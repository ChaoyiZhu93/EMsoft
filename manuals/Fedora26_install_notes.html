<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<title>EMsoft_install_notes</title>
<!-- 2017-08-04 Fri 16:06 -->
<meta  http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta  name="generator" content="Org-mode" />
<meta  name="author" content="Joao Fonseca" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center; }
  .todo   { font-family: monospace; color: red; }
  .done   { color: green; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  pre.src-sh:before    { content: 'sh'; }
  pre.src-bash:before  { content: 'sh'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-R:before     { content: 'R'; }
  pre.src-perl:before  { content: 'Perl'; }
  pre.src-java:before  { content: 'Java'; }
  pre.src-sql:before   { content: 'SQL'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.right  { text-align: center;  }
  th.left   { text-align: center;   }
  th.center { text-align: center; }
  td.right  { text-align: right;  }
  td.left   { text-align: left;   }
  td.center { text-align: center; }
  dt { font-weight: bold; }
  .footpara:nth-child(2) { display: inline; }
  .footpara { display: block; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  /*]]>*/-->
</style>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2013 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="content">
<h1 class="title">EMsoft_install_notes</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#sec-1">1. Installing EMsoft on a fresh Fedora (25/26) install</a>
<ul>
<li><a href="#sec-1-1">1.1. install dkms</a></li>
<li><a href="#sec-1-2">1.2. Install opencl software</a></li>
<li><a href="#sec-1-3">1.3. Install cmake3</a></li>
<li><a href="#sec-1-4">1.4. install gcc-c++</a></li>
<li><a href="#sec-1-5">1.5. Install gcc-gfortran</a></li>
<li><a href="#sec-1-6">1.6. Install LAPACK</a></li>
<li><a href="#sec-1-7">1.7. Procedure for installing SDK</a></li>
<li><a href="#sec-1-8">1.8. Procedure for building EMsoft</a></li>
<li><a href="#sec-1-9">1.9. EMsoft configuration</a></li>
<li><a href="#sec-1-10">1.10. IDL routines</a>
<ul>
<li><a href="#sec-1-10-1">1.10.1. Install IDL</a></li>
<li><a href="#sec-1-10-2">1.10.2. Fix links to EMsoftLib library</a></li>
<li><a href="#sec-1-10-3">1.10.3. Change IDL installation scripts</a></li>
<li><a href="#sec-1-10-4">1.10.4. Compiling Efit virtual machine</a></li>
<li><a href="#sec-1-10-5">1.10.5. Compiling SEMDisplay virtual machine</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1"><span class="section-number-2">1</span> Installing EMsoft on a fresh Fedora (25/26) install</h2>
<div class="outline-text-2" id="text-1">
</div><div id="outline-container-sec-1-1" class="outline-3">
<h3 id="sec-1-1"><span class="section-number-3">1.1</span> install dkms</h3>
<div class="outline-text-3" id="text-1-1">
<pre class="example">
&gt;&gt;sudo dnf install dkms
</pre>
</div>
</div>
<div id="outline-container-sec-1-2" class="outline-3">
<h3 id="sec-1-2"><span class="section-number-3">1.2</span> Install opencl software</h3>
<div class="outline-text-3" id="text-1-2">
<p>
The Intel OpenCl software can be downloaded from here:
<a href="https://software.intel.com/en-us/articles/opencl-drivers">https://software.intel.com/en-us/articles/opencl-drivers</a>
You will need at least the runtime drivers. Installing the SDK DOES NOT install the runtime drivers.
</p>

<p>
The NVIDIA driver is usually installed when the graphics card is installed. Installing an NVIDIA card on Fedora has usually bee painful, however, there is a nice repository with a nice, well structured version of the drivers which works well with Fedora 25/26:
<a href="https://negativo17.org/nvidia-driver/">https://negativo17.org/nvidia-driver/</a>
you will need to install the CUDA tools and libraries (nvidia-cuda-devel) for it to work.
</p>
</div>
</div>

<div id="outline-container-sec-1-3" class="outline-3">
<h3 id="sec-1-3"><span class="section-number-3">1.3</span> Install cmake3</h3>
<div class="outline-text-3" id="text-1-3">
<pre class="example">
&gt;&gt;sudo dnf install cmake3
</pre>
</div>
</div>

<div id="outline-container-sec-1-4" class="outline-3">
<h3 id="sec-1-4"><span class="section-number-3">1.4</span> install gcc-c++</h3>
<div class="outline-text-3" id="text-1-4">
<pre class="example">
&gt;&gt;sudo dnf install gcc-c++
</pre>
</div>
</div>

<div id="outline-container-sec-1-5" class="outline-3">
<h3 id="sec-1-5"><span class="section-number-3">1.5</span> Install gcc-gfortran</h3>
<div class="outline-text-3" id="text-1-5">
<pre class="example">
&gt;&gt;sudo dnf install gcc-fortran
</pre>
</div>
</div>
<div id="outline-container-sec-1-6" class="outline-3">
<h3 id="sec-1-6"><span class="section-number-3">1.6</span> Install LAPACK</h3>
<div class="outline-text-3" id="text-1-6">
<pre class="example">
&gt;&gt;sudo dnf install lapack-devel
</pre>
</div>
</div>

<div id="outline-container-sec-1-7" class="outline-3">
<h3 id="sec-1-7"><span class="section-number-3">1.7</span> Procedure for installing SDK</h3>
<div class="outline-text-3" id="text-1-7">
<p>
Edit directory name in SDK_conf to indicate where the SDK should be installed. In this example the directory is (here <b>/home/user/EMsoftSDK</b>)
</p>

<p>
Run linux script in: 
</p>

<p>
<b><i>EMsoftPublic/Support/SDK_Build_Scripts/Linux_Build_Scripts</i></b>
</p>

<p>
The main script, Build_SDK.sh, downloads the latest versions of the software needed to build EMsoft and compiles them. This will only work properly if the dependencies above (cmake, lapack-devel etc.) have all been installed.
</p>

<p>
Once the SDK has been installed properly we can build EMsoft.
</p>
</div>
</div>

<div id="outline-container-sec-1-8" class="outline-3">
<h3 id="sec-1-8"><span class="section-number-3">1.8</span> Procedure for building EMsoft</h3>
<div class="outline-text-3" id="text-1-8">
<p>
In the EMsoftPublic directory, create a Build directory:
</p>

<pre class="example">
&gt;&gt;mkdir Build
</pre>

<p>
Then change to the Build directory 
</p>

<pre class="example">
&gt;&gt;cd Build 
</pre>

<p>
and run cmake. If you have installed cmake3 this can be done with the following command: 
</p>

<pre class="example">
&gt;&gt;cmake -DEMsoft_SDK=/home/user/EMsoft_SDK -DCMAKE_BUILD_TYPE=Debug ../
</pre>

<p>
note that there is a typo in the other instructions file (it has EMSoft_SDK instead of EMsoft_SDK). If cmake complains that it hasn't found something, this is because either the SDK wasn't installed cleanly or the path to the SDK, which is passed on with "-DEMsoft_SDK =/home/user/EMsoft_SD, has not been passed on properly. There should never be a need to edit the configuation files cmake creates.
</p>

<p>
Finally run make to compile EMsoft:
</p>

<pre class="example">
&gt;&gt;make
</pre>
</div>
</div>

<div id="outline-container-sec-1-9" class="outline-3">
<h3 id="sec-1-9"><span class="section-number-3">1.9</span> EMsoft configuration</h3>
<div class="outline-text-3" id="text-1-9">
<p>
The first thing to do is run EMsoftinit in <b>Bin/</b> directory and follow the instructions to define the different paths. This includes defining the path for the EMsoft folder, the EMsoft data file and the path for the libraries for the IDL routines (<b><i>home/user/EMsoftPublic/Build/Bin</i></b>).   
</p>
</div>
</div>

<div id="outline-container-sec-1-10" class="outline-3">
<h3 id="sec-1-10"><span class="section-number-3">1.10</span> IDL routines</h3>
<div class="outline-text-3" id="text-1-10">
<p>
There are a number of useful IDL routines, however, lots of TLC seems to be needed to get them to run. 
</p>
</div>

<div id="outline-container-sec-1-10-1" class="outline-4">
<h4 id="sec-1-10-1"><span class="section-number-4">1.10.1</span> Install IDL</h4>
<div class="outline-text-4" id="text-1-10-1">
<p>
Firstly you will need an IDL licence (and installation) so that you can install and compile the IDL routines. How you will do this will depend on your local arrangements.
</p>
</div>
</div>

<div id="outline-container-sec-1-10-2" class="outline-4">
<h4 id="sec-1-10-2"><span class="section-number-4">1.10.2</span> Fix links to EMsoftLib library</h4>
<div class="outline-text-4" id="text-1-10-2">
<p>
The next thing to do is to create <b>.dylib</b> versions of the <b>.so</b> shared libraries. The files are identical but the IDL programs look for a <b>.dylib</b> file whereas the compiler produces the linux <b>.so</b> file. Alternatively, one can replace the calls to libEMsoftLib.dylib with libEMsoftLib.so in the <b>.pro</b> files in the <b>EMsoftPublic/IDL/pro</b> directory:
</p>
<pre class="example">
&gt;&gt;sed -i -- 's/dylib/so/g' *
</pre>
</div>
</div>

<div id="outline-container-sec-1-10-3" class="outline-4">
<h4 id="sec-1-10-3"><span class="section-number-4">1.10.3</span> Change IDL installation scripts</h4>
<div class="outline-text-4" id="text-1-10-3">
<p>
There are 3 installation scripts for creating virtual IDL machines that can then be run without a license. These are mkVM_Efitgui.txt, mkVM_SEMgui.txt and mkVM_ellipsometrytool.txt. These need to be edited to change the directory inofrmtation to reflect your local configuration and to change the compilation flag from MACINT64 to LIN64. After this, going into the IDL prompt and entering @mkVM_Efitgui.txt should create a virtual machine in the directory defined in the *.txt script. But instead we get a bunch of compilation errors. 
</p>
</div>
</div>

<div id="outline-container-sec-1-10-4" class="outline-4">
<h4 id="sec-1-10-4"><span class="section-number-4">1.10.4</span> Compiling Efit virtual machine</h4>
<div class="outline-text-4" id="text-1-10-4">
<p>
Some of these errors appear because the names of the IDL routines called do not match the filenames because of different capitalization (e.g. Efit.pro calls @CoreWtest but the filename is CoreWTest.pro, @CoreWtextE&gt;CreWTestE.pro, @Core_event&gt;core_event.pro). I guess this isn't a problem on a Mac but it just doesn't work on Linux. I capitalized the cpre_event.pro file name but made the other changes on the routine.
</p>

<p>
You also need to move all the routines named Core_* to the top of the list of the main routine (Efit.pro for example). For some reason, in my setup, these need to come first or there will be compilation errors later on. The error is cryptically: "Only 8 subscripts allowed." Also, @Efit_amoeba must preceed @Efit_fit and you need to add @Efit_showpattern to the list. 
</p>
</div>
<ol class="org-ol"><li><a id="sec-1-10-4-1" name="sec-1-10-4-1"></a>List of commands on an Efit.pro that compiles OK:<br  /><div class="outline-text-5" id="text-1-10-4-1">
<pre class="example">
@Core_WidgetEvent
@Core_WidgetChoiceEvent
@Core_WText
@Core_WTextE
@Core_FitLine
@Core_Print
@Core_getenv
@Core_quatmult
@Core_quat_Lp
@Core_eu2qu
@Core_qu2eu
@Core_LambertSphereToSquare
@Core_histnd
@Core_mind
@Efitcalc
@Efitinit
@Efit_display
@Efit_display_event
@Efitevent
@Efit_control
@Efit_control_event
@Efit_event
@Efit_amoeba
@Efit_fit
@Efit_update
@Efitgetpreferences
@Efitwritepreferences
@Efitgetfilename
@Efit_navigator
@Efit_navigator_event
@Efit_updatePC
@Efit_showpattern
</pre>
</div>
</li>
<li><a id="sec-1-10-4-2" name="sec-1-10-4-2"></a><br  /><div class="outline-text-5" id="text-1-10-4-2">
<p>
Another error that crops up is "% Attempt to extend common block: FITPARAMETERS". This comes from the fact that this commonblock has different number of parameters in different routines. To fix this you need to add <b>fitIterations</b> to the common block in 3 files: EBSDfit.pro, EBSDfit_event.pro and Core_FitLine.pro.
</p>
</div>
</li></ol>
</div>

<div id="outline-container-sec-1-10-5" class="outline-4">
<h4 id="sec-1-10-5"><span class="section-number-4">1.10.5</span> Compiling SEMDisplay virtual machine</h4>
<div class="outline-text-4" id="text-1-10-5">
<p>
There is only one typo in a filename:
</p>
<pre class="example">
&gt;&gt;mv Core_Lamberts2SP.pro Core_LambertS2SP.pro.
</pre>

<p>
After this, and the changes to directory, flags etc it compiles fine.
</p>
</div>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: Joao Fonseca</p>
<p class="date">Created: 2017-08-04 Fri 16:06</p>
<p class="creator"><a href="http://www.gnu.org/software/emacs/">Emacs</a> 25.2.1 (<a href="http://orgmode.org">Org</a> mode 8.2.10)</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
