<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
	 
	 <meta name="description" content="EMsoft main library">
    
    <meta name="author" content="Marc De Graef Research Group/Carnegie Mellon University" >
    <link rel="icon" href="../favicon.png">

    <title>EMdymod.f90 &ndash; Fortran Program</title>

    <link href="../css/bootstrap.min.css" rel="stylesheet">
    <link href="../css/pygments.css" rel="stylesheet">
    <link href="../css/font-awesome.min.css" rel="stylesheet">
    <link href="../css/local.css" rel="stylesheet">
    

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    
    <script src="../js/jquery-2.1.3.min.js"></script>
    <script src="../js/svg-pan-zoom.min.js"></script>

    
    <script src="../tipuesearch/tipuesearch_content.js"></script>
    <link  href="../tipuesearch/tipuesearch.css" rel="stylesheet">
    <script src="../tipuesearch/tipuesearch_set.js"></script>
    <script src="../tipuesearch/tipuesearch.js"></script>
    

  </head>

  <body>

    <!-- Fixed navbar -->
    <nav class="navbar navbar-inverse navbar-fixed-top">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="../index.html">Fortran Program </a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
				
            <li class="dropdown hidden-xs visible-sm visible-md hidden-lg">
              <a href="#" class="dropdown-toggle"
              data-toggle="dropdown" role="button"
              aria-haspopup="true"
		 aria-expanded="false">Contents <span class="caret"></span></a>
	      <ul class="dropdown-menu">
              
            <li><a href="../lists/files.html">Source Files</a></li>
				
				
            <li><a href="../lists/modules.html">Modules</a></li>
				
            
                                
            <li><a href="../lists/procedures.html">Procedures</a></li>
				
				
            <li><a href="../lists/absint.html">Abstract Interfaces</a></li>
								
            <li><a href="../lists/types.html">Derived Types</a></li>
				
				
            <li><a href="../lists/programs.html">Programs</a></li>
				
            </ul>
            </li>

<li class="visible-xs hidden-sm visible-lg"><a href="../lists/files.html">Source Files</a></li>


<li class="visible-xs hidden-sm visible-lg"><a href="../lists/modules.html">Modules</a></li>



<li class="visible-xs hidden-sm visible-lg"><a href="../lists/procedures.html">Procedures</a></li>


<li class="visible-xs hidden-sm visible-lg"><a href="../lists/absint.html">Abstract Interfaces</a></li>
                             
<li class="visible-xs hidden-sm visible-lg"><a href="../lists/types.html">Derived Types</a></li>


<li class="visible-xs hidden-sm visible-lg"><a href="../lists/programs.html">Programs</a></li>

          </ul>
        
        <form action="../search.html" class="navbar-form navbar-right" role="search">
        <div class="form-group">
          <input type="text" class="form-control" placeholder="Search" name="q" id="tipue_search_input" autocomplete="off" required>
        </div>
<!--
        <button type="submit" class="btn btn-default">Submit</button>
-->
        </form>
        
        </div><!--/.nav-collapse -->
      </div>
    </nav>

    <div class="container">
    
  
  <div class="row">
    <h1>EMdymod.f90
    <small>Source File</small>
    
    </h1>
    
<div class="row">
  <div class="col-lg-12">
<div class="well well-sm">
  <ul class="list-inline" style="margin-bottom:0px;display:inline">
     
     
     
     
    
    
     <li><i class="fa fa-list-ol"></i>
       <a data-toggle="tooltip"
	  data-placement="bottom" data-html="true"
	  title=" 6.8% of total for source files.">2083 statements</a>
     </li> 
     
     
    <li><i class="fa fa-code"></i><a href="../src/EMdymod.f90"> Source File</a></li>
     
  </ul>
  <ol class="breadcrumb in-well text-right">
  
     <li class="active">EMdymod.f90</li>
  </ol>
</div>
</div>
</div>
<script>
  $(function () {
  $('[data-toggle="tooltip"]').tooltip()
  })
</script>

  </div>
  <div class="row">
    <div class="col-md-3 hidden-xs hidden-sm visible-md visible-lg">
    
<div id="sidebar">
  






<div class="panel panel-primary">
  <div class="panel-heading text-left"><h3 class="panel-title"><a data-toggle="collapse" href="#mods-0">Modules</a></h3></div>
  <div id="mods-0" class="panel-collapse collapse">
    <div class="list-group">
      
      <a class="list-group-item" href="../module/emdymod.html">EMdymod</a>
      
    </div>
  </div>
</div>















<div class="panel panel-primary">
  <div class="panel-heading text-left"><h3 class="panel-title">Source Code</h3></div>
  <div class="list-group">
    <a class="list-group-item" href="../sourcefile/emdymod.f90.html#src">EMdymod.f90</a>
  </div>
</div>


  <hr>
  

<div class="panel panel-default">
  <div class="panel-heading text-left"><h3 class="panel-title"><a data-toggle="collapse" href="#allfiles-0">All Source Files</a></h3></div>
  <div id="allfiles-0" class="panel-collapse collapse">
    <div class="list-group">
      
      <a class="list-group-item" href="../sourcefile/apb.f90.html">apb.f90</a>
      
      <a class="list-group-item" href="../sourcefile/bobyqa.f90.html">bobyqa.f90</a>
      
      <a class="list-group-item" href="../sourcefile/bobyqa_refinement.f90.html">bobyqa_refinement.f90</a>
      
      <a class="list-group-item" href="../sourcefile/clsupport.f90.html">CLsupport.f90</a>
      
      <a class="list-group-item" href="../sourcefile/constants.f90.html">constants.f90</a>
      
      <a class="list-group-item" href="../sourcefile/defectmodule.f90.html">defectmodule.f90</a>
      
      <a class="list-group-item" href="../sourcefile/dictmod.f90.html">dictmod.f90</a>
      
      <a class="list-group-item" href="../sourcefile/dispfield.f90.html">dispfield.f90</a>
      
      <a class="list-group-item" href="../sourcefile/distortion.f90.html">distortion.f90</a>
      
      <a class="list-group-item" href="../sourcefile/eccimod.f90.html">ECCImod.f90</a>
      
      <a class="list-group-item" href="../sourcefile/eispack.f90.html">eispack.f90</a>
      
      <a class="list-group-item" href="../sourcefile/emdymod.f90.html">EMdymod.f90</a>
      
      <a class="list-group-item" href="../sourcefile/filters.f90.html">filters.f90</a>
      
      <a class="list-group-item" href="../sourcefile/hdftest.f90.html">hdftest.f90</a>
      
      <a class="list-group-item" href="../sourcefile/indexingmod.f90.html">Indexingmod.f90</a>
      
      <a class="list-group-item" href="../sourcefile/initializers.f90.html">initializers.f90</a>
      
      <a class="list-group-item" href="../sourcefile/jsonsupport.f90.html">JSONsupport.f90</a>
      
      <a class="list-group-item" href="../sourcefile/muellercalculus.f90.html">MuellerCalculus.f90</a>
      
      <a class="list-group-item" href="../sourcefile/multibeams.f90.html">multibeams.f90</a>
      
      <a class="list-group-item" href="../sourcefile/namelisthandlers.f90.html">NameListHandlers.f90</a>
      
      <a class="list-group-item" href="../sourcefile/namelistjsonwriters.f90.html">NameListJSONwriters.f90</a>
      
      <a class="list-group-item" href="../sourcefile/namelisttypedefs.f90.html">NameListTypedefs.f90</a>
      
      <a class="list-group-item" href="../sourcefile/noise.f90.html">noise.f90</a>
      
      <a class="list-group-item" href="../sourcefile/others.f90.html">others.f90</a>
      
      <a class="list-group-item" href="../sourcefile/pedmod.f90.html">PEDmod.f90</a>
      
      <a class="list-group-item" href="../sourcefile/pfinversion.f90.html">PFInversion.f90</a>
      
      <a class="list-group-item" href="../sourcefile/pgm.f90.html">pgm.f90</a>
      
      <a class="list-group-item" href="../sourcefile/povray.f90.html">povray.f90</a>
      
      <a class="list-group-item" href="../sourcefile/rng.f90.html">rng.f90</a>
      
      <a class="list-group-item" href="../sourcefile/simulated_annealing.f90.html">simulated_annealing.f90</a>
      
      <a class="list-group-item" href="../sourcefile/so3.f90.html">so3.f90</a>
      
      <a class="list-group-item" href="../sourcefile/stemmodule.f90.html">STEMmodule.f90</a>
      
      <a class="list-group-item" href="../sourcefile/timing.f90.html">timing.f90</a>
      
    </div>
  </div>
</div>


</div>  

    </div>
    <div class="col-md-9" id='text'>
    
    
    <h3>This File Depends On</h3>
    
                <div class="depgraph"><?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.38.0 (20140413.2041)
 -->
<!-- Title: sourcefile~~emdymod.f90~~EfferentGraph Pages: 1 -->
<svg id="sourcefileemdymodf90EfferentGraph" width="365pt" height="350pt"
 viewBox="0.00 0.00 365.00 349.58" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="sourcefile~~emdymod.f90~~EfferentGraph" class="graph" transform="scale(1 1) rotate(0) translate(4 345.581)">
<title>sourcefile~~emdymod.f90~~EfferentGraph</title>
<polygon fill="white" stroke="none" points="-4,4 -4,-345.581 361,-345.581 361,4 -4,4"/>
<!-- sourcefile~emdymod.f90 -->
<g id="sourcefile~~emdymod.f90~~EfferentGraph_node1" class="node"><title>sourcefile~emdymod.f90</title>
<polygon fill="none" stroke="black" points="357,-190 280,-190 280,-166 357,-166 357,-190"/>
<text text-anchor="middle" x="318.5" y="-175.6" font-family="Helvetica,sans-Serif" font-size="10.50">EMdymod.f90</text>
</g>
<!-- sourcefile~indexingmod.f90 -->
<g id="sourcefile~~emdymod.f90~~EfferentGraph_node2" class="node"><title>sourcefile~indexingmod.f90</title>
<g id="a_sourcefile~~emdymod.f90~~EfferentGraph_node2"><a xlink:href="../sourcefile/indexingmod.f90.html" xlink:title="Indexingmod.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="244,-310 154,-310 154,-286 244,-286 244,-310"/>
<text text-anchor="middle" x="199" y="-295.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Indexingmod.f90</text>
</a>
</g>
</g>
<!-- sourcefile~indexingmod.f90&#45;&gt;sourcefile~emdymod.f90 -->
<g id="sourcefile~~emdymod.f90~~EfferentGraph_edge5" class="edge"><title>sourcefile~indexingmod.f90&#45;&gt;sourcefile~emdymod.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M224.396,-285.76C231.099,-281.833 238.132,-277.151 244,-272 268.841,-250.193 291.27,-219.052 304.643,-198.684"/>
<polygon fill="#ff0000" stroke="#ff0000" points="307.662,-200.461 310.126,-190.157 301.774,-196.675 307.662,-200.461"/>
</g>
<!-- sourcefile~timing.f90 -->
<g id="sourcefile~~emdymod.f90~~EfferentGraph_node3" class="node"><title>sourcefile~timing.f90</title>
<g id="a_sourcefile~~emdymod.f90~~EfferentGraph_node3"><a xlink:href="../sourcefile/timing.f90.html" xlink:title="timing.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="228,-230 170,-230 170,-206 228,-206 228,-230"/>
<text text-anchor="middle" x="199" y="-215.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">timing.f90</text>
</a>
</g>
</g>
<!-- sourcefile~timing.f90&#45;&gt;sourcefile~emdymod.f90 -->
<g id="sourcefile~~emdymod.f90~~EfferentGraph_edge6" class="edge"><title>sourcefile~timing.f90&#45;&gt;sourcefile~emdymod.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M228.144,-208.419C241.399,-203.907 257.538,-198.413 272.434,-193.342"/>
<polygon fill="#ff0000" stroke="#ff0000" points="273.662,-196.621 282.001,-190.085 271.406,-189.994 273.662,-196.621"/>
</g>
<!-- sourcefile~filters.f90 -->
<g id="sourcefile~~emdymod.f90~~EfferentGraph_node4" class="node"><title>sourcefile~filters.f90</title>
<g id="a_sourcefile~~emdymod.f90~~EfferentGraph_node4"><a xlink:href="../sourcefile/filters.f90.html" xlink:title="filters.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="226.5,-150 171.5,-150 171.5,-126 226.5,-126 226.5,-150"/>
<text text-anchor="middle" x="199" y="-135.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">filters.f90</text>
</a>
</g>
</g>
<!-- sourcefile~filters.f90&#45;&gt;sourcefile~emdymod.f90 -->
<g id="sourcefile~~emdymod.f90~~EfferentGraph_edge7" class="edge"><title>sourcefile~filters.f90&#45;&gt;sourcefile~emdymod.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M226.663,-147.077C240.104,-151.652 256.778,-157.329 272.157,-162.564"/>
<polygon fill="#ff0000" stroke="#ff0000" points="271.435,-166.016 282.029,-165.925 273.691,-159.389 271.435,-166.016"/>
</g>
<!-- sourcefile~initializers.f90 -->
<g id="sourcefile~~emdymod.f90~~EfferentGraph_node5" class="node"><title>sourcefile~initializers.f90</title>
<g id="a_sourcefile~~emdymod.f90~~EfferentGraph_node5"><a xlink:href="../sourcefile/initializers.f90.html" xlink:title="initializers.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="237,-108 161,-108 161,-84 237,-84 237,-108"/>
<text text-anchor="middle" x="199" y="-93.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">initializers.f90</text>
</a>
</g>
</g>
<!-- sourcefile~initializers.f90&#45;&gt;sourcefile~emdymod.f90 -->
<g id="sourcefile~~emdymod.f90~~EfferentGraph_edge8" class="edge"><title>sourcefile~initializers.f90&#45;&gt;sourcefile~emdymod.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M228.025,-108.093C233.457,-110.791 239.009,-113.808 244,-117 263.268,-129.324 283.11,-146.075 297.314,-158.906"/>
<polygon fill="#ff0000" stroke="#ff0000" points="295.246,-161.759 304.978,-165.945 299.98,-156.603 295.246,-161.759"/>
</g>
<!-- sourcefile~multibeams.f90 -->
<g id="sourcefile~~emdymod.f90~~EfferentGraph_node6" class="node"><title>sourcefile~multibeams.f90</title>
<g id="a_sourcefile~~emdymod.f90~~EfferentGraph_node6"><a xlink:href="../sourcefile/multibeams.f90.html" xlink:title="multibeams.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="241,-66 157,-66 157,-42 241,-42 241,-66"/>
<text text-anchor="middle" x="199" y="-51.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">multibeams.f90</text>
</a>
</g>
</g>
<!-- sourcefile~multibeams.f90&#45;&gt;sourcefile~emdymod.f90 -->
<g id="sourcefile~~emdymod.f90~~EfferentGraph_edge9" class="edge"><title>sourcefile~multibeams.f90&#45;&gt;sourcefile~emdymod.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M230.582,-66.0896C235.326,-68.6555 239.98,-71.6266 244,-75 271.682,-98.2292 294.137,-134.135 306.652,-156.834"/>
<polygon fill="#ff0000" stroke="#ff0000" points="303.584,-158.518 311.394,-165.678 309.754,-155.211 303.584,-158.518"/>
</g>
<!-- sourcefile~clsupport.f90 -->
<g id="sourcefile~~emdymod.f90~~EfferentGraph_node7" class="node"><title>sourcefile~clsupport.f90</title>
<g id="a_sourcefile~~emdymod.f90~~EfferentGraph_node7"><a xlink:href="../sourcefile/clsupport.f90.html" xlink:title="CLsupport.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="98,-340 20,-340 20,-316 98,-316 98,-340"/>
<text text-anchor="middle" x="59" y="-325.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">CLsupport.f90</text>
</a>
</g>
</g>
<!-- sourcefile~clsupport.f90&#45;&gt;sourcefile~emdymod.f90 -->
<g id="sourcefile~~emdymod.f90~~EfferentGraph_edge10" class="edge"><title>sourcefile~clsupport.f90&#45;&gt;sourcefile~emdymod.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M98.1903,-336.491C137.891,-343.099 200.233,-347.027 244,-319 286.19,-291.983 305.5,-232.409 313.167,-200.017"/>
<polygon fill="#ff0000" stroke="#ff0000" points="316.605,-200.679 315.337,-190.16 309.769,-199.174 316.605,-200.679"/>
</g>
<!-- sourcefile~clsupport.f90&#45;&gt;sourcefile~indexingmod.f90 -->
<g id="sourcefile~~emdymod.f90~~EfferentGraph_edge1" class="edge"><title>sourcefile~clsupport.f90&#45;&gt;sourcefile~indexingmod.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M98.0744,-319.723C112.21,-316.65 128.53,-313.102 143.828,-309.776"/>
<polygon fill="#ff0000" stroke="#ff0000" points="144.673,-313.175 153.701,-307.63 143.186,-306.334 144.673,-313.175"/>
</g>
<!-- sourcefile~namelisttypedefs.f90 -->
<g id="sourcefile~~emdymod.f90~~EfferentGraph_node8" class="node"><title>sourcefile~namelisttypedefs.f90</title>
<g id="a_sourcefile~~emdymod.f90~~EfferentGraph_node8"><a xlink:href="../sourcefile/namelisttypedefs.f90.html" xlink:title="NameListTypedefs.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="118,-279 0,-279 0,-255 118,-255 118,-279"/>
<text text-anchor="middle" x="59" y="-264.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">NameListTypedefs.f90</text>
</a>
</g>
</g>
<!-- sourcefile~namelisttypedefs.f90&#45;&gt;sourcefile~emdymod.f90 -->
<g id="sourcefile~~emdymod.f90~~EfferentGraph_edge11" class="edge"><title>sourcefile~namelisttypedefs.f90&#45;&gt;sourcefile~emdymod.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M118.205,-266.091C155.573,-263.621 204.35,-256.795 244,-239 265.7,-229.261 286.158,-211.285 299.952,-197.36"/>
<polygon fill="#ff0000" stroke="#ff0000" points="302.501,-199.759 306.896,-190.119 297.449,-194.914 302.501,-199.759"/>
</g>
<!-- sourcefile~namelisttypedefs.f90&#45;&gt;sourcefile~indexingmod.f90 -->
<g id="sourcefile~~emdymod.f90~~EfferentGraph_edge2" class="edge"><title>sourcefile~namelisttypedefs.f90&#45;&gt;sourcefile~indexingmod.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M113.75,-279.074C123.739,-281.318 134.178,-283.663 144.17,-285.908"/>
<polygon fill="#ff0000" stroke="#ff0000" points="143.456,-289.335 153.98,-288.112 144.991,-282.505 143.456,-289.335"/>
</g>
<!-- sourcefile~distortion.f90 -->
<g id="sourcefile~~emdymod.f90~~EfferentGraph_node9" class="node"><title>sourcefile~distortion.f90</title>
<g id="a_sourcefile~~emdymod.f90~~EfferentGraph_node9"><a xlink:href="../sourcefile/distortion.f90.html" xlink:title="distortion.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="235.5,-24 162.5,-24 162.5,-0 235.5,-0 235.5,-24"/>
<text text-anchor="middle" x="199" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">distortion.f90</text>
</a>
</g>
</g>
<!-- sourcefile~distortion.f90&#45;&gt;sourcefile~emdymod.f90 -->
<g id="sourcefile~~emdymod.f90~~EfferentGraph_edge12" class="edge"><title>sourcefile~distortion.f90&#45;&gt;sourcefile~emdymod.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M231.944,-24.0995C236.308,-26.6166 240.487,-29.5702 244,-33 280.127,-68.2755 301.656,-125.064 311.347,-156.068"/>
<polygon fill="#ff0000" stroke="#ff0000" points="308.064,-157.305 314.285,-165.881 314.77,-155.297 308.064,-157.305"/>
</g>
<!-- sourcefile~constants.f90 -->
<g id="sourcefile~~emdymod.f90~~EfferentGraph_node10" class="node"><title>sourcefile~constants.f90</title>
<g id="a_sourcefile~~emdymod.f90~~EfferentGraph_node10"><a xlink:href="../sourcefile/constants.f90.html" xlink:title="constants.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="96.5,-150 21.5,-150 21.5,-126 96.5,-126 96.5,-150"/>
<text text-anchor="middle" x="59" y="-135.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">constants.f90</text>
</a>
</g>
</g>
<!-- sourcefile~constants.f90&#45;&gt;sourcefile~emdymod.f90 -->
<g id="sourcefile~~emdymod.f90~~EfferentGraph_edge13" class="edge"><title>sourcefile~constants.f90&#45;&gt;sourcefile~emdymod.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M96.8803,-147.172C114.145,-151.226 135.04,-155.789 154,-159 192.644,-165.544 236.812,-170.53 269.492,-173.748"/>
<polygon fill="#ff0000" stroke="#ff0000" points="269.387,-177.254 279.677,-174.731 270.059,-170.287 269.387,-177.254"/>
</g>
<!-- sourcefile~constants.f90&#45;&gt;sourcefile~filters.f90 -->
<g id="sourcefile~~emdymod.f90~~EfferentGraph_edge3" class="edge"><title>sourcefile~constants.f90&#45;&gt;sourcefile~filters.f90</title>
<path fill="none" stroke="#aaff00" stroke-dasharray="5,2" d="M96.6192,-138C116.519,-138 141.065,-138 161.02,-138"/>
<polygon fill="#aaff00" stroke="#aaff00" points="161.281,-141.5 171.281,-138 161.281,-134.5 161.281,-141.5"/>
</g>
<!-- sourcefile~constants.f90&#45;&gt;sourcefile~initializers.f90 -->
<g id="sourcefile~~emdymod.f90~~EfferentGraph_edge4" class="edge"><title>sourcefile~constants.f90&#45;&gt;sourcefile~initializers.f90</title>
<path fill="none" stroke="#00ff00" stroke-dasharray="5,2" d="M96.6192,-126.855C113.328,-121.77 133.313,-115.687 151.105,-110.272"/>
<polygon fill="#00ff00" stroke="#00ff00" points="152.181,-113.603 160.729,-107.343 150.143,-106.907 152.181,-113.603"/>
</g>
</g>
</svg>
</div>
                <div><a type="button" class="graph-help" data-toggle="modal" href="#graph-help-text">Help</a></div>
                <div class="modal fade" id="graph-help-text" tabindex="-1" role="dialog">
                  <div class="modal-dialog modal-lg" role="document">
                    <div class="modal-content">
                      <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                        <h4 class="modal-title" id="-graph-help-label">Graph Key</h4>
                      </div>
                      <div class="modal-body">
                        
    <p>Nodes of different colours represent the following: </p>
    <?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.38.0 (20140413.2041)
 -->
<!-- Title: Graph Key Pages: 1 -->
<svg width="188pt" height="32pt"
 viewBox="0.00 0.00 188.00 32.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 28)">
<title>Graph Key</title>
<polygon fill="white" stroke="none" points="-4,4 -4,-28 184,-28 184,4 -4,4"/>
<!-- Source File -->
<g id="node1" class="node"><title>Source File</title>
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="66,-24 0,-24 0,-0 66,-0 66,-24"/>
<text text-anchor="middle" x="33" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Source File</text>
</g>
<!-- This Page&#39;s Entity -->
<g id="node2" class="node"><title>This Page&#39;s Entity</title>
<polygon fill="none" stroke="black" points="180,-24 84,-24 84,-0 180,-0 180,-24"/>
<text text-anchor="middle" x="132" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50">This Page&#39;s Entity</text>
</g>
</g>
</svg>

    
    <p>Solid arrows point from a file to a file which depends upon it. A file 
    is dependent upon another if the latter must be compiled before the former
    can be. Where possible, edges connecting nodes are given different colours to make them easier to distinguish in large graphs.
    </p>
    
                      </div>
                    </div>
                  </div>
                </div>
                
    
      
      <h3>Files Dependent On This One</h3>
      
                <div class="depgraph"><?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.38.0 (20140413.2041)
 -->
<!-- Title: sourcefile~~emdymod.f90~~AfferentGraph Pages: 1 -->
<svg id="sourcefileemdymodf90AfferentGraph" width="247pt" height="32pt"
 viewBox="0.00 0.00 247.00 32.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="sourcefile~~emdymod.f90~~AfferentGraph" class="graph" transform="scale(1 1) rotate(0) translate(4 28)">
<title>sourcefile~~emdymod.f90~~AfferentGraph</title>
<polygon fill="white" stroke="none" points="-4,4 -4,-28 243,-28 243,4 -4,4"/>
<!-- sourcefile~emdymod.f90 -->
<g id="sourcefile~~emdymod.f90~~AfferentGraph_node1" class="node"><title>sourcefile~emdymod.f90</title>
<polygon fill="none" stroke="black" points="77,-24 0,-24 0,-0 77,-0 77,-24"/>
<text text-anchor="middle" x="38.5" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50">EMdymod.f90</text>
</g>
<!-- sourcefile~simulated_annealing.f90 -->
<g id="sourcefile~~emdymod.f90~~AfferentGraph_node2" class="node"><title>sourcefile~simulated_annealing.f90</title>
<g id="a_sourcefile~~emdymod.f90~~AfferentGraph_node2"><a xlink:href="../sourcefile/simulated_annealing.f90.html" xlink:title="simulated_annealing.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="239,-24 113,-24 113,-0 239,-0 239,-24"/>
<text text-anchor="middle" x="176" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">simulated_annealing.f90</text>
</a>
</g>
</g>
<!-- sourcefile~emdymod.f90&#45;&gt;sourcefile~simulated_annealing.f90 -->
<g id="sourcefile~~emdymod.f90~~AfferentGraph_edge1" class="edge"><title>sourcefile~emdymod.f90&#45;&gt;sourcefile~simulated_annealing.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M77.2443,-12C85.1803,-12 93.8046,-12 102.534,-12"/>
<polygon fill="#ff0000" stroke="#ff0000" points="102.794,-15.5001 112.794,-12 102.794,-8.5001 102.794,-15.5001"/>
</g>
</g>
</svg>
</div>
                <div><a type="button" class="graph-help" data-toggle="modal" href="#graph-help-text">Help</a></div>
                <div class="modal fade" id="graph-help-text" tabindex="-1" role="dialog">
                  <div class="modal-dialog modal-lg" role="document">
                    <div class="modal-content">
                      <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                        <h4 class="modal-title" id="-graph-help-label">Graph Key</h4>
                      </div>
                      <div class="modal-body">
                        
    <p>Nodes of different colours represent the following: </p>
    <?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.38.0 (20140413.2041)
 -->
<!-- Title: Graph Key Pages: 1 -->
<svg width="188pt" height="32pt"
 viewBox="0.00 0.00 188.00 32.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 28)">
<title>Graph Key</title>
<polygon fill="white" stroke="none" points="-4,4 -4,-28 184,-28 184,4 -4,4"/>
<!-- Source File -->
<g id="node1" class="node"><title>Source File</title>
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="66,-24 0,-24 0,-0 66,-0 66,-24"/>
<text text-anchor="middle" x="33" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Source File</text>
</g>
<!-- This Page&#39;s Entity -->
<g id="node2" class="node"><title>This Page&#39;s Entity</title>
<polygon fill="none" stroke="black" points="180,-24 84,-24 84,-0 180,-0 180,-24"/>
<text text-anchor="middle" x="132" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50">This Page&#39;s Entity</text>
</g>
</g>
</svg>

    
    <p>Solid arrows point from a file to a file which depends upon it. A file 
    is dependent upon another if the latter must be compiled before the former
    can be. Where possible, edges connecting nodes are given different colours to make them easier to distinguish in large graphs.
    </p>
    
                      </div>
                    </div>
                  </div>
                </div>
                
      
      <br>

    <section class="visible-xs visible-sm hidden-md">
      






<div class="panel panel-primary">
  <div class="panel-heading text-left"><h3 class="panel-title"><a data-toggle="collapse" href="#mods-1">Modules</a></h3></div>
  <div id="mods-1" class="panel-collapse collapse">
    <div class="list-group">
      
      <a class="list-group-item" href="../module/emdymod.html">EMdymod</a>
      
    </div>
  </div>
</div>















<div class="panel panel-primary">
  <div class="panel-heading text-left"><h3 class="panel-title">Source Code</h3></div>
  <div class="list-group">
    <a class="list-group-item" href="../sourcefile/emdymod.f90.html#src">EMdymod.f90</a>
  </div>
</div>


    </section>
    <br class="visible-xs visible-sm hidden-md">

    <section>
      <h2><span class="anchor" id="src"></span>Source Code</h2>
    <div class="hl"><pre><span></span><a name="ln-1"></a><span class="c">! ###################################################################</span>
<a name="ln-2"></a><span class="c">! Copyright (c) 2013-2016, Marc De Graef/Carnegie Mellon University</span>
<a name="ln-3"></a><span class="c">! All rights reserved.</span>
<a name="ln-4"></a><span class="c">!</span>
<a name="ln-5"></a><span class="c">! Redistribution and use in source and binary forms, with or without modification, are </span>
<a name="ln-6"></a><span class="c">! permitted provided that the following conditions are met:</span>
<a name="ln-7"></a><span class="c">!</span>
<a name="ln-8"></a><span class="c">!     - Redistributions of source code must retain the above copyright notice, this list </span>
<a name="ln-9"></a><span class="c">!        of conditions and the following disclaimer.</span>
<a name="ln-10"></a><span class="c">!     - Redistributions in binary form must reproduce the above copyright notice, this </span>
<a name="ln-11"></a><span class="c">!        list of conditions and the following disclaimer in the documentation and/or </span>
<a name="ln-12"></a><span class="c">!        other materials provided with the distribution.</span>
<a name="ln-13"></a><span class="c">!     - Neither the names of Marc De Graef, Carnegie Mellon University nor the names </span>
<a name="ln-14"></a><span class="c">!        of its contributors may be used to endorse or promote products derived from </span>
<a name="ln-15"></a><span class="c">!        this software without specific prior written permission.</span>
<a name="ln-16"></a><span class="c">!</span>
<a name="ln-17"></a><span class="c">! THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &quot;AS IS&quot; </span>
<a name="ln-18"></a><span class="c">! AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE </span>
<a name="ln-19"></a><span class="c">! IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE </span>
<a name="ln-20"></a><span class="c">! ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE </span>
<a name="ln-21"></a><span class="c">! LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL </span>
<a name="ln-22"></a><span class="c">! DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR </span>
<a name="ln-23"></a><span class="c">! SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER </span>
<a name="ln-24"></a><span class="c">! CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, </span>
<a name="ln-25"></a><span class="c">! OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE </span>
<a name="ln-26"></a><span class="c">! USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span>
<a name="ln-27"></a><span class="c">! ###################################################################</span>
<a name="ln-28"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-29"></a><span class="c">! EMsoft:EMdymod.f90</span>
<a name="ln-30"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-31"></a><span class="c">!</span>
<a name="ln-32"></a><span class="c">! MODULE: EMdymod</span>
<a name="ln-33"></a><span class="c">!</span>
<a name="ln-34"></a><span class="c">!&gt; @author Marc De Graef, Carnegie Mellon University</span>
<a name="ln-35"></a><span class="c">!</span>
<a name="ln-36"></a><span class="c">!&gt; @brief routines that can be called by external code; all routines requiring HDF are in EMdymodHDF.f90</span>
<a name="ln-37"></a><span class="c">!</span>
<a name="ln-38"></a><span class="c">!&gt; @date  10/16/15 MDG 1.0 original</span>
<a name="ln-39"></a><span class="c">!&gt; @date  01/11/16 MDG 2.0 split into this file and EMdymodHDF.f90</span>
<a name="ln-40"></a><span class="c">!&gt; @date  01/12/16 MDG 2.1 added functionality for DREAM.3D progress callback and cancel option</span>
<a name="ln-41"></a><span class="c">!&gt; @date  01/13/16 MDG 2.2 name change of SingleEBSDPattern routine and split into two versions (C and other)</span>
<a name="ln-42"></a><span class="c">!&gt; @date  01/14/16 MDG 2.3 added EMsoftCgetECPatterns routine</span>
<a name="ln-43"></a><span class="c">!&gt; @date  01/25/16 MDG 2.4 several routine name changes</span>
<a name="ln-44"></a><span class="c">!&gt; @date  04/28/16 MDG 2.5 unified the ipar and fpar arrays for all C-callable routines</span>
<a name="ln-45"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-46"></a><span class="c">!</span>
<a name="ln-47"></a><span class="c">! general information: the ipar and fpar arrays for all the routines that are C-callable</span>
<a name="ln-48"></a><span class="c">! are identical, so we document here their component definitions; to allow for future expansion, each</span>
<a name="ln-49"></a><span class="c">! array has 40 entries, of which about half are currently (April 2016) used.</span>
<a name="ln-50"></a><span class="c">!</span>
<a name="ln-51"></a><span class="c">! integer(kind=irg) :: ipar(40)  components </span>
<a name="ln-52"></a><span class="c">! ipar(1) : nx  = (numsx-1)/2</span>
<a name="ln-53"></a><span class="c">! ipar(2) : globalworkgrpsz</span>
<a name="ln-54"></a><span class="c">! ipar(3) : num_el</span>
<a name="ln-55"></a><span class="c">! ipar(4) : totnum_el</span>
<a name="ln-56"></a><span class="c">! ipar(5) : multiplier</span>
<a name="ln-57"></a><span class="c">! ipar(6) : devid</span>
<a name="ln-58"></a><span class="c">! ipar(7) : platid</span>
<a name="ln-59"></a><span class="c">! ipar(8) : CrystalSystem</span>
<a name="ln-60"></a><span class="c">! ipar(9) : Natomtypes</span>
<a name="ln-61"></a><span class="c">! ipar(10): SpaceGroupNumber</span>
<a name="ln-62"></a><span class="c">! ipar(11): SpaceGroupSetting</span>
<a name="ln-63"></a><span class="c">! ipar(12): numEbins</span>
<a name="ln-64"></a><span class="c">! ipar(13): numzbins</span>
<a name="ln-65"></a><span class="c">! ipar(14): mcmode  ( 1 = &#39;full&#39;, 2 = &#39;bse1&#39; )</span>
<a name="ln-66"></a><span class="c">! ipar(15): numangle</span>
<a name="ln-67"></a><span class="c">! ipar(16): nxten = nx/10</span>
<a name="ln-68"></a><span class="c">! the following are only used in the master routine</span>
<a name="ln-69"></a><span class="c">! ipar(17): npx</span>
<a name="ln-70"></a><span class="c">! ipar(18): nthreads</span>
<a name="ln-71"></a><span class="c">! the following are only used in the EBSD pattern routine</span>
<a name="ln-72"></a><span class="c">! ipar(19): numx of detector pixels</span>
<a name="ln-73"></a><span class="c">! ipar(20): numy of detector pixels</span>
<a name="ln-74"></a><span class="c">! ipar(21): number of orientation in quaternion set</span>
<a name="ln-75"></a><span class="c">! ipar(22): binning factor (0-3)</span>
<a name="ln-76"></a><span class="c">! ipar(23): binned x-dimension</span>
<a name="ln-77"></a><span class="c">! ipar(24): binned y-dimension</span>
<a name="ln-78"></a><span class="c">! ipar(25): anglemode  (0 for quaternions, 1 for Euler angles)</span>
<a name="ln-79"></a><span class="c">! ipar(26:40) : 0 (unused for now)</span>
<a name="ln-80"></a>
<a name="ln-81"></a>
<a name="ln-82"></a><span class="c">! real(kind=dbl) :: fpar(40)  components</span>
<a name="ln-83"></a><span class="c">! fpar(1) : sig</span>
<a name="ln-84"></a><span class="c">! fpar(2) : omega</span>
<a name="ln-85"></a><span class="c">! fpar(3) : EkeV</span>
<a name="ln-86"></a><span class="c">! fpar(4) : Ehistmin</span>
<a name="ln-87"></a><span class="c">! fpar(5) : Ebinsize</span>
<a name="ln-88"></a><span class="c">! fpar(6) : depthmax</span>
<a name="ln-89"></a><span class="c">! fpar(7) : depthstep</span>
<a name="ln-90"></a><span class="c">! fpar(8) : sigstart</span>
<a name="ln-91"></a><span class="c">! fpar(9) : sigend</span>
<a name="ln-92"></a><span class="c">! fpar(10): sigstep</span>
<a name="ln-93"></a><span class="c">! parameters only used in the master pattern routine</span>
<a name="ln-94"></a><span class="c">! fpar(11) : dmin</span>
<a name="ln-95"></a><span class="c">! fpar(12) : Bethe  c1</span>
<a name="ln-96"></a><span class="c">! fpar(13) : Bethe  c2</span>
<a name="ln-97"></a><span class="c">! fpar(14) : Bethe  c3</span>
<a name="ln-98"></a><span class="c">! parameters only used in the EBSD pattern routine</span>
<a name="ln-99"></a><span class="c">! fpar(15): pattern center x</span>
<a name="ln-100"></a><span class="c">! fpar(16): pattern center y</span>
<a name="ln-101"></a><span class="c">! fpar(17): scintillator pixel size</span>
<a name="ln-102"></a><span class="c">! fpar(18): detector tilt angle</span>
<a name="ln-103"></a><span class="c">! fpar(19): sample-scintillator distance</span>
<a name="ln-104"></a><span class="c">! fpar(20): beam current</span>
<a name="ln-105"></a><span class="c">! fpar(21): dwelltime</span>
<a name="ln-106"></a><span class="c">! fpar(22): gamma value</span>
<a name="ln-107"></a><span class="c">! fpar(23:40): 0 (unused for now)</span>
<a name="ln-108"></a>
<a name="ln-109"></a>
<a name="ln-110"></a>
<a name="ln-111"></a>
<a name="ln-112"></a><span class="c">!</span>
<a name="ln-113"></a><span class="k">module </span><span class="n">EMdymod</span>
<a name="ln-114"></a>
<a name="ln-115"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-116"></a><span class="c">! Callback routine(s) to communicate progress with DREAM.3D package</span>
<a name="ln-117"></a>
<a name="ln-118"></a><span class="c">! Define interface of call-back routine</span>
<a name="ln-119"></a><span class="c">! arguments are:</span>
<a name="ln-120"></a><span class="c">!  objAddress: unique 8-byte integer to identify the calling class in DREAM.3D</span>
<a name="ln-121"></a><span class="c">!  patternCompleted: integer indicating the current pattern ID number</span>
<a name="ln-122"></a><span class="c">!</span>
<a name="ln-123"></a><span class="k">ABSTRACT INTERFACE</span>
<a name="ln-124"></a><span class="k">   SUBROUTINE </span><span class="n">ProgressCallBack</span><span class="p">(</span><span class="n">objAddress</span><span class="p">,</span> <span class="n">patternCompleted</span><span class="p">)</span>
<a name="ln-125"></a>    <span class="k">USE</span><span class="p">,</span> <span class="k">INTRINSIC</span> <span class="kd">::</span> <span class="nb">ISO_C_BINDING</span>
<a name="ln-126"></a><span class="nb">    </span><span class="kt">INTEGER</span><span class="p">(</span><span class="kt">c_size_t</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">),</span> <span class="k">VALUE</span>          <span class="kd">::</span> <span class="n">objAddress</span>
<a name="ln-127"></a>    <span class="kt">INTEGER</span><span class="p">(</span><span class="nb">KIND</span><span class="o">=</span><span class="mi">4</span><span class="p">),</span> <span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">),</span> <span class="k">VALUE</span>           <span class="kd">::</span> <span class="n">patternCompleted</span>
<a name="ln-128"></a>   <span class="k">END SUBROUTINE </span><span class="n">ProgressCallBack</span>
<a name="ln-129"></a><span class="k">END INTERFACE</span>
<a name="ln-130"></a>
<a name="ln-131"></a>
<a name="ln-132"></a><span class="c">! similar callback routine, with two integer arguments</span>
<a name="ln-133"></a><span class="k">ABSTRACT INTERFACE</span>
<a name="ln-134"></a><span class="k">   SUBROUTINE </span><span class="n">ProgressCallBack2</span><span class="p">(</span><span class="n">objAddress</span><span class="p">,</span> <span class="n">loopCompleted</span><span class="p">,</span> <span class="n">totalLoops</span><span class="p">,</span> <span class="n">bseYield</span><span class="p">)</span>
<a name="ln-135"></a>    <span class="k">USE</span><span class="p">,</span> <span class="k">INTRINSIC</span> <span class="kd">::</span> <span class="nb">ISO_C_BINDING</span>
<a name="ln-136"></a><span class="nb">    </span><span class="kt">INTEGER</span><span class="p">(</span><span class="kt">c_size_t</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">),</span> <span class="k">VALUE</span>          <span class="kd">::</span> <span class="n">objAddress</span>
<a name="ln-137"></a>    <span class="kt">INTEGER</span><span class="p">(</span><span class="nb">KIND</span><span class="o">=</span><span class="mi">4</span><span class="p">),</span> <span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">),</span> <span class="k">VALUE</span>           <span class="kd">::</span> <span class="n">loopCompleted</span>
<a name="ln-138"></a>    <span class="kt">INTEGER</span><span class="p">(</span><span class="nb">KIND</span><span class="o">=</span><span class="mi">4</span><span class="p">),</span> <span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">),</span> <span class="k">VALUE</span>           <span class="kd">::</span> <span class="n">totalLoops</span>
<a name="ln-139"></a>    <span class="kt">REAL</span><span class="p">(</span><span class="nb">KIND</span><span class="o">=</span><span class="mi">4</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">),</span> <span class="k">VALUE</span>              <span class="kd">::</span> <span class="n">bseYield</span>
<a name="ln-140"></a>   <span class="k">END SUBROUTINE </span><span class="n">ProgressCallBack2</span>
<a name="ln-141"></a><span class="k">END INTERFACE</span>
<a name="ln-142"></a>
<a name="ln-143"></a><span class="c">! similar callback routine, with two integer arguments</span>
<a name="ln-144"></a><span class="k">ABSTRACT INTERFACE</span>
<a name="ln-145"></a><span class="k">   SUBROUTINE </span><span class="n">ProgressCallBack3</span><span class="p">(</span><span class="n">objAddress</span><span class="p">,</span> <span class="n">loopCompleted</span><span class="p">,</span> <span class="n">totalLoops</span><span class="p">,</span> <span class="n">EloopCompleted</span><span class="p">,</span> <span class="n">totalEloops</span><span class="p">)</span>
<a name="ln-146"></a>    <span class="k">USE</span><span class="p">,</span> <span class="k">INTRINSIC</span> <span class="kd">::</span> <span class="nb">ISO_C_BINDING</span>
<a name="ln-147"></a><span class="nb">    </span><span class="kt">INTEGER</span><span class="p">(</span><span class="kt">c_size_t</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">),</span> <span class="k">VALUE</span>          <span class="kd">::</span> <span class="n">objAddress</span>
<a name="ln-148"></a>    <span class="kt">INTEGER</span><span class="p">(</span><span class="nb">KIND</span><span class="o">=</span><span class="mi">4</span><span class="p">),</span> <span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">),</span> <span class="k">VALUE</span>           <span class="kd">::</span> <span class="n">loopCompleted</span>
<a name="ln-149"></a>    <span class="kt">INTEGER</span><span class="p">(</span><span class="nb">KIND</span><span class="o">=</span><span class="mi">4</span><span class="p">),</span> <span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">),</span> <span class="k">VALUE</span>           <span class="kd">::</span> <span class="n">totalLoops</span>
<a name="ln-150"></a>    <span class="kt">INTEGER</span><span class="p">(</span><span class="nb">KIND</span><span class="o">=</span><span class="mi">4</span><span class="p">),</span> <span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">),</span> <span class="k">VALUE</span>           <span class="kd">::</span> <span class="n">EloopCompleted</span>
<a name="ln-151"></a>    <span class="kt">INTEGER</span><span class="p">(</span><span class="nb">KIND</span><span class="o">=</span><span class="mi">4</span><span class="p">),</span> <span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">),</span> <span class="k">VALUE</span>           <span class="kd">::</span> <span class="n">totalELoops</span>
<a name="ln-152"></a>   <span class="k">END SUBROUTINE </span><span class="n">ProgressCallBack3</span>
<a name="ln-153"></a><span class="k">END INTERFACE</span>
<a name="ln-154"></a>
<a name="ln-155"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-156"></a>
<a name="ln-157"></a><span class="k">contains</span>
<a name="ln-158"></a>
<a name="ln-159"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-160"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-161"></a><span class="c">! the first series of routines starting with EMsoftC are callable from C/C++</span>
<a name="ln-162"></a><span class="c">! programs and can handle progress callback and a cancel request.</span>
<a name="ln-163"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-164"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-165"></a>
<a name="ln-166"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-167"></a><span class="c">!</span>
<a name="ln-168"></a><span class="c">! SUBROUTINE:EMsoftCgetEBSDPatterns</span>
<a name="ln-169"></a><span class="c">!</span>
<a name="ln-170"></a><span class="c">!&gt; @author Marc De Graef, Carnegie Mellon University</span>
<a name="ln-171"></a><span class="c">!</span>
<a name="ln-172"></a><span class="c">!&gt; @brief This subroutine can be called by a C/C++ program as a standalone function to compute EBSD patterns</span>
<a name="ln-173"></a><span class="c">!</span>
<a name="ln-174"></a><span class="c">!&gt; @details This subroutine provides a method to compute a series of EBSD patterns and</span>
<a name="ln-175"></a><span class="c">!&gt; can be called from an external C/C++ program; the routine provides a callback mechanism to</span>
<a name="ln-176"></a><span class="c">!&gt; update the calling program about computational progress, as well as a cancel option.</span>
<a name="ln-177"></a><span class="c">!&gt; The routine is intended to be called form a C/C++ program, e.g., DREAM.3D.  This routine is a simplified version</span>
<a name="ln-178"></a><span class="c">!&gt; of the core of the EMEBSD program. </span>
<a name="ln-179"></a><span class="c">!&gt;</span>
<a name="ln-180"></a><span class="c">!&gt; @param ipar array with integer input parameters</span>
<a name="ln-181"></a><span class="c">!&gt; @param fpar array with float input parameters</span>
<a name="ln-182"></a><span class="c">!&gt; @param EBSDpattern output array</span>
<a name="ln-183"></a><span class="c">!&gt; @param quats quaternion input array</span>
<a name="ln-184"></a><span class="c">!&gt; @param accum_e array with Monte Carlo histogram</span>
<a name="ln-185"></a><span class="c">!&gt; @param mLPNH Northern hemisphere master pattern</span>
<a name="ln-186"></a><span class="c">!&gt; @param mLPSH Southern hemisphere master pattern</span>
<a name="ln-187"></a><span class="c">!&gt; @param cproc pointer to a C-function for the callback process</span>
<a name="ln-188"></a><span class="c">!&gt; @param objAddress unique integer identifying the calling class in DREAM.3D</span>
<a name="ln-189"></a><span class="c">!&gt; @param cancel character defined by DREAM.3D; when not equal to NULL (i.e., char(0)), the computation should be halted</span>
<a name="ln-190"></a><span class="c">!</span>
<a name="ln-191"></a><span class="c">!&gt; @date 10/16/15 MDG 1.0 original</span>
<a name="ln-192"></a><span class="c">!&gt; @date 11/02/15 MDG 1.1 simplification of the input variables</span>
<a name="ln-193"></a><span class="c">!&gt; @date 11/04/15 MDG 1.2 added array of quaternions as input parameter; used complete mLPNH/SH arrays with local sum</span>
<a name="ln-194"></a><span class="c">!&gt; @date 01/12/16 MDG 1.3 added arguments and functionality for interface with DREAM.3D and other calling programs</span>
<a name="ln-195"></a><span class="c">!&gt; @date 01/13/16 MDG 2.0 forked from original SingleEBSDPattern routine; SAVE atrribute removed; ipar redefined (ipar(1) removed)</span>
<a name="ln-196"></a><span class="c">!&gt; @date 04/28/16 MDG 2.1 adjusted ipar and fpar components to new convention</span>
<a name="ln-197"></a><span class="c">!&gt; @date 06/12/16 MDG 2.2 correction for effective pixel area with respect to equal-area Lambert projection</span>
<a name="ln-198"></a><span class="c">!&gt; @date 07/01/16 MDG 2.3 correction of array subscripts in rgx/y/z arrays.</span>
<a name="ln-199"></a><span class="c">!&gt; @date 12/05/16 MDG 2.4 added option to pass in Euler angles instead of quaternions; quats array dimensions are unchanged</span>
<a name="ln-200"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-201"></a><span class="k">recursive subroutine </span><span class="n">EMsoftCgetEBSDPatterns</span><span class="p">(</span><span class="n">ipar</span><span class="p">,</span> <span class="n">fpar</span><span class="p">,</span> <span class="n">EBSDpattern</span><span class="p">,</span> <span class="n">quats</span><span class="p">,</span> <span class="n">accum_e</span><span class="p">,</span> <span class="n">mLPNH</span><span class="p">,</span> <span class="n">mLPSH</span><span class="p">,</span> <span class="n">cproc</span><span class="p">,</span> <span class="n">objAddress</span><span class="p">,</span> <span class="n">cancel</span><span class="p">)</span> <span class="p">&amp;</span>
<a name="ln-202"></a>           <span class="k">bind</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;EMsoftCgetEBSDPatterns&#39;</span><span class="p">)</span>    <span class="c">! this routine is callable from a C/C++ program</span>
<a name="ln-203"></a><span class="c">!DEC$ ATTRIBUTES DLLEXPORT :: EMsoftCgetEBSDPatterns</span>
<a name="ln-204"></a>
<a name="ln-205"></a><span class="c">! the input parameters are all part of a ipar and fpar input arrays instead of the usual namelist structure to</span>
<a name="ln-206"></a><span class="c">! make this routine callable by external programs, such as DREAM.3D</span>
<a name="ln-207"></a>
<a name="ln-208"></a><span class="c">! The following is the mapping for the ipar and fpar array components used in this routine:</span>
<a name="ln-209"></a><span class="c">!</span>
<a name="ln-210"></a><span class="c">! ipar(1)  = mcnsx</span>
<a name="ln-211"></a><span class="c">! ipar(9)  = numset</span>
<a name="ln-212"></a><span class="c">! ipar(12) = detnumEbins</span>
<a name="ln-213"></a><span class="c">! ipar(17) = mpnpx</span>
<a name="ln-214"></a><span class="c">! ipar(19) = detnumsx</span>
<a name="ln-215"></a><span class="c">! ipar(20) = detnumsy</span>
<a name="ln-216"></a><span class="c">! ipar(21) = numquats</span>
<a name="ln-217"></a><span class="c">! ipar(22) = binning</span>
<a name="ln-218"></a><span class="c">! ipar(23) = binned x-dimension</span>
<a name="ln-219"></a><span class="c">! ipar(24) = binned y-dimension</span>
<a name="ln-220"></a><span class="c">! ipar(25) = anglemode</span>
<a name="ln-221"></a>
<a name="ln-222"></a><span class="c">! fpar(1)  = enl%MCsig</span>
<a name="ln-223"></a><span class="c">! fpar(2)  = enl%omega</span>
<a name="ln-224"></a><span class="c">! fpar(15) = enl%xpc</span>
<a name="ln-225"></a><span class="c">! fpar(16) = enl%ypc</span>
<a name="ln-226"></a><span class="c">! fpar(17) = enl%delta</span>
<a name="ln-227"></a><span class="c">! fpar(18) = enl%thetac</span>
<a name="ln-228"></a><span class="c">! fpar(19) = enl%L</span>
<a name="ln-229"></a><span class="c">! fpar(20) = enl%beamcurrent</span>
<a name="ln-230"></a><span class="c">! fpar(21) = enl%dwelltime</span>
<a name="ln-231"></a><span class="c">! fpar(22) = gammavalue</span>
<a name="ln-232"></a>
<a name="ln-233"></a><span class="k">use </span><span class="n">local</span>
<a name="ln-234"></a><span class="k">use </span><span class="n">constants</span>
<a name="ln-235"></a><span class="k">use </span><span class="n">Lambert</span>
<a name="ln-236"></a><span class="k">use </span><span class="n">quaternions</span>
<a name="ln-237"></a><span class="k">use </span><span class="n">rotations</span>
<a name="ln-238"></a><span class="k">use</span><span class="p">,</span><span class="k">INTRINSIC</span> <span class="kd">::</span> <span class="nb">ISO_C_BINDING</span>
<a name="ln-239"></a>
<a name="ln-240"></a><span class="k">IMPLICIT NONE</span>
<a name="ln-241"></a>
<a name="ln-242"></a><span class="kt">integer</span><span class="p">(</span><span class="kt">c_int32_t</span><span class="p">),</span><span class="k">PARAMETER</span>            <span class="kd">::</span> <span class="n">nipar</span><span class="o">=</span><span class="mi">40</span>
<a name="ln-243"></a><span class="kt">integer</span><span class="p">(</span><span class="kt">c_int32_t</span><span class="p">),</span><span class="k">PARAMETER</span>            <span class="kd">::</span> <span class="n">nfpar</span><span class="o">=</span><span class="mi">40</span>
<a name="ln-244"></a><span class="kt">integer</span><span class="p">(</span><span class="kt">c_int32_t</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>           <span class="kd">::</span> <span class="n">ipar</span><span class="p">(</span><span class="n">nipar</span><span class="p">)</span>
<a name="ln-245"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>               <span class="kd">::</span> <span class="n">fpar</span><span class="p">(</span><span class="n">nfpar</span><span class="p">)</span>
<a name="ln-246"></a><span class="kt">integer</span><span class="p">(</span><span class="kt">c_int32_t</span><span class="p">),</span><span class="k">PARAMETER</span>            <span class="kd">::</span> <span class="n">nq</span><span class="o">=</span><span class="mi">4</span>
<a name="ln-247"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>               <span class="kd">::</span> <span class="n">quats</span><span class="p">(</span><span class="n">nq</span><span class="p">,</span><span class="n">ipar</span><span class="p">(</span><span class="mi">21</span><span class="p">))</span>
<a name="ln-248"></a><span class="kt">integer</span><span class="p">(</span><span class="kt">c_int32_t</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>           <span class="kd">::</span> <span class="n">accum_e</span><span class="p">(</span><span class="n">ipar</span><span class="p">(</span><span class="mi">12</span><span class="p">),</span><span class="o">-</span><span class="n">ipar</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span><span class="n">ipar</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="o">-</span><span class="n">ipar</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span><span class="n">ipar</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
<a name="ln-249"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>               <span class="kd">::</span> <span class="n">mLPNH</span><span class="p">(</span><span class="o">-</span><span class="n">ipar</span><span class="p">(</span><span class="mi">17</span><span class="p">):</span><span class="n">ipar</span><span class="p">(</span><span class="mi">17</span><span class="p">),</span> <span class="o">-</span><span class="n">ipar</span><span class="p">(</span><span class="mi">17</span><span class="p">):</span><span class="n">ipar</span><span class="p">(</span><span class="mi">17</span><span class="p">),</span> <span class="n">ipar</span><span class="p">(</span><span class="mi">12</span><span class="p">),</span> <span class="n">ipar</span><span class="p">(</span><span class="mi">9</span><span class="p">))</span>
<a name="ln-250"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>               <span class="kd">::</span> <span class="n">mLPSH</span><span class="p">(</span><span class="o">-</span><span class="n">ipar</span><span class="p">(</span><span class="mi">17</span><span class="p">):</span><span class="n">ipar</span><span class="p">(</span><span class="mi">17</span><span class="p">),</span> <span class="o">-</span><span class="n">ipar</span><span class="p">(</span><span class="mi">17</span><span class="p">):</span><span class="n">ipar</span><span class="p">(</span><span class="mi">17</span><span class="p">),</span> <span class="n">ipar</span><span class="p">(</span><span class="mi">12</span><span class="p">),</span> <span class="n">ipar</span><span class="p">(</span><span class="mi">9</span><span class="p">))</span>
<a name="ln-251"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">OUT</span><span class="p">)</span>              <span class="kd">::</span> <span class="n">EBSDpattern</span><span class="p">(</span><span class="n">ipar</span><span class="p">(</span><span class="mi">23</span><span class="p">),</span><span class="n">ipar</span><span class="p">(</span><span class="mi">24</span><span class="p">),</span><span class="n">ipar</span><span class="p">(</span><span class="mi">21</span><span class="p">))</span>
<a name="ln-252"></a><span class="k">TYPE</span><span class="p">(</span><span class="kt">C_FUNPTR</span><span class="p">),</span> <span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">),</span> <span class="k">VALUE</span>       <span class="kd">::</span> <span class="n">cproc</span>
<a name="ln-253"></a><span class="kt">integer</span><span class="p">(</span><span class="kt">c_size_t</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">),</span> <span class="k">VALUE</span>     <span class="kd">::</span> <span class="n">objAddress</span>
<a name="ln-254"></a><span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>             <span class="kd">::</span> <span class="n">cancel</span>
<a name="ln-255"></a>
<a name="ln-256"></a><span class="c">! various variables and arrays</span>
<a name="ln-257"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">)</span>                          <span class="kd">::</span> <span class="n">fullsizepattern</span><span class="p">(</span><span class="n">ipar</span><span class="p">(</span><span class="mi">19</span><span class="p">),</span><span class="n">ipar</span><span class="p">(</span><span class="mi">20</span><span class="p">)),</span> <span class="n">binned</span><span class="p">(</span><span class="n">ipar</span><span class="p">(</span><span class="mi">23</span><span class="p">),</span><span class="n">ipar</span><span class="p">(</span><span class="mi">24</span><span class="p">))</span>
<a name="ln-258"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">irg</span><span class="p">),</span><span class="k">allocatable</span>              <span class="kd">::</span> <span class="n">accum_e_detector</span><span class="p">(:,:,:)</span>
<a name="ln-259"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">),</span><span class="k">allocatable</span>              <span class="kd">::</span> <span class="n">rgx</span><span class="p">(:,:),</span> <span class="n">rgy</span><span class="p">(:,:),</span> <span class="n">rgz</span><span class="p">(:,:)</span>
<a name="ln-260"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">),</span><span class="k">allocatable</span>              <span class="kd">::</span> <span class="n">mLPNHsum</span><span class="p">(:,:,:),</span> <span class="n">mLPSHsum</span><span class="p">(:,:,:)</span>
<a name="ln-261"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">),</span><span class="k">save</span>                     <span class="kd">::</span> <span class="n">prefactor</span>
<a name="ln-262"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">),</span><span class="k">allocatable</span>              <span class="kd">::</span> <span class="n">scin_x</span><span class="p">(:),</span> <span class="n">scin_y</span><span class="p">(:)</span>                 <span class="c">! scintillator coordinate arrays [microns]</span>
<a name="ln-263"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">),</span><span class="k">parameter</span>                <span class="kd">::</span> <span class="n">dtor</span> <span class="o">=</span> <span class="mf">0.0174533</span>  <span class="c">! convert from degrees to radians</span>
<a name="ln-264"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">)</span>                          <span class="kd">::</span> <span class="n">alp</span><span class="p">,</span> <span class="n">ca</span><span class="p">,</span> <span class="n">sa</span><span class="p">,</span> <span class="n">cw</span><span class="p">,</span> <span class="n">sw</span><span class="p">,</span> <span class="n">quat</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<a name="ln-265"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">)</span>                          <span class="kd">::</span> <span class="n">L2</span><span class="p">,</span> <span class="n">Ls</span><span class="p">,</span> <span class="n">Lc</span>     <span class="c">! distances</span>
<a name="ln-266"></a><span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">irg</span><span class="p">)</span>                       <span class="kd">::</span> <span class="n">nix</span><span class="p">,</span> <span class="n">niy</span><span class="p">,</span> <span class="n">binx</span><span class="p">,</span> <span class="n">biny</span><span class="p">,</span>  <span class="n">nixp</span><span class="p">,</span> <span class="n">niyp</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">Emin</span><span class="p">,</span> <span class="n">Emax</span><span class="p">,</span> <span class="n">istat</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">dn</span><span class="p">,</span> <span class="n">cn</span><span class="p">,</span> <span class="p">&amp;</span> 
<a name="ln-267"></a>                                           <span class="n">ii</span><span class="p">,</span> <span class="n">jj</span><span class="p">,</span> <span class="n">binfac</span><span class="p">,</span> <span class="n">ipx</span><span class="p">,</span> <span class="n">ipy</span>      <span class="c">! various parameters</span>
<a name="ln-268"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">)</span>                          <span class="kd">::</span> <span class="n">dc</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">scl</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">gam</span><span class="p">,</span> <span class="n">pcvec</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">dp</span><span class="p">,</span> <span class="n">calpha</span>           <span class="c">! direction cosine array</span>
<a name="ln-269"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">)</span>                          <span class="kd">::</span> <span class="n">sx</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dxm</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">dym</span><span class="p">,</span> <span class="n">rhos</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">bindx</span>         <span class="c">! various parameters</span>
<a name="ln-270"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">)</span>                          <span class="kd">::</span> <span class="n">ixy</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<a name="ln-271"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">dbl</span><span class="p">),</span><span class="k">parameter</span>                <span class="kd">::</span> <span class="n">nAmpere</span> <span class="o">=</span> <span class="mf">6.241D+18</span> 
<a name="ln-272"></a><span class="k">PROCEDURE</span><span class="p">(</span><span class="n">ProgressCallBack</span><span class="p">),</span> <span class="k">POINTER</span>    <span class="kd">::</span> <span class="n">proc</span>
<a name="ln-273"></a>
<a name="ln-274"></a><span class="c">! link the proc procedure to the cproc argument</span>
<a name="ln-275"></a><span class="k">CALL </span><span class="nb">C_F_PROCPOINTER</span> <span class="p">(</span><span class="n">cproc</span><span class="p">,</span> <span class="n">proc</span><span class="p">)</span>
<a name="ln-276"></a>
<a name="ln-277"></a><span class="c">! binned pattern dimensions</span>
<a name="ln-278"></a>  <span class="n">binx</span> <span class="o">=</span> <span class="n">ipar</span><span class="p">(</span><span class="mi">23</span><span class="p">)</span>
<a name="ln-279"></a>  <span class="n">biny</span> <span class="o">=</span> <span class="n">ipar</span><span class="p">(</span><span class="mi">24</span><span class="p">)</span>
<a name="ln-280"></a>  <span class="n">binfac</span> <span class="o">=</span> <span class="mi">2</span><span class="o">**</span><span class="n">ipar</span><span class="p">(</span><span class="mi">22</span><span class="p">)</span>
<a name="ln-281"></a>  <span class="n">bindx</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">binfac</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
<a name="ln-282"></a>
<a name="ln-283"></a><span class="c">!====================================</span>
<a name="ln-284"></a><span class="c">! ------ generate the detector rgx, rgy, rgz arrays (and a few others)</span>
<a name="ln-285"></a><span class="c">!====================================</span>
<a name="ln-286"></a>  <span class="k">if</span> <span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">mLPNHsum</span><span class="p">))</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">mLPNHsum</span><span class="p">)</span>
<a name="ln-287"></a>  <span class="k">if</span> <span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">mLPSHsum</span><span class="p">))</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">mLPSHsum</span><span class="p">)</span>
<a name="ln-288"></a>
<a name="ln-289"></a>  <span class="k">allocate</span><span class="p">(</span><span class="n">mLPNHsum</span><span class="p">(</span><span class="o">-</span><span class="n">ipar</span><span class="p">(</span><span class="mi">17</span><span class="p">):</span><span class="n">ipar</span><span class="p">(</span><span class="mi">17</span><span class="p">),</span> <span class="o">-</span><span class="n">ipar</span><span class="p">(</span><span class="mi">17</span><span class="p">):</span><span class="n">ipar</span><span class="p">(</span><span class="mi">17</span><span class="p">),</span> <span class="n">ipar</span><span class="p">(</span><span class="mi">12</span><span class="p">)))</span>
<a name="ln-290"></a>  <span class="k">allocate</span><span class="p">(</span><span class="n">mLPSHsum</span><span class="p">(</span><span class="o">-</span><span class="n">ipar</span><span class="p">(</span><span class="mi">17</span><span class="p">):</span><span class="n">ipar</span><span class="p">(</span><span class="mi">17</span><span class="p">),</span> <span class="o">-</span><span class="n">ipar</span><span class="p">(</span><span class="mi">17</span><span class="p">):</span><span class="n">ipar</span><span class="p">(</span><span class="mi">17</span><span class="p">),</span> <span class="n">ipar</span><span class="p">(</span><span class="mi">12</span><span class="p">)))</span>
<a name="ln-291"></a>  <span class="n">mLPNHsum</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">mLPNH</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>
<a name="ln-292"></a>  <span class="n">mLPSHsum</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">mLPSH</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>
<a name="ln-293"></a>
<a name="ln-294"></a>  <span class="k">allocate</span><span class="p">(</span><span class="n">scin_x</span><span class="p">(</span><span class="n">ipar</span><span class="p">(</span><span class="mi">19</span><span class="p">)),</span><span class="n">scin_y</span><span class="p">(</span><span class="n">ipar</span><span class="p">(</span><span class="mi">20</span><span class="p">)),</span><span class="nb">stat</span><span class="o">=</span><span class="n">istat</span><span class="p">)</span>
<a name="ln-295"></a>  
<a name="ln-296"></a>  <span class="n">scin_x</span> <span class="o">=</span> <span class="o">-</span> <span class="p">(</span> <span class="n">fpar</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="nb">float</span><span class="p">(</span><span class="n">ipar</span><span class="p">(</span><span class="mi">19</span><span class="p">))</span> <span class="p">)</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="o">-</span> <span class="p">(</span><span class="o">/</span> <span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">ipar</span><span class="p">(</span><span class="mi">19</span><span class="p">))</span> <span class="o">/</span><span class="p">)</span> <span class="p">)</span> <span class="o">*</span> <span class="n">fpar</span><span class="p">(</span><span class="mi">17</span><span class="p">)</span>
<a name="ln-297"></a>  <span class="n">scin_y</span> <span class="o">=</span> <span class="p">(</span> <span class="n">fpar</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="nb">float</span><span class="p">(</span><span class="n">ipar</span><span class="p">(</span><span class="mi">20</span><span class="p">))</span> <span class="p">)</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="o">-</span> <span class="p">(</span><span class="o">/</span> <span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">ipar</span><span class="p">(</span><span class="mi">20</span><span class="p">))</span> <span class="o">/</span><span class="p">)</span> <span class="p">)</span> <span class="o">*</span> <span class="n">fpar</span><span class="p">(</span><span class="mi">17</span><span class="p">)</span>
<a name="ln-298"></a>
<a name="ln-299"></a><span class="c">! auxiliary angle to rotate between reference frames</span>
<a name="ln-300"></a>  <span class="n">alp</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">cPi</span> <span class="o">-</span> <span class="p">(</span><span class="n">fpar</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">fpar</span><span class="p">(</span><span class="mi">18</span><span class="p">))</span> <span class="o">*</span> <span class="n">dtor</span>
<a name="ln-301"></a>  <span class="n">ca</span> <span class="o">=</span> <span class="nb">cos</span><span class="p">(</span><span class="n">alp</span><span class="p">)</span>
<a name="ln-302"></a>  <span class="n">sa</span> <span class="o">=</span> <span class="nb">sin</span><span class="p">(</span><span class="n">alp</span><span class="p">)</span>
<a name="ln-303"></a>
<a name="ln-304"></a>  <span class="n">cw</span> <span class="o">=</span> <span class="nb">cos</span><span class="p">(</span><span class="n">fpar</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">dtor</span><span class="p">)</span>
<a name="ln-305"></a>  <span class="n">sw</span> <span class="o">=</span> <span class="nb">sin</span><span class="p">(</span><span class="n">fpar</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">dtor</span><span class="p">)</span>
<a name="ln-306"></a>
<a name="ln-307"></a><span class="c">! compute auxilliary interpolation arrays</span>
<a name="ln-308"></a>  <span class="k">if</span> <span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">rgx</span><span class="p">))</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">rgx</span><span class="p">,</span> <span class="n">rgy</span><span class="p">,</span> <span class="n">rgz</span><span class="p">)</span>
<a name="ln-309"></a>
<a name="ln-310"></a>  <span class="k">allocate</span><span class="p">(</span><span class="n">rgx</span><span class="p">(</span><span class="n">ipar</span><span class="p">(</span><span class="mi">19</span><span class="p">),</span><span class="n">ipar</span><span class="p">(</span><span class="mi">20</span><span class="p">)),</span> <span class="n">rgy</span><span class="p">(</span><span class="n">ipar</span><span class="p">(</span><span class="mi">19</span><span class="p">),</span><span class="n">ipar</span><span class="p">(</span><span class="mi">20</span><span class="p">)),</span> <span class="n">rgz</span><span class="p">(</span><span class="n">ipar</span><span class="p">(</span><span class="mi">19</span><span class="p">),</span><span class="n">ipar</span><span class="p">(</span><span class="mi">20</span><span class="p">)))</span>
<a name="ln-311"></a>
<a name="ln-312"></a>  <span class="n">L2</span> <span class="o">=</span> <span class="n">fpar</span><span class="p">(</span><span class="mi">19</span><span class="p">)</span> <span class="o">*</span> <span class="n">fpar</span><span class="p">(</span><span class="mi">19</span><span class="p">)</span>
<a name="ln-313"></a>  <span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">ipar</span><span class="p">(</span><span class="mi">19</span><span class="p">)</span>
<a name="ln-314"></a>    <span class="n">sx</span> <span class="o">=</span> <span class="n">L2</span> <span class="o">+</span> <span class="n">scin_x</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="o">*</span> <span class="n">scin_x</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
<a name="ln-315"></a>    <span class="n">Ls</span> <span class="o">=</span> <span class="o">-</span><span class="n">sw</span> <span class="o">*</span> <span class="n">scin_x</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="o">+</span> <span class="n">fpar</span><span class="p">(</span><span class="mi">19</span><span class="p">)</span> <span class="o">*</span> <span class="n">cw</span>
<a name="ln-316"></a>    <span class="n">Lc</span> <span class="o">=</span> <span class="n">cw</span> <span class="o">*</span> <span class="n">scin_x</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="o">+</span> <span class="n">fpar</span><span class="p">(</span><span class="mi">19</span><span class="p">)</span> <span class="o">*</span> <span class="n">sw</span>
<a name="ln-317"></a>    <span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">ipar</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
<a name="ln-318"></a><span class="c">!   rhos = 1.0/sqrt(sx + scin_y(i)**2)</span>
<a name="ln-319"></a>     <span class="n">rgx</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">scin_y</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">*</span> <span class="n">ca</span> <span class="o">+</span> <span class="n">sa</span> <span class="o">*</span> <span class="n">Ls</span><span class="p">)</span> <span class="c">! * rhos</span>
<a name="ln-320"></a>     <span class="n">rgy</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="n">Lc</span> <span class="c">! * rhos</span>
<a name="ln-321"></a>     <span class="n">rgz</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">sa</span> <span class="o">*</span> <span class="n">scin_y</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="n">ca</span> <span class="o">*</span> <span class="n">Ls</span><span class="p">)</span> <span class="c">! * rhos</span>
<a name="ln-322"></a><span class="c">! make sure that these vectors are normalized !</span>
<a name="ln-323"></a>     <span class="n">x</span> <span class="o">=</span> <span class="nb">sqrt</span><span class="p">(</span><span class="n">rgx</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">rgy</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">rgz</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
<a name="ln-324"></a>     <span class="n">rgx</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="n">rgx</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">)</span> <span class="o">/</span> <span class="n">x</span>
<a name="ln-325"></a>     <span class="n">rgy</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="n">rgy</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">)</span> <span class="o">/</span> <span class="n">x</span>
<a name="ln-326"></a>     <span class="n">rgz</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="n">rgz</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">)</span> <span class="o">/</span> <span class="n">x</span>
<a name="ln-327"></a>    <span class="k">end do</span>
<a name="ln-328"></a><span class="k">  end do</span>
<a name="ln-329"></a>
<a name="ln-330"></a><span class="c">! remove the auxiliary arrays scin_x and scin_y</span>
<a name="ln-331"></a>  <span class="k">deallocate</span><span class="p">(</span><span class="n">scin_x</span><span class="p">,</span> <span class="n">scin_y</span><span class="p">)</span>
<a name="ln-332"></a>
<a name="ln-333"></a><span class="c">!====================================</span>
<a name="ln-334"></a><span class="c">! ------ create the equivalent detector energy array</span>
<a name="ln-335"></a><span class="c">!====================================</span>
<a name="ln-336"></a><span class="c">! from the Monte Carlo energy data, we need to extract the relevant</span>
<a name="ln-337"></a><span class="c">! entries for the detector geometry defined above.  </span>
<a name="ln-338"></a>
<a name="ln-339"></a><span class="c">! determine the scale factor for the Lambert interpolation; the square has</span>
<a name="ln-340"></a><span class="c">! an edge length of 2 x sqrt(pi/2)</span>
<a name="ln-341"></a>  <span class="n">scl</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">ipar</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span> 
<a name="ln-342"></a>
<a name="ln-343"></a><span class="c">! energy summation will go over all energy bins</span>
<a name="ln-344"></a>  <span class="n">Emin</span> <span class="o">=</span> <span class="mi">1</span>
<a name="ln-345"></a>  <span class="n">Emax</span> <span class="o">=</span> <span class="n">ipar</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span>
<a name="ln-346"></a>
<a name="ln-347"></a>  <span class="k">if</span> <span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">accum_e_detector</span><span class="p">))</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">accum_e_detector</span><span class="p">)</span>
<a name="ln-348"></a>
<a name="ln-349"></a>  <span class="k">allocate</span><span class="p">(</span><span class="n">accum_e_detector</span><span class="p">(</span><span class="n">ipar</span><span class="p">(</span><span class="mi">12</span><span class="p">),</span><span class="n">ipar</span><span class="p">(</span><span class="mi">19</span><span class="p">),</span><span class="n">ipar</span><span class="p">(</span><span class="mi">20</span><span class="p">)))</span>
<a name="ln-350"></a>
<a name="ln-351"></a><span class="c">! correction of change in effective pixel area compared to equal-area Lambert projection</span>
<a name="ln-352"></a>  <span class="n">alpha</span> <span class="o">=</span> <span class="nb">atan</span><span class="p">(</span><span class="n">fpar</span><span class="p">(</span><span class="mi">17</span><span class="p">)</span><span class="o">/</span><span class="n">fpar</span><span class="p">(</span><span class="mi">19</span><span class="p">)</span><span class="o">/</span><span class="nb">sqrt</span><span class="p">(</span><span class="nb">sngl</span><span class="p">(</span><span class="n">cPi</span><span class="p">)))</span>
<a name="ln-353"></a>  <span class="n">ipx</span> <span class="o">=</span> <span class="n">ipar</span><span class="p">(</span><span class="mi">19</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="nb">nint</span><span class="p">(</span><span class="n">fpar</span><span class="p">(</span><span class="mi">15</span><span class="p">))</span>
<a name="ln-354"></a>  <span class="n">ipy</span> <span class="o">=</span> <span class="n">ipar</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="nb">nint</span><span class="p">(</span><span class="n">fpar</span><span class="p">(</span><span class="mi">16</span><span class="p">))</span>
<a name="ln-355"></a>  <span class="k">if</span> <span class="p">(</span><span class="n">ipx</span> <span class="p">.</span><span class="n">gt</span><span class="p">.</span> <span class="n">ipar</span><span class="p">(</span><span class="mi">19</span><span class="p">))</span> <span class="n">ipx</span> <span class="o">=</span> <span class="n">ipar</span><span class="p">(</span><span class="mi">19</span><span class="p">)</span>
<a name="ln-356"></a>  <span class="k">if</span> <span class="p">(</span><span class="n">ipx</span> <span class="p">.</span><span class="n">lt</span><span class="p">.</span> <span class="mi">1</span><span class="p">)</span> <span class="n">ipx</span> <span class="o">=</span> <span class="mi">1</span>
<a name="ln-357"></a>  <span class="k">if</span> <span class="p">(</span><span class="n">ipy</span> <span class="p">.</span><span class="n">gt</span><span class="p">.</span> <span class="n">ipar</span><span class="p">(</span><span class="mi">20</span><span class="p">))</span> <span class="n">ipy</span> <span class="o">=</span> <span class="n">ipar</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
<a name="ln-358"></a>  <span class="k">if</span> <span class="p">(</span><span class="n">ipy</span> <span class="p">.</span><span class="n">lt</span><span class="p">.</span> <span class="mi">1</span><span class="p">)</span> <span class="n">ipy</span> <span class="o">=</span> <span class="mi">1</span>
<a name="ln-359"></a>  <span class="n">pcvec</span> <span class="o">=</span> <span class="p">(</span><span class="o">/</span> <span class="n">rgx</span><span class="p">(</span><span class="n">ipx</span><span class="p">,</span><span class="n">ipy</span><span class="p">),</span> <span class="n">rgy</span><span class="p">(</span><span class="n">ipx</span><span class="p">,</span><span class="n">ipy</span><span class="p">),</span> <span class="n">rgz</span><span class="p">(</span><span class="n">ipx</span><span class="p">,</span><span class="n">ipy</span><span class="p">)</span> <span class="o">/</span><span class="p">)</span>
<a name="ln-360"></a>  <span class="n">calpha</span> <span class="o">=</span> <span class="nb">cos</span><span class="p">(</span><span class="n">alpha</span><span class="p">)</span>
<a name="ln-361"></a>  <span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">ipar</span><span class="p">(</span><span class="mi">19</span><span class="p">)</span>
<a name="ln-362"></a>    <span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">ipar</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
<a name="ln-363"></a><span class="c">! do the coordinate transformation for this detector pixel</span>
<a name="ln-364"></a>       <span class="n">dc</span> <span class="o">=</span> <span class="p">(</span><span class="o">/</span> <span class="n">rgx</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">),</span> <span class="n">rgy</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">),</span> <span class="n">rgz</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span> <span class="o">/</span><span class="p">)</span>
<a name="ln-365"></a><span class="c">! make sure the third one is positive; if not, switch all </span>
<a name="ln-366"></a>       <span class="k">if</span> <span class="p">(</span><span class="n">dc</span><span class="p">(</span><span class="mi">3</span><span class="p">).</span><span class="n">lt</span><span class="p">.</span><span class="mf">0.0</span><span class="p">)</span> <span class="n">dc</span> <span class="o">=</span> <span class="o">-</span><span class="n">dc</span>
<a name="ln-367"></a><span class="c">! convert these direction cosines to coordinates in the Rosca-Lambert projection</span>
<a name="ln-368"></a>        <span class="n">ixy</span> <span class="o">=</span> <span class="n">scl</span> <span class="o">*</span> <span class="n">LambertSphereToSquare</span><span class="p">(</span> <span class="n">dc</span><span class="p">,</span> <span class="n">istat</span> <span class="p">)</span>
<a name="ln-369"></a>        <span class="n">x</span> <span class="o">=</span> <span class="n">ixy</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-370"></a>        <span class="n">ixy</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">ixy</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<a name="ln-371"></a>        <span class="n">ixy</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="n">x</span>
<a name="ln-372"></a><span class="c">! four-point interpolation (bi-quadratic)</span>
<a name="ln-373"></a>        <span class="n">nix</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ipar</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="n">ixy</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="o">-</span><span class="n">ipar</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-374"></a>        <span class="n">niy</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ipar</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="n">ixy</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span><span class="o">-</span><span class="n">ipar</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-375"></a>        <span class="n">dx</span> <span class="o">=</span> <span class="n">ixy</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">nix</span>
<a name="ln-376"></a>        <span class="n">dy</span> <span class="o">=</span> <span class="n">ixy</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">-</span><span class="n">niy</span>
<a name="ln-377"></a>        <span class="n">dxm</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">-</span><span class="n">dx</span>
<a name="ln-378"></a>        <span class="n">dym</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">-</span><span class="n">dy</span>
<a name="ln-379"></a><span class="c">! do the area correction for this detector pixel</span>
<a name="ln-380"></a>        <span class="n">dp</span> <span class="o">=</span> <span class="nb">dot_product</span><span class="p">(</span><span class="n">pcvec</span><span class="p">,</span><span class="n">dc</span><span class="p">)</span>
<a name="ln-381"></a>        <span class="k">if</span> <span class="p">((</span><span class="n">i</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="n">ipx</span><span class="p">).</span><span class="nb">and</span><span class="p">.(</span><span class="n">j</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="n">ipy</span><span class="p">))</span> <span class="k">then</span>
<a name="ln-382"></a><span class="k">          </span><span class="n">gam</span> <span class="o">=</span> <span class="mf">0.25</span> 
<a name="ln-383"></a>        <span class="k">else</span>
<a name="ln-384"></a><span class="k">          </span><span class="n">theta</span> <span class="o">=</span> <span class="n">calpha</span><span class="o">*</span><span class="n">calpha</span> <span class="o">+</span> <span class="n">dp</span><span class="o">*</span><span class="n">dp</span> <span class="o">-</span> <span class="mf">1.0</span>
<a name="ln-385"></a>          <span class="n">gam</span> <span class="o">=</span> <span class="n">theta</span><span class="o">**</span><span class="mf">1.5</span><span class="o">/</span><span class="p">(</span><span class="n">calpha</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.25</span>
<a name="ln-386"></a>          
<a name="ln-387"></a>        <span class="k">end if</span>
<a name="ln-388"></a><span class="c">! interpolate the intensity </span>
<a name="ln-389"></a>        <span class="k">do </span><span class="n">k</span><span class="o">=</span> <span class="n">Emin</span><span class="p">,</span> <span class="n">Emax</span>
<a name="ln-390"></a>          <span class="n">accum_e_detector</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span> <span class="o">=</span> <span class="n">gam</span> <span class="o">*</span> <span class="p">(</span><span class="n">accum_e</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">nix</span><span class="p">,</span><span class="n">niy</span><span class="p">)</span> <span class="o">*</span> <span class="n">dxm</span> <span class="o">*</span> <span class="n">dym</span> <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-391"></a>                                    <span class="n">accum_e</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">nix</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">niy</span><span class="p">)</span> <span class="o">*</span> <span class="n">dx</span> <span class="o">*</span> <span class="n">dym</span> <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-392"></a>                                    <span class="n">accum_e</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">nix</span><span class="p">,</span><span class="n">niy</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">dxm</span> <span class="o">*</span> <span class="n">dy</span> <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-393"></a>                                    <span class="n">accum_e</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">nix</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">niy</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">dx</span> <span class="o">*</span> <span class="n">dy</span><span class="p">)</span>
<a name="ln-394"></a>        <span class="k">end do</span>
<a name="ln-395"></a><span class="k">    end do</span>
<a name="ln-396"></a><span class="k">  end do </span>
<a name="ln-397"></a><span class="k">  </span><span class="n">prefactor</span> <span class="o">=</span> <span class="mf">0.25D0</span> <span class="o">*</span> <span class="n">nAmpere</span> <span class="o">*</span> <span class="n">fpar</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span> <span class="o">*</span> <span class="n">fpar</span><span class="p">(</span><span class="mi">21</span><span class="p">)</span>  <span class="o">*</span> <span class="mf">1.0D-15</span> <span class="o">/</span> <span class="nb">sum</span><span class="p">(</span><span class="n">accum_e_detector</span><span class="p">)</span>
<a name="ln-398"></a>  <span class="n">accum_e_detector</span> <span class="o">=</span> <span class="n">accum_e_detector</span> <span class="o">*</span> <span class="n">prefactor</span>
<a name="ln-399"></a>
<a name="ln-400"></a><span class="c">! from here on, we simply compute the EBSD patterns by interpolation, using the above arrays</span>
<a name="ln-401"></a><span class="c">! no intensity scaling or anything else...other than multiplication by pre-factor</span>
<a name="ln-402"></a><span class="c">! intensity scaling is left to the user of the calling program.</span>
<a name="ln-403"></a>
<a name="ln-404"></a><span class="c">! define some parameters and initialize EBSDpattern</span>
<a name="ln-405"></a><span class="n">scl</span> <span class="o">=</span> <span class="nb">dble</span><span class="p">(</span><span class="n">ipar</span><span class="p">(</span><span class="mi">17</span><span class="p">))</span> 
<a name="ln-406"></a><span class="n">EBSDpattern</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-407"></a><span class="n">fullsizepattern</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-408"></a><span class="n">dn</span> <span class="o">=</span> <span class="nb">nint</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">ipar</span><span class="p">(</span><span class="mi">21</span><span class="p">))</span><span class="o">*</span><span class="mf">0.01</span><span class="p">)</span>
<a name="ln-409"></a><span class="n">cn</span> <span class="o">=</span> <span class="n">dn</span>
<a name="ln-410"></a>
<a name="ln-411"></a><span class="c">! here is the main loop over all quaternions</span>
<a name="ln-412"></a><span class="n">quatloop</span><span class="p">:</span> <span class="k">do </span><span class="n">ip</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">ipar</span><span class="p">(</span><span class="mi">21</span><span class="p">)</span>
<a name="ln-413"></a>  <span class="n">binned</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-414"></a>  <span class="n">fullsizepattern</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-415"></a>  <span class="k">if</span> <span class="p">(</span><span class="n">ipar</span><span class="p">(</span><span class="mi">25</span><span class="p">).</span><span class="n">eq</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span> <span class="k">then </span>
<a name="ln-416"></a><span class="k">    </span><span class="n">quat</span> <span class="o">=</span> <span class="n">quats</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span><span class="n">ip</span><span class="p">)</span>
<a name="ln-417"></a>  <span class="k">else</span>
<a name="ln-418"></a><span class="k">    </span><span class="n">quat</span> <span class="o">=</span> <span class="n">eu2qu</span><span class="p">(</span><span class="n">quats</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span><span class="n">ip</span><span class="p">))</span> <span class="c">! this assumes that the input Euler angles are in radians</span>
<a name="ln-419"></a>  <span class="k">end if</span>
<a name="ln-420"></a><span class="k">  do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">ipar</span><span class="p">(</span><span class="mi">19</span><span class="p">)</span>
<a name="ln-421"></a>    <span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">ipar</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
<a name="ln-422"></a><span class="c">! do the active coordinate transformation for this euler angle</span>
<a name="ln-423"></a>      <span class="n">dc</span> <span class="o">=</span> <span class="n">quat_Lp</span><span class="p">(</span><span class="n">quat</span><span class="p">,</span>  <span class="p">(</span><span class="o">/</span> <span class="n">rgx</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">),</span> <span class="n">rgy</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">),</span> <span class="n">rgz</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span> <span class="o">/</span><span class="p">)</span> <span class="p">)</span>
<a name="ln-424"></a><span class="c">! normalize dc</span>
<a name="ln-425"></a>      <span class="n">dc</span> <span class="o">=</span> <span class="n">dc</span><span class="o">/</span><span class="nb">sqrt</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">dc</span><span class="o">*</span><span class="n">dc</span><span class="p">))</span>
<a name="ln-426"></a><span class="c">! convert these direction cosines to coordinates in the Rosca-Lambert projection (always square projection !!!)</span>
<a name="ln-427"></a>      <span class="n">ixy</span> <span class="o">=</span> <span class="n">scl</span> <span class="o">*</span> <span class="n">LambertSphereToSquare</span><span class="p">(</span> <span class="n">dc</span><span class="p">,</span> <span class="n">istat</span> <span class="p">)</span>
<a name="ln-428"></a>
<a name="ln-429"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">istat</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span> <span class="k">then</span> 
<a name="ln-430"></a><span class="c">! four-point interpolation (bi-quadratic)</span>
<a name="ln-431"></a>        <span class="n">nix</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ipar</span><span class="p">(</span><span class="mi">17</span><span class="p">)</span><span class="o">+</span><span class="n">ixy</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="o">-</span><span class="n">ipar</span><span class="p">(</span><span class="mi">17</span><span class="p">)</span>
<a name="ln-432"></a>        <span class="n">niy</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ipar</span><span class="p">(</span><span class="mi">17</span><span class="p">)</span><span class="o">+</span><span class="n">ixy</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span><span class="o">-</span><span class="n">ipar</span><span class="p">(</span><span class="mi">17</span><span class="p">)</span>
<a name="ln-433"></a>        <span class="n">nixp</span> <span class="o">=</span> <span class="n">nix</span><span class="o">+</span><span class="mi">1</span>
<a name="ln-434"></a>        <span class="n">niyp</span> <span class="o">=</span> <span class="n">niy</span><span class="o">+</span><span class="mi">1</span>
<a name="ln-435"></a>        <span class="k">if</span> <span class="p">(</span><span class="n">nixp</span><span class="p">.</span><span class="n">gt</span><span class="p">.</span><span class="n">ipar</span><span class="p">(</span><span class="mi">17</span><span class="p">))</span> <span class="n">nixp</span> <span class="o">=</span> <span class="n">nix</span>
<a name="ln-436"></a>        <span class="k">if</span> <span class="p">(</span><span class="n">niyp</span><span class="p">.</span><span class="n">gt</span><span class="p">.</span><span class="n">ipar</span><span class="p">(</span><span class="mi">17</span><span class="p">))</span> <span class="n">niyp</span> <span class="o">=</span> <span class="n">niy</span>
<a name="ln-437"></a>        <span class="k">if</span> <span class="p">(</span><span class="n">nix</span><span class="p">.</span><span class="n">lt</span><span class="p">.</span><span class="o">-</span><span class="n">ipar</span><span class="p">(</span><span class="mi">17</span><span class="p">))</span> <span class="n">nix</span> <span class="o">=</span> <span class="n">nixp</span>
<a name="ln-438"></a>        <span class="k">if</span> <span class="p">(</span><span class="n">niy</span><span class="p">.</span><span class="n">lt</span><span class="p">.</span><span class="o">-</span><span class="n">ipar</span><span class="p">(</span><span class="mi">17</span><span class="p">))</span> <span class="n">niy</span> <span class="o">=</span> <span class="n">niyp</span>
<a name="ln-439"></a>        <span class="n">dx</span> <span class="o">=</span> <span class="n">ixy</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">nix</span>
<a name="ln-440"></a>        <span class="n">dy</span> <span class="o">=</span> <span class="n">ixy</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">-</span><span class="n">niy</span>
<a name="ln-441"></a>        <span class="n">dxm</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">-</span><span class="n">dx</span>
<a name="ln-442"></a>        <span class="n">dym</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">-</span><span class="n">dy</span>
<a name="ln-443"></a>        <span class="k">if</span> <span class="p">(</span><span class="n">dc</span><span class="p">(</span><span class="mi">3</span><span class="p">).</span><span class="n">gt</span><span class="p">.</span><span class="mf">0.0</span><span class="p">)</span> <span class="k">then</span> <span class="c">! we&#39;re in the Northern hemisphere</span>
<a name="ln-444"></a>          <span class="k">do </span><span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">ipar</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span> 
<a name="ln-445"></a>            <span class="n">fullsizepattern</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span> <span class="o">=</span> <span class="n">fullsizepattern</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span> <span class="o">+</span> <span class="n">accum_e_detector</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span> <span class="n">mLPNHsum</span><span class="p">(</span><span class="n">nix</span><span class="p">,</span><span class="n">niy</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">*</span> <span class="n">dxm</span> <span class="o">*</span> <span class="n">dym</span> <span class="o">+</span><span class="p">&amp;</span>
<a name="ln-446"></a>                                        <span class="n">mLPNHsum</span><span class="p">(</span><span class="n">nixp</span><span class="p">,</span><span class="n">niy</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">*</span> <span class="n">dx</span> <span class="o">*</span> <span class="n">dym</span> <span class="o">+</span> <span class="n">mLPNHsum</span><span class="p">(</span><span class="n">nix</span><span class="p">,</span><span class="n">niyp</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">*</span> <span class="n">dxm</span> <span class="o">*</span> <span class="n">dy</span> <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-447"></a>                                        <span class="n">mLPNHsum</span><span class="p">(</span><span class="n">nixp</span><span class="p">,</span><span class="n">niyp</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">*</span> <span class="n">dx</span> <span class="o">*</span> <span class="n">dy</span> <span class="p">)</span>
<a name="ln-448"></a>          <span class="k">end do</span>
<a name="ln-449"></a><span class="k">        else</span>                   <span class="c">! we&#39;re in the Southern hemisphere</span>
<a name="ln-450"></a>          <span class="k">do </span><span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">ipar</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span> 
<a name="ln-451"></a>            <span class="n">fullsizepattern</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span> <span class="o">=</span> <span class="n">fullsizepattern</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span> <span class="o">+</span> <span class="n">accum_e_detector</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span> <span class="n">mLPSHsum</span><span class="p">(</span><span class="n">nix</span><span class="p">,</span><span class="n">niy</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">*</span> <span class="n">dxm</span> <span class="o">*</span> <span class="n">dym</span> <span class="o">+</span><span class="p">&amp;</span>
<a name="ln-452"></a>                                        <span class="n">mLPSHsum</span><span class="p">(</span><span class="n">nixp</span><span class="p">,</span><span class="n">niy</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">*</span> <span class="n">dx</span> <span class="o">*</span> <span class="n">dym</span> <span class="o">+</span> <span class="n">mLPSHsum</span><span class="p">(</span><span class="n">nix</span><span class="p">,</span><span class="n">niyp</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">*</span> <span class="n">dxm</span> <span class="o">*</span> <span class="n">dy</span> <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-453"></a>                                        <span class="n">mLPSHsum</span><span class="p">(</span><span class="n">nixp</span><span class="p">,</span><span class="n">niyp</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">*</span> <span class="n">dx</span> <span class="o">*</span> <span class="n">dy</span> <span class="p">)</span>
<a name="ln-454"></a>          <span class="k">end do</span>
<a name="ln-455"></a><span class="k">        end if</span>
<a name="ln-456"></a><span class="k">      end if</span>
<a name="ln-457"></a><span class="k">    end do</span>
<a name="ln-458"></a><span class="k">  end do</span>
<a name="ln-459"></a>
<a name="ln-460"></a><span class="c">! bin the pattern if necessary and apply the gamma scaling factor</span>
<a name="ln-461"></a>  <span class="k">if</span> <span class="p">(</span><span class="n">binx</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="n">ipar</span><span class="p">(</span><span class="mi">19</span><span class="p">))</span> <span class="k">then </span>
<a name="ln-462"></a><span class="k">    do </span><span class="n">ii</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">ipar</span><span class="p">(</span><span class="mi">19</span><span class="p">),</span><span class="n">binfac</span>
<a name="ln-463"></a>        <span class="k">do </span><span class="n">jj</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">ipar</span><span class="p">(</span><span class="mi">20</span><span class="p">),</span><span class="n">binfac</span>
<a name="ln-464"></a>            <span class="n">binned</span><span class="p">(</span><span class="n">ii</span><span class="o">/</span><span class="n">binfac</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">jj</span><span class="o">/</span><span class="n">binfac</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="p">&amp;</span>
<a name="ln-465"></a>            <span class="nb">sum</span><span class="p">(</span><span class="n">fullsizepattern</span><span class="p">(</span><span class="n">ii</span><span class="p">:</span><span class="n">ii</span><span class="o">+</span><span class="n">binfac</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">jj</span><span class="p">:</span><span class="n">jj</span><span class="o">+</span><span class="n">binfac</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
<a name="ln-466"></a>        <span class="k">end do</span>
<a name="ln-467"></a><span class="k">    end do</span>
<a name="ln-468"></a><span class="k">    </span><span class="n">EBSDpattern</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">binx</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">biny</span><span class="p">,</span><span class="n">ip</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">binned</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">binx</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">biny</span><span class="p">)</span><span class="o">*</span> <span class="n">bindx</span><span class="p">)</span><span class="o">**</span><span class="n">fpar</span><span class="p">(</span><span class="mi">22</span><span class="p">)</span>
<a name="ln-469"></a>  <span class="k">else</span>
<a name="ln-470"></a><span class="k">    </span><span class="n">EBSDpattern</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">binx</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">biny</span><span class="p">,</span><span class="n">ip</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">fullsizepattern</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">binx</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">biny</span><span class="p">))</span><span class="o">**</span><span class="n">fpar</span><span class="p">(</span><span class="mi">22</span><span class="p">)</span>
<a name="ln-471"></a>  <span class="k">end if</span>
<a name="ln-472"></a>
<a name="ln-473"></a><span class="c">! has the cancel flag been set by the calling program ?</span>
<a name="ln-474"></a>  <span class="k">if</span><span class="p">(</span><span class="n">cancel</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="nb">char</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span> <span class="k">EXIT </span><span class="n">quatloop</span>
<a name="ln-475"></a>
<a name="ln-476"></a><span class="c">! update the progress counter and report it to the calling program via the proc callback routine</span>
<a name="ln-477"></a>  <span class="k">if</span><span class="p">(</span><span class="n">objAddress</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-478"></a><span class="k">    if</span> <span class="p">(</span><span class="n">ip</span><span class="p">.</span><span class="n">ge</span><span class="p">.</span><span class="n">cn</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-479"></a><span class="k">      </span><span class="n">cn</span> <span class="o">=</span> <span class="n">cn</span><span class="o">+</span><span class="n">dn</span>
<a name="ln-480"></a>      <span class="k">call </span><span class="n">proc</span><span class="p">(</span><span class="n">objAddress</span><span class="p">,</span> <span class="n">ip</span><span class="p">)</span>
<a name="ln-481"></a>    <span class="k">end if</span>
<a name="ln-482"></a><span class="k">  end if</span>
<a name="ln-483"></a>
<a name="ln-484"></a><span class="k">end do </span><span class="n">quatloop</span>
<a name="ln-485"></a>
<a name="ln-486"></a>
<a name="ln-487"></a><span class="k">end subroutine </span><span class="n">EMsoftCgetEBSDPatterns</span>
<a name="ln-488"></a>
<a name="ln-489"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-490"></a><span class="c">!</span>
<a name="ln-491"></a><span class="c">! SUBROUTINE:EMsoftCgetECPatterns</span>
<a name="ln-492"></a><span class="c">!</span>
<a name="ln-493"></a><span class="c">!&gt; @author Saransh Singh/Marc De Graef, Carnegie Mellon University</span>
<a name="ln-494"></a><span class="c">!</span>
<a name="ln-495"></a><span class="c">!&gt; @brief This subroutine can be called by a C/C++ program as a standalone function to compute ECPs</span>
<a name="ln-496"></a><span class="c">!</span>
<a name="ln-497"></a><span class="c">!&gt; @details This subroutine provides a method to compute a series of ECPs and</span>
<a name="ln-498"></a><span class="c">!&gt; can be called from an external C/C++ program; the routine provides a callback mechanism to</span>
<a name="ln-499"></a><span class="c">!&gt; update the calling program about computational progress, as well as a cancel option.</span>
<a name="ln-500"></a><span class="c">!&gt; The routine is intended to be called form a C/C++ program, e.g., DREAM.3D.  This routine is a simplified version</span>
<a name="ln-501"></a><span class="c">!&gt; of the core of the EMECP program. </span>
<a name="ln-502"></a><span class="c">!&gt;</span>
<a name="ln-503"></a><span class="c">!&gt; This routine will first compute the incident cone vectors etc. if necessary, and then perform</span>
<a name="ln-504"></a><span class="c">!&gt; the usual interpolation from the square Lambert projection. The pattern will be a basic pattern,</span>
<a name="ln-505"></a><span class="c">!&gt; without any intensity scaling or binning etc; the calling program should take care of those </span>
<a name="ln-506"></a><span class="c">!&gt; operations.</span>
<a name="ln-507"></a><span class="c">!</span>
<a name="ln-508"></a><span class="c">!&gt; @param ipar array with integer input parameters</span>
<a name="ln-509"></a><span class="c">!&gt; @param fpar array with float input parameters</span>
<a name="ln-510"></a><span class="c">!&gt; @param ECPattern output array</span>
<a name="ln-511"></a><span class="c">!&gt; @param quats array of quaternions</span>
<a name="ln-512"></a><span class="c">!&gt; @param accum_e array with Monte Carlo histogram</span>
<a name="ln-513"></a><span class="c">!&gt; @param mLPNH Northern hemisphere master pattern</span>
<a name="ln-514"></a><span class="c">!&gt; @param mLPSH Southern hemisphere master pattern</span>
<a name="ln-515"></a><span class="c">!</span>
<a name="ln-516"></a><span class="c">!&gt; @date 10/16/15  SS 1.0 original</span>
<a name="ln-517"></a><span class="c">!&gt; @date 11/02/14 MDG 1.1 put all integer parameters inside ipar and fixed size of ipar/fpar</span>
<a name="ln-518"></a><span class="c">!&gt; @date 11/04/15 MDG 1.2 added array of quaternions as input parameter</span>
<a name="ln-519"></a><span class="c">!&gt; @date 01/14/16 MDG 2.0 forked from original SingleECPattern routine; SAVE atrribute removed; ipar redefined (ipar(1) removed)</span>
<a name="ln-520"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-521"></a><span class="k">recursive subroutine </span><span class="n">EMsoftCgetECPatterns</span><span class="p">(</span><span class="n">ipar</span><span class="p">,</span> <span class="n">fpar</span><span class="p">,</span> <span class="n">ECpattern</span><span class="p">,</span> <span class="n">quats</span><span class="p">,</span> <span class="n">accum_e</span><span class="p">,</span> <span class="n">mLPNH</span><span class="p">,</span> <span class="n">mLPSH</span><span class="p">,</span> <span class="n">cproc</span><span class="p">,</span> <span class="n">objAddress</span><span class="p">,</span> <span class="n">cancel</span><span class="p">)</span> <span class="p">&amp;</span>
<a name="ln-522"></a>           <span class="k">bind</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;EMsoftCgetECPatterns&#39;</span><span class="p">)</span>    <span class="c">! this routine is callable from a C/C++ program</span>
<a name="ln-523"></a><span class="c">!DEC$ ATTRIBUTES DLLEXPORT :: EMsoftCgetECPatterns</span>
<a name="ln-524"></a>
<a name="ln-525"></a><span class="c">! the input parameters are all part of a ipar and fpar input arrays instead of the usual namelist structures.</span>
<a name="ln-526"></a><span class="c">! The following is the mapping:</span>
<a name="ln-527"></a><span class="c">!</span>
<a name="ln-528"></a><span class="c">! ipar(1) = detnumpix</span>
<a name="ln-529"></a><span class="c">! ipar(2) = numangle</span>
<a name="ln-530"></a><span class="c">! ipar(3) = mcnsx</span>
<a name="ln-531"></a><span class="c">! ipar(4) = numset</span>
<a name="ln-532"></a><span class="c">! ipar(5) = mpnpx</span>
<a name="ln-533"></a><span class="c">! ipar(6) = numquats</span>
<a name="ln-534"></a>
<a name="ln-535"></a><span class="c">! fpar(1) = ecpnl%thetac</span>
<a name="ln-536"></a><span class="c">! fpar(2) = ecpnl%sampletilt</span>
<a name="ln-537"></a><span class="c">! fpar(3) = ecpnl%workingdistance</span>
<a name="ln-538"></a><span class="c">! fpar(4) = ecpnl%Rin</span>
<a name="ln-539"></a><span class="c">! fpar(5) = ecpnl%Rout</span>
<a name="ln-540"></a><span class="c">! fpar(6) = ecpnl%sigstart</span>
<a name="ln-541"></a><span class="c">! fpar(7) = ecpnl%sigend</span>
<a name="ln-542"></a><span class="c">! fpar(8) = ecpnl%sigstep</span>
<a name="ln-543"></a>
<a name="ln-544"></a><span class="k">use </span><span class="n">local</span>
<a name="ln-545"></a><span class="k">use </span><span class="n">constants</span>
<a name="ln-546"></a><span class="k">use </span><span class="n">Lambert</span>
<a name="ln-547"></a><span class="k">use </span><span class="n">quaternions</span>
<a name="ln-548"></a><span class="k">use</span><span class="p">,</span><span class="k">INTRINSIC</span> <span class="kd">::</span> <span class="nb">ISO_C_BINDING</span>
<a name="ln-549"></a>
<a name="ln-550"></a><span class="k">IMPLICIT NONE</span>
<a name="ln-551"></a>
<a name="ln-552"></a><span class="kt">integer</span><span class="p">(</span><span class="kt">c_size_t</span><span class="p">),</span><span class="k">PARAMETER</span>             <span class="kd">::</span> <span class="n">nipar</span><span class="o">=</span><span class="mi">6</span>
<a name="ln-553"></a><span class="kt">integer</span><span class="p">(</span><span class="kt">c_size_t</span><span class="p">),</span><span class="k">PARAMETER</span>             <span class="kd">::</span> <span class="n">nfpar</span><span class="o">=</span><span class="mi">8</span>
<a name="ln-554"></a><span class="kt">integer</span><span class="p">(</span><span class="kt">c_size_t</span><span class="p">),</span><span class="k">PARAMETER</span>             <span class="kd">::</span> <span class="n">nq</span><span class="o">=</span><span class="mi">4</span>
<a name="ln-555"></a><span class="kt">integer</span><span class="p">(</span><span class="kt">c_size_t</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>            <span class="kd">::</span> <span class="n">ipar</span><span class="p">(</span><span class="n">nipar</span><span class="p">)</span>
<a name="ln-556"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>               <span class="kd">::</span> <span class="n">fpar</span><span class="p">(</span><span class="n">nfpar</span><span class="p">)</span>
<a name="ln-557"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">OUT</span><span class="p">)</span>              <span class="kd">::</span> <span class="n">ECpattern</span><span class="p">(</span><span class="n">ipar</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="n">ipar</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="n">ipar</span><span class="p">(</span><span class="mi">6</span><span class="p">))</span>
<a name="ln-558"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>               <span class="kd">::</span> <span class="n">quats</span><span class="p">(</span><span class="n">nq</span><span class="p">,</span><span class="n">ipar</span><span class="p">(</span><span class="mi">6</span><span class="p">))</span>
<a name="ln-559"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>               <span class="kd">::</span> <span class="n">accum_e</span><span class="p">(</span><span class="n">ipar</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span><span class="o">-</span><span class="n">ipar</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span><span class="n">ipar</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span><span class="o">-</span><span class="n">ipar</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span><span class="n">ipar</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
<a name="ln-560"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>               <span class="kd">::</span> <span class="n">mLPNH</span><span class="p">(</span><span class="o">-</span><span class="n">ipar</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span><span class="n">ipar</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span> <span class="o">-</span><span class="n">ipar</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span><span class="n">ipar</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span> <span class="n">ipar</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
<a name="ln-561"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>               <span class="kd">::</span> <span class="n">mLPSH</span><span class="p">(</span><span class="o">-</span><span class="n">ipar</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span><span class="n">ipar</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span> <span class="o">-</span><span class="n">ipar</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span><span class="n">ipar</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span> <span class="n">ipar</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
<a name="ln-562"></a><span class="k">TYPE</span><span class="p">(</span><span class="kt">C_FUNPTR</span><span class="p">),</span> <span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">),</span> <span class="k">VALUE</span>       <span class="kd">::</span> <span class="n">cproc</span>
<a name="ln-563"></a><span class="kt">integer</span><span class="p">(</span><span class="kt">c_size_t</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">),</span> <span class="k">VALUE</span>     <span class="kd">::</span> <span class="n">objAddress</span>
<a name="ln-564"></a><span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>             <span class="kd">::</span> <span class="n">cancel</span>
<a name="ln-565"></a>
<a name="ln-566"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">),</span><span class="k">allocatable</span>              <span class="kd">::</span> <span class="n">klist</span><span class="p">(:,:,:),</span> <span class="n">rgx</span><span class="p">(:,:),</span> <span class="n">rgy</span><span class="p">(:,:),</span> <span class="n">rgz</span><span class="p">(:,:),</span> <span class="n">weightfact</span><span class="p">(:)</span>
<a name="ln-567"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">),</span><span class="k">allocatable</span>              <span class="kd">::</span> <span class="n">mLPNHsum</span><span class="p">(:,:),</span> <span class="n">mLPSHsum</span><span class="p">(:,:)</span>
<a name="ln-568"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">dbl</span><span class="p">),</span><span class="k">parameter</span>                <span class="kd">::</span> <span class="n">Rtod</span> <span class="o">=</span> <span class="mi">5</span><span class="mf">7.2957795131D0</span>
<a name="ln-569"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">dbl</span><span class="p">),</span><span class="k">parameter</span>                <span class="kd">::</span> <span class="n">dtoR</span> <span class="o">=</span> <span class="mf">0.01745329251D0</span>
<a name="ln-570"></a>
<a name="ln-571"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">)</span>                          <span class="kd">::</span> <span class="n">kk</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">thetacr</span><span class="p">,</span> <span class="n">ktmax</span><span class="p">,</span> <span class="n">delta</span><span class="p">,</span> <span class="n">wf</span><span class="p">,</span> <span class="n">quat</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<a name="ln-572"></a><span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">irg</span><span class="p">)</span>                       <span class="kd">::</span> <span class="n">istat</span><span class="p">,</span> <span class="n">imin</span><span class="p">,</span> <span class="n">imax</span><span class="p">,</span> <span class="n">jmin</span><span class="p">,</span> <span class="n">jmax</span><span class="p">,</span> <span class="n">ii</span> <span class="p">,</span><span class="n">jj</span><span class="p">,</span> <span class="n">nazimuth</span><span class="p">,</span> <span class="n">npolar</span><span class="p">,</span> <span class="n">nsig</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">dn</span><span class="p">,</span> <span class="n">cn</span>
<a name="ln-573"></a><span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">irg</span><span class="p">)</span>                       <span class="kd">::</span> <span class="n">ipolar</span><span class="p">,</span> <span class="n">iazimuth</span><span class="p">,</span> <span class="n">isig</span><span class="p">,</span> <span class="n">isampletilt</span><span class="p">,</span> <span class="n">nix</span><span class="p">,</span> <span class="n">niy</span><span class="p">,</span> <span class="n">nixp</span><span class="p">,</span> <span class="n">niyp</span><span class="p">,</span> <span class="n">isigp</span>
<a name="ln-574"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">)</span>                          <span class="kd">::</span> <span class="n">thetain</span><span class="p">,</span> <span class="n">thetaout</span><span class="p">,</span> <span class="n">polar</span><span class="p">,</span> <span class="n">azimuthal</span><span class="p">,</span> <span class="n">delpolar</span><span class="p">,</span> <span class="n">delazimuth</span><span class="p">,</span> <span class="n">om</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-575"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">)</span>                          <span class="kd">::</span> <span class="n">dc</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">scl</span><span class="p">,</span> <span class="n">deltheta</span><span class="p">,</span> <span class="n">acc_sum</span><span class="p">,</span> <span class="n">MCangle</span><span class="p">,</span> <span class="n">ixy</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">dxm</span><span class="p">,</span> <span class="n">dym</span><span class="p">,</span> <span class="n">dp</span>
<a name="ln-576"></a><span class="k">PROCEDURE</span><span class="p">(</span><span class="n">ProgressCallBack</span><span class="p">),</span> <span class="k">POINTER</span>    <span class="kd">::</span> <span class="n">proc</span>
<a name="ln-577"></a>
<a name="ln-578"></a><span class="c">! link the proc procedure to the cproc argument</span>
<a name="ln-579"></a><span class="k">CALL </span><span class="nb">C_F_PROCPOINTER</span> <span class="p">(</span><span class="n">cproc</span><span class="p">,</span> <span class="n">proc</span><span class="p">)</span>
<a name="ln-580"></a>
<a name="ln-581"></a>
<a name="ln-582"></a><span class="c">!==================================================================================</span>
<a name="ln-583"></a><span class="c">! ------ generate the detector klist, rgx, rgy, rgz, weightfactors arrays </span>
<a name="ln-584"></a><span class="c">!==================================================================================</span>
<a name="ln-585"></a>
<a name="ln-586"></a><span class="n">imin</span> <span class="o">=</span> <span class="mi">1</span>
<a name="ln-587"></a><span class="n">imax</span> <span class="o">=</span> <span class="n">ipar</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-588"></a><span class="n">jmin</span> <span class="o">=</span> <span class="mi">1</span>
<a name="ln-589"></a><span class="n">jmax</span> <span class="o">=</span> <span class="n">ipar</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-590"></a>
<a name="ln-591"></a>
<a name="ln-592"></a>    <span class="k">if</span> <span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">mLPNHsum</span><span class="p">))</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">mLPNHsum</span><span class="p">)</span>
<a name="ln-593"></a>    <span class="k">if</span> <span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">mLPSHsum</span><span class="p">))</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">mLPSHsum</span><span class="p">)</span>
<a name="ln-594"></a>
<a name="ln-595"></a>    <span class="k">allocate</span><span class="p">(</span><span class="n">mLPNHsum</span><span class="p">(</span><span class="o">-</span><span class="n">ipar</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span><span class="n">ipar</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span> <span class="o">-</span><span class="n">ipar</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span><span class="n">ipar</span><span class="p">(</span><span class="mi">5</span><span class="p">)))</span>
<a name="ln-596"></a>    <span class="k">allocate</span><span class="p">(</span><span class="n">mLPSHsum</span><span class="p">(</span><span class="o">-</span><span class="n">ipar</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span><span class="n">ipar</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span> <span class="o">-</span><span class="n">ipar</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span><span class="n">ipar</span><span class="p">(</span><span class="mi">5</span><span class="p">)))</span>
<a name="ln-597"></a>    <span class="n">mLPNHsum</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">mLPNH</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-598"></a>    <span class="n">mLPSHsum</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">mLPSH</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-599"></a>
<a name="ln-600"></a>    <span class="k">if</span> <span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">klist</span><span class="p">))</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">klist</span><span class="p">)</span>
<a name="ln-601"></a>    <span class="k">allocate</span><span class="p">(</span><span class="n">klist</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">ipar</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="mi">1</span><span class="p">:</span><span class="n">ipar</span><span class="p">(</span><span class="mi">1</span><span class="p">)),</span> <span class="nb">stat</span><span class="o">=</span><span class="n">istat</span><span class="p">)</span>
<a name="ln-602"></a>    <span class="n">kk</span> <span class="o">=</span> <span class="p">(</span><span class="o">/</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">1.0</span><span class="o">/</span><span class="p">)</span>
<a name="ln-603"></a>    <span class="n">thetacr</span> <span class="o">=</span> <span class="n">DtoR</span><span class="o">*</span><span class="n">fpar</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-604"></a>    <span class="n">ktmax</span> <span class="o">=</span> <span class="nb">tan</span><span class="p">(</span><span class="n">thetacr</span><span class="p">)</span>
<a name="ln-605"></a>    <span class="n">delta</span> <span class="o">=</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">ktmax</span><span class="o">/</span><span class="nb">dble</span><span class="p">(</span><span class="n">ipar</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-606"></a>     
<a name="ln-607"></a>    <span class="k">do </span><span class="n">ii</span> <span class="o">=</span> <span class="n">imin</span><span class="p">,</span> <span class="n">imax</span>
<a name="ln-608"></a>        <span class="k">do </span><span class="n">jj</span> <span class="o">=</span> <span class="n">jmin</span><span class="p">,</span> <span class="n">jmax</span>
<a name="ln-609"></a>            <span class="n">klist</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="o">/-</span><span class="n">ktmax</span><span class="o">+</span><span class="n">delta</span><span class="o">*</span><span class="p">(</span><span class="n">ii</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span><span class="o">-</span><span class="n">ktmax</span><span class="o">+</span><span class="n">delta</span><span class="o">*</span><span class="p">(</span><span class="n">jj</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span><span class="mf">0.0</span><span class="o">/</span><span class="p">)</span> <span class="o">+</span> <span class="n">kk</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-610"></a>            <span class="n">klist</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">)</span> <span class="o">=</span>  <span class="n">klist</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">)</span><span class="o">/</span><span class="nb">sqrt</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span> <span class="n">klist</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
<a name="ln-611"></a>        <span class="k">end do</span>
<a name="ln-612"></a><span class="k">    end do</span>
<a name="ln-613"></a>
<a name="ln-614"></a><span class="k">    </span><span class="n">thetain</span> <span class="o">=</span> <span class="n">atan2</span><span class="p">(</span><span class="n">fpar</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span><span class="n">fpar</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
<a name="ln-615"></a>    <span class="n">thetaout</span> <span class="o">=</span> <span class="n">atan2</span><span class="p">(</span><span class="n">fpar</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span><span class="n">fpar</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
<a name="ln-616"></a>
<a name="ln-617"></a>    <span class="n">om</span><span class="p">(</span><span class="mi">1</span><span class="p">,:)</span> <span class="o">=</span> <span class="p">(</span><span class="o">/</span><span class="nb">cos</span><span class="p">(</span><span class="n">fpar</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="nb">sngl</span><span class="p">(</span><span class="n">dtor</span><span class="p">)),</span><span class="mf">0.0</span><span class="p">,</span><span class="nb">sin</span><span class="p">(</span><span class="n">fpar</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="nb">sngl</span><span class="p">(</span><span class="n">dtor</span><span class="p">))</span><span class="o">/</span><span class="p">)</span>
<a name="ln-618"></a>    <span class="n">om</span><span class="p">(</span><span class="mi">2</span><span class="p">,:)</span> <span class="o">=</span> <span class="p">(</span><span class="o">/</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">1.0</span><span class="p">,</span><span class="mf">0.0</span><span class="o">/</span><span class="p">)</span>
<a name="ln-619"></a>    <span class="n">om</span><span class="p">(</span><span class="mi">3</span><span class="p">,:)</span> <span class="o">=</span> <span class="p">(</span><span class="o">/-</span><span class="nb">sin</span><span class="p">(</span><span class="n">fpar</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="nb">sngl</span><span class="p">(</span><span class="n">dtor</span><span class="p">)),</span><span class="mf">0.0</span><span class="p">,</span><span class="nb">cos</span><span class="p">(</span><span class="n">fpar</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="nb">sngl</span><span class="p">(</span><span class="n">dtor</span><span class="p">))</span><span class="o">/</span><span class="p">)</span>
<a name="ln-620"></a>
<a name="ln-621"></a>    <span class="n">npolar</span> <span class="o">=</span> <span class="nb">nint</span><span class="p">((</span><span class="n">thetaout</span> <span class="o">-</span> <span class="n">thetain</span><span class="p">)</span><span class="o">*</span><span class="mi">18</span><span class="mf">0.0</span><span class="o">/</span><span class="n">cPi</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-622"></a>    <span class="n">delpolar</span> <span class="o">=</span> <span class="p">(</span><span class="n">thetaout</span> <span class="o">-</span> <span class="n">thetain</span><span class="p">)</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">npolar</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-623"></a>
<a name="ln-624"></a>    <span class="n">nazimuth</span> <span class="o">=</span> <span class="mi">361</span>
<a name="ln-625"></a>    <span class="n">delazimuth</span> <span class="o">=</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">cPi</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">nazimuth</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-626"></a>
<a name="ln-627"></a>    <span class="k">if</span> <span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">rgx</span><span class="p">))</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">rgx</span><span class="p">,</span> <span class="n">rgy</span><span class="p">,</span> <span class="n">rgz</span><span class="p">)</span>
<a name="ln-628"></a>    <span class="k">allocate</span><span class="p">(</span><span class="n">rgx</span><span class="p">(</span><span class="n">npolar</span><span class="p">,</span> <span class="n">nazimuth</span><span class="p">),</span> <span class="n">rgy</span><span class="p">(</span><span class="n">npolar</span><span class="p">,</span> <span class="n">nazimuth</span><span class="p">),</span> <span class="n">rgz</span><span class="p">(</span><span class="n">npolar</span><span class="p">,</span> <span class="n">nazimuth</span><span class="p">),</span> <span class="nb">stat</span><span class="o">=</span><span class="n">istat</span><span class="p">)</span>
<a name="ln-629"></a>
<a name="ln-630"></a>    <span class="k">do </span><span class="n">ipolar</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="n">npolar</span>
<a name="ln-631"></a>         <span class="n">polar</span> <span class="o">=</span> <span class="n">thetain</span> <span class="o">+</span> <span class="nb">float</span><span class="p">(</span><span class="n">ipolar</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">delpolar</span>
<a name="ln-632"></a>
<a name="ln-633"></a>         <span class="k">do </span><span class="n">iazimuth</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="n">nazimuth</span>
<a name="ln-634"></a>             <span class="n">azimuthal</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">iazimuth</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">delazimuth</span>
<a name="ln-635"></a>
<a name="ln-636"></a>             <span class="n">dc</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="nb">cos</span><span class="p">(</span><span class="n">azimuthal</span><span class="p">)</span><span class="o">*</span><span class="nb">sin</span><span class="p">(</span><span class="n">polar</span><span class="p">)</span>
<a name="ln-637"></a>             <span class="n">dc</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="nb">sin</span><span class="p">(</span><span class="n">azimuthal</span><span class="p">)</span><span class="o">*</span><span class="nb">sin</span><span class="p">(</span><span class="n">polar</span><span class="p">)</span>
<a name="ln-638"></a>             <span class="n">dc</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="nb">cos</span><span class="p">(</span><span class="n">polar</span><span class="p">)</span>
<a name="ln-639"></a>
<a name="ln-640"></a>             <span class="n">dc</span> <span class="o">=</span> <span class="nb">matmul</span><span class="p">(</span><span class="n">om</span><span class="p">,</span><span class="n">dc</span><span class="p">)</span>
<a name="ln-641"></a>
<a name="ln-642"></a>             <span class="n">rgx</span><span class="p">(</span><span class="n">ipolar</span><span class="p">,</span><span class="n">iazimuth</span><span class="p">)</span> <span class="o">=</span> <span class="n">dc</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-643"></a>             <span class="n">rgy</span><span class="p">(</span><span class="n">ipolar</span><span class="p">,</span><span class="n">iazimuth</span><span class="p">)</span> <span class="o">=</span> <span class="n">dc</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<a name="ln-644"></a>             <span class="n">rgz</span><span class="p">(</span><span class="n">ipolar</span><span class="p">,</span><span class="n">iazimuth</span><span class="p">)</span> <span class="o">=</span> <span class="n">dc</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-645"></a>        <span class="k">end do</span>
<a name="ln-646"></a><span class="k">    end do</span>
<a name="ln-647"></a>
<a name="ln-648"></a><span class="c">!===================================================================</span>
<a name="ln-649"></a><span class="c">! ------ generate the weight factors from the monte carlo histogram</span>
<a name="ln-650"></a><span class="c">!===================================================================</span>
<a name="ln-651"></a>
<a name="ln-652"></a>    <span class="n">scl</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">ipar</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
<a name="ln-653"></a>    <span class="n">nsig</span> <span class="o">=</span> <span class="nb">nint</span><span class="p">(</span><span class="n">fpar</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="nb">abs</span><span class="p">(</span><span class="n">fpar</span><span class="p">(</span><span class="mi">2</span><span class="p">)))</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-654"></a>
<a name="ln-655"></a>    <span class="n">deltheta</span> <span class="o">=</span> <span class="p">(</span><span class="n">fpar</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="nb">abs</span><span class="p">(</span><span class="n">fpar</span><span class="p">(</span><span class="mi">2</span><span class="p">)))</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">nsig</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-656"></a>
<a name="ln-657"></a>    <span class="k">if</span> <span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">weightfact</span><span class="p">))</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">weightfact</span><span class="p">)</span>
<a name="ln-658"></a>    <span class="k">allocate</span><span class="p">(</span><span class="n">weightfact</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">nsig</span><span class="p">),</span> <span class="nb">stat</span><span class="o">=</span><span class="n">istat</span><span class="p">)</span>
<a name="ln-659"></a>    <span class="n">weightfact</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-660"></a>
<a name="ln-661"></a>    <span class="k">do </span><span class="n">isig</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="n">nsig</span>
<a name="ln-662"></a>        <span class="n">acc_sum</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-663"></a>        <span class="n">MCangle</span> <span class="o">=</span> <span class="p">(</span><span class="n">isig</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">deltheta</span>
<a name="ln-664"></a>        <span class="n">isampletilt</span> <span class="o">=</span> <span class="nb">nint</span><span class="p">((</span><span class="n">MCangle</span> <span class="o">-</span> <span class="n">fpar</span><span class="p">(</span><span class="mi">6</span><span class="p">))</span><span class="o">/</span><span class="n">fpar</span><span class="p">(</span><span class="mi">8</span><span class="p">))</span>
<a name="ln-665"></a>    
<a name="ln-666"></a>        <span class="k">if</span> <span class="p">(</span><span class="n">isampletilt</span> <span class="p">.</span><span class="n">lt</span><span class="p">.</span> <span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-667"></a><span class="k">            </span><span class="n">isampletilt</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">isampletilt</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-668"></a>        <span class="k">else</span>
<a name="ln-669"></a><span class="k">            </span><span class="n">isampletilt</span> <span class="o">=</span> <span class="n">isampletilt</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-670"></a>        <span class="k">end if</span>
<a name="ln-671"></a>
<a name="ln-672"></a><span class="k">        do </span><span class="n">ipolar</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="n">npolar</span>
<a name="ln-673"></a>            <span class="k">do </span><span class="n">iazimuth</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="n">nazimuth</span>
<a name="ln-674"></a>                <span class="n">dc</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="o">/</span><span class="n">rgx</span><span class="p">(</span><span class="n">ipolar</span><span class="p">,</span><span class="n">iazimuth</span><span class="p">),</span> <span class="n">rgy</span><span class="p">(</span><span class="n">ipolar</span><span class="p">,</span><span class="n">iazimuth</span><span class="p">),</span> <span class="n">rgz</span><span class="p">(</span><span class="n">ipolar</span><span class="p">,</span><span class="n">iazimuth</span><span class="p">)</span><span class="o">/</span><span class="p">)</span>
<a name="ln-675"></a><span class="c">! convert to Rosca-lambert projection</span>
<a name="ln-676"></a>                <span class="n">ixy</span> <span class="o">=</span> <span class="n">scl</span> <span class="o">*</span>  <span class="n">LambertSphereToSquare</span><span class="p">(</span> <span class="n">dc</span><span class="p">,</span> <span class="n">istat</span> <span class="p">)</span>
<a name="ln-677"></a>                <span class="n">nix</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ipar</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">+</span><span class="n">ixy</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="o">-</span><span class="n">ipar</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-678"></a>                <span class="n">niy</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ipar</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">+</span><span class="n">ixy</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span><span class="o">-</span><span class="n">ipar</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-679"></a>                <span class="n">nixp</span> <span class="o">=</span> <span class="n">nix</span><span class="o">+</span><span class="mi">1</span>
<a name="ln-680"></a>                <span class="n">niyp</span> <span class="o">=</span> <span class="n">niy</span><span class="o">+</span><span class="mi">1</span>
<a name="ln-681"></a>                <span class="k">if</span> <span class="p">(</span><span class="n">nixp</span><span class="p">.</span><span class="n">gt</span><span class="p">.</span><span class="n">ipar</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span> <span class="n">nixp</span> <span class="o">=</span> <span class="n">nix</span>
<a name="ln-682"></a>                <span class="k">if</span> <span class="p">(</span><span class="n">niyp</span><span class="p">.</span><span class="n">gt</span><span class="p">.</span><span class="n">ipar</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span> <span class="n">niyp</span> <span class="o">=</span> <span class="n">niy</span>
<a name="ln-683"></a>                <span class="k">if</span> <span class="p">(</span><span class="n">nix</span><span class="p">.</span><span class="n">lt</span><span class="p">.</span><span class="o">-</span><span class="n">ipar</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span> <span class="n">nix</span> <span class="o">=</span> <span class="n">nixp</span>
<a name="ln-684"></a>                <span class="k">if</span> <span class="p">(</span><span class="n">niy</span><span class="p">.</span><span class="n">lt</span><span class="p">.</span><span class="o">-</span><span class="n">ipar</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span> <span class="n">niy</span> <span class="o">=</span> <span class="n">niyp</span>
<a name="ln-685"></a>                <span class="n">dx</span> <span class="o">=</span> <span class="n">ixy</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">nix</span>
<a name="ln-686"></a>                <span class="n">dy</span> <span class="o">=</span> <span class="n">ixy</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">-</span><span class="n">niy</span>
<a name="ln-687"></a>                <span class="n">dxm</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">-</span><span class="n">dx</span>
<a name="ln-688"></a>                <span class="n">dym</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">-</span><span class="n">dy</span>
<a name="ln-689"></a>            
<a name="ln-690"></a>                <span class="n">acc_sum</span> <span class="o">=</span> <span class="mf">0.25</span><span class="o">*</span><span class="p">(</span><span class="n">accum_e</span><span class="p">(</span><span class="n">isampletilt</span><span class="p">,</span><span class="n">nix</span><span class="p">,</span><span class="n">niy</span><span class="p">)</span> <span class="o">*</span> <span class="n">dxm</span> <span class="o">*</span> <span class="n">dym</span> <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-691"></a>                                <span class="n">accum_e</span><span class="p">(</span><span class="n">isampletilt</span><span class="p">,</span><span class="n">nixp</span><span class="p">,</span><span class="n">niy</span><span class="p">)</span> <span class="o">*</span> <span class="n">dx</span> <span class="o">*</span> <span class="n">dym</span> <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-692"></a>                                <span class="n">accum_e</span><span class="p">(</span><span class="n">isampletilt</span><span class="p">,</span><span class="n">nix</span><span class="p">,</span><span class="n">niyp</span><span class="p">)</span> <span class="o">*</span> <span class="n">dxm</span> <span class="o">*</span> <span class="n">dy</span> <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-693"></a>                                <span class="n">accum_e</span><span class="p">(</span><span class="n">isampletilt</span><span class="p">,</span><span class="n">nixp</span><span class="p">,</span><span class="n">niyp</span><span class="p">)</span> <span class="o">*</span> <span class="n">dx</span> <span class="o">*</span> <span class="n">dy</span><span class="p">)</span>
<a name="ln-694"></a>             
<a name="ln-695"></a>                <span class="n">weightfact</span><span class="p">(</span><span class="n">isig</span><span class="p">)</span> <span class="o">=</span> <span class="n">weightfact</span><span class="p">(</span><span class="n">isig</span><span class="p">)</span> <span class="o">+</span> <span class="n">acc_sum</span>
<a name="ln-696"></a>
<a name="ln-697"></a>            <span class="k">end do</span>
<a name="ln-698"></a><span class="k">        end do</span>
<a name="ln-699"></a><span class="k">    end do</span>
<a name="ln-700"></a>
<a name="ln-701"></a><span class="k">    </span><span class="n">weightfact</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">nsig</span><span class="p">)</span> <span class="o">=</span> <span class="n">weightfact</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">nsig</span><span class="p">)</span><span class="o">/</span><span class="n">weightfact</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-702"></a>
<a name="ln-703"></a><span class="c">!===================================================================</span>
<a name="ln-704"></a><span class="c">! ------ perform interpolation from square lambert map</span>
<a name="ln-705"></a><span class="c">!===================================================================</span>
<a name="ln-706"></a><span class="n">scl</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">ipar</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>
<a name="ln-707"></a><span class="n">ECPattern</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-708"></a><span class="n">dn</span> <span class="o">=</span> <span class="nb">nint</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">ipar</span><span class="p">(</span><span class="mi">6</span><span class="p">))</span><span class="o">*</span><span class="mf">0.01</span><span class="p">)</span>
<a name="ln-709"></a><span class="n">cn</span> <span class="o">=</span> <span class="n">dn</span>
<a name="ln-710"></a>
<a name="ln-711"></a><span class="n">quatloop</span><span class="p">:</span> <span class="k">do </span><span class="n">ip</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">ipar</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
<a name="ln-712"></a>  <span class="k">do </span><span class="n">ii</span> <span class="o">=</span> <span class="n">imin</span><span class="p">,</span> <span class="n">imax</span>
<a name="ln-713"></a>    <span class="k">do </span><span class="n">jj</span> <span class="o">=</span> <span class="n">jmin</span><span class="p">,</span> <span class="n">jmax</span>
<a name="ln-714"></a>
<a name="ln-715"></a>        <span class="n">dc</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">klist</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">)</span>
<a name="ln-716"></a>        <span class="n">dc</span> <span class="o">=</span> <span class="n">dc</span><span class="o">/</span><span class="nb">sqrt</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">dc</span><span class="o">*</span><span class="n">dc</span><span class="p">))</span>
<a name="ln-717"></a>        
<a name="ln-718"></a>        <span class="n">dp</span> <span class="o">=</span> <span class="nb">DOT_PRODUCT</span><span class="p">(</span><span class="n">dc</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">),(</span><span class="o">/</span><span class="nb">sin</span><span class="p">(</span><span class="n">fpar</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">dtoR</span><span class="p">),</span><span class="mf">0.D0</span><span class="p">,</span><span class="nb">cos</span><span class="p">(</span><span class="n">fpar</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">dtoR</span><span class="p">)</span><span class="o">/</span><span class="p">))</span>      
<a name="ln-719"></a>        <span class="k">if</span> <span class="p">(</span><span class="n">dp</span> <span class="p">.</span><span class="n">gt</span><span class="p">.</span> <span class="mf">1.D0</span><span class="p">)</span> <span class="n">dp</span> <span class="o">=</span> <span class="mf">1.0</span>
<a name="ln-720"></a>        <span class="n">MCangle</span> <span class="o">=</span> <span class="nb">acos</span><span class="p">(</span><span class="n">dp</span><span class="p">)</span><span class="o">*</span><span class="n">Rtod</span>
<a name="ln-721"></a>        <span class="n">isig</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">MCangle</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-722"></a>        <span class="k">if</span> <span class="p">(</span><span class="n">isig</span> <span class="p">.</span><span class="n">gt</span><span class="p">.</span> <span class="n">nsig</span><span class="p">)</span> <span class="n">isig</span> <span class="o">=</span> <span class="n">nsig</span>
<a name="ln-723"></a>
<a name="ln-724"></a>        <span class="n">isigp</span> <span class="o">=</span> <span class="n">isig</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-725"></a>        <span class="k">if</span> <span class="p">(</span><span class="n">isigp</span> <span class="p">.</span><span class="n">gt</span><span class="p">.</span> <span class="n">nsig</span><span class="p">)</span> <span class="n">isigp</span> <span class="o">=</span> <span class="n">nsig</span>
<a name="ln-726"></a>        <span class="n">dx</span> <span class="o">=</span> <span class="n">MCangle</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="n">MCangle</span><span class="p">)</span>
<a name="ln-727"></a>        <span class="n">dxm</span> <span class="o">=</span>  <span class="mf">1.0</span> <span class="o">-</span> <span class="n">dx</span>
<a name="ln-728"></a>        
<a name="ln-729"></a>        <span class="n">wf</span> <span class="o">=</span> <span class="n">weightfact</span><span class="p">(</span><span class="n">isig</span><span class="p">)</span> <span class="o">*</span> <span class="n">dxm</span> <span class="o">+</span> <span class="n">weightfact</span><span class="p">(</span><span class="n">isigp</span><span class="p">)</span> <span class="o">*</span> <span class="n">dx</span>
<a name="ln-730"></a>        <span class="n">wf</span> <span class="o">=</span> <span class="mf">1.0</span>
<a name="ln-731"></a>        <span class="n">dc</span> <span class="o">=</span> <span class="n">quat_LP</span><span class="p">(</span><span class="n">quats</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span><span class="n">ip</span><span class="p">),</span> <span class="n">dc</span><span class="p">)</span>
<a name="ln-732"></a>        <span class="n">dc</span> <span class="o">=</span> <span class="n">dc</span><span class="o">/</span><span class="nb">sqrt</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">dc</span><span class="o">*</span><span class="n">dc</span><span class="p">))</span>
<a name="ln-733"></a>
<a name="ln-734"></a>        <span class="n">ixy</span> <span class="o">=</span> <span class="n">scl</span> <span class="o">*</span> <span class="n">LambertSphereToSquare</span><span class="p">(</span> <span class="n">dc</span><span class="p">,</span> <span class="n">istat</span> <span class="p">)</span>
<a name="ln-735"></a>        <span class="n">nix</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ipar</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">+</span><span class="n">ixy</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="o">-</span><span class="n">ipar</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<a name="ln-736"></a>        <span class="n">niy</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ipar</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">+</span><span class="n">ixy</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span><span class="o">-</span><span class="n">ipar</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<a name="ln-737"></a>        <span class="n">nixp</span> <span class="o">=</span> <span class="n">nix</span><span class="o">+</span><span class="mi">1</span>
<a name="ln-738"></a>        <span class="n">niyp</span> <span class="o">=</span> <span class="n">niy</span><span class="o">+</span><span class="mi">1</span>
<a name="ln-739"></a>        <span class="k">if</span> <span class="p">(</span><span class="n">nixp</span><span class="p">.</span><span class="n">gt</span><span class="p">.</span><span class="n">ipar</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span> <span class="n">nixp</span> <span class="o">=</span> <span class="n">nix</span>
<a name="ln-740"></a>        <span class="k">if</span> <span class="p">(</span><span class="n">niyp</span><span class="p">.</span><span class="n">gt</span><span class="p">.</span><span class="n">ipar</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span> <span class="n">niyp</span> <span class="o">=</span> <span class="n">niy</span>
<a name="ln-741"></a>        <span class="k">if</span> <span class="p">(</span><span class="n">nix</span><span class="p">.</span><span class="n">lt</span><span class="p">.</span><span class="o">-</span><span class="n">ipar</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span> <span class="n">nix</span> <span class="o">=</span> <span class="n">nixp</span>
<a name="ln-742"></a>        <span class="k">if</span> <span class="p">(</span><span class="n">niy</span><span class="p">.</span><span class="n">lt</span><span class="p">.</span><span class="o">-</span><span class="n">ipar</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span> <span class="n">niy</span> <span class="o">=</span> <span class="n">niyp</span>
<a name="ln-743"></a>        <span class="n">dx</span> <span class="o">=</span> <span class="n">ixy</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">nix</span>
<a name="ln-744"></a>        <span class="n">dy</span> <span class="o">=</span> <span class="n">ixy</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">-</span><span class="n">niy</span>
<a name="ln-745"></a>        <span class="n">dxm</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">-</span><span class="n">dx</span>
<a name="ln-746"></a>        <span class="n">dym</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">-</span><span class="n">dy</span>
<a name="ln-747"></a>        
<a name="ln-748"></a>        <span class="k">if</span> <span class="p">(</span><span class="n">dc</span><span class="p">(</span><span class="mi">3</span><span class="p">).</span><span class="n">ge</span><span class="p">.</span><span class="mf">0.D0</span><span class="p">)</span> <span class="k">then </span>
<a name="ln-749"></a><span class="k">            </span><span class="n">ECpattern</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">,</span><span class="n">ip</span><span class="p">)</span> <span class="o">=</span> <span class="n">wf</span> <span class="o">*</span> <span class="p">(</span> <span class="n">mLPNHsum</span><span class="p">(</span><span class="n">nix</span><span class="p">,</span><span class="n">niy</span><span class="p">)</span> <span class="o">*</span> <span class="n">dxm</span> <span class="o">*</span> <span class="n">dym</span> <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-750"></a>                         <span class="n">mLPNHsum</span><span class="p">(</span><span class="n">nixp</span><span class="p">,</span><span class="n">niy</span><span class="p">)</span> <span class="o">*</span> <span class="n">dx</span> <span class="o">*</span> <span class="n">dym</span> <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-751"></a>                         <span class="n">mLPNHsum</span><span class="p">(</span><span class="n">nix</span><span class="p">,</span><span class="n">niyp</span><span class="p">)</span> <span class="o">*</span> <span class="n">dxm</span> <span class="o">*</span> <span class="n">dy</span> <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-752"></a>                         <span class="n">mLPNHsum</span><span class="p">(</span><span class="n">nixp</span><span class="p">,</span><span class="n">niyp</span><span class="p">)</span> <span class="o">*</span> <span class="n">dx</span> <span class="o">*</span> <span class="n">dy</span> <span class="p">)</span>
<a name="ln-753"></a>
<a name="ln-754"></a>        <span class="k">else</span>
<a name="ln-755"></a><span class="k">            </span><span class="n">ECpattern</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">,</span><span class="n">ip</span><span class="p">)</span> <span class="o">=</span>  <span class="n">wf</span> <span class="o">*</span> <span class="p">(</span> <span class="n">mLPSHsum</span><span class="p">(</span><span class="n">nix</span><span class="p">,</span><span class="n">niy</span><span class="p">)</span> <span class="o">*</span> <span class="n">dxm</span> <span class="o">*</span> <span class="n">dym</span> <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-756"></a>                         <span class="n">mLPSHsum</span><span class="p">(</span><span class="n">nixp</span><span class="p">,</span><span class="n">niy</span><span class="p">)</span> <span class="o">*</span> <span class="n">dx</span> <span class="o">*</span> <span class="n">dym</span> <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-757"></a>                         <span class="n">mLPSHsum</span><span class="p">(</span><span class="n">nix</span><span class="p">,</span><span class="n">niyp</span><span class="p">)</span> <span class="o">*</span> <span class="n">dxm</span> <span class="o">*</span> <span class="n">dy</span> <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-758"></a>                         <span class="n">mLPSHsum</span><span class="p">(</span><span class="n">nixp</span><span class="p">,</span><span class="n">niyp</span><span class="p">)</span> <span class="o">*</span> <span class="n">dx</span> <span class="o">*</span> <span class="n">dy</span> <span class="p">)</span>
<a name="ln-759"></a>        <span class="k">end if</span>
<a name="ln-760"></a>
<a name="ln-761"></a><span class="k">    end do</span>
<a name="ln-762"></a><span class="k">  end do</span>
<a name="ln-763"></a>
<a name="ln-764"></a><span class="c">! has the cancel flag been set by the calling program ?</span>
<a name="ln-765"></a>  <span class="k">if</span><span class="p">(</span><span class="n">cancel</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="nb">char</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span> <span class="k">EXIT </span><span class="n">quatloop</span>
<a name="ln-766"></a>
<a name="ln-767"></a><span class="c">! update the progress counter and report it to the calling program via the proc callback routine</span>
<a name="ln-768"></a>  <span class="k">if</span><span class="p">(</span><span class="n">objAddress</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-769"></a><span class="k">    if</span> <span class="p">(</span><span class="n">ip</span><span class="p">.</span><span class="n">ge</span><span class="p">.</span><span class="n">cn</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-770"></a><span class="k">      </span><span class="n">cn</span> <span class="o">=</span> <span class="n">cn</span><span class="o">+</span><span class="n">dn</span>
<a name="ln-771"></a>      <span class="k">call </span><span class="n">proc</span><span class="p">(</span><span class="n">objAddress</span><span class="p">,</span> <span class="n">ip</span><span class="p">)</span>
<a name="ln-772"></a>    <span class="k">end if</span>
<a name="ln-773"></a><span class="k">  end if</span>
<a name="ln-774"></a><span class="k">end do </span><span class="n">quatloop</span>
<a name="ln-775"></a>
<a name="ln-776"></a><span class="k">end subroutine </span><span class="n">EMsoftCgetECPatterns</span>
<a name="ln-777"></a>
<a name="ln-778"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-779"></a><span class="c">!</span>
<a name="ln-780"></a><span class="c">! SUBROUTINE:EMsoftCgetMCOpenCL</span>
<a name="ln-781"></a><span class="c">!</span>
<a name="ln-782"></a><span class="c">!&gt; @author Marc De Graef, Carnegie Mellon University</span>
<a name="ln-783"></a><span class="c">!</span>
<a name="ln-784"></a><span class="c">!&gt; @brief This subroutine can be called by a C/C++ program as a standalone routine to compute Monte Carlo data</span>
<a name="ln-785"></a><span class="c">!</span>
<a name="ln-786"></a><span class="c">!&gt; @details This subroutine provides a method to compute a Monte Carlo data set, normally computed</span>
<a name="ln-787"></a><span class="c">!&gt; with the EMMCOpenCL.f90 program.  The routine can be called from an external C/C++ program; </span>
<a name="ln-788"></a><span class="c">!&gt; the routine provides a callback mechanism to update the calling program about computational </span>
<a name="ln-789"></a><span class="c">!&gt; progress, as well as a cancel option.</span>
<a name="ln-790"></a><span class="c">!&gt;</span>
<a name="ln-791"></a><span class="c">!&gt; The routine is intended to be called from a C/C++ program, e.g., DREAM.3D.  This routine is a </span>
<a name="ln-792"></a><span class="c">!&gt; simplified version of the core of the EMMCOpenCL program. </span>
<a name="ln-793"></a><span class="c">!&gt;</span>
<a name="ln-794"></a><span class="c">!&gt; Since the HDF5 library with fortran90 support can only be a static library on Mac OS X, we must</span>
<a name="ln-795"></a><span class="c">!&gt; have the calling program read the .xtal HDF5 file and pass the necessary information on to</span>
<a name="ln-796"></a><span class="c">!&gt; this routine.  This is a workaround until the HDF group fixes the static library issue; DREAM.3D</span>
<a name="ln-797"></a><span class="c">!&gt; requires a dynamical HDF5 library, so for DREAM.3D and EMsoft to properly work together, the </span>
<a name="ln-798"></a><span class="c">!&gt; callable routines in this file may not depend on any HDF code at all, either directly or indirectly.</span>
<a name="ln-799"></a><span class="c">!&gt;</span>
<a name="ln-800"></a><span class="c">!&gt; @param ipar array with integer input parameters</span>
<a name="ln-801"></a><span class="c">!&gt; @param fpar array with float input parameters</span>
<a name="ln-802"></a><span class="c">!&gt; @param atdata atom coordinate array</span>
<a name="ln-803"></a><span class="c">!&gt; @param attypes atom type array</span>
<a name="ln-804"></a><span class="c">!&gt; @param latparm lattice parameter array</span>
<a name="ln-805"></a><span class="c">!&gt; @param accum_e output array with Monte Carlo energy histogram</span>
<a name="ln-806"></a><span class="c">!&gt; @param accum_z output array with Monte Carlo depth histogram</span>
<a name="ln-807"></a><span class="c">!</span>
<a name="ln-808"></a><span class="c">!&gt; @date 03/08/16 MDG 1.0 original</span>
<a name="ln-809"></a><span class="c">!&gt; @date 03/19/16 MDG 1.1 corrections to a few variable types</span>
<a name="ln-810"></a><span class="c">!&gt; @date 04/13/16 MDG 1.2 correction to accum_z array size due to changes in calling DREAM.3D filter</span>
<a name="ln-811"></a><span class="c">!&gt; @date 04/18/16 MDG 1.3 increased number of entries in ipar, fpar for compatibility with EMsoftCgetEBSDmaster routine</span>
<a name="ln-812"></a><span class="c">!&gt; @date 04/28/16 MDG 1.4 corrected error in indexing of init_seeds array; caused DREAM.3D to crash randomly</span>
<a name="ln-813"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-814"></a><span class="k">recursive subroutine </span><span class="n">EMsoftCgetMCOpenCL</span><span class="p">(</span><span class="n">ipar</span><span class="p">,</span> <span class="n">fpar</span><span class="p">,</span> <span class="n">atompos</span><span class="p">,</span> <span class="n">atomtypes</span><span class="p">,</span> <span class="n">latparm</span><span class="p">,</span> <span class="n">accum_e</span><span class="p">,</span> <span class="n">accum_z</span><span class="p">,</span> <span class="n">cproc</span><span class="p">,</span> <span class="n">objAddress</span><span class="p">,</span> <span class="n">cancel</span><span class="p">)</span> <span class="p">&amp;</span>
<a name="ln-815"></a>           <span class="k">bind</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;EMsoftCgetMCOpenCL&#39;</span><span class="p">)</span>    <span class="c">! this routine is callable from a C/C++ program</span>
<a name="ln-816"></a><span class="c">!DEC$ ATTRIBUTES DLLEXPORT :: EMsoftCgetMCOpenCL</span>
<a name="ln-817"></a>
<a name="ln-818"></a><span class="c">! ipar components</span>
<a name="ln-819"></a><span class="c">! ipar(1) : integer(kind=irg)       :: nx  = (numsx-1)/2</span>
<a name="ln-820"></a><span class="c">! ipar(2) : integer(kind=irg)       :: globalworkgrpsz</span>
<a name="ln-821"></a><span class="c">! ipar(3) : integer(kind=irg)       :: num_el</span>
<a name="ln-822"></a><span class="c">! ipar(4) : integer(kind=irg)       :: totnum_el</span>
<a name="ln-823"></a><span class="c">! ipar(5) : integer(kind=irg)       :: multiplier</span>
<a name="ln-824"></a><span class="c">! ipar(6) : integer(kind=irg)       :: devid</span>
<a name="ln-825"></a><span class="c">! ipar(7) : integer(kind=irg)       :: platid</span>
<a name="ln-826"></a><span class="c">! ipar(8) : integer(kind=irg)       :: CrystalSystem</span>
<a name="ln-827"></a><span class="c">! ipar(9) : integer(kind=irg)       :: Natomtypes</span>
<a name="ln-828"></a><span class="c">! ipar(10): integer(kind=irg)       :: SpaceGroupNumber</span>
<a name="ln-829"></a><span class="c">! ipar(11): integer(kind=irg)       :: SpaceGroupSetting</span>
<a name="ln-830"></a><span class="c">! ipar(12): integer(kind=irg)       :: numEbins</span>
<a name="ln-831"></a><span class="c">! ipar(13): integer(kind=irg)       :: numzbins</span>
<a name="ln-832"></a><span class="c">! ipar(14): integer(kind=irg)       :: mcmode  ( 1 = &#39;full&#39;, 2 = &#39;bse1&#39; )</span>
<a name="ln-833"></a><span class="c">! ipar(15): integer(kind=irg)       :: numangle</span>
<a name="ln-834"></a><span class="c">! ipar(16): integer(kind=irg)       :: nxten = nx/10</span>
<a name="ln-835"></a><span class="c">! other entries are not used</span>
<a name="ln-836"></a>
<a name="ln-837"></a><span class="c">! fpar components</span>
<a name="ln-838"></a><span class="c">! fpar(1) : real(kind=dbl)          :: sig</span>
<a name="ln-839"></a><span class="c">! fpar(2) : real(kind=dbl)          :: omega</span>
<a name="ln-840"></a><span class="c">! fpar(3) : real(kind=dbl)          :: EkeV</span>
<a name="ln-841"></a><span class="c">! fpar(4) : real(kind=dbl)          :: Ehistmin</span>
<a name="ln-842"></a><span class="c">! fpar(5) : real(kind=dbl)          :: Ebinsize</span>
<a name="ln-843"></a><span class="c">! fpar(6) : real(kind=dbl)          :: depthmax</span>
<a name="ln-844"></a><span class="c">! fpar(7) : real(kind=dbl)          :: depthstep</span>
<a name="ln-845"></a><span class="c">! fpar(8) : real(kind=dbl)          :: sigstart</span>
<a name="ln-846"></a><span class="c">! fpar(9) : real(kind=dbl)          :: sigend</span>
<a name="ln-847"></a><span class="c">! fpar(10): real(kind=dbl)          :: sigstep</span>
<a name="ln-848"></a><span class="c">! other entries are not used</span>
<a name="ln-849"></a>
<a name="ln-850"></a>
<a name="ln-851"></a><span class="k">use </span><span class="n">local</span>
<a name="ln-852"></a><span class="k">use </span><span class="n">constants</span>
<a name="ln-853"></a><span class="k">use </span><span class="n">crystal</span>
<a name="ln-854"></a><span class="k">use </span><span class="n">constants</span>
<a name="ln-855"></a><span class="k">use </span><span class="n">symmetry</span>
<a name="ln-856"></a><span class="k">use </span><span class="n">io</span>
<a name="ln-857"></a><span class="k">use </span><span class="n">typedefs</span>
<a name="ln-858"></a><span class="k">use </span><span class="n">clfortran</span>
<a name="ln-859"></a><span class="k">use </span><span class="n">CLsupport</span>
<a name="ln-860"></a><span class="k">use </span><span class="n">timing</span>
<a name="ln-861"></a><span class="k">use</span><span class="p">,</span><span class="k">INTRINSIC</span> <span class="kd">::</span> <span class="nb">ISO_C_BINDING</span>
<a name="ln-862"></a>
<a name="ln-863"></a><span class="k">IMPLICIT NONE</span>
<a name="ln-864"></a>
<a name="ln-865"></a><span class="kt">integer</span><span class="p">(</span><span class="kt">c_int32_t</span><span class="p">),</span><span class="k">PARAMETER</span>            <span class="kd">::</span> <span class="n">nipar</span><span class="o">=</span><span class="mi">40</span>
<a name="ln-866"></a><span class="kt">integer</span><span class="p">(</span><span class="kt">c_int32_t</span><span class="p">),</span><span class="k">PARAMETER</span>            <span class="kd">::</span> <span class="n">nfpar</span><span class="o">=</span><span class="mi">40</span>
<a name="ln-867"></a><span class="kt">integer</span><span class="p">(</span><span class="kt">c_int32_t</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>           <span class="kd">::</span> <span class="n">ipar</span><span class="p">(</span><span class="n">nipar</span><span class="p">)</span>
<a name="ln-868"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>               <span class="kd">::</span> <span class="n">fpar</span><span class="p">(</span><span class="n">nfpar</span><span class="p">)</span>
<a name="ln-869"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>               <span class="kd">::</span> <span class="n">atompos</span><span class="p">(</span><span class="n">ipar</span><span class="p">(</span><span class="mi">9</span><span class="p">),</span><span class="mi">5</span><span class="p">)</span>
<a name="ln-870"></a><span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">irg</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>            <span class="kd">::</span> <span class="n">atomtypes</span><span class="p">(</span><span class="n">ipar</span><span class="p">(</span><span class="mi">9</span><span class="p">))</span>
<a name="ln-871"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>               <span class="kd">::</span> <span class="n">latparm</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
<a name="ln-872"></a><span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">irg</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">OUT</span><span class="p">)</span>           <span class="kd">::</span> <span class="n">accum_e</span><span class="p">(</span><span class="n">ipar</span><span class="p">(</span><span class="mi">12</span><span class="p">),</span><span class="o">-</span><span class="n">ipar</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span><span class="n">ipar</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="o">-</span><span class="n">ipar</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span><span class="n">ipar</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
<a name="ln-873"></a><span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">irg</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">OUT</span><span class="p">)</span>           <span class="kd">::</span> <span class="n">accum_z</span><span class="p">(</span><span class="n">ipar</span><span class="p">(</span><span class="mi">12</span><span class="p">),</span><span class="n">ipar</span><span class="p">(</span><span class="mi">13</span><span class="p">),</span><span class="o">-</span><span class="n">ipar</span><span class="p">(</span><span class="mi">16</span><span class="p">):</span><span class="n">ipar</span><span class="p">(</span><span class="mi">16</span><span class="p">),</span><span class="o">-</span><span class="n">ipar</span><span class="p">(</span><span class="mi">16</span><span class="p">):</span><span class="n">ipar</span><span class="p">(</span><span class="mi">16</span><span class="p">))</span>
<a name="ln-874"></a><span class="k">TYPE</span><span class="p">(</span><span class="kt">C_FUNPTR</span><span class="p">),</span> <span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">),</span> <span class="k">VALUE</span>       <span class="kd">::</span> <span class="n">cproc</span>
<a name="ln-875"></a><span class="kt">integer</span><span class="p">(</span><span class="kt">c_size_t</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">),</span> <span class="k">VALUE</span>     <span class="kd">::</span> <span class="n">objAddress</span>
<a name="ln-876"></a><span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>             <span class="kd">::</span> <span class="n">cancel</span>
<a name="ln-877"></a>
<a name="ln-878"></a><span class="c">! local variables and parameters</span>
<a name="ln-879"></a><span class="k">type</span><span class="p">(</span><span class="n">unitcell</span><span class="p">),</span><span class="k">pointer</span>                  <span class="kd">::</span> <span class="n">cell</span>
<a name="ln-880"></a><span class="kt">character</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>                            <span class="kd">::</span> <span class="n">mode</span>
<a name="ln-881"></a><span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">ill</span><span class="p">)</span>                       <span class="kd">::</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">io_int</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">num_max</span><span class="p">,</span> <span class="n">totnum_el</span><span class="p">,</span> <span class="n">ipg</span><span class="p">,</span> <span class="n">isave</span><span class="p">,</span> <span class="n">istat</span>
<a name="ln-882"></a><span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">irg</span><span class="p">)</span>                       <span class="kd">::</span> <span class="n">nx</span><span class="p">,</span> <span class="n">numEbins</span><span class="p">,</span> <span class="n">numzbins</span><span class="p">,</span> <span class="n">numangle</span><span class="p">,</span> <span class="n">iang</span><span class="p">,</span> <span class="n">cn</span><span class="p">,</span> <span class="n">dn</span><span class="p">,</span> <span class="n">totn</span> 
<a name="ln-883"></a><span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">irg</span><span class="p">),</span><span class="k">target</span>                <span class="kd">::</span> <span class="n">globalworkgrpsz</span><span class="p">,</span> <span class="n">num_el</span><span class="p">,</span> <span class="n">steps</span>
<a name="ln-884"></a><span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">),</span><span class="k">target</span>                  <span class="kd">::</span> <span class="n">globalsize</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">localsize</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> 
<a name="ln-885"></a><span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>                         <span class="kd">::</span> <span class="n">size_in_bytes</span><span class="p">,</span><span class="n">size_in_bytes_seeds</span> 
<a name="ln-886"></a>
<a name="ln-887"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">),</span><span class="k">target</span>                   <span class="kd">::</span> <span class="n">dens</span><span class="p">,</span> <span class="n">avA</span><span class="p">,</span> <span class="n">avZ</span><span class="p">,</span> <span class="n">omega</span><span class="p">,</span> <span class="n">EkeV</span><span class="p">,</span> <span class="n">sig</span><span class="p">,</span> <span class="n">bseyield</span><span class="p">,</span> <span class="n">io_real</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-888"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">4</span><span class="p">),</span><span class="k">target</span>                     <span class="kd">::</span> <span class="n">density</span><span class="p">,</span> <span class="n">Ze</span><span class="p">,</span> <span class="n">at_wt</span><span class="p">,</span> <span class="n">delta</span>
<a name="ln-889"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">),</span><span class="k">parameter</span>                  <span class="kd">::</span> <span class="n">dtoR</span> <span class="o">=</span> <span class="mf">0.01745329251D0</span>  <span class="c">! pi/180</span>
<a name="ln-890"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">4</span><span class="p">),</span><span class="k">allocatable</span><span class="p">,</span> <span class="k">target</span>        <span class="kd">::</span> <span class="n">Lamresx</span><span class="p">(:),</span> <span class="n">Lamresy</span><span class="p">(:),</span> <span class="n">depthres</span><span class="p">(:),</span> <span class="n">energyres</span><span class="p">(:)</span>
<a name="ln-891"></a>
<a name="ln-892"></a><span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">4</span><span class="p">),</span><span class="k">allocatable</span>             <span class="kd">::</span> <span class="n">rnseeds</span><span class="p">(:)</span>
<a name="ln-893"></a><span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">4</span><span class="p">),</span><span class="k">allocatable</span><span class="p">,</span><span class="k">target</span>      <span class="kd">::</span> <span class="n">init_seeds</span><span class="p">(:)</span>
<a name="ln-894"></a><span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>                         <span class="kd">::</span> <span class="n">idxy</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">iE</span><span class="p">,</span> <span class="n">px</span><span class="p">,</span> <span class="n">py</span><span class="p">,</span> <span class="n">iz</span><span class="p">,</span> <span class="n">nseeds</span><span class="p">,</span> <span class="n">hdferr</span><span class="p">,</span> <span class="n">tstart</span> <span class="c">! auxiliary variables</span>
<a name="ln-895"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>                            <span class="kd">::</span> <span class="n">cxyz</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">edis</span><span class="p">,</span> <span class="n">bse</span><span class="p">,</span> <span class="n">xy</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">xs</span><span class="p">,</span> <span class="n">ys</span><span class="p">,</span> <span class="n">zs</span><span class="p">,</span> <span class="n">sclf</span> <span class="c">! auxiliary variables</span>
<a name="ln-896"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>                            <span class="kd">::</span> <span class="nb">rand</span>
<a name="ln-897"></a><span class="kt">logical</span>                                 <span class="kd">::</span> <span class="n">f_exists</span>
<a name="ln-898"></a>
<a name="ln-899"></a>
<a name="ln-900"></a><span class="c">! OpenCL variables</span>
<a name="ln-901"></a><span class="kt">integer</span><span class="p">(</span><span class="kt">c_intptr_t</span><span class="p">),</span><span class="k">allocatable</span><span class="p">,</span> <span class="k">target</span> <span class="kd">::</span> <span class="n">platform</span><span class="p">(:)</span>
<a name="ln-902"></a><span class="kt">integer</span><span class="p">(</span><span class="kt">c_intptr_t</span><span class="p">),</span><span class="k">allocatable</span><span class="p">,</span> <span class="k">target</span> <span class="kd">::</span> <span class="n">device</span><span class="p">(:)</span>
<a name="ln-903"></a><span class="kt">integer</span><span class="p">(</span><span class="kt">c_intptr_t</span><span class="p">),</span><span class="k">target</span>              <span class="kd">::</span> <span class="n">context</span>
<a name="ln-904"></a><span class="kt">integer</span><span class="p">(</span><span class="kt">c_intptr_t</span><span class="p">),</span><span class="k">target</span>              <span class="kd">::</span> <span class="n">command_queue</span>
<a name="ln-905"></a><span class="kt">integer</span><span class="p">(</span><span class="kt">c_intptr_t</span><span class="p">),</span><span class="k">target</span>              <span class="kd">::</span> <span class="n">prog</span>
<a name="ln-906"></a><span class="kt">integer</span><span class="p">(</span><span class="kt">c_intptr_t</span><span class="p">),</span><span class="k">target</span>              <span class="kd">::</span> <span class="n">kernel</span>
<a name="ln-907"></a><span class="kt">integer</span><span class="p">(</span><span class="kt">c_intptr_t</span><span class="p">),</span><span class="k">target</span>              <span class="kd">::</span> <span class="n">LamX</span><span class="p">,</span> <span class="n">LamY</span><span class="p">,</span> <span class="n">LamZ</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">energy</span><span class="p">,</span> <span class="n">seeds</span>
<a name="ln-908"></a><span class="k">type</span><span class="p">(</span><span class="kt">c_ptr</span><span class="p">)</span>                             <span class="kd">::</span> <span class="n">event</span>
<a name="ln-909"></a><span class="kt">integer</span><span class="p">(</span><span class="kt">c_int32_t</span><span class="p">)</span>                      <span class="kd">::</span> <span class="n">ierr</span><span class="p">,</span> <span class="n">pcnt</span>
<a name="ln-910"></a><span class="kt">integer</span><span class="p">(</span><span class="kt">c_size_t</span><span class="p">),</span><span class="k">target</span>                <span class="kd">::</span> <span class="n">slength</span>
<a name="ln-911"></a><span class="kt">integer</span><span class="p">(</span><span class="kt">c_intptr_t</span><span class="p">),</span><span class="k">target</span>              <span class="kd">::</span> <span class="n">ctx_props</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-912"></a><span class="kt">character</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span><span class="k">target</span>                     <span class="kd">::</span> <span class="n">kernelname</span>
<a name="ln-913"></a><span class="kt">character</span><span class="p">(</span><span class="mi">19</span><span class="p">),</span><span class="k">target</span>                    <span class="kd">::</span> <span class="n">progoptions</span>
<a name="ln-914"></a><span class="kt">character</span><span class="p">(</span><span class="n">fnlen</span><span class="p">),</span><span class="k">target</span>                 <span class="kd">::</span> <span class="n">info</span> <span class="c">! info about the GPU</span>
<a name="ln-915"></a><span class="kt">integer</span><span class="p">(</span><span class="kt">c_int64_t</span><span class="p">)</span>                      <span class="kd">::</span> <span class="n">cmd_queue_props</span>
<a name="ln-916"></a>
<a name="ln-917"></a><span class="kt">integer</span><span class="p">,</span> <span class="k">parameter</span>                      <span class="kd">::</span> <span class="n">iunit</span> <span class="o">=</span> <span class="mi">10</span>
<a name="ln-918"></a><span class="kt">integer</span><span class="p">,</span> <span class="k">parameter</span>                      <span class="kd">::</span> <span class="n">source_length</span> <span class="o">=</span> <span class="mi">50000</span>
<a name="ln-919"></a><span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="n">source_length</span><span class="p">),</span><span class="k">target</span>     <span class="kd">::</span> <span class="n">source</span>
<a name="ln-920"></a><span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="n">source_length</span><span class="p">,</span> <span class="nb">KIND</span><span class="o">=</span><span class="kt">c_char</span><span class="p">),</span><span class="k">TARGET</span> <span class="kd">::</span> <span class="n">csource</span>
<a name="ln-921"></a><span class="k">type</span><span class="p">(</span><span class="kt">c_ptr</span><span class="p">),</span> <span class="k">target</span>                     <span class="kd">::</span> <span class="n">psource</span>
<a name="ln-922"></a><span class="kt">integer</span><span class="p">(</span><span class="kt">c_int</span><span class="p">)</span>                          <span class="kd">::</span> <span class="n">nump</span><span class="p">,</span> <span class="n">numd</span><span class="p">,</span> <span class="n">irec</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span><span class="n">val1</span> <span class="c">! auxiliary variables</span>
<a name="ln-923"></a><span class="kt">integer</span><span class="p">(</span><span class="kt">c_size_t</span><span class="p">)</span>                       <span class="kd">::</span> <span class="n">cnum</span><span class="p">,</span> <span class="n">cnuminfo</span>
<a name="ln-924"></a><span class="kt">character</span><span class="p">(</span><span class="n">fnlen</span><span class="p">)</span>                        <span class="kd">::</span> <span class="n">instring</span><span class="p">,</span> <span class="n">dataname</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">sourcefile</span>
<a name="ln-925"></a><span class="k">PROCEDURE</span><span class="p">(</span><span class="n">ProgressCallBack2</span><span class="p">),</span> <span class="k">POINTER</span>   <span class="kd">::</span> <span class="n">proc</span>
<a name="ln-926"></a>
<a name="ln-927"></a><span class="c">! link the proc procedure to the cproc argument</span>
<a name="ln-928"></a><span class="k">CALL </span><span class="nb">C_F_PROCPOINTER</span> <span class="p">(</span><span class="n">cproc</span><span class="p">,</span> <span class="n">proc</span><span class="p">)</span>
<a name="ln-929"></a>
<a name="ln-930"></a><span class="c">! since this routine needs to read a .cl file, we need to make sure that the pathnames are </span>
<a name="ln-931"></a><span class="c">! properly set...</span>
<a name="ln-932"></a><span class="k">call </span><span class="n">EMsoft_path_init</span>
<a name="ln-933"></a>
<a name="ln-934"></a><span class="c">! the following is necessitated by the fact that none of this code may </span>
<a name="ln-935"></a><span class="c">! depend on HDF5 routines, so we need to cut-and-paste from various </span>
<a name="ln-936"></a><span class="c">! other library routines to set things up so that we can compute the </span>
<a name="ln-937"></a><span class="c">! density, and the average atomic number and atomic mass...</span>
<a name="ln-938"></a>
<a name="ln-939"></a><span class="c">! copy all the unit cell parameters into the proper fields and compute the </span>
<a name="ln-940"></a><span class="c">! density parameters needed by the Monte Carlo routine; then discard the cell structure</span>
<a name="ln-941"></a><span class="k">nullify</span><span class="p">(</span><span class="n">cell</span><span class="p">)</span>
<a name="ln-942"></a><span class="k">allocate</span><span class="p">(</span><span class="n">cell</span><span class="p">)</span>
<a name="ln-943"></a><span class="c">! lattice parameters</span>
<a name="ln-944"></a><span class="n">cell</span><span class="p">%</span><span class="n">a</span> <span class="o">=</span> <span class="nb">dble</span><span class="p">(</span><span class="n">latparm</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
<a name="ln-945"></a><span class="n">cell</span><span class="p">%</span><span class="n">b</span> <span class="o">=</span> <span class="nb">dble</span><span class="p">(</span><span class="n">latparm</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
<a name="ln-946"></a><span class="n">cell</span><span class="p">%</span><span class="n">c</span> <span class="o">=</span> <span class="nb">dble</span><span class="p">(</span><span class="n">latparm</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
<a name="ln-947"></a><span class="n">cell</span><span class="p">%</span><span class="n">alpha</span> <span class="o">=</span> <span class="nb">dble</span><span class="p">(</span><span class="n">latparm</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
<a name="ln-948"></a><span class="n">cell</span><span class="p">%</span><span class="n">beta</span> <span class="o">=</span> <span class="nb">dble</span><span class="p">(</span><span class="n">latparm</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>
<a name="ln-949"></a><span class="n">cell</span><span class="p">%</span><span class="nb">gamma</span> <span class="o">=</span> <span class="nb">dble</span><span class="p">(</span><span class="n">latparm</span><span class="p">(</span><span class="mi">6</span><span class="p">))</span>
<a name="ln-950"></a><span class="c">! symmetry parameters</span>
<a name="ln-951"></a><span class="n">cell</span><span class="p">%</span><span class="n">xtal_system</span> <span class="o">=</span> <span class="n">ipar</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
<a name="ln-952"></a><span class="n">cell</span><span class="p">%</span><span class="n">SYM_SGset</span> <span class="o">=</span> <span class="n">ipar</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span>
<a name="ln-953"></a><span class="n">cell</span><span class="p">%</span><span class="n">SYM_SGnum</span> <span class="o">=</span> <span class="n">ipar</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<a name="ln-954"></a><span class="k">if</span> <span class="p">((</span><span class="n">cell</span><span class="p">%</span><span class="n">SYM_SGnum</span><span class="p">.</span><span class="n">ge</span><span class="p">.</span><span class="mi">143</span><span class="p">).</span><span class="nb">and</span><span class="p">.(</span><span class="n">cell</span><span class="p">%</span><span class="n">SYM_SGnum</span><span class="p">.</span><span class="n">le</span><span class="p">.</span><span class="mi">167</span><span class="p">))</span> <span class="k">then</span>
<a name="ln-955"></a><span class="k">  </span><span class="n">cell</span><span class="p">%</span><span class="n">SG</span><span class="p">%</span><span class="n">SYM_trigonal</span> <span class="o">=</span> <span class="p">.</span><span class="n">TRUE</span><span class="p">.</span>
<a name="ln-956"></a><span class="k">else</span>
<a name="ln-957"></a><span class="k">  </span><span class="n">cell</span><span class="p">%</span><span class="n">SG</span><span class="p">%</span><span class="n">SYM_trigonal</span> <span class="o">=</span> <span class="p">.</span><span class="n">FALSE</span><span class="p">.</span>
<a name="ln-958"></a><span class="k">end if</span> 
<a name="ln-959"></a><span class="c">! atom type and coordinate parameters</span>
<a name="ln-960"></a><span class="n">cell</span><span class="p">%</span><span class="n">ATOM_ntype</span> <span class="o">=</span> <span class="n">ipar</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span>
<a name="ln-961"></a><span class="n">cell</span><span class="p">%</span><span class="n">ATOM_type</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">cell</span><span class="p">%</span><span class="n">ATOM_ntype</span><span class="p">)</span> <span class="o">=</span> <span class="n">atomtypes</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">cell</span><span class="p">%</span><span class="n">ATOM_ntype</span><span class="p">)</span> 
<a name="ln-962"></a><span class="n">cell</span><span class="p">%</span><span class="n">ATOM_pos</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">cell</span><span class="p">%</span><span class="n">ATOM_ntype</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="n">atompos</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">cell</span><span class="p">%</span><span class="n">ATOM_ntype</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="mi">5</span><span class="p">)</span> 
<a name="ln-963"></a><span class="c">! generate the symmetry operations</span>
<a name="ln-964"></a><span class="n">cell</span><span class="p">%</span><span class="n">hexset</span> <span class="o">=</span> <span class="p">.</span><span class="n">FALSE</span><span class="p">.</span>
<a name="ln-965"></a><span class="k">if</span> <span class="p">(</span><span class="n">cell</span><span class="p">%</span><span class="n">xtal_system</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mi">4</span><span class="p">)</span> <span class="n">cell</span><span class="p">%</span><span class="n">hexset</span> <span class="o">=</span> <span class="p">.</span><span class="n">TRUE</span><span class="p">.</span>
<a name="ln-966"></a><span class="k">if</span> <span class="p">((</span><span class="n">cell</span><span class="p">%</span><span class="n">xtal_system</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mi">5</span><span class="p">).</span><span class="nb">AND</span><span class="p">.(</span><span class="n">cell</span><span class="p">%</span><span class="n">SYM_SGset</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="mi">2</span><span class="p">))</span> <span class="n">cell</span><span class="p">%</span><span class="n">hexset</span> <span class="o">=</span> <span class="p">.</span><span class="n">TRUE</span><span class="p">.</span>
<a name="ln-967"></a><span class="c">! compute the metric matrices</span>
<a name="ln-968"></a> <span class="k">call </span><span class="n">CalcMatrices</span><span class="p">(</span><span class="n">cell</span><span class="p">)</span>
<a name="ln-969"></a><span class="c">! First generate the point symmetry matrices, then the actual space group.</span>
<a name="ln-970"></a><span class="c">! Get the symmorphic space group corresponding to the point group</span>
<a name="ln-971"></a><span class="c">! of the actual space group</span>
<a name="ln-972"></a> <span class="n">ipg</span><span class="o">=</span><span class="mi">0</span>
<a name="ln-973"></a> <span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="mi">32</span>
<a name="ln-974"></a>  <span class="k">if</span> <span class="p">(</span><span class="n">SGPG</span><span class="p">(</span><span class="n">i</span><span class="p">).</span><span class="n">le</span><span class="p">.</span><span class="n">cell</span><span class="p">%</span><span class="n">SYM_SGnum</span><span class="p">)</span> <span class="n">ipg</span><span class="o">=</span><span class="n">i</span>
<a name="ln-975"></a> <span class="k">end do</span>
<a name="ln-976"></a><span class="c">! if the actual group is also the symmorphic group, then both </span>
<a name="ln-977"></a><span class="c">! steps can be done simultaneously, otherwise two calls to </span>
<a name="ln-978"></a><span class="c">! GenerateSymmetry are needed.</span>
<a name="ln-979"></a> <span class="k">if</span> <span class="p">(</span><span class="n">SGPG</span><span class="p">(</span><span class="n">ipg</span><span class="p">).</span><span class="n">eq</span><span class="p">.</span><span class="n">cell</span><span class="p">%</span><span class="n">SYM_SGnum</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-980"></a><span class="k">  call </span><span class="n">GenerateSymmetry</span><span class="p">(</span><span class="n">cell</span><span class="p">,.</span><span class="n">TRUE</span><span class="p">.)</span>
<a name="ln-981"></a> <span class="k">else</span>
<a name="ln-982"></a><span class="k">  </span><span class="n">isave</span> <span class="o">=</span> <span class="n">cell</span><span class="p">%</span><span class="n">SYM_SGnum</span>
<a name="ln-983"></a>  <span class="n">cell</span><span class="p">%</span><span class="n">SYM_SGnum</span> <span class="o">=</span> <span class="n">SGPG</span><span class="p">(</span><span class="n">ipg</span><span class="p">)</span>
<a name="ln-984"></a>  <span class="k">call </span><span class="n">GenerateSymmetry</span><span class="p">(</span><span class="n">cell</span><span class="p">,.</span><span class="n">TRUE</span><span class="p">.)</span>
<a name="ln-985"></a>  <span class="n">cell</span><span class="p">%</span><span class="n">SYM_SGnum</span> <span class="o">=</span> <span class="n">isave</span>
<a name="ln-986"></a>  <span class="k">call </span><span class="n">GenerateSymmetry</span><span class="p">(</span><span class="n">cell</span><span class="p">,.</span><span class="n">FALSE</span><span class="p">.)</span>
<a name="ln-987"></a> <span class="k">end if</span>
<a name="ln-988"></a><span class="c">! next we get all the atom positions</span>
<a name="ln-989"></a><span class="k">call </span><span class="n">CalcPositions</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span><span class="s1">&#39;v&#39;</span><span class="p">)</span>
<a name="ln-990"></a><span class="c">! and now we have all we need to compute the density, average A and average Z</span>
<a name="ln-991"></a><span class="k">call </span><span class="n">CalcDensity</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span> <span class="n">dens</span><span class="p">,</span> <span class="n">avZ</span><span class="p">,</span> <span class="n">avA</span><span class="p">)</span>
<a name="ln-992"></a><span class="c">! deallocate the cell structure</span>
<a name="ln-993"></a><span class="k">deallocate</span><span class="p">(</span><span class="n">cell</span><span class="p">)</span>
<a name="ln-994"></a>
<a name="ln-995"></a><span class="c">! and copy these values into the desired variables</span>
<a name="ln-996"></a><span class="n">density</span> <span class="o">=</span> <span class="nb">dble</span><span class="p">(</span><span class="n">dens</span><span class="p">)</span>
<a name="ln-997"></a><span class="n">Ze</span> <span class="o">=</span> <span class="nb">dble</span><span class="p">(</span><span class="n">avZ</span><span class="p">)</span>
<a name="ln-998"></a><span class="n">at_wt</span> <span class="o">=</span> <span class="nb">dble</span><span class="p">(</span><span class="n">avA</span><span class="p">)</span>
<a name="ln-999"></a>
<a name="ln-1000"></a><span class="c">! define a number of parameters</span>
<a name="ln-1001"></a><span class="n">steps</span> <span class="o">=</span> <span class="mi">300</span>
<a name="ln-1002"></a><span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;full&#39;</span>
<a name="ln-1003"></a><span class="k">if</span> <span class="p">(</span><span class="n">ipar</span><span class="p">(</span><span class="mi">14</span><span class="p">).</span><span class="n">ne</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span> <span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;bse1&#39;</span>   
<a name="ln-1004"></a><span class="n">EkeV</span> <span class="o">=</span> <span class="nb">sngl</span><span class="p">(</span><span class="n">fpar</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
<a name="ln-1005"></a><span class="c">!sig = mcnl%sig*dtoR    ! this is defined later on and depends on the mode</span>
<a name="ln-1006"></a><span class="n">omega</span> <span class="o">=</span> <span class="nb">sngl</span><span class="p">(</span><span class="n">fpar</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span><span class="o">*</span><span class="n">dtoR</span>
<a name="ln-1007"></a><span class="n">globalworkgrpsz</span> <span class="o">=</span> <span class="n">ipar</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<a name="ln-1008"></a><span class="n">num_el</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ipar</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>  <span class="c">! no. of electron simulation by one work item</span>
<a name="ln-1009"></a><span class="n">num_max</span> <span class="o">=</span> <span class="n">globalworkgrpsz</span><span class="o">*</span><span class="n">globalworkgrpsz</span><span class="o">*</span><span class="n">num_el</span> <span class="c">! total simulation in one loop</span>
<a name="ln-1010"></a><span class="n">totnum_el</span> <span class="o">=</span> <span class="n">ipar</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">*</span> <span class="n">ipar</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="c">! total number of electrons to simulate</span>
<a name="ln-1011"></a><span class="n">globalsize</span> <span class="o">=</span> <span class="p">(</span><span class="o">/</span> <span class="n">globalworkgrpsz</span><span class="p">,</span> <span class="n">globalworkgrpsz</span> <span class="o">/</span><span class="p">)</span>
<a name="ln-1012"></a><span class="c">!localsize = (/ globalworkgrpsz, globalworkgrpsz /)</span>
<a name="ln-1013"></a><span class="c">!localsize = (/ globalworkgrpsz/10, globalworkgrpsz/10 /)</span>
<a name="ln-1014"></a><span class="n">numEbins</span> <span class="o">=</span>  <span class="nb">int</span><span class="p">(</span><span class="n">ipar</span><span class="p">(</span><span class="mi">12</span><span class="p">))</span>
<a name="ln-1015"></a><span class="n">numzbins</span> <span class="o">=</span>  <span class="nb">int</span><span class="p">(</span><span class="n">ipar</span><span class="p">(</span><span class="mi">13</span><span class="p">))</span>
<a name="ln-1016"></a><span class="n">nx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ipar</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
<a name="ln-1017"></a><span class="n">delta</span> <span class="o">=</span> <span class="nb">dble</span><span class="p">(</span><span class="n">nx</span><span class="p">)</span>
<a name="ln-1018"></a><span class="n">size_in_bytes</span> <span class="o">=</span> <span class="n">num_max</span><span class="o">*</span><span class="n">sizeof</span><span class="p">(</span><span class="n">EkeV</span><span class="p">)</span>
<a name="ln-1019"></a><span class="n">size_in_bytes_seeds</span> <span class="o">=</span> <span class="mi">4</span><span class="o">*</span><span class="n">globalworkgrpsz</span><span class="o">*</span><span class="n">globalworkgrpsz</span><span class="o">*</span><span class="n">sizeof</span><span class="p">(</span><span class="n">EkeV</span><span class="p">)</span>
<a name="ln-1020"></a><span class="n">numangle</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ipar</span><span class="p">(</span><span class="mi">15</span><span class="p">))</span>
<a name="ln-1021"></a>
<a name="ln-1022"></a><span class="c">! next allocate and initialize a couple of arrays</span>
<a name="ln-1023"></a><span class="k">allocate</span><span class="p">(</span><span class="n">Lamresx</span><span class="p">(</span><span class="n">num_max</span><span class="p">),</span> <span class="n">Lamresy</span><span class="p">(</span><span class="n">num_max</span><span class="p">),</span> <span class="n">depthres</span><span class="p">(</span><span class="n">num_max</span><span class="p">),</span> <span class="n">energyres</span><span class="p">(</span><span class="n">num_max</span><span class="p">),</span> <span class="nb">stat</span><span class="o">=</span><span class="n">istat</span><span class="p">)</span>
<a name="ln-1024"></a><span class="n">depthres</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-1025"></a><span class="n">energyres</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-1026"></a><span class="n">Lamresx</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-1027"></a><span class="n">Lamresy</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-1028"></a><span class="n">accum_e</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-1029"></a><span class="n">accum_z</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-1030"></a>
<a name="ln-1031"></a>
<a name="ln-1032"></a><span class="c">!======================</span>
<a name="ln-1033"></a><span class="c">! OpenCL INITIALIZATION</span>
<a name="ln-1034"></a><span class="c">!======================</span>
<a name="ln-1035"></a><span class="k">call </span><span class="n">CLinit_PDCCQ</span><span class="p">(</span><span class="n">platform</span><span class="p">,</span> <span class="n">nump</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">ipar</span><span class="p">(</span><span class="mi">7</span><span class="p">)),</span> <span class="n">device</span><span class="p">,</span> <span class="n">numd</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">ipar</span><span class="p">(</span><span class="mi">6</span><span class="p">)),</span> <span class="n">info</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">command_queue</span><span class="p">)</span>
<a name="ln-1036"></a>
<a name="ln-1037"></a><span class="c">!=====================</span>
<a name="ln-1038"></a><span class="c">! BUILD THE KERNEL</span>
<a name="ln-1039"></a><span class="c">!=====================</span>
<a name="ln-1040"></a><span class="c">! read the source file</span>
<a name="ln-1041"></a><span class="n">sourcefile</span> <span class="o">=</span> <span class="s1">&#39;EMMC.cl&#39;</span>
<a name="ln-1042"></a><span class="k">call </span><span class="n">CLread_source_file</span><span class="p">(</span><span class="n">sourcefile</span><span class="p">,</span> <span class="n">csource</span><span class="p">,</span> <span class="n">slength</span><span class="p">)</span>
<a name="ln-1043"></a>
<a name="ln-1044"></a><span class="c">! we disable all screen output; perhaps we can feed error messages back to the calling program...</span>
<a name="ln-1045"></a>
<a name="ln-1046"></a><span class="c">! create the program</span>
<a name="ln-1047"></a><span class="n">pcnt</span> <span class="o">=</span> <span class="mi">1</span>
<a name="ln-1048"></a><span class="n">psource</span> <span class="o">=</span> <span class="nb">C_LOC</span><span class="p">(</span><span class="n">csource</span><span class="p">)</span>
<a name="ln-1049"></a><span class="n">prog</span> <span class="o">=</span> <span class="n">clCreateProgramWithSource</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">pcnt</span><span class="p">,</span> <span class="nb">C_LOC</span><span class="p">(</span><span class="n">psource</span><span class="p">),</span> <span class="nb">C_LOC</span><span class="p">(</span><span class="n">slength</span><span class="p">),</span> <span class="n">ierr</span><span class="p">)</span>
<a name="ln-1050"></a><span class="c">! if(ierr /= CL_SUCCESS) call FatalError(&quot;clCreateProgramWithSource: &quot;,&#39;Error: cannot create program from source.&#39;)</span>
<a name="ln-1051"></a>
<a name="ln-1052"></a><span class="c">! build the program</span>
<a name="ln-1053"></a><span class="n">progoptions</span> <span class="o">=</span> <span class="s1">&#39;-cl-no-signed-zeros&#39;</span>
<a name="ln-1054"></a><span class="n">ierr</span> <span class="o">=</span> <span class="n">clBuildProgram</span><span class="p">(</span><span class="n">prog</span><span class="p">,</span> <span class="n">numd</span><span class="p">,</span> <span class="nb">C_LOC</span><span class="p">(</span><span class="n">device</span><span class="p">),</span> <span class="nb">C_LOC</span><span class="p">(</span><span class="n">progoptions</span><span class="p">),</span> <span class="nb">C_NULL_FUNPTR</span><span class="p">,</span> <span class="nb">C_NULL_PTR</span><span class="p">)</span>
<a name="ln-1055"></a><span class="c">! if(ierr /= CL_SUCCESS) call FatalError(&quot;clBuildProgram: &quot;,&#39;Error: cannot build program.&#39;)</span>
<a name="ln-1056"></a>
<a name="ln-1057"></a><span class="c">! get the compilation log</span>
<a name="ln-1058"></a><span class="n">ierr</span> <span class="o">=</span> <span class="n">clGetProgramBuildInfo</span><span class="p">(</span><span class="n">prog</span><span class="p">,</span> <span class="n">device</span><span class="p">(</span><span class="n">ipar</span><span class="p">(</span><span class="mi">6</span><span class="p">)),</span> <span class="n">CL_PROGRAM_BUILD_LOG</span><span class="p">,</span> <span class="n">sizeof</span><span class="p">(</span><span class="n">source</span><span class="p">),</span> <span class="nb">C_LOC</span><span class="p">(</span><span class="n">source</span><span class="p">),</span> <span class="n">cnum</span><span class="p">)</span>
<a name="ln-1059"></a><span class="c">! if(len(trim(source)) &gt; 0) call Message(trim(source(1:cnum)),frm=&#39;(A)&#39;)</span>
<a name="ln-1060"></a><span class="c">! if(ierr /= CL_SUCCESS) call FatalError(&quot;clGetProgramBuildInfo: &quot;,&#39;Error building program.&#39;)</span>
<a name="ln-1061"></a>
<a name="ln-1062"></a><span class="c">! if we get here, then the program build was successful and we can proceed with the creation of the kernel</span>
<a name="ln-1063"></a><span class="c">! call Message(&#39;Program Build Successful... Creating kernel&#39;)</span>
<a name="ln-1064"></a>
<a name="ln-1065"></a><span class="c">! finally get the kernel and release the program</span>
<a name="ln-1066"></a><span class="n">kernelname</span> <span class="o">=</span> <span class="s1">&#39;MC&#39;</span>
<a name="ln-1067"></a><span class="n">kernel</span> <span class="o">=</span> <span class="n">clCreateKernel</span><span class="p">(</span><span class="n">prog</span><span class="p">,</span> <span class="nb">C_LOC</span><span class="p">(</span><span class="n">kernelname</span><span class="p">),</span> <span class="n">ierr</span><span class="p">)</span>
<a name="ln-1068"></a><span class="c">! if(ierr /= CL_SUCCESS) call FatalError(&quot;clCreateKernel: &quot;,&#39;Error creating kernel MC.&#39;)</span>
<a name="ln-1069"></a>
<a name="ln-1070"></a><span class="n">ierr</span> <span class="o">=</span> <span class="n">clReleaseProgram</span><span class="p">(</span><span class="n">prog</span><span class="p">)</span>
<a name="ln-1071"></a><span class="c">! if(ierr /= CL_SUCCESS) call FatalError(&quot;clReleaseProgram: &quot;,&#39;Error releasing program.&#39;)</span>
<a name="ln-1072"></a>
<a name="ln-1073"></a><span class="k">open</span><span class="p">(</span><span class="n">unit</span> <span class="o">=</span> <span class="n">iunit</span><span class="p">,</span> <span class="k">file</span> <span class="o">=</span> <span class="nb">trim</span><span class="p">(</span><span class="n">EMsoft_toNativePath</span><span class="p">(</span><span class="n">EMsoft_getRandomseedfilename</span><span class="p">())),</span> <span class="n">form</span><span class="o">=</span><span class="s1">&#39;unformatted&#39;</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="s1">&#39;old&#39;</span><span class="p">)</span>
<a name="ln-1074"></a><span class="k">read</span><span class="p">(</span><span class="n">iunit</span><span class="p">)</span> <span class="n">nseeds</span>
<a name="ln-1075"></a><span class="k">allocate</span><span class="p">(</span><span class="n">rnseeds</span><span class="p">(</span><span class="n">nseeds</span><span class="p">))</span>
<a name="ln-1076"></a><span class="k">read</span><span class="p">(</span><span class="n">iunit</span><span class="p">)</span> <span class="n">rnseeds</span>
<a name="ln-1077"></a><span class="k">close</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">iunit</span><span class="p">,</span><span class="n">status</span><span class="o">=</span><span class="s1">&#39;keep&#39;</span><span class="p">)</span>
<a name="ln-1078"></a>
<a name="ln-1079"></a><span class="c">! the next error needs to be checked in the calling program</span>
<a name="ln-1080"></a><span class="c">! if (globalworkgrpsz**2 .gt. nseeds) call FatalError(&#39;EMMCOpenCL:&#39;,&#39;insufficient prime numbers&#39;)</span>
<a name="ln-1081"></a>
<a name="ln-1082"></a><span class="k">allocate</span><span class="p">(</span><span class="n">init_seeds</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="n">globalworkgrpsz</span><span class="o">*</span><span class="n">globalworkgrpsz</span><span class="p">),</span><span class="nb">stat</span><span class="o">=</span><span class="n">istat</span><span class="p">)</span>
<a name="ln-1083"></a><span class="n">init_seeds</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-1084"></a><span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="n">globalworkgrpsz</span>
<a name="ln-1085"></a>    <span class="k">do </span><span class="n">j</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="n">globalworkgrpsz</span>
<a name="ln-1086"></a>        <span class="k">do </span><span class="n">k</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="mi">4</span>
<a name="ln-1087"></a>            <span class="n">init_seeds</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="p">((</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">globalworkgrpsz</span><span class="o">+</span><span class="p">(</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">+</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">rnseeds</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="p">((</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">globalworkgrpsz</span><span class="o">+</span><span class="n">j</span><span class="p">)</span><span class="o">+</span><span class="n">k</span><span class="p">)</span>
<a name="ln-1088"></a>        <span class="k">end do</span>
<a name="ln-1089"></a><span class="k">    end do</span>
<a name="ln-1090"></a><span class="k">end do</span>
<a name="ln-1091"></a>
<a name="ln-1092"></a><span class="c">! create device memory buffers</span>
<a name="ln-1093"></a><span class="n">LamX</span> <span class="o">=</span> <span class="n">clCreateBuffer</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">CL_MEM_WRITE_ONLY</span><span class="p">,</span> <span class="n">size_in_bytes</span><span class="p">,</span> <span class="nb">C_NULL_PTR</span><span class="p">,</span> <span class="n">ierr</span><span class="p">)</span>
<a name="ln-1094"></a><span class="c">! if(ierr /= CL_SUCCESS) call FatalError(&#39;clCreateBuffer: &#39;,&#39;cannot allocate device memory for LamX.&#39;)</span>
<a name="ln-1095"></a>
<a name="ln-1096"></a><span class="n">LamY</span> <span class="o">=</span> <span class="n">clCreateBuffer</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">CL_MEM_WRITE_ONLY</span><span class="p">,</span> <span class="n">size_in_bytes</span><span class="p">,</span> <span class="nb">C_NULL_PTR</span><span class="p">,</span> <span class="n">ierr</span><span class="p">)</span>
<a name="ln-1097"></a><span class="c">! if(ierr /= CL_SUCCESS) call FatalError(&#39;clCreateBuffer: &#39;,&#39;cannot allocate device memory for LamY.&#39;)</span>
<a name="ln-1098"></a>
<a name="ln-1099"></a><span class="n">depth</span> <span class="o">=</span> <span class="n">clCreateBuffer</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">CL_MEM_WRITE_ONLY</span><span class="p">,</span> <span class="n">size_in_bytes</span><span class="p">,</span> <span class="nb">C_NULL_PTR</span><span class="p">,</span> <span class="n">ierr</span><span class="p">)</span>
<a name="ln-1100"></a><span class="c">!   if(ierr /= CL_SUCCESS) call FatalError(&#39;clCreateBuffer: &#39;,&#39;cannot allocate device memory for depth.&#39;)</span>
<a name="ln-1101"></a>
<a name="ln-1102"></a><span class="n">energy</span> <span class="o">=</span> <span class="n">clCreateBuffer</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">CL_MEM_WRITE_ONLY</span><span class="p">,</span> <span class="n">size_in_bytes</span><span class="p">,</span> <span class="nb">C_NULL_PTR</span><span class="p">,</span> <span class="n">ierr</span><span class="p">)</span>
<a name="ln-1103"></a><span class="c">!   if(ierr /= CL_SUCCESS) call FatalError(&#39;clCreateBuffer: &#39;,&#39;cannot allocate device memory for energy.&#39;)</span>
<a name="ln-1104"></a>
<a name="ln-1105"></a><span class="n">seeds</span> <span class="o">=</span> <span class="n">clCreateBuffer</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">CL_MEM_READ_WRITE</span><span class="p">,</span> <span class="n">size_in_bytes</span><span class="p">,</span> <span class="nb">C_NULL_PTR</span><span class="p">,</span> <span class="n">ierr</span><span class="p">)</span>
<a name="ln-1106"></a><span class="c">! if(ierr /= CL_SUCCESS) call FatalError(&#39;clCreateBuffer: &#39;,&#39;cannot allocate device memory for seeds.&#39;)</span>
<a name="ln-1107"></a>
<a name="ln-1108"></a><span class="n">ierr</span> <span class="o">=</span> <span class="n">clEnqueueWriteBuffer</span><span class="p">(</span><span class="n">command_queue</span><span class="p">,</span> <span class="n">seeds</span><span class="p">,</span> <span class="n">CL_TRUE</span><span class="p">,</span> <span class="mi">0</span><span class="err">_</span><span class="mi">8</span><span class="p">,</span> <span class="n">size_in_bytes_seeds</span><span class="p">,</span> <span class="nb">C_LOC</span><span class="p">(</span><span class="n">init_seeds</span><span class="p">(</span><span class="mi">1</span><span class="p">)),</span> <span class="p">&amp;</span>
<a name="ln-1109"></a>                            <span class="mi">0</span><span class="p">,</span> <span class="nb">C_NULL_PTR</span><span class="p">,</span> <span class="nb">C_NULL_PTR</span><span class="p">)</span>
<a name="ln-1110"></a><span class="c">! if(ierr /= CL_SUCCESS) call FatalError(&#39;clEnqueueWriteBuffer: &#39;,&#39;cannot Enqueue write buffer.&#39;)</span>
<a name="ln-1111"></a>
<a name="ln-1112"></a><span class="c">! set the callback parameters</span>
<a name="ln-1113"></a><span class="n">dn</span> <span class="o">=</span> <span class="mi">1</span>
<a name="ln-1114"></a><span class="n">cn</span> <span class="o">=</span> <span class="n">dn</span>
<a name="ln-1115"></a><span class="n">totn</span> <span class="o">=</span> <span class="n">numangle</span> <span class="o">*</span> <span class="p">(</span><span class="n">totnum_el</span><span class="o">/</span><span class="n">num_max</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-1116"></a>
<a name="ln-1117"></a><span class="k">call </span><span class="n">Time_tick</span><span class="p">(</span><span class="n">tstart</span><span class="p">)</span>
<a name="ln-1118"></a>
<a name="ln-1119"></a><span class="c">! loop over angles (used for BSE1, single run for full)</span>
<a name="ln-1120"></a><span class="n">angleloop</span><span class="p">:</span> <span class="k">do </span><span class="n">iang</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="n">numangle</span>
<a name="ln-1121"></a>
<a name="ln-1122"></a>  <span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="p">.</span><span class="n">eq</span><span class="p">.</span> <span class="s1">&#39;bse1&#39;</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1123"></a><span class="k">    </span><span class="n">sig</span> <span class="o">=</span> <span class="p">(</span><span class="n">fpar</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">iang</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">fpar</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span><span class="o">*</span><span class="n">dtoR</span>
<a name="ln-1124"></a>  <span class="k">else </span>
<a name="ln-1125"></a><span class="k">    </span><span class="n">sig</span> <span class="o">=</span> <span class="n">fpar</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">dtoR</span>
<a name="ln-1126"></a>  <span class="k">end if</span>
<a name="ln-1127"></a>
<a name="ln-1128"></a><span class="k">  </span><span class="n">mainloop</span><span class="p">:</span> <span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,(</span><span class="n">totnum_el</span><span class="o">/</span><span class="n">num_max</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-1129"></a>
<a name="ln-1130"></a><span class="c">! set the kernel arguments</span>
<a name="ln-1131"></a>    <span class="n">ierr</span> <span class="o">=</span> <span class="n">clSetKernelArg</span><span class="p">(</span><span class="n">kernel</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">sizeof</span><span class="p">(</span><span class="n">LamX</span><span class="p">),</span> <span class="nb">C_LOC</span><span class="p">(</span><span class="n">LamX</span><span class="p">))</span>
<a name="ln-1132"></a>    <span class="c">!   if(ierr /= CL_SUCCESS) stop &#39;Error: cannot set kernel argument.&#39;</span>
<a name="ln-1133"></a>
<a name="ln-1134"></a>    <span class="n">ierr</span> <span class="o">=</span> <span class="n">clSetKernelArg</span><span class="p">(</span><span class="n">kernel</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">sizeof</span><span class="p">(</span><span class="n">LamY</span><span class="p">),</span> <span class="nb">C_LOC</span><span class="p">(</span><span class="n">LamY</span><span class="p">))</span>
<a name="ln-1135"></a>    <span class="c">!   if(ierr /= CL_SUCCESS) stop &#39;Error: cannot set kernel argument.&#39;</span>
<a name="ln-1136"></a>
<a name="ln-1137"></a>    <span class="n">ierr</span> <span class="o">=</span> <span class="n">clSetKernelArg</span><span class="p">(</span><span class="n">kernel</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">sizeof</span><span class="p">(</span><span class="n">EkeV</span><span class="p">),</span> <span class="nb">C_LOC</span><span class="p">(</span><span class="n">EkeV</span><span class="p">))</span>
<a name="ln-1138"></a>    <span class="c">!   if(ierr /= CL_SUCCESS) stop &#39;Error: cannot set kernel argument.&#39;</span>
<a name="ln-1139"></a>
<a name="ln-1140"></a>    <span class="n">ierr</span> <span class="o">=</span> <span class="n">clSetKernelArg</span><span class="p">(</span><span class="n">kernel</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">sizeof</span><span class="p">(</span><span class="n">globalworkgrpsz</span><span class="p">),</span> <span class="nb">C_LOC</span><span class="p">(</span><span class="n">globalworkgrpsz</span><span class="p">))</span>
<a name="ln-1141"></a>    <span class="c">!   if(ierr /= CL_SUCCESS) stop &#39;Error: cannot set kernel argument.&#39;</span>
<a name="ln-1142"></a>
<a name="ln-1143"></a>    <span class="n">ierr</span> <span class="o">=</span> <span class="n">clSetKernelArg</span><span class="p">(</span><span class="n">kernel</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">sizeof</span><span class="p">(</span><span class="n">Ze</span><span class="p">),</span> <span class="nb">C_LOC</span><span class="p">(</span><span class="n">Ze</span><span class="p">))</span>
<a name="ln-1144"></a>    <span class="c">!   if(ierr /= CL_SUCCESS) stop &#39;Error: cannot set kernel argument.&#39;</span>
<a name="ln-1145"></a>
<a name="ln-1146"></a>    <span class="n">ierr</span> <span class="o">=</span> <span class="n">clSetKernelArg</span><span class="p">(</span><span class="n">kernel</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">sizeof</span><span class="p">(</span><span class="n">density</span><span class="p">),</span> <span class="nb">C_LOC</span><span class="p">(</span><span class="n">density</span><span class="p">))</span>
<a name="ln-1147"></a>    <span class="c">!   if(ierr /= CL_SUCCESS) stop &#39;Error: cannot set kernel argument.&#39;</span>
<a name="ln-1148"></a>
<a name="ln-1149"></a>    <span class="n">ierr</span> <span class="o">=</span> <span class="n">clSetKernelArg</span><span class="p">(</span><span class="n">kernel</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="n">sizeof</span><span class="p">(</span><span class="n">at_wt</span><span class="p">),</span> <span class="nb">C_LOC</span><span class="p">(</span><span class="n">at_wt</span><span class="p">))</span>
<a name="ln-1150"></a>    <span class="c">!   if(ierr /= CL_SUCCESS) stop &#39;Error: cannot set kernel argument.&#39;</span>
<a name="ln-1151"></a>
<a name="ln-1152"></a>    <span class="n">ierr</span> <span class="o">=</span> <span class="n">clSetKernelArg</span><span class="p">(</span><span class="n">kernel</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="n">sizeof</span><span class="p">(</span><span class="n">num_el</span><span class="p">),</span> <span class="nb">C_LOC</span><span class="p">(</span><span class="n">num_el</span><span class="p">))</span>
<a name="ln-1153"></a>    <span class="c">!   if(ierr /= CL_SUCCESS) stop &#39;Error: cannot set kernel argument.&#39;</span>
<a name="ln-1154"></a>
<a name="ln-1155"></a>    <span class="n">ierr</span> <span class="o">=</span> <span class="n">clSetKernelArg</span><span class="p">(</span><span class="n">kernel</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="n">sizeof</span><span class="p">(</span><span class="n">seeds</span><span class="p">),</span> <span class="nb">C_LOC</span><span class="p">(</span><span class="n">seeds</span><span class="p">))</span>
<a name="ln-1156"></a>    <span class="c">!   if(ierr /= CL_SUCCESS) stop &#39;Error: cannot set kernel argument.&#39;</span>
<a name="ln-1157"></a>
<a name="ln-1158"></a>    <span class="n">ierr</span> <span class="o">=</span> <span class="n">clSetKernelArg</span><span class="p">(</span><span class="n">kernel</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="n">sizeof</span><span class="p">(</span><span class="n">sig</span><span class="p">),</span> <span class="nb">C_LOC</span><span class="p">(</span><span class="n">sig</span><span class="p">))</span>
<a name="ln-1159"></a>    <span class="c">!   if(ierr /= CL_SUCCESS) stop &#39;Error: cannot set kernel argument.&#39;</span>
<a name="ln-1160"></a>
<a name="ln-1161"></a>    <span class="n">ierr</span> <span class="o">=</span> <span class="n">clSetKernelArg</span><span class="p">(</span><span class="n">kernel</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">sizeof</span><span class="p">(</span><span class="n">omega</span><span class="p">),</span> <span class="nb">C_LOC</span><span class="p">(</span><span class="n">omega</span><span class="p">))</span>
<a name="ln-1162"></a>    <span class="c">!   if(ierr /= CL_SUCCESS) stop &#39;Error: cannot set kernel argument.&#39;</span>
<a name="ln-1163"></a>
<a name="ln-1164"></a>    <span class="n">ierr</span> <span class="o">=</span> <span class="n">clSetKernelArg</span><span class="p">(</span><span class="n">kernel</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="n">sizeof</span><span class="p">(</span><span class="n">depth</span><span class="p">),</span> <span class="nb">C_LOC</span><span class="p">(</span><span class="n">depth</span><span class="p">))</span>
<a name="ln-1165"></a>    <span class="c">!   if(ierr /= CL_SUCCESS) stop &#39;Error: cannot set kernel argument.&#39;</span>
<a name="ln-1166"></a>
<a name="ln-1167"></a>    <span class="n">ierr</span> <span class="o">=</span> <span class="n">clSetKernelArg</span><span class="p">(</span><span class="n">kernel</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="n">sizeof</span><span class="p">(</span><span class="n">energy</span><span class="p">),</span> <span class="nb">C_LOC</span><span class="p">(</span><span class="n">energy</span><span class="p">))</span>
<a name="ln-1168"></a>    <span class="c">!   if(ierr /= CL_SUCCESS) stop &#39;Error: cannot set kernel argument.&#39;</span>
<a name="ln-1169"></a>
<a name="ln-1170"></a>    <span class="n">ierr</span> <span class="o">=</span> <span class="n">clSetKernelArg</span><span class="p">(</span><span class="n">kernel</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="n">sizeof</span><span class="p">(</span><span class="n">steps</span><span class="p">),</span> <span class="nb">C_LOC</span><span class="p">(</span><span class="n">steps</span><span class="p">))</span>
<a name="ln-1171"></a>    <span class="c">!   if(ierr /= CL_SUCCESS) stop &#39;Error: cannot set kernel argument.&#39;</span>
<a name="ln-1172"></a>
<a name="ln-1173"></a><span class="c">! execute the kernel</span>
<a name="ln-1174"></a><span class="c">!   ierr = clEnqueueNDRangeKernel(command_queue, kernel, 2, C_NULL_PTR, C_LOC(globalsize), C_LOC(localsize), &amp;</span>
<a name="ln-1175"></a><span class="c">!                                 0, C_NULL_PTR, C_NULL_PTR)</span>
<a name="ln-1176"></a>    <span class="n">ierr</span> <span class="o">=</span> <span class="n">clEnqueueNDRangeKernel</span><span class="p">(</span><span class="n">command_queue</span><span class="p">,</span> <span class="n">kernel</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="nb">C_NULL_PTR</span><span class="p">,</span> <span class="nb">C_LOC</span><span class="p">(</span><span class="n">globalsize</span><span class="p">),</span> <span class="nb">C_NULL_PTR</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-1177"></a>                                  <span class="mi">0</span><span class="p">,</span> <span class="nb">C_NULL_PTR</span><span class="p">,</span> <span class="nb">C_NULL_PTR</span><span class="p">)</span>
<a name="ln-1178"></a><span class="c">! wait for the commands to finish</span>
<a name="ln-1179"></a>    <span class="n">ierr</span> <span class="o">=</span> <span class="n">clFinish</span><span class="p">(</span><span class="n">command_queue</span><span class="p">)</span>
<a name="ln-1180"></a>
<a name="ln-1181"></a><span class="c">! read the resulting vector from device memory</span>
<a name="ln-1182"></a>    <span class="n">ierr</span> <span class="o">=</span> <span class="n">clEnqueueReadBuffer</span><span class="p">(</span><span class="n">command_queue</span><span class="p">,</span><span class="n">LamX</span><span class="p">,</span><span class="n">CL_TRUE</span><span class="p">,</span><span class="mi">0</span><span class="err">_</span><span class="mi">8</span><span class="p">,</span><span class="n">size_in_bytes</span><span class="p">,</span><span class="nb">C_LOC</span><span class="p">(</span><span class="n">Lamresx</span><span class="p">(</span><span class="mi">1</span><span class="p">)),</span><span class="mi">0</span><span class="p">,</span><span class="nb">C_NULL_PTR</span><span class="p">,</span><span class="nb">C_NULL_PTR</span><span class="p">)</span>
<a name="ln-1183"></a>    <span class="n">ierr</span> <span class="o">=</span> <span class="n">clEnqueueReadBuffer</span><span class="p">(</span><span class="n">command_queue</span><span class="p">,</span><span class="n">LamY</span><span class="p">,</span><span class="n">CL_TRUE</span><span class="p">,</span><span class="mi">0</span><span class="err">_</span><span class="mi">8</span><span class="p">,</span><span class="n">size_in_bytes</span><span class="p">,</span><span class="nb">C_LOC</span><span class="p">(</span><span class="n">Lamresy</span><span class="p">(</span><span class="mi">1</span><span class="p">)),</span><span class="mi">0</span><span class="p">,</span><span class="nb">C_NULL_PTR</span><span class="p">,</span><span class="nb">C_NULL_PTR</span><span class="p">)</span>
<a name="ln-1184"></a>    <span class="n">ierr</span> <span class="o">=</span> <span class="n">clEnqueueReadBuffer</span><span class="p">(</span><span class="n">command_queue</span><span class="p">,</span><span class="n">depth</span><span class="p">,</span><span class="n">CL_TRUE</span><span class="p">,</span><span class="mi">0</span><span class="err">_</span><span class="mi">8</span><span class="p">,</span><span class="n">size_in_bytes</span><span class="p">,</span><span class="nb">C_LOC</span><span class="p">(</span><span class="n">depthres</span><span class="p">(</span><span class="mi">1</span><span class="p">)),</span><span class="mi">0</span><span class="p">,</span><span class="nb">C_NULL_PTR</span><span class="p">,</span><span class="nb">C_NULL_PTR</span><span class="p">)</span>
<a name="ln-1185"></a>    <span class="n">ierr</span> <span class="o">=</span> <span class="n">clEnqueueReadBuffer</span><span class="p">(</span><span class="n">command_queue</span><span class="p">,</span><span class="n">energy</span><span class="p">,</span><span class="n">CL_TRUE</span><span class="p">,</span><span class="mi">0</span><span class="err">_</span><span class="mi">8</span><span class="p">,</span><span class="n">size_in_bytes</span><span class="p">,</span><span class="nb">C_LOC</span><span class="p">(</span><span class="n">energyres</span><span class="p">(</span><span class="mi">1</span><span class="p">)),</span><span class="mi">0</span><span class="p">,</span><span class="nb">C_NULL_PTR</span><span class="p">,</span><span class="nb">C_NULL_PTR</span><span class="p">)</span>
<a name="ln-1186"></a>
<a name="ln-1187"></a>
<a name="ln-1188"></a>
<a name="ln-1189"></a>    <span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="p">.</span><span class="n">eq</span><span class="p">.</span> <span class="s1">&#39;full&#39;</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1190"></a><span class="k">      </span><span class="n">subloopfull</span><span class="p">:</span> <span class="k">do </span><span class="n">j</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">num_max</span>
<a name="ln-1191"></a>        <span class="k">if</span> <span class="p">((</span><span class="n">Lamresx</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="p">.</span><span class="n">ne</span><span class="p">.</span> <span class="o">-</span><span class="mi">1</span><span class="mf">0.0</span><span class="p">)</span> <span class="p">.</span><span class="nb">and</span><span class="p">.</span> <span class="p">(</span><span class="n">Lamresy</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="p">.</span><span class="n">ne</span><span class="p">.</span> <span class="o">-</span><span class="mi">1</span><span class="mf">0.0</span><span class="p">)</span> <span class="p">&amp;</span>
<a name="ln-1192"></a>          <span class="p">.</span><span class="nb">and</span><span class="p">.</span> <span class="p">(</span><span class="n">depthres</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="p">.</span><span class="n">ne</span><span class="p">.</span> <span class="mi">1</span><span class="mf">0.0</span><span class="p">)</span> <span class="p">.</span><span class="nb">and</span><span class="p">.</span> <span class="p">(</span><span class="n">energyres</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="p">.</span><span class="n">ne</span><span class="p">.</span> <span class="mf">0.0</span><span class="p">)</span> <span class="p">&amp;</span>
<a name="ln-1193"></a>          <span class="p">.</span><span class="nb">and</span><span class="p">.</span> <span class="p">.</span><span class="nb">not</span><span class="p">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">Lamresx</span><span class="p">(</span><span class="n">j</span><span class="p">))</span> <span class="p">.</span><span class="nb">and</span><span class="p">.</span> <span class="p">.</span><span class="nb">not</span><span class="p">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">Lamresy</span><span class="p">(</span><span class="n">j</span><span class="p">)))</span> <span class="k">then</span>
<a name="ln-1194"></a><span class="c">! and get the nearest pixel [ take into account reversal of coordinate frame (x,y) -&gt; (y,-x) ]</span>
<a name="ln-1195"></a>             <span class="k">if</span> <span class="p">((</span><span class="nb">nint</span><span class="p">(</span><span class="n">delta</span><span class="o">*</span><span class="n">Lamresy</span><span class="p">(</span><span class="n">j</span><span class="p">))</span> <span class="p">.</span><span class="n">eq</span><span class="p">.</span> <span class="mf">0.0</span><span class="p">)</span> <span class="p">.</span><span class="nb">and</span><span class="p">.</span> <span class="p">(</span><span class="nb">nint</span><span class="p">(</span><span class="o">-</span><span class="n">delta</span><span class="o">*</span><span class="n">Lamresx</span><span class="p">(</span><span class="n">j</span><span class="p">))</span> <span class="p">.</span><span class="n">eq</span><span class="p">.</span> <span class="mf">0.0</span><span class="p">))</span> <span class="k">then</span>
<a name="ln-1196"></a><span class="k">               </span><span class="n">val1</span> <span class="o">=</span> <span class="n">val1</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-1197"></a>             <span class="k">end if</span>
<a name="ln-1198"></a>
<a name="ln-1199"></a><span class="k">             </span><span class="n">val</span> <span class="o">=</span> <span class="n">val</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-1200"></a>             <span class="n">idxy</span> <span class="o">=</span> <span class="p">(</span><span class="o">/</span> <span class="nb">nint</span><span class="p">(</span><span class="n">delta</span><span class="o">*</span><span class="n">Lamresy</span><span class="p">(</span><span class="n">j</span><span class="p">)),</span> <span class="nb">nint</span><span class="p">(</span><span class="o">-</span><span class="n">delta</span><span class="o">*</span><span class="n">Lamresx</span><span class="p">(</span><span class="n">j</span><span class="p">))</span> <span class="o">/</span><span class="p">)</span>
<a name="ln-1201"></a>
<a name="ln-1202"></a>             <span class="k">if</span> <span class="p">(</span><span class="nb">maxval</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">idxy</span><span class="p">)).</span><span class="n">le</span><span class="p">.</span><span class="n">nx</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1203"></a><span class="c">! If Ec larger than Emin, then we should count this electron</span>
<a name="ln-1204"></a>               <span class="k">if</span> <span class="p">(</span><span class="n">energyres</span><span class="p">(</span><span class="n">j</span><span class="p">).</span><span class="n">gt</span><span class="p">.</span><span class="n">fpar</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span> <span class="k">then</span>
<a name="ln-1205"></a>
<a name="ln-1206"></a><span class="k">                 </span><span class="n">iE</span> <span class="o">=</span> <span class="nb">nint</span><span class="p">((</span><span class="n">energyres</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">-</span><span class="n">fpar</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span><span class="o">/</span><span class="n">fpar</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span><span class="o">+</span><span class="mi">1</span>
<a name="ln-1207"></a><span class="c">! first add this electron to the correct exit distance vs. energy bin (coarser than the angular plot)</span>
<a name="ln-1208"></a>                 <span class="n">edis</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">depthres</span><span class="p">(</span><span class="n">j</span><span class="p">))</span>  <span class="c">! distance from last scattering point to surface along trajectory</span>
<a name="ln-1209"></a>                 <span class="n">iz</span> <span class="o">=</span> <span class="nb">nint</span><span class="p">(</span><span class="n">edis</span><span class="o">/</span><span class="n">fpar</span><span class="p">(</span><span class="mi">7</span><span class="p">))</span> <span class="o">+</span><span class="mi">1</span>
<a name="ln-1210"></a>                 <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">iz</span><span class="p">.</span><span class="n">gt</span><span class="p">.</span><span class="mi">0</span><span class="p">).</span><span class="nb">and</span><span class="p">.(</span><span class="n">iz</span><span class="p">.</span><span class="n">le</span><span class="p">.</span><span class="n">ipar</span><span class="p">(</span><span class="mi">13</span><span class="p">))</span> <span class="p">)</span> <span class="k">then</span>
<a name="ln-1211"></a>
<a name="ln-1212"></a><span class="k">                   </span><span class="n">px</span> <span class="o">=</span> <span class="nb">nint</span><span class="p">(</span><span class="n">idxy</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">1</span><span class="mf">0.0</span><span class="p">)</span>
<a name="ln-1213"></a>                   <span class="n">py</span> <span class="o">=</span> <span class="nb">nint</span><span class="p">(</span><span class="n">idxy</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="mi">1</span><span class="mf">0.0</span><span class="p">)</span>
<a name="ln-1214"></a>                   <span class="n">accum_z</span><span class="p">(</span><span class="n">iE</span><span class="p">,</span><span class="n">iz</span><span class="p">,</span><span class="n">px</span><span class="p">,</span><span class="n">py</span><span class="p">)</span> <span class="o">=</span> <span class="n">accum_z</span><span class="p">(</span><span class="n">iE</span><span class="p">,</span><span class="n">iz</span><span class="p">,</span><span class="n">px</span><span class="p">,</span><span class="n">py</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-1215"></a>
<a name="ln-1216"></a>                 <span class="k">end if</span>
<a name="ln-1217"></a><span class="c">! then add it to the modified Lambert accumulator array.</span>
<a name="ln-1218"></a>                 <span class="n">accum_e</span><span class="p">(</span><span class="n">iE</span><span class="p">,</span><span class="n">idxy</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="n">idxy</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span> <span class="o">=</span> <span class="n">accum_e</span><span class="p">(</span><span class="n">iE</span><span class="p">,</span><span class="n">idxy</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="n">idxy</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-1219"></a>               <span class="k">end if</span>
<a name="ln-1220"></a><span class="k">             end if</span>
<a name="ln-1221"></a><span class="k">        end if</span>
<a name="ln-1222"></a><span class="k">      end do </span><span class="n">subloopfull</span>
<a name="ln-1223"></a>    <span class="k">end if</span>
<a name="ln-1224"></a>
<a name="ln-1225"></a><span class="k">    if</span> <span class="p">(</span><span class="n">mode</span> <span class="p">.</span><span class="n">eq</span><span class="p">.</span> <span class="s1">&#39;bse1&#39;</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1226"></a><span class="k">      </span><span class="n">subloopbse1</span><span class="p">:</span> <span class="k">do </span><span class="n">j</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">num_max</span>
<a name="ln-1227"></a>
<a name="ln-1228"></a>        <span class="k">if</span> <span class="p">((</span><span class="n">Lamresx</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="p">.</span><span class="n">ne</span><span class="p">.</span> <span class="o">-</span><span class="mi">1</span><span class="mf">0.0</span><span class="p">)</span> <span class="p">.</span><span class="nb">and</span><span class="p">.</span> <span class="p">(</span><span class="n">Lamresy</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="p">.</span><span class="n">ne</span><span class="p">.</span> <span class="o">-</span><span class="mi">1</span><span class="mf">0.0</span><span class="p">)</span> <span class="p">&amp;</span>
<a name="ln-1229"></a>          <span class="p">.</span><span class="nb">and</span><span class="p">.</span> <span class="p">(</span><span class="n">depthres</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="p">.</span><span class="n">ne</span><span class="p">.</span> <span class="mi">1</span><span class="mf">0.0</span><span class="p">)</span> <span class="p">.</span><span class="nb">and</span><span class="p">.</span> <span class="p">(</span><span class="n">energyres</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="p">.</span><span class="n">ne</span><span class="p">.</span> <span class="mf">0.0</span><span class="p">)</span> <span class="p">&amp;</span>
<a name="ln-1230"></a>          <span class="p">.</span><span class="nb">and</span><span class="p">.</span> <span class="p">.</span><span class="nb">not</span><span class="p">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">Lamresx</span><span class="p">(</span><span class="n">j</span><span class="p">))</span> <span class="p">.</span><span class="nb">and</span><span class="p">.</span> <span class="p">.</span><span class="nb">not</span><span class="p">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">Lamresy</span><span class="p">(</span><span class="n">j</span><span class="p">)))</span> <span class="k">then</span>
<a name="ln-1231"></a><span class="c">! and get the nearest pixel [ take into account reversal of coordinate frame (x,y) -&gt; (y,-x) ]</span>
<a name="ln-1232"></a>          <span class="k">if</span> <span class="p">((</span><span class="nb">nint</span><span class="p">(</span><span class="n">delta</span><span class="o">*</span><span class="n">Lamresy</span><span class="p">(</span><span class="n">j</span><span class="p">))</span> <span class="p">.</span><span class="n">eq</span><span class="p">.</span> <span class="mf">0.0</span><span class="p">)</span> <span class="p">.</span><span class="nb">and</span><span class="p">.</span> <span class="p">(</span><span class="nb">nint</span><span class="p">(</span><span class="o">-</span><span class="n">delta</span><span class="o">*</span><span class="n">Lamresx</span><span class="p">(</span><span class="n">j</span><span class="p">))</span> <span class="p">.</span><span class="n">eq</span><span class="p">.</span> <span class="mf">0.0</span><span class="p">))</span> <span class="k">then</span>
<a name="ln-1233"></a><span class="k">            </span><span class="n">val1</span> <span class="o">=</span> <span class="n">val1</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-1234"></a>          <span class="k">end if</span>
<a name="ln-1235"></a>
<a name="ln-1236"></a><span class="k">          </span><span class="n">val</span> <span class="o">=</span> <span class="n">val</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-1237"></a>          <span class="n">idxy</span> <span class="o">=</span> <span class="p">(</span><span class="o">/</span> <span class="nb">nint</span><span class="p">(</span><span class="n">delta</span><span class="o">*</span><span class="n">Lamresy</span><span class="p">(</span><span class="n">j</span><span class="p">)),</span> <span class="nb">nint</span><span class="p">(</span><span class="o">-</span><span class="n">delta</span><span class="o">*</span><span class="n">Lamresx</span><span class="p">(</span><span class="n">j</span><span class="p">))</span> <span class="o">/</span><span class="p">)</span>
<a name="ln-1238"></a>
<a name="ln-1239"></a>          <span class="k">if</span> <span class="p">(</span><span class="nb">maxval</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">idxy</span><span class="p">)).</span><span class="n">le</span><span class="p">.</span><span class="n">nx</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1240"></a><span class="c">! first add this electron to the correct exit distance vs. sigma (coarser than the angular plot)</span>
<a name="ln-1241"></a>            <span class="n">edis</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">depthres</span><span class="p">(</span><span class="n">j</span><span class="p">))</span>  <span class="c">! distance from last scattering point to surface along trajectory</span>
<a name="ln-1242"></a>            <span class="n">iz</span> <span class="o">=</span> <span class="nb">nint</span><span class="p">(</span><span class="n">edis</span><span class="o">/</span><span class="n">fpar</span><span class="p">(</span><span class="mi">7</span><span class="p">))</span> <span class="o">+</span><span class="mi">1</span>
<a name="ln-1243"></a>            <span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">iz</span><span class="p">.</span><span class="n">gt</span><span class="p">.</span><span class="mi">0</span><span class="p">).</span><span class="nb">and</span><span class="p">.(</span><span class="n">iz</span><span class="p">.</span><span class="n">le</span><span class="p">.</span><span class="n">ipar</span><span class="p">(</span><span class="mi">13</span><span class="p">))</span> <span class="p">)</span> <span class="k">then</span>
<a name="ln-1244"></a><span class="k">              </span><span class="n">px</span> <span class="o">=</span> <span class="nb">nint</span><span class="p">(</span><span class="n">idxy</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">1</span><span class="mf">0.0</span><span class="p">)</span>
<a name="ln-1245"></a>              <span class="n">py</span> <span class="o">=</span> <span class="nb">nint</span><span class="p">(</span><span class="n">idxy</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="mi">1</span><span class="mf">0.0</span><span class="p">)</span>
<a name="ln-1246"></a>              <span class="n">accum_z</span><span class="p">(</span><span class="n">iang</span><span class="p">,</span><span class="n">iz</span><span class="p">,</span><span class="n">px</span><span class="p">,</span><span class="n">py</span><span class="p">)</span> <span class="o">=</span> <span class="n">accum_z</span><span class="p">(</span><span class="n">iang</span><span class="p">,</span><span class="n">iz</span><span class="p">,</span><span class="n">px</span><span class="p">,</span><span class="n">py</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-1247"></a>
<a name="ln-1248"></a>            <span class="k">end if</span>
<a name="ln-1249"></a><span class="c">! then add it to the modified Lambert accumulator array.</span>
<a name="ln-1250"></a>            <span class="n">accum_e</span><span class="p">(</span><span class="n">iang</span><span class="p">,</span><span class="n">idxy</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="n">idxy</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span> <span class="o">=</span> <span class="n">accum_e</span><span class="p">(</span><span class="n">iang</span><span class="p">,</span><span class="n">idxy</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="n">idxy</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-1251"></a>          <span class="k">end if</span>
<a name="ln-1252"></a><span class="k">        end if</span>
<a name="ln-1253"></a><span class="k">      end do </span><span class="n">subloopbse1</span>
<a name="ln-1254"></a>    <span class="k">end if</span>
<a name="ln-1255"></a>
<a name="ln-1256"></a><span class="c">! has the cancel flag been set by the calling program ?</span>
<a name="ln-1257"></a>  <span class="k">if</span><span class="p">(</span><span class="n">cancel</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="nb">char</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span> <span class="k">EXIT </span><span class="n">angleloop</span>
<a name="ln-1258"></a>
<a name="ln-1259"></a><span class="c">! update the progress counter and report it to the calling program via the proc callback routine</span>
<a name="ln-1260"></a>  <span class="k">if</span><span class="p">(</span><span class="n">objAddress</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1261"></a><span class="k">    </span><span class="n">cn</span> <span class="o">=</span> <span class="n">cn</span><span class="o">+</span><span class="n">dn</span>
<a name="ln-1262"></a>    <span class="n">bseyield</span> <span class="o">=</span> <span class="mi">10</span><span class="mf">0.0</span><span class="o">*</span><span class="nb">float</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">accum_e</span><span class="p">))</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="o">*</span><span class="n">num_max</span><span class="p">)</span>
<a name="ln-1263"></a>    <span class="k">write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="n">cn</span><span class="p">,</span> <span class="n">totn</span><span class="p">,</span> <span class="n">bseyield</span>
<a name="ln-1264"></a>    <span class="k">call </span><span class="n">proc</span><span class="p">(</span><span class="n">objAddress</span><span class="p">,</span> <span class="n">cn</span><span class="p">,</span> <span class="n">totn</span><span class="p">,</span> <span class="n">bseyield</span><span class="p">)</span>
<a name="ln-1265"></a>  <span class="k">end if</span>
<a name="ln-1266"></a>
<a name="ln-1267"></a><span class="k">  end do </span><span class="n">mainloop</span>
<a name="ln-1268"></a><span class="k">end do </span><span class="n">angleloop</span> 
<a name="ln-1269"></a>
<a name="ln-1270"></a><span class="k">write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="s1">&#39;Total GPU time [s] = &#39;</span><span class="p">,</span><span class="n">Time_tock</span><span class="p">(</span><span class="n">tstart</span><span class="p">)</span>
<a name="ln-1271"></a>
<a name="ln-1272"></a><span class="c">!=====================</span>
<a name="ln-1273"></a><span class="c">! RELEASE EVERYTHING</span>
<a name="ln-1274"></a><span class="c">!=====================</span>
<a name="ln-1275"></a>
<a name="ln-1276"></a><span class="n">ierr</span> <span class="o">=</span> <span class="n">clReleaseKernel</span><span class="p">(</span><span class="n">kernel</span><span class="p">)</span>
<a name="ln-1277"></a><span class="n">ierr</span> <span class="o">=</span> <span class="n">clReleaseCommandQueue</span><span class="p">(</span><span class="n">command_queue</span><span class="p">)</span>
<a name="ln-1278"></a><span class="n">ierr</span> <span class="o">=</span> <span class="n">clReleaseContext</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
<a name="ln-1279"></a><span class="n">ierr</span> <span class="o">=</span> <span class="n">clReleaseMemObject</span><span class="p">(</span><span class="n">LamX</span><span class="p">)</span>
<a name="ln-1280"></a><span class="n">ierr</span> <span class="o">=</span> <span class="n">clReleaseMemObject</span><span class="p">(</span><span class="n">LamY</span><span class="p">)</span>
<a name="ln-1281"></a><span class="n">ierr</span> <span class="o">=</span> <span class="n">clReleaseMemObject</span><span class="p">(</span><span class="n">depth</span><span class="p">)</span>
<a name="ln-1282"></a><span class="n">ierr</span> <span class="o">=</span> <span class="n">clReleaseMemObject</span><span class="p">(</span><span class="n">energy</span><span class="p">)</span>
<a name="ln-1283"></a><span class="n">ierr</span> <span class="o">=</span> <span class="n">clReleaseMemObject</span><span class="p">(</span><span class="n">seeds</span><span class="p">)</span>
<a name="ln-1284"></a>
<a name="ln-1285"></a>
<a name="ln-1286"></a><span class="k">end subroutine </span><span class="n">EMsoftCgetMCOpenCL</span>
<a name="ln-1287"></a>
<a name="ln-1288"></a>
<a name="ln-1289"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-1290"></a><span class="c">!</span>
<a name="ln-1291"></a><span class="c">! SUBROUTINE:EMsoftCgetEBSDmaster</span>
<a name="ln-1292"></a><span class="c">!</span>
<a name="ln-1293"></a><span class="c">!&gt; @author Marc De Graef, Carnegie Mellon University</span>
<a name="ln-1294"></a><span class="c">!</span>
<a name="ln-1295"></a><span class="c">!&gt; @brief This subroutine can be called by a C/C++ program as a standalone routine to compute EBSD master patterns</span>
<a name="ln-1296"></a><span class="c">!</span>
<a name="ln-1297"></a><span class="c">!&gt; @details This subroutine provides a method to compute an EBSD master pattern for the northern and southern</span>
<a name="ln-1298"></a><span class="c">!&gt; hemispheres, i.e., it implements the EMEBSDmaster.f90 program.  The routine can be called from an external C/C++ program; </span>
<a name="ln-1299"></a><span class="c">!&gt; the routine provides a callback mechanism to update the calling program about computational </span>
<a name="ln-1300"></a><span class="c">!&gt; progress, as well as a cancel option.</span>
<a name="ln-1301"></a><span class="c">!&gt;</span>
<a name="ln-1302"></a><span class="c">!&gt; The routine is intended to be called from a C/C++ program, e.g., DREAM.3D.  This routine is a </span>
<a name="ln-1303"></a><span class="c">!&gt; simplified version of the core of the EMEBSDmaster program. </span>
<a name="ln-1304"></a><span class="c">!&gt;</span>
<a name="ln-1305"></a><span class="c">!&gt; Since the HDF5 library with fortran90 support can only be a static library on Mac OS X, we must</span>
<a name="ln-1306"></a><span class="c">!&gt; have the calling program read the .xtal HDF5 file and pass the necessary information on to</span>
<a name="ln-1307"></a><span class="c">!&gt; this routine.  This is a workaround until the HDF group fixes the static library issue; DREAM.3D</span>
<a name="ln-1308"></a><span class="c">!&gt; requires a dynamical HDF5 library, so for DREAM.3D and EMsoft to properly work together, the </span>
<a name="ln-1309"></a><span class="c">!&gt; callable routines in this file may not depend on any HDF code at all, either directly or indirectly.</span>
<a name="ln-1310"></a><span class="c">!&gt;</span>
<a name="ln-1311"></a><span class="c">!&gt; @param ipar array with integer input parameters</span>
<a name="ln-1312"></a><span class="c">!&gt; @param fpar array with float input parameters</span>
<a name="ln-1313"></a><span class="c">!&gt; @param atdata atom coordinate array</span>
<a name="ln-1314"></a><span class="c">!&gt; @param attypes atom type array</span>
<a name="ln-1315"></a><span class="c">!&gt; @param latparm lattice parameter array</span>
<a name="ln-1316"></a><span class="c">!&gt; @param accum_z output array with Monte Carlo depth histogram</span>
<a name="ln-1317"></a><span class="c">!&gt; @param mLPNH modified Lambert projection northern hemisphere (output)</span>
<a name="ln-1318"></a><span class="c">!&gt; @param mLPSH modified Lambert projection southern hemisphere (output)</span>
<a name="ln-1319"></a><span class="c">!</span>
<a name="ln-1320"></a><span class="c">!&gt; @date 04/17/16 MDG 1.0 original</span>
<a name="ln-1321"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-1322"></a><span class="k">recursive subroutine </span><span class="n">EMsoftCgetEBSDmaster</span><span class="p">(</span><span class="n">ipar</span><span class="p">,</span><span class="n">fpar</span><span class="p">,</span><span class="n">atompos</span><span class="p">,</span><span class="n">atomtypes</span><span class="p">,</span><span class="n">latparm</span><span class="p">,</span><span class="n">accum_z</span><span class="p">,</span><span class="n">mLPNH</span><span class="p">,</span><span class="n">mLPSH</span><span class="p">,</span><span class="n">cproc</span><span class="p">,</span><span class="n">objAddress</span><span class="p">,</span><span class="n">cancel</span><span class="p">)</span> <span class="p">&amp;</span>
<a name="ln-1323"></a>           <span class="k">bind</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;EMsoftCgetEBSDmaster&#39;</span><span class="p">)</span>    <span class="c">! this routine is callable from a C/C++ program</span>
<a name="ln-1324"></a><span class="c">!DEC$ ATTRIBUTES DLLEXPORT :: EMsoftCgetEBSDmaster</span>
<a name="ln-1325"></a>
<a name="ln-1326"></a><span class="c">! these are the same as in the EMsoftCgetMCOpenCL routine, with a few extras at the end.</span>
<a name="ln-1327"></a><span class="c">! ipar components</span>
<a name="ln-1328"></a><span class="c">! ipar(1) : integer(kind=irg)       :: nx  = (numsx-1)/2</span>
<a name="ln-1329"></a><span class="c">! ipar(2) : integer(kind=irg)       :: globalworkgrpsz</span>
<a name="ln-1330"></a><span class="c">! ipar(3) : integer(kind=irg)       :: num_el</span>
<a name="ln-1331"></a><span class="c">! ipar(4) : integer(kind=irg)       :: totnum_el</span>
<a name="ln-1332"></a><span class="c">! ipar(5) : integer(kind=irg)       :: multiplier</span>
<a name="ln-1333"></a><span class="c">! ipar(6) : integer(kind=irg)       :: devid</span>
<a name="ln-1334"></a><span class="c">! ipar(7) : integer(kind=irg)       :: platid</span>
<a name="ln-1335"></a><span class="c">! ipar(8) : integer(kind=irg)       :: CrystalSystem</span>
<a name="ln-1336"></a><span class="c">! ipar(9) : integer(kind=irg)       :: Natomtypes</span>
<a name="ln-1337"></a><span class="c">! ipar(10): integer(kind=irg)       :: SpaceGroupNumber</span>
<a name="ln-1338"></a><span class="c">! ipar(11): integer(kind=irg)       :: SpaceGroupSetting</span>
<a name="ln-1339"></a><span class="c">! ipar(12): integer(kind=irg)       :: numEbins</span>
<a name="ln-1340"></a><span class="c">! ipar(13): integer(kind=irg)       :: numzbins</span>
<a name="ln-1341"></a><span class="c">! ipar(14): integer(kind=irg)       :: mcmode  ( 1 = &#39;full&#39;, 2 = &#39;bse1&#39; )</span>
<a name="ln-1342"></a><span class="c">! ipar(15): integer(kind=irg)       :: numangle</span>
<a name="ln-1343"></a><span class="c">! ipar(16): integer(kind=irg)       :: nxten = nx/10</span>
<a name="ln-1344"></a><span class="c">! the following are only used in this routine, not in the Monte Carlo routine</span>
<a name="ln-1345"></a><span class="c">! ipar(17): integer(kind=irg)       :: npx</span>
<a name="ln-1346"></a><span class="c">! ipar(18): integer(kind=irg)       :: nthreads</span>
<a name="ln-1347"></a>
<a name="ln-1348"></a><span class="c">! fpar components</span>
<a name="ln-1349"></a><span class="c">! fpar(1) : real(kind=dbl)          :: sig</span>
<a name="ln-1350"></a><span class="c">! fpar(2) : real(kind=dbl)          :: omega</span>
<a name="ln-1351"></a><span class="c">! fpar(3) : real(kind=dbl)          :: EkeV</span>
<a name="ln-1352"></a><span class="c">! fpar(4) : real(kind=dbl)          :: Ehistmin</span>
<a name="ln-1353"></a><span class="c">! fpar(5) : real(kind=dbl)          :: Ebinsize</span>
<a name="ln-1354"></a><span class="c">! fpar(6) : real(kind=dbl)          :: depthmax</span>
<a name="ln-1355"></a><span class="c">! fpar(7) : real(kind=dbl)          :: depthstep</span>
<a name="ln-1356"></a><span class="c">! fpar(8) : real(kind=dbl)          :: sigstart</span>
<a name="ln-1357"></a><span class="c">! fpar(9) : real(kind=dbl)          :: sigend</span>
<a name="ln-1358"></a><span class="c">! fpar(10): real(kind=dbl)          :: sigstep</span>
<a name="ln-1359"></a><span class="c">! parameters only used in this routine, this includes the Bethe Parameters !!!!</span>
<a name="ln-1360"></a><span class="c">! fpar(11) : real(kind=dbl)         :: dmin</span>
<a name="ln-1361"></a><span class="c">! fpar(12) : real(kind=dbl)         :: Bethe  c1</span>
<a name="ln-1362"></a><span class="c">! fpar(13) : real(kind=dbl)         :: Bethe  c2</span>
<a name="ln-1363"></a><span class="c">! fpar(14) : real(kind=dbl)         :: Bethe  c3</span>
<a name="ln-1364"></a>
<a name="ln-1365"></a><span class="k">use </span><span class="n">typedefs</span>
<a name="ln-1366"></a><span class="k">use </span><span class="n">NameListTypedefs</span>
<a name="ln-1367"></a><span class="k">use </span><span class="n">initializers</span>
<a name="ln-1368"></a><span class="k">use </span><span class="n">MBmodule</span>
<a name="ln-1369"></a><span class="k">use </span><span class="n">symmetry</span>
<a name="ln-1370"></a><span class="k">use </span><span class="n">crystal</span>
<a name="ln-1371"></a><span class="k">use </span><span class="n">constants</span>
<a name="ln-1372"></a><span class="k">use </span><span class="n">error</span>
<a name="ln-1373"></a><span class="k">use </span><span class="n">gvectors</span>
<a name="ln-1374"></a><span class="k">use </span><span class="n">kvectors</span>
<a name="ln-1375"></a><span class="k">use </span><span class="n">io</span>
<a name="ln-1376"></a><span class="k">use </span><span class="n">local</span>
<a name="ln-1377"></a><span class="k">use </span><span class="n">files</span>
<a name="ln-1378"></a><span class="k">use </span><span class="n">diffraction</span>
<a name="ln-1379"></a><span class="k">use </span><span class="n">multibeams</span>
<a name="ln-1380"></a><span class="k">use </span><span class="n">timing</span>
<a name="ln-1381"></a><span class="k">use </span><span class="n">Lambert</span>
<a name="ln-1382"></a><span class="k">use </span><span class="nb">ISO_C_BINDING</span>
<a name="ln-1383"></a><span class="k">use </span><span class="n">omp_lib</span>
<a name="ln-1384"></a>
<a name="ln-1385"></a><span class="k">IMPLICIT NONE</span>
<a name="ln-1386"></a>
<a name="ln-1387"></a><span class="kt">integer</span><span class="p">(</span><span class="kt">c_int32_t</span><span class="p">),</span><span class="k">PARAMETER</span>            <span class="kd">::</span> <span class="n">nipar</span><span class="o">=</span><span class="mi">40</span>
<a name="ln-1388"></a><span class="kt">integer</span><span class="p">(</span><span class="kt">c_int32_t</span><span class="p">),</span><span class="k">PARAMETER</span>            <span class="kd">::</span> <span class="n">nfpar</span><span class="o">=</span><span class="mi">40</span>
<a name="ln-1389"></a><span class="kt">integer</span><span class="p">(</span><span class="kt">c_int32_t</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>           <span class="kd">::</span> <span class="n">ipar</span><span class="p">(</span><span class="n">nipar</span><span class="p">)</span>
<a name="ln-1390"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>               <span class="kd">::</span> <span class="n">fpar</span><span class="p">(</span><span class="n">nfpar</span><span class="p">)</span>
<a name="ln-1391"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>               <span class="kd">::</span> <span class="n">atompos</span><span class="p">(</span><span class="n">ipar</span><span class="p">(</span><span class="mi">9</span><span class="p">),</span><span class="mi">5</span><span class="p">)</span>
<a name="ln-1392"></a><span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">irg</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>            <span class="kd">::</span> <span class="n">atomtypes</span><span class="p">(</span><span class="n">ipar</span><span class="p">(</span><span class="mi">9</span><span class="p">))</span>
<a name="ln-1393"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>               <span class="kd">::</span> <span class="n">latparm</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
<a name="ln-1394"></a><span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">irg</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>            <span class="kd">::</span> <span class="n">accum_z</span><span class="p">(</span><span class="n">ipar</span><span class="p">(</span><span class="mi">12</span><span class="p">),</span><span class="n">ipar</span><span class="p">(</span><span class="mi">13</span><span class="p">),</span><span class="o">-</span><span class="n">ipar</span><span class="p">(</span><span class="mi">16</span><span class="p">):</span><span class="n">ipar</span><span class="p">(</span><span class="mi">16</span><span class="p">),</span><span class="o">-</span><span class="n">ipar</span><span class="p">(</span><span class="mi">16</span><span class="p">):</span><span class="n">ipar</span><span class="p">(</span><span class="mi">16</span><span class="p">))</span>
<a name="ln-1395"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">OUT</span><span class="p">)</span>              <span class="kd">::</span> <span class="n">mLPNH</span><span class="p">(</span><span class="o">-</span><span class="n">ipar</span><span class="p">(</span><span class="mi">17</span><span class="p">):</span><span class="n">ipar</span><span class="p">(</span><span class="mi">17</span><span class="p">),</span><span class="o">-</span><span class="n">ipar</span><span class="p">(</span><span class="mi">17</span><span class="p">):</span><span class="n">ipar</span><span class="p">(</span><span class="mi">17</span><span class="p">),</span><span class="mi">1</span><span class="p">:</span><span class="n">ipar</span><span class="p">(</span><span class="mi">12</span><span class="p">),</span><span class="mi">1</span><span class="p">:</span><span class="n">ipar</span><span class="p">(</span><span class="mi">9</span><span class="p">))</span>
<a name="ln-1396"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">OUT</span><span class="p">)</span>              <span class="kd">::</span> <span class="n">mLPSH</span><span class="p">(</span><span class="o">-</span><span class="n">ipar</span><span class="p">(</span><span class="mi">17</span><span class="p">):</span><span class="n">ipar</span><span class="p">(</span><span class="mi">17</span><span class="p">),</span><span class="o">-</span><span class="n">ipar</span><span class="p">(</span><span class="mi">17</span><span class="p">):</span><span class="n">ipar</span><span class="p">(</span><span class="mi">17</span><span class="p">),</span><span class="mi">1</span><span class="p">:</span><span class="n">ipar</span><span class="p">(</span><span class="mi">12</span><span class="p">),</span><span class="mi">1</span><span class="p">:</span><span class="n">ipar</span><span class="p">(</span><span class="mi">9</span><span class="p">))</span>
<a name="ln-1397"></a><span class="k">TYPE</span><span class="p">(</span><span class="kt">C_FUNPTR</span><span class="p">),</span> <span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">),</span> <span class="k">VALUE</span>       <span class="kd">::</span> <span class="n">cproc</span>
<a name="ln-1398"></a><span class="kt">integer</span><span class="p">(</span><span class="kt">c_size_t</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">),</span> <span class="k">VALUE</span>     <span class="kd">::</span> <span class="n">objAddress</span>
<a name="ln-1399"></a><span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>             <span class="kd">::</span> <span class="n">cancel</span>
<a name="ln-1400"></a>
<a name="ln-1401"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">dbl</span><span class="p">)</span>          <span class="kd">::</span> <span class="n">ctmp</span><span class="p">(</span><span class="mi">192</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">arg</span>
<a name="ln-1402"></a>
<a name="ln-1403"></a><span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">irg</span><span class="p">)</span>       <span class="kd">::</span> <span class="n">isym</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">ik</span><span class="p">,</span><span class="n">npy</span><span class="p">,</span><span class="n">ipx</span><span class="p">,</span><span class="n">ipy</span><span class="p">,</span><span class="n">ipz</span><span class="p">,</span><span class="n">debug</span><span class="p">,</span><span class="n">iE</span><span class="p">,</span><span class="n">izz</span><span class="p">,</span> <span class="n">izzmax</span><span class="p">,</span> <span class="n">iequiv</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">48</span><span class="p">),</span> <span class="n">nequiv</span><span class="p">,</span> <span class="n">num_el</span><span class="p">,</span> <span class="n">MCnthreads</span><span class="p">,</span> <span class="p">&amp;</span> <span class="c">! counters</span>
<a name="ln-1404"></a>                           <span class="n">numk</span><span class="p">,</span> <span class="p">&amp;</span> <span class="c">! number of independent incident beam directions</span>
<a name="ln-1405"></a>                           <span class="n">ir</span><span class="p">,</span><span class="n">nat</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span><span class="n">kk</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">skip</span><span class="p">,</span> <span class="n">ijmax</span><span class="p">,</span> <span class="n">one</span><span class="p">,</span> <span class="n">NUMTHREADS</span><span class="p">,</span> <span class="n">TID</span><span class="p">,</span> <span class="n">SamplingType</span><span class="p">,</span> <span class="n">cancelerr</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-1406"></a>                           <span class="n">numset</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="n">ix</span><span class="p">,</span><span class="n">iy</span><span class="p">,</span><span class="n">iz</span><span class="p">,</span> <span class="n">nns</span><span class="p">,</span> <span class="n">nnw</span><span class="p">,</span> <span class="n">nref</span><span class="p">,</span> <span class="n">Estart</span><span class="p">,</span> <span class="n">ipg</span><span class="p">,</span> <span class="n">isave</span><span class="p">,</span> <span class="n">npx</span><span class="p">,</span> <span class="n">nthreads</span><span class="p">,</span>  <span class="p">&amp;</span>
<a name="ln-1407"></a>                           <span class="n">istat</span><span class="p">,</span><span class="n">gzero</span><span class="p">,</span><span class="n">ic</span><span class="p">,</span><span class="n">ip</span><span class="p">,</span><span class="n">ikk</span><span class="p">,</span> <span class="n">totstrong</span><span class="p">,</span> <span class="n">totweak</span><span class="p">,</span> <span class="n">jh</span><span class="p">,</span> <span class="n">ierr</span><span class="p">,</span> <span class="n">nix</span><span class="p">,</span> <span class="n">niy</span><span class="p">,</span> <span class="n">nixp</span><span class="p">,</span> <span class="n">niyp</span><span class="p">,</span> <span class="n">nxten</span>     <span class="c">! counters</span>
<a name="ln-1408"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">dbl</span><span class="p">)</span>          <span class="kd">::</span> <span class="n">tpi</span><span class="p">,</span><span class="n">Znsq</span><span class="p">,</span> <span class="n">kkl</span><span class="p">,</span> <span class="n">DBWF</span><span class="p">,</span> <span class="n">kin</span><span class="p">,</span> <span class="n">delta</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">lambda</span><span class="p">,</span> <span class="n">omtl</span><span class="p">,</span> <span class="n">srt</span><span class="p">,</span> <span class="n">dc</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">xy</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">edge</span><span class="p">,</span> <span class="n">scl</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-1409"></a>                           <span class="n">dx</span><span class="p">,</span> <span class="n">dxm</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">dym</span><span class="p">,</span> <span class="nb">dmin</span> <span class="c">!</span>
<a name="ln-1410"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">)</span>          <span class="kd">::</span> <span class="n">io_real</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span> <span class="n">selE</span><span class="p">,</span> <span class="n">kn</span><span class="p">,</span> <span class="n">FN</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">kkk</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">tstart</span><span class="p">,</span> <span class="n">tstop</span><span class="p">,</span> <span class="n">bp</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<a name="ln-1411"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">),</span><span class="k">allocatable</span>      <span class="kd">::</span> <span class="n">EkeVs</span><span class="p">(:),</span> <span class="n">svals</span><span class="p">(:),</span> <span class="n">auxNH</span><span class="p">(:,:,:),</span> <span class="n">auxSH</span><span class="p">(:,:,:)</span>  <span class="c">! results</span>
<a name="ln-1412"></a><span class="kt">complex</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">dbl</span><span class="p">)</span>               <span class="kd">::</span> <span class="n">czero</span>
<a name="ln-1413"></a><span class="kt">complex</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">dbl</span><span class="p">),</span><span class="k">allocatable</span>   <span class="kd">::</span> <span class="n">Lgh</span><span class="p">(:,:),</span> <span class="n">Sgh</span><span class="p">(:,:,:)</span>
<a name="ln-1414"></a><span class="kt">logical</span>                 <span class="kd">::</span> <span class="n">usehex</span><span class="p">,</span> <span class="n">switchmirror</span><span class="p">,</span> <span class="n">verbose</span>
<a name="ln-1415"></a>
<a name="ln-1416"></a><span class="c">! Monte Carlo derived quantities</span>
<a name="ln-1417"></a><span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">irg</span><span class="p">)</span>       <span class="kd">::</span> <span class="n">numEbins</span><span class="p">,</span> <span class="n">numzbins</span><span class="p">,</span> <span class="n">nsx</span><span class="p">,</span> <span class="n">nsy</span><span class="p">,</span> <span class="n">hdferr</span><span class="p">,</span> <span class="n">nlines</span><span class="p">,</span> <span class="n">lastEnergy</span><span class="p">,</span> <span class="n">cn</span><span class="p">,</span> <span class="n">dn</span><span class="p">,</span> <span class="n">totn</span><span class="p">,</span> <span class="n">cn2</span><span class="p">,</span> <span class="n">totn2</span> <span class="c">! variables used in MC energy file</span>
<a name="ln-1418"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">dbl</span><span class="p">)</span>          <span class="kd">::</span> <span class="n">EkeV</span><span class="p">,</span> <span class="n">Ehistmin</span><span class="p">,</span> <span class="n">Ebinsize</span><span class="p">,</span> <span class="n">depthmax</span><span class="p">,</span> <span class="n">depthstep</span><span class="p">,</span> <span class="n">etotal</span> <span class="c">! enery variables from MC program</span>
<a name="ln-1419"></a><span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">irg</span><span class="p">),</span><span class="k">allocatable</span> <span class="kd">::</span> <span class="n">thick</span><span class="p">(:),</span> <span class="n">acc_z</span><span class="p">(:,:,:,:)</span>
<a name="ln-1420"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">),</span><span class="k">allocatable</span> <span class="kd">::</span> <span class="n">lambdaE</span><span class="p">(:,:)</span>
<a name="ln-1421"></a><span class="kt">logical</span>                 <span class="kd">::</span> <span class="n">f_exists</span><span class="p">,</span> <span class="n">readonly</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="p">.</span><span class="n">TRUE</span><span class="p">.,</span> <span class="n">insert</span><span class="o">=</span><span class="p">.</span><span class="n">TRUE</span><span class="p">.,</span> <span class="n">stereog</span>
<a name="ln-1422"></a><span class="kt">character</span><span class="p">(</span><span class="n">fnlen</span><span class="p">,</span> <span class="nb">KIND</span><span class="o">=</span><span class="kt">c_char</span><span class="p">),</span><span class="k">allocatable</span><span class="p">,</span><span class="k">TARGET</span> <span class="kd">::</span> <span class="n">stringarray</span><span class="p">(:)</span>
<a name="ln-1423"></a><span class="kt">character</span><span class="p">(</span><span class="n">fnlen</span><span class="p">,</span><span class="nb">kind</span><span class="o">=</span><span class="kt">c_char</span><span class="p">)</span>                     <span class="kd">::</span> <span class="n">line2</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-1424"></a>
<a name="ln-1425"></a><span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">irg</span><span class="p">)</span>       <span class="kd">::</span> <span class="n">imh</span><span class="p">,</span> <span class="n">imk</span><span class="p">,</span> <span class="n">iml</span><span class="p">,</span> <span class="n">gg</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-1426"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">)</span>          <span class="kd">::</span> <span class="n">dhkl</span><span class="p">,</span> <span class="n">ddt</span>
<a name="ln-1427"></a>
<a name="ln-1428"></a><span class="k">type</span><span class="p">(</span><span class="n">unitcell</span><span class="p">),</span><span class="k">pointer</span>          <span class="kd">::</span> <span class="n">cell</span>
<a name="ln-1429"></a><span class="k">type</span><span class="p">(</span><span class="n">DynType</span><span class="p">),</span><span class="k">save</span>              <span class="kd">::</span> <span class="n">Dyn</span>
<a name="ln-1430"></a><span class="k">type</span><span class="p">(</span><span class="n">gnode</span><span class="p">),</span><span class="k">save</span>                <span class="kd">::</span> <span class="n">rlp</span>
<a name="ln-1431"></a><span class="k">type</span><span class="p">(</span><span class="n">reflisttype</span><span class="p">),</span><span class="k">pointer</span>       <span class="kd">::</span> <span class="n">reflist</span><span class="p">,</span><span class="n">firstw</span><span class="p">,</span> <span class="n">rltmp</span>
<a name="ln-1432"></a><span class="k">type</span><span class="p">(</span><span class="n">BetheParameterType</span><span class="p">)</span>        <span class="kd">::</span> <span class="n">BetheParameters</span>
<a name="ln-1433"></a><span class="k">type</span><span class="p">(</span><span class="n">kvectorlist</span><span class="p">),</span><span class="k">pointer</span>       <span class="kd">::</span> <span class="n">khead</span><span class="p">,</span> <span class="n">ktmp</span>
<a name="ln-1434"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">),</span><span class="k">allocatable</span>      <span class="kd">::</span> <span class="n">karray</span><span class="p">(:,:)</span>
<a name="ln-1435"></a><span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">irg</span><span class="p">),</span><span class="k">allocatable</span>   <span class="kd">::</span> <span class="n">kij</span><span class="p">(:,:)</span>
<a name="ln-1436"></a><span class="kt">complex</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">dbl</span><span class="p">),</span><span class="k">allocatable</span>   <span class="kd">::</span> <span class="n">DynMat</span><span class="p">(:,:)</span>
<a name="ln-1437"></a><span class="kt">character</span><span class="p">(</span><span class="n">fnlen</span><span class="p">)</span>                <span class="kd">::</span> <span class="n">dataset</span><span class="p">,</span> <span class="n">instring</span>
<a name="ln-1438"></a><span class="k">PROCEDURE</span><span class="p">(</span><span class="n">ProgressCallBack3</span><span class="p">),</span> <span class="k">POINTER</span>   <span class="kd">::</span> <span class="n">proc</span>
<a name="ln-1439"></a>
<a name="ln-1440"></a><span class="c">!$OMP THREADPRIVATE(rlp) </span>
<a name="ln-1441"></a>
<a name="ln-1442"></a><span class="c">! link the proc procedure to the cproc argument</span>
<a name="ln-1443"></a><span class="k">CALL </span><span class="nb">C_F_PROCPOINTER</span> <span class="p">(</span><span class="n">cproc</span><span class="p">,</span> <span class="n">proc</span><span class="p">)</span>
<a name="ln-1444"></a>
<a name="ln-1445"></a>
<a name="ln-1446"></a><span class="c">! initalize a few variables</span>
<a name="ln-1447"></a><span class="n">tpi</span> <span class="o">=</span> <span class="mf">2.D0</span><span class="o">*</span><span class="n">cPi</span>
<a name="ln-1448"></a><span class="n">czero</span> <span class="o">=</span> <span class="n">dcmplx</span><span class="p">(</span><span class="mf">0.D0</span><span class="p">,</span><span class="mf">0.D0</span><span class="p">)</span>
<a name="ln-1449"></a>
<a name="ln-1450"></a><span class="c">! parameters that would normally be read from the MC HDF5 file</span>
<a name="ln-1451"></a><span class="n">npx</span> <span class="o">=</span> <span class="n">ipar</span><span class="p">(</span><span class="mi">17</span><span class="p">)</span>
<a name="ln-1452"></a><span class="n">nxten</span> <span class="o">=</span> <span class="n">ipar</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span>
<a name="ln-1453"></a><span class="n">EkeV</span> <span class="o">=</span> <span class="n">fpar</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-1454"></a><span class="n">Ehistmin</span> <span class="o">=</span> <span class="n">fpar</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<a name="ln-1455"></a><span class="n">Ebinsize</span> <span class="o">=</span> <span class="n">fpar</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<a name="ln-1456"></a><span class="n">depthmax</span> <span class="o">=</span> <span class="n">fpar</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
<a name="ln-1457"></a><span class="n">depthstep</span> <span class="o">=</span> <span class="n">fpar</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span>
<a name="ln-1458"></a><span class="n">numEbins</span> <span class="o">=</span> <span class="n">ipar</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span>
<a name="ln-1459"></a><span class="n">Estart</span> <span class="o">=</span> <span class="n">numEbins</span>
<a name="ln-1460"></a><span class="n">numzbins</span> <span class="o">=</span> <span class="n">ipar</span><span class="p">(</span><span class="mi">13</span><span class="p">)</span>
<a name="ln-1461"></a><span class="n">num_el</span> <span class="o">=</span> <span class="n">ipar</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-1462"></a><span class="nb">dmin</span> <span class="o">=</span> <span class="n">fpar</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span>
<a name="ln-1463"></a><span class="n">nthreads</span> <span class="o">=</span> <span class="n">ipar</span><span class="p">(</span><span class="mi">18</span><span class="p">)</span>
<a name="ln-1464"></a><span class="n">etotal</span> <span class="o">=</span> <span class="nb">dble</span><span class="p">(</span><span class="n">ipar</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span><span class="o">*</span><span class="nb">dble</span><span class="p">(</span><span class="n">ipar</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>
<a name="ln-1465"></a>
<a name="ln-1466"></a><span class="c">! extract the BetheParameters ... </span>
<a name="ln-1467"></a><span class="n">BetheParameters</span><span class="p">%</span><span class="n">c1</span> <span class="o">=</span> <span class="n">fpar</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span>
<a name="ln-1468"></a><span class="n">BetheParameters</span><span class="p">%</span><span class="n">c2</span> <span class="o">=</span> <span class="n">fpar</span><span class="p">(</span><span class="mi">13</span><span class="p">)</span>
<a name="ln-1469"></a><span class="n">BetheParameters</span><span class="p">%</span><span class="n">c3</span> <span class="o">=</span> <span class="n">fpar</span><span class="p">(</span><span class="mi">14</span><span class="p">)</span>
<a name="ln-1470"></a>
<a name="ln-1471"></a><span class="c">!=============================================</span>
<a name="ln-1472"></a><span class="c">!=============================================</span>
<a name="ln-1473"></a><span class="c">! crystallography section</span>
<a name="ln-1474"></a>
<a name="ln-1475"></a><span class="k">nullify</span><span class="p">(</span><span class="n">cell</span><span class="p">)</span>
<a name="ln-1476"></a><span class="k">allocate</span><span class="p">(</span><span class="n">cell</span><span class="p">)</span>
<a name="ln-1477"></a>
<a name="ln-1478"></a>
<a name="ln-1479"></a><span class="c">! lattice parameters</span>
<a name="ln-1480"></a><span class="n">cell</span><span class="p">%</span><span class="n">a</span> <span class="o">=</span> <span class="nb">dble</span><span class="p">(</span><span class="n">latparm</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
<a name="ln-1481"></a><span class="n">cell</span><span class="p">%</span><span class="n">b</span> <span class="o">=</span> <span class="nb">dble</span><span class="p">(</span><span class="n">latparm</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
<a name="ln-1482"></a><span class="n">cell</span><span class="p">%</span><span class="n">c</span> <span class="o">=</span> <span class="nb">dble</span><span class="p">(</span><span class="n">latparm</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
<a name="ln-1483"></a><span class="n">cell</span><span class="p">%</span><span class="n">alpha</span> <span class="o">=</span> <span class="nb">dble</span><span class="p">(</span><span class="n">latparm</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
<a name="ln-1484"></a><span class="n">cell</span><span class="p">%</span><span class="n">beta</span> <span class="o">=</span> <span class="nb">dble</span><span class="p">(</span><span class="n">latparm</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>
<a name="ln-1485"></a><span class="n">cell</span><span class="p">%</span><span class="nb">gamma</span> <span class="o">=</span> <span class="nb">dble</span><span class="p">(</span><span class="n">latparm</span><span class="p">(</span><span class="mi">6</span><span class="p">))</span>
<a name="ln-1486"></a><span class="c">! symmetry parameters</span>
<a name="ln-1487"></a><span class="n">cell</span><span class="p">%</span><span class="n">xtal_system</span> <span class="o">=</span> <span class="n">ipar</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
<a name="ln-1488"></a><span class="n">cell</span><span class="p">%</span><span class="n">SYM_SGset</span> <span class="o">=</span> <span class="n">ipar</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span>
<a name="ln-1489"></a><span class="n">cell</span><span class="p">%</span><span class="n">SYM_SGnum</span> <span class="o">=</span> <span class="n">ipar</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<a name="ln-1490"></a><span class="k">if</span> <span class="p">((</span><span class="n">cell</span><span class="p">%</span><span class="n">SYM_SGnum</span><span class="p">.</span><span class="n">ge</span><span class="p">.</span><span class="mi">143</span><span class="p">).</span><span class="nb">and</span><span class="p">.(</span><span class="n">cell</span><span class="p">%</span><span class="n">SYM_SGnum</span><span class="p">.</span><span class="n">le</span><span class="p">.</span><span class="mi">167</span><span class="p">))</span> <span class="k">then</span>
<a name="ln-1491"></a><span class="k">  </span><span class="n">cell</span><span class="p">%</span><span class="n">SG</span><span class="p">%</span><span class="n">SYM_trigonal</span> <span class="o">=</span> <span class="p">.</span><span class="n">TRUE</span><span class="p">.</span>
<a name="ln-1492"></a><span class="k">else</span>
<a name="ln-1493"></a><span class="k">  </span><span class="n">cell</span><span class="p">%</span><span class="n">SG</span><span class="p">%</span><span class="n">SYM_trigonal</span> <span class="o">=</span> <span class="p">.</span><span class="n">FALSE</span><span class="p">.</span>
<a name="ln-1494"></a><span class="k">end if</span> 
<a name="ln-1495"></a><span class="c">! atom type and coordinate parameters</span>
<a name="ln-1496"></a><span class="n">cell</span><span class="p">%</span><span class="n">ATOM_ntype</span> <span class="o">=</span> <span class="n">ipar</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span>
<a name="ln-1497"></a><span class="n">cell</span><span class="p">%</span><span class="n">ATOM_type</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">cell</span><span class="p">%</span><span class="n">ATOM_ntype</span><span class="p">)</span> <span class="o">=</span> <span class="n">atomtypes</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">cell</span><span class="p">%</span><span class="n">ATOM_ntype</span><span class="p">)</span> 
<a name="ln-1498"></a><span class="n">cell</span><span class="p">%</span><span class="n">ATOM_pos</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">cell</span><span class="p">%</span><span class="n">ATOM_ntype</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="n">atompos</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">cell</span><span class="p">%</span><span class="n">ATOM_ntype</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="mi">5</span><span class="p">)</span> 
<a name="ln-1499"></a><span class="c">! generate the symmetry operations</span>
<a name="ln-1500"></a><span class="n">cell</span><span class="p">%</span><span class="n">hexset</span> <span class="o">=</span> <span class="p">.</span><span class="n">FALSE</span><span class="p">.</span>
<a name="ln-1501"></a><span class="k">if</span> <span class="p">(</span><span class="n">cell</span><span class="p">%</span><span class="n">xtal_system</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mi">4</span><span class="p">)</span> <span class="n">cell</span><span class="p">%</span><span class="n">hexset</span> <span class="o">=</span> <span class="p">.</span><span class="n">TRUE</span><span class="p">.</span>
<a name="ln-1502"></a><span class="k">if</span> <span class="p">((</span><span class="n">cell</span><span class="p">%</span><span class="n">xtal_system</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mi">5</span><span class="p">).</span><span class="nb">AND</span><span class="p">.(</span><span class="n">cell</span><span class="p">%</span><span class="n">SYM_SGset</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="mi">2</span><span class="p">))</span> <span class="n">cell</span><span class="p">%</span><span class="n">hexset</span> <span class="o">=</span> <span class="p">.</span><span class="n">TRUE</span><span class="p">.</span>
<a name="ln-1503"></a><span class="c">! compute the metric matrices</span>
<a name="ln-1504"></a> <span class="k">call </span><span class="n">CalcMatrices</span><span class="p">(</span><span class="n">cell</span><span class="p">)</span>
<a name="ln-1505"></a><span class="c">! First generate the point symmetry matrices, then the actual space group.</span>
<a name="ln-1506"></a><span class="c">! Get the symmorphic space group corresponding to the point group</span>
<a name="ln-1507"></a><span class="c">! of the actual space group</span>
<a name="ln-1508"></a> <span class="n">ipg</span><span class="o">=</span><span class="mi">0</span>
<a name="ln-1509"></a> <span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="mi">32</span>
<a name="ln-1510"></a>  <span class="k">if</span> <span class="p">(</span><span class="n">SGPG</span><span class="p">(</span><span class="n">i</span><span class="p">).</span><span class="n">le</span><span class="p">.</span><span class="n">cell</span><span class="p">%</span><span class="n">SYM_SGnum</span><span class="p">)</span> <span class="n">ipg</span><span class="o">=</span><span class="n">i</span>
<a name="ln-1511"></a> <span class="k">end do</span>
<a name="ln-1512"></a><span class="c">! if the actual group is also the symmorphic group, then both </span>
<a name="ln-1513"></a><span class="c">! steps can be done simultaneously, otherwise two calls to </span>
<a name="ln-1514"></a><span class="c">! GenerateSymmetry are needed.</span>
<a name="ln-1515"></a> <span class="k">if</span> <span class="p">(</span><span class="n">SGPG</span><span class="p">(</span><span class="n">ipg</span><span class="p">).</span><span class="n">eq</span><span class="p">.</span><span class="n">cell</span><span class="p">%</span><span class="n">SYM_SGnum</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1516"></a><span class="k">  call </span><span class="n">GenerateSymmetry</span><span class="p">(</span><span class="n">cell</span><span class="p">,.</span><span class="n">TRUE</span><span class="p">.)</span>
<a name="ln-1517"></a> <span class="k">else</span>
<a name="ln-1518"></a><span class="k">  </span><span class="n">isave</span> <span class="o">=</span> <span class="n">cell</span><span class="p">%</span><span class="n">SYM_SGnum</span>
<a name="ln-1519"></a>  <span class="n">cell</span><span class="p">%</span><span class="n">SYM_SGnum</span> <span class="o">=</span> <span class="n">SGPG</span><span class="p">(</span><span class="n">ipg</span><span class="p">)</span>
<a name="ln-1520"></a>  <span class="k">call </span><span class="n">GenerateSymmetry</span><span class="p">(</span><span class="n">cell</span><span class="p">,.</span><span class="n">TRUE</span><span class="p">.)</span>
<a name="ln-1521"></a>  <span class="n">cell</span><span class="p">%</span><span class="n">SYM_SGnum</span> <span class="o">=</span> <span class="n">isave</span>
<a name="ln-1522"></a>  <span class="k">call </span><span class="n">GenerateSymmetry</span><span class="p">(</span><span class="n">cell</span><span class="p">,.</span><span class="n">FALSE</span><span class="p">.)</span>
<a name="ln-1523"></a> <span class="k">end if</span>
<a name="ln-1524"></a><span class="c">! next we get all the atom positions</span>
<a name="ln-1525"></a><span class="k">call </span><span class="n">CalcPositions</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span><span class="s1">&#39;v&#39;</span><span class="p">)</span>
<a name="ln-1526"></a>
<a name="ln-1527"></a><span class="c">! voltage will be set in the energyloop later on...</span>
<a name="ln-1528"></a><span class="n">cell</span><span class="p">%</span><span class="n">voltage</span> <span class="o">=</span> <span class="nb">dble</span><span class="p">(</span><span class="n">EkeV</span><span class="p">)</span>
<a name="ln-1529"></a><span class="n">skip</span> <span class="o">=</span> <span class="mi">3</span>        <span class="c">! always use Weickenmeier&amp;Kohl scattering coefficients, including absorptive form factors</span>
<a name="ln-1530"></a><span class="k">call </span><span class="n">CalcWaveLength</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span><span class="n">rlp</span><span class="p">,</span><span class="n">skip</span><span class="p">)</span>
<a name="ln-1531"></a>
<a name="ln-1532"></a><span class="c">! compute the range of reflections for the lookup table and allocate the table</span>
<a name="ln-1533"></a><span class="c">! The master list is easily created by brute force</span>
<a name="ln-1534"></a> <span class="n">imh</span> <span class="o">=</span> <span class="mi">1</span>
<a name="ln-1535"></a> <span class="k">do </span>
<a name="ln-1536"></a><span class="k">   </span><span class="n">dhkl</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">/</span><span class="n">CalcLength</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span>  <span class="p">(</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">imh</span><span class="p">)</span> <span class="p">,</span><span class="mf">0.0_sgl</span><span class="p">,</span><span class="mf">0.0_sgl</span><span class="o">/</span><span class="p">),</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
<a name="ln-1537"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">dhkl</span><span class="p">.</span><span class="n">lt</span><span class="p">.</span><span class="nb">dmin</span><span class="p">)</span> <span class="k">EXIT</span>
<a name="ln-1538"></a><span class="k">   </span><span class="n">imh</span> <span class="o">=</span> <span class="n">imh</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-1539"></a> <span class="k">end do</span>
<a name="ln-1540"></a><span class="k"> </span><span class="n">imk</span> <span class="o">=</span> <span class="mi">1</span>
<a name="ln-1541"></a> <span class="k">do </span>
<a name="ln-1542"></a><span class="k">   </span><span class="n">dhkl</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">/</span><span class="n">CalcLength</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span> <span class="p">(</span><span class="o">/</span><span class="mf">0.0_sgl</span><span class="p">,</span><span class="nb">float</span><span class="p">(</span><span class="n">imk</span><span class="p">),</span><span class="mf">0.0_sgl</span><span class="o">/</span><span class="p">),</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
<a name="ln-1543"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">dhkl</span><span class="p">.</span><span class="n">lt</span><span class="p">.</span><span class="nb">dmin</span><span class="p">)</span> <span class="k">EXIT</span>
<a name="ln-1544"></a><span class="k">   </span><span class="n">imk</span> <span class="o">=</span> <span class="n">imk</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-1545"></a> <span class="k">end do</span>
<a name="ln-1546"></a><span class="k"> </span><span class="n">iml</span> <span class="o">=</span> <span class="mi">1</span>
<a name="ln-1547"></a> <span class="k">do </span>
<a name="ln-1548"></a><span class="k">   </span><span class="n">dhkl</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">/</span><span class="n">CalcLength</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span> <span class="p">(</span><span class="o">/</span><span class="mf">0.0_sgl</span><span class="p">,</span><span class="mf">0.0_sgl</span><span class="p">,</span><span class="nb">float</span><span class="p">(</span><span class="n">iml</span><span class="p">)</span><span class="o">/</span><span class="p">),</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
<a name="ln-1549"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">dhkl</span><span class="p">.</span><span class="n">lt</span><span class="p">.</span><span class="nb">dmin</span><span class="p">)</span> <span class="k">EXIT</span>
<a name="ln-1550"></a><span class="k">   </span><span class="n">iml</span> <span class="o">=</span> <span class="n">iml</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-1551"></a> <span class="k">end do</span>
<a name="ln-1552"></a>  
<a name="ln-1553"></a><span class="c">! the LUT array stores all the Fourier coefficients, so that we only need to compute them once... i.e., here and now</span>
<a name="ln-1554"></a> <span class="k">allocate</span><span class="p">(</span><span class="n">cell</span><span class="p">%</span><span class="n">LUT</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">imh</span><span class="p">:</span><span class="mi">2</span><span class="o">*</span><span class="n">imh</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">imk</span><span class="p">:</span><span class="mi">2</span><span class="o">*</span><span class="n">imk</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">iml</span><span class="p">:</span><span class="mi">2</span><span class="o">*</span><span class="n">iml</span><span class="p">),</span><span class="nb">stat</span><span class="o">=</span><span class="n">istat</span><span class="p">)</span>
<a name="ln-1555"></a> <span class="k">if</span> <span class="p">(</span><span class="n">istat</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span> <span class="k">call </span><span class="n">FatalError</span><span class="p">(</span><span class="s1">&#39;InitializeCell:&#39;</span><span class="p">,</span><span class="s1">&#39; unable to allocate cell%LUT array&#39;</span><span class="p">)</span>
<a name="ln-1556"></a> <span class="n">cell</span><span class="p">%</span><span class="n">LUT</span> <span class="o">=</span> <span class="n">dcmplx</span><span class="p">(</span><span class="mf">0.D0</span><span class="p">,</span><span class="mf">0.D0</span><span class="p">)</span>
<a name="ln-1557"></a> <span class="k">allocate</span><span class="p">(</span><span class="n">cell</span><span class="p">%</span><span class="n">LUTqg</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">imh</span><span class="p">:</span><span class="mi">2</span><span class="o">*</span><span class="n">imh</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">imk</span><span class="p">:</span><span class="mi">2</span><span class="o">*</span><span class="n">imk</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">iml</span><span class="p">:</span><span class="mi">2</span><span class="o">*</span><span class="n">iml</span><span class="p">),</span><span class="nb">stat</span><span class="o">=</span><span class="n">istat</span><span class="p">)</span>
<a name="ln-1558"></a> <span class="k">if</span> <span class="p">(</span><span class="n">istat</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span> <span class="k">call </span><span class="n">FatalError</span><span class="p">(</span><span class="s1">&#39;InitializeCell:&#39;</span><span class="p">,</span><span class="s1">&#39; unable to allocate cell%LUTqg array&#39;</span><span class="p">)</span>
<a name="ln-1559"></a> <span class="n">cell</span><span class="p">%</span><span class="n">LUTqg</span> <span class="o">=</span> <span class="n">dcmplx</span><span class="p">(</span><span class="mf">0.D0</span><span class="p">,</span><span class="mf">0.D0</span><span class="p">)</span>
<a name="ln-1560"></a> 
<a name="ln-1561"></a><span class="c">! allocate an array that keeps track of potential double diffraction reflections</span>
<a name="ln-1562"></a> <span class="k">allocate</span><span class="p">(</span><span class="n">cell</span><span class="p">%</span><span class="n">dbdiff</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">imh</span><span class="p">:</span><span class="mi">2</span><span class="o">*</span><span class="n">imh</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">imk</span><span class="p">:</span><span class="mi">2</span><span class="o">*</span><span class="n">imk</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">iml</span><span class="p">:</span><span class="mi">2</span><span class="o">*</span><span class="n">iml</span><span class="p">),</span><span class="nb">stat</span><span class="o">=</span><span class="n">istat</span><span class="p">)</span>
<a name="ln-1563"></a> <span class="k">if</span> <span class="p">(</span><span class="n">istat</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span> <span class="k">call </span><span class="n">FatalError</span><span class="p">(</span><span class="s1">&#39;InitializeCell:&#39;</span><span class="p">,</span><span class="s1">&#39; unable to allocate cell%dbdiff array&#39;</span><span class="p">)</span>
<a name="ln-1564"></a> <span class="n">cell</span><span class="p">%</span><span class="n">dbdiff</span> <span class="o">=</span> <span class="p">.</span><span class="n">FALSE</span><span class="p">.</span>
<a name="ln-1565"></a> <span class="n">ddt</span> <span class="o">=</span> <span class="mf">1.0e-5</span>  
<a name="ln-1566"></a><span class="c">! changed from 1.0e-10 on 08/14/15 by MDG in response to some issues with double</span>
<a name="ln-1567"></a><span class="c">! diffraction spots not being taken into account in EBSD master pattern simulations </span>
<a name="ln-1568"></a>
<a name="ln-1569"></a><span class="c">! next, we compute the overall lookup table cell%LUT; we do not, at this point, create a </span>
<a name="ln-1570"></a><span class="c">! list of linked reflections; in the old code, this was done at the same time, but it appears</span>
<a name="ln-1571"></a><span class="c">! it is better to decouple these two computations. In this new approach, we&#39;ll compute a much</span>
<a name="ln-1572"></a><span class="c">! shorter linked list based on the incident wave vector direction.</span>
<a name="ln-1573"></a>
<a name="ln-1574"></a><span class="c">! first, we deal with the transmitted beam</span>
<a name="ln-1575"></a> <span class="n">gg</span> <span class="o">=</span> <span class="p">(</span><span class="o">/</span> <span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span> <span class="o">/</span><span class="p">)</span>
<a name="ln-1576"></a> <span class="k">call </span><span class="n">CalcUcg</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span><span class="n">rlp</span><span class="p">,</span><span class="n">gg</span><span class="p">,</span><span class="n">applyqgshift</span><span class="o">=</span><span class="p">.</span><span class="n">TRUE</span><span class="p">.)</span>  
<a name="ln-1577"></a> <span class="n">Dyn</span><span class="p">%</span><span class="n">Upz</span> <span class="o">=</span> <span class="n">rlp</span><span class="p">%</span><span class="n">Vpmod</span>         <span class="c">! U&#39;0 normal absorption parameter </span>
<a name="ln-1578"></a> 
<a name="ln-1579"></a><span class="c">! and add this reflection to the look-up table</span>
<a name="ln-1580"></a> <span class="n">cell</span><span class="p">%</span><span class="n">LUT</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="o">=</span> <span class="n">rlp</span><span class="p">%</span><span class="n">Ucg</span>
<a name="ln-1581"></a> <span class="n">cell</span><span class="p">%</span><span class="n">LUTqg</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="o">=</span> <span class="n">rlp</span><span class="p">%</span><span class="n">qg</span>
<a name="ln-1582"></a>
<a name="ln-1583"></a><span class="c">! now do the same for the other allowed reflections</span>
<a name="ln-1584"></a><span class="c">! note that the lookup table must be twice as large as the list of participating reflections,</span>
<a name="ln-1585"></a><span class="c">! since the dynamical matrix uses g-h as its index !!!  </span>
<a name="ln-1586"></a><span class="n">ixl</span><span class="p">:</span> <span class="k">do </span><span class="n">ix</span><span class="o">=-</span><span class="mi">2</span><span class="o">*</span><span class="n">imh</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="n">imh</span>
<a name="ln-1587"></a><span class="n">iyl</span><span class="p">:</span>  <span class="k">do </span><span class="n">iy</span><span class="o">=-</span><span class="mi">2</span><span class="o">*</span><span class="n">imk</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="n">imk</span>
<a name="ln-1588"></a><span class="n">izl</span><span class="p">:</span>   <span class="k">do </span><span class="n">iz</span><span class="o">=-</span><span class="mi">2</span><span class="o">*</span><span class="n">iml</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="n">iml</span>
<a name="ln-1589"></a>        <span class="n">gg</span> <span class="o">=</span> <span class="p">(</span><span class="o">/</span> <span class="n">ix</span><span class="p">,</span> <span class="n">iy</span><span class="p">,</span> <span class="n">iz</span> <span class="o">/</span><span class="p">)</span>
<a name="ln-1590"></a>        <span class="k">if</span> <span class="p">(</span><span class="n">IsGAllowed</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span><span class="n">gg</span><span class="p">))</span> <span class="k">then</span>  <span class="c">! is this reflection allowed by lattice centering ?</span>
<a name="ln-1591"></a><span class="c">! add the reflection to the look up table</span>
<a name="ln-1592"></a>           <span class="k">call </span><span class="n">CalcUcg</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span><span class="n">rlp</span><span class="p">,</span><span class="n">gg</span><span class="p">,</span><span class="n">applyqgshift</span><span class="o">=</span><span class="p">.</span><span class="n">TRUE</span><span class="p">.)</span>
<a name="ln-1593"></a>           <span class="n">cell</span><span class="p">%</span><span class="n">LUT</span><span class="p">(</span><span class="n">ix</span><span class="p">,</span> <span class="n">iy</span><span class="p">,</span> <span class="n">iz</span><span class="p">)</span> <span class="o">=</span> <span class="n">rlp</span><span class="p">%</span><span class="n">Ucg</span>
<a name="ln-1594"></a>           <span class="n">cell</span><span class="p">%</span><span class="n">LUTqg</span><span class="p">(</span><span class="n">ix</span><span class="p">,</span> <span class="n">iy</span><span class="p">,</span> <span class="n">iz</span><span class="p">)</span> <span class="o">=</span> <span class="n">rlp</span><span class="p">%</span><span class="n">qg</span>
<a name="ln-1595"></a><span class="c">! flag this reflection as a double diffraction candidate if cabs(Ucg)&lt;ddt threshold</span>
<a name="ln-1596"></a>           <span class="k">if</span> <span class="p">(</span><span class="nb">cabs</span><span class="p">(</span><span class="n">rlp</span><span class="p">%</span><span class="n">Ucg</span><span class="p">).</span><span class="n">le</span><span class="p">.</span><span class="n">ddt</span><span class="p">)</span> <span class="k">then </span>
<a name="ln-1597"></a><span class="k">             </span><span class="n">cell</span><span class="p">%</span><span class="n">dbdiff</span><span class="p">(</span><span class="n">ix</span><span class="p">,</span><span class="n">iy</span><span class="p">,</span><span class="n">iz</span><span class="p">)</span> <span class="o">=</span> <span class="p">.</span><span class="n">TRUE</span><span class="p">.</span>
<a name="ln-1598"></a>           <span class="k">end if</span>
<a name="ln-1599"></a><span class="k">        end if</span> <span class="c">! IsGAllowed</span>
<a name="ln-1600"></a>       <span class="k">end do </span><span class="n">izl</span>
<a name="ln-1601"></a>      <span class="k">end do </span><span class="n">iyl</span>
<a name="ln-1602"></a>    <span class="k">end do </span><span class="n">ixl</span>
<a name="ln-1603"></a>
<a name="ln-1604"></a><span class="c">! determine the point group number</span>
<a name="ln-1605"></a> <span class="n">j</span><span class="o">=</span><span class="mi">0</span>
<a name="ln-1606"></a> <span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="mi">32</span>
<a name="ln-1607"></a>  <span class="k">if</span> <span class="p">(</span><span class="n">SGPG</span><span class="p">(</span><span class="n">i</span><span class="p">).</span><span class="n">le</span><span class="p">.</span><span class="n">cell</span><span class="p">%</span><span class="n">SYM_SGnum</span><span class="p">)</span> <span class="n">j</span><span class="o">=</span><span class="n">i</span>
<a name="ln-1608"></a> <span class="k">end do</span>
<a name="ln-1609"></a><span class="k"> </span><span class="n">isym</span> <span class="o">=</span> <span class="n">j</span>
<a name="ln-1610"></a>
<a name="ln-1611"></a><span class="c">! here is new code dealing with all the special cases (quite a few more compared to the </span>
<a name="ln-1612"></a><span class="c">! Laue group case)...  isym is the point group number. Once the symmetry case has been</span>
<a name="ln-1613"></a><span class="c">! fully determined (taking into account things like 31m and 3m1 an such), then the only places</span>
<a name="ln-1614"></a><span class="c">! that symmetry is handled are the modified Calckvectors routine, and the filling of the modified</span>
<a name="ln-1615"></a><span class="c">! Lambert projections after the dynamical simulation step.  We are also changing the name of the </span>
<a name="ln-1616"></a><span class="c">! sr array (or srhex) to mLPNH and mLPSH (modified Lambert Projection Northern/Southern Hemisphere).</span>
<a name="ln-1617"></a>
<a name="ln-1618"></a><span class="c">! Here, we encode isym into a new number that describes the sampling scheme; the new schemes are </span>
<a name="ln-1619"></a><span class="c">! described in detail in the EBSD manual pdf file.</span>
<a name="ln-1620"></a><span class="n">SamplingType</span> <span class="o">=</span> <span class="n">PGSamplingType</span><span class="p">(</span><span class="n">isym</span><span class="p">)</span>
<a name="ln-1621"></a>
<a name="ln-1622"></a><span class="c">! next, intercept the special cases (hexagonal vs. rhombohedral cases that require special treatment)</span>
<a name="ln-1623"></a><span class="k">if</span> <span class="p">((</span><span class="n">SamplingType</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="o">-</span><span class="mi">1</span><span class="p">).</span><span class="nb">or</span><span class="p">.(</span><span class="n">isym</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mi">14</span><span class="p">).</span><span class="nb">or</span><span class="p">.(</span><span class="n">isym</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mi">26</span><span class="p">))</span> <span class="k">then </span>
<a name="ln-1624"></a><span class="k">  </span><span class="n">SamplingType</span> <span class="o">=</span> <span class="n">getHexvsRho</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span><span class="n">isym</span><span class="p">)</span>
<a name="ln-1625"></a><span class="k">end if</span> 
<a name="ln-1626"></a>
<a name="ln-1627"></a><span class="c">! if the point group is trigonal or hexagonal, we need to switch usehex to .TRUE. so that</span>
<a name="ln-1628"></a><span class="c">! the program will use the hexagonal sampling method</span>
<a name="ln-1629"></a><span class="n">usehex</span> <span class="o">=</span> <span class="p">.</span><span class="n">FALSE</span><span class="p">.</span>
<a name="ln-1630"></a><span class="k">if</span> <span class="p">((</span><span class="n">cell</span><span class="p">%</span><span class="n">xtal_system</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mi">4</span><span class="p">).</span><span class="nb">or</span><span class="p">.(</span><span class="n">cell</span><span class="p">%</span><span class="n">xtal_system</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mi">5</span><span class="p">))</span> <span class="n">usehex</span> <span class="o">=</span> <span class="p">.</span><span class="n">TRUE</span><span class="p">.</span>
<a name="ln-1631"></a>
<a name="ln-1632"></a><span class="c">! ---------- end of symmetry and crystallography section</span>
<a name="ln-1633"></a><span class="c">!=============================================</span>
<a name="ln-1634"></a><span class="c">!=============================================</span>
<a name="ln-1635"></a>
<a name="ln-1636"></a><span class="c">!=============================================</span>
<a name="ln-1637"></a><span class="c">!=============================================</span>
<a name="ln-1638"></a><span class="c">! this is where we determine the value for the thickness integration limit for the CalcLgh3 routine...</span>
<a name="ln-1639"></a><span class="k">allocate</span><span class="p">(</span><span class="n">EkeVs</span><span class="p">(</span><span class="n">numEbins</span><span class="p">),</span><span class="n">thick</span><span class="p">(</span><span class="n">numEbins</span><span class="p">))</span>
<a name="ln-1640"></a>
<a name="ln-1641"></a><span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">numEbins</span>
<a name="ln-1642"></a>  <span class="n">EkeVs</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="n">Ehistmin</span> <span class="o">+</span> <span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">Ebinsize</span>
<a name="ln-1643"></a><span class="k">end do</span>
<a name="ln-1644"></a>
<a name="ln-1645"></a><span class="c">! then, for each energy determine the 95% histogram thickness</span>
<a name="ln-1646"></a><span class="n">izzmax</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-1647"></a><span class="k">do </span><span class="n">iE</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="n">numEbins</span>
<a name="ln-1648"></a> <span class="k">do </span><span class="n">ix</span><span class="o">=-</span><span class="n">nxten</span><span class="p">,</span><span class="n">nxten</span>
<a name="ln-1649"></a>  <span class="k">do </span><span class="n">iy</span><span class="o">=-</span><span class="n">nxten</span><span class="p">,</span><span class="n">nxten</span>
<a name="ln-1650"></a>   <span class="n">istat</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">accum_z</span><span class="p">(</span><span class="n">iE</span><span class="p">,:,</span><span class="n">ix</span><span class="p">,</span><span class="n">iy</span><span class="p">))</span>
<a name="ln-1651"></a>   <span class="n">izz</span> <span class="o">=</span> <span class="mi">1</span>
<a name="ln-1652"></a>   <span class="k">do while</span> <span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">accum_z</span><span class="p">(</span><span class="n">iE</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">izz</span><span class="p">,</span><span class="n">ix</span><span class="p">,</span><span class="n">iy</span><span class="p">)).</span><span class="n">lt</span><span class="p">.(</span><span class="mf">0.99</span><span class="o">*</span><span class="n">istat</span><span class="p">))</span> 
<a name="ln-1653"></a>    <span class="n">izz</span> <span class="o">=</span> <span class="n">izz</span><span class="o">+</span><span class="mi">1</span>
<a name="ln-1654"></a>   <span class="k">end do</span>
<a name="ln-1655"></a><span class="k">   if</span> <span class="p">(</span><span class="n">izz</span><span class="p">.</span><span class="n">gt</span><span class="p">.</span><span class="n">izzmax</span><span class="p">)</span> <span class="n">izzmax</span> <span class="o">=</span> <span class="n">izz</span>
<a name="ln-1656"></a>  <span class="k">end do</span>
<a name="ln-1657"></a><span class="k"> end do</span>
<a name="ln-1658"></a><span class="k"> </span><span class="n">thick</span><span class="p">(</span><span class="n">iE</span><span class="p">)</span> <span class="o">=</span> <span class="nb">dble</span><span class="p">(</span><span class="n">izzmax</span><span class="p">)</span> <span class="o">*</span> <span class="n">depthstep</span>
<a name="ln-1659"></a><span class="k">end do</span>
<a name="ln-1660"></a>
<a name="ln-1661"></a><span class="n">izz</span> <span class="o">=</span> <span class="nb">nint</span><span class="p">(</span><span class="nb">maxval</span><span class="p">(</span><span class="n">thick</span><span class="p">)</span><span class="o">/</span><span class="n">depthstep</span><span class="p">)</span>
<a name="ln-1662"></a><span class="k">allocate</span><span class="p">(</span><span class="n">lambdaE</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">numEbins</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">izz</span><span class="p">),</span><span class="nb">stat</span><span class="o">=</span><span class="n">istat</span><span class="p">)</span>
<a name="ln-1663"></a><span class="k">do </span><span class="n">iE</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">numEbins</span>
<a name="ln-1664"></a> <span class="k">do </span><span class="n">iz</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">izz</span>
<a name="ln-1665"></a>  <span class="n">lambdaE</span><span class="p">(</span><span class="n">iE</span><span class="p">,</span><span class="n">iz</span><span class="p">)</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">accum_z</span><span class="p">(</span><span class="n">iE</span><span class="p">,</span><span class="n">iz</span><span class="p">,</span><span class="o">-</span><span class="n">nxten</span><span class="p">:</span><span class="n">nxten</span><span class="p">,</span><span class="o">-</span><span class="n">nxten</span><span class="p">:</span><span class="n">nxten</span><span class="p">)))</span><span class="o">/</span><span class="n">etotal</span>
<a name="ln-1666"></a> <span class="k">end do</span>
<a name="ln-1667"></a><span class="k">end do</span>
<a name="ln-1668"></a>
<a name="ln-1669"></a><span class="c">! ---------- end of &#39;read Monte Carlo output file and extract necessary parameters&#39; section</span>
<a name="ln-1670"></a><span class="c">!=============================================</span>
<a name="ln-1671"></a><span class="c">!=============================================</span>
<a name="ln-1672"></a>
<a name="ln-1673"></a><span class="c">!=============================================</span>
<a name="ln-1674"></a><span class="c">!=============================================</span>
<a name="ln-1675"></a><span class="c">! ---------- a couple of initializations</span>
<a name="ln-1676"></a>   <span class="n">numset</span> <span class="o">=</span> <span class="n">cell</span> <span class="p">%</span> <span class="n">ATOM_ntype</span>  
<a name="ln-1677"></a>   <span class="n">npy</span> <span class="o">=</span> <span class="n">npx</span>
<a name="ln-1678"></a>   <span class="k">allocate</span><span class="p">(</span><span class="n">svals</span><span class="p">(</span><span class="n">numset</span><span class="p">),</span><span class="nb">stat</span><span class="o">=</span><span class="n">istat</span><span class="p">)</span>
<a name="ln-1679"></a>   <span class="n">gzero</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c">! index of incident beam</span>
<a name="ln-1680"></a>   <span class="n">debug</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c">! no longer used</span>
<a name="ln-1681"></a><span class="c">! ----------</span>
<a name="ln-1682"></a><span class="c">!=============================================</span>
<a name="ln-1683"></a><span class="c">!=============================================</span>
<a name="ln-1684"></a>
<a name="ln-1685"></a><span class="c">!=============================================</span>
<a name="ln-1686"></a><span class="c">!=============================================</span>
<a name="ln-1687"></a><span class="c">! ---------- allocate memory for the master patterns (done in calling program)</span>
<a name="ln-1688"></a><span class="c">! allocate(mLPNH(-emnl%npx:emnl%npx,-npy:npy,1,1:numset),stat=istat)</span>
<a name="ln-1689"></a><span class="c">! allocate(mLPSH(-emnl%npx:emnl%npx,-npy:npy,1,1:numset),stat=istat)</span>
<a name="ln-1690"></a>
<a name="ln-1691"></a><span class="c">! set various arrays to zero</span>
<a name="ln-1692"></a>   <span class="n">mLPNH</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-1693"></a>   <span class="n">mLPSH</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-1694"></a>
<a name="ln-1695"></a><span class="c">! force dynamical matrix routine to read new Bethe parameters from file</span>
<a name="ln-1696"></a><span class="c">! this will all be changed with the new version of the Bethe potentials</span>
<a name="ln-1697"></a><span class="c">! these parameters were already defined above, having been passed in </span>
<a name="ln-1698"></a><span class="c">! from the external calling program</span>
<a name="ln-1699"></a><span class="c">!  call Set_Bethe_Parameters(BetheParameters)</span>
<a name="ln-1700"></a>
<a name="ln-1701"></a><span class="c">! set the callback parameters</span>
<a name="ln-1702"></a><span class="n">dn</span> <span class="o">=</span> <span class="mi">1</span>
<a name="ln-1703"></a><span class="n">cn</span> <span class="o">=</span> <span class="n">dn</span>
<a name="ln-1704"></a><span class="n">cn2</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-1705"></a><span class="n">totn2</span> <span class="o">=</span> <span class="n">Estart</span>
<a name="ln-1706"></a>
<a name="ln-1707"></a><span class="c">!=============================================</span>
<a name="ln-1708"></a><span class="c">!=============================================</span>
<a name="ln-1709"></a><span class="c">! ---------- from here on, we need to repeat the entire computation for each energy value</span>
<a name="ln-1710"></a><span class="n">cancelerr</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-1711"></a><span class="n">energyloop</span><span class="p">:</span> <span class="k">do </span><span class="n">iE</span><span class="o">=</span><span class="n">Estart</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span>
<a name="ln-1712"></a>   <span class="n">cn2</span> <span class="o">=</span> <span class="n">cn2</span><span class="o">+</span><span class="n">dn</span> 
<a name="ln-1713"></a>
<a name="ln-1714"></a><span class="c">! set the accelerating voltage</span>
<a name="ln-1715"></a>   <span class="n">skip</span> <span class="o">=</span> <span class="mi">3</span>
<a name="ln-1716"></a>   <span class="n">cell</span><span class="p">%</span><span class="n">voltage</span> <span class="o">=</span> <span class="nb">dble</span><span class="p">(</span><span class="n">EkeVs</span><span class="p">(</span><span class="n">iE</span><span class="p">))</span>
<a name="ln-1717"></a>   <span class="k">call </span><span class="n">CalcWaveLength</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span> <span class="n">rlp</span><span class="p">,</span> <span class="n">skip</span><span class="p">)</span>
<a name="ln-1718"></a>
<a name="ln-1719"></a><span class="c">!=============================================</span>
<a name="ln-1720"></a><span class="c">! ---------- create the incident beam directions list</span>
<a name="ln-1721"></a><span class="c">! determine all independent incident beam directions (use a linked list starting at khead)</span>
<a name="ln-1722"></a><span class="c">! numk is the total number of k-vectors to be included in this computation;</span>
<a name="ln-1723"></a><span class="c">! note that this needs to be redone for each energy, since the wave vector changes with energy</span>
<a name="ln-1724"></a>   <span class="k">nullify</span><span class="p">(</span><span class="n">khead</span><span class="p">)</span>
<a name="ln-1725"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">usehex</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1726"></a><span class="k">    call </span><span class="n">Calckvectors</span><span class="p">(</span><span class="n">khead</span><span class="p">,</span><span class="n">cell</span><span class="p">,</span> <span class="p">(</span><span class="o">/</span> <span class="mf">0.D0</span><span class="p">,</span> <span class="mf">0.D0</span><span class="p">,</span> <span class="mf">1.D0</span> <span class="o">/</span><span class="p">),</span> <span class="p">(</span><span class="o">/</span> <span class="mf">0.D0</span><span class="p">,</span> <span class="mf">0.D0</span><span class="p">,</span> <span class="mf">0.D0</span> <span class="o">/</span><span class="p">),</span><span class="mf">0.D0</span><span class="p">,</span><span class="n">npx</span><span class="p">,</span><span class="n">npy</span><span class="p">,</span><span class="n">numk</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-1727"></a>                <span class="n">SamplingType</span><span class="p">,</span><span class="n">ijmax</span><span class="p">,</span><span class="s1">&#39;RoscaLambert&#39;</span><span class="p">,</span><span class="n">usehex</span><span class="p">)</span>
<a name="ln-1728"></a>   <span class="k">else </span>
<a name="ln-1729"></a><span class="k">    call </span><span class="n">Calckvectors</span><span class="p">(</span><span class="n">khead</span><span class="p">,</span><span class="n">cell</span><span class="p">,</span> <span class="p">(</span><span class="o">/</span> <span class="mf">0.D0</span><span class="p">,</span> <span class="mf">0.D0</span><span class="p">,</span> <span class="mf">1.D0</span> <span class="o">/</span><span class="p">),</span> <span class="p">(</span><span class="o">/</span> <span class="mf">0.D0</span><span class="p">,</span> <span class="mf">0.D0</span><span class="p">,</span> <span class="mf">0.D0</span> <span class="o">/</span><span class="p">),</span><span class="mf">0.D0</span><span class="p">,</span><span class="n">npx</span><span class="p">,</span><span class="n">npy</span><span class="p">,</span><span class="n">numk</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-1730"></a>                <span class="n">SamplingType</span><span class="p">,</span><span class="n">ijmax</span><span class="p">,</span><span class="s1">&#39;RoscaLambert&#39;</span><span class="p">,</span><span class="n">usehex</span><span class="p">)</span>
<a name="ln-1731"></a>   <span class="k">end if</span>
<a name="ln-1732"></a><span class="k">   </span><span class="n">totn</span> <span class="o">=</span> <span class="n">numk</span>
<a name="ln-1733"></a>   <span class="n">cn</span> <span class="o">=</span> <span class="n">dn</span>
<a name="ln-1734"></a>
<a name="ln-1735"></a><span class="c">! convert part of the kvector linked list into arrays for OpenMP</span>
<a name="ln-1736"></a>  <span class="k">allocate</span><span class="p">(</span><span class="n">karray</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="n">numk</span><span class="p">),</span> <span class="n">kij</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="n">numk</span><span class="p">),</span><span class="nb">stat</span><span class="o">=</span><span class="n">istat</span><span class="p">)</span>
<a name="ln-1737"></a><span class="c">! point to the first beam direction</span>
<a name="ln-1738"></a>  <span class="n">ktmp</span> <span class="o">=&gt;</span> <span class="n">khead</span>
<a name="ln-1739"></a><span class="c">! and loop through the list, keeping k, kn, and i,j</span>
<a name="ln-1740"></a>  <span class="n">karray</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="nb">sngl</span><span class="p">(</span><span class="n">ktmp</span><span class="p">%</span><span class="n">k</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">))</span>
<a name="ln-1741"></a>  <span class="n">karray</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="nb">sngl</span><span class="p">(</span><span class="n">ktmp</span><span class="p">%</span><span class="n">kn</span><span class="p">)</span>
<a name="ln-1742"></a>  <span class="n">kij</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="o">/</span> <span class="n">ktmp</span><span class="p">%</span><span class="n">i</span><span class="p">,</span> <span class="n">ktmp</span><span class="p">%</span><span class="n">j</span><span class="p">,</span> <span class="n">ktmp</span><span class="p">%</span><span class="n">hs</span> <span class="o">/</span><span class="p">)</span>
<a name="ln-1743"></a>   <span class="k">do </span><span class="n">ik</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">numk</span>
<a name="ln-1744"></a>     <span class="n">ktmp</span> <span class="o">=&gt;</span> <span class="n">ktmp</span><span class="p">%</span><span class="n">next</span>
<a name="ln-1745"></a>     <span class="n">karray</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span><span class="n">ik</span><span class="p">)</span> <span class="o">=</span> <span class="nb">sngl</span><span class="p">(</span><span class="n">ktmp</span><span class="p">%</span><span class="n">k</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">))</span>
<a name="ln-1746"></a>     <span class="n">karray</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="n">ik</span><span class="p">)</span> <span class="o">=</span> <span class="nb">sngl</span><span class="p">(</span><span class="n">ktmp</span><span class="p">%</span><span class="n">kn</span><span class="p">)</span>
<a name="ln-1747"></a>     <span class="n">kij</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span><span class="n">ik</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="o">/</span> <span class="n">ktmp</span><span class="p">%</span><span class="n">i</span><span class="p">,</span> <span class="n">ktmp</span><span class="p">%</span><span class="n">j</span><span class="p">,</span> <span class="n">ktmp</span><span class="p">%</span><span class="n">hs</span> <span class="o">/</span><span class="p">)</span>
<a name="ln-1748"></a>   <span class="k">end do</span>
<a name="ln-1749"></a><span class="c">! and remove the linked list</span>
<a name="ln-1750"></a>  <span class="k">call </span><span class="n">Delete_kvectorlist</span><span class="p">(</span><span class="n">khead</span><span class="p">)</span>
<a name="ln-1751"></a>
<a name="ln-1752"></a>  <span class="n">verbose</span> <span class="o">=</span> <span class="p">.</span><span class="n">FALSE</span><span class="p">.</span>
<a name="ln-1753"></a>  <span class="n">totstrong</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-1754"></a>  <span class="n">totweak</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-1755"></a>
<a name="ln-1756"></a><span class="c">! ---------- end of &quot;create the incident beam directions list&quot;</span>
<a name="ln-1757"></a><span class="c">!=============================================</span>
<a name="ln-1758"></a>
<a name="ln-1759"></a><span class="c">! here&#39;s where we introduce the OpenMP calls, to spead up the overall calculations...</span>
<a name="ln-1760"></a>
<a name="ln-1761"></a><span class="c">! set the number of OpenMP threads </span>
<a name="ln-1762"></a>  <span class="k">call </span><span class="n">OMP_SET_NUM_THREADS</span><span class="p">(</span><span class="n">nthreads</span><span class="p">)</span>
<a name="ln-1763"></a>
<a name="ln-1764"></a><span class="c">! use OpenMP to run on multiple cores ... </span>
<a name="ln-1765"></a><span class="c">!$OMP PARALLEL COPYIN(rlp) &amp;</span>
<a name="ln-1766"></a><span class="c">!$OMP&amp; PRIVATE(DynMat,Sgh,Lgh,ik,FN,TID,kn,ipx,ipy,ix,iequiv,nequiv,reflist,firstw) &amp;</span>
<a name="ln-1767"></a><span class="c">!$OMP&amp; PRIVATE(kkk,nns,nnw,nref,svals,nat) SHARED(cancelerr)</span>
<a name="ln-1768"></a>
<a name="ln-1769"></a>  <span class="n">NUMTHREADS</span> <span class="o">=</span> <span class="n">OMP_GET_NUM_THREADS</span><span class="p">()</span>
<a name="ln-1770"></a>  <span class="n">TID</span> <span class="o">=</span> <span class="n">OMP_GET_THREAD_NUM</span><span class="p">()</span>
<a name="ln-1771"></a>
<a name="ln-1772"></a>
<a name="ln-1773"></a><span class="c">!$OMP DO SCHEDULE(DYNAMIC,100)    </span>
<a name="ln-1774"></a><span class="c">! ---------- and here we start the beam direction loop</span>
<a name="ln-1775"></a>   <span class="n">beamloop</span><span class="p">:</span><span class="k">do </span><span class="n">ik</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="n">numk</span>
<a name="ln-1776"></a>
<a name="ln-1777"></a><span class="c">!=============================================</span>
<a name="ln-1778"></a><span class="c">! ---------- create the master reflection list for this beam direction</span>
<a name="ln-1779"></a><span class="c">! Then we must determine the masterlist of reflections (also a linked list);</span>
<a name="ln-1780"></a><span class="c">! This list basically samples a large reciprocal space volume; it does not </span>
<a name="ln-1781"></a><span class="c">! distinguish between zero and higher order Laue zones, since that </span>
<a name="ln-1782"></a><span class="c">! distinction becomes meaningless when we consider the complete </span>
<a name="ln-1783"></a><span class="c">! reciprocal lattice.  </span>
<a name="ln-1784"></a>     <span class="k">nullify</span><span class="p">(</span><span class="n">reflist</span><span class="p">)</span>
<a name="ln-1785"></a>     <span class="n">kkk</span> <span class="o">=</span> <span class="n">karray</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span><span class="n">ik</span><span class="p">)</span>
<a name="ln-1786"></a>     <span class="n">FN</span> <span class="o">=</span> <span class="n">kkk</span>
<a name="ln-1787"></a>
<a name="ln-1788"></a>     <span class="k">call </span><span class="n">Initialize_ReflectionList</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span> <span class="n">reflist</span><span class="p">,</span> <span class="n">BetheParameters</span><span class="p">,</span> <span class="n">FN</span><span class="p">,</span> <span class="n">kkk</span><span class="p">,</span> <span class="nb">sngl</span><span class="p">(</span><span class="nb">dmin</span><span class="p">),</span> <span class="n">nref</span><span class="p">)</span>
<a name="ln-1789"></a><span class="c">! ---------- end of &quot;create the master reflection list&quot;</span>
<a name="ln-1790"></a><span class="c">!=============================================</span>
<a name="ln-1791"></a>
<a name="ln-1792"></a>
<a name="ln-1793"></a><span class="c">! determine strong and weak reflections</span>
<a name="ln-1794"></a>     <span class="k">nullify</span><span class="p">(</span><span class="n">firstw</span><span class="p">)</span>
<a name="ln-1795"></a>     <span class="n">nns</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-1796"></a>     <span class="n">nnw</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-1797"></a>     <span class="k">call </span><span class="n">Apply_BethePotentials</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span> <span class="n">reflist</span><span class="p">,</span> <span class="n">firstw</span><span class="p">,</span> <span class="n">BetheParameters</span><span class="p">,</span> <span class="n">nref</span><span class="p">,</span> <span class="n">nns</span><span class="p">,</span> <span class="n">nnw</span><span class="p">)</span>
<a name="ln-1798"></a>
<a name="ln-1799"></a><span class="c">! generate the dynamical matrix</span>
<a name="ln-1800"></a>     <span class="k">allocate</span><span class="p">(</span><span class="n">DynMat</span><span class="p">(</span><span class="n">nns</span><span class="p">,</span><span class="n">nns</span><span class="p">))</span>
<a name="ln-1801"></a>     <span class="k">call </span><span class="n">GetDynMat</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span> <span class="n">reflist</span><span class="p">,</span> <span class="n">firstw</span><span class="p">,</span> <span class="n">rlp</span><span class="p">,</span> <span class="n">DynMat</span><span class="p">,</span> <span class="n">nns</span><span class="p">,</span> <span class="n">nnw</span><span class="p">)</span>
<a name="ln-1802"></a>     <span class="n">totstrong</span> <span class="o">=</span> <span class="n">totstrong</span> <span class="o">+</span> <span class="n">nns</span>
<a name="ln-1803"></a>     <span class="n">totweak</span> <span class="o">=</span> <span class="n">totweak</span> <span class="o">+</span> <span class="n">nnw</span>
<a name="ln-1804"></a>
<a name="ln-1805"></a><span class="c">! then we need to initialize the Sgh and Lgh arrays</span>
<a name="ln-1806"></a>     <span class="k">if</span> <span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">Sgh</span><span class="p">))</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">Sgh</span><span class="p">)</span>
<a name="ln-1807"></a>     <span class="k">if</span> <span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">Lgh</span><span class="p">))</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">Lgh</span><span class="p">)</span>
<a name="ln-1808"></a>     <span class="k">allocate</span><span class="p">(</span><span class="n">Sgh</span><span class="p">(</span><span class="n">nns</span><span class="p">,</span><span class="n">nns</span><span class="p">,</span><span class="n">numset</span><span class="p">),</span><span class="n">Lgh</span><span class="p">(</span><span class="n">nns</span><span class="p">,</span><span class="n">nns</span><span class="p">))</span>
<a name="ln-1809"></a>     <span class="n">Sgh</span> <span class="o">=</span> <span class="n">czero</span>
<a name="ln-1810"></a>     <span class="n">Lgh</span> <span class="o">=</span> <span class="n">czero</span>
<a name="ln-1811"></a>     <span class="n">nat</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-1812"></a>     <span class="k">call </span><span class="n">CalcSgh</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span><span class="n">reflist</span><span class="p">,</span><span class="n">nns</span><span class="p">,</span><span class="n">numset</span><span class="p">,</span><span class="n">Sgh</span><span class="p">,</span><span class="n">nat</span><span class="p">)</span>
<a name="ln-1813"></a>
<a name="ln-1814"></a><span class="c">! solve the dynamical eigenvalue equation for this beam direction  </span>
<a name="ln-1815"></a>     <span class="n">kn</span> <span class="o">=</span> <span class="n">karray</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="n">ik</span><span class="p">)</span>
<a name="ln-1816"></a>     <span class="k">call </span><span class="n">CalcLgh</span><span class="p">(</span><span class="n">DynMat</span><span class="p">,</span><span class="n">Lgh</span><span class="p">,</span><span class="nb">dble</span><span class="p">(</span><span class="n">thick</span><span class="p">(</span><span class="n">iE</span><span class="p">)),</span><span class="nb">dble</span><span class="p">(</span><span class="n">kn</span><span class="p">),</span><span class="n">nns</span><span class="p">,</span><span class="n">gzero</span><span class="p">,</span><span class="n">depthstep</span><span class="p">,</span><span class="n">lambdaE</span><span class="p">(</span><span class="n">iE</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">izzmax</span><span class="p">),</span><span class="n">izzmax</span><span class="p">)</span>
<a name="ln-1817"></a>     <span class="k">deallocate</span><span class="p">(</span><span class="n">DynMat</span><span class="p">)</span>
<a name="ln-1818"></a>
<a name="ln-1819"></a><span class="c">! sum over the element-wise (Hadamard) product of the Lgh and Sgh arrays </span>
<a name="ln-1820"></a>     <span class="n">svals</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-1821"></a>     <span class="k">do </span><span class="n">ix</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">numset</span>
<a name="ln-1822"></a>       <span class="n">svals</span><span class="p">(</span><span class="n">ix</span><span class="p">)</span> <span class="o">=</span> <span class="kt">real</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">Lgh</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">nns</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">nns</span><span class="p">)</span><span class="o">*</span><span class="n">Sgh</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">nns</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">nns</span><span class="p">,</span><span class="n">ix</span><span class="p">)))</span>
<a name="ln-1823"></a>     <span class="k">end do</span>
<a name="ln-1824"></a><span class="k">     </span><span class="n">svals</span> <span class="o">=</span> <span class="n">svals</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">nat</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">numset</span><span class="p">)))</span>
<a name="ln-1825"></a>
<a name="ln-1826"></a><span class="c">! and store the resulting svals values, applying point group symmetry where needed.</span>
<a name="ln-1827"></a>     <span class="n">ipx</span> <span class="o">=</span> <span class="n">kij</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">ik</span><span class="p">)</span>
<a name="ln-1828"></a>     <span class="n">ipy</span> <span class="o">=</span> <span class="n">kij</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="n">ik</span><span class="p">)</span>
<a name="ln-1829"></a>     <span class="n">ipz</span> <span class="o">=</span> <span class="n">kij</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="n">ik</span><span class="p">)</span>
<a name="ln-1830"></a><span class="c">!</span>
<a name="ln-1831"></a>     <span class="k">if</span> <span class="p">(</span><span class="n">usehex</span><span class="p">)</span> <span class="k">then </span>
<a name="ln-1832"></a><span class="k">       call </span><span class="n">Apply3DPGSymmetry</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span><span class="n">ipx</span><span class="p">,</span><span class="n">ipy</span><span class="p">,</span><span class="n">ipz</span><span class="p">,</span><span class="n">npx</span><span class="p">,</span><span class="n">iequiv</span><span class="p">,</span><span class="n">nequiv</span><span class="p">,</span><span class="n">usehex</span><span class="p">)</span>
<a name="ln-1833"></a>     <span class="k">else</span>
<a name="ln-1834"></a><span class="k">       if</span> <span class="p">((</span><span class="n">cell</span><span class="p">%</span><span class="n">SYM_SGnum</span><span class="p">.</span><span class="n">ge</span><span class="p">.</span><span class="mi">195</span><span class="p">).</span><span class="nb">and</span><span class="p">.(</span><span class="n">cell</span><span class="p">%</span><span class="n">SYM_SGnum</span><span class="p">.</span><span class="n">le</span><span class="p">.</span><span class="mi">230</span><span class="p">))</span> <span class="k">then</span>
<a name="ln-1835"></a><span class="k">         call </span><span class="n">Apply3DPGSymmetry</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span><span class="n">ipx</span><span class="p">,</span><span class="n">ipy</span><span class="p">,</span><span class="n">ipz</span><span class="p">,</span><span class="n">npx</span><span class="p">,</span><span class="n">iequiv</span><span class="p">,</span><span class="n">nequiv</span><span class="p">,</span><span class="n">cubictype</span><span class="o">=</span><span class="n">SamplingType</span><span class="p">)</span>
<a name="ln-1836"></a>       <span class="k">else</span>
<a name="ln-1837"></a><span class="k">         call </span><span class="n">Apply3DPGSymmetry</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span><span class="n">ipx</span><span class="p">,</span><span class="n">ipy</span><span class="p">,</span><span class="n">ipz</span><span class="p">,</span><span class="n">npx</span><span class="p">,</span><span class="n">iequiv</span><span class="p">,</span><span class="n">nequiv</span><span class="p">)</span>
<a name="ln-1838"></a>       <span class="k">end if</span>
<a name="ln-1839"></a><span class="k">     end if</span>
<a name="ln-1840"></a><span class="c">!$OMP CRITICAL</span>
<a name="ln-1841"></a>     <span class="k">do </span><span class="n">ix</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">nequiv</span>
<a name="ln-1842"></a>       <span class="k">if</span> <span class="p">(</span><span class="n">iequiv</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="n">ix</span><span class="p">).</span><span class="n">eq</span><span class="p">.</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="n">mLPSH</span><span class="p">(</span><span class="n">iequiv</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">ix</span><span class="p">),</span><span class="n">iequiv</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="n">ix</span><span class="p">),</span><span class="n">iE</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">numset</span><span class="p">)</span> <span class="o">=</span> <span class="n">svals</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">numset</span><span class="p">)</span>
<a name="ln-1843"></a>       <span class="k">if</span> <span class="p">(</span><span class="n">iequiv</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="n">ix</span><span class="p">).</span><span class="n">eq</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span> <span class="n">mLPNH</span><span class="p">(</span><span class="n">iequiv</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">ix</span><span class="p">),</span><span class="n">iequiv</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="n">ix</span><span class="p">),</span><span class="n">iE</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">numset</span><span class="p">)</span> <span class="o">=</span> <span class="n">svals</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">numset</span><span class="p">)</span>
<a name="ln-1844"></a>     <span class="k">end do</span>
<a name="ln-1845"></a><span class="c">!$OMP END CRITICAL</span>
<a name="ln-1846"></a>  
<a name="ln-1847"></a>     <span class="k">call </span><span class="n">Delete_gvectorlist</span><span class="p">(</span><span class="n">reflist</span><span class="p">)</span>
<a name="ln-1848"></a>
<a name="ln-1849"></a><span class="c">! has the cancel flag been set by the calling program ?</span>
<a name="ln-1850"></a><span class="c">!!!!$OMP CANCELLATION POINT</span>
<a name="ln-1851"></a>    <span class="k">if</span><span class="p">(</span><span class="n">cancel</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="nb">char</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span> <span class="k">then</span>
<a name="ln-1852"></a><span class="c">!$OMP ATOMIC WRITE</span>
<a name="ln-1853"></a>       <span class="n">cancelerr</span> <span class="o">=</span> <span class="mi">1</span>
<a name="ln-1854"></a><span class="c">!$OMP CANCEL DO</span>
<a name="ln-1855"></a>    <span class="k">end if</span> 
<a name="ln-1856"></a>
<a name="ln-1857"></a><span class="c">! update the progress counter and report it to the calling program via the proc callback routine</span>
<a name="ln-1858"></a><span class="c">!$OMP CRITICAL</span>
<a name="ln-1859"></a>   <span class="k">if</span><span class="p">(</span><span class="n">objAddress</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1860"></a><span class="k">     </span><span class="n">cn</span> <span class="o">=</span> <span class="n">cn</span><span class="o">+</span><span class="n">dn</span>
<a name="ln-1861"></a>     <span class="k">if</span> <span class="p">(</span><span class="nb">mod</span><span class="p">(</span><span class="n">cn</span><span class="p">,</span><span class="mi">1000</span><span class="p">).</span><span class="n">eq</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span> <span class="k">then </span>
<a name="ln-1862"></a><span class="k">       call </span><span class="n">proc</span><span class="p">(</span><span class="n">objAddress</span><span class="p">,</span> <span class="n">cn</span><span class="p">,</span> <span class="n">totn</span><span class="p">,</span> <span class="n">cn2</span><span class="p">,</span> <span class="n">totn2</span><span class="p">)</span>
<a name="ln-1863"></a>     <span class="k">end if</span>
<a name="ln-1864"></a><span class="k">   end if</span>
<a name="ln-1865"></a><span class="c">!$OMP END CRITICAL</span>
<a name="ln-1866"></a>
<a name="ln-1867"></a>    <span class="k">end do </span><span class="n">beamloop</span>
<a name="ln-1868"></a>
<a name="ln-1869"></a><span class="c">! end of OpenMP portion</span>
<a name="ln-1870"></a><span class="c">!$OMP END PARALLEL</span>
<a name="ln-1871"></a>  
<a name="ln-1872"></a><span class="c">! was the Cancel button pressed in the calling program?</span>
<a name="ln-1873"></a>  <span class="k">if</span><span class="p">(</span><span class="n">cancelerr</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span> <span class="k">EXIT </span><span class="n">energyloop</span>
<a name="ln-1874"></a>
<a name="ln-1875"></a>  <span class="k">deallocate</span><span class="p">(</span><span class="n">karray</span><span class="p">,</span> <span class="n">kij</span><span class="p">)</span>
<a name="ln-1876"></a>
<a name="ln-1877"></a> <span class="k">if</span> <span class="p">(</span><span class="n">usehex</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1878"></a><span class="c">! and finally, we convert the hexagonally sampled array to a square Lambert projection which will be used </span>
<a name="ln-1879"></a><span class="c">! for all EBSD pattern interpolations;  we need to do this for both the Northern and Southern hemispheres</span>
<a name="ln-1880"></a>
<a name="ln-1881"></a><span class="c">! we begin by allocating auxiliary arrays to hold copies of the hexagonal data; the original arrays will</span>
<a name="ln-1882"></a><span class="c">! then be overwritten with the newly interpolated data.</span>
<a name="ln-1883"></a>  <span class="k">allocate</span><span class="p">(</span><span class="n">auxNH</span><span class="p">(</span><span class="o">-</span><span class="n">npx</span><span class="p">:</span><span class="n">npx</span><span class="p">,</span><span class="o">-</span><span class="n">npy</span><span class="p">:</span><span class="n">npy</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">numset</span><span class="p">),</span><span class="nb">stat</span><span class="o">=</span><span class="n">istat</span><span class="p">)</span>
<a name="ln-1884"></a>  <span class="k">allocate</span><span class="p">(</span><span class="n">auxSH</span><span class="p">(</span><span class="o">-</span><span class="n">npx</span><span class="p">:</span><span class="n">npx</span><span class="p">,</span><span class="o">-</span><span class="n">npy</span><span class="p">:</span><span class="n">npy</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">numset</span><span class="p">),</span><span class="nb">stat</span><span class="o">=</span><span class="n">istat</span><span class="p">)</span>
<a name="ln-1885"></a>  <span class="n">auxNH</span> <span class="o">=</span> <span class="n">mLPNH</span><span class="p">(</span><span class="o">-</span><span class="n">npx</span><span class="p">:</span><span class="n">npx</span><span class="p">,</span><span class="o">-</span><span class="n">npy</span><span class="p">:</span><span class="n">npy</span><span class="p">,</span><span class="n">iE</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">numset</span><span class="p">)</span>
<a name="ln-1886"></a>  <span class="n">auxSH</span> <span class="o">=</span> <span class="n">mLPSH</span><span class="p">(</span><span class="o">-</span><span class="n">npx</span><span class="p">:</span><span class="n">npx</span><span class="p">,</span><span class="o">-</span><span class="n">npy</span><span class="p">:</span><span class="n">npy</span><span class="p">,</span><span class="n">iE</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">numset</span><span class="p">)</span>
<a name="ln-1887"></a>
<a name="ln-1888"></a><span class="c">! </span>
<a name="ln-1889"></a>  <span class="n">edge</span> <span class="o">=</span> <span class="mf">1.D0</span> <span class="o">/</span> <span class="nb">dble</span><span class="p">(</span><span class="n">npx</span><span class="p">)</span>
<a name="ln-1890"></a>  <span class="n">scl</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">npx</span><span class="p">)</span> 
<a name="ln-1891"></a>  <span class="k">do </span><span class="n">i</span><span class="o">=-</span><span class="n">npx</span><span class="p">,</span><span class="n">npx</span>
<a name="ln-1892"></a>    <span class="k">do </span><span class="n">j</span><span class="o">=-</span><span class="n">npy</span><span class="p">,</span><span class="n">npy</span>
<a name="ln-1893"></a><span class="c">! determine the spherical direction for this point</span>
<a name="ln-1894"></a>      <span class="n">xy</span> <span class="o">=</span> <span class="p">(</span><span class="o">/</span> <span class="nb">dble</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="nb">dble</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="o">/</span><span class="p">)</span> <span class="o">*</span> <span class="n">edge</span>
<a name="ln-1895"></a>      <span class="n">dc</span> <span class="o">=</span> <span class="n">LambertSquareToSphere</span><span class="p">(</span><span class="n">xy</span><span class="p">,</span> <span class="n">ierr</span><span class="p">)</span>
<a name="ln-1896"></a><span class="c">! convert direction cosines to hexagonal Lambert projections</span>
<a name="ln-1897"></a>      <span class="n">xy</span> <span class="o">=</span> <span class="n">scl</span> <span class="o">*</span> <span class="n">LambertSphereToHex</span><span class="p">(</span> <span class="n">dc</span><span class="p">,</span> <span class="n">ierr</span> <span class="p">)</span>
<a name="ln-1898"></a><span class="c">! interpolate intensity from the neighboring points</span>
<a name="ln-1899"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">ierr</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span> <span class="k">then </span>
<a name="ln-1900"></a><span class="k">        </span><span class="n">nix</span> <span class="o">=</span> <span class="nb">floor</span><span class="p">(</span><span class="n">xy</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
<a name="ln-1901"></a>        <span class="n">niy</span> <span class="o">=</span> <span class="nb">floor</span><span class="p">(</span><span class="n">xy</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
<a name="ln-1902"></a>        <span class="n">nixp</span> <span class="o">=</span> <span class="n">nix</span><span class="o">+</span><span class="mi">1</span>
<a name="ln-1903"></a>        <span class="n">niyp</span> <span class="o">=</span> <span class="n">niy</span><span class="o">+</span><span class="mi">1</span>
<a name="ln-1904"></a>        <span class="k">if</span> <span class="p">(</span><span class="n">nixp</span><span class="p">.</span><span class="n">gt</span><span class="p">.</span><span class="n">npx</span><span class="p">)</span> <span class="n">nixp</span> <span class="o">=</span> <span class="n">nix</span>
<a name="ln-1905"></a>        <span class="k">if</span> <span class="p">(</span><span class="n">niyp</span><span class="p">.</span><span class="n">gt</span><span class="p">.</span><span class="n">npx</span><span class="p">)</span> <span class="n">niyp</span> <span class="o">=</span> <span class="n">niy</span>
<a name="ln-1906"></a>        <span class="n">dx</span> <span class="o">=</span> <span class="n">xy</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">nix</span>
<a name="ln-1907"></a>        <span class="n">dy</span> <span class="o">=</span> <span class="n">xy</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="n">niy</span>
<a name="ln-1908"></a>        <span class="n">dxm</span> <span class="o">=</span> <span class="mf">1.D0</span> <span class="o">-</span> <span class="n">dx</span>
<a name="ln-1909"></a>        <span class="n">dym</span> <span class="o">=</span> <span class="mf">1.D0</span> <span class="o">-</span> <span class="n">dy</span>
<a name="ln-1910"></a>        <span class="n">mLPNH</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">iE</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">numset</span><span class="p">)</span> <span class="o">=</span> <span class="n">auxNH</span><span class="p">(</span><span class="n">nix</span><span class="p">,</span><span class="n">niy</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">numset</span><span class="p">)</span><span class="o">*</span><span class="n">dxm</span><span class="o">*</span><span class="n">dym</span> <span class="o">+</span> <span class="n">auxNH</span><span class="p">(</span><span class="n">nixp</span><span class="p">,</span><span class="n">niy</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">numset</span><span class="p">)</span><span class="o">*</span><span class="n">dx</span><span class="o">*</span><span class="n">dym</span> <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-1911"></a>                             <span class="n">auxNH</span><span class="p">(</span><span class="n">nix</span><span class="p">,</span><span class="n">niyp</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">numset</span><span class="p">)</span><span class="o">*</span><span class="n">dxm</span><span class="o">*</span><span class="n">dy</span> <span class="o">+</span> <span class="n">auxNH</span><span class="p">(</span><span class="n">nixp</span><span class="p">,</span><span class="n">niyp</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">numset</span><span class="p">)</span><span class="o">*</span><span class="n">dx</span><span class="o">*</span><span class="n">dy</span>
<a name="ln-1912"></a>        <span class="n">mLPSH</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">iE</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">numset</span><span class="p">)</span> <span class="o">=</span> <span class="n">auxSH</span><span class="p">(</span><span class="n">nix</span><span class="p">,</span><span class="n">niy</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">numset</span><span class="p">)</span><span class="o">*</span><span class="n">dxm</span><span class="o">*</span><span class="n">dym</span> <span class="o">+</span> <span class="n">auxSH</span><span class="p">(</span><span class="n">nixp</span><span class="p">,</span><span class="n">niy</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">numset</span><span class="p">)</span><span class="o">*</span><span class="n">dx</span><span class="o">*</span><span class="n">dym</span> <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-1913"></a>                             <span class="n">auxSH</span><span class="p">(</span><span class="n">nix</span><span class="p">,</span><span class="n">niyp</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">numset</span><span class="p">)</span><span class="o">*</span><span class="n">dxm</span><span class="o">*</span><span class="n">dy</span> <span class="o">+</span> <span class="n">auxSH</span><span class="p">(</span><span class="n">nixp</span><span class="p">,</span><span class="n">niyp</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">numset</span><span class="p">)</span><span class="o">*</span><span class="n">dx</span><span class="o">*</span><span class="n">dy</span>
<a name="ln-1914"></a>      <span class="k">end if</span>
<a name="ln-1915"></a><span class="k">    end do</span>
<a name="ln-1916"></a><span class="k">  end do</span>
<a name="ln-1917"></a><span class="k">  deallocate</span><span class="p">(</span><span class="n">auxNH</span><span class="p">,</span> <span class="n">auxSH</span><span class="p">)</span>
<a name="ln-1918"></a> <span class="k">end if</span>
<a name="ln-1919"></a>
<a name="ln-1920"></a><span class="c">! make sure that the outer pixel rim of the mLPSH patterns is identical to</span>
<a name="ln-1921"></a><span class="c">! that of the mLPNH array.</span>
<a name="ln-1922"></a> <span class="n">mLPSH</span><span class="p">(</span><span class="o">-</span><span class="n">npx</span><span class="p">,</span><span class="o">-</span><span class="n">npx</span><span class="p">:</span><span class="n">npx</span><span class="p">,</span><span class="n">iE</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">numset</span><span class="p">)</span> <span class="o">=</span> <span class="n">mLPNH</span><span class="p">(</span><span class="o">-</span><span class="n">npx</span><span class="p">,</span><span class="o">-</span><span class="n">npx</span><span class="p">:</span><span class="n">npx</span><span class="p">,</span><span class="n">iE</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">numset</span><span class="p">)</span>
<a name="ln-1923"></a> <span class="n">mLPSH</span><span class="p">(</span> <span class="n">npx</span><span class="p">,</span><span class="o">-</span><span class="n">npx</span><span class="p">:</span><span class="n">npx</span><span class="p">,</span><span class="n">iE</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">numset</span><span class="p">)</span> <span class="o">=</span> <span class="n">mLPNH</span><span class="p">(</span> <span class="n">npx</span><span class="p">,</span><span class="o">-</span><span class="n">npx</span><span class="p">:</span><span class="n">npx</span><span class="p">,</span><span class="n">iE</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">numset</span><span class="p">)</span>
<a name="ln-1924"></a> <span class="n">mLPSH</span><span class="p">(</span><span class="o">-</span><span class="n">npx</span><span class="p">:</span><span class="n">npx</span><span class="p">,</span><span class="o">-</span><span class="n">npx</span><span class="p">,</span><span class="n">iE</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">numset</span><span class="p">)</span> <span class="o">=</span> <span class="n">mLPNH</span><span class="p">(</span><span class="o">-</span><span class="n">npx</span><span class="p">:</span><span class="n">npx</span><span class="p">,</span><span class="o">-</span><span class="n">npx</span><span class="p">,</span><span class="n">iE</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">numset</span><span class="p">)</span>
<a name="ln-1925"></a> <span class="n">mLPSH</span><span class="p">(</span><span class="o">-</span><span class="n">npx</span><span class="p">:</span><span class="n">npx</span><span class="p">,</span> <span class="n">npx</span><span class="p">,</span><span class="n">iE</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">numset</span><span class="p">)</span> <span class="o">=</span> <span class="n">mLPNH</span><span class="p">(</span><span class="o">-</span><span class="n">npx</span><span class="p">:</span><span class="n">npx</span><span class="p">,</span> <span class="n">npx</span><span class="p">,</span><span class="n">iE</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">numset</span><span class="p">)</span>
<a name="ln-1926"></a>
<a name="ln-1927"></a>
<a name="ln-1928"></a><span class="k">end do </span><span class="n">energyloop</span>
<a name="ln-1929"></a>
<a name="ln-1930"></a><span class="c">! that&#39;s the end of it...</span>
<a name="ln-1931"></a>
<a name="ln-1932"></a><span class="k">end subroutine </span><span class="n">EMsoftCgetEBSDmaster</span>
<a name="ln-1933"></a>
<a name="ln-1934"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-1935"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-1936"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-1937"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-1938"></a>
<a name="ln-1939"></a>
<a name="ln-1940"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-1941"></a><span class="c">!</span>
<a name="ln-1942"></a><span class="c">! SUBROUTINE:getEBSDPatterns</span>
<a name="ln-1943"></a><span class="c">!</span>
<a name="ln-1944"></a><span class="c">!&gt; @author Marc De Graef, Carnegie Mellon University</span>
<a name="ln-1945"></a><span class="c">!</span>
<a name="ln-1946"></a><span class="c">!&gt; @brief This function can be called as a standalone function to compute an EBSD pattern</span>
<a name="ln-1947"></a><span class="c">!</span>
<a name="ln-1948"></a><span class="c">!&gt; @etails The main purpose of this routine and its accompanying wrapper routine is to</span>
<a name="ln-1949"></a><span class="c">!&gt; provide a way for an external program to compute a channeling pattern.  The idea is that </span>
<a name="ln-1950"></a><span class="c">!&gt; all the necessary arrays and variables are passed in by reference as arguments, without</span>
<a name="ln-1951"></a><span class="c">!&gt; the need for the routine to fetch any other data from files etc...  The initial goal is</span>
<a name="ln-1952"></a><span class="c">!&gt; to have a function that can be called with the CALL_EXTERNAL mechanism in IDL or MatLab.</span>
<a name="ln-1953"></a><span class="c">!&gt; This routine should be called via the getEBSDPatternsWrapper routine!  For calls from</span>
<a name="ln-1954"></a><span class="c">!&gt; a C/C++ program, use the EMsoftCgetEBSDPatterns routine instead.</span>
<a name="ln-1955"></a><span class="c">!</span>
<a name="ln-1956"></a><span class="c">!&gt; @param ipar array with integer input parameters</span>
<a name="ln-1957"></a><span class="c">!&gt; @param fpar array with float input parameters</span>
<a name="ln-1958"></a><span class="c">!&gt; @param EBSDpattern output array</span>
<a name="ln-1959"></a><span class="c">!&gt; @param quats quaternion input array</span>
<a name="ln-1960"></a><span class="c">!&gt; @param accum_e array with Monte Carlo histogram</span>
<a name="ln-1961"></a><span class="c">!&gt; @param mLPNH Northern hemisphere master pattern</span>
<a name="ln-1962"></a><span class="c">!&gt; @param mLPSH Southern hemisphere master pattern</span>
<a name="ln-1963"></a><span class="c">!</span>
<a name="ln-1964"></a><span class="c">!&gt; @date 10/16/15 MDG 1.0 original</span>
<a name="ln-1965"></a><span class="c">!&gt; @date 11/02/15 MDG 1.1 simplification of the input variables</span>
<a name="ln-1966"></a><span class="c">!&gt; @date 11/04/15 MDG 1.2 added array of quaternions as input parameter; used complete mLPNH/SH arrays with local sum</span>
<a name="ln-1967"></a><span class="c">!&gt; @date 01/12/15 MDG 1.3 added arguments and functionality for interface with DREAM.3D and other calling programs</span>
<a name="ln-1968"></a><span class="c">!&gt; @date 01/13/15 MDG 1.4 after split with EMsoftCgetEBSDPatterns subroutine, removed DREAM.3D interfacing stuff</span>
<a name="ln-1969"></a><span class="c">!&gt; @date 07/10/16 MDG 1.5 added energy min/max parameters</span>
<a name="ln-1970"></a><span class="c">!&gt; @date 08/03/16 MDG 1.6 corrected normalizing issue in rgx,y,z arrays that causes NANs to be returned from Lambert projection routines</span>
<a name="ln-1971"></a><span class="c">!&gt; @date 08/R2516 MDG 1.7 added transfer optics barrel distortion to rgx,y,z arrays.</span>
<a name="ln-1972"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-1973"></a><span class="k">recursive subroutine </span><span class="n">getEBSDPatterns</span><span class="p">(</span><span class="n">ipar</span><span class="p">,</span> <span class="n">fpar</span><span class="p">,</span> <span class="n">EBSDpattern</span><span class="p">,</span> <span class="n">quats</span><span class="p">,</span> <span class="n">accum_e</span><span class="p">,</span> <span class="n">mLPNH</span><span class="p">,</span> <span class="n">mLPSH</span><span class="p">)</span>
<a name="ln-1974"></a><span class="c">!DEC$ ATTRIBUTES DLLEXPORT :: getEBSDPatterns</span>
<a name="ln-1975"></a>
<a name="ln-1976"></a><span class="c">! the input parameters are all part of a ipar and fpar input arrays instead of the usual namelist structure to</span>
<a name="ln-1977"></a><span class="c">! make this routine callable by external programs; for calls from  C/C++, use the EsoftCgetEBSDPatterns routine instead.  </span>
<a name="ln-1978"></a>
<a name="ln-1979"></a><span class="c">! The following is the mapping for the ipar and fpar arrays:</span>
<a name="ln-1980"></a><span class="c">!</span>
<a name="ln-1981"></a><span class="c">! ipar(1) = 2 if rgx, rgy, rgz detector arrays need to be computed, 1 if not (arrays will have save status)</span>
<a name="ln-1982"></a><span class="c">! ipar(2) = detnumsx</span>
<a name="ln-1983"></a><span class="c">! ipar(3) = detnumsy</span>
<a name="ln-1984"></a><span class="c">! ipar(4) = detnumEbins</span>
<a name="ln-1985"></a><span class="c">! ipar(5) = mcnsx</span>
<a name="ln-1986"></a><span class="c">! ipar(6) = mpnpx</span>
<a name="ln-1987"></a><span class="c">! ipar(7) = numset</span>
<a name="ln-1988"></a><span class="c">! ipar(8) = numquats</span>
<a name="ln-1989"></a><span class="c">! ipar(9) = Eminsel</span>
<a name="ln-1990"></a><span class="c">! ipar(10) = Emaxsel</span>
<a name="ln-1991"></a>
<a name="ln-1992"></a><span class="c">! fpar(1) = enl%xpc</span>
<a name="ln-1993"></a><span class="c">! fpar(2) = enl%ypc</span>
<a name="ln-1994"></a><span class="c">! fpar(3) = enl%delta</span>
<a name="ln-1995"></a><span class="c">! fpar(4) = enl%MCsig</span>
<a name="ln-1996"></a><span class="c">! fpar(5) = enl%omega</span>
<a name="ln-1997"></a><span class="c">! fpar(6) = enl%thetac</span>
<a name="ln-1998"></a><span class="c">! fpar(7) = enl%L</span>
<a name="ln-1999"></a><span class="c">! fpar(8) = enl%beamcurrent</span>
<a name="ln-2000"></a><span class="c">! fpar(9) = enl%dwelltime</span>
<a name="ln-2001"></a><span class="c">! fpar(10) = enl%alphaBD</span>
<a name="ln-2002"></a>
<a name="ln-2003"></a><span class="k">use </span><span class="n">local</span>
<a name="ln-2004"></a><span class="k">use </span><span class="n">constants</span>
<a name="ln-2005"></a><span class="k">use </span><span class="n">Lambert</span>
<a name="ln-2006"></a><span class="k">use </span><span class="n">quaternions</span>
<a name="ln-2007"></a><span class="k">use</span><span class="p">,</span><span class="k">INTRINSIC</span> <span class="kd">::</span> <span class="nb">ISO_C_BINDING</span>
<a name="ln-2008"></a>
<a name="ln-2009"></a><span class="k">IMPLICIT NONE</span>
<a name="ln-2010"></a>
<a name="ln-2011"></a><span class="kt">integer</span><span class="p">(</span><span class="kt">c_size_t</span><span class="p">),</span><span class="k">PARAMETER</span>             <span class="kd">::</span> <span class="n">nipar</span><span class="o">=</span><span class="mi">10</span>
<a name="ln-2012"></a><span class="kt">integer</span><span class="p">(</span><span class="kt">c_size_t</span><span class="p">),</span><span class="k">PARAMETER</span>             <span class="kd">::</span> <span class="n">nfpar</span><span class="o">=</span><span class="mi">10</span>
<a name="ln-2013"></a><span class="kt">integer</span><span class="p">(</span><span class="kt">c_size_t</span><span class="p">),</span><span class="k">PARAMETER</span>             <span class="kd">::</span> <span class="n">nq</span><span class="o">=</span><span class="mi">4</span>
<a name="ln-2014"></a><span class="kt">integer</span><span class="p">(</span><span class="kt">c_size_t</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>            <span class="kd">::</span> <span class="n">ipar</span><span class="p">(</span><span class="n">nipar</span><span class="p">)</span>
<a name="ln-2015"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>               <span class="kd">::</span> <span class="n">fpar</span><span class="p">(</span><span class="n">nfpar</span><span class="p">)</span>
<a name="ln-2016"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>               <span class="kd">::</span> <span class="n">quats</span><span class="p">(</span><span class="n">nq</span><span class="p">,</span><span class="n">ipar</span><span class="p">(</span><span class="mi">8</span><span class="p">))</span>
<a name="ln-2017"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>               <span class="kd">::</span> <span class="n">accum_e</span><span class="p">(</span><span class="n">ipar</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span><span class="o">-</span><span class="n">ipar</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span><span class="n">ipar</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span><span class="o">-</span><span class="n">ipar</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span><span class="n">ipar</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>
<a name="ln-2018"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>               <span class="kd">::</span> <span class="n">mLPNH</span><span class="p">(</span><span class="o">-</span><span class="n">ipar</span><span class="p">(</span><span class="mi">6</span><span class="p">):</span><span class="n">ipar</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span> <span class="o">-</span><span class="n">ipar</span><span class="p">(</span><span class="mi">6</span><span class="p">):</span><span class="n">ipar</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span> <span class="n">ipar</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="n">ipar</span><span class="p">(</span><span class="mi">7</span><span class="p">))</span>
<a name="ln-2019"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>               <span class="kd">::</span> <span class="n">mLPSH</span><span class="p">(</span><span class="o">-</span><span class="n">ipar</span><span class="p">(</span><span class="mi">6</span><span class="p">):</span><span class="n">ipar</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span> <span class="o">-</span><span class="n">ipar</span><span class="p">(</span><span class="mi">6</span><span class="p">):</span><span class="n">ipar</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span> <span class="n">ipar</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="n">ipar</span><span class="p">(</span><span class="mi">7</span><span class="p">))</span>
<a name="ln-2020"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">OUT</span><span class="p">)</span>              <span class="kd">::</span> <span class="n">EBSDpattern</span><span class="p">(</span><span class="n">ipar</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span><span class="n">ipar</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span><span class="n">ipar</span><span class="p">(</span><span class="mi">8</span><span class="p">))</span>
<a name="ln-2021"></a>
<a name="ln-2022"></a><span class="c">! variables that must potentially be saved for the next time this function is called</span>
<a name="ln-2023"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">),</span><span class="k">allocatable</span><span class="p">,</span><span class="k">save</span>         <span class="kd">::</span> <span class="n">accum_e_detector</span><span class="p">(:,:,:)</span>
<a name="ln-2024"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">),</span><span class="k">allocatable</span><span class="p">,</span><span class="k">save</span>         <span class="kd">::</span> <span class="n">rgx</span><span class="p">(:,:),</span> <span class="n">rgy</span><span class="p">(:,:),</span> <span class="n">rgz</span><span class="p">(:,:)</span>
<a name="ln-2025"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">),</span><span class="k">allocatable</span><span class="p">,</span><span class="k">save</span>         <span class="kd">::</span> <span class="n">mLPNHsum</span><span class="p">(:,:,:),</span> <span class="n">mLPSHsum</span><span class="p">(:,:,:)</span>
<a name="ln-2026"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">),</span><span class="k">save</span>                     <span class="kd">::</span> <span class="n">prefactor</span>
<a name="ln-2027"></a>
<a name="ln-2028"></a><span class="c">! other variables</span>
<a name="ln-2029"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">),</span><span class="k">allocatable</span>              <span class="kd">::</span> <span class="n">scin_x</span><span class="p">(:),</span> <span class="n">scin_y</span><span class="p">(:)</span>                 <span class="c">! scintillator coordinate arrays [microns]</span>
<a name="ln-2030"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">),</span><span class="k">parameter</span>                <span class="kd">::</span> <span class="n">dtor</span> <span class="o">=</span> <span class="mf">0.0174533</span>  <span class="c">! convert from degrees to radians</span>
<a name="ln-2031"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">)</span>                          <span class="kd">::</span> <span class="n">alp</span><span class="p">,</span> <span class="n">ca</span><span class="p">,</span> <span class="n">sa</span><span class="p">,</span> <span class="n">cw</span><span class="p">,</span> <span class="n">sw</span>
<a name="ln-2032"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">)</span>                          <span class="kd">::</span> <span class="n">L2</span><span class="p">,</span> <span class="n">Ls</span><span class="p">,</span> <span class="n">Lc</span><span class="p">,</span> <span class="n">pcxd</span><span class="p">,</span> <span class="n">pcyd</span><span class="p">,</span> <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span>     <span class="c">! distances</span>
<a name="ln-2033"></a><span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">irg</span><span class="p">)</span>                       <span class="kd">::</span> <span class="n">nix</span><span class="p">,</span> <span class="n">niy</span><span class="p">,</span> <span class="n">binx</span><span class="p">,</span> <span class="n">biny</span><span class="p">,</span>  <span class="n">nixp</span><span class="p">,</span> <span class="n">niyp</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">Emin</span><span class="p">,</span> <span class="n">Emax</span><span class="p">,</span> <span class="n">istat</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">ipx</span><span class="p">,</span> <span class="n">ipy</span> <span class="c">! various parameters</span>
<a name="ln-2034"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">)</span>                          <span class="kd">::</span> <span class="n">dc</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">scl</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">gam</span><span class="p">,</span> <span class="n">pcvec</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">dp</span><span class="p">,</span> <span class="n">calpha</span>           <span class="c">! direction cosine array</span>
<a name="ln-2035"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">)</span>                          <span class="kd">::</span> <span class="n">sx</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dxm</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">dym</span><span class="p">,</span> <span class="n">rhos</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">bindx</span>         <span class="c">! various parameters</span>
<a name="ln-2036"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">)</span>                          <span class="kd">::</span> <span class="n">ixy</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<a name="ln-2037"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">dbl</span><span class="p">),</span><span class="k">parameter</span>                <span class="kd">::</span> <span class="n">nAmpere</span> <span class="o">=</span> <span class="mf">6.241D+18</span> 
<a name="ln-2038"></a>
<a name="ln-2039"></a><span class="c">!====================================</span>
<a name="ln-2040"></a><span class="c">! ------ generate the detector rgx, rgy, rgz arrays if needed (calling program must decide this via ipar(1))</span>
<a name="ln-2041"></a><span class="c">!====================================</span>
<a name="ln-2042"></a><span class="k">if</span> <span class="p">(</span><span class="n">ipar</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="n">ge</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-2043"></a>
<a name="ln-2044"></a><span class="k"> if</span> <span class="p">((</span><span class="n">ipar</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="n">eq</span><span class="p">.</span><span class="mi">2</span><span class="p">).</span><span class="nb">or</span><span class="p">.(.</span><span class="nb">not</span><span class="p">.</span><span class="nb">allocated</span><span class="p">(</span><span class="n">mLPNHsum</span><span class="p">)))</span> <span class="k">then</span> <span class="c">! complete reset, including the mLPNHsum and mLPSHsum arrays</span>
<a name="ln-2045"></a>    <span class="k">if</span> <span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">mLPNHsum</span><span class="p">))</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">mLPNHsum</span><span class="p">)</span>
<a name="ln-2046"></a>    <span class="k">if</span> <span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">mLPSHsum</span><span class="p">))</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">mLPSHsum</span><span class="p">)</span>
<a name="ln-2047"></a>
<a name="ln-2048"></a>    <span class="k">allocate</span><span class="p">(</span><span class="n">mLPNHsum</span><span class="p">(</span><span class="o">-</span><span class="n">ipar</span><span class="p">(</span><span class="mi">6</span><span class="p">):</span><span class="n">ipar</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span> <span class="o">-</span><span class="n">ipar</span><span class="p">(</span><span class="mi">6</span><span class="p">):</span><span class="n">ipar</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span> <span class="n">ipar</span><span class="p">(</span><span class="mi">4</span><span class="p">)))</span>
<a name="ln-2049"></a>    <span class="k">allocate</span><span class="p">(</span><span class="n">mLPSHsum</span><span class="p">(</span><span class="o">-</span><span class="n">ipar</span><span class="p">(</span><span class="mi">6</span><span class="p">):</span><span class="n">ipar</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span> <span class="o">-</span><span class="n">ipar</span><span class="p">(</span><span class="mi">6</span><span class="p">):</span><span class="n">ipar</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span> <span class="n">ipar</span><span class="p">(</span><span class="mi">4</span><span class="p">)))</span>
<a name="ln-2050"></a>    <span class="n">mLPNHsum</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">mLPNH</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>
<a name="ln-2051"></a>    <span class="n">mLPSHsum</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">mLPSH</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>
<a name="ln-2052"></a>
<a name="ln-2053"></a> <span class="k">end if</span>
<a name="ln-2054"></a>
<a name="ln-2055"></a><span class="c">! This needs to be done only once for a given detector geometry (i.e., when ipar(1)=1 or larger)</span>
<a name="ln-2056"></a>  <span class="k">allocate</span><span class="p">(</span><span class="n">scin_x</span><span class="p">(</span><span class="n">ipar</span><span class="p">(</span><span class="mi">2</span><span class="p">)),</span><span class="n">scin_y</span><span class="p">(</span><span class="n">ipar</span><span class="p">(</span><span class="mi">3</span><span class="p">)),</span><span class="nb">stat</span><span class="o">=</span><span class="n">istat</span><span class="p">)</span>
<a name="ln-2057"></a>  
<a name="ln-2058"></a>  <span class="n">pcxd</span> <span class="o">=</span> <span class="n">fpar</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">fpar</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-2059"></a>  <span class="n">pcyd</span> <span class="o">=</span> <span class="n">fpar</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">fpar</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-2060"></a>
<a name="ln-2061"></a>  <span class="n">scin_x</span> <span class="o">=</span> <span class="o">-</span> <span class="p">(</span> <span class="n">fpar</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="nb">float</span><span class="p">(</span><span class="n">ipar</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span> <span class="p">)</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="o">-</span> <span class="p">(</span><span class="o">/</span> <span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">ipar</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span> <span class="o">/</span><span class="p">)</span> <span class="p">)</span> <span class="o">*</span> <span class="n">fpar</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-2062"></a>  <span class="n">scin_y</span> <span class="o">=</span> <span class="p">(</span> <span class="n">fpar</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="nb">float</span><span class="p">(</span><span class="n">ipar</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span> <span class="p">)</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="o">-</span> <span class="p">(</span><span class="o">/</span> <span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">ipar</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span> <span class="o">/</span><span class="p">)</span> <span class="p">)</span> <span class="o">*</span> <span class="n">fpar</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-2063"></a>
<a name="ln-2064"></a><span class="c">! auxiliary angle to rotate between reference frames</span>
<a name="ln-2065"></a>  <span class="n">alp</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">cPi</span> <span class="o">-</span> <span class="p">(</span><span class="n">fpar</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">-</span> <span class="n">fpar</span><span class="p">(</span><span class="mi">6</span><span class="p">))</span> <span class="o">*</span> <span class="n">dtor</span>
<a name="ln-2066"></a>  <span class="n">ca</span> <span class="o">=</span> <span class="nb">cos</span><span class="p">(</span><span class="n">alp</span><span class="p">)</span>
<a name="ln-2067"></a>  <span class="n">sa</span> <span class="o">=</span> <span class="nb">sin</span><span class="p">(</span><span class="n">alp</span><span class="p">)</span>
<a name="ln-2068"></a>
<a name="ln-2069"></a>  <span class="n">cw</span> <span class="o">=</span> <span class="nb">cos</span><span class="p">(</span><span class="n">fpar</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">*</span> <span class="n">dtor</span><span class="p">)</span>
<a name="ln-2070"></a>  <span class="n">sw</span> <span class="o">=</span> <span class="nb">sin</span><span class="p">(</span><span class="n">fpar</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">*</span> <span class="n">dtor</span><span class="p">)</span>
<a name="ln-2071"></a>
<a name="ln-2072"></a><span class="c">! compute auxilliary interpolation arrays</span>
<a name="ln-2073"></a>  <span class="k">if</span> <span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">rgx</span><span class="p">))</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">rgx</span><span class="p">,</span> <span class="n">rgy</span><span class="p">,</span> <span class="n">rgz</span><span class="p">)</span>
<a name="ln-2074"></a>
<a name="ln-2075"></a>  <span class="k">allocate</span><span class="p">(</span><span class="n">rgx</span><span class="p">(</span><span class="n">ipar</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span><span class="n">ipar</span><span class="p">(</span><span class="mi">3</span><span class="p">)),</span> <span class="n">rgy</span><span class="p">(</span><span class="n">ipar</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span><span class="n">ipar</span><span class="p">(</span><span class="mi">3</span><span class="p">)),</span> <span class="n">rgz</span><span class="p">(</span><span class="n">ipar</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span><span class="n">ipar</span><span class="p">(</span><span class="mi">3</span><span class="p">)))</span>
<a name="ln-2076"></a>
<a name="ln-2077"></a><span class="c">! do we need to perform a Barrel Distortion?</span>
<a name="ln-2078"></a><span class="c">! we will do this here by expanding/contracting the radial component of the </span>
<a name="ln-2079"></a><span class="c">! (rgx, rgy) to (rgx,rgy) * (1+alphaBD * (rgx^2+rgy^2))</span>
<a name="ln-2080"></a><span class="c">! in other words, we pre-distort the sampling grid with the barrel distortion.</span>
<a name="ln-2081"></a>
<a name="ln-2082"></a>  <span class="n">L2</span> <span class="o">=</span> <span class="n">fpar</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">*</span> <span class="n">fpar</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span>
<a name="ln-2083"></a>  <span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">ipar</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<a name="ln-2084"></a>    <span class="n">Ls</span> <span class="o">=</span> <span class="o">-</span><span class="n">sw</span> <span class="o">*</span> <span class="n">scin_x</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="o">+</span> <span class="n">fpar</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">*</span> <span class="n">cw</span>
<a name="ln-2085"></a>    <span class="n">Lc</span> <span class="o">=</span> <span class="n">cw</span> <span class="o">*</span> <span class="n">scin_x</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="o">+</span> <span class="n">fpar</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">*</span> <span class="n">sw</span>
<a name="ln-2086"></a>    <span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">ipar</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-2087"></a><span class="c">!    rhos = 1.0/sqrt(sx + scin_y(i)**2)</span>
<a name="ln-2088"></a>     <span class="n">rgx</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">scin_y</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">*</span> <span class="n">ca</span> <span class="o">+</span> <span class="n">sa</span> <span class="o">*</span> <span class="n">Ls</span><span class="p">)</span> <span class="c">! * rhos</span>
<a name="ln-2089"></a>     <span class="n">rgy</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="n">Lc</span> <span class="c">! * rhos</span>
<a name="ln-2090"></a>     <span class="n">rgz</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">sa</span> <span class="o">*</span> <span class="n">scin_y</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="n">ca</span> <span class="o">*</span> <span class="n">Ls</span><span class="p">)</span> <span class="c">! * rhos</span>
<a name="ln-2091"></a><span class="c">! apply Barrel Distortion ?</span>
<a name="ln-2092"></a>     <span class="k">if</span> <span class="p">(</span><span class="n">fpar</span><span class="p">(</span><span class="mi">10</span><span class="p">).</span><span class="n">ne</span><span class="p">.</span><span class="mf">0.0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-2093"></a><span class="c">! shift the components to the detector center coordinate frame</span>
<a name="ln-2094"></a>       <span class="n">xx</span> <span class="o">=</span> <span class="n">rgx</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">)</span><span class="o">-</span><span class="n">pcyd</span>
<a name="ln-2095"></a>       <span class="n">yy</span> <span class="o">=</span> <span class="n">rgy</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">)</span><span class="o">+</span><span class="n">pcxd</span>
<a name="ln-2096"></a><span class="c">! compute the distortion amount; the factor of 10^(-10) is inserted here...</span>
<a name="ln-2097"></a>       <span class="n">sx</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">+</span> <span class="mf">1.E-10</span> <span class="o">*</span> <span class="n">fpar</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">xx</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">yy</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> 
<a name="ln-2098"></a><span class="c">! and shift them back to the pattern center reference frame</span>
<a name="ln-2099"></a>       <span class="n">rgx</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="n">xx</span><span class="o">*</span><span class="n">sx</span><span class="o">+</span><span class="n">pcyd</span>
<a name="ln-2100"></a>       <span class="n">rgy</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="n">yy</span><span class="o">*</span><span class="n">sx</span><span class="o">-</span><span class="n">pcxd</span>
<a name="ln-2101"></a>     <span class="k">end if</span>
<a name="ln-2102"></a><span class="c">! make sure that these vectors are normalized !</span>
<a name="ln-2103"></a>     <span class="n">x</span> <span class="o">=</span> <span class="nb">sqrt</span><span class="p">(</span><span class="n">rgx</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">rgy</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">rgz</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
<a name="ln-2104"></a>     <span class="n">rgx</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="n">rgx</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">)</span> <span class="o">/</span> <span class="n">x</span>
<a name="ln-2105"></a>     <span class="n">rgy</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="n">rgy</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">)</span> <span class="o">/</span> <span class="n">x</span>
<a name="ln-2106"></a>     <span class="n">rgz</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="n">rgz</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">)</span> <span class="o">/</span> <span class="n">x</span>
<a name="ln-2107"></a>    <span class="k">end do</span>
<a name="ln-2108"></a><span class="k">  end do</span>
<a name="ln-2109"></a>
<a name="ln-2110"></a><span class="c">! test dump of rgx/y/z arrays to check for proper inclusion of barrel distortion:</span>
<a name="ln-2111"></a><span class="c">!open(unit=dataunit,file=&#39;rgxyz.data&#39;,status=&#39;unknown&#39;,form=&#39;unformatted&#39;)</span>
<a name="ln-2112"></a><span class="c">!write(dataunit) rgx</span>
<a name="ln-2113"></a><span class="c">!write(dataunit) rgy</span>
<a name="ln-2114"></a><span class="c">!write(dataunit) rgz</span>
<a name="ln-2115"></a><span class="c">!close(unit=dataunit,status=&#39;keep&#39;)</span>
<a name="ln-2116"></a>
<a name="ln-2117"></a><span class="c">! remove the auxiliary arrays scin_x and scin_y</span>
<a name="ln-2118"></a>  <span class="k">deallocate</span><span class="p">(</span><span class="n">scin_x</span><span class="p">,</span> <span class="n">scin_y</span><span class="p">)</span>
<a name="ln-2119"></a>
<a name="ln-2120"></a><span class="c">!====================================</span>
<a name="ln-2121"></a><span class="c">! ------ create the equivalent detector energy array</span>
<a name="ln-2122"></a><span class="c">!====================================</span>
<a name="ln-2123"></a><span class="c">! from the Monte Carlo energy data, we need to extract the relevant</span>
<a name="ln-2124"></a><span class="c">! entries for the detector geometry defined above.  </span>
<a name="ln-2125"></a>
<a name="ln-2126"></a><span class="c">! determine the scale factor for the Lambert interpolation; the square has</span>
<a name="ln-2127"></a><span class="c">! an edge length of 2 x sqrt(pi/2)</span>
<a name="ln-2128"></a>  <span class="n">scl</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">ipar</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span> 
<a name="ln-2129"></a>
<a name="ln-2130"></a><span class="c">! energy summation will go over all energy bins</span>
<a name="ln-2131"></a>  <span class="n">Emin</span> <span class="o">=</span> <span class="n">ipar</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span>
<a name="ln-2132"></a>  <span class="n">Emax</span> <span class="o">=</span> <span class="n">ipar</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<a name="ln-2133"></a>
<a name="ln-2134"></a>  <span class="k">if</span> <span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">accum_e_detector</span><span class="p">))</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">accum_e_detector</span><span class="p">)</span>
<a name="ln-2135"></a>
<a name="ln-2136"></a>  <span class="k">allocate</span><span class="p">(</span><span class="n">accum_e_detector</span><span class="p">(</span><span class="n">ipar</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span><span class="n">ipar</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span><span class="n">ipar</span><span class="p">(</span><span class="mi">3</span><span class="p">)))</span>
<a name="ln-2137"></a>
<a name="ln-2138"></a><span class="c">! correction of change in effective pixel area compared to equal-area Lambert projection</span>
<a name="ln-2139"></a>  <span class="n">alpha</span> <span class="o">=</span> <span class="nb">atan</span><span class="p">(</span><span class="n">fpar</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">/</span><span class="n">fpar</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span><span class="o">/</span><span class="nb">sqrt</span><span class="p">(</span><span class="nb">sngl</span><span class="p">(</span><span class="n">cPi</span><span class="p">)))</span>
<a name="ln-2140"></a>  <span class="n">ipx</span> <span class="o">=</span> <span class="n">ipar</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="nb">nint</span><span class="p">(</span><span class="n">fpar</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
<a name="ln-2141"></a>  <span class="n">ipy</span> <span class="o">=</span> <span class="n">ipar</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="nb">nint</span><span class="p">(</span><span class="n">fpar</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
<a name="ln-2142"></a>  
<a name="ln-2143"></a>  <span class="k">if</span> <span class="p">((</span><span class="nb">abs</span><span class="p">(</span><span class="n">ipy</span><span class="p">).</span><span class="n">gt</span><span class="p">.</span><span class="n">ipar</span><span class="p">(</span><span class="mi">3</span><span class="p">)).</span><span class="nb">or</span><span class="p">.(</span><span class="nb">abs</span><span class="p">(</span><span class="n">ipx</span><span class="p">).</span><span class="n">gt</span><span class="p">.</span><span class="n">ipar</span><span class="p">(</span><span class="mi">2</span><span class="p">)))</span> <span class="k">then </span>
<a name="ln-2144"></a><span class="k">    </span><span class="n">pcvec</span> <span class="o">=</span> <span class="p">(</span><span class="o">/</span><span class="n">pcyd</span><span class="o">*</span><span class="n">ca</span> <span class="o">+</span> <span class="n">pcxd</span><span class="o">*</span><span class="n">sa</span><span class="o">*</span><span class="n">sw</span> <span class="o">+</span> <span class="n">fpar</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span><span class="o">*</span><span class="n">cw</span><span class="o">*</span><span class="n">sa</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-2145"></a>             <span class="n">fpar</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span><span class="o">*</span><span class="n">sw</span> <span class="o">-</span> <span class="n">pcxd</span><span class="o">*</span><span class="n">cw</span><span class="p">,&amp;</span>
<a name="ln-2146"></a>             <span class="n">fpar</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span><span class="o">*</span><span class="n">ca</span><span class="o">*</span><span class="n">cw</span> <span class="o">+</span> <span class="n">pcxd</span><span class="o">*</span><span class="n">ca</span><span class="o">*</span><span class="n">sw</span> <span class="o">-</span> <span class="n">pcyd</span><span class="o">*</span><span class="n">sa</span><span class="o">/</span><span class="p">)</span>
<a name="ln-2147"></a>    <span class="n">pcvec</span> <span class="o">=</span> <span class="n">pcvec</span><span class="o">/</span><span class="nb">NORM2</span><span class="p">(</span><span class="n">pcvec</span><span class="p">)</span>
<a name="ln-2148"></a>  <span class="k">else</span>
<a name="ln-2149"></a><span class="k">    </span><span class="n">pcvec</span> <span class="o">=</span> <span class="p">(</span><span class="o">/</span> <span class="n">rgx</span><span class="p">(</span><span class="n">ipx</span><span class="p">,</span><span class="n">ipy</span><span class="p">),</span> <span class="n">rgy</span><span class="p">(</span><span class="n">ipx</span><span class="p">,</span><span class="n">ipy</span><span class="p">),</span> <span class="n">rgz</span><span class="p">(</span><span class="n">ipx</span><span class="p">,</span><span class="n">ipy</span><span class="p">)</span> <span class="o">/</span><span class="p">)</span>
<a name="ln-2150"></a>  <span class="k">end if</span>
<a name="ln-2151"></a>
<a name="ln-2152"></a><span class="k">  </span><span class="n">calpha</span> <span class="o">=</span> <span class="nb">cos</span><span class="p">(</span><span class="n">alpha</span><span class="p">)</span>
<a name="ln-2153"></a>  <span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">ipar</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<a name="ln-2154"></a>    <span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">ipar</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-2155"></a><span class="c">! do the coordinate transformation for this detector pixel</span>
<a name="ln-2156"></a>       <span class="n">dc</span> <span class="o">=</span> <span class="p">(</span><span class="o">/</span> <span class="n">rgx</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">),</span> <span class="n">rgy</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">),</span> <span class="n">rgz</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span> <span class="o">/</span><span class="p">)</span>
<a name="ln-2157"></a><span class="c">! make sure the third one is positive; if not, switch all </span>
<a name="ln-2158"></a>       <span class="k">if</span> <span class="p">(</span><span class="n">dc</span><span class="p">(</span><span class="mi">3</span><span class="p">).</span><span class="n">lt</span><span class="p">.</span><span class="mf">0.0</span><span class="p">)</span> <span class="n">dc</span> <span class="o">=</span> <span class="o">-</span><span class="n">dc</span>
<a name="ln-2159"></a><span class="c">! convert these direction cosines to coordinates in the Rosca-Lambert projection</span>
<a name="ln-2160"></a>        <span class="n">ixy</span> <span class="o">=</span> <span class="n">scl</span> <span class="o">*</span> <span class="n">LambertSphereToSquare</span><span class="p">(</span> <span class="n">dc</span><span class="p">,</span> <span class="n">istat</span> <span class="p">)</span>
<a name="ln-2161"></a>        <span class="n">x</span> <span class="o">=</span> <span class="n">ixy</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-2162"></a>        <span class="n">ixy</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">ixy</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<a name="ln-2163"></a>        <span class="n">ixy</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="n">x</span>
<a name="ln-2164"></a><span class="c">! four-point interpolation (bi-quadratic)</span>
<a name="ln-2165"></a>        <span class="n">nix</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ipar</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">+</span><span class="n">ixy</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="o">-</span><span class="n">ipar</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<a name="ln-2166"></a>        <span class="n">niy</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ipar</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">+</span><span class="n">ixy</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span><span class="o">-</span><span class="n">ipar</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<a name="ln-2167"></a>        <span class="n">nixp</span> <span class="o">=</span> <span class="n">nix</span><span class="o">+</span><span class="mi">1</span>
<a name="ln-2168"></a>        <span class="n">niyp</span> <span class="o">=</span> <span class="n">niy</span><span class="o">+</span><span class="mi">1</span>
<a name="ln-2169"></a>        <span class="k">if</span> <span class="p">(</span><span class="n">nix</span> <span class="p">.</span><span class="n">gt</span><span class="p">.</span> <span class="n">ipar</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span> <span class="n">nix</span> <span class="o">=</span> <span class="n">ipar</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<a name="ln-2170"></a>        <span class="k">if</span> <span class="p">(</span><span class="n">niy</span> <span class="p">.</span><span class="n">gt</span><span class="p">.</span> <span class="n">ipar</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span> <span class="n">niy</span> <span class="o">=</span> <span class="n">ipar</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<a name="ln-2171"></a>        <span class="k">if</span> <span class="p">(</span><span class="n">nix</span> <span class="p">.</span><span class="n">lt</span><span class="p">.</span> <span class="o">-</span><span class="n">ipar</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span> <span class="n">nix</span> <span class="o">=</span> <span class="o">-</span><span class="n">ipar</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<a name="ln-2172"></a>        <span class="k">if</span> <span class="p">(</span><span class="n">niy</span> <span class="p">.</span><span class="n">lt</span><span class="p">.</span> <span class="o">-</span><span class="n">ipar</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span> <span class="n">niy</span> <span class="o">=</span> <span class="o">-</span><span class="n">ipar</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<a name="ln-2173"></a>
<a name="ln-2174"></a>        <span class="k">if</span> <span class="p">(</span><span class="n">nixp</span> <span class="p">.</span><span class="n">gt</span><span class="p">.</span> <span class="n">ipar</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span> <span class="n">nixp</span> <span class="o">=</span> <span class="n">ipar</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<a name="ln-2175"></a>        <span class="k">if</span> <span class="p">(</span><span class="n">niyp</span> <span class="p">.</span><span class="n">gt</span><span class="p">.</span> <span class="n">ipar</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span> <span class="n">niyp</span> <span class="o">=</span> <span class="n">ipar</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<a name="ln-2176"></a>        <span class="k">if</span> <span class="p">(</span><span class="n">nixp</span> <span class="p">.</span><span class="n">lt</span><span class="p">.</span> <span class="o">-</span><span class="n">ipar</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span> <span class="n">nixp</span> <span class="o">=</span> <span class="o">-</span><span class="n">ipar</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<a name="ln-2177"></a>        <span class="k">if</span> <span class="p">(</span><span class="n">niyp</span> <span class="p">.</span><span class="n">lt</span><span class="p">.</span> <span class="o">-</span><span class="n">ipar</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span> <span class="n">niyp</span> <span class="o">=</span> <span class="o">-</span><span class="n">ipar</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<a name="ln-2178"></a>
<a name="ln-2179"></a>        <span class="n">dx</span> <span class="o">=</span> <span class="n">ixy</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">nix</span>
<a name="ln-2180"></a>        <span class="n">dy</span> <span class="o">=</span> <span class="n">ixy</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">-</span><span class="n">niy</span>
<a name="ln-2181"></a>        <span class="n">dxm</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">-</span><span class="n">dx</span>
<a name="ln-2182"></a>        <span class="n">dym</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">-</span><span class="n">dy</span>
<a name="ln-2183"></a><span class="c">! do the area correction for this detector pixel</span>
<a name="ln-2184"></a>        <span class="n">dp</span> <span class="o">=</span> <span class="nb">dot_product</span><span class="p">(</span><span class="n">pcvec</span><span class="p">,</span><span class="n">dc</span><span class="p">)</span>
<a name="ln-2185"></a>        <span class="k">if</span> <span class="p">((</span><span class="n">i</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="n">ipx</span><span class="p">).</span><span class="nb">and</span><span class="p">.(</span><span class="n">j</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="n">ipy</span><span class="p">))</span> <span class="k">then</span>
<a name="ln-2186"></a><span class="k">          </span><span class="n">gam</span> <span class="o">=</span> <span class="mf">0.25</span> 
<a name="ln-2187"></a>        <span class="k">else</span>
<a name="ln-2188"></a><span class="k">          </span><span class="n">gam</span> <span class="o">=</span> <span class="p">((</span><span class="n">calpha</span><span class="o">*</span><span class="n">calpha</span> <span class="o">+</span> <span class="n">dp</span><span class="o">*</span><span class="n">dp</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">)</span><span class="o">**</span><span class="mf">1.5</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">calpha</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.25</span>
<a name="ln-2189"></a>        <span class="k">end if</span>
<a name="ln-2190"></a><span class="c">! interpolate the intensity </span>
<a name="ln-2191"></a>        <span class="k">do </span><span class="n">k</span><span class="o">=</span> <span class="n">Emin</span><span class="p">,</span> <span class="n">Emax</span>
<a name="ln-2192"></a>          <span class="n">accum_e_detector</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span> <span class="o">=</span> <span class="n">gam</span> <span class="o">*</span> <span class="p">(</span><span class="n">accum_e</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">nix</span><span class="p">,</span><span class="n">niy</span><span class="p">)</span> <span class="o">*</span> <span class="n">dxm</span> <span class="o">*</span> <span class="n">dym</span> <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-2193"></a>                                    <span class="n">accum_e</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">nixp</span><span class="p">,</span><span class="n">niy</span><span class="p">)</span> <span class="o">*</span> <span class="n">dx</span> <span class="o">*</span> <span class="n">dym</span> <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-2194"></a>                                    <span class="n">accum_e</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">nix</span><span class="p">,</span><span class="n">niyp</span><span class="p">)</span> <span class="o">*</span> <span class="n">dxm</span> <span class="o">*</span> <span class="n">dy</span> <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-2195"></a>                                    <span class="n">accum_e</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">nixp</span><span class="p">,</span><span class="n">niyp</span><span class="p">)</span> <span class="o">*</span> <span class="n">dx</span> <span class="o">*</span> <span class="n">dy</span><span class="p">)</span>
<a name="ln-2196"></a>        <span class="k">end do</span>
<a name="ln-2197"></a><span class="k">    end do</span>
<a name="ln-2198"></a><span class="k">  end do </span>
<a name="ln-2199"></a><span class="k">  </span><span class="n">prefactor</span> <span class="o">=</span> <span class="mf">0.25D0</span> <span class="o">*</span> <span class="n">nAmpere</span> <span class="o">*</span> <span class="n">fpar</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span> <span class="o">*</span> <span class="n">fpar</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span>  <span class="o">*</span> <span class="mf">1.0D-15</span> <span class="o">/</span> <span class="nb">sum</span><span class="p">(</span><span class="n">accum_e_detector</span><span class="p">)</span>
<a name="ln-2200"></a><span class="k">end if</span>   <span class="c">! end of ipar(1)=1 test</span>
<a name="ln-2201"></a>
<a name="ln-2202"></a><span class="c">!open(unit=dataunit,file=&#39;TKDdetectorarray_dymod.data&#39;,status=&#39;unknown&#39;,form=&#39;unformatted&#39;)</span>
<a name="ln-2203"></a><span class="c">!write(dataunit) accum_e_detector</span>
<a name="ln-2204"></a><span class="c">!close(unit=dataunit,status=&#39;keep&#39;)</span>
<a name="ln-2205"></a>
<a name="ln-2206"></a><span class="c">! from here on, we simply compute the EBSD patterns by interpolation, using the saved arrays from above</span>
<a name="ln-2207"></a><span class="c">! no intensity scaling or anything else...other than multiplication by pre-factor</span>
<a name="ln-2208"></a><span class="c">! intensity scaling is left to the user of the calling program.</span>
<a name="ln-2209"></a>
<a name="ln-2210"></a><span class="c">! define some parameters and initialize EBSDpattern</span>
<a name="ln-2211"></a><span class="n">scl</span> <span class="o">=</span> <span class="nb">dble</span><span class="p">(</span><span class="n">ipar</span><span class="p">(</span><span class="mi">6</span><span class="p">))</span> 
<a name="ln-2212"></a><span class="n">EBSDpattern</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-2213"></a>
<a name="ln-2214"></a><span class="c">! here is the main loop over all quaternions</span>
<a name="ln-2215"></a><span class="n">quatloop</span><span class="p">:</span> <span class="k">do </span><span class="n">ip</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">ipar</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
<a name="ln-2216"></a>  <span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">ipar</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<a name="ln-2217"></a>    <span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">ipar</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-2218"></a><span class="c">! do the active coordinate transformation for this euler angle</span>
<a name="ln-2219"></a>      <span class="n">dc</span> <span class="o">=</span> <span class="n">quat_Lp</span><span class="p">(</span><span class="n">quats</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span><span class="n">ip</span><span class="p">),</span>  <span class="p">(</span><span class="o">/</span> <span class="n">rgx</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">),</span> <span class="n">rgy</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">),</span> <span class="n">rgz</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span> <span class="o">/</span><span class="p">)</span> <span class="p">)</span>
<a name="ln-2220"></a><span class="c">! normalize dc</span>
<a name="ln-2221"></a>      <span class="n">dc</span> <span class="o">=</span> <span class="n">dc</span><span class="o">/</span><span class="nb">sqrt</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">dc</span><span class="o">*</span><span class="n">dc</span><span class="p">))</span>
<a name="ln-2222"></a><span class="c">! convert these direction cosines to coordinates in the Rosca-Lambert projection (always square projection !!!)</span>
<a name="ln-2223"></a>      <span class="n">ixy</span> <span class="o">=</span> <span class="n">scl</span> <span class="o">*</span> <span class="n">LambertSphereToSquare</span><span class="p">(</span> <span class="n">dc</span><span class="p">,</span> <span class="n">istat</span> <span class="p">)</span>
<a name="ln-2224"></a>
<a name="ln-2225"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">istat</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span> <span class="k">then</span> 
<a name="ln-2226"></a><span class="c">! four-point interpolation (bi-quadratic)</span>
<a name="ln-2227"></a>        <span class="n">nix</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ipar</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span><span class="o">+</span><span class="n">ixy</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="o">-</span><span class="n">ipar</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
<a name="ln-2228"></a>        <span class="n">niy</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ipar</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span><span class="o">+</span><span class="n">ixy</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span><span class="o">-</span><span class="n">ipar</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
<a name="ln-2229"></a>        <span class="n">nixp</span> <span class="o">=</span> <span class="n">nix</span><span class="o">+</span><span class="mi">1</span>
<a name="ln-2230"></a>        <span class="n">niyp</span> <span class="o">=</span> <span class="n">niy</span><span class="o">+</span><span class="mi">1</span>
<a name="ln-2231"></a>        <span class="k">if</span> <span class="p">(</span><span class="n">nix</span> <span class="p">.</span><span class="n">gt</span><span class="p">.</span> <span class="n">ipar</span><span class="p">(</span><span class="mi">6</span><span class="p">))</span> <span class="n">nix</span> <span class="o">=</span> <span class="n">ipar</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
<a name="ln-2232"></a>        <span class="k">if</span> <span class="p">(</span><span class="n">niy</span> <span class="p">.</span><span class="n">gt</span><span class="p">.</span> <span class="n">ipar</span><span class="p">(</span><span class="mi">6</span><span class="p">))</span> <span class="n">niy</span> <span class="o">=</span> <span class="n">ipar</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
<a name="ln-2233"></a>        <span class="k">if</span> <span class="p">(</span><span class="n">nix</span> <span class="p">.</span><span class="n">lt</span><span class="p">.</span> <span class="o">-</span><span class="n">ipar</span><span class="p">(</span><span class="mi">6</span><span class="p">))</span> <span class="n">nix</span> <span class="o">=</span> <span class="o">-</span><span class="n">ipar</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
<a name="ln-2234"></a>        <span class="k">if</span> <span class="p">(</span><span class="n">niy</span> <span class="p">.</span><span class="n">lt</span><span class="p">.</span> <span class="o">-</span><span class="n">ipar</span><span class="p">(</span><span class="mi">6</span><span class="p">))</span> <span class="n">niy</span> <span class="o">=</span> <span class="o">-</span><span class="n">ipar</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
<a name="ln-2235"></a>
<a name="ln-2236"></a>        <span class="k">if</span> <span class="p">(</span><span class="n">nixp</span> <span class="p">.</span><span class="n">gt</span><span class="p">.</span> <span class="n">ipar</span><span class="p">(</span><span class="mi">6</span><span class="p">))</span> <span class="n">nixp</span> <span class="o">=</span> <span class="n">ipar</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
<a name="ln-2237"></a>        <span class="k">if</span> <span class="p">(</span><span class="n">niyp</span> <span class="p">.</span><span class="n">gt</span><span class="p">.</span> <span class="n">ipar</span><span class="p">(</span><span class="mi">6</span><span class="p">))</span> <span class="n">niyp</span> <span class="o">=</span> <span class="n">ipar</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
<a name="ln-2238"></a>        <span class="k">if</span> <span class="p">(</span><span class="n">nixp</span> <span class="p">.</span><span class="n">lt</span><span class="p">.</span> <span class="o">-</span><span class="n">ipar</span><span class="p">(</span><span class="mi">6</span><span class="p">))</span> <span class="n">nixp</span> <span class="o">=</span> <span class="o">-</span><span class="n">ipar</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
<a name="ln-2239"></a>        <span class="k">if</span> <span class="p">(</span><span class="n">niyp</span> <span class="p">.</span><span class="n">lt</span><span class="p">.</span> <span class="o">-</span><span class="n">ipar</span><span class="p">(</span><span class="mi">6</span><span class="p">))</span> <span class="n">niyp</span> <span class="o">=</span> <span class="o">-</span><span class="n">ipar</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
<a name="ln-2240"></a>
<a name="ln-2241"></a>        <span class="n">dx</span> <span class="o">=</span> <span class="n">ixy</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">nix</span>
<a name="ln-2242"></a>        <span class="n">dy</span> <span class="o">=</span> <span class="n">ixy</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">-</span><span class="n">niy</span>
<a name="ln-2243"></a>        <span class="n">dxm</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">-</span><span class="n">dx</span>
<a name="ln-2244"></a>        <span class="n">dym</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">-</span><span class="n">dy</span>
<a name="ln-2245"></a>        <span class="k">if</span> <span class="p">(</span><span class="n">dc</span><span class="p">(</span><span class="mi">3</span><span class="p">).</span><span class="n">gt</span><span class="p">.</span><span class="mf">0.0</span><span class="p">)</span> <span class="k">then</span> <span class="c">! we&#39;re in the Northern hemisphere</span>
<a name="ln-2246"></a>          <span class="k">do </span><span class="n">k</span><span class="o">=</span><span class="n">Emin</span><span class="p">,</span><span class="n">Emax</span>
<a name="ln-2247"></a>            <span class="n">EBSDpattern</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">ip</span><span class="p">)</span> <span class="o">=</span> <span class="n">EBSDpattern</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">ip</span><span class="p">)</span> <span class="o">+</span> <span class="n">accum_e_detector</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span> <span class="n">mLPNHsum</span><span class="p">(</span><span class="n">nix</span><span class="p">,</span><span class="n">niy</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">*</span> <span class="n">dxm</span> <span class="o">*</span> <span class="n">dym</span> <span class="o">+</span><span class="p">&amp;</span>
<a name="ln-2248"></a>                                        <span class="n">mLPNHsum</span><span class="p">(</span><span class="n">nixp</span><span class="p">,</span><span class="n">niy</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">*</span> <span class="n">dx</span> <span class="o">*</span> <span class="n">dym</span> <span class="o">+</span> <span class="n">mLPNHsum</span><span class="p">(</span><span class="n">nix</span><span class="p">,</span><span class="n">niyp</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">*</span> <span class="n">dxm</span> <span class="o">*</span> <span class="n">dy</span> <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-2249"></a>                                        <span class="n">mLPNHsum</span><span class="p">(</span><span class="n">nixp</span><span class="p">,</span><span class="n">niyp</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">*</span> <span class="n">dx</span> <span class="o">*</span> <span class="n">dy</span> <span class="p">)</span>
<a name="ln-2250"></a>          <span class="k">end do</span>
<a name="ln-2251"></a><span class="k">        else</span>                   <span class="c">! we&#39;re in the Southern hemisphere</span>
<a name="ln-2252"></a>          <span class="k">do </span><span class="n">k</span><span class="o">=</span><span class="n">Emin</span><span class="p">,</span><span class="n">Emax</span> 
<a name="ln-2253"></a>            <span class="n">EBSDpattern</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">ip</span><span class="p">)</span> <span class="o">=</span> <span class="n">EBSDpattern</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">ip</span><span class="p">)</span> <span class="o">+</span> <span class="n">accum_e_detector</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span> <span class="n">mLPSHsum</span><span class="p">(</span><span class="n">nix</span><span class="p">,</span><span class="n">niy</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">*</span> <span class="n">dxm</span> <span class="o">*</span> <span class="n">dym</span> <span class="o">+</span><span class="p">&amp;</span>
<a name="ln-2254"></a>                                        <span class="n">mLPSHsum</span><span class="p">(</span><span class="n">nixp</span><span class="p">,</span><span class="n">niy</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">*</span> <span class="n">dx</span> <span class="o">*</span> <span class="n">dym</span> <span class="o">+</span> <span class="n">mLPSHsum</span><span class="p">(</span><span class="n">nix</span><span class="p">,</span><span class="n">niyp</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">*</span> <span class="n">dxm</span> <span class="o">*</span> <span class="n">dy</span> <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-2255"></a>                                        <span class="n">mLPSHsum</span><span class="p">(</span><span class="n">nixp</span><span class="p">,</span><span class="n">niyp</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">*</span> <span class="n">dx</span> <span class="o">*</span> <span class="n">dy</span> <span class="p">)</span>
<a name="ln-2256"></a>          <span class="k">end do</span>
<a name="ln-2257"></a><span class="k">        end if</span>
<a name="ln-2258"></a><span class="k">      end if</span>
<a name="ln-2259"></a><span class="k">    end do</span>
<a name="ln-2260"></a><span class="k">  end do</span>
<a name="ln-2261"></a><span class="k">end do </span><span class="n">quatloop</span>
<a name="ln-2262"></a>
<a name="ln-2263"></a><span class="c">! finally, scale the patterns by the appropriate factor and return to the calling program</span>
<a name="ln-2264"></a><span class="n">EBSDpattern</span> <span class="o">=</span> <span class="n">prefactor</span> <span class="o">*</span> <span class="n">EBSDpattern</span>
<a name="ln-2265"></a>
<a name="ln-2266"></a><span class="k">end subroutine </span><span class="n">getEBSDPatterns</span>
<a name="ln-2267"></a>
<a name="ln-2268"></a>
<a name="ln-2269"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-2270"></a><span class="c">!</span>
<a name="ln-2271"></a><span class="c">! SUBROUTINE:getEBSDPatterns2</span>
<a name="ln-2272"></a><span class="c">!</span>
<a name="ln-2273"></a><span class="c">!&gt; @author Marc De Graef, Carnegie Mellon University</span>
<a name="ln-2274"></a><span class="c">!</span>
<a name="ln-2275"></a><span class="c">!&gt; @brief This function can be called as a standalone function to compute an EBSD pattern</span>
<a name="ln-2276"></a><span class="c">!</span>
<a name="ln-2277"></a><span class="c">!&gt; @etails The main purpose of this routine and its accompanying wrapper routine is to</span>
<a name="ln-2278"></a><span class="c">!&gt; provide a way for an external program to compute a channeling pattern.  The idea is that </span>
<a name="ln-2279"></a><span class="c">!&gt; all the necessary arrays and variables are passed in by reference as arguments, without</span>
<a name="ln-2280"></a><span class="c">!&gt; the need for the routine to fetch any other data from files etc...  The initial goal is</span>
<a name="ln-2281"></a><span class="c">!&gt; to have a function that can be called with the CALL_EXTERNAL mechanism in IDL or MatLab.</span>
<a name="ln-2282"></a><span class="c">!&gt; This routine should be called via the getEBSDPatternsWrapper routine!  For calls from</span>
<a name="ln-2283"></a><span class="c">!&gt; a C/C++ program, use the EMsoftCgetEBSDPatterns routine instead.  This routine is a slightly</span>
<a name="ln-2284"></a><span class="c">!&gt; modified version of the regular getEBSDPatterns routine and does not SAVE any variables.</span>
<a name="ln-2285"></a><span class="c">!</span>
<a name="ln-2286"></a><span class="c">!&gt; @param ipar array with integer input parameters</span>
<a name="ln-2287"></a><span class="c">!&gt; @param fpar array with float input parameters</span>
<a name="ln-2288"></a><span class="c">!&gt; @param EBSDpattern output array</span>
<a name="ln-2289"></a><span class="c">!&gt; @param quats quaternion input array</span>
<a name="ln-2290"></a><span class="c">!&gt; @param accum_e array with Monte Carlo histogram</span>
<a name="ln-2291"></a><span class="c">!&gt; @param mLPNH Northern hemisphere master pattern</span>
<a name="ln-2292"></a><span class="c">!&gt; @param mLPSH Southern hemisphere master pattern</span>
<a name="ln-2293"></a><span class="c">!</span>
<a name="ln-2294"></a><span class="c">!&gt; @date 10/16/15 MDG 1.0 original</span>
<a name="ln-2295"></a><span class="c">!&gt; @date 11/02/15 MDG 1.1 simplification of the input variables</span>
<a name="ln-2296"></a><span class="c">!&gt; @date 11/04/15 MDG 1.2 added array of quaternions as input parameter; used complete mLPNH/SH arrays with local sum</span>
<a name="ln-2297"></a><span class="c">!&gt; @date 01/12/15 MDG 1.3 added arguments and functionality for interface with DREAM.3D and other calling programs</span>
<a name="ln-2298"></a><span class="c">!&gt; @date 01/13/15 MDG 1.4 after split with EMsoftCgetEBSDPatterns subroutine, removed DREAM.3D interfacing stuff</span>
<a name="ln-2299"></a><span class="c">!&gt; @date 07/10/16 MDG 1.5 added energy min/max parameters</span>
<a name="ln-2300"></a><span class="c">!&gt; @date 08/03/16 MDG 1.6 corrected normalizing issue in rgx,y,z arrays that causes NANs to be returned from Lambert projection routines</span>
<a name="ln-2301"></a><span class="c">!&gt; @date 08/25/16 MDG 1.7 added transfer optics barrel distortion to rgx,y,z arrays.</span>
<a name="ln-2302"></a><span class="c">!&gt; @date 04/24/17 MDG 1.8 forked from original routine without SAVEd variables</span>
<a name="ln-2303"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-2304"></a><span class="k">recursive subroutine </span><span class="n">getEBSDPatterns2</span><span class="p">(</span><span class="n">ipar</span><span class="p">,</span> <span class="n">fpar</span><span class="p">,</span> <span class="n">EBSDpattern</span><span class="p">,</span> <span class="n">quats</span><span class="p">,</span> <span class="n">accum_e</span><span class="p">,</span> <span class="n">mLPNHsum</span><span class="p">,</span> <span class="n">mLPSHsum</span><span class="p">)</span>
<a name="ln-2305"></a><span class="c">!DEC$ ATTRIBUTES DLLEXPORT :: getEBSDPatterns2</span>
<a name="ln-2306"></a>
<a name="ln-2307"></a><span class="c">! the input parameters are all part of a ipar and fpar input arrays instead of the usual namelist structure to</span>
<a name="ln-2308"></a><span class="c">! make this routine callable by external programs; for calls from  C/C++, use the EsoftCgetEBSDPatterns routine instead.  </span>
<a name="ln-2309"></a>
<a name="ln-2310"></a><span class="c">! The following is the mapping for the ipar and fpar arrays:</span>
<a name="ln-2311"></a><span class="c">!</span>
<a name="ln-2312"></a><span class="c">! ipar(1) = 2 if rgx, rgy, rgz detector arrays need to be computed, 1 if not (arrays will have save status)</span>
<a name="ln-2313"></a><span class="c">! ipar(2) = detnumsx</span>
<a name="ln-2314"></a><span class="c">! ipar(3) = detnumsy</span>
<a name="ln-2315"></a><span class="c">! ipar(4) = detnumEbins</span>
<a name="ln-2316"></a><span class="c">! ipar(5) = mcnsx</span>
<a name="ln-2317"></a><span class="c">! ipar(6) = mpnpx</span>
<a name="ln-2318"></a><span class="c">! ipar(7) = numset</span>
<a name="ln-2319"></a><span class="c">! ipar(8) = numquats</span>
<a name="ln-2320"></a><span class="c">! ipar(9) = Eminsel</span>
<a name="ln-2321"></a><span class="c">! ipar(10) = Emaxsel</span>
<a name="ln-2322"></a>
<a name="ln-2323"></a><span class="c">! fpar(1) = enl%xpc</span>
<a name="ln-2324"></a><span class="c">! fpar(2) = enl%ypc</span>
<a name="ln-2325"></a><span class="c">! fpar(3) = enl%delta</span>
<a name="ln-2326"></a><span class="c">! fpar(4) = enl%MCsig</span>
<a name="ln-2327"></a><span class="c">! fpar(5) = enl%omega</span>
<a name="ln-2328"></a><span class="c">! fpar(6) = enl%thetac</span>
<a name="ln-2329"></a><span class="c">! fpar(7) = enl%L</span>
<a name="ln-2330"></a><span class="c">! fpar(8) = enl%beamcurrent</span>
<a name="ln-2331"></a><span class="c">! fpar(9) = enl%dwelltime</span>
<a name="ln-2332"></a><span class="c">! fpar(10) = enl%alphaBD</span>
<a name="ln-2333"></a>
<a name="ln-2334"></a><span class="k">use </span><span class="n">local</span>
<a name="ln-2335"></a><span class="k">use </span><span class="n">constants</span>
<a name="ln-2336"></a><span class="k">use </span><span class="n">Lambert</span>
<a name="ln-2337"></a><span class="k">use </span><span class="n">quaternions</span>
<a name="ln-2338"></a><span class="k">use</span><span class="p">,</span><span class="k">INTRINSIC</span> <span class="kd">::</span> <span class="nb">ISO_C_BINDING</span>
<a name="ln-2339"></a>
<a name="ln-2340"></a><span class="k">IMPLICIT NONE</span>
<a name="ln-2341"></a>
<a name="ln-2342"></a><span class="kt">integer</span><span class="p">(</span><span class="kt">c_size_t</span><span class="p">),</span><span class="k">PARAMETER</span>             <span class="kd">::</span> <span class="n">nipar</span><span class="o">=</span><span class="mi">10</span>
<a name="ln-2343"></a><span class="kt">integer</span><span class="p">(</span><span class="kt">c_size_t</span><span class="p">),</span><span class="k">PARAMETER</span>             <span class="kd">::</span> <span class="n">nfpar</span><span class="o">=</span><span class="mi">10</span>
<a name="ln-2344"></a><span class="kt">integer</span><span class="p">(</span><span class="kt">c_size_t</span><span class="p">),</span><span class="k">PARAMETER</span>             <span class="kd">::</span> <span class="n">nq</span><span class="o">=</span><span class="mi">4</span>
<a name="ln-2345"></a><span class="kt">integer</span><span class="p">(</span><span class="kt">c_size_t</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>            <span class="kd">::</span> <span class="n">ipar</span><span class="p">(</span><span class="n">nipar</span><span class="p">)</span>
<a name="ln-2346"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>               <span class="kd">::</span> <span class="n">fpar</span><span class="p">(</span><span class="n">nfpar</span><span class="p">)</span>
<a name="ln-2347"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>               <span class="kd">::</span> <span class="n">quats</span><span class="p">(</span><span class="n">nq</span><span class="p">,</span><span class="n">ipar</span><span class="p">(</span><span class="mi">8</span><span class="p">))</span>
<a name="ln-2348"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>               <span class="kd">::</span> <span class="n">accum_e</span><span class="p">(</span><span class="n">ipar</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span><span class="o">-</span><span class="n">ipar</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span><span class="n">ipar</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span><span class="o">-</span><span class="n">ipar</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span><span class="n">ipar</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>
<a name="ln-2349"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>               <span class="kd">::</span> <span class="n">mLPNHsum</span><span class="p">(</span><span class="o">-</span><span class="n">ipar</span><span class="p">(</span><span class="mi">6</span><span class="p">):</span><span class="n">ipar</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span> <span class="o">-</span><span class="n">ipar</span><span class="p">(</span><span class="mi">6</span><span class="p">):</span><span class="n">ipar</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span> <span class="n">ipar</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
<a name="ln-2350"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>               <span class="kd">::</span> <span class="n">mLPSHsum</span><span class="p">(</span><span class="o">-</span><span class="n">ipar</span><span class="p">(</span><span class="mi">6</span><span class="p">):</span><span class="n">ipar</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span> <span class="o">-</span><span class="n">ipar</span><span class="p">(</span><span class="mi">6</span><span class="p">):</span><span class="n">ipar</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span> <span class="n">ipar</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
<a name="ln-2351"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">OUT</span><span class="p">)</span>              <span class="kd">::</span> <span class="n">EBSDpattern</span><span class="p">(</span><span class="n">ipar</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span><span class="n">ipar</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span><span class="n">ipar</span><span class="p">(</span><span class="mi">8</span><span class="p">))</span>
<a name="ln-2352"></a>
<a name="ln-2353"></a><span class="c">! allocatable variables</span>
<a name="ln-2354"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">),</span><span class="k">allocatable</span>              <span class="kd">::</span> <span class="n">accum_e_detector</span><span class="p">(:,:,:)</span>
<a name="ln-2355"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">),</span><span class="k">allocatable</span>              <span class="kd">::</span> <span class="n">rgx</span><span class="p">(:,:),</span> <span class="n">rgy</span><span class="p">(:,:),</span> <span class="n">rgz</span><span class="p">(:,:)</span>
<a name="ln-2356"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">),</span><span class="k">save</span>                     <span class="kd">::</span> <span class="n">prefactor</span>
<a name="ln-2357"></a>
<a name="ln-2358"></a><span class="c">! other variables</span>
<a name="ln-2359"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">),</span><span class="k">allocatable</span>              <span class="kd">::</span> <span class="n">scin_x</span><span class="p">(:),</span> <span class="n">scin_y</span><span class="p">(:)</span>                 <span class="c">! scintillator coordinate arrays [microns]</span>
<a name="ln-2360"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">),</span><span class="k">parameter</span>                <span class="kd">::</span> <span class="n">dtor</span> <span class="o">=</span> <span class="mf">0.0174533</span>  <span class="c">! convert from degrees to radians</span>
<a name="ln-2361"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">)</span>                          <span class="kd">::</span> <span class="n">alp</span><span class="p">,</span> <span class="n">ca</span><span class="p">,</span> <span class="n">sa</span><span class="p">,</span> <span class="n">cw</span><span class="p">,</span> <span class="n">sw</span>
<a name="ln-2362"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">)</span>                          <span class="kd">::</span> <span class="n">L2</span><span class="p">,</span> <span class="n">Ls</span><span class="p">,</span> <span class="n">Lc</span><span class="p">,</span> <span class="n">pcxd</span><span class="p">,</span> <span class="n">pcyd</span><span class="p">,</span> <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span>     <span class="c">! distances</span>
<a name="ln-2363"></a><span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">irg</span><span class="p">)</span>                       <span class="kd">::</span> <span class="n">nix</span><span class="p">,</span> <span class="n">niy</span><span class="p">,</span> <span class="n">binx</span><span class="p">,</span> <span class="n">biny</span><span class="p">,</span>  <span class="n">nixp</span><span class="p">,</span> <span class="n">niyp</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">Emin</span><span class="p">,</span> <span class="n">Emax</span><span class="p">,</span> <span class="n">istat</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">ipx</span><span class="p">,</span> <span class="n">ipy</span> <span class="c">! various parameters</span>
<a name="ln-2364"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">)</span>                          <span class="kd">::</span> <span class="n">dc</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">scl</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">gam</span><span class="p">,</span> <span class="n">pcvec</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">dp</span><span class="p">,</span> <span class="n">calpha</span>           <span class="c">! direction cosine array</span>
<a name="ln-2365"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">)</span>                          <span class="kd">::</span> <span class="n">sx</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dxm</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">dym</span><span class="p">,</span> <span class="n">rhos</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">bindx</span>         <span class="c">! various parameters</span>
<a name="ln-2366"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">)</span>                          <span class="kd">::</span> <span class="n">ixy</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<a name="ln-2367"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">dbl</span><span class="p">),</span><span class="k">parameter</span>                <span class="kd">::</span> <span class="n">nAmpere</span> <span class="o">=</span> <span class="mf">6.241D+18</span> 
<a name="ln-2368"></a>
<a name="ln-2369"></a><span class="c">!====================================</span>
<a name="ln-2370"></a><span class="c">! ------ generate the detector rgx, rgy, rgz arrays </span>
<a name="ln-2371"></a><span class="c">!====================================</span>
<a name="ln-2372"></a>
<a name="ln-2373"></a><span class="c">! This needs to be done only once for a given detector geometry (i.e., when ipar(1)=1 or larger)</span>
<a name="ln-2374"></a>  <span class="k">allocate</span><span class="p">(</span><span class="n">scin_x</span><span class="p">(</span><span class="n">ipar</span><span class="p">(</span><span class="mi">2</span><span class="p">)),</span><span class="n">scin_y</span><span class="p">(</span><span class="n">ipar</span><span class="p">(</span><span class="mi">3</span><span class="p">)),</span><span class="nb">stat</span><span class="o">=</span><span class="n">istat</span><span class="p">)</span>
<a name="ln-2375"></a>  
<a name="ln-2376"></a>  <span class="n">pcxd</span> <span class="o">=</span> <span class="n">fpar</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">fpar</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-2377"></a>  <span class="n">pcyd</span> <span class="o">=</span> <span class="n">fpar</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">fpar</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-2378"></a>
<a name="ln-2379"></a>  <span class="n">scin_x</span> <span class="o">=</span> <span class="o">-</span> <span class="p">(</span> <span class="n">fpar</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="nb">float</span><span class="p">(</span><span class="n">ipar</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span> <span class="p">)</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="o">-</span> <span class="p">(</span><span class="o">/</span> <span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">ipar</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span> <span class="o">/</span><span class="p">)</span> <span class="p">)</span> <span class="o">*</span> <span class="n">fpar</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-2380"></a>  <span class="n">scin_y</span> <span class="o">=</span> <span class="p">(</span> <span class="n">fpar</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="nb">float</span><span class="p">(</span><span class="n">ipar</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span> <span class="p">)</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="o">-</span> <span class="p">(</span><span class="o">/</span> <span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">ipar</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span> <span class="o">/</span><span class="p">)</span> <span class="p">)</span> <span class="o">*</span> <span class="n">fpar</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-2381"></a>
<a name="ln-2382"></a><span class="c">! auxiliary angle to rotate between reference frames</span>
<a name="ln-2383"></a>  <span class="n">alp</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">cPi</span> <span class="o">-</span> <span class="p">(</span><span class="n">fpar</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">-</span> <span class="n">fpar</span><span class="p">(</span><span class="mi">6</span><span class="p">))</span> <span class="o">*</span> <span class="n">dtor</span>
<a name="ln-2384"></a>  <span class="n">ca</span> <span class="o">=</span> <span class="nb">cos</span><span class="p">(</span><span class="n">alp</span><span class="p">)</span>
<a name="ln-2385"></a>  <span class="n">sa</span> <span class="o">=</span> <span class="nb">sin</span><span class="p">(</span><span class="n">alp</span><span class="p">)</span>
<a name="ln-2386"></a>
<a name="ln-2387"></a>  <span class="n">cw</span> <span class="o">=</span> <span class="nb">cos</span><span class="p">(</span><span class="n">fpar</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">*</span> <span class="n">dtor</span><span class="p">)</span>
<a name="ln-2388"></a>  <span class="n">sw</span> <span class="o">=</span> <span class="nb">sin</span><span class="p">(</span><span class="n">fpar</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">*</span> <span class="n">dtor</span><span class="p">)</span>
<a name="ln-2389"></a>
<a name="ln-2390"></a><span class="c">! compute auxilliary interpolation arrays</span>
<a name="ln-2391"></a>  <span class="k">allocate</span><span class="p">(</span><span class="n">rgx</span><span class="p">(</span><span class="n">ipar</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span><span class="n">ipar</span><span class="p">(</span><span class="mi">3</span><span class="p">)),</span> <span class="n">rgy</span><span class="p">(</span><span class="n">ipar</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span><span class="n">ipar</span><span class="p">(</span><span class="mi">3</span><span class="p">)),</span> <span class="n">rgz</span><span class="p">(</span><span class="n">ipar</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span><span class="n">ipar</span><span class="p">(</span><span class="mi">3</span><span class="p">)))</span>
<a name="ln-2392"></a>
<a name="ln-2393"></a><span class="c">! do we need to perform a Barrel Distortion?</span>
<a name="ln-2394"></a><span class="c">! we will do this here by expanding/contracting the radial component of the </span>
<a name="ln-2395"></a><span class="c">! (rgx, rgy) to (rgx,rgy) * (1+alphaBD * (rgx^2+rgy^2))</span>
<a name="ln-2396"></a><span class="c">! in other words, we pre-distort the sampling grid with the barrel distortion.</span>
<a name="ln-2397"></a>
<a name="ln-2398"></a>  <span class="n">L2</span> <span class="o">=</span> <span class="n">fpar</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">*</span> <span class="n">fpar</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span>
<a name="ln-2399"></a>  <span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">ipar</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<a name="ln-2400"></a>    <span class="n">Ls</span> <span class="o">=</span> <span class="o">-</span><span class="n">sw</span> <span class="o">*</span> <span class="n">scin_x</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="o">+</span> <span class="n">fpar</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">*</span> <span class="n">cw</span>
<a name="ln-2401"></a>    <span class="n">Lc</span> <span class="o">=</span> <span class="n">cw</span> <span class="o">*</span> <span class="n">scin_x</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="o">+</span> <span class="n">fpar</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">*</span> <span class="n">sw</span>
<a name="ln-2402"></a>    <span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">ipar</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-2403"></a><span class="c">!    rhos = 1.0/sqrt(sx + scin_y(i)**2)</span>
<a name="ln-2404"></a>     <span class="n">rgx</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">scin_y</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">*</span> <span class="n">ca</span> <span class="o">+</span> <span class="n">sa</span> <span class="o">*</span> <span class="n">Ls</span><span class="p">)</span> <span class="c">! * rhos</span>
<a name="ln-2405"></a>     <span class="n">rgy</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="n">Lc</span> <span class="c">! * rhos</span>
<a name="ln-2406"></a>     <span class="n">rgz</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">sa</span> <span class="o">*</span> <span class="n">scin_y</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="n">ca</span> <span class="o">*</span> <span class="n">Ls</span><span class="p">)</span> <span class="c">! * rhos</span>
<a name="ln-2407"></a><span class="c">! apply Barrel Distortion ?</span>
<a name="ln-2408"></a>     <span class="k">if</span> <span class="p">(</span><span class="n">fpar</span><span class="p">(</span><span class="mi">10</span><span class="p">).</span><span class="n">ne</span><span class="p">.</span><span class="mf">0.0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-2409"></a><span class="c">! shift the components to the detector center coordinate frame</span>
<a name="ln-2410"></a>       <span class="n">xx</span> <span class="o">=</span> <span class="n">rgx</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">)</span><span class="o">-</span><span class="n">pcyd</span>
<a name="ln-2411"></a>       <span class="n">yy</span> <span class="o">=</span> <span class="n">rgy</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">)</span><span class="o">+</span><span class="n">pcxd</span>
<a name="ln-2412"></a><span class="c">! compute the distortion amount; the factor of 10^(-10) is inserted here...</span>
<a name="ln-2413"></a>       <span class="n">sx</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">+</span> <span class="mf">1.E-10</span> <span class="o">*</span> <span class="n">fpar</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">xx</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">yy</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> 
<a name="ln-2414"></a><span class="c">! and shift them back to the pattern center reference frame</span>
<a name="ln-2415"></a>       <span class="n">rgx</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="n">xx</span><span class="o">*</span><span class="n">sx</span><span class="o">+</span><span class="n">pcyd</span>
<a name="ln-2416"></a>       <span class="n">rgy</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="n">yy</span><span class="o">*</span><span class="n">sx</span><span class="o">-</span><span class="n">pcxd</span>
<a name="ln-2417"></a>     <span class="k">end if</span>
<a name="ln-2418"></a><span class="c">! make sure that these vectors are normalized !</span>
<a name="ln-2419"></a>     <span class="n">x</span> <span class="o">=</span> <span class="nb">sqrt</span><span class="p">(</span><span class="n">rgx</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">rgy</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">rgz</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
<a name="ln-2420"></a>     <span class="n">rgx</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="n">rgx</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">)</span> <span class="o">/</span> <span class="n">x</span>
<a name="ln-2421"></a>     <span class="n">rgy</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="n">rgy</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">)</span> <span class="o">/</span> <span class="n">x</span>
<a name="ln-2422"></a>     <span class="n">rgz</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="n">rgz</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">)</span> <span class="o">/</span> <span class="n">x</span>
<a name="ln-2423"></a>    <span class="k">end do</span>
<a name="ln-2424"></a><span class="k">  end do</span>
<a name="ln-2425"></a>
<a name="ln-2426"></a><span class="c">! remove the auxiliary arrays scin_x and scin_y</span>
<a name="ln-2427"></a>  <span class="k">deallocate</span><span class="p">(</span><span class="n">scin_x</span><span class="p">,</span> <span class="n">scin_y</span><span class="p">)</span>
<a name="ln-2428"></a>
<a name="ln-2429"></a><span class="c">!====================================</span>
<a name="ln-2430"></a><span class="c">! ------ create the equivalent detector energy array</span>
<a name="ln-2431"></a><span class="c">!====================================</span>
<a name="ln-2432"></a><span class="c">! from the Monte Carlo energy data, we need to extract the relevant</span>
<a name="ln-2433"></a><span class="c">! entries for the detector geometry defined above.  </span>
<a name="ln-2434"></a>
<a name="ln-2435"></a><span class="c">! determine the scale factor for the Lambert interpolation; the square has</span>
<a name="ln-2436"></a><span class="c">! an edge length of 2 x sqrt(pi/2)</span>
<a name="ln-2437"></a>  <span class="n">scl</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">ipar</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span> 
<a name="ln-2438"></a>
<a name="ln-2439"></a><span class="c">! energy summation will go over all energy bins</span>
<a name="ln-2440"></a>  <span class="n">Emin</span> <span class="o">=</span> <span class="n">ipar</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span>
<a name="ln-2441"></a>  <span class="n">Emax</span> <span class="o">=</span> <span class="n">ipar</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<a name="ln-2442"></a>
<a name="ln-2443"></a>  <span class="k">allocate</span><span class="p">(</span><span class="n">accum_e_detector</span><span class="p">(</span><span class="n">ipar</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span><span class="n">ipar</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span><span class="n">ipar</span><span class="p">(</span><span class="mi">3</span><span class="p">)))</span>
<a name="ln-2444"></a>
<a name="ln-2445"></a><span class="c">! correction of change in effective pixel area compared to equal-area Lambert projection</span>
<a name="ln-2446"></a>  <span class="n">alpha</span> <span class="o">=</span> <span class="nb">atan</span><span class="p">(</span><span class="n">fpar</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">/</span><span class="n">fpar</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span><span class="o">/</span><span class="nb">sqrt</span><span class="p">(</span><span class="nb">sngl</span><span class="p">(</span><span class="n">cPi</span><span class="p">)))</span>
<a name="ln-2447"></a>  <span class="n">ipx</span> <span class="o">=</span> <span class="n">ipar</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="nb">nint</span><span class="p">(</span><span class="n">fpar</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
<a name="ln-2448"></a>  <span class="n">ipy</span> <span class="o">=</span> <span class="n">ipar</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="nb">nint</span><span class="p">(</span><span class="n">fpar</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
<a name="ln-2449"></a>  
<a name="ln-2450"></a>  <span class="k">if</span> <span class="p">(</span><span class="n">ipx</span> <span class="p">.</span><span class="n">gt</span><span class="p">.</span> <span class="n">ipar</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span> <span class="n">ipx</span> <span class="o">=</span> <span class="n">ipar</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<a name="ln-2451"></a>  <span class="k">if</span> <span class="p">(</span><span class="n">ipx</span> <span class="p">.</span><span class="n">lt</span><span class="p">.</span> <span class="mi">1</span><span class="p">)</span> <span class="n">ipx</span> <span class="o">=</span> <span class="mi">1</span>
<a name="ln-2452"></a>  
<a name="ln-2453"></a>  <span class="k">if</span> <span class="p">(</span><span class="n">ipy</span> <span class="p">.</span><span class="n">gt</span><span class="p">.</span> <span class="n">ipar</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span> <span class="n">ipy</span> <span class="o">=</span> <span class="n">ipar</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-2454"></a>  <span class="k">if</span> <span class="p">(</span><span class="n">ipy</span> <span class="p">.</span><span class="n">lt</span><span class="p">.</span> <span class="mi">1</span><span class="p">)</span> <span class="n">ipy</span> <span class="o">=</span> <span class="mi">1</span>
<a name="ln-2455"></a>  
<a name="ln-2456"></a>  <span class="n">pcvec</span> <span class="o">=</span> <span class="p">(</span><span class="o">/</span> <span class="n">rgx</span><span class="p">(</span><span class="n">ipx</span><span class="p">,</span><span class="n">ipy</span><span class="p">),</span> <span class="n">rgy</span><span class="p">(</span><span class="n">ipx</span><span class="p">,</span><span class="n">ipy</span><span class="p">),</span> <span class="n">rgz</span><span class="p">(</span><span class="n">ipx</span><span class="p">,</span><span class="n">ipy</span><span class="p">)</span> <span class="o">/</span><span class="p">)</span>
<a name="ln-2457"></a>  <span class="n">calpha</span> <span class="o">=</span> <span class="nb">cos</span><span class="p">(</span><span class="n">alpha</span><span class="p">)</span>
<a name="ln-2458"></a>  <span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">ipar</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<a name="ln-2459"></a>    <span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">ipar</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-2460"></a><span class="c">! do the coordinate transformation for this detector pixel</span>
<a name="ln-2461"></a>       <span class="n">dc</span> <span class="o">=</span> <span class="p">(</span><span class="o">/</span> <span class="n">rgx</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">),</span> <span class="n">rgy</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">),</span> <span class="n">rgz</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span> <span class="o">/</span><span class="p">)</span>
<a name="ln-2462"></a><span class="c">! make sure the third one is positive; if not, switch all </span>
<a name="ln-2463"></a>       <span class="k">if</span> <span class="p">(</span><span class="n">dc</span><span class="p">(</span><span class="mi">3</span><span class="p">).</span><span class="n">lt</span><span class="p">.</span><span class="mf">0.0</span><span class="p">)</span> <span class="n">dc</span> <span class="o">=</span> <span class="o">-</span><span class="n">dc</span>
<a name="ln-2464"></a><span class="c">! convert these direction cosines to coordinates in the Rosca-Lambert projection</span>
<a name="ln-2465"></a>        <span class="n">ixy</span> <span class="o">=</span> <span class="n">scl</span> <span class="o">*</span> <span class="n">LambertSphereToSquare</span><span class="p">(</span> <span class="n">dc</span><span class="p">,</span> <span class="n">istat</span> <span class="p">)</span>
<a name="ln-2466"></a>        <span class="n">x</span> <span class="o">=</span> <span class="n">ixy</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-2467"></a>        <span class="n">ixy</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">ixy</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<a name="ln-2468"></a>        <span class="n">ixy</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="n">x</span>
<a name="ln-2469"></a><span class="c">! four-point interpolation (bi-quadratic)</span>
<a name="ln-2470"></a>        <span class="n">nix</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ipar</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">+</span><span class="n">ixy</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="o">-</span><span class="n">ipar</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<a name="ln-2471"></a>        <span class="n">niy</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ipar</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">+</span><span class="n">ixy</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span><span class="o">-</span><span class="n">ipar</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<a name="ln-2472"></a>        <span class="n">nixp</span> <span class="o">=</span> <span class="n">nix</span><span class="o">+</span><span class="mi">1</span>
<a name="ln-2473"></a>        <span class="n">niyp</span> <span class="o">=</span> <span class="n">niy</span><span class="o">+</span><span class="mi">1</span>
<a name="ln-2474"></a>        <span class="k">if</span> <span class="p">(</span><span class="n">nix</span> <span class="p">.</span><span class="n">gt</span><span class="p">.</span> <span class="n">ipar</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span> <span class="n">nix</span> <span class="o">=</span> <span class="n">ipar</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<a name="ln-2475"></a>        <span class="k">if</span> <span class="p">(</span><span class="n">niy</span> <span class="p">.</span><span class="n">gt</span><span class="p">.</span> <span class="n">ipar</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span> <span class="n">niy</span> <span class="o">=</span> <span class="n">ipar</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<a name="ln-2476"></a>        <span class="k">if</span> <span class="p">(</span><span class="n">nix</span> <span class="p">.</span><span class="n">lt</span><span class="p">.</span> <span class="o">-</span><span class="n">ipar</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span> <span class="n">nix</span> <span class="o">=</span> <span class="o">-</span><span class="n">ipar</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<a name="ln-2477"></a>        <span class="k">if</span> <span class="p">(</span><span class="n">niy</span> <span class="p">.</span><span class="n">lt</span><span class="p">.</span> <span class="o">-</span><span class="n">ipar</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span> <span class="n">niy</span> <span class="o">=</span> <span class="o">-</span><span class="n">ipar</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<a name="ln-2478"></a>
<a name="ln-2479"></a>        <span class="k">if</span> <span class="p">(</span><span class="n">nixp</span> <span class="p">.</span><span class="n">gt</span><span class="p">.</span> <span class="n">ipar</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span> <span class="n">nixp</span> <span class="o">=</span> <span class="n">ipar</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<a name="ln-2480"></a>        <span class="k">if</span> <span class="p">(</span><span class="n">niyp</span> <span class="p">.</span><span class="n">gt</span><span class="p">.</span> <span class="n">ipar</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span> <span class="n">niyp</span> <span class="o">=</span> <span class="n">ipar</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<a name="ln-2481"></a>        <span class="k">if</span> <span class="p">(</span><span class="n">nixp</span> <span class="p">.</span><span class="n">lt</span><span class="p">.</span> <span class="o">-</span><span class="n">ipar</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span> <span class="n">nixp</span> <span class="o">=</span> <span class="o">-</span><span class="n">ipar</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<a name="ln-2482"></a>        <span class="k">if</span> <span class="p">(</span><span class="n">niyp</span> <span class="p">.</span><span class="n">lt</span><span class="p">.</span> <span class="o">-</span><span class="n">ipar</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span> <span class="n">niyp</span> <span class="o">=</span> <span class="o">-</span><span class="n">ipar</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<a name="ln-2483"></a>
<a name="ln-2484"></a>        <span class="n">dx</span> <span class="o">=</span> <span class="n">ixy</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">nix</span>
<a name="ln-2485"></a>        <span class="n">dy</span> <span class="o">=</span> <span class="n">ixy</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">-</span><span class="n">niy</span>
<a name="ln-2486"></a>        <span class="n">dxm</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">-</span><span class="n">dx</span>
<a name="ln-2487"></a>        <span class="n">dym</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">-</span><span class="n">dy</span>
<a name="ln-2488"></a><span class="c">! do the area correction for this detector pixel</span>
<a name="ln-2489"></a>        <span class="n">dp</span> <span class="o">=</span> <span class="nb">dot_product</span><span class="p">(</span><span class="n">pcvec</span><span class="p">,</span><span class="n">dc</span><span class="p">)</span>
<a name="ln-2490"></a>        <span class="k">if</span> <span class="p">((</span><span class="n">i</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="n">ipx</span><span class="p">).</span><span class="nb">and</span><span class="p">.(</span><span class="n">j</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="n">ipy</span><span class="p">))</span> <span class="k">then</span>
<a name="ln-2491"></a><span class="k">          </span><span class="n">gam</span> <span class="o">=</span> <span class="mf">0.25</span> 
<a name="ln-2492"></a>        <span class="k">else</span>
<a name="ln-2493"></a><span class="k">          </span><span class="n">gam</span> <span class="o">=</span> <span class="p">((</span><span class="n">calpha</span><span class="o">*</span><span class="n">calpha</span> <span class="o">+</span> <span class="n">dp</span><span class="o">*</span><span class="n">dp</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">)</span><span class="o">**</span><span class="mf">1.5</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">calpha</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.25</span>
<a name="ln-2494"></a>        <span class="k">end if</span>
<a name="ln-2495"></a><span class="c">! interpolate the intensity </span>
<a name="ln-2496"></a>        <span class="k">do </span><span class="n">k</span><span class="o">=</span> <span class="n">Emin</span><span class="p">,</span> <span class="n">Emax</span>
<a name="ln-2497"></a>          <span class="n">accum_e_detector</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span> <span class="o">=</span> <span class="n">gam</span> <span class="o">*</span> <span class="p">(</span><span class="n">accum_e</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">nix</span><span class="p">,</span><span class="n">niy</span><span class="p">)</span> <span class="o">*</span> <span class="n">dxm</span> <span class="o">*</span> <span class="n">dym</span> <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-2498"></a>                                    <span class="n">accum_e</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">nixp</span><span class="p">,</span><span class="n">niy</span><span class="p">)</span> <span class="o">*</span> <span class="n">dx</span> <span class="o">*</span> <span class="n">dym</span> <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-2499"></a>                                    <span class="n">accum_e</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">nix</span><span class="p">,</span><span class="n">niyp</span><span class="p">)</span> <span class="o">*</span> <span class="n">dxm</span> <span class="o">*</span> <span class="n">dy</span> <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-2500"></a>                                    <span class="n">accum_e</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">nixp</span><span class="p">,</span><span class="n">niyp</span><span class="p">)</span> <span class="o">*</span> <span class="n">dx</span> <span class="o">*</span> <span class="n">dy</span><span class="p">)</span>
<a name="ln-2501"></a>        <span class="k">end do</span>
<a name="ln-2502"></a><span class="k">    end do</span>
<a name="ln-2503"></a><span class="k">  end do </span>
<a name="ln-2504"></a><span class="k">  </span><span class="n">prefactor</span> <span class="o">=</span> <span class="mf">0.25D0</span> <span class="o">*</span> <span class="n">nAmpere</span> <span class="o">*</span> <span class="n">fpar</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span> <span class="o">*</span> <span class="n">fpar</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span>  <span class="o">*</span> <span class="mf">1.0D-15</span> <span class="o">/</span> <span class="nb">sum</span><span class="p">(</span><span class="n">accum_e_detector</span><span class="p">)</span>
<a name="ln-2505"></a>
<a name="ln-2506"></a><span class="c">! from here on, we simply compute the EBSD patterns by interpolation, </span>
<a name="ln-2507"></a><span class="c">! no intensity scaling or anything else...other than multiplication by pre-factor</span>
<a name="ln-2508"></a><span class="c">! intensity scaling is left to the user of the calling program.</span>
<a name="ln-2509"></a>
<a name="ln-2510"></a><span class="c">! define some parameters and initialize EBSDpattern</span>
<a name="ln-2511"></a><span class="n">scl</span> <span class="o">=</span> <span class="nb">dble</span><span class="p">(</span><span class="n">ipar</span><span class="p">(</span><span class="mi">6</span><span class="p">))</span> 
<a name="ln-2512"></a><span class="n">EBSDpattern</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-2513"></a>
<a name="ln-2514"></a><span class="c">! here is the main loop over all quaternions</span>
<a name="ln-2515"></a><span class="n">quatloop</span><span class="p">:</span> <span class="k">do </span><span class="n">ip</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">ipar</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
<a name="ln-2516"></a>  <span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">ipar</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<a name="ln-2517"></a>    <span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">ipar</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-2518"></a><span class="c">! do the active coordinate transformation for this euler angle</span>
<a name="ln-2519"></a>      <span class="n">dc</span> <span class="o">=</span> <span class="n">quat_Lp</span><span class="p">(</span><span class="n">quats</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span><span class="n">ip</span><span class="p">),</span>  <span class="p">(</span><span class="o">/</span> <span class="n">rgx</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">),</span> <span class="n">rgy</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">),</span> <span class="n">rgz</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span> <span class="o">/</span><span class="p">)</span> <span class="p">)</span>
<a name="ln-2520"></a><span class="c">! normalize dc</span>
<a name="ln-2521"></a>      <span class="n">dc</span> <span class="o">=</span> <span class="n">dc</span><span class="o">/</span><span class="nb">sqrt</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">dc</span><span class="o">*</span><span class="n">dc</span><span class="p">))</span>
<a name="ln-2522"></a><span class="c">! convert these direction cosines to coordinates in the Rosca-Lambert projection (always square projection !!!)</span>
<a name="ln-2523"></a>      <span class="n">ixy</span> <span class="o">=</span> <span class="n">scl</span> <span class="o">*</span> <span class="n">LambertSphereToSquare</span><span class="p">(</span> <span class="n">dc</span><span class="p">,</span> <span class="n">istat</span> <span class="p">)</span>
<a name="ln-2524"></a>
<a name="ln-2525"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">istat</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span> <span class="k">then</span> 
<a name="ln-2526"></a><span class="c">! four-point interpolation (bi-quadratic)</span>
<a name="ln-2527"></a>        <span class="n">nix</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ipar</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span><span class="o">+</span><span class="n">ixy</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="o">-</span><span class="n">ipar</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
<a name="ln-2528"></a>        <span class="n">niy</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ipar</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span><span class="o">+</span><span class="n">ixy</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span><span class="o">-</span><span class="n">ipar</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
<a name="ln-2529"></a>        <span class="n">nixp</span> <span class="o">=</span> <span class="n">nix</span><span class="o">+</span><span class="mi">1</span>
<a name="ln-2530"></a>        <span class="n">niyp</span> <span class="o">=</span> <span class="n">niy</span><span class="o">+</span><span class="mi">1</span>
<a name="ln-2531"></a>        <span class="k">if</span> <span class="p">(</span><span class="n">nix</span> <span class="p">.</span><span class="n">gt</span><span class="p">.</span> <span class="n">ipar</span><span class="p">(</span><span class="mi">6</span><span class="p">))</span> <span class="n">nix</span> <span class="o">=</span> <span class="n">ipar</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
<a name="ln-2532"></a>        <span class="k">if</span> <span class="p">(</span><span class="n">niy</span> <span class="p">.</span><span class="n">gt</span><span class="p">.</span> <span class="n">ipar</span><span class="p">(</span><span class="mi">6</span><span class="p">))</span> <span class="n">niy</span> <span class="o">=</span> <span class="n">ipar</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
<a name="ln-2533"></a>        <span class="k">if</span> <span class="p">(</span><span class="n">nix</span> <span class="p">.</span><span class="n">lt</span><span class="p">.</span> <span class="o">-</span><span class="n">ipar</span><span class="p">(</span><span class="mi">6</span><span class="p">))</span> <span class="n">nix</span> <span class="o">=</span> <span class="o">-</span><span class="n">ipar</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
<a name="ln-2534"></a>        <span class="k">if</span> <span class="p">(</span><span class="n">niy</span> <span class="p">.</span><span class="n">lt</span><span class="p">.</span> <span class="o">-</span><span class="n">ipar</span><span class="p">(</span><span class="mi">6</span><span class="p">))</span> <span class="n">niy</span> <span class="o">=</span> <span class="o">-</span><span class="n">ipar</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
<a name="ln-2535"></a>
<a name="ln-2536"></a>        <span class="k">if</span> <span class="p">(</span><span class="n">nixp</span> <span class="p">.</span><span class="n">gt</span><span class="p">.</span> <span class="n">ipar</span><span class="p">(</span><span class="mi">6</span><span class="p">))</span> <span class="n">nixp</span> <span class="o">=</span> <span class="n">ipar</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
<a name="ln-2537"></a>        <span class="k">if</span> <span class="p">(</span><span class="n">niyp</span> <span class="p">.</span><span class="n">gt</span><span class="p">.</span> <span class="n">ipar</span><span class="p">(</span><span class="mi">6</span><span class="p">))</span> <span class="n">niyp</span> <span class="o">=</span> <span class="n">ipar</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
<a name="ln-2538"></a>        <span class="k">if</span> <span class="p">(</span><span class="n">nixp</span> <span class="p">.</span><span class="n">lt</span><span class="p">.</span> <span class="o">-</span><span class="n">ipar</span><span class="p">(</span><span class="mi">6</span><span class="p">))</span> <span class="n">nixp</span> <span class="o">=</span> <span class="o">-</span><span class="n">ipar</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
<a name="ln-2539"></a>        <span class="k">if</span> <span class="p">(</span><span class="n">niyp</span> <span class="p">.</span><span class="n">lt</span><span class="p">.</span> <span class="o">-</span><span class="n">ipar</span><span class="p">(</span><span class="mi">6</span><span class="p">))</span> <span class="n">niyp</span> <span class="o">=</span> <span class="o">-</span><span class="n">ipar</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
<a name="ln-2540"></a>
<a name="ln-2541"></a>        <span class="n">dx</span> <span class="o">=</span> <span class="n">ixy</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">nix</span>
<a name="ln-2542"></a>        <span class="n">dy</span> <span class="o">=</span> <span class="n">ixy</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">-</span><span class="n">niy</span>
<a name="ln-2543"></a>        <span class="n">dxm</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">-</span><span class="n">dx</span>
<a name="ln-2544"></a>        <span class="n">dym</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">-</span><span class="n">dy</span>
<a name="ln-2545"></a>
<a name="ln-2546"></a>        <span class="k">if</span> <span class="p">(</span><span class="n">dc</span><span class="p">(</span><span class="mi">3</span><span class="p">).</span><span class="n">gt</span><span class="p">.</span><span class="mf">0.0</span><span class="p">)</span> <span class="k">then</span> <span class="c">! we&#39;re in the Northern hemisphere</span>
<a name="ln-2547"></a>          <span class="k">do </span><span class="n">k</span><span class="o">=</span><span class="n">Emin</span><span class="p">,</span><span class="n">Emax</span>
<a name="ln-2548"></a>            <span class="n">EBSDpattern</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">ip</span><span class="p">)</span> <span class="o">=</span> <span class="n">EBSDpattern</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">ip</span><span class="p">)</span> <span class="o">+</span> <span class="n">accum_e_detector</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span> <span class="n">mLPNHsum</span><span class="p">(</span><span class="n">nix</span><span class="p">,</span><span class="n">niy</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">*</span> <span class="n">dxm</span> <span class="o">*</span> <span class="n">dym</span> <span class="o">+</span><span class="p">&amp;</span>
<a name="ln-2549"></a>                                        <span class="n">mLPNHsum</span><span class="p">(</span><span class="n">nixp</span><span class="p">,</span><span class="n">niy</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">*</span> <span class="n">dx</span> <span class="o">*</span> <span class="n">dym</span> <span class="o">+</span> <span class="n">mLPNHsum</span><span class="p">(</span><span class="n">nix</span><span class="p">,</span><span class="n">niyp</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">*</span> <span class="n">dxm</span> <span class="o">*</span> <span class="n">dy</span> <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-2550"></a>                                        <span class="n">mLPNHsum</span><span class="p">(</span><span class="n">nixp</span><span class="p">,</span><span class="n">niyp</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">*</span> <span class="n">dx</span> <span class="o">*</span> <span class="n">dy</span> <span class="p">)</span>
<a name="ln-2551"></a>          <span class="k">end do</span>
<a name="ln-2552"></a><span class="k">        else</span>                   <span class="c">! we&#39;re in the Southern hemisphere</span>
<a name="ln-2553"></a>          <span class="k">do </span><span class="n">k</span><span class="o">=</span><span class="n">Emin</span><span class="p">,</span><span class="n">Emax</span> 
<a name="ln-2554"></a>            <span class="n">EBSDpattern</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">ip</span><span class="p">)</span> <span class="o">=</span> <span class="n">EBSDpattern</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">ip</span><span class="p">)</span> <span class="o">+</span> <span class="n">accum_e_detector</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span> <span class="n">mLPSHsum</span><span class="p">(</span><span class="n">nix</span><span class="p">,</span><span class="n">niy</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">*</span> <span class="n">dxm</span> <span class="o">*</span> <span class="n">dym</span> <span class="o">+</span><span class="p">&amp;</span>
<a name="ln-2555"></a>                                        <span class="n">mLPSHsum</span><span class="p">(</span><span class="n">nixp</span><span class="p">,</span><span class="n">niy</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">*</span> <span class="n">dx</span> <span class="o">*</span> <span class="n">dym</span> <span class="o">+</span> <span class="n">mLPSHsum</span><span class="p">(</span><span class="n">nix</span><span class="p">,</span><span class="n">niyp</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">*</span> <span class="n">dxm</span> <span class="o">*</span> <span class="n">dy</span> <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-2556"></a>                                        <span class="n">mLPSHsum</span><span class="p">(</span><span class="n">nixp</span><span class="p">,</span><span class="n">niyp</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">*</span> <span class="n">dx</span> <span class="o">*</span> <span class="n">dy</span> <span class="p">)</span>
<a name="ln-2557"></a>          <span class="k">end do</span>
<a name="ln-2558"></a><span class="k">        end if</span>
<a name="ln-2559"></a><span class="k">      end if</span>
<a name="ln-2560"></a><span class="k">    end do</span>
<a name="ln-2561"></a><span class="k">  end do</span>
<a name="ln-2562"></a><span class="k">end do </span><span class="n">quatloop</span>
<a name="ln-2563"></a>
<a name="ln-2564"></a><span class="k">deallocate</span><span class="p">(</span><span class="n">accum_e_detector</span><span class="p">)</span>
<a name="ln-2565"></a>
<a name="ln-2566"></a><span class="c">! finally, scale the patterns by the appropriate factor and return to the calling program</span>
<a name="ln-2567"></a><span class="n">EBSDpattern</span> <span class="o">=</span> <span class="n">prefactor</span> <span class="o">*</span> <span class="n">EBSDpattern</span>
<a name="ln-2568"></a>
<a name="ln-2569"></a><span class="k">end subroutine </span><span class="n">getEBSDPatterns2</span>
<a name="ln-2570"></a>
<a name="ln-2571"></a>
<a name="ln-2572"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-2573"></a><span class="c">!</span>
<a name="ln-2574"></a><span class="c">! SUBROUTINE:getECPatterns</span>
<a name="ln-2575"></a><span class="c">!</span>
<a name="ln-2576"></a><span class="c">!&gt; @author Saransh Singh, Carnegie Mellon University</span>
<a name="ln-2577"></a><span class="c">!</span>
<a name="ln-2578"></a><span class="c">!&gt; @brief This function can be called as a standalone function to compute an electron channeling pattern</span>
<a name="ln-2579"></a><span class="c">!&gt; based on Marc&#39;s code above</span>
<a name="ln-2580"></a><span class="c">!</span>
<a name="ln-2581"></a><span class="c">!&gt; @etails The main purpose of this routine and its accompanying wrapper routine is to</span>
<a name="ln-2582"></a><span class="c">!&gt; provide a way for an external program to compute an EC pattern.  The idea is that </span>
<a name="ln-2583"></a><span class="c">!&gt; all the necessary arrays and variables are passed in by reference as arguments, without</span>
<a name="ln-2584"></a><span class="c">!&gt; the need for the routine to fetch any other data from files etc...  The initial goal is</span>
<a name="ln-2585"></a><span class="c">!&gt; to have a function that can be called with the CALL_EXTERNAL mechanism in IDL, but </span>
<a name="ln-2586"></a><span class="c">!&gt; in the long run this will also be the approach for calling the routine from C/C++, which</span>
<a name="ln-2587"></a><span class="c">!&gt; is an essential part of integration with DREAM.3D.  This routine is a simplified version</span>
<a name="ln-2588"></a><span class="c">!&gt; of the core of the EMECP program. </span>
<a name="ln-2589"></a><span class="c">!&gt;</span>
<a name="ln-2590"></a><span class="c">!&gt; This routine will first compute the incident cone vectors etc. if necessary, and then perform</span>
<a name="ln-2591"></a><span class="c">!&gt; the usual interpolation from the square Lambert projection. The pattern will be a basic pattern,</span>
<a name="ln-2592"></a><span class="c">!&gt; without any intensity scaling or binning etc; the calling program should take care of those </span>
<a name="ln-2593"></a><span class="c">!&gt; operations.</span>
<a name="ln-2594"></a><span class="c">!</span>
<a name="ln-2595"></a><span class="c">!&gt; @param ipar array with integer input parameters</span>
<a name="ln-2596"></a><span class="c">!&gt; @param fpar array with float input parameters</span>
<a name="ln-2597"></a><span class="c">!&gt; @param ECPattern output array</span>
<a name="ln-2598"></a><span class="c">!&gt; @param quats array of quaternions</span>
<a name="ln-2599"></a><span class="c">!&gt; @param accum_e array with Monte Carlo histogram</span>
<a name="ln-2600"></a><span class="c">!&gt; @param mLPNH Northern hemisphere master pattern</span>
<a name="ln-2601"></a><span class="c">!&gt; @param mLPSH Southern hemisphere master pattern</span>
<a name="ln-2602"></a><span class="c">!</span>
<a name="ln-2603"></a><span class="c">!&gt; @date 10/16/15  SS 1.0 original</span>
<a name="ln-2604"></a><span class="c">!&gt; @date 11/02/14 MDG 1.1 put all integer parameters inside ipar and fixed size of ipar/fpar</span>
<a name="ln-2605"></a><span class="c">!&gt; @date 11/04/15 MDG 1.2 added array of quaternions as input parameter</span>
<a name="ln-2606"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-2607"></a><span class="k">recursive subroutine </span><span class="n">getECPatterns</span><span class="p">(</span><span class="n">ipar</span><span class="p">,</span> <span class="n">fpar</span><span class="p">,</span> <span class="n">ECpattern</span><span class="p">,</span> <span class="n">quats</span><span class="p">,</span> <span class="n">accum_e</span><span class="p">,</span> <span class="n">mLPNH</span><span class="p">,</span> <span class="n">mLPSH</span><span class="p">)</span>
<a name="ln-2608"></a><span class="c">!DEC$ ATTRIBUTES DLLEXPORT :: GetECPatterns</span>
<a name="ln-2609"></a>
<a name="ln-2610"></a><span class="c">! the input parameters are all part of a ipar and fpar input arrays instead of the usual namelist structures.</span>
<a name="ln-2611"></a><span class="c">! The following is the mapping:</span>
<a name="ln-2612"></a><span class="c">!</span>
<a name="ln-2613"></a><span class="c">! ipar(1) = 1 if GetVectorsCone detector arrays need to be computed, 0 if not (arrays will have save status)</span>
<a name="ln-2614"></a><span class="c">! ipar(2) = detnumsx</span>
<a name="ln-2615"></a><span class="c">! ipar(3) = detnumsy</span>
<a name="ln-2616"></a><span class="c">! ipar(4) = numangle</span>
<a name="ln-2617"></a><span class="c">! ipar(5) = mcnsx</span>
<a name="ln-2618"></a><span class="c">! ipar(6) = numset</span>
<a name="ln-2619"></a><span class="c">! ipar(7) = mpnpx</span>
<a name="ln-2620"></a><span class="c">! ipar(8) = numquats</span>
<a name="ln-2621"></a>
<a name="ln-2622"></a><span class="c">! fpar(1) = ecpnl%thetac</span>
<a name="ln-2623"></a><span class="c">! fpar(2) = ecpnl%sampletilt</span>
<a name="ln-2624"></a><span class="c">! fpar(3) = ecpnl%workingdistance</span>
<a name="ln-2625"></a><span class="c">! fpar(4) = ecpnl%Rin</span>
<a name="ln-2626"></a><span class="c">! fpar(5) = ecpnl%Rout</span>
<a name="ln-2627"></a><span class="c">! fpar(6) = ecpnl%sigstart</span>
<a name="ln-2628"></a><span class="c">! fpar(7) = ecpnl%sigend</span>
<a name="ln-2629"></a><span class="c">! fpar(8) = ecpnl%sigstep</span>
<a name="ln-2630"></a>
<a name="ln-2631"></a><span class="c">!!!!!!!! removed:  fpar(9-12) =  quaternion for requested Euler angles</span>
<a name="ln-2632"></a>
<a name="ln-2633"></a><span class="k">use </span><span class="n">local</span>
<a name="ln-2634"></a><span class="k">use </span><span class="n">constants</span>
<a name="ln-2635"></a><span class="k">use </span><span class="n">Lambert</span>
<a name="ln-2636"></a><span class="k">use </span><span class="n">quaternions</span>
<a name="ln-2637"></a><span class="k">use </span><span class="n">distortion</span>
<a name="ln-2638"></a><span class="k">use</span><span class="p">,</span><span class="k">INTRINSIC</span> <span class="kd">::</span> <span class="nb">ISO_C_BINDING</span>
<a name="ln-2639"></a>
<a name="ln-2640"></a><span class="k">IMPLICIT NONE</span>
<a name="ln-2641"></a>
<a name="ln-2642"></a><span class="kt">integer</span><span class="p">(</span><span class="kt">c_size_t</span><span class="p">),</span><span class="k">PARAMETER</span>             <span class="kd">::</span> <span class="n">nipar</span><span class="o">=</span><span class="mi">8</span>
<a name="ln-2643"></a><span class="kt">integer</span><span class="p">(</span><span class="kt">c_size_t</span><span class="p">),</span><span class="k">PARAMETER</span>             <span class="kd">::</span> <span class="n">nfpar</span><span class="o">=</span><span class="mi">8</span>
<a name="ln-2644"></a><span class="kt">integer</span><span class="p">(</span><span class="kt">c_size_t</span><span class="p">),</span><span class="k">PARAMETER</span>             <span class="kd">::</span> <span class="n">nq</span><span class="o">=</span><span class="mi">4</span>
<a name="ln-2645"></a><span class="kt">integer</span><span class="p">(</span><span class="kt">c_size_t</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>            <span class="kd">::</span> <span class="n">ipar</span><span class="p">(</span><span class="n">nipar</span><span class="p">)</span>
<a name="ln-2646"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>               <span class="kd">::</span> <span class="n">fpar</span><span class="p">(</span><span class="n">nfpar</span><span class="p">)</span>
<a name="ln-2647"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">OUT</span><span class="p">)</span>              <span class="kd">::</span> <span class="n">ECpattern</span><span class="p">(</span><span class="n">ipar</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span><span class="n">ipar</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span><span class="n">ipar</span><span class="p">(</span><span class="mi">8</span><span class="p">))</span>
<a name="ln-2648"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>               <span class="kd">::</span> <span class="n">quats</span><span class="p">(</span><span class="n">nq</span><span class="p">,</span><span class="n">ipar</span><span class="p">(</span><span class="mi">8</span><span class="p">))</span>
<a name="ln-2649"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>               <span class="kd">::</span> <span class="n">accum_e</span><span class="p">(</span><span class="n">ipar</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span><span class="o">-</span><span class="n">ipar</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span><span class="n">ipar</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span><span class="o">-</span><span class="n">ipar</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span><span class="n">ipar</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>
<a name="ln-2650"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>               <span class="kd">::</span> <span class="n">mLPNH</span><span class="p">(</span><span class="o">-</span><span class="n">ipar</span><span class="p">(</span><span class="mi">7</span><span class="p">):</span><span class="n">ipar</span><span class="p">(</span><span class="mi">7</span><span class="p">),</span> <span class="o">-</span><span class="n">ipar</span><span class="p">(</span><span class="mi">7</span><span class="p">):</span><span class="n">ipar</span><span class="p">(</span><span class="mi">7</span><span class="p">),</span> <span class="n">ipar</span><span class="p">(</span><span class="mi">6</span><span class="p">))</span>
<a name="ln-2651"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>               <span class="kd">::</span> <span class="n">mLPSH</span><span class="p">(</span><span class="o">-</span><span class="n">ipar</span><span class="p">(</span><span class="mi">7</span><span class="p">):</span><span class="n">ipar</span><span class="p">(</span><span class="mi">7</span><span class="p">),</span> <span class="o">-</span><span class="n">ipar</span><span class="p">(</span><span class="mi">7</span><span class="p">):</span><span class="n">ipar</span><span class="p">(</span><span class="mi">7</span><span class="p">),</span> <span class="n">ipar</span><span class="p">(</span><span class="mi">6</span><span class="p">))</span>
<a name="ln-2652"></a>
<a name="ln-2653"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">),</span><span class="k">allocatable</span><span class="p">,</span><span class="k">save</span>         <span class="kd">::</span> <span class="n">klist</span><span class="p">(:,:,:),</span> <span class="n">rgx</span><span class="p">(:,:),</span> <span class="n">rgy</span><span class="p">(:,:),</span> <span class="n">rgz</span><span class="p">(:,:),</span> <span class="n">weightfact</span><span class="p">(:)</span>
<a name="ln-2654"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">),</span><span class="k">allocatable</span><span class="p">,</span><span class="k">save</span>         <span class="kd">::</span> <span class="n">mLPNHsum</span><span class="p">(:,:),</span> <span class="n">mLPSHsum</span><span class="p">(:,:)</span>
<a name="ln-2655"></a>
<a name="ln-2656"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">dbl</span><span class="p">),</span><span class="k">parameter</span>                <span class="kd">::</span> <span class="n">Rtod</span> <span class="o">=</span> <span class="mi">5</span><span class="mf">7.2957795131D0</span>
<a name="ln-2657"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">dbl</span><span class="p">),</span><span class="k">parameter</span>                <span class="kd">::</span> <span class="n">dtoR</span> <span class="o">=</span> <span class="mf">0.01745329251D0</span>
<a name="ln-2658"></a>
<a name="ln-2659"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">)</span>                          <span class="kd">::</span> <span class="n">kk</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">thetacr</span><span class="p">,</span> <span class="n">ktmax</span><span class="p">,</span> <span class="n">delta</span><span class="p">,</span> <span class="n">wf</span><span class="p">,</span> <span class="n">quat</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<a name="ln-2660"></a><span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">irg</span><span class="p">)</span>                       <span class="kd">::</span> <span class="n">istat</span><span class="p">,</span> <span class="n">imin</span><span class="p">,</span> <span class="n">imax</span><span class="p">,</span> <span class="n">jmin</span><span class="p">,</span> <span class="n">jmax</span><span class="p">,</span> <span class="n">ii</span> <span class="p">,</span><span class="n">jj</span><span class="p">,</span> <span class="n">nazimuth</span><span class="p">,</span> <span class="n">npolar</span><span class="p">,</span> <span class="n">nsig</span><span class="p">,</span> <span class="n">ip</span>
<a name="ln-2661"></a><span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">irg</span><span class="p">)</span>                       <span class="kd">::</span> <span class="n">ipolar</span><span class="p">,</span> <span class="n">iazimuth</span><span class="p">,</span> <span class="n">isig</span><span class="p">,</span> <span class="n">isampletilt</span><span class="p">,</span> <span class="n">nix</span><span class="p">,</span> <span class="n">niy</span><span class="p">,</span> <span class="n">nixp</span><span class="p">,</span> <span class="n">niyp</span><span class="p">,</span> <span class="n">isigp</span>
<a name="ln-2662"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">)</span>                          <span class="kd">::</span> <span class="n">thetain</span><span class="p">,</span> <span class="n">thetaout</span><span class="p">,</span> <span class="n">polar</span><span class="p">,</span> <span class="n">azimuthal</span><span class="p">,</span> <span class="n">delpolar</span><span class="p">,</span> <span class="n">delazimuth</span><span class="p">,</span> <span class="n">om</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-2663"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">)</span>                          <span class="kd">::</span> <span class="n">dc</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">scl</span><span class="p">,</span> <span class="n">deltheta</span><span class="p">,</span> <span class="n">acc_sum</span><span class="p">,</span> <span class="n">MCangle</span><span class="p">,</span> <span class="n">ixy</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">dxm</span><span class="p">,</span> <span class="n">dym</span><span class="p">,</span> <span class="n">dp</span>
<a name="ln-2664"></a>
<a name="ln-2665"></a>
<a name="ln-2666"></a><span class="c">!==================================================================================</span>
<a name="ln-2667"></a><span class="c">! ------ generate the detector klist, rgx, rgy, rgz, weightfactors arrays if needed </span>
<a name="ln-2668"></a><span class="c">!------- (calling program must decide this via ipar(1))</span>
<a name="ln-2669"></a><span class="c">!==================================================================================</span>
<a name="ln-2670"></a>
<a name="ln-2671"></a><span class="n">imin</span> <span class="o">=</span> <span class="mi">1</span>
<a name="ln-2672"></a><span class="n">imax</span> <span class="o">=</span> <span class="n">ipar</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<a name="ln-2673"></a><span class="n">jmin</span> <span class="o">=</span> <span class="mi">1</span>
<a name="ln-2674"></a><span class="n">jmax</span> <span class="o">=</span> <span class="n">ipar</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-2675"></a>
<a name="ln-2676"></a><span class="k">if</span> <span class="p">(</span><span class="n">ipar</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="n">ge</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-2677"></a>
<a name="ln-2678"></a><span class="k">  if</span> <span class="p">(</span><span class="n">ipar</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="n">eq</span><span class="p">.</span><span class="mi">2</span><span class="p">)</span> <span class="k">then</span> <span class="c">! complete reset, including the mLPNHsum and mLPSHsum arrays</span>
<a name="ln-2679"></a>    <span class="k">if</span> <span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">mLPNHsum</span><span class="p">))</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">mLPNHsum</span><span class="p">)</span>
<a name="ln-2680"></a>    <span class="k">if</span> <span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">mLPSHsum</span><span class="p">))</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">mLPSHsum</span><span class="p">)</span>
<a name="ln-2681"></a>
<a name="ln-2682"></a>    <span class="k">allocate</span><span class="p">(</span><span class="n">mLPNHsum</span><span class="p">(</span><span class="o">-</span><span class="n">ipar</span><span class="p">(</span><span class="mi">7</span><span class="p">):</span><span class="n">ipar</span><span class="p">(</span><span class="mi">7</span><span class="p">),</span> <span class="o">-</span><span class="n">ipar</span><span class="p">(</span><span class="mi">7</span><span class="p">):</span><span class="n">ipar</span><span class="p">(</span><span class="mi">7</span><span class="p">)))</span>
<a name="ln-2683"></a>    <span class="k">allocate</span><span class="p">(</span><span class="n">mLPSHsum</span><span class="p">(</span><span class="o">-</span><span class="n">ipar</span><span class="p">(</span><span class="mi">7</span><span class="p">):</span><span class="n">ipar</span><span class="p">(</span><span class="mi">7</span><span class="p">),</span> <span class="o">-</span><span class="n">ipar</span><span class="p">(</span><span class="mi">7</span><span class="p">):</span><span class="n">ipar</span><span class="p">(</span><span class="mi">7</span><span class="p">)))</span>
<a name="ln-2684"></a>    <span class="n">mLPNHsum</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">mLPNH</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-2685"></a>    <span class="n">mLPSHsum</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">mLPSH</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-2686"></a>  <span class="k">end if</span>
<a name="ln-2687"></a>
<a name="ln-2688"></a><span class="k">    if</span> <span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">klist</span><span class="p">))</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">klist</span><span class="p">)</span>
<a name="ln-2689"></a>    <span class="k">allocate</span><span class="p">(</span><span class="n">klist</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">ipar</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span><span class="mi">1</span><span class="p">:</span><span class="n">ipar</span><span class="p">(</span><span class="mi">3</span><span class="p">)),</span> <span class="nb">stat</span><span class="o">=</span><span class="n">istat</span><span class="p">)</span>
<a name="ln-2690"></a>    <span class="n">kk</span> <span class="o">=</span> <span class="p">(</span><span class="o">/</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">1.0</span><span class="o">/</span><span class="p">)</span>
<a name="ln-2691"></a>    <span class="n">thetacr</span> <span class="o">=</span> <span class="n">DtoR</span><span class="o">*</span><span class="n">fpar</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-2692"></a>    <span class="n">ktmax</span> <span class="o">=</span> <span class="nb">tan</span><span class="p">(</span><span class="n">thetacr</span><span class="p">)</span>
<a name="ln-2693"></a>    <span class="n">delta</span> <span class="o">=</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">ktmax</span><span class="o">/</span><span class="nb">dble</span><span class="p">(</span><span class="n">ipar</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-2694"></a>     
<a name="ln-2695"></a>    <span class="k">do </span><span class="n">ii</span> <span class="o">=</span> <span class="n">imin</span><span class="p">,</span> <span class="n">imax</span>
<a name="ln-2696"></a>        <span class="k">do </span><span class="n">jj</span> <span class="o">=</span> <span class="n">jmin</span><span class="p">,</span> <span class="n">jmax</span>
<a name="ln-2697"></a>            <span class="n">klist</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="o">/-</span><span class="n">ktmax</span><span class="o">+</span><span class="n">delta</span><span class="o">*</span><span class="p">(</span><span class="n">ii</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span><span class="o">-</span><span class="n">ktmax</span><span class="o">+</span><span class="n">delta</span><span class="o">*</span><span class="p">(</span><span class="n">jj</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span><span class="mf">0.0</span><span class="o">/</span><span class="p">)</span> <span class="o">+</span> <span class="n">kk</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-2698"></a>            <span class="n">klist</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">)</span> <span class="o">=</span>  <span class="n">klist</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">)</span><span class="o">/</span><span class="nb">sqrt</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span> <span class="n">klist</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
<a name="ln-2699"></a>        <span class="k">end do</span>
<a name="ln-2700"></a><span class="k">    end do</span>
<a name="ln-2701"></a>
<a name="ln-2702"></a><span class="k">    </span><span class="n">thetain</span> <span class="o">=</span> <span class="n">atan2</span><span class="p">(</span><span class="n">fpar</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span><span class="n">fpar</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
<a name="ln-2703"></a>    <span class="n">thetaout</span> <span class="o">=</span> <span class="n">atan2</span><span class="p">(</span><span class="n">fpar</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span><span class="n">fpar</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
<a name="ln-2704"></a>
<a name="ln-2705"></a>    <span class="n">om</span><span class="p">(</span><span class="mi">1</span><span class="p">,:)</span> <span class="o">=</span> <span class="p">(</span><span class="o">/</span><span class="nb">cos</span><span class="p">(</span><span class="n">fpar</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="nb">sngl</span><span class="p">(</span><span class="n">dtor</span><span class="p">)),</span><span class="mf">0.0</span><span class="p">,</span><span class="nb">sin</span><span class="p">(</span><span class="n">fpar</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="nb">sngl</span><span class="p">(</span><span class="n">dtor</span><span class="p">))</span><span class="o">/</span><span class="p">)</span>
<a name="ln-2706"></a>    <span class="n">om</span><span class="p">(</span><span class="mi">2</span><span class="p">,:)</span> <span class="o">=</span> <span class="p">(</span><span class="o">/</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">1.0</span><span class="p">,</span><span class="mf">0.0</span><span class="o">/</span><span class="p">)</span>
<a name="ln-2707"></a>    <span class="n">om</span><span class="p">(</span><span class="mi">3</span><span class="p">,:)</span> <span class="o">=</span> <span class="p">(</span><span class="o">/-</span><span class="nb">sin</span><span class="p">(</span><span class="n">fpar</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="nb">sngl</span><span class="p">(</span><span class="n">dtor</span><span class="p">)),</span><span class="mf">0.0</span><span class="p">,</span><span class="nb">cos</span><span class="p">(</span><span class="n">fpar</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="nb">sngl</span><span class="p">(</span><span class="n">dtor</span><span class="p">))</span><span class="o">/</span><span class="p">)</span>
<a name="ln-2708"></a>
<a name="ln-2709"></a>    <span class="n">npolar</span> <span class="o">=</span> <span class="nb">nint</span><span class="p">((</span><span class="n">thetaout</span> <span class="o">-</span> <span class="n">thetain</span><span class="p">)</span><span class="o">*</span><span class="mi">18</span><span class="mf">0.0</span><span class="o">/</span><span class="n">cPi</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-2710"></a>    <span class="n">delpolar</span> <span class="o">=</span> <span class="p">(</span><span class="n">thetaout</span> <span class="o">-</span> <span class="n">thetain</span><span class="p">)</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">npolar</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-2711"></a>
<a name="ln-2712"></a>    <span class="n">nazimuth</span> <span class="o">=</span> <span class="mi">361</span>
<a name="ln-2713"></a>    <span class="n">delazimuth</span> <span class="o">=</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">cPi</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">nazimuth</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-2714"></a>
<a name="ln-2715"></a>    <span class="k">if</span> <span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">rgx</span><span class="p">))</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">rgx</span><span class="p">,</span> <span class="n">rgy</span><span class="p">,</span> <span class="n">rgz</span><span class="p">)</span>
<a name="ln-2716"></a>    <span class="k">allocate</span><span class="p">(</span><span class="n">rgx</span><span class="p">(</span><span class="n">npolar</span><span class="p">,</span> <span class="n">nazimuth</span><span class="p">),</span> <span class="n">rgy</span><span class="p">(</span><span class="n">npolar</span><span class="p">,</span> <span class="n">nazimuth</span><span class="p">),</span> <span class="n">rgz</span><span class="p">(</span><span class="n">npolar</span><span class="p">,</span> <span class="n">nazimuth</span><span class="p">),</span> <span class="nb">stat</span><span class="o">=</span><span class="n">istat</span><span class="p">)</span>
<a name="ln-2717"></a>
<a name="ln-2718"></a>    <span class="k">do </span><span class="n">ipolar</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="n">npolar</span>
<a name="ln-2719"></a>         <span class="n">polar</span> <span class="o">=</span> <span class="n">thetain</span> <span class="o">+</span> <span class="nb">float</span><span class="p">(</span><span class="n">ipolar</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">delpolar</span>
<a name="ln-2720"></a>
<a name="ln-2721"></a>         <span class="k">do </span><span class="n">iazimuth</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="n">nazimuth</span>
<a name="ln-2722"></a>             <span class="n">azimuthal</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">iazimuth</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">delazimuth</span>
<a name="ln-2723"></a>
<a name="ln-2724"></a>             <span class="n">dc</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="nb">cos</span><span class="p">(</span><span class="n">azimuthal</span><span class="p">)</span><span class="o">*</span><span class="nb">sin</span><span class="p">(</span><span class="n">polar</span><span class="p">)</span>
<a name="ln-2725"></a>             <span class="n">dc</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="nb">sin</span><span class="p">(</span><span class="n">azimuthal</span><span class="p">)</span><span class="o">*</span><span class="nb">sin</span><span class="p">(</span><span class="n">polar</span><span class="p">)</span>
<a name="ln-2726"></a>             <span class="n">dc</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="nb">cos</span><span class="p">(</span><span class="n">polar</span><span class="p">)</span>
<a name="ln-2727"></a>
<a name="ln-2728"></a>             <span class="n">dc</span> <span class="o">=</span> <span class="nb">matmul</span><span class="p">(</span><span class="n">om</span><span class="p">,</span><span class="n">dc</span><span class="p">)</span>
<a name="ln-2729"></a>
<a name="ln-2730"></a>             <span class="n">rgx</span><span class="p">(</span><span class="n">ipolar</span><span class="p">,</span><span class="n">iazimuth</span><span class="p">)</span> <span class="o">=</span> <span class="n">dc</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-2731"></a>             <span class="n">rgy</span><span class="p">(</span><span class="n">ipolar</span><span class="p">,</span><span class="n">iazimuth</span><span class="p">)</span> <span class="o">=</span> <span class="n">dc</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<a name="ln-2732"></a>             <span class="n">rgz</span><span class="p">(</span><span class="n">ipolar</span><span class="p">,</span><span class="n">iazimuth</span><span class="p">)</span> <span class="o">=</span> <span class="n">dc</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-2733"></a>        <span class="k">end do</span>
<a name="ln-2734"></a><span class="k">    end do</span>
<a name="ln-2735"></a>
<a name="ln-2736"></a><span class="c">!===================================================================</span>
<a name="ln-2737"></a><span class="c">! ------ generate the weight factors from the monte carlo histogram</span>
<a name="ln-2738"></a><span class="c">!===================================================================</span>
<a name="ln-2739"></a>
<a name="ln-2740"></a>    <span class="n">scl</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">ipar</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>
<a name="ln-2741"></a>    <span class="n">nsig</span> <span class="o">=</span> <span class="nb">nint</span><span class="p">(</span><span class="n">fpar</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="nb">abs</span><span class="p">(</span><span class="n">fpar</span><span class="p">(</span><span class="mi">2</span><span class="p">)))</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-2742"></a>
<a name="ln-2743"></a>    <span class="n">deltheta</span> <span class="o">=</span> <span class="p">(</span><span class="n">fpar</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="nb">abs</span><span class="p">(</span><span class="n">fpar</span><span class="p">(</span><span class="mi">2</span><span class="p">)))</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">nsig</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-2744"></a>
<a name="ln-2745"></a>    <span class="k">if</span> <span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">weightfact</span><span class="p">))</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">weightfact</span><span class="p">)</span>
<a name="ln-2746"></a>    <span class="k">allocate</span><span class="p">(</span><span class="n">weightfact</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">nsig</span><span class="p">),</span> <span class="nb">stat</span><span class="o">=</span><span class="n">istat</span><span class="p">)</span>
<a name="ln-2747"></a>    <span class="n">weightfact</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-2748"></a>
<a name="ln-2749"></a>    <span class="k">do </span><span class="n">isig</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="n">nsig</span>
<a name="ln-2750"></a>        <span class="n">acc_sum</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-2751"></a>        <span class="n">MCangle</span> <span class="o">=</span> <span class="p">(</span><span class="n">isig</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">deltheta</span>
<a name="ln-2752"></a>        <span class="n">isampletilt</span> <span class="o">=</span> <span class="nb">nint</span><span class="p">((</span><span class="n">MCangle</span> <span class="o">-</span> <span class="n">fpar</span><span class="p">(</span><span class="mi">6</span><span class="p">))</span><span class="o">/</span><span class="n">fpar</span><span class="p">(</span><span class="mi">8</span><span class="p">))</span>
<a name="ln-2753"></a>    
<a name="ln-2754"></a>        <span class="k">if</span> <span class="p">(</span><span class="n">isampletilt</span> <span class="p">.</span><span class="n">lt</span><span class="p">.</span> <span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-2755"></a><span class="k">            </span><span class="n">isampletilt</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">isampletilt</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-2756"></a>        <span class="k">else</span>
<a name="ln-2757"></a><span class="k">            </span><span class="n">isampletilt</span> <span class="o">=</span> <span class="n">isampletilt</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-2758"></a>        <span class="k">end if</span>
<a name="ln-2759"></a>
<a name="ln-2760"></a><span class="k">        do </span><span class="n">ipolar</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="n">npolar</span>
<a name="ln-2761"></a>            <span class="k">do </span><span class="n">iazimuth</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="n">nazimuth</span>
<a name="ln-2762"></a>                <span class="n">dc</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="o">/</span><span class="n">rgx</span><span class="p">(</span><span class="n">ipolar</span><span class="p">,</span><span class="n">iazimuth</span><span class="p">),</span> <span class="n">rgy</span><span class="p">(</span><span class="n">ipolar</span><span class="p">,</span><span class="n">iazimuth</span><span class="p">),</span> <span class="n">rgz</span><span class="p">(</span><span class="n">ipolar</span><span class="p">,</span><span class="n">iazimuth</span><span class="p">)</span><span class="o">/</span><span class="p">)</span>
<a name="ln-2763"></a><span class="c">! convert to Rosca-lambert projection</span>
<a name="ln-2764"></a>                <span class="n">ixy</span> <span class="o">=</span> <span class="n">scl</span> <span class="o">*</span>  <span class="n">LambertSphereToSquare</span><span class="p">(</span> <span class="n">dc</span><span class="p">,</span> <span class="n">istat</span> <span class="p">)</span>
<a name="ln-2765"></a>                <span class="n">nix</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ipar</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">+</span><span class="n">ixy</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="o">-</span><span class="n">ipar</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<a name="ln-2766"></a>                <span class="n">niy</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ipar</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">+</span><span class="n">ixy</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span><span class="o">-</span><span class="n">ipar</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<a name="ln-2767"></a>                <span class="n">nixp</span> <span class="o">=</span> <span class="n">nix</span><span class="o">+</span><span class="mi">1</span>
<a name="ln-2768"></a>                <span class="n">niyp</span> <span class="o">=</span> <span class="n">niy</span><span class="o">+</span><span class="mi">1</span>
<a name="ln-2769"></a>                <span class="k">if</span> <span class="p">(</span><span class="n">nixp</span><span class="p">.</span><span class="n">gt</span><span class="p">.</span><span class="n">ipar</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span> <span class="n">nixp</span> <span class="o">=</span> <span class="n">nix</span>
<a name="ln-2770"></a>                <span class="k">if</span> <span class="p">(</span><span class="n">niyp</span><span class="p">.</span><span class="n">gt</span><span class="p">.</span><span class="n">ipar</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span> <span class="n">niyp</span> <span class="o">=</span> <span class="n">niy</span>
<a name="ln-2771"></a>                <span class="k">if</span> <span class="p">(</span><span class="n">nix</span><span class="p">.</span><span class="n">lt</span><span class="p">.</span><span class="o">-</span><span class="n">ipar</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span> <span class="n">nix</span> <span class="o">=</span> <span class="n">nixp</span>
<a name="ln-2772"></a>                <span class="k">if</span> <span class="p">(</span><span class="n">niy</span><span class="p">.</span><span class="n">lt</span><span class="p">.</span><span class="o">-</span><span class="n">ipar</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span> <span class="n">niy</span> <span class="o">=</span> <span class="n">niyp</span>
<a name="ln-2773"></a>                <span class="n">dx</span> <span class="o">=</span> <span class="n">ixy</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">nix</span>
<a name="ln-2774"></a>                <span class="n">dy</span> <span class="o">=</span> <span class="n">ixy</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">-</span><span class="n">niy</span>
<a name="ln-2775"></a>                <span class="n">dxm</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">-</span><span class="n">dx</span>
<a name="ln-2776"></a>                <span class="n">dym</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">-</span><span class="n">dy</span>
<a name="ln-2777"></a>            
<a name="ln-2778"></a>                <span class="n">acc_sum</span> <span class="o">=</span> <span class="mf">0.25</span><span class="o">*</span><span class="p">(</span><span class="n">accum_e</span><span class="p">(</span><span class="n">isampletilt</span><span class="p">,</span><span class="n">nix</span><span class="p">,</span><span class="n">niy</span><span class="p">)</span> <span class="o">*</span> <span class="n">dxm</span> <span class="o">*</span> <span class="n">dym</span> <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-2779"></a>                                <span class="n">accum_e</span><span class="p">(</span><span class="n">isampletilt</span><span class="p">,</span><span class="n">nixp</span><span class="p">,</span><span class="n">niy</span><span class="p">)</span> <span class="o">*</span> <span class="n">dx</span> <span class="o">*</span> <span class="n">dym</span> <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-2780"></a>                                <span class="n">accum_e</span><span class="p">(</span><span class="n">isampletilt</span><span class="p">,</span><span class="n">nix</span><span class="p">,</span><span class="n">niyp</span><span class="p">)</span> <span class="o">*</span> <span class="n">dxm</span> <span class="o">*</span> <span class="n">dy</span> <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-2781"></a>                                <span class="n">accum_e</span><span class="p">(</span><span class="n">isampletilt</span><span class="p">,</span><span class="n">nixp</span><span class="p">,</span><span class="n">niyp</span><span class="p">)</span> <span class="o">*</span> <span class="n">dx</span> <span class="o">*</span> <span class="n">dy</span><span class="p">)</span>
<a name="ln-2782"></a>             
<a name="ln-2783"></a>                <span class="n">weightfact</span><span class="p">(</span><span class="n">isig</span><span class="p">)</span> <span class="o">=</span> <span class="n">weightfact</span><span class="p">(</span><span class="n">isig</span><span class="p">)</span> <span class="o">+</span> <span class="n">acc_sum</span>
<a name="ln-2784"></a>
<a name="ln-2785"></a>            <span class="k">end do</span>
<a name="ln-2786"></a><span class="k">        end do</span>
<a name="ln-2787"></a><span class="k">    end do</span>
<a name="ln-2788"></a>
<a name="ln-2789"></a><span class="k">    </span><span class="n">weightfact</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">nsig</span><span class="p">)</span> <span class="o">=</span> <span class="n">weightfact</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">nsig</span><span class="p">)</span><span class="o">/</span><span class="n">weightfact</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-2790"></a>
<a name="ln-2791"></a><span class="k">end if</span>
<a name="ln-2792"></a>
<a name="ln-2793"></a><span class="c">!===================================================================</span>
<a name="ln-2794"></a><span class="c">! ------ perform interpolation from square lambert map</span>
<a name="ln-2795"></a><span class="c">!===================================================================</span>
<a name="ln-2796"></a><span class="n">scl</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">ipar</span><span class="p">(</span><span class="mi">7</span><span class="p">))</span>
<a name="ln-2797"></a>
<a name="ln-2798"></a><span class="k">do </span><span class="n">ip</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">ipar</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
<a name="ln-2799"></a>  <span class="k">do </span><span class="n">ii</span> <span class="o">=</span> <span class="n">imin</span><span class="p">,</span> <span class="n">imax</span>
<a name="ln-2800"></a>    <span class="k">do </span><span class="n">jj</span> <span class="o">=</span> <span class="n">jmin</span><span class="p">,</span> <span class="n">jmax</span>
<a name="ln-2801"></a>
<a name="ln-2802"></a>        <span class="n">dc</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">klist</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">)</span>
<a name="ln-2803"></a>        <span class="n">dc</span> <span class="o">=</span> <span class="n">dc</span><span class="o">/</span><span class="nb">sqrt</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">dc</span><span class="o">*</span><span class="n">dc</span><span class="p">))</span>
<a name="ln-2804"></a>        
<a name="ln-2805"></a>        <span class="n">dp</span> <span class="o">=</span> <span class="nb">DOT_PRODUCT</span><span class="p">(</span><span class="n">dc</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">),(</span><span class="o">/</span><span class="nb">sin</span><span class="p">(</span><span class="n">fpar</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">dtoR</span><span class="p">),</span><span class="mf">0.D0</span><span class="p">,</span><span class="nb">cos</span><span class="p">(</span><span class="n">fpar</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">dtoR</span><span class="p">)</span><span class="o">/</span><span class="p">))</span>      
<a name="ln-2806"></a>        <span class="k">if</span> <span class="p">(</span><span class="n">dp</span> <span class="p">.</span><span class="n">gt</span><span class="p">.</span> <span class="mf">1.D0</span><span class="p">)</span> <span class="n">dp</span> <span class="o">=</span> <span class="mf">1.0</span>
<a name="ln-2807"></a>        <span class="n">MCangle</span> <span class="o">=</span> <span class="nb">acos</span><span class="p">(</span><span class="n">dp</span><span class="p">)</span><span class="o">*</span><span class="n">Rtod</span>
<a name="ln-2808"></a>        <span class="n">isig</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">MCangle</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-2809"></a>        <span class="k">if</span> <span class="p">(</span><span class="n">isig</span> <span class="p">.</span><span class="n">gt</span><span class="p">.</span> <span class="n">nsig</span><span class="p">)</span> <span class="n">isig</span> <span class="o">=</span> <span class="n">nsig</span>
<a name="ln-2810"></a>
<a name="ln-2811"></a>        <span class="n">isigp</span> <span class="o">=</span> <span class="n">isig</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-2812"></a>        <span class="k">if</span> <span class="p">(</span><span class="n">isigp</span> <span class="p">.</span><span class="n">gt</span><span class="p">.</span> <span class="n">nsig</span><span class="p">)</span> <span class="n">isigp</span> <span class="o">=</span> <span class="n">nsig</span>
<a name="ln-2813"></a>        <span class="n">dx</span> <span class="o">=</span> <span class="n">MCangle</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="n">MCangle</span><span class="p">)</span>
<a name="ln-2814"></a>        <span class="n">dxm</span> <span class="o">=</span>  <span class="mf">1.0</span> <span class="o">-</span> <span class="n">dx</span>
<a name="ln-2815"></a>        
<a name="ln-2816"></a>        <span class="n">wf</span> <span class="o">=</span> <span class="n">weightfact</span><span class="p">(</span><span class="n">isig</span><span class="p">)</span> <span class="o">*</span> <span class="n">dxm</span> <span class="o">+</span> <span class="n">weightfact</span><span class="p">(</span><span class="n">isigp</span><span class="p">)</span> <span class="o">*</span> <span class="n">dx</span>
<a name="ln-2817"></a>        <span class="n">wf</span> <span class="o">=</span> <span class="mf">1.0</span>
<a name="ln-2818"></a>        <span class="n">dc</span> <span class="o">=</span> <span class="n">quat_LP</span><span class="p">(</span><span class="n">quats</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span><span class="n">ip</span><span class="p">),</span> <span class="n">dc</span><span class="p">)</span>
<a name="ln-2819"></a>        <span class="n">dc</span> <span class="o">=</span> <span class="n">dc</span><span class="o">/</span><span class="nb">sqrt</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">dc</span><span class="o">*</span><span class="n">dc</span><span class="p">))</span>
<a name="ln-2820"></a>
<a name="ln-2821"></a>        <span class="n">ixy</span> <span class="o">=</span> <span class="n">scl</span> <span class="o">*</span> <span class="n">LambertSphereToSquare</span><span class="p">(</span> <span class="n">dc</span><span class="p">,</span> <span class="n">istat</span> <span class="p">)</span>
<a name="ln-2822"></a>        <span class="n">nix</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ipar</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span><span class="o">+</span><span class="n">ixy</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="o">-</span><span class="n">ipar</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span>
<a name="ln-2823"></a>        <span class="n">niy</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ipar</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span><span class="o">+</span><span class="n">ixy</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span><span class="o">-</span><span class="n">ipar</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span>
<a name="ln-2824"></a>        <span class="n">nixp</span> <span class="o">=</span> <span class="n">nix</span><span class="o">+</span><span class="mi">1</span>
<a name="ln-2825"></a>        <span class="n">niyp</span> <span class="o">=</span> <span class="n">niy</span><span class="o">+</span><span class="mi">1</span>
<a name="ln-2826"></a>        <span class="k">if</span> <span class="p">(</span><span class="n">nixp</span><span class="p">.</span><span class="n">gt</span><span class="p">.</span><span class="n">ipar</span><span class="p">(</span><span class="mi">7</span><span class="p">))</span> <span class="n">nixp</span> <span class="o">=</span> <span class="n">nix</span>
<a name="ln-2827"></a>        <span class="k">if</span> <span class="p">(</span><span class="n">niyp</span><span class="p">.</span><span class="n">gt</span><span class="p">.</span><span class="n">ipar</span><span class="p">(</span><span class="mi">7</span><span class="p">))</span> <span class="n">niyp</span> <span class="o">=</span> <span class="n">niy</span>
<a name="ln-2828"></a>        <span class="k">if</span> <span class="p">(</span><span class="n">nix</span><span class="p">.</span><span class="n">lt</span><span class="p">.</span><span class="o">-</span><span class="n">ipar</span><span class="p">(</span><span class="mi">7</span><span class="p">))</span> <span class="n">nix</span> <span class="o">=</span> <span class="n">nixp</span>
<a name="ln-2829"></a>        <span class="k">if</span> <span class="p">(</span><span class="n">niy</span><span class="p">.</span><span class="n">lt</span><span class="p">.</span><span class="o">-</span><span class="n">ipar</span><span class="p">(</span><span class="mi">7</span><span class="p">))</span> <span class="n">niy</span> <span class="o">=</span> <span class="n">niyp</span>
<a name="ln-2830"></a>        <span class="n">dx</span> <span class="o">=</span> <span class="n">ixy</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">nix</span>
<a name="ln-2831"></a>        <span class="n">dy</span> <span class="o">=</span> <span class="n">ixy</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">-</span><span class="n">niy</span>
<a name="ln-2832"></a>        <span class="n">dxm</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">-</span><span class="n">dx</span>
<a name="ln-2833"></a>        <span class="n">dym</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">-</span><span class="n">dy</span>
<a name="ln-2834"></a>
<a name="ln-2835"></a>        <span class="k">if</span> <span class="p">(</span><span class="n">dc</span><span class="p">(</span><span class="mi">3</span><span class="p">).</span><span class="n">gt</span><span class="p">.</span><span class="mf">0.0</span><span class="p">)</span> <span class="k">then </span>
<a name="ln-2836"></a><span class="k">            </span><span class="n">ECpattern</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">,</span><span class="n">ip</span><span class="p">)</span> <span class="o">=</span> <span class="n">wf</span> <span class="o">*</span> <span class="p">(</span> <span class="n">mLPNHsum</span><span class="p">(</span><span class="n">nix</span><span class="p">,</span><span class="n">niy</span><span class="p">)</span> <span class="o">*</span> <span class="n">dxm</span> <span class="o">*</span> <span class="n">dym</span> <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-2837"></a>                         <span class="n">mLPNHsum</span><span class="p">(</span><span class="n">nixp</span><span class="p">,</span><span class="n">niy</span><span class="p">)</span> <span class="o">*</span> <span class="n">dx</span> <span class="o">*</span> <span class="n">dym</span> <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-2838"></a>                         <span class="n">mLPNHsum</span><span class="p">(</span><span class="n">nix</span><span class="p">,</span><span class="n">niyp</span><span class="p">)</span> <span class="o">*</span> <span class="n">dxm</span> <span class="o">*</span> <span class="n">dy</span> <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-2839"></a>                         <span class="n">mLPNHsum</span><span class="p">(</span><span class="n">nixp</span><span class="p">,</span><span class="n">niyp</span><span class="p">)</span> <span class="o">*</span> <span class="n">dx</span> <span class="o">*</span> <span class="n">dy</span> <span class="p">)</span>
<a name="ln-2840"></a>
<a name="ln-2841"></a>        <span class="k">else</span>
<a name="ln-2842"></a><span class="k">            </span><span class="n">ECpattern</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">,</span><span class="n">ip</span><span class="p">)</span> <span class="o">=</span>  <span class="n">wf</span> <span class="o">*</span> <span class="p">(</span> <span class="n">mLPSHsum</span><span class="p">(</span><span class="n">nix</span><span class="p">,</span><span class="n">niy</span><span class="p">)</span> <span class="o">*</span> <span class="n">dxm</span> <span class="o">*</span> <span class="n">dym</span> <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-2843"></a>                         <span class="n">mLPSHsum</span><span class="p">(</span><span class="n">nixp</span><span class="p">,</span><span class="n">niy</span><span class="p">)</span> <span class="o">*</span> <span class="n">dx</span> <span class="o">*</span> <span class="n">dym</span> <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-2844"></a>                         <span class="n">mLPSHsum</span><span class="p">(</span><span class="n">nix</span><span class="p">,</span><span class="n">niyp</span><span class="p">)</span> <span class="o">*</span> <span class="n">dxm</span> <span class="o">*</span> <span class="n">dy</span> <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-2845"></a>                         <span class="n">mLPSHsum</span><span class="p">(</span><span class="n">nixp</span><span class="p">,</span><span class="n">niyp</span><span class="p">)</span> <span class="o">*</span> <span class="n">dx</span> <span class="o">*</span> <span class="n">dy</span> <span class="p">)</span>
<a name="ln-2846"></a>        <span class="k">end if</span>
<a name="ln-2847"></a>
<a name="ln-2848"></a><span class="k">    end do</span>
<a name="ln-2849"></a><span class="k">  end do</span>
<a name="ln-2850"></a><span class="k">end do</span>
<a name="ln-2851"></a>
<a name="ln-2852"></a>
<a name="ln-2853"></a><span class="k">end subroutine </span><span class="n">getECPatterns</span>
<a name="ln-2854"></a>
<a name="ln-2855"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-2856"></a><span class="c">!</span>
<a name="ln-2857"></a><span class="c">! SUBROUTINE:getKosselPatterns</span>
<a name="ln-2858"></a><span class="c">!</span>
<a name="ln-2859"></a><span class="c">!&gt; @author Marc De Graef, Carnegie Mellon University</span>
<a name="ln-2860"></a><span class="c">!</span>
<a name="ln-2861"></a><span class="c">!&gt; @brief This function can be called as a standalone function to compute a Kossel pattern</span>
<a name="ln-2862"></a><span class="c">!</span>
<a name="ln-2863"></a><span class="c">!&gt; @etails The main purpose of this routine and its accompanying wrapper routine is to</span>
<a name="ln-2864"></a><span class="c">!&gt; provide a way for an external program to compute a Kossel pattern.  The idea is that </span>
<a name="ln-2865"></a><span class="c">!&gt; all the necessary arrays and variables are passed in by reference as arguments, without</span>
<a name="ln-2866"></a><span class="c">!&gt; the need for the routine to fetch any other data from files etc...  The initial goal is</span>
<a name="ln-2867"></a><span class="c">!&gt; to have a function that can be called with the CALL_EXTERNAL mechanism in IDL, but </span>
<a name="ln-2868"></a><span class="c">!&gt; in the long run this will also be the approach for calling the routine from C/C++, which</span>
<a name="ln-2869"></a><span class="c">!&gt; is an essential part of integration with DREAM.3D.  </span>
<a name="ln-2870"></a><span class="c">!&gt;</span>
<a name="ln-2871"></a><span class="c">!&gt; This routine will first compute the incident cone vectors etc. if necessary, and then perform</span>
<a name="ln-2872"></a><span class="c">!&gt; the usual interpolation from the square Lambert projection. The pattern will be a basic pattern,</span>
<a name="ln-2873"></a><span class="c">!&gt; without any intensity scaling or binning etc; the calling program should take care of those </span>
<a name="ln-2874"></a><span class="c">!&gt; operations. This is simpler than the ECP case, since there is no energy dependent stuff to </span>
<a name="ln-2875"></a><span class="c">!&gt; worry about. We&#39;re also keeping the ipar and fpar arrays the same as for the ECP case, even</span>
<a name="ln-2876"></a><span class="c">!&gt; though we could in principle simplify them; this facilitates integration with the SEMDisplay </span>
<a name="ln-2877"></a><span class="c">!&gt; program.</span>
<a name="ln-2878"></a><span class="c">!</span>
<a name="ln-2879"></a><span class="c">!&gt; @param ipar array with integer input parameters</span>
<a name="ln-2880"></a><span class="c">!&gt; @param fpar array with float input parameters</span>
<a name="ln-2881"></a><span class="c">!&gt; @param KosselPattern output array</span>
<a name="ln-2882"></a><span class="c">!&gt; @param quats array of quaternions</span>
<a name="ln-2883"></a><span class="c">!&gt; @param mLPNH Northern hemisphere master pattern</span>
<a name="ln-2884"></a><span class="c">!&gt; @param mLPSH Southern hemisphere master pattern</span>
<a name="ln-2885"></a><span class="c">!</span>
<a name="ln-2886"></a><span class="c">!&gt; @date 11/09/15 MDG 1.0 original</span>
<a name="ln-2887"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-2888"></a><span class="k">recursive subroutine </span><span class="n">getKosselPatterns</span><span class="p">(</span><span class="n">ipar</span><span class="p">,</span> <span class="n">fpar</span><span class="p">,</span> <span class="n">Kosselpattern</span><span class="p">,</span> <span class="n">quats</span><span class="p">,</span> <span class="n">mLPNH</span><span class="p">,</span> <span class="n">mLPSH</span><span class="p">)</span>
<a name="ln-2889"></a><span class="c">!DEC$ ATTRIBUTES DLLEXPORT :: getKosselPatterns</span>
<a name="ln-2890"></a>
<a name="ln-2891"></a><span class="c">! the input parameters are all part of a ipar and fpar input arrays instead of the usual namelist structures.</span>
<a name="ln-2892"></a><span class="c">! The following is the mapping:</span>
<a name="ln-2893"></a><span class="c">!</span>
<a name="ln-2894"></a><span class="c">! ipar(1) = 1 if GetVectorsCone detector arrays need to be computed, 0 if not (arrays will have save status)</span>
<a name="ln-2895"></a><span class="c">! ipar(2) = detnumsx</span>
<a name="ln-2896"></a><span class="c">! ipar(3) = mpnpx</span>
<a name="ln-2897"></a><span class="c">! ipar(4) = numquats</span>
<a name="ln-2898"></a><span class="c">! ipar(5) = numdepths</span>
<a name="ln-2899"></a><span class="c">! ipar(6) = depthsel</span>
<a name="ln-2900"></a>
<a name="ln-2901"></a><span class="c">! fpar(1) = ecpnl%thetac</span>
<a name="ln-2902"></a>
<a name="ln-2903"></a><span class="k">use </span><span class="n">local</span>
<a name="ln-2904"></a><span class="k">use </span><span class="n">constants</span>
<a name="ln-2905"></a><span class="k">use </span><span class="n">Lambert</span>
<a name="ln-2906"></a><span class="k">use </span><span class="n">quaternions</span>
<a name="ln-2907"></a><span class="k">use</span><span class="p">,</span><span class="k">INTRINSIC</span> <span class="kd">::</span> <span class="nb">ISO_C_BINDING</span>
<a name="ln-2908"></a>
<a name="ln-2909"></a><span class="k">IMPLICIT NONE</span>
<a name="ln-2910"></a>
<a name="ln-2911"></a><span class="kt">integer</span><span class="p">(</span><span class="kt">c_size_t</span><span class="p">),</span><span class="k">PARAMETER</span>             <span class="kd">::</span> <span class="n">nipar</span><span class="o">=</span><span class="mi">6</span>
<a name="ln-2912"></a><span class="kt">integer</span><span class="p">(</span><span class="kt">c_size_t</span><span class="p">),</span><span class="k">PARAMETER</span>             <span class="kd">::</span> <span class="n">nfpar</span><span class="o">=</span><span class="mi">1</span>
<a name="ln-2913"></a><span class="kt">integer</span><span class="p">(</span><span class="kt">c_size_t</span><span class="p">),</span><span class="k">PARAMETER</span>             <span class="kd">::</span> <span class="n">nq</span><span class="o">=</span><span class="mi">4</span>
<a name="ln-2914"></a><span class="kt">integer</span><span class="p">(</span><span class="kt">c_size_t</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>            <span class="kd">::</span> <span class="n">ipar</span><span class="p">(</span><span class="n">nipar</span><span class="p">)</span>
<a name="ln-2915"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>               <span class="kd">::</span> <span class="n">fpar</span><span class="p">(</span><span class="n">nfpar</span><span class="p">)</span>
<a name="ln-2916"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">OUT</span><span class="p">)</span>              <span class="kd">::</span> <span class="n">Kosselpattern</span><span class="p">(</span><span class="n">ipar</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span><span class="n">ipar</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span><span class="n">ipar</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
<a name="ln-2917"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>               <span class="kd">::</span> <span class="n">quats</span><span class="p">(</span><span class="n">nq</span><span class="p">,</span><span class="n">ipar</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
<a name="ln-2918"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>               <span class="kd">::</span> <span class="n">mLPNH</span><span class="p">(</span><span class="o">-</span><span class="n">ipar</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span><span class="n">ipar</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="o">-</span><span class="n">ipar</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span><span class="n">ipar</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span><span class="n">ipar</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>
<a name="ln-2919"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>               <span class="kd">::</span> <span class="n">mLPSH</span><span class="p">(</span><span class="o">-</span><span class="n">ipar</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span><span class="n">ipar</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="o">-</span><span class="n">ipar</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span><span class="n">ipar</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span><span class="n">ipar</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>
<a name="ln-2920"></a>
<a name="ln-2921"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">),</span><span class="k">allocatable</span><span class="p">,</span><span class="k">save</span>         <span class="kd">::</span> <span class="n">klist</span><span class="p">(:,:,:)</span>
<a name="ln-2922"></a>
<a name="ln-2923"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">dbl</span><span class="p">),</span><span class="k">parameter</span>                <span class="kd">::</span> <span class="n">Rtod</span> <span class="o">=</span> <span class="mi">5</span><span class="mf">7.2957795131D0</span>
<a name="ln-2924"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">dbl</span><span class="p">),</span><span class="k">parameter</span>                <span class="kd">::</span> <span class="n">dtoR</span> <span class="o">=</span> <span class="mf">0.01745329251D0</span>
<a name="ln-2925"></a>
<a name="ln-2926"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">)</span>                          <span class="kd">::</span> <span class="n">kk</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">thetacr</span><span class="p">,</span> <span class="n">ktmax</span><span class="p">,</span> <span class="n">delta</span><span class="p">,</span> <span class="n">quat</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<a name="ln-2927"></a><span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">irg</span><span class="p">)</span>                       <span class="kd">::</span> <span class="n">istat</span><span class="p">,</span> <span class="n">imin</span><span class="p">,</span> <span class="n">imax</span><span class="p">,</span> <span class="n">jmin</span><span class="p">,</span> <span class="n">jmax</span><span class="p">,</span> <span class="n">ii</span> <span class="p">,</span><span class="n">jj</span><span class="p">,</span> <span class="n">nsig</span><span class="p">,</span> <span class="n">ip</span>
<a name="ln-2928"></a><span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">irg</span><span class="p">)</span>                       <span class="kd">::</span> <span class="n">isig</span><span class="p">,</span> <span class="n">nix</span><span class="p">,</span> <span class="n">niy</span><span class="p">,</span> <span class="n">nixp</span><span class="p">,</span> <span class="n">niyp</span><span class="p">,</span> <span class="n">isigp</span>
<a name="ln-2929"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">)</span>                          <span class="kd">::</span> <span class="n">dc</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">scl</span><span class="p">,</span> <span class="n">ixy</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">dxm</span><span class="p">,</span> <span class="n">dym</span><span class="p">,</span> <span class="n">dp</span>
<a name="ln-2930"></a>
<a name="ln-2931"></a>
<a name="ln-2932"></a><span class="c">!==================================================================================</span>
<a name="ln-2933"></a><span class="c">! ------ generate the detector klist array if needed </span>
<a name="ln-2934"></a><span class="c">!------- (calling program must decide this via ipar(1))</span>
<a name="ln-2935"></a><span class="c">!==================================================================================</span>
<a name="ln-2936"></a>
<a name="ln-2937"></a><span class="k">if</span> <span class="p">(</span><span class="n">ipar</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="n">ge</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-2938"></a>
<a name="ln-2939"></a><span class="k">    if</span> <span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">klist</span><span class="p">))</span> <span class="k">deallocate</span><span class="p">(</span><span class="n">klist</span><span class="p">)</span>
<a name="ln-2940"></a>    <span class="k">allocate</span><span class="p">(</span><span class="n">klist</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span><span class="o">-</span><span class="n">ipar</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span><span class="n">ipar</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span><span class="o">-</span><span class="n">ipar</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span><span class="n">ipar</span><span class="p">(</span><span class="mi">2</span><span class="p">)),</span> <span class="nb">stat</span><span class="o">=</span><span class="n">istat</span><span class="p">)</span>
<a name="ln-2941"></a>    <span class="n">kk</span> <span class="o">=</span> <span class="p">(</span><span class="o">/</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">1.0</span><span class="o">/</span><span class="p">)</span>
<a name="ln-2942"></a>    <span class="n">thetacr</span> <span class="o">=</span> <span class="n">DtoR</span><span class="o">*</span><span class="n">fpar</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-2943"></a>    <span class="n">ktmax</span> <span class="o">=</span> <span class="nb">tan</span><span class="p">(</span><span class="n">thetacr</span><span class="p">)</span>
<a name="ln-2944"></a>    <span class="n">delta</span> <span class="o">=</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">ktmax</span><span class="o">/</span><span class="nb">dble</span><span class="p">(</span><span class="n">ipar</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-2945"></a>
<a name="ln-2946"></a>    <span class="n">imin</span> <span class="o">=</span> <span class="mi">1</span>
<a name="ln-2947"></a>    <span class="n">imax</span> <span class="o">=</span> <span class="n">ipar</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<a name="ln-2948"></a>    <span class="n">jmin</span> <span class="o">=</span> <span class="mi">1</span>
<a name="ln-2949"></a>    <span class="n">jmax</span> <span class="o">=</span> <span class="n">ipar</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<a name="ln-2950"></a>     
<a name="ln-2951"></a>    <span class="k">do </span><span class="n">ii</span> <span class="o">=</span> <span class="n">imin</span><span class="p">,</span> <span class="n">imax</span>
<a name="ln-2952"></a>        <span class="k">do </span><span class="n">jj</span> <span class="o">=</span> <span class="n">jmin</span><span class="p">,</span> <span class="n">jmax</span>
<a name="ln-2953"></a>            <span class="n">klist</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="o">/-</span><span class="n">ktmax</span><span class="o">+</span><span class="n">delta</span><span class="o">*</span><span class="p">(</span><span class="n">ii</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span><span class="o">-</span><span class="n">ktmax</span><span class="o">+</span><span class="n">delta</span><span class="o">*</span><span class="p">(</span><span class="n">jj</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span><span class="mf">0.0</span><span class="o">/</span><span class="p">)</span> <span class="o">+</span> <span class="n">kk</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-2954"></a>            <span class="n">klist</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">)</span> <span class="o">=</span>  <span class="n">klist</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">)</span><span class="o">/</span><span class="nb">sqrt</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span> <span class="n">klist</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
<a name="ln-2955"></a>        <span class="k">end do</span>
<a name="ln-2956"></a><span class="k">    end do</span>
<a name="ln-2957"></a><span class="k">end if</span>
<a name="ln-2958"></a>
<a name="ln-2959"></a><span class="c">!===================================================================</span>
<a name="ln-2960"></a><span class="c">! ------ perform interpolation from square lambert map</span>
<a name="ln-2961"></a><span class="c">!===================================================================</span>
<a name="ln-2962"></a>
<a name="ln-2963"></a><span class="n">scl</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">ipar</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
<a name="ln-2964"></a>
<a name="ln-2965"></a><span class="k">do </span><span class="n">ip</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">ipar</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<a name="ln-2966"></a>  <span class="k">do </span><span class="n">ii</span> <span class="o">=</span> <span class="n">imin</span><span class="p">,</span> <span class="n">imax</span>
<a name="ln-2967"></a>    <span class="k">do </span><span class="n">jj</span> <span class="o">=</span> <span class="n">jmin</span><span class="p">,</span> <span class="n">jmax</span>
<a name="ln-2968"></a>
<a name="ln-2969"></a>        <span class="n">dc</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">klist</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">)</span>
<a name="ln-2970"></a>        <span class="n">dc</span> <span class="o">=</span> <span class="n">quat_LP</span><span class="p">(</span><span class="n">quats</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span><span class="n">ip</span><span class="p">),</span> <span class="n">dc</span><span class="p">)</span>
<a name="ln-2971"></a>        <span class="n">dc</span> <span class="o">=</span> <span class="n">dc</span><span class="o">/</span><span class="nb">sqrt</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">dc</span><span class="o">*</span><span class="n">dc</span><span class="p">))</span>
<a name="ln-2972"></a>
<a name="ln-2973"></a>        <span class="n">ixy</span> <span class="o">=</span> <span class="n">scl</span> <span class="o">*</span> <span class="n">LambertSphereToSquare</span><span class="p">(</span> <span class="n">dc</span><span class="p">,</span> <span class="n">istat</span> <span class="p">)</span>
<a name="ln-2974"></a>        <span class="n">nix</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ipar</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">+</span><span class="n">ixy</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="o">-</span><span class="n">ipar</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-2975"></a>        <span class="n">niy</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ipar</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">+</span><span class="n">ixy</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span><span class="o">-</span><span class="n">ipar</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-2976"></a>        <span class="n">nixp</span> <span class="o">=</span> <span class="n">nix</span><span class="o">+</span><span class="mi">1</span>
<a name="ln-2977"></a>        <span class="n">niyp</span> <span class="o">=</span> <span class="n">niy</span><span class="o">+</span><span class="mi">1</span>
<a name="ln-2978"></a>        <span class="k">if</span> <span class="p">(</span><span class="n">nixp</span><span class="p">.</span><span class="n">gt</span><span class="p">.</span><span class="n">ipar</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span> <span class="n">nixp</span> <span class="o">=</span> <span class="n">nix</span>
<a name="ln-2979"></a>        <span class="k">if</span> <span class="p">(</span><span class="n">niyp</span><span class="p">.</span><span class="n">gt</span><span class="p">.</span><span class="n">ipar</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span> <span class="n">niyp</span> <span class="o">=</span> <span class="n">niy</span>
<a name="ln-2980"></a>        <span class="k">if</span> <span class="p">(</span><span class="n">nix</span><span class="p">.</span><span class="n">lt</span><span class="p">.</span><span class="o">-</span><span class="n">ipar</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span> <span class="n">nix</span> <span class="o">=</span> <span class="n">nixp</span>
<a name="ln-2981"></a>        <span class="k">if</span> <span class="p">(</span><span class="n">niy</span><span class="p">.</span><span class="n">lt</span><span class="p">.</span><span class="o">-</span><span class="n">ipar</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span> <span class="n">niy</span> <span class="o">=</span> <span class="n">niyp</span>
<a name="ln-2982"></a>        <span class="n">dx</span> <span class="o">=</span> <span class="n">ixy</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">nix</span>
<a name="ln-2983"></a>        <span class="n">dy</span> <span class="o">=</span> <span class="n">ixy</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">-</span><span class="n">niy</span>
<a name="ln-2984"></a>        <span class="n">dxm</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">-</span><span class="n">dx</span>
<a name="ln-2985"></a>        <span class="n">dym</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">-</span><span class="n">dy</span>
<a name="ln-2986"></a>
<a name="ln-2987"></a>        <span class="k">if</span> <span class="p">(</span><span class="n">dc</span><span class="p">(</span><span class="mi">3</span><span class="p">).</span><span class="n">gt</span><span class="p">.</span><span class="mf">0.0</span><span class="p">)</span> <span class="k">then </span>
<a name="ln-2988"></a><span class="k">            </span><span class="n">Kosselpattern</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">,</span><span class="n">ip</span><span class="p">)</span> <span class="o">=</span>  <span class="n">mLPNH</span><span class="p">(</span><span class="n">nix</span><span class="p">,</span><span class="n">niy</span><span class="p">,</span><span class="n">ipar</span><span class="p">(</span><span class="mi">6</span><span class="p">))</span> <span class="o">*</span> <span class="n">dxm</span> <span class="o">*</span> <span class="n">dym</span> <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-2989"></a>                         <span class="n">mLPNH</span><span class="p">(</span><span class="n">nixp</span><span class="p">,</span><span class="n">niy</span><span class="p">,</span><span class="n">ipar</span><span class="p">(</span><span class="mi">6</span><span class="p">))</span> <span class="o">*</span> <span class="n">dx</span> <span class="o">*</span> <span class="n">dym</span> <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-2990"></a>                         <span class="n">mLPNH</span><span class="p">(</span><span class="n">nix</span><span class="p">,</span><span class="n">niyp</span><span class="p">,</span><span class="n">ipar</span><span class="p">(</span><span class="mi">6</span><span class="p">))</span> <span class="o">*</span> <span class="n">dxm</span> <span class="o">*</span> <span class="n">dy</span> <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-2991"></a>                         <span class="n">mLPNH</span><span class="p">(</span><span class="n">nixp</span><span class="p">,</span><span class="n">niyp</span><span class="p">,</span><span class="n">ipar</span><span class="p">(</span><span class="mi">6</span><span class="p">))</span> <span class="o">*</span> <span class="n">dx</span> <span class="o">*</span> <span class="n">dy</span> 
<a name="ln-2992"></a>
<a name="ln-2993"></a>        <span class="k">else</span>
<a name="ln-2994"></a><span class="k">            </span><span class="n">Kosselpattern</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">,</span><span class="n">ip</span><span class="p">)</span> <span class="o">=</span>  <span class="n">mLPSH</span><span class="p">(</span><span class="n">nix</span><span class="p">,</span><span class="n">niy</span><span class="p">,</span><span class="n">ipar</span><span class="p">(</span><span class="mi">6</span><span class="p">))</span> <span class="o">*</span> <span class="n">dxm</span> <span class="o">*</span> <span class="n">dym</span> <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-2995"></a>                         <span class="n">mLPSH</span><span class="p">(</span><span class="n">nixp</span><span class="p">,</span><span class="n">niy</span><span class="p">,</span><span class="n">ipar</span><span class="p">(</span><span class="mi">6</span><span class="p">))</span> <span class="o">*</span> <span class="n">dx</span> <span class="o">*</span> <span class="n">dym</span> <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-2996"></a>                         <span class="n">mLPSH</span><span class="p">(</span><span class="n">nix</span><span class="p">,</span><span class="n">niyp</span><span class="p">,</span><span class="n">ipar</span><span class="p">(</span><span class="mi">6</span><span class="p">))</span> <span class="o">*</span> <span class="n">dxm</span> <span class="o">*</span> <span class="n">dy</span> <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-2997"></a>                         <span class="n">mLPSH</span><span class="p">(</span><span class="n">nixp</span><span class="p">,</span><span class="n">niyp</span><span class="p">,</span><span class="n">ipar</span><span class="p">(</span><span class="mi">6</span><span class="p">))</span> <span class="o">*</span> <span class="n">dx</span> <span class="o">*</span> <span class="n">dy</span> 
<a name="ln-2998"></a>        <span class="k">end if</span>
<a name="ln-2999"></a><span class="k">    end do</span>
<a name="ln-3000"></a><span class="k">  end do</span>
<a name="ln-3001"></a><span class="k">end do</span>
<a name="ln-3002"></a>
<a name="ln-3003"></a><span class="k">end subroutine </span><span class="n">getKosselPatterns</span>
<a name="ln-3004"></a>
<a name="ln-3005"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-3006"></a><span class="c">!</span>
<a name="ln-3007"></a><span class="c">! SUBROUTINE:EBSD4calfun</span>
<a name="ln-3008"></a><span class="c">!</span>
<a name="ln-3009"></a><span class="c">!&gt; @author Saransh Singh, Carnegie Mellon University</span>
<a name="ln-3010"></a><span class="c">!</span>
<a name="ln-3011"></a><span class="c">!&gt; @brief This function is used by bobyqa to fit an EBSD pattern</span>
<a name="ln-3012"></a><span class="c">!</span>
<a name="ln-3013"></a><span class="c">!&gt; @details The main purpose of this routine is to calculte the difference of 1 with the dot</span>
<a name="ln-3014"></a><span class="c">!&gt; product of an experimental pattern with the given set of detector parameters. This is used</span>
<a name="ln-3015"></a><span class="c">!&gt; by bobyqa module to fit an EBSD pattern when 4 patterns are fitted simultaneously</span>
<a name="ln-3016"></a><span class="c">!&gt;</span>
<a name="ln-3017"></a><span class="c">!&gt; This routine will first compute the detector arrays rgx etc. if necessary, and then perform</span>
<a name="ln-3018"></a><span class="c">!&gt; the usual interpolation from the square Lambert projection. The pattern will be a basic pattern,</span>
<a name="ln-3019"></a><span class="c">!&gt; without any intensity scaling or binning etc; the calling program should take care of those </span>
<a name="ln-3020"></a><span class="c">!&gt; operations.</span>
<a name="ln-3021"></a><span class="c">!</span>
<a name="ln-3022"></a><span class="c">!&gt; @param ipar array with integer input parameters</span>
<a name="ln-3023"></a><span class="c">!&gt; @param fpar array with float input parameters</span>
<a name="ln-3024"></a><span class="c">!&gt; @param initmeanval mean value of search space</span>
<a name="ln-3025"></a><span class="c">!&gt; @param EBSDpattern output array</span>
<a name="ln-3026"></a><span class="c">!&gt; @param quats quaternion input array</span>
<a name="ln-3027"></a><span class="c">!&gt; @param accum_e array with Monte Carlo histogram</span>
<a name="ln-3028"></a><span class="c">!&gt; @param mLPNH Northern hemisphere master pattern</span>
<a name="ln-3029"></a><span class="c">!&gt; @param mLPSH Southern hemisphere master pattern</span>
<a name="ln-3030"></a><span class="c">!</span>
<a name="ln-3031"></a><span class="c">!&gt; @date 12/12/15 SS 1.0 original</span>
<a name="ln-3032"></a><span class="c">!&gt; @date 03/28/16 SS 1.1 omega is no longer a variable parameter</span>
<a name="ln-3033"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-3034"></a>
<a name="ln-3035"></a><span class="k">recursive subroutine </span><span class="n">EBSD4calfun</span><span class="p">(</span><span class="n">nipar</span><span class="p">,</span> <span class="n">nfpar</span><span class="p">,</span> <span class="n">ninit</span><span class="p">,</span> <span class="n">ipar</span><span class="p">,</span> <span class="n">fpar</span><span class="p">,</span> <span class="n">initmeanval</span><span class="p">,</span> <span class="n">expt</span><span class="p">,</span> <span class="n">accum_e</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-3036"></a>                                <span class="n">mLPNH</span><span class="p">,</span> <span class="n">mLPSH</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">expt2</span><span class="p">,</span> <span class="n">expt3</span><span class="p">,</span> <span class="n">expt4</span><span class="p">,</span> <span class="n">nstep</span><span class="p">,</span> <span class="n">stepsize</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
<a name="ln-3037"></a><span class="c">!DEC$ ATTRIBUTES DLLEXPORT :: EBSD4calfun</span>
<a name="ln-3038"></a>
<a name="ln-3039"></a><span class="c">! the input parameters are all part of a ipar and fpar input arrays instead of the usual namelist structures.</span>
<a name="ln-3040"></a><span class="c">! The following is the mapping:</span>
<a name="ln-3041"></a><span class="c">!</span>
<a name="ln-3042"></a>
<a name="ln-3043"></a><span class="c">! ipar(1) = 2</span>
<a name="ln-3044"></a><span class="c">! ipar(2) = detnumsx</span>
<a name="ln-3045"></a><span class="c">! ipar(3) = detnumsy</span>
<a name="ln-3046"></a><span class="c">! ipar(4) = detnumEbins</span>
<a name="ln-3047"></a><span class="c">! ipar(5) = mcnsx</span>
<a name="ln-3048"></a><span class="c">! ipar(6) = mpnpx</span>
<a name="ln-3049"></a><span class="c">! ipar(7) = numset</span>
<a name="ln-3050"></a><span class="c">! ipar(8) = numquats</span>
<a name="ln-3051"></a><span class="c">! ipar(9) = Emin</span>
<a name="ln-3052"></a><span class="c">! ipar(10) = Emax</span>
<a name="ln-3053"></a><span class="c">! ipar(11) = 0/1 ;0 for no mask, 1 for mask</span>
<a name="ln-3054"></a><span class="c">! ipar(12) = binning</span>
<a name="ln-3055"></a><span class="c">! ipar(13) = pixx_pat1</span>
<a name="ln-3056"></a><span class="c">! ipar(14) = pixy_pat1</span>
<a name="ln-3057"></a><span class="c">! ipar(15) = pixx_pat2</span>
<a name="ln-3058"></a><span class="c">! ipar(16) = pixy_pat2</span>
<a name="ln-3059"></a><span class="c">! ipar(17) = pixx_pat3</span>
<a name="ln-3060"></a><span class="c">! ipar(18) = pixy_pat3</span>
<a name="ln-3061"></a><span class="c">! ipar(19) = pixx_pat4</span>
<a name="ln-3062"></a><span class="c">! ipar(20) = pixy_pat4</span>
<a name="ln-3063"></a>
<a name="ln-3064"></a><span class="c">! fpar(1) = enl%xpc</span>
<a name="ln-3065"></a><span class="c">! fpar(2) = enl%ypc</span>
<a name="ln-3066"></a><span class="c">! fpar(3) = enl%delta</span>
<a name="ln-3067"></a><span class="c">! fpar(4) = enl%MCsig</span>
<a name="ln-3068"></a><span class="c">! fpar(5) = enl%omega</span>
<a name="ln-3069"></a><span class="c">! fpar(6) = enl%thetac</span>
<a name="ln-3070"></a><span class="c">! fpar(7) = enl%L</span>
<a name="ln-3071"></a><span class="c">! fpar(8) = enl%beamcurrent</span>
<a name="ln-3072"></a><span class="c">! fpar(9) = enl%dwelltime</span>
<a name="ln-3073"></a><span class="c">! fpar(10) = enl%gammavalue</span>
<a name="ln-3074"></a><span class="c">! fpar(11) = maskradius</span>
<a name="ln-3075"></a><span class="c">! fpar(12) = stepx</span>
<a name="ln-3076"></a><span class="c">! fpar(13) = stepy</span>
<a name="ln-3077"></a>
<a name="ln-3078"></a><span class="c">! initmeanval(1) = fpar(7)</span>
<a name="ln-3079"></a><span class="c">! initmeanval(2) = phi1</span>
<a name="ln-3080"></a><span class="c">! initmeanval(3) = phi</span>
<a name="ln-3081"></a><span class="c">! initmeanval(4) = phi2</span>
<a name="ln-3082"></a><span class="c">! initmeanval(5) = xpc</span>
<a name="ln-3083"></a><span class="c">! initmeanval(6) = ypc</span>
<a name="ln-3084"></a>
<a name="ln-3085"></a><span class="c">! stepsize(1) = step_xpc</span>
<a name="ln-3086"></a><span class="c">! stepsize(2) = step_ypc</span>
<a name="ln-3087"></a><span class="c">! stepsize(3) = step_phi1 ; all 4 patterns</span>
<a name="ln-3088"></a><span class="c">! stepsize(4) = step_phi ; all 4 patterns</span>
<a name="ln-3089"></a><span class="c">! stepsize(5) = step_phi2 ; all 4 patterns</span>
<a name="ln-3090"></a><span class="c">! stepsize(6) = step_L</span>
<a name="ln-3091"></a>
<a name="ln-3092"></a><span class="c">! X = (/xpc, ypc, omega, L, phi1, phi, phi2/)</span>
<a name="ln-3093"></a>
<a name="ln-3094"></a>            
<a name="ln-3095"></a><span class="k">use </span><span class="n">local</span>
<a name="ln-3096"></a><span class="k">use </span><span class="n">rotations</span>
<a name="ln-3097"></a><span class="k">use </span><span class="n">constants</span>
<a name="ln-3098"></a><span class="k">use </span><span class="n">distortion</span>
<a name="ln-3099"></a><span class="k">use </span><span class="n">filters</span>
<a name="ln-3100"></a><span class="k">use </span><span class="n">Indexingmod</span><span class="p">,</span> <span class="n">ONLY</span><span class="p">:</span><span class="n">Jaccard_Distance</span>
<a name="ln-3101"></a><span class="k">use</span><span class="p">,</span><span class="k">INTRINSIC</span> <span class="kd">::</span> <span class="nb">ISO_C_BINDING</span>
<a name="ln-3102"></a><span class="nb">           </span>
<a name="ln-3103"></a><span class="k">implicit none</span>
<a name="ln-3104"></a>
<a name="ln-3105"></a><span class="kt">integer</span><span class="p">(</span><span class="n">irg</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>                 <span class="kd">::</span> <span class="n">nipar</span>
<a name="ln-3106"></a><span class="kt">integer</span><span class="p">(</span><span class="n">irg</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>                 <span class="kd">::</span> <span class="n">nfpar</span>
<a name="ln-3107"></a><span class="kt">integer</span><span class="p">(</span><span class="n">irg</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>                 <span class="kd">::</span> <span class="n">ninit</span>         
<a name="ln-3108"></a><span class="kt">integer</span><span class="p">(</span><span class="kt">c_size_t</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>            <span class="kd">::</span> <span class="n">ipar</span><span class="p">(</span><span class="n">nipar</span><span class="p">)</span>
<a name="ln-3109"></a><span class="kt">real</span><span class="p">(</span><span class="n">sgl</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span>                 <span class="kd">::</span> <span class="n">fpar</span><span class="p">(</span><span class="n">nfpar</span><span class="p">)</span>
<a name="ln-3110"></a><span class="kt">real</span><span class="p">(</span><span class="n">sgl</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>                    <span class="kd">::</span> <span class="n">initmeanval</span><span class="p">(</span><span class="n">ninit</span><span class="p">)</span>
<a name="ln-3111"></a><span class="kt">integer</span><span class="p">(</span><span class="n">irg</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>                 <span class="kd">::</span> <span class="n">nstep</span>
<a name="ln-3112"></a><span class="kt">real</span><span class="p">(</span><span class="n">sgl</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>                    <span class="kd">::</span> <span class="n">stepsize</span><span class="p">(</span><span class="n">nstep</span><span class="p">)</span>
<a name="ln-3113"></a><span class="kt">real</span><span class="p">(</span><span class="kt">c_float</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>                <span class="kd">::</span> <span class="n">expt</span><span class="p">(</span><span class="n">ipar</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">ipar</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">/</span><span class="n">ipar</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span><span class="o">/</span><span class="n">ipar</span><span class="p">(</span><span class="mi">12</span><span class="p">))</span>
<a name="ln-3114"></a><span class="kt">real</span><span class="p">(</span><span class="kt">c_float</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>                <span class="kd">::</span> <span class="n">expt2</span><span class="p">(</span><span class="n">ipar</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">ipar</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">/</span><span class="n">ipar</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span><span class="o">/</span><span class="n">ipar</span><span class="p">(</span><span class="mi">12</span><span class="p">))</span>
<a name="ln-3115"></a><span class="kt">real</span><span class="p">(</span><span class="kt">c_float</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>                <span class="kd">::</span> <span class="n">expt3</span><span class="p">(</span><span class="n">ipar</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">ipar</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">/</span><span class="n">ipar</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span><span class="o">/</span><span class="n">ipar</span><span class="p">(</span><span class="mi">12</span><span class="p">))</span>
<a name="ln-3116"></a><span class="kt">real</span><span class="p">(</span><span class="kt">c_float</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>                <span class="kd">::</span> <span class="n">expt4</span><span class="p">(</span><span class="n">ipar</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">ipar</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">/</span><span class="n">ipar</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span><span class="o">/</span><span class="n">ipar</span><span class="p">(</span><span class="mi">12</span><span class="p">))</span>
<a name="ln-3117"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>               <span class="kd">::</span> <span class="n">accum_e</span><span class="p">(</span><span class="n">ipar</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span><span class="o">-</span><span class="n">ipar</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span><span class="n">ipar</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span><span class="o">-</span><span class="n">ipar</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span><span class="n">ipar</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>
<a name="ln-3118"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>               <span class="kd">::</span> <span class="n">mLPNH</span><span class="p">(</span><span class="o">-</span><span class="n">ipar</span><span class="p">(</span><span class="mi">6</span><span class="p">):</span><span class="n">ipar</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span> <span class="o">-</span><span class="n">ipar</span><span class="p">(</span><span class="mi">6</span><span class="p">):</span><span class="n">ipar</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span> <span class="n">ipar</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span> <span class="n">ipar</span><span class="p">(</span><span class="mi">7</span><span class="p">))</span>
<a name="ln-3119"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>               <span class="kd">::</span> <span class="n">mLPSH</span><span class="p">(</span><span class="o">-</span><span class="n">ipar</span><span class="p">(</span><span class="mi">6</span><span class="p">):</span><span class="n">ipar</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span> <span class="o">-</span><span class="n">ipar</span><span class="p">(</span><span class="mi">6</span><span class="p">):</span><span class="n">ipar</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span> <span class="n">ipar</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span> <span class="n">ipar</span><span class="p">(</span><span class="mi">7</span><span class="p">))</span>
<a name="ln-3120"></a><span class="kt">integer</span><span class="p">(</span><span class="n">irg</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>                 <span class="kd">::</span> <span class="n">n</span>
<a name="ln-3121"></a><span class="kt">real</span><span class="p">(</span><span class="n">dbl</span><span class="p">),</span><span class="k">dimension</span><span class="p">(:),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>       <span class="kd">::</span> <span class="n">x</span>
<a name="ln-3122"></a><span class="kt">real</span><span class="p">(</span><span class="n">dbl</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>                   <span class="kd">::</span> <span class="n">f</span>
<a name="ln-3123"></a><span class="kt">logical</span><span class="p">,</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">),</span><span class="k">optional</span>             <span class="kd">::</span> <span class="n">verbose</span>
<a name="ln-3124"></a>
<a name="ln-3125"></a><span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">irg</span><span class="p">)</span>                       <span class="kd">::</span> <span class="n">nnx</span><span class="p">,</span> <span class="n">nny</span><span class="p">,</span> <span class="n">binx</span><span class="p">,</span> <span class="n">biny</span>
<a name="ln-3126"></a><span class="kt">complex</span><span class="p">(</span><span class="n">dbl</span><span class="p">)</span>                            <span class="kd">::</span> <span class="n">D</span>
<a name="ln-3127"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">)</span>                          <span class="kd">::</span> <span class="n">quats</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">bindx</span><span class="p">,</span> <span class="n">ma</span><span class="p">,</span> <span class="n">mi</span>
<a name="ln-3128"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">),</span><span class="k">allocatable</span>              <span class="kd">::</span> <span class="n">EBSDpattern</span><span class="p">(:,:,:),</span> <span class="n">binned</span><span class="p">(:,:)</span>
<a name="ln-3129"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">),</span><span class="k">allocatable</span>              <span class="kd">::</span> <span class="n">EBSDpatternintd</span><span class="p">(:,:)</span>
<a name="ln-3130"></a><span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">irg</span><span class="p">),</span><span class="k">allocatable</span>           <span class="kd">::</span> <span class="n">EBSDpatterninteger</span><span class="p">(:,:),</span> <span class="n">EBSDpatternad</span><span class="p">(:,:)</span>
<a name="ln-3131"></a>
<a name="ln-3132"></a><span class="c">! variables that must be saved for the next time this function is called</span>
<a name="ln-3133"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">)</span>                          <span class="kd">::</span> <span class="n">prefactor</span>
<a name="ln-3134"></a><span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">irg</span><span class="p">),</span><span class="k">allocatable</span>           <span class="kd">::</span> <span class="n">img1</span><span class="p">(:),</span> <span class="n">img2</span><span class="p">(:),</span> <span class="n">img_fit_cumul</span><span class="p">(:),</span> <span class="n">img_expt_cumul</span><span class="p">(:)</span>
<a name="ln-3135"></a><span class="c">! other variables</span>
<a name="ln-3136"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">),</span><span class="k">parameter</span>                <span class="kd">::</span> <span class="n">dtor</span> <span class="o">=</span> <span class="mf">0.0174533</span>  <span class="c">! convert from degrees to radians</span>
<a name="ln-3137"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">)</span>                          <span class="kd">::</span> <span class="n">ixy</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">eu</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">eu2</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">eu3</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">eu4</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-3138"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">),</span> <span class="k">allocatable</span>             <span class="kd">::</span> <span class="n">EBSDvector</span><span class="p">(:),</span> <span class="n">EBSDflip</span><span class="p">(:,:),</span> <span class="n">mask</span><span class="p">(:,:)</span>
<a name="ln-3139"></a><span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">irg</span><span class="p">)</span>                       <span class="kd">::</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">istat</span>
<a name="ln-3140"></a>
<a name="ln-3141"></a><span class="kt">logical</span>                                 <span class="kd">::</span> <span class="nb">stat</span><span class="p">,</span> <span class="n">readonly</span>
<a name="ln-3142"></a><span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">irg</span><span class="p">)</span>                       <span class="kd">::</span> <span class="n">hdferr</span><span class="p">,</span> <span class="n">nlines</span>
<a name="ln-3143"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">)</span>                          <span class="kd">::</span> <span class="n">fpar2</span><span class="p">(</span><span class="n">nfpar</span><span class="p">)</span>
<a name="ln-3144"></a>
<a name="ln-3145"></a><span class="c">!fpar(1) = sngl(X(1))*ipar(2) - ipar(2)/2 + initmeanval(5) ! xpc +/- detnumx/2 pixels</span>
<a name="ln-3146"></a><span class="c">!fpar(2) = sngl(X(2))*ipar(3) - ipar(3)/2 + initmeanval(6) ! ypc +/- detnumy/2 pixels</span>
<a name="ln-3147"></a>
<a name="ln-3148"></a><span class="n">fpar</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="nb">sngl</span><span class="p">(</span><span class="n">X</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="o">*</span><span class="mf">2.0</span><span class="o">*</span><span class="n">stepsize</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">stepsize</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">initmeanval</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="c">! xpc +/- 5 pixels</span>
<a name="ln-3149"></a><span class="n">fpar</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="nb">sngl</span><span class="p">(</span><span class="n">X</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span><span class="o">*</span><span class="mf">2.0</span><span class="o">*</span><span class="n">stepsize</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="n">stepsize</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">initmeanval</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="c">! ypc +/- 5 pixels</span>
<a name="ln-3150"></a>
<a name="ln-3151"></a><span class="c">!fpar(1) = initmeanval(5) ! xpc +/- detnumx/2 pixels</span>
<a name="ln-3152"></a><span class="c">!fpar(2) = initmeanval(6) ! ypc +/- detnumy/2 pixels</span>
<a name="ln-3153"></a>
<a name="ln-3154"></a><span class="n">fpar</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">=</span> <span class="nb">sngl</span><span class="p">(</span><span class="n">X</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span><span class="o">*</span><span class="mf">2.0</span><span class="o">*</span><span class="n">stepsize</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span><span class="o">*</span><span class="n">fpar</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">-</span> <span class="n">stepsize</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span><span class="o">*</span><span class="n">fpar</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="n">initmeanval</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c">! mean +/- 5 pixels</span>
<a name="ln-3155"></a><span class="c">!fpar(7) = initmeanval(1) ! mean +/- 2000 microns</span>
<a name="ln-3156"></a>
<a name="ln-3157"></a><span class="c">! 03/28/16 omega is no longer a variable parameter anymore</span>
<a name="ln-3158"></a><span class="n">fpar</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="nb">sngl</span><span class="p">(</span><span class="n">X</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span><span class="o">*</span><span class="mf">0.0</span> <span class="o">-</span> <span class="mf">0.0</span> <span class="c">! omega 0 +/- 5 degrees</span>
<a name="ln-3159"></a>
<a name="ln-3160"></a><span class="c">!eu = (/initmeanval(2), initmeanval(3), initmeanval(4)/)*dtor ! don&#39;t change the values for euler angles</span>
<a name="ln-3161"></a><span class="n">eu</span> <span class="o">=</span> <span class="p">(</span><span class="o">/</span><span class="n">X</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">*</span><span class="mf">2.0</span><span class="o">*</span><span class="n">stepsize</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">-</span> <span class="n">stepsize</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="n">initmeanval</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">X</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span><span class="o">*</span><span class="mf">2.0</span><span class="o">*</span><span class="n">stepsize</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">-</span> <span class="n">stepsize</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>  <span class="o">+</span> <span class="n">initmeanval</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="p">&amp;</span>
<a name="ln-3162"></a>       <span class="n">X</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span><span class="o">*</span><span class="mf">2.0</span><span class="o">*</span><span class="n">stepsize</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">-</span> <span class="n">stepsize</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="n">initmeanval</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">/</span><span class="p">)</span><span class="o">*</span><span class="n">dtor</span> <span class="c">! mean +/- 2 degrees</span>
<a name="ln-3163"></a><span class="n">eu2</span> <span class="o">=</span> <span class="p">(</span><span class="o">/</span><span class="n">X</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="o">*</span><span class="mf">2.0</span><span class="o">*</span><span class="n">stepsize</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">-</span> <span class="n">stepsize</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="n">initmeanval</span><span class="p">(</span><span class="mi">7</span><span class="p">),</span> <span class="n">X</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span><span class="o">*</span><span class="mf">2.0</span><span class="o">*</span><span class="n">stepsize</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">-</span> <span class="n">stepsize</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="n">initmeanval</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span> <span class="p">&amp;</span>
<a name="ln-3164"></a>       <span class="n">X</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">*</span><span class="mf">2.0</span><span class="o">*</span><span class="n">stepsize</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">-</span> <span class="n">stepsize</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="n">initmeanval</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span><span class="o">/</span><span class="p">)</span><span class="o">*</span><span class="n">dtor</span> <span class="c">! mean +/- 2 degrees</span>
<a name="ln-3165"></a><span class="n">eu3</span> <span class="o">=</span> <span class="p">(</span><span class="o">/</span><span class="n">X</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span><span class="o">*</span><span class="mf">2.0</span><span class="o">*</span><span class="n">stepsize</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">-</span> <span class="n">stepsize</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="n">initmeanval</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span> <span class="n">X</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span><span class="o">*</span><span class="mf">2.0</span><span class="o">*</span><span class="n">stepsize</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">-</span> <span class="n">stepsize</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="n">initmeanval</span><span class="p">(</span><span class="mi">11</span><span class="p">),</span> <span class="p">&amp;</span>
<a name="ln-3166"></a>       <span class="n">X</span><span class="p">(</span><span class="mi">13</span><span class="p">)</span><span class="o">*</span><span class="mf">2.0</span><span class="o">*</span><span class="n">stepsize</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">-</span> <span class="n">stepsize</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="n">initmeanval</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span><span class="o">/</span><span class="p">)</span><span class="o">*</span><span class="n">dtor</span> <span class="c">! mean +/- 2 degrees</span>
<a name="ln-3167"></a><span class="n">eu4</span> <span class="o">=</span> <span class="p">(</span><span class="o">/</span><span class="n">X</span><span class="p">(</span><span class="mi">14</span><span class="p">)</span><span class="o">*</span><span class="mf">2.0</span><span class="o">*</span><span class="n">stepsize</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">-</span> <span class="n">stepsize</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="n">initmeanval</span><span class="p">(</span><span class="mi">13</span><span class="p">),</span> <span class="n">X</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span><span class="o">*</span><span class="mf">2.0</span><span class="o">*</span><span class="n">stepsize</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">-</span> <span class="n">stepsize</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="n">initmeanval</span><span class="p">(</span><span class="mi">14</span><span class="p">),</span> <span class="p">&amp;</span>
<a name="ln-3168"></a>       <span class="n">X</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span><span class="o">*</span><span class="mf">2.0</span><span class="o">*</span><span class="n">stepsize</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">-</span> <span class="n">stepsize</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="n">initmeanval</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span><span class="o">/</span><span class="p">)</span><span class="o">*</span><span class="n">dtor</span> <span class="c">! mean +/- 2 degrees</span>
<a name="ln-3169"></a>
<a name="ln-3170"></a><span class="c">!D = dcmplx(X(8)*0.000002D0 - 0.000001D0 + dble(initmeanval(5)), X(9)*0.000002D0 - 0.000001D0 + dble(initmeanval(6)))</span>
<a name="ln-3171"></a>
<a name="ln-3172"></a><span class="n">binx</span> <span class="o">=</span> <span class="n">ipar</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">ipar</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span>
<a name="ln-3173"></a><span class="n">biny</span> <span class="o">=</span> <span class="n">ipar</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">/</span><span class="n">ipar</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span>
<a name="ln-3174"></a><span class="n">bindx</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">ipar</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
<a name="ln-3175"></a>
<a name="ln-3176"></a><span class="k">allocate</span><span class="p">(</span><span class="n">EBSDvector</span><span class="p">(</span><span class="n">binx</span><span class="o">*</span><span class="n">biny</span><span class="p">),</span><span class="n">mask</span><span class="p">(</span><span class="n">binx</span><span class="p">,</span><span class="n">biny</span><span class="p">))</span>
<a name="ln-3177"></a><span class="k">allocate</span><span class="p">(</span><span class="n">EBSDpattern</span><span class="p">(</span><span class="n">ipar</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span><span class="n">ipar</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span><span class="mi">1</span><span class="p">))</span>
<a name="ln-3178"></a><span class="k">allocate</span><span class="p">(</span><span class="n">binned</span><span class="p">(</span><span class="n">binx</span><span class="p">,</span><span class="n">biny</span><span class="p">))</span>
<a name="ln-3179"></a><span class="k">allocate</span><span class="p">(</span><span class="n">EBSDpatternintd</span><span class="p">(</span><span class="n">ipar</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span><span class="n">ipar</span><span class="p">(</span><span class="mi">3</span><span class="p">)),</span><span class="n">EBSDpatterninteger</span><span class="p">(</span><span class="n">ipar</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span><span class="n">ipar</span><span class="p">(</span><span class="mi">3</span><span class="p">)),</span> <span class="n">EBSDpatternad</span><span class="p">(</span><span class="n">ipar</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span><span class="n">ipar</span><span class="p">(</span><span class="mi">3</span><span class="p">)))</span>
<a name="ln-3180"></a><span class="k">allocate</span><span class="p">(</span><span class="n">img1</span><span class="p">(</span><span class="n">binx</span><span class="o">*</span><span class="n">biny</span><span class="p">),</span><span class="n">img2</span><span class="p">(</span><span class="n">binx</span><span class="o">*</span><span class="n">biny</span><span class="p">))</span>
<a name="ln-3181"></a><span class="k">allocate</span><span class="p">(</span><span class="n">img_fit_cumul</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="n">binx</span><span class="o">*</span><span class="n">biny</span><span class="p">),</span><span class="n">img_expt_cumul</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="n">binx</span><span class="o">*</span><span class="n">biny</span><span class="p">))</span>
<a name="ln-3182"></a>
<a name="ln-3183"></a><span class="n">binned</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-3184"></a><span class="n">EBSDpatternintd</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-3185"></a><span class="n">EBSDpatterninteger</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-3186"></a><span class="n">EBSDpatternad</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-3187"></a><span class="n">img1</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-3188"></a><span class="n">img2</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-3189"></a><span class="n">img_fit_cumul</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-3190"></a><span class="n">img_expt_cumul</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-3191"></a>
<a name="ln-3192"></a><span class="n">mask</span> <span class="o">=</span> <span class="mf">1.0</span>
<a name="ln-3193"></a>
<a name="ln-3194"></a><span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">verbose</span><span class="p">))</span> <span class="k">then</span>
<a name="ln-3195"></a><span class="k">    if</span><span class="p">(</span><span class="n">verbose</span><span class="p">)</span> <span class="k">then    </span>
<a name="ln-3196"></a><span class="k">        print</span><span class="o">*</span><span class="p">,</span><span class="s1">&#39;xpc, ypc, L, eu_pat1, eu_pat2, eu_pat3, eu_pat4 = &#39;</span><span class="p">,</span> <span class="n">fpar</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">fpar</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">fpar</span><span class="p">(</span><span class="mi">7</span><span class="p">),</span><span class="n">eu</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="mi">18</span><span class="mf">0.0</span><span class="o">/</span><span class="n">cPi</span><span class="p">,&amp;</span>
<a name="ln-3197"></a>        <span class="n">eu2</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="mi">18</span><span class="mf">0.0</span><span class="o">/</span><span class="n">cPi</span><span class="p">,</span><span class="n">eu3</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="mi">18</span><span class="mf">0.0</span><span class="o">/</span><span class="n">cPi</span><span class="p">,</span><span class="n">eu4</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="mi">18</span><span class="mf">0.0</span><span class="o">/</span><span class="n">cPi</span>
<a name="ln-3198"></a>    <span class="k">end if</span>
<a name="ln-3199"></a><span class="k">end if</span>
<a name="ln-3200"></a>
<a name="ln-3201"></a><span class="n">fpar2</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">nfpar</span><span class="p">)</span> <span class="o">=</span> <span class="n">fpar</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">nfpar</span><span class="p">)</span>
<a name="ln-3202"></a>
<a name="ln-3203"></a><span class="c">!==============================================================================</span>
<a name="ln-3204"></a><span class="c">!============IMAGE 1===========================================================</span>
<a name="ln-3205"></a><span class="c">!==============================================================================</span>
<a name="ln-3206"></a>
<a name="ln-3207"></a><span class="n">quats</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">eu2qu</span><span class="p">(</span><span class="n">eu</span><span class="p">)</span>
<a name="ln-3208"></a>
<a name="ln-3209"></a><span class="n">fpar2</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">nfpar</span><span class="p">)</span> <span class="o">=</span> <span class="n">fpar</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">nfpar</span><span class="p">)</span>
<a name="ln-3210"></a><span class="n">fpar2</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">fpar</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">ipar</span><span class="p">(</span><span class="mi">13</span><span class="p">)</span><span class="o">*</span><span class="n">fpar</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span><span class="o">/</span><span class="n">fpar</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-3211"></a><span class="n">fpar2</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">fpar</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="n">ipar</span><span class="p">(</span><span class="mi">14</span><span class="p">)</span><span class="o">*</span><span class="n">fpar</span><span class="p">(</span><span class="mi">13</span><span class="p">)</span><span class="o">/</span><span class="n">fpar</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-3212"></a>
<a name="ln-3213"></a><span class="k">call </span><span class="n">getEBSDPatterns</span><span class="p">(</span><span class="n">ipar</span><span class="p">,</span> <span class="n">fpar2</span><span class="p">,</span> <span class="n">EBSDpattern</span><span class="p">,</span> <span class="n">quats</span><span class="p">,</span> <span class="n">accum_e</span><span class="p">,</span> <span class="n">mLPNH</span><span class="p">,</span> <span class="n">mLPSH</span><span class="p">)</span>
<a name="ln-3214"></a>
<a name="ln-3215"></a><span class="c">!nnx = ipar(2)</span>
<a name="ln-3216"></a><span class="c">!nny = ipar(3)</span>
<a name="ln-3217"></a>
<a name="ln-3218"></a><span class="c">!EBSDpatternintd = ((EBSDPattern(:,:,1) - mi)/ (ma-mi))</span>
<a name="ln-3219"></a><span class="c">!EBSDpatterninteger = nint(EBSDpatternintd*255.0)</span>
<a name="ln-3220"></a><span class="c">!EBSDpatternad =  adhisteq(10,nnx,nny,EBSDpatterninteger)</span>
<a name="ln-3221"></a><span class="c">!EBSDPattern(:,:,1) = float(EBSDpatternad)</span>
<a name="ln-3222"></a>
<a name="ln-3223"></a><span class="k">if</span> <span class="p">(</span><span class="n">ipar</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span> <span class="p">.</span><span class="n">ne</span><span class="p">.</span> <span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-3224"></a><span class="k">    do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">binx</span>
<a name="ln-3225"></a>        <span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">biny</span>
<a name="ln-3226"></a>            <span class="n">binned</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">EBSDpattern</span><span class="p">((</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">ipar</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">i</span><span class="o">*</span><span class="n">ipar</span><span class="p">(</span><span class="mi">12</span><span class="p">),(</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">ipar</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">j</span><span class="o">*</span><span class="n">ipar</span><span class="p">(</span><span class="mi">12</span><span class="p">),</span><span class="mi">1</span><span class="p">))</span>
<a name="ln-3227"></a>        <span class="k">end do</span>
<a name="ln-3228"></a><span class="k">    end do </span>
<a name="ln-3229"></a><span class="k">    </span><span class="n">binned</span> <span class="o">=</span> <span class="n">binned</span> <span class="o">*</span> <span class="n">bindx</span> 
<a name="ln-3230"></a><span class="k">else</span>
<a name="ln-3231"></a><span class="k">    </span><span class="n">binned</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">binx</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">biny</span><span class="p">)</span> <span class="o">=</span> <span class="n">EBSDpattern</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">binx</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">biny</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-3232"></a><span class="k">end if</span>
<a name="ln-3233"></a>
<a name="ln-3234"></a>
<a name="ln-3235"></a><span class="k">if</span> <span class="p">(</span><span class="n">ipar</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span> <span class="p">.</span><span class="n">eq</span><span class="p">.</span> <span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-3236"></a><span class="k">    do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="n">binx</span>
<a name="ln-3237"></a>        <span class="k">do </span><span class="n">j</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="n">biny</span>
<a name="ln-3238"></a>            <span class="k">if</span><span class="p">(((</span><span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">-</span><span class="nb">ceiling</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">binx</span><span class="p">)</span><span class="o">/</span><span class="mf">2.0</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">-</span><span class="nb">ceiling</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">biny</span><span class="p">)</span><span class="o">/</span><span class="mf">2.0</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="p">.</span><span class="n">gt</span><span class="p">.</span> <span class="n">fpar</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-3239"></a><span class="k">                </span><span class="n">mask</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-3240"></a>            <span class="k">end if</span>
<a name="ln-3241"></a><span class="k">        end do</span>
<a name="ln-3242"></a><span class="k">    end do</span>
<a name="ln-3243"></a><span class="k">end if</span>
<a name="ln-3244"></a>
<a name="ln-3245"></a><span class="n">binned</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">binx</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">biny</span><span class="p">)</span> <span class="o">=</span> <span class="n">binned</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">binx</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">biny</span><span class="p">)</span><span class="o">*</span><span class="n">mask</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">binx</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">biny</span><span class="p">)</span>
<a name="ln-3246"></a><span class="n">binned</span> <span class="o">=</span> <span class="n">binned</span><span class="o">**</span><span class="n">fpar</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<a name="ln-3247"></a>
<a name="ln-3248"></a>
<a name="ln-3249"></a><span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">biny</span>
<a name="ln-3250"></a>    <span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">binx</span>
<a name="ln-3251"></a>        <span class="n">EBSDvector</span><span class="p">((</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">binx</span><span class="o">+</span><span class="n">j</span><span class="p">)</span> <span class="o">=</span> <span class="n">binned</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
<a name="ln-3252"></a>    <span class="k">end do</span>
<a name="ln-3253"></a><span class="k">end do</span>
<a name="ln-3254"></a>
<a name="ln-3255"></a><span class="n">ma</span> <span class="o">=</span> <span class="nb">maxval</span><span class="p">(</span><span class="n">EBSDvector</span><span class="p">)</span>
<a name="ln-3256"></a><span class="n">mi</span> <span class="o">=</span> <span class="nb">minval</span><span class="p">(</span><span class="n">EBSDvector</span><span class="p">)</span>
<a name="ln-3257"></a>
<a name="ln-3258"></a><span class="n">img1</span> <span class="o">=</span> <span class="nb">nint</span><span class="p">(</span><span class="mi">25</span><span class="mf">5.0</span><span class="o">*</span><span class="p">(</span><span class="n">EBSDvector</span> <span class="o">-</span> <span class="n">mi</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">ma</span> <span class="o">-</span> <span class="n">mi</span><span class="p">))</span>
<a name="ln-3259"></a>
<a name="ln-3260"></a><span class="n">ma</span> <span class="o">=</span> <span class="nb">maxval</span><span class="p">(</span><span class="n">expt</span><span class="p">)</span>
<a name="ln-3261"></a><span class="n">mi</span> <span class="o">=</span> <span class="nb">minval</span><span class="p">(</span><span class="n">expt</span><span class="p">)</span>
<a name="ln-3262"></a>
<a name="ln-3263"></a><span class="n">img2</span> <span class="o">=</span> <span class="nb">nint</span><span class="p">(</span><span class="mi">25</span><span class="mf">5.0</span><span class="o">*</span><span class="p">(</span><span class="n">expt</span> <span class="o">-</span> <span class="n">mi</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">ma</span> <span class="o">-</span> <span class="n">mi</span><span class="p">))</span>
<a name="ln-3264"></a>
<a name="ln-3265"></a><span class="n">img_fit_cumul</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">binx</span><span class="o">*</span><span class="n">biny</span><span class="p">)</span> <span class="o">=</span> <span class="n">img1</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">binx</span><span class="o">*</span><span class="n">biny</span><span class="p">)</span>
<a name="ln-3266"></a><span class="n">img_expt_cumul</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">binx</span><span class="o">*</span><span class="n">biny</span><span class="p">)</span> <span class="o">=</span> <span class="n">img2</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">binx</span><span class="o">*</span><span class="n">biny</span><span class="p">)</span>
<a name="ln-3267"></a>
<a name="ln-3268"></a><span class="c">!open(unit=13,file=&#39;/Users/saranshsingh/Desktop/testd.txt&#39;,action=&#39;write&#39;)</span>
<a name="ln-3269"></a><span class="c">!open(unit=14,file=&#39;/Users/saranshsingh/Desktop/teste.txt&#39;,action=&#39;write&#39;)</span>
<a name="ln-3270"></a>
<a name="ln-3271"></a><span class="c">!do i = 1,binx</span>
<a name="ln-3272"></a><span class="c">!    do j = 1,biny</span>
<a name="ln-3273"></a><span class="c">!        write(13,&#39;(F15.6)&#39;,advance=&#39;no&#39;)EBSDvector((i-1)*biny+j)</span>
<a name="ln-3274"></a><span class="c">!        write(14,&#39;(F15.6)&#39;,advance=&#39;no&#39;)expt((i-1)*biny+j)</span>
<a name="ln-3275"></a><span class="c">!    end do</span>
<a name="ln-3276"></a><span class="c">!    write(13,*)&#39;&#39;</span>
<a name="ln-3277"></a><span class="c">!    write(14,*)&#39;&#39;</span>
<a name="ln-3278"></a><span class="c">!end do</span>
<a name="ln-3279"></a>
<a name="ln-3280"></a><span class="c">!close(13)</span>
<a name="ln-3281"></a><span class="c">!close(14)</span>
<a name="ln-3282"></a><span class="c">!stop</span>
<a name="ln-3283"></a>
<a name="ln-3284"></a>
<a name="ln-3285"></a><span class="c">!==============================================================================</span>
<a name="ln-3286"></a><span class="c">!============IMAGE 2===========================================================</span>
<a name="ln-3287"></a><span class="c">!==============================================================================</span>
<a name="ln-3288"></a>
<a name="ln-3289"></a><span class="n">quats</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">eu2qu</span><span class="p">(</span><span class="n">eu2</span><span class="p">)</span>
<a name="ln-3290"></a><span class="n">fpar2</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">nfpar</span><span class="p">)</span> <span class="o">=</span> <span class="n">fpar</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">nfpar</span><span class="p">)</span>
<a name="ln-3291"></a><span class="n">fpar2</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">fpar</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">ipar</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span><span class="o">*</span><span class="n">fpar</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span><span class="o">/</span><span class="n">fpar</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-3292"></a><span class="n">fpar2</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">fpar</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="n">ipar</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span><span class="o">*</span><span class="n">fpar</span><span class="p">(</span><span class="mi">13</span><span class="p">)</span><span class="o">/</span><span class="n">fpar</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-3293"></a>
<a name="ln-3294"></a>
<a name="ln-3295"></a><span class="k">call </span><span class="n">getEBSDPatterns</span><span class="p">(</span><span class="n">ipar</span><span class="p">,</span> <span class="n">fpar2</span><span class="p">,</span> <span class="n">EBSDpattern</span><span class="p">,</span> <span class="n">quats</span><span class="p">,</span> <span class="n">accum_e</span><span class="p">,</span> <span class="n">mLPNH</span><span class="p">,</span> <span class="n">mLPSH</span><span class="p">)</span>
<a name="ln-3296"></a>
<a name="ln-3297"></a><span class="k">if</span> <span class="p">(</span><span class="n">ipar</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span> <span class="p">.</span><span class="n">ne</span><span class="p">.</span> <span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-3298"></a><span class="k">    do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">binx</span>
<a name="ln-3299"></a>        <span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">biny</span>
<a name="ln-3300"></a>            <span class="n">binned</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">EBSDpattern</span><span class="p">((</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">ipar</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">i</span><span class="o">*</span><span class="n">ipar</span><span class="p">(</span><span class="mi">12</span><span class="p">),(</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">ipar</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">j</span><span class="o">*</span><span class="n">ipar</span><span class="p">(</span><span class="mi">12</span><span class="p">),</span><span class="mi">1</span><span class="p">))</span>
<a name="ln-3301"></a>        <span class="k">end do</span>
<a name="ln-3302"></a><span class="k">    end do </span>
<a name="ln-3303"></a><span class="k">    </span><span class="n">binned</span> <span class="o">=</span> <span class="n">binned</span> <span class="o">*</span> <span class="n">bindx</span> 
<a name="ln-3304"></a><span class="k">else</span>
<a name="ln-3305"></a><span class="k">    </span><span class="n">binned</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">binx</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">biny</span><span class="p">)</span> <span class="o">=</span> <span class="n">EBSDpattern</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">binx</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">biny</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-3306"></a><span class="k">end if</span>
<a name="ln-3307"></a>
<a name="ln-3308"></a><span class="n">binned</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">binx</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">biny</span><span class="p">)</span> <span class="o">=</span> <span class="n">binned</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">binx</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">biny</span><span class="p">)</span><span class="o">*</span><span class="n">mask</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">binx</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">biny</span><span class="p">)</span>
<a name="ln-3309"></a><span class="n">binned</span> <span class="o">=</span> <span class="n">binned</span><span class="o">**</span><span class="n">fpar</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<a name="ln-3310"></a>
<a name="ln-3311"></a>
<a name="ln-3312"></a><span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">biny</span>
<a name="ln-3313"></a>    <span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">binx</span>
<a name="ln-3314"></a>        <span class="n">EBSDvector</span><span class="p">((</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">binx</span><span class="o">+</span><span class="n">j</span><span class="p">)</span> <span class="o">=</span> <span class="n">binned</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
<a name="ln-3315"></a>    <span class="k">end do</span>
<a name="ln-3316"></a><span class="k">end do</span>
<a name="ln-3317"></a>
<a name="ln-3318"></a><span class="n">ma</span> <span class="o">=</span> <span class="nb">maxval</span><span class="p">(</span><span class="n">EBSDvector</span><span class="p">)</span>
<a name="ln-3319"></a><span class="n">mi</span> <span class="o">=</span> <span class="nb">minval</span><span class="p">(</span><span class="n">EBSDvector</span><span class="p">)</span>
<a name="ln-3320"></a>
<a name="ln-3321"></a><span class="n">img1</span> <span class="o">=</span> <span class="nb">nint</span><span class="p">(</span><span class="mi">25</span><span class="mf">5.0</span><span class="o">*</span><span class="p">(</span><span class="n">EBSDvector</span> <span class="o">-</span> <span class="n">mi</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">ma</span> <span class="o">-</span> <span class="n">mi</span><span class="p">))</span>
<a name="ln-3322"></a>
<a name="ln-3323"></a><span class="n">ma</span> <span class="o">=</span> <span class="nb">maxval</span><span class="p">(</span><span class="n">expt2</span><span class="p">)</span>
<a name="ln-3324"></a><span class="n">mi</span> <span class="o">=</span> <span class="nb">minval</span><span class="p">(</span><span class="n">expt2</span><span class="p">)</span>
<a name="ln-3325"></a>
<a name="ln-3326"></a><span class="n">img2</span> <span class="o">=</span> <span class="nb">nint</span><span class="p">(</span><span class="mi">25</span><span class="mf">5.0</span><span class="o">*</span><span class="p">(</span><span class="n">expt2</span> <span class="o">-</span> <span class="n">mi</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">ma</span> <span class="o">-</span> <span class="n">mi</span><span class="p">))</span>
<a name="ln-3327"></a>
<a name="ln-3328"></a><span class="n">img_fit_cumul</span><span class="p">(</span><span class="n">binx</span><span class="o">*</span><span class="n">biny</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="o">*</span><span class="n">binx</span><span class="o">*</span><span class="n">biny</span><span class="p">)</span> <span class="o">=</span> <span class="n">img1</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">binx</span><span class="o">*</span><span class="n">biny</span><span class="p">)</span>
<a name="ln-3329"></a><span class="n">img_expt_cumul</span><span class="p">(</span><span class="n">binx</span><span class="o">*</span><span class="n">biny</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="o">*</span><span class="n">binx</span><span class="o">*</span><span class="n">biny</span><span class="p">)</span> <span class="o">=</span> <span class="n">img2</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">binx</span><span class="o">*</span><span class="n">biny</span><span class="p">)</span>
<a name="ln-3330"></a>
<a name="ln-3331"></a><span class="c">!==============================================================================</span>
<a name="ln-3332"></a><span class="c">!============IMAGE 3===========================================================</span>
<a name="ln-3333"></a><span class="c">!==============================================================================</span>
<a name="ln-3334"></a>
<a name="ln-3335"></a><span class="n">quats</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">eu2qu</span><span class="p">(</span><span class="n">eu3</span><span class="p">)</span>
<a name="ln-3336"></a><span class="n">fpar2</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">nfpar</span><span class="p">)</span> <span class="o">=</span> <span class="n">fpar</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">nfpar</span><span class="p">)</span>
<a name="ln-3337"></a><span class="n">fpar2</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">fpar</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">ipar</span><span class="p">(</span><span class="mi">17</span><span class="p">)</span><span class="o">*</span><span class="n">fpar</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span><span class="o">/</span><span class="n">fpar</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-3338"></a><span class="n">fpar2</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">fpar</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="n">ipar</span><span class="p">(</span><span class="mi">18</span><span class="p">)</span><span class="o">*</span><span class="n">fpar</span><span class="p">(</span><span class="mi">13</span><span class="p">)</span><span class="o">/</span><span class="n">fpar</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-3339"></a>
<a name="ln-3340"></a>
<a name="ln-3341"></a><span class="k">call </span><span class="n">getEBSDPatterns</span><span class="p">(</span><span class="n">ipar</span><span class="p">,</span> <span class="n">fpar2</span><span class="p">,</span> <span class="n">EBSDpattern</span><span class="p">,</span> <span class="n">quats</span><span class="p">,</span> <span class="n">accum_e</span><span class="p">,</span> <span class="n">mLPNH</span><span class="p">,</span> <span class="n">mLPSH</span><span class="p">)</span>
<a name="ln-3342"></a>
<a name="ln-3343"></a><span class="k">if</span> <span class="p">(</span><span class="n">ipar</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span> <span class="p">.</span><span class="n">ne</span><span class="p">.</span> <span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-3344"></a><span class="k">    do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">binx</span>
<a name="ln-3345"></a>        <span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">biny</span>
<a name="ln-3346"></a>            <span class="n">binned</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">EBSDpattern</span><span class="p">((</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">ipar</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">i</span><span class="o">*</span><span class="n">ipar</span><span class="p">(</span><span class="mi">12</span><span class="p">),(</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">ipar</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">j</span><span class="o">*</span><span class="n">ipar</span><span class="p">(</span><span class="mi">12</span><span class="p">),</span><span class="mi">1</span><span class="p">))</span>
<a name="ln-3347"></a>        <span class="k">end do</span>
<a name="ln-3348"></a><span class="k">    end do </span>
<a name="ln-3349"></a><span class="k">    </span><span class="n">binned</span> <span class="o">=</span> <span class="n">binned</span> <span class="o">*</span> <span class="n">bindx</span> 
<a name="ln-3350"></a><span class="k">else</span>
<a name="ln-3351"></a><span class="k">    </span><span class="n">binned</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">binx</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">biny</span><span class="p">)</span> <span class="o">=</span> <span class="n">EBSDpattern</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">binx</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">biny</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-3352"></a><span class="k">end if</span>
<a name="ln-3353"></a>
<a name="ln-3354"></a><span class="n">binned</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">binx</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">biny</span><span class="p">)</span> <span class="o">=</span> <span class="n">binned</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">binx</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">biny</span><span class="p">)</span><span class="o">*</span><span class="n">mask</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">binx</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">biny</span><span class="p">)</span>
<a name="ln-3355"></a><span class="n">binned</span> <span class="o">=</span> <span class="n">binned</span><span class="o">**</span><span class="n">fpar</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<a name="ln-3356"></a>
<a name="ln-3357"></a>
<a name="ln-3358"></a><span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">biny</span>
<a name="ln-3359"></a>    <span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">binx</span>
<a name="ln-3360"></a>        <span class="n">EBSDvector</span><span class="p">((</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">binx</span><span class="o">+</span><span class="n">j</span><span class="p">)</span> <span class="o">=</span> <span class="n">binned</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
<a name="ln-3361"></a>    <span class="k">end do</span>
<a name="ln-3362"></a><span class="k">end do</span>
<a name="ln-3363"></a>
<a name="ln-3364"></a><span class="n">ma</span> <span class="o">=</span> <span class="nb">maxval</span><span class="p">(</span><span class="n">EBSDvector</span><span class="p">)</span>
<a name="ln-3365"></a><span class="n">mi</span> <span class="o">=</span> <span class="nb">minval</span><span class="p">(</span><span class="n">EBSDvector</span><span class="p">)</span>
<a name="ln-3366"></a>
<a name="ln-3367"></a><span class="n">img1</span> <span class="o">=</span> <span class="nb">nint</span><span class="p">(</span><span class="mi">25</span><span class="mf">5.0</span><span class="o">*</span><span class="p">(</span><span class="n">EBSDvector</span> <span class="o">-</span> <span class="n">mi</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">ma</span> <span class="o">-</span> <span class="n">mi</span><span class="p">))</span>
<a name="ln-3368"></a>
<a name="ln-3369"></a><span class="n">ma</span> <span class="o">=</span> <span class="nb">maxval</span><span class="p">(</span><span class="n">expt3</span><span class="p">)</span>
<a name="ln-3370"></a><span class="n">mi</span> <span class="o">=</span> <span class="nb">minval</span><span class="p">(</span><span class="n">expt3</span><span class="p">)</span>
<a name="ln-3371"></a>
<a name="ln-3372"></a><span class="n">img2</span> <span class="o">=</span> <span class="nb">nint</span><span class="p">(</span><span class="mi">25</span><span class="mf">5.0</span><span class="o">*</span><span class="p">(</span><span class="n">expt3</span> <span class="o">-</span> <span class="n">mi</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">ma</span> <span class="o">-</span> <span class="n">mi</span><span class="p">))</span>
<a name="ln-3373"></a>
<a name="ln-3374"></a><span class="n">img_fit_cumul</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">binx</span><span class="o">*</span><span class="n">biny</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="o">*</span><span class="n">binx</span><span class="o">*</span><span class="n">biny</span><span class="p">)</span> <span class="o">=</span> <span class="n">img1</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">binx</span><span class="o">*</span><span class="n">biny</span><span class="p">)</span>
<a name="ln-3375"></a><span class="n">img_expt_cumul</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">binx</span><span class="o">*</span><span class="n">biny</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="o">*</span><span class="n">binx</span><span class="o">*</span><span class="n">biny</span><span class="p">)</span> <span class="o">=</span> <span class="n">img2</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">binx</span><span class="o">*</span><span class="n">biny</span><span class="p">)</span>
<a name="ln-3376"></a>
<a name="ln-3377"></a><span class="c">!==============================================================================</span>
<a name="ln-3378"></a><span class="c">!============IMAGE 4===========================================================</span>
<a name="ln-3379"></a><span class="c">!==============================================================================</span>
<a name="ln-3380"></a>
<a name="ln-3381"></a><span class="n">quats</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">eu2qu</span><span class="p">(</span><span class="n">eu4</span><span class="p">)</span>
<a name="ln-3382"></a><span class="n">fpar2</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">nfpar</span><span class="p">)</span> <span class="o">=</span> <span class="n">fpar</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">nfpar</span><span class="p">)</span>
<a name="ln-3383"></a><span class="n">fpar2</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">fpar</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">ipar</span><span class="p">(</span><span class="mi">19</span><span class="p">)</span><span class="o">*</span><span class="n">fpar</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span><span class="o">/</span><span class="n">fpar</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-3384"></a><span class="n">fpar2</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">fpar</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="n">ipar</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">*</span><span class="n">fpar</span><span class="p">(</span><span class="mi">13</span><span class="p">)</span><span class="o">/</span><span class="n">fpar</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-3385"></a>
<a name="ln-3386"></a><span class="k">call </span><span class="n">getEBSDPatterns</span><span class="p">(</span><span class="n">ipar</span><span class="p">,</span> <span class="n">fpar2</span><span class="p">,</span> <span class="n">EBSDpattern</span><span class="p">,</span> <span class="n">quats</span><span class="p">,</span> <span class="n">accum_e</span><span class="p">,</span> <span class="n">mLPNH</span><span class="p">,</span> <span class="n">mLPSH</span><span class="p">)</span>
<a name="ln-3387"></a>
<a name="ln-3388"></a><span class="k">if</span> <span class="p">(</span><span class="n">ipar</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span> <span class="p">.</span><span class="n">ne</span><span class="p">.</span> <span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-3389"></a><span class="k">    do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">binx</span>
<a name="ln-3390"></a>        <span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">biny</span>
<a name="ln-3391"></a>            <span class="n">binned</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">EBSDpattern</span><span class="p">((</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">ipar</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">i</span><span class="o">*</span><span class="n">ipar</span><span class="p">(</span><span class="mi">12</span><span class="p">),(</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">ipar</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">j</span><span class="o">*</span><span class="n">ipar</span><span class="p">(</span><span class="mi">12</span><span class="p">),</span><span class="mi">1</span><span class="p">))</span>
<a name="ln-3392"></a>        <span class="k">end do</span>
<a name="ln-3393"></a><span class="k">    end do </span>
<a name="ln-3394"></a><span class="k">    </span><span class="n">binned</span> <span class="o">=</span> <span class="n">binned</span> <span class="o">*</span> <span class="n">bindx</span> 
<a name="ln-3395"></a><span class="k">else</span>
<a name="ln-3396"></a><span class="k">    </span><span class="n">binned</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">binx</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">biny</span><span class="p">)</span> <span class="o">=</span> <span class="n">EBSDpattern</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">binx</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">biny</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-3397"></a><span class="k">end if</span>
<a name="ln-3398"></a>
<a name="ln-3399"></a><span class="n">binned</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">binx</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">biny</span><span class="p">)</span> <span class="o">=</span> <span class="n">binned</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">binx</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">biny</span><span class="p">)</span><span class="o">*</span><span class="n">mask</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">binx</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">biny</span><span class="p">)</span>
<a name="ln-3400"></a><span class="n">binned</span> <span class="o">=</span> <span class="n">binned</span><span class="o">**</span><span class="n">fpar</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<a name="ln-3401"></a>
<a name="ln-3402"></a>
<a name="ln-3403"></a><span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">biny</span>
<a name="ln-3404"></a>    <span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">binx</span>
<a name="ln-3405"></a>        <span class="n">EBSDvector</span><span class="p">((</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">binx</span><span class="o">+</span><span class="n">j</span><span class="p">)</span> <span class="o">=</span> <span class="n">binned</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
<a name="ln-3406"></a>    <span class="k">end do</span>
<a name="ln-3407"></a><span class="k">end do</span>
<a name="ln-3408"></a>
<a name="ln-3409"></a><span class="n">ma</span> <span class="o">=</span> <span class="nb">maxval</span><span class="p">(</span><span class="n">EBSDvector</span><span class="p">)</span>
<a name="ln-3410"></a><span class="n">mi</span> <span class="o">=</span> <span class="nb">minval</span><span class="p">(</span><span class="n">EBSDvector</span><span class="p">)</span>
<a name="ln-3411"></a>
<a name="ln-3412"></a><span class="n">img1</span> <span class="o">=</span> <span class="nb">nint</span><span class="p">(</span><span class="mi">25</span><span class="mf">5.0</span><span class="o">*</span><span class="p">(</span><span class="n">EBSDvector</span> <span class="o">-</span> <span class="n">mi</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">ma</span> <span class="o">-</span> <span class="n">mi</span><span class="p">))</span>
<a name="ln-3413"></a>
<a name="ln-3414"></a><span class="n">ma</span> <span class="o">=</span> <span class="nb">maxval</span><span class="p">(</span><span class="n">expt4</span><span class="p">)</span>
<a name="ln-3415"></a><span class="n">mi</span> <span class="o">=</span> <span class="nb">minval</span><span class="p">(</span><span class="n">expt4</span><span class="p">)</span>
<a name="ln-3416"></a>
<a name="ln-3417"></a><span class="n">img2</span> <span class="o">=</span> <span class="nb">nint</span><span class="p">(</span><span class="mi">25</span><span class="mf">5.0</span><span class="o">*</span><span class="p">(</span><span class="n">expt4</span> <span class="o">-</span> <span class="n">mi</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">ma</span> <span class="o">-</span> <span class="n">mi</span><span class="p">))</span>
<a name="ln-3418"></a>
<a name="ln-3419"></a><span class="n">img_fit_cumul</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">binx</span><span class="o">*</span><span class="n">biny</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="o">*</span><span class="n">binx</span><span class="o">*</span><span class="n">biny</span><span class="p">)</span> <span class="o">=</span> <span class="n">img1</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">binx</span><span class="o">*</span><span class="n">biny</span><span class="p">)</span>
<a name="ln-3420"></a><span class="n">img_expt_cumul</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">binx</span><span class="o">*</span><span class="n">biny</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="o">*</span><span class="n">binx</span><span class="o">*</span><span class="n">biny</span><span class="p">)</span> <span class="o">=</span> <span class="n">img2</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">binx</span><span class="o">*</span><span class="n">biny</span><span class="p">)</span>
<a name="ln-3421"></a>
<a name="ln-3422"></a><span class="n">F</span> <span class="o">=</span> <span class="n">Jaccard_Distance</span><span class="p">(</span><span class="n">img_fit_cumul</span><span class="p">,</span><span class="n">img_expt_cumul</span><span class="p">,</span><span class="mi">4</span><span class="o">*</span><span class="n">binx</span><span class="o">*</span><span class="n">biny</span><span class="p">)</span>
<a name="ln-3423"></a>
<a name="ln-3424"></a><span class="c">!F = 1.0 - DOT_PRODUCT(EBSDvector,expt)</span>
<a name="ln-3425"></a>
<a name="ln-3426"></a><span class="k">end subroutine </span><span class="n">EBSD4calfun</span>
<a name="ln-3427"></a>
<a name="ln-3428"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-3429"></a><span class="c">!</span>
<a name="ln-3430"></a><span class="c">! SUBROUTINE:EBSDcalfun</span>
<a name="ln-3431"></a><span class="c">!</span>
<a name="ln-3432"></a><span class="c">!&gt; @author Saransh Singh, Carnegie Mellon University</span>
<a name="ln-3433"></a><span class="c">!</span>
<a name="ln-3434"></a><span class="c">!&gt; @brief This function is used by bobyqa to fit an EBSD pattern</span>
<a name="ln-3435"></a><span class="c">!</span>
<a name="ln-3436"></a><span class="c">!&gt; @details The main purpose of this routine is to calculte the difference of 1 with the dot</span>
<a name="ln-3437"></a><span class="c">!&gt; product of an experimental pattern with the given set of detector parameters. This is used</span>
<a name="ln-3438"></a><span class="c">!&gt; by bobyqa module to fit an EBSD pattern.</span>
<a name="ln-3439"></a><span class="c">!&gt;</span>
<a name="ln-3440"></a><span class="c">!&gt; This routine will first compute the detector arrays rgx etc. if necessary, and then perform</span>
<a name="ln-3441"></a><span class="c">!&gt; the usual interpolation from the square Lambert projection. The pattern will be a basic pattern,</span>
<a name="ln-3442"></a><span class="c">!&gt; without any intensity scaling or binning etc; the calling program should take care of those </span>
<a name="ln-3443"></a><span class="c">!&gt; operations.</span>
<a name="ln-3444"></a><span class="c">!</span>
<a name="ln-3445"></a><span class="c">!&gt; @param ipar array with integer input parameters</span>
<a name="ln-3446"></a><span class="c">!&gt; @param fpar array with float input parameters</span>
<a name="ln-3447"></a><span class="c">!&gt; @param initmeanval mean value of search space</span>
<a name="ln-3448"></a><span class="c">!&gt; @param EBSDpattern output array</span>
<a name="ln-3449"></a><span class="c">!&gt; @param quats quaternion input array</span>
<a name="ln-3450"></a><span class="c">!&gt; @param accum_e array with Monte Carlo histogram</span>
<a name="ln-3451"></a><span class="c">!&gt; @param mLPNH Northern hemisphere master pattern</span>
<a name="ln-3452"></a><span class="c">!&gt; @param mLPSH Southern hemisphere master pattern</span>
<a name="ln-3453"></a><span class="c">!</span>
<a name="ln-3454"></a><span class="c">!&gt; @date 12/12/15 SS 1.0 original</span>
<a name="ln-3455"></a><span class="c">!&gt; @date 03/28/16 SS 1.1 omega is no longer a variable parameter</span>
<a name="ln-3456"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-3457"></a>
<a name="ln-3458"></a><span class="k">recursive subroutine </span><span class="n">EBSDcalfun</span><span class="p">(</span><span class="n">nipar</span><span class="p">,</span> <span class="n">nfpar</span><span class="p">,</span> <span class="n">ninit</span><span class="p">,</span> <span class="n">ipar</span><span class="p">,</span> <span class="n">fpar</span><span class="p">,</span> <span class="n">initmeanval</span><span class="p">,</span> <span class="n">expt</span><span class="p">,</span> <span class="n">accum_e</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-3459"></a>                                <span class="n">mLPNH</span><span class="p">,</span> <span class="n">mLPSH</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">nstep</span><span class="p">,</span> <span class="n">stepsize</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
<a name="ln-3460"></a><span class="c">!DEC$ ATTRIBUTES DLLEXPORT :: EBSDcalfun</span>
<a name="ln-3461"></a>
<a name="ln-3462"></a><span class="c">! the input parameters are all part of a ipar and fpar input arrays instead of the usual namelist structures.</span>
<a name="ln-3463"></a><span class="c">! The following is the mapping:</span>
<a name="ln-3464"></a><span class="c">!</span>
<a name="ln-3465"></a>
<a name="ln-3466"></a><span class="c">! ipar(1) = 2</span>
<a name="ln-3467"></a><span class="c">! ipar(2) = detnumsx</span>
<a name="ln-3468"></a><span class="c">! ipar(3) = detnumsy</span>
<a name="ln-3469"></a><span class="c">! ipar(4) = detnumEbins</span>
<a name="ln-3470"></a><span class="c">! ipar(5) = mcnsx</span>
<a name="ln-3471"></a><span class="c">! ipar(6) = mpnpx</span>
<a name="ln-3472"></a><span class="c">! ipar(7) = numset</span>
<a name="ln-3473"></a><span class="c">! ipar(8) = numquats</span>
<a name="ln-3474"></a><span class="c">! ipar(9) = Emin</span>
<a name="ln-3475"></a><span class="c">! ipar(10) = Emax</span>
<a name="ln-3476"></a><span class="c">! ipar(11) = 0/1 ;0 for no mask, 1 for mask</span>
<a name="ln-3477"></a><span class="c">! ipar(12) = binning</span>
<a name="ln-3478"></a><span class="c">! ipar(13) = 0/1; 0 for DP and 1 for JD</span>
<a name="ln-3479"></a><span class="c">! ipar(14) = nregions</span>
<a name="ln-3480"></a>
<a name="ln-3481"></a><span class="c">! fpar(1) = enl%xpc</span>
<a name="ln-3482"></a><span class="c">! fpar(2) = enl%ypc</span>
<a name="ln-3483"></a><span class="c">! fpar(3) = enl%delta</span>
<a name="ln-3484"></a><span class="c">! fpar(4) = enl%MCsig</span>
<a name="ln-3485"></a><span class="c">! fpar(5) = enl%omega</span>
<a name="ln-3486"></a><span class="c">! fpar(6) = enl%thetac</span>
<a name="ln-3487"></a><span class="c">! fpar(7) = enl%L</span>
<a name="ln-3488"></a><span class="c">! fpar(8) = enl%beamcurrent</span>
<a name="ln-3489"></a><span class="c">! fpar(9) = enl%dwelltime</span>
<a name="ln-3490"></a><span class="c">! fpar(10) = alphaBD ; barrell distortion coefficient</span>
<a name="ln-3491"></a><span class="c">! fpar(11) = maskradius</span>
<a name="ln-3492"></a><span class="c">! fpar(12) = enl%gammavalue</span>
<a name="ln-3493"></a>
<a name="ln-3494"></a><span class="c">! initmeanval(1) = fpar(7)</span>
<a name="ln-3495"></a><span class="c">! initmeanval(2) = phi1</span>
<a name="ln-3496"></a><span class="c">! initmeanval(3) = phi</span>
<a name="ln-3497"></a><span class="c">! initmeanval(4) = phi2</span>
<a name="ln-3498"></a><span class="c">! initmeanval(5) = xpc</span>
<a name="ln-3499"></a><span class="c">! initmeanval(6) = ypc</span>
<a name="ln-3500"></a>
<a name="ln-3501"></a><span class="c">! stepsize(1) = step_xpc</span>
<a name="ln-3502"></a><span class="c">! stepsize(2) = step_ypc</span>
<a name="ln-3503"></a><span class="c">! stepsize(3) = step_phi1 </span>
<a name="ln-3504"></a><span class="c">! stepsize(4) = step_phi </span>
<a name="ln-3505"></a><span class="c">! stepsize(5) = step_phi2 </span>
<a name="ln-3506"></a><span class="c">! stepsize(6) = step_L</span>
<a name="ln-3507"></a>
<a name="ln-3508"></a><span class="c">! X = (/xpc, ypc, omega, L, phi1, phi, phi2/)</span>
<a name="ln-3509"></a>
<a name="ln-3510"></a>            
<a name="ln-3511"></a><span class="k">use </span><span class="n">local</span>
<a name="ln-3512"></a><span class="k">use </span><span class="n">rotations</span>
<a name="ln-3513"></a><span class="k">use </span><span class="n">constants</span>
<a name="ln-3514"></a><span class="k">use </span><span class="n">distortion</span>
<a name="ln-3515"></a><span class="k">use </span><span class="n">filters</span>
<a name="ln-3516"></a><span class="k">use </span><span class="n">Indexingmod</span><span class="p">,</span> <span class="n">ONLY</span><span class="p">:</span><span class="n">Jaccard_Distance</span>
<a name="ln-3517"></a><span class="k">use</span><span class="p">,</span><span class="k">INTRINSIC</span> <span class="kd">::</span> <span class="nb">ISO_C_BINDING</span>
<a name="ln-3518"></a><span class="nb">           </span>
<a name="ln-3519"></a><span class="k">implicit none</span>
<a name="ln-3520"></a>
<a name="ln-3521"></a><span class="kt">integer</span><span class="p">(</span><span class="n">irg</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>                 <span class="kd">::</span> <span class="n">nipar</span>
<a name="ln-3522"></a><span class="kt">integer</span><span class="p">(</span><span class="n">irg</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>                 <span class="kd">::</span> <span class="n">nfpar</span>
<a name="ln-3523"></a><span class="kt">integer</span><span class="p">(</span><span class="n">irg</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>                 <span class="kd">::</span> <span class="n">ninit</span>         
<a name="ln-3524"></a><span class="kt">integer</span><span class="p">(</span><span class="kt">c_size_t</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>            <span class="kd">::</span> <span class="n">ipar</span><span class="p">(</span><span class="n">nipar</span><span class="p">)</span>
<a name="ln-3525"></a><span class="kt">real</span><span class="p">(</span><span class="n">sgl</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span>                 <span class="kd">::</span> <span class="n">fpar</span><span class="p">(</span><span class="n">nfpar</span><span class="p">)</span>
<a name="ln-3526"></a><span class="kt">real</span><span class="p">(</span><span class="n">sgl</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>                    <span class="kd">::</span> <span class="n">initmeanval</span><span class="p">(</span><span class="n">ninit</span><span class="p">)</span>
<a name="ln-3527"></a><span class="kt">integer</span><span class="p">(</span><span class="n">irg</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>                 <span class="kd">::</span> <span class="n">nstep</span>
<a name="ln-3528"></a><span class="kt">real</span><span class="p">(</span><span class="n">sgl</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>                    <span class="kd">::</span> <span class="n">stepsize</span><span class="p">(</span><span class="n">nstep</span><span class="p">)</span>
<a name="ln-3529"></a><span class="kt">real</span><span class="p">(</span><span class="kt">c_float</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>                <span class="kd">::</span> <span class="n">expt</span><span class="p">(</span><span class="n">ipar</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">ipar</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">/</span><span class="n">ipar</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
<a name="ln-3530"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>               <span class="kd">::</span> <span class="n">accum_e</span><span class="p">(</span><span class="n">ipar</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span><span class="o">-</span><span class="n">ipar</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span><span class="n">ipar</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span><span class="o">-</span><span class="n">ipar</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span><span class="n">ipar</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>
<a name="ln-3531"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>               <span class="kd">::</span> <span class="n">mLPNH</span><span class="p">(</span><span class="o">-</span><span class="n">ipar</span><span class="p">(</span><span class="mi">6</span><span class="p">):</span><span class="n">ipar</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span> <span class="o">-</span><span class="n">ipar</span><span class="p">(</span><span class="mi">6</span><span class="p">):</span><span class="n">ipar</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span> <span class="n">ipar</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span> <span class="n">ipar</span><span class="p">(</span><span class="mi">7</span><span class="p">))</span>
<a name="ln-3532"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>               <span class="kd">::</span> <span class="n">mLPSH</span><span class="p">(</span><span class="o">-</span><span class="n">ipar</span><span class="p">(</span><span class="mi">6</span><span class="p">):</span><span class="n">ipar</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span> <span class="o">-</span><span class="n">ipar</span><span class="p">(</span><span class="mi">6</span><span class="p">):</span><span class="n">ipar</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span> <span class="n">ipar</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span> <span class="n">ipar</span><span class="p">(</span><span class="mi">7</span><span class="p">))</span>
<a name="ln-3533"></a><span class="kt">integer</span><span class="p">(</span><span class="n">irg</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>                 <span class="kd">::</span> <span class="n">n</span>
<a name="ln-3534"></a><span class="kt">real</span><span class="p">(</span><span class="n">dbl</span><span class="p">),</span><span class="k">dimension</span><span class="p">(:),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>       <span class="kd">::</span> <span class="n">x</span>
<a name="ln-3535"></a><span class="kt">real</span><span class="p">(</span><span class="n">dbl</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>                   <span class="kd">::</span> <span class="n">f</span>
<a name="ln-3536"></a><span class="kt">logical</span><span class="p">,</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">),</span><span class="k">optional</span>             <span class="kd">::</span> <span class="n">verbose</span>
<a name="ln-3537"></a>
<a name="ln-3538"></a><span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">irg</span><span class="p">)</span>                       <span class="kd">::</span> <span class="n">nnx</span><span class="p">,</span> <span class="n">nny</span><span class="p">,</span> <span class="n">binx</span><span class="p">,</span> <span class="n">biny</span>
<a name="ln-3539"></a><span class="kt">complex</span><span class="p">(</span><span class="n">dbl</span><span class="p">)</span>                            <span class="kd">::</span> <span class="n">D</span>
<a name="ln-3540"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">)</span>                          <span class="kd">::</span> <span class="n">quats</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">bindx</span><span class="p">,</span> <span class="n">ma</span><span class="p">,</span> <span class="n">mi</span>
<a name="ln-3541"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">),</span><span class="k">allocatable</span>              <span class="kd">::</span> <span class="n">EBSDpattern</span><span class="p">(:,:,:),</span> <span class="n">binned</span><span class="p">(:,:)</span>
<a name="ln-3542"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">),</span><span class="k">allocatable</span>              <span class="kd">::</span> <span class="n">EBSDpatternintd</span><span class="p">(:,:)</span>
<a name="ln-3543"></a><span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">irg</span><span class="p">),</span><span class="k">allocatable</span>           <span class="kd">::</span> <span class="n">EBSDpatterninteger</span><span class="p">(:,:),</span> <span class="n">EBSDpatternad</span><span class="p">(:,:)</span>
<a name="ln-3544"></a>
<a name="ln-3545"></a><span class="c">! variables that must be saved for the next time this function is called</span>
<a name="ln-3546"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">)</span>                          <span class="kd">::</span> <span class="n">prefactor</span>
<a name="ln-3547"></a><span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">irg</span><span class="p">),</span><span class="k">allocatable</span>           <span class="kd">::</span> <span class="n">img1</span><span class="p">(:),</span> <span class="n">img2</span><span class="p">(:)</span>
<a name="ln-3548"></a><span class="c">! other variables</span>
<a name="ln-3549"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">),</span><span class="k">parameter</span>                <span class="kd">::</span> <span class="n">dtor</span> <span class="o">=</span> <span class="mf">0.0174533</span>  <span class="c">! convert from degrees to radians</span>
<a name="ln-3550"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">)</span>                          <span class="kd">::</span> <span class="n">ixy</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">eu</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">eu2</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">eu3</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">eu4</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-3551"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">),</span> <span class="k">allocatable</span>             <span class="kd">::</span> <span class="n">EBSDvector</span><span class="p">(:),</span> <span class="n">EBSDflip</span><span class="p">(:,:),</span> <span class="n">mask</span><span class="p">(:,:)</span>
<a name="ln-3552"></a><span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">irg</span><span class="p">)</span>                       <span class="kd">::</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">istat</span>
<a name="ln-3553"></a>
<a name="ln-3554"></a><span class="kt">logical</span>                                 <span class="kd">::</span> <span class="nb">stat</span><span class="p">,</span> <span class="n">readonly</span>
<a name="ln-3555"></a><span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">irg</span><span class="p">)</span>                       <span class="kd">::</span> <span class="n">hdferr</span><span class="p">,</span> <span class="n">nlines</span><span class="p">,</span> <span class="n">nregions</span>
<a name="ln-3556"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">)</span>                          <span class="kd">::</span> <span class="n">fpar2</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<a name="ln-3557"></a><span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>                         <span class="kd">::</span> <span class="n">ipar2</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<a name="ln-3558"></a>
<a name="ln-3559"></a><span class="n">fpar</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="nb">sngl</span><span class="p">(</span><span class="n">X</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="o">*</span><span class="mf">2.0</span><span class="o">*</span><span class="n">stepsize</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">stepsize</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">initmeanval</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="c">! xpc +/- 5 pixels</span>
<a name="ln-3560"></a><span class="n">fpar</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="nb">sngl</span><span class="p">(</span><span class="n">X</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span><span class="o">*</span><span class="mf">2.0</span><span class="o">*</span><span class="n">stepsize</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="n">stepsize</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">initmeanval</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="c">! ypc +/- 5 pixels</span>
<a name="ln-3561"></a>
<a name="ln-3562"></a>
<a name="ln-3563"></a><span class="n">fpar</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="o">=</span> <span class="nb">sngl</span><span class="p">(</span><span class="n">X</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span><span class="o">*</span><span class="mf">2.0</span><span class="o">*</span><span class="n">stepsize</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span><span class="o">*</span><span class="n">fpar</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">-</span> <span class="n">stepsize</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span><span class="o">*</span><span class="n">fpar</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="n">initmeanval</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c">! mean +/- 5 pixels</span>
<a name="ln-3564"></a>
<a name="ln-3565"></a><span class="c">! 03/28/16 omega is no longer a variable parameter anymore</span>
<a name="ln-3566"></a><span class="n">fpar</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="nb">sngl</span><span class="p">(</span><span class="n">X</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span><span class="o">*</span><span class="mf">0.0</span> <span class="o">-</span> <span class="mf">0.0</span> 
<a name="ln-3567"></a>
<a name="ln-3568"></a><span class="n">eu</span> <span class="o">=</span> <span class="p">(</span><span class="o">/</span><span class="n">X</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">*</span><span class="mf">2.0</span><span class="o">*</span><span class="n">stepsize</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">-</span> <span class="n">stepsize</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="n">initmeanval</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">X</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span><span class="o">*</span><span class="mf">2.0</span><span class="o">*</span><span class="n">stepsize</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">-</span> <span class="n">stepsize</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>  <span class="o">+</span> <span class="n">initmeanval</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="p">&amp;</span>
<a name="ln-3569"></a>       <span class="n">X</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span><span class="o">*</span><span class="mf">2.0</span><span class="o">*</span><span class="n">stepsize</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">-</span> <span class="n">stepsize</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="n">initmeanval</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">/</span><span class="p">)</span><span class="o">*</span><span class="n">dtor</span> <span class="c">! mean +/- 2 degrees</span>
<a name="ln-3570"></a>
<a name="ln-3571"></a>
<a name="ln-3572"></a><span class="n">binx</span> <span class="o">=</span> <span class="n">ipar</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">ipar</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span>
<a name="ln-3573"></a><span class="n">biny</span> <span class="o">=</span> <span class="n">ipar</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">/</span><span class="n">ipar</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span>
<a name="ln-3574"></a><span class="n">bindx</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">ipar</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
<a name="ln-3575"></a><span class="n">nnx</span> <span class="o">=</span> <span class="n">ipar</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<a name="ln-3576"></a><span class="n">nny</span> <span class="o">=</span> <span class="n">ipar</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-3577"></a><span class="n">nregions</span> <span class="o">=</span> <span class="n">IPAR</span><span class="p">(</span><span class="mi">14</span><span class="p">)</span>
<a name="ln-3578"></a>
<a name="ln-3579"></a><span class="k">allocate</span><span class="p">(</span><span class="n">EBSDvector</span><span class="p">(</span><span class="n">binx</span><span class="o">*</span><span class="n">biny</span><span class="p">),</span><span class="n">mask</span><span class="p">(</span><span class="n">binx</span><span class="p">,</span><span class="n">biny</span><span class="p">))</span>
<a name="ln-3580"></a><span class="k">allocate</span><span class="p">(</span><span class="n">EBSDpattern</span><span class="p">(</span><span class="n">ipar</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span><span class="n">ipar</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span><span class="mi">1</span><span class="p">))</span>
<a name="ln-3581"></a><span class="k">allocate</span><span class="p">(</span><span class="n">binned</span><span class="p">(</span><span class="n">binx</span><span class="p">,</span><span class="n">biny</span><span class="p">))</span>
<a name="ln-3582"></a><span class="k">allocate</span><span class="p">(</span><span class="n">EBSDpatternintd</span><span class="p">(</span><span class="n">ipar</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span><span class="n">ipar</span><span class="p">(</span><span class="mi">3</span><span class="p">)),</span><span class="n">EBSDpatterninteger</span><span class="p">(</span><span class="n">ipar</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span><span class="n">ipar</span><span class="p">(</span><span class="mi">3</span><span class="p">)),</span> <span class="n">EBSDpatternad</span><span class="p">(</span><span class="n">ipar</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span><span class="n">ipar</span><span class="p">(</span><span class="mi">3</span><span class="p">)))</span>
<a name="ln-3583"></a><span class="k">allocate</span><span class="p">(</span><span class="n">img1</span><span class="p">(</span><span class="n">binx</span><span class="o">*</span><span class="n">biny</span><span class="p">),</span><span class="n">img2</span><span class="p">(</span><span class="n">binx</span><span class="o">*</span><span class="n">biny</span><span class="p">))</span>
<a name="ln-3584"></a>
<a name="ln-3585"></a><span class="n">binned</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-3586"></a><span class="n">EBSDpatternintd</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-3587"></a><span class="n">EBSDpatterninteger</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-3588"></a><span class="n">EBSDpatternad</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-3589"></a><span class="n">img1</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-3590"></a><span class="n">img2</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-3591"></a>
<a name="ln-3592"></a><span class="n">mask</span> <span class="o">=</span> <span class="mf">1.0</span>
<a name="ln-3593"></a>
<a name="ln-3594"></a><span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">verbose</span><span class="p">))</span> <span class="k">then</span>
<a name="ln-3595"></a><span class="k">    if</span><span class="p">(</span><span class="n">verbose</span><span class="p">)</span> <span class="k">then    </span>
<a name="ln-3596"></a><span class="k">        print</span><span class="o">*</span><span class="p">,</span><span class="s1">&#39;xpc, ypc, L, eu = &#39;</span><span class="p">,</span> <span class="n">fpar</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">fpar</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">fpar</span><span class="p">(</span><span class="mi">7</span><span class="p">),</span> <span class="n">eu</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="mi">18</span><span class="mf">0.0</span><span class="o">/</span><span class="n">cPi</span>
<a name="ln-3597"></a>     <span class="k">end if</span>
<a name="ln-3598"></a><span class="k">end if</span>
<a name="ln-3599"></a>
<a name="ln-3600"></a><span class="n">fpar2</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">10</span><span class="p">)</span> <span class="o">=</span> <span class="n">fpar</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">10</span><span class="p">)</span>
<a name="ln-3601"></a><span class="n">ipar2</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">10</span><span class="p">)</span> <span class="o">=</span> <span class="n">ipar</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">10</span><span class="p">)</span>
<a name="ln-3602"></a><span class="n">quats</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">eu2qu</span><span class="p">(</span><span class="n">eu</span><span class="p">)</span>
<a name="ln-3603"></a>
<a name="ln-3604"></a><span class="k">call </span><span class="n">getEBSDPatterns</span><span class="p">(</span><span class="n">ipar2</span><span class="p">,</span> <span class="n">fpar2</span><span class="p">,</span> <span class="n">EBSDpattern</span><span class="p">,</span> <span class="n">quats</span><span class="p">,</span> <span class="n">accum_e</span><span class="p">,</span> <span class="n">mLPNH</span><span class="p">,</span> <span class="n">mLPSH</span><span class="p">)</span>
<a name="ln-3605"></a>
<a name="ln-3606"></a><span class="n">ma</span> <span class="o">=</span> <span class="nb">maxval</span><span class="p">(</span><span class="n">EBSDPattern</span><span class="p">(:,:,</span><span class="mi">1</span><span class="p">))</span>
<a name="ln-3607"></a><span class="n">mi</span> <span class="o">=</span> <span class="nb">minval</span><span class="p">(</span><span class="n">EBSDPattern</span><span class="p">(:,:,</span><span class="mi">1</span><span class="p">))</span>
<a name="ln-3608"></a>
<a name="ln-3609"></a><span class="n">EBSDpatternintd</span> <span class="o">=</span> <span class="p">((</span><span class="n">EBSDPattern</span><span class="p">(:,:,</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">mi</span><span class="p">)</span><span class="o">/</span> <span class="p">(</span><span class="n">ma</span><span class="o">-</span><span class="n">mi</span><span class="p">))</span>
<a name="ln-3610"></a><span class="n">EBSDpatterninteger</span> <span class="o">=</span> <span class="nb">nint</span><span class="p">(</span><span class="n">EBSDpatternintd</span><span class="o">*</span><span class="mi">25</span><span class="mf">5.0</span><span class="p">)</span>
<a name="ln-3611"></a><span class="n">EBSDpatternad</span> <span class="o">=</span>  <span class="n">adhisteq</span><span class="p">(</span><span class="n">nregions</span><span class="p">,</span><span class="n">nnx</span><span class="p">,</span><span class="n">nny</span><span class="p">,</span><span class="n">EBSDpatterninteger</span><span class="p">)</span>
<a name="ln-3612"></a><span class="n">EBSDPattern</span><span class="p">(:,:,</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">EBSDpatternad</span><span class="p">)</span>
<a name="ln-3613"></a>
<a name="ln-3614"></a><span class="k">if</span> <span class="p">(</span><span class="n">ipar</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span> <span class="p">.</span><span class="n">ne</span><span class="p">.</span> <span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-3615"></a><span class="k">    do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">binx</span>
<a name="ln-3616"></a>        <span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">biny</span>
<a name="ln-3617"></a>            <span class="n">binned</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">EBSDpattern</span><span class="p">((</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">ipar</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">i</span><span class="o">*</span><span class="n">ipar</span><span class="p">(</span><span class="mi">12</span><span class="p">),(</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">ipar</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">j</span><span class="o">*</span><span class="n">ipar</span><span class="p">(</span><span class="mi">12</span><span class="p">),</span><span class="mi">1</span><span class="p">))</span>
<a name="ln-3618"></a>        <span class="k">end do</span>
<a name="ln-3619"></a><span class="k">    end do </span>
<a name="ln-3620"></a><span class="k">    </span><span class="n">binned</span> <span class="o">=</span> <span class="n">binned</span> <span class="o">*</span> <span class="n">bindx</span> 
<a name="ln-3621"></a><span class="k">else</span>
<a name="ln-3622"></a><span class="k">    </span><span class="n">binned</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">binx</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">biny</span><span class="p">)</span> <span class="o">=</span> <span class="n">EBSDpattern</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">binx</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">biny</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-3623"></a><span class="k">end if</span>
<a name="ln-3624"></a>
<a name="ln-3625"></a>
<a name="ln-3626"></a><span class="k">if</span> <span class="p">(</span><span class="n">ipar</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span> <span class="p">.</span><span class="n">eq</span><span class="p">.</span> <span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-3627"></a><span class="k">    do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="n">binx</span>
<a name="ln-3628"></a>        <span class="k">do </span><span class="n">j</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="n">biny</span>
<a name="ln-3629"></a>            <span class="k">if</span><span class="p">(((</span><span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">-</span><span class="nb">ceiling</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">binx</span><span class="p">)</span><span class="o">/</span><span class="mf">2.0</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">-</span><span class="nb">ceiling</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">biny</span><span class="p">)</span><span class="o">/</span><span class="mf">2.0</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="p">.</span><span class="n">gt</span><span class="p">.</span> <span class="n">fpar</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-3630"></a><span class="k">                </span><span class="n">mask</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-3631"></a>            <span class="k">end if</span>
<a name="ln-3632"></a><span class="k">        end do</span>
<a name="ln-3633"></a><span class="k">    end do</span>
<a name="ln-3634"></a><span class="k">end if</span>
<a name="ln-3635"></a>
<a name="ln-3636"></a><span class="n">binned</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">binx</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">biny</span><span class="p">)</span> <span class="o">=</span> <span class="n">binned</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">binx</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">biny</span><span class="p">)</span><span class="o">*</span><span class="n">mask</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">binx</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">biny</span><span class="p">)</span>
<a name="ln-3637"></a><span class="n">binned</span> <span class="o">=</span> <span class="n">binned</span><span class="o">**</span><span class="n">fpar</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span>
<a name="ln-3638"></a>
<a name="ln-3639"></a>
<a name="ln-3640"></a><span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">biny</span>
<a name="ln-3641"></a>    <span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">binx</span>
<a name="ln-3642"></a>        <span class="n">EBSDvector</span><span class="p">((</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">binx</span><span class="o">+</span><span class="n">j</span><span class="p">)</span> <span class="o">=</span> <span class="n">binned</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
<a name="ln-3643"></a>    <span class="k">end do</span>
<a name="ln-3644"></a><span class="k">end do</span>
<a name="ln-3645"></a>
<a name="ln-3646"></a><span class="n">EBSDvector</span> <span class="o">=</span> <span class="n">EBSDvector</span><span class="o">/</span><span class="nb">NORM2</span><span class="p">(</span><span class="n">EBSDvector</span><span class="p">)</span>
<a name="ln-3647"></a>
<a name="ln-3648"></a><span class="k">if</span><span class="p">(</span><span class="n">IPAR</span><span class="p">(</span><span class="mi">13</span><span class="p">)</span> <span class="p">.</span><span class="n">eq</span><span class="p">.</span> <span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-3649"></a><span class="k">    </span><span class="n">ma</span> <span class="o">=</span> <span class="nb">maxval</span><span class="p">(</span><span class="n">EBSDvector</span><span class="p">)</span>
<a name="ln-3650"></a>    <span class="n">mi</span> <span class="o">=</span> <span class="nb">minval</span><span class="p">(</span><span class="n">EBSDvector</span><span class="p">)</span>
<a name="ln-3651"></a>
<a name="ln-3652"></a>    <span class="n">img1</span> <span class="o">=</span> <span class="nb">nint</span><span class="p">(</span><span class="mi">25</span><span class="mf">5.0</span><span class="o">*</span><span class="p">(</span><span class="n">EBSDvector</span> <span class="o">-</span> <span class="n">mi</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">ma</span> <span class="o">-</span> <span class="n">mi</span><span class="p">))</span>
<a name="ln-3653"></a>
<a name="ln-3654"></a>    <span class="n">ma</span> <span class="o">=</span> <span class="nb">maxval</span><span class="p">(</span><span class="n">expt</span><span class="p">)</span>
<a name="ln-3655"></a>    <span class="n">mi</span> <span class="o">=</span> <span class="nb">minval</span><span class="p">(</span><span class="n">expt</span><span class="p">)</span>
<a name="ln-3656"></a>
<a name="ln-3657"></a>    <span class="n">img2</span> <span class="o">=</span> <span class="nb">nint</span><span class="p">(</span><span class="mi">25</span><span class="mf">5.0</span><span class="o">*</span><span class="p">(</span><span class="n">expt</span> <span class="o">-</span> <span class="n">mi</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">ma</span> <span class="o">-</span> <span class="n">mi</span><span class="p">))</span>
<a name="ln-3658"></a>
<a name="ln-3659"></a>    <span class="n">F</span> <span class="o">=</span> <span class="n">Jaccard_Distance</span><span class="p">(</span><span class="n">img1</span><span class="p">,</span><span class="n">img2</span><span class="p">,</span><span class="n">binx</span><span class="o">*</span><span class="n">biny</span><span class="p">)</span>
<a name="ln-3660"></a><span class="k">else</span>
<a name="ln-3661"></a><span class="k">    </span><span class="n">F</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="nb">DOT_PRODUCT</span><span class="p">(</span><span class="n">EBSDvector</span><span class="p">,</span><span class="n">expt</span><span class="p">)</span>
<a name="ln-3662"></a><span class="k">end if</span>
<a name="ln-3663"></a>
<a name="ln-3664"></a><span class="k">end subroutine </span><span class="n">EBSDcalfun</span>
<a name="ln-3665"></a>
<a name="ln-3666"></a>
<a name="ln-3667"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-3668"></a><span class="c">!</span>
<a name="ln-3669"></a><span class="c">! SUBROUTINE:ECPcalfun</span>
<a name="ln-3670"></a><span class="c">!</span>
<a name="ln-3671"></a><span class="c">!&gt; @author Saransh Singh, Carnegie Mellon University</span>
<a name="ln-3672"></a><span class="c">!</span>
<a name="ln-3673"></a><span class="c">!&gt; @brief This function is used by bobyqa to fit an EBSD pattern</span>
<a name="ln-3674"></a><span class="c">!</span>
<a name="ln-3675"></a><span class="c">!&gt; @etails The main purpose of this routine is to calculte the difference of 1 with the dot</span>
<a name="ln-3676"></a><span class="c">!&gt; product of an experimental pattern with the given set of detector parameters. This is used</span>
<a name="ln-3677"></a><span class="c">!&gt; by bobyqa module to fit an EBSD pattern.</span>
<a name="ln-3678"></a><span class="c">!&gt;</span>
<a name="ln-3679"></a><span class="c">!&gt; This routine will first compute the detector arrays rgx etc. if necessary, and then perform</span>
<a name="ln-3680"></a><span class="c">!&gt; the usual interpolation from the square Lambert projection. The pattern will be a basic pattern,</span>
<a name="ln-3681"></a><span class="c">!&gt; without any intensity scaling or binning etc; the calling program should take care of those </span>
<a name="ln-3682"></a><span class="c">!&gt; operations.</span>
<a name="ln-3683"></a><span class="c">!</span>
<a name="ln-3684"></a><span class="c">!&gt; @param ipar array with integer input parameters</span>
<a name="ln-3685"></a><span class="c">!&gt; @param fpar array with float input parameters</span>
<a name="ln-3686"></a><span class="c">!&gt; @param initmeanval array with mean value of search space</span>
<a name="ln-3687"></a><span class="c">!&gt; @param ECPattern output array</span>
<a name="ln-3688"></a><span class="c">!&gt; @param quats array of quaternions</span>
<a name="ln-3689"></a><span class="c">!&gt; @param accum_e array with Monte Carlo histogram</span>
<a name="ln-3690"></a><span class="c">!&gt; @param mLPNH Northern hemisphere master pattern</span>
<a name="ln-3691"></a><span class="c">!&gt; @param mLPSH Southern hemisphere master pattern</span>
<a name="ln-3692"></a><span class="c">!</span>
<a name="ln-3693"></a><span class="c">!&gt; @date 12/12/15  SS 1.0 original</span>
<a name="ln-3694"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-3695"></a>
<a name="ln-3696"></a><span class="k">recursive subroutine </span><span class="n">ECPcalfun</span> <span class="p">(</span><span class="n">nipar</span><span class="p">,</span> <span class="n">nfpar</span><span class="p">,</span> <span class="n">ninit</span><span class="p">,</span> <span class="n">ipar</span><span class="p">,</span> <span class="n">fpar</span><span class="p">,</span> <span class="n">initmeanval</span><span class="p">,</span> <span class="n">expt</span><span class="p">,</span> <span class="n">accum_e</span><span class="p">,</span> <span class="n">mLPNH</span><span class="p">,</span> <span class="n">mLPSH</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-3697"></a>                                <span class="n">n</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">nstep</span><span class="p">,</span> <span class="n">stepsize</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
<a name="ln-3698"></a><span class="c">!DEC$ ATTRIBUTES DLLEXPORT :: ECPcalfun</span>
<a name="ln-3699"></a>
<a name="ln-3700"></a><span class="c">! the input parameters are all part of a ipar and fpar input arrays instead of the usual namelist structures.</span>
<a name="ln-3701"></a><span class="c">! The following is the mapping:</span>
<a name="ln-3702"></a><span class="c">!</span>
<a name="ln-3703"></a><span class="c">! ipar(1) = 1 </span>
<a name="ln-3704"></a><span class="c">! ipar(2) = detnumsx</span>
<a name="ln-3705"></a><span class="c">! ipar(3) = detnumsy</span>
<a name="ln-3706"></a><span class="c">! ipar(4) = numangle</span>
<a name="ln-3707"></a><span class="c">! ipar(5) = mcnsx</span>
<a name="ln-3708"></a><span class="c">! ipar(6) = mpnpx</span>
<a name="ln-3709"></a><span class="c">! ipar(7) = numset</span>
<a name="ln-3710"></a><span class="c">! ipar(8) = numquats</span>
<a name="ln-3711"></a><span class="c">! ipar(9) = 0/1 ;0 for no mask, 1 for mask</span>
<a name="ln-3712"></a><span class="c">! ipar(10) = 1; equal to numEbins</span>
<a name="ln-3713"></a><span class="c">! ipar(11) = 0/1; 0 for DP 1 for JD</span>
<a name="ln-3714"></a><span class="c">! ipar(12) = 1 ;binning</span>
<a name="ln-3715"></a>
<a name="ln-3716"></a><span class="c">! fpar(1) = ecpnl%thetac</span>
<a name="ln-3717"></a><span class="c">! fpar(2) = ecpnl%sampletilt</span>
<a name="ln-3718"></a><span class="c">! fpar(3) = ecpnl%workingdistance</span>
<a name="ln-3719"></a><span class="c">! fpar(4) = ecpnl%Rin</span>
<a name="ln-3720"></a><span class="c">! fpar(5) = ecpnl%Rout</span>
<a name="ln-3721"></a><span class="c">! fpar(6) = ecpnl%sigstart</span>
<a name="ln-3722"></a><span class="c">! fpar(7) = ecpnl%sigend</span>
<a name="ln-3723"></a><span class="c">! fpar(8) = ecpnl%sigstep</span>
<a name="ln-3724"></a><span class="c">! fpar(9) = ecpnl%gammavalue</span>
<a name="ln-3725"></a><span class="c">! fpar(10) = maskradius</span>
<a name="ln-3726"></a>
<a name="ln-3727"></a><span class="c">! initmeanval(1) = thetac</span>
<a name="ln-3728"></a><span class="c">! initmeanval(2) = sampletilt</span>
<a name="ln-3729"></a><span class="c">! initmeanval(3) = working distance </span>
<a name="ln-3730"></a><span class="c">! initmeanval(4) = phi1</span>
<a name="ln-3731"></a><span class="c">! initmeanval(5) = phi</span>
<a name="ln-3732"></a><span class="c">! initmeanval(6) = phi2</span>
<a name="ln-3733"></a>
<a name="ln-3734"></a><span class="c">! stepsize(1) = step_thetacone</span>
<a name="ln-3735"></a><span class="c">! stepsize(2) = step_phi1</span>
<a name="ln-3736"></a><span class="c">! stepsize(3) = step_phi ; all 4 patterns</span>
<a name="ln-3737"></a><span class="c">! stepsize(4) = step_phi2 ; all 4 patterns</span>
<a name="ln-3738"></a>
<a name="ln-3739"></a>
<a name="ln-3740"></a><span class="k">use </span><span class="n">local</span>
<a name="ln-3741"></a><span class="k">use </span><span class="n">rotations</span>
<a name="ln-3742"></a><span class="k">use </span><span class="n">constants</span>
<a name="ln-3743"></a><span class="k">use </span><span class="n">distortion</span> 
<a name="ln-3744"></a><span class="k">use</span><span class="p">,</span><span class="k">INTRINSIC</span> <span class="kd">::</span> <span class="nb">ISO_C_BINDING</span>
<a name="ln-3745"></a><span class="k">use </span><span class="n">filters</span>
<a name="ln-3746"></a><span class="k">use </span><span class="n">Indexingmod</span><span class="p">,</span> <span class="n">ONLY</span><span class="p">:</span><span class="n">Jaccard_Distance</span>
<a name="ln-3747"></a>
<a name="ln-3748"></a><span class="k">IMPLICIT NONE</span>
<a name="ln-3749"></a>
<a name="ln-3750"></a><span class="kt">integer</span><span class="p">(</span><span class="kt">c_size_t</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>            <span class="kd">::</span> <span class="n">ipar</span><span class="p">(</span><span class="n">nipar</span><span class="p">)</span>
<a name="ln-3751"></a><span class="kt">real</span><span class="p">(</span><span class="n">sgl</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span>                 <span class="kd">::</span> <span class="n">fpar</span><span class="p">(</span><span class="n">nfpar</span><span class="p">)</span>
<a name="ln-3752"></a><span class="kt">real</span><span class="p">(</span><span class="n">sgl</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>                    <span class="kd">::</span> <span class="n">initmeanval</span><span class="p">(</span><span class="n">ninit</span><span class="p">)</span>
<a name="ln-3753"></a><span class="kt">integer</span><span class="p">(</span><span class="n">irg</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>                 <span class="kd">::</span> <span class="n">nipar</span>
<a name="ln-3754"></a><span class="kt">integer</span><span class="p">(</span><span class="n">irg</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>                 <span class="kd">::</span> <span class="n">nfpar</span>
<a name="ln-3755"></a><span class="kt">integer</span><span class="p">(</span><span class="n">irg</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>                 <span class="kd">::</span> <span class="n">ninit</span>
<a name="ln-3756"></a><span class="kt">real</span><span class="p">(</span><span class="kt">c_float</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>                <span class="kd">::</span> <span class="n">expt</span><span class="p">(</span><span class="n">ipar</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">ipar</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">/</span><span class="n">ipar</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
<a name="ln-3757"></a><span class="kt">integer</span><span class="p">(</span><span class="n">irg</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>                 <span class="kd">::</span> <span class="n">nstep</span>
<a name="ln-3758"></a><span class="kt">real</span><span class="p">(</span><span class="n">sgl</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>                    <span class="kd">::</span> <span class="n">stepsize</span><span class="p">(</span><span class="n">nstep</span><span class="p">)</span>
<a name="ln-3759"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>               <span class="kd">::</span> <span class="n">accum_e</span><span class="p">(</span><span class="n">ipar</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span><span class="o">-</span><span class="n">ipar</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span><span class="n">ipar</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span><span class="o">-</span><span class="n">ipar</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span><span class="n">ipar</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>
<a name="ln-3760"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>               <span class="kd">::</span> <span class="n">mLPNH</span><span class="p">(</span><span class="o">-</span><span class="n">ipar</span><span class="p">(</span><span class="mi">6</span><span class="p">):</span><span class="n">ipar</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span> <span class="o">-</span><span class="n">ipar</span><span class="p">(</span><span class="mi">6</span><span class="p">):</span><span class="n">ipar</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span> <span class="n">ipar</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span> <span class="n">ipar</span><span class="p">(</span><span class="mi">7</span><span class="p">))</span>
<a name="ln-3761"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>               <span class="kd">::</span> <span class="n">mLPSH</span><span class="p">(</span><span class="o">-</span><span class="n">ipar</span><span class="p">(</span><span class="mi">6</span><span class="p">):</span><span class="n">ipar</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span> <span class="o">-</span><span class="n">ipar</span><span class="p">(</span><span class="mi">6</span><span class="p">):</span><span class="n">ipar</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span> <span class="n">ipar</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span> <span class="n">ipar</span><span class="p">(</span><span class="mi">7</span><span class="p">))</span>
<a name="ln-3762"></a><span class="kt">integer</span><span class="p">(</span><span class="n">irg</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>                 <span class="kd">::</span> <span class="n">n</span>
<a name="ln-3763"></a><span class="kt">real</span><span class="p">(</span><span class="n">dbl</span><span class="p">),</span><span class="k">dimension</span><span class="p">(:),</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span>       <span class="kd">::</span> <span class="n">x</span>
<a name="ln-3764"></a><span class="kt">real</span><span class="p">(</span><span class="n">dbl</span><span class="p">),</span><span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>                   <span class="kd">::</span> <span class="n">f</span>
<a name="ln-3765"></a><span class="kt">logical</span><span class="p">,</span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">),</span><span class="k">optional</span>             <span class="kd">::</span> <span class="n">verbose</span>
<a name="ln-3766"></a>
<a name="ln-3767"></a><span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">irg</span><span class="p">)</span>                       <span class="kd">::</span> <span class="n">nnx</span><span class="p">,</span> <span class="n">nny</span>
<a name="ln-3768"></a><span class="kt">complex</span><span class="p">(</span><span class="n">dbl</span><span class="p">)</span>                            <span class="kd">::</span> <span class="n">D</span>
<a name="ln-3769"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">)</span>                          <span class="kd">::</span> <span class="n">quats</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">ma</span><span class="p">,</span> <span class="n">mi</span>
<a name="ln-3770"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">),</span><span class="k">allocatable</span>              <span class="kd">::</span> <span class="n">ECPpattern</span><span class="p">(:,:,:)</span>
<a name="ln-3771"></a>
<a name="ln-3772"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">),</span><span class="k">allocatable</span>              <span class="kd">::</span> <span class="n">binned</span><span class="p">(:,:)</span>
<a name="ln-3773"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">),</span><span class="k">allocatable</span>              <span class="kd">::</span> <span class="n">ECPpatternintd</span><span class="p">(:,:)</span>
<a name="ln-3774"></a><span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">irg</span><span class="p">),</span><span class="k">allocatable</span>           <span class="kd">::</span> <span class="n">ECPpatterninteger</span><span class="p">(:,:),</span> <span class="n">ECPpatternad</span><span class="p">(:,:)</span>
<a name="ln-3775"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">),</span><span class="k">allocatable</span>              <span class="kd">::</span> <span class="n">ECPvector</span><span class="p">(:),</span> <span class="n">ECPvectorcpy</span><span class="p">(:),</span> <span class="n">ECPtmp</span><span class="p">(:,:)</span>
<a name="ln-3776"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">),</span><span class="k">allocatable</span>              <span class="kd">::</span> <span class="n">mask</span><span class="p">(:,:)</span>
<a name="ln-3777"></a><span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">irg</span><span class="p">),</span><span class="k">allocatable</span>           <span class="kd">::</span> <span class="n">img1</span><span class="p">(:),</span> <span class="n">img2</span><span class="p">(:)</span>
<a name="ln-3778"></a>
<a name="ln-3779"></a><span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">irg</span><span class="p">)</span>                       <span class="kd">::</span> <span class="n">istat</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span>
<a name="ln-3780"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">),</span><span class="k">parameter</span>                <span class="kd">::</span> <span class="n">dtor</span> <span class="o">=</span> <span class="mf">0.0174533</span>  <span class="c">! convert from degrees to radians</span>
<a name="ln-3781"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">)</span>                          <span class="kd">::</span> <span class="n">eu</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-3782"></a><span class="kt">logical</span>                                 <span class="kd">::</span> <span class="nb">stat</span><span class="p">,</span> <span class="n">readonly</span>
<a name="ln-3783"></a><span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">irg</span><span class="p">)</span>                       <span class="kd">::</span> <span class="n">hdferr</span><span class="p">,</span> <span class="n">nlines</span><span class="p">,</span> <span class="n">nregions</span>
<a name="ln-3784"></a>
<a name="ln-3785"></a>
<a name="ln-3786"></a><span class="n">fpar</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="nb">sngl</span><span class="p">(</span><span class="n">X</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="o">*</span><span class="mf">2.0</span><span class="o">*</span><span class="n">stepsize</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">stepsize</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">initmeanval</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c">! thetac mean +/- stepsize degrees degrees only</span>
<a name="ln-3787"></a>
<a name="ln-3788"></a><span class="n">eu</span> <span class="o">=</span> <span class="p">(</span><span class="o">/</span><span class="n">X</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="mf">2.0</span><span class="o">*</span><span class="n">stepsize</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="n">stepsize</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">initmeanval</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">X</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="mf">2.0</span><span class="o">*</span><span class="n">stepsize</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">-</span> <span class="n">stepsize</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>  <span class="o">+</span> <span class="n">initmeanval</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="p">&amp;</span>
<a name="ln-3789"></a>       <span class="n">X</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">*</span><span class="mf">2.0</span><span class="o">*</span><span class="n">stepsize</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">-</span> <span class="n">stepsize</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="n">initmeanval</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">/</span><span class="p">)</span><span class="o">*</span><span class="n">cPi</span><span class="o">/</span><span class="mi">18</span><span class="mf">0.0</span> <span class="c">! mean +/- stepsize</span>
<a name="ln-3790"></a>
<a name="ln-3791"></a><span class="n">quats</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">eu2qu</span><span class="p">(</span><span class="n">eu</span><span class="p">)</span>
<a name="ln-3792"></a>
<a name="ln-3793"></a><span class="c">!D = dcmplx(0.D0,0.D0)</span>
<a name="ln-3794"></a><span class="c">! read all the files </span>
<a name="ln-3795"></a>
<a name="ln-3796"></a><span class="k">allocate</span><span class="p">(</span><span class="n">ECPvector</span><span class="p">(</span><span class="n">ipar</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">ipar</span><span class="p">(</span><span class="mi">3</span><span class="p">)),</span><span class="n">mask</span><span class="p">(</span><span class="n">ipar</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span><span class="n">ipar</span><span class="p">(</span><span class="mi">3</span><span class="p">)))</span>
<a name="ln-3797"></a><span class="k">allocate</span><span class="p">(</span><span class="n">ECPpattern</span><span class="p">(</span><span class="n">ipar</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span><span class="n">ipar</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span><span class="n">ipar</span><span class="p">(</span><span class="mi">8</span><span class="p">)))</span>
<a name="ln-3798"></a><span class="k">allocate</span><span class="p">(</span><span class="n">ECPpatternintd</span><span class="p">(</span><span class="n">ipar</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span><span class="n">ipar</span><span class="p">(</span><span class="mi">3</span><span class="p">)),</span><span class="n">ECPpatterninteger</span><span class="p">(</span><span class="n">ipar</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span><span class="n">ipar</span><span class="p">(</span><span class="mi">3</span><span class="p">)),</span> <span class="n">ECPpatternad</span><span class="p">(</span><span class="n">ipar</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span><span class="n">ipar</span><span class="p">(</span><span class="mi">3</span><span class="p">)))</span>
<a name="ln-3799"></a><span class="n">ECPpatternintd</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-3800"></a><span class="n">ECPpatterninteger</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-3801"></a><span class="n">ECPpatternad</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-3802"></a>
<a name="ln-3803"></a><span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">verbose</span><span class="p">))</span> <span class="k">then</span>
<a name="ln-3804"></a><span class="k">    if</span><span class="p">(</span><span class="n">verbose</span><span class="p">)</span> <span class="k">then    </span>
<a name="ln-3805"></a><span class="k">        print</span><span class="o">*</span><span class="p">,</span><span class="s1">&#39;thetac, eu = &#39;</span><span class="p">,</span><span class="nb">sngl</span><span class="p">(</span><span class="n">X</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="o">*</span><span class="mf">2.0</span><span class="o">*</span><span class="n">stepsize</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">stepsize</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">initmeanval</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">eu</span><span class="o">*</span><span class="mi">18</span><span class="mf">0.0</span><span class="o">/</span><span class="n">cPi</span>
<a name="ln-3806"></a>    <span class="k">end if</span>
<a name="ln-3807"></a><span class="k">end if</span>
<a name="ln-3808"></a>
<a name="ln-3809"></a><span class="n">mask</span> <span class="o">=</span> <span class="mf">1.0</span>
<a name="ln-3810"></a><span class="k">do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="n">ipar</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<a name="ln-3811"></a>    <span class="k">do </span><span class="n">j</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="n">ipar</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-3812"></a>        <span class="k">if</span><span class="p">(((</span><span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">-</span><span class="nb">ceiling</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">ipar</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span><span class="o">/</span><span class="mf">2.0</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">-</span><span class="nb">ceiling</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">ipar</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span><span class="o">/</span><span class="mf">2.0</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="p">.</span><span class="n">gt</span><span class="p">.</span> <span class="n">fpar</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-3813"></a><span class="k">            </span><span class="n">mask</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-3814"></a>        <span class="k">end if</span>
<a name="ln-3815"></a><span class="k">    end do</span>
<a name="ln-3816"></a><span class="k">end do</span>
<a name="ln-3817"></a>
<a name="ln-3818"></a><span class="k">call </span><span class="n">getECPatterns</span><span class="p">(</span><span class="n">ipar</span><span class="p">,</span> <span class="n">fpar</span><span class="p">,</span> <span class="n">ECPpattern</span><span class="p">,</span> <span class="n">quats</span><span class="p">,</span> <span class="n">accum_e</span><span class="p">,</span> <span class="n">mLPNH</span><span class="p">,</span> <span class="n">mLPSH</span><span class="p">)</span>
<a name="ln-3819"></a>
<a name="ln-3820"></a><span class="n">nnx</span> <span class="o">=</span> <span class="n">ipar</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<a name="ln-3821"></a><span class="n">nny</span> <span class="o">=</span> <span class="n">ipar</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-3822"></a><span class="c">!nregions = ipar(12)</span>
<a name="ln-3823"></a>
<a name="ln-3824"></a><span class="k">allocate</span><span class="p">(</span><span class="n">ECPvector</span><span class="p">(</span><span class="n">ipar</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">ipar</span><span class="p">(</span><span class="mi">3</span><span class="p">)),</span><span class="nb">stat</span><span class="o">=</span><span class="n">istat</span><span class="p">)</span>
<a name="ln-3825"></a>
<a name="ln-3826"></a><span class="k">if</span> <span class="p">(</span><span class="n">ipar</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span> <span class="p">.</span><span class="n">eq</span><span class="p">.</span> <span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-3827"></a><span class="k">    do </span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="n">ipar</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
<a name="ln-3828"></a>        <span class="n">ECPpattern</span><span class="p">(:,:,</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="n">ECPpattern</span><span class="p">(:,:,</span><span class="n">i</span><span class="p">)</span><span class="o">*</span><span class="n">mask</span>
<a name="ln-3829"></a>    <span class="k">end do</span>
<a name="ln-3830"></a><span class="k">end if</span>
<a name="ln-3831"></a>
<a name="ln-3832"></a><span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">ipar</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<a name="ln-3833"></a>    <span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">ipar</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-3834"></a>        <span class="n">ECPvector</span><span class="p">((</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">ipar</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">+</span><span class="n">j</span><span class="p">)</span> <span class="o">=</span> <span class="n">ECPpattern</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-3835"></a>    <span class="k">end do</span>
<a name="ln-3836"></a><span class="k">end do</span>
<a name="ln-3837"></a>
<a name="ln-3838"></a><span class="c">!ECPvector = 0.0</span>
<a name="ln-3839"></a>
<a name="ln-3840"></a><span class="c">!do i = 1,ipar(2)</span>
<a name="ln-3841"></a><span class="c">!    ECPvector((i-1)*ipar(3)+1:i*ipar(3)) = ECPvectorcpy((ipar(2)-i)*ipar(3)+1:(ipar(2)-i+1)*ipar(3))</span>
<a name="ln-3842"></a><span class="c">!end do</span>
<a name="ln-3843"></a>
<a name="ln-3844"></a><span class="n">ECPvector</span> <span class="o">=</span> <span class="n">ECPvector</span><span class="o">**</span><span class="n">fpar</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span>
<a name="ln-3845"></a><span class="n">ECPvector</span> <span class="o">=</span> <span class="n">ECPvector</span><span class="o">/</span><span class="nb">NORM2</span><span class="p">(</span><span class="n">ECPvector</span><span class="p">)</span>
<a name="ln-3846"></a>
<a name="ln-3847"></a><span class="k">if</span><span class="p">(</span><span class="n">IPAR</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span> <span class="p">.</span><span class="n">eq</span><span class="p">.</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-3848"></a><span class="k">    </span><span class="n">F</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="nb">DOT_PRODUCT</span><span class="p">(</span><span class="n">ECPvector</span><span class="p">,</span><span class="n">expt</span><span class="p">)</span>
<a name="ln-3849"></a><span class="k">else</span>
<a name="ln-3850"></a><span class="k">    allocate</span><span class="p">(</span><span class="n">img1</span><span class="p">(</span><span class="n">ipar</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">ipar</span><span class="p">(</span><span class="mi">3</span><span class="p">)),</span><span class="n">img2</span><span class="p">(</span><span class="n">ipar</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">ipar</span><span class="p">(</span><span class="mi">3</span><span class="p">)))</span>
<a name="ln-3851"></a>    <span class="n">ma</span> <span class="o">=</span> <span class="nb">maxval</span><span class="p">(</span><span class="n">ECPvector</span><span class="p">)</span>
<a name="ln-3852"></a>    <span class="n">mi</span> <span class="o">=</span> <span class="nb">minval</span><span class="p">(</span><span class="n">ECPvector</span><span class="p">)</span>
<a name="ln-3853"></a>
<a name="ln-3854"></a>    <span class="n">img1</span> <span class="o">=</span> <span class="nb">nint</span><span class="p">(</span><span class="mi">25</span><span class="mf">5.0</span><span class="o">*</span><span class="p">(</span><span class="n">ECPvector</span> <span class="o">-</span> <span class="n">mi</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">ma</span> <span class="o">-</span> <span class="n">mi</span><span class="p">))</span>
<a name="ln-3855"></a>
<a name="ln-3856"></a>    <span class="n">ma</span> <span class="o">=</span> <span class="nb">maxval</span><span class="p">(</span><span class="n">expt</span><span class="p">)</span>
<a name="ln-3857"></a>    <span class="n">mi</span> <span class="o">=</span> <span class="nb">minval</span><span class="p">(</span><span class="n">expt</span><span class="p">)</span>
<a name="ln-3858"></a>
<a name="ln-3859"></a>    <span class="n">img2</span> <span class="o">=</span> <span class="nb">nint</span><span class="p">(</span><span class="mi">25</span><span class="mf">5.0</span><span class="o">*</span><span class="p">(</span><span class="n">expt</span> <span class="o">-</span> <span class="n">mi</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">ma</span> <span class="o">-</span> <span class="n">mi</span><span class="p">))</span>
<a name="ln-3860"></a>
<a name="ln-3861"></a>    <span class="n">F</span> <span class="o">=</span> <span class="n">Jaccard_Distance</span><span class="p">(</span><span class="n">img1</span><span class="p">,</span><span class="n">img2</span><span class="p">,</span><span class="n">nnx</span><span class="o">*</span><span class="n">nny</span><span class="p">)</span>
<a name="ln-3862"></a>    
<a name="ln-3863"></a><span class="k">end if</span>
<a name="ln-3864"></a>
<a name="ln-3865"></a><span class="k">end subroutine </span><span class="n">ECPcalfun</span>
<a name="ln-3866"></a>
<a name="ln-3867"></a><span class="c">!===================================================================</span>
<a name="ln-3868"></a><span class="c">!===================================================================</span>
<a name="ln-3869"></a><span class="c">! here we start with the Wrapper routines that are actually</span>
<a name="ln-3870"></a><span class="c">! called from another language</span>
<a name="ln-3871"></a><span class="c">!</span>
<a name="ln-3872"></a><span class="c">! Tested languages:  IDL</span>
<a name="ln-3873"></a><span class="c">! To be tested:  Matlab</span>
<a name="ln-3874"></a><span class="c">!===================================================================</span>
<a name="ln-3875"></a><span class="c">!===================================================================</span>
<a name="ln-3876"></a>
<a name="ln-3877"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-3878"></a><span class="c">!</span>
<a name="ln-3879"></a><span class="c">! SUBROUTINE:getEBSDPatternsWrapper</span>
<a name="ln-3880"></a><span class="c">!</span>
<a name="ln-3881"></a><span class="c">!&gt; @author Marc De Graef, Carnegie Mellon University</span>
<a name="ln-3882"></a><span class="c">!</span>
<a name="ln-3883"></a><span class="c">!&gt; @brief wrapper routine for getEBSDPatterns</span>
<a name="ln-3884"></a><span class="c">!&gt;</span>
<a name="ln-3885"></a><span class="c">!&gt; see example at https://groups.google.com/forum/#!topic/comp.lang.idl-pvwave/Gk0xxVFbW8E</span>
<a name="ln-3886"></a><span class="c">!</span>
<a name="ln-3887"></a><span class="c">!&gt; @param argc number of argument</span>
<a name="ln-3888"></a><span class="c">!&gt; @param argv pointers to subroutine parameters</span>
<a name="ln-3889"></a><span class="c">!</span>
<a name="ln-3890"></a><span class="c">!&gt; @date 10/16/15 MDG 1.0 original</span>
<a name="ln-3891"></a><span class="c">!&gt; @date 11/02/15 MDG 1.1 simplified parameters</span>
<a name="ln-3892"></a><span class="c">!&gt; @date 01/12/16 MDG 1.2 added dummy arguments for progress callback and cancel handling</span>
<a name="ln-3893"></a><span class="c">!&gt; @date 01/13/16 MDG 1.3 removed dummy arguments for progress callback and cancel handling</span>
<a name="ln-3894"></a><span class="c">!&gt; @date 07/10/16 MDG 1.4 added energy min/max indices</span>
<a name="ln-3895"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-3896"></a><span class="k">recursive function </span><span class="n">getEBSDPatternsWrapper</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">)</span> <span class="k">bind</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;getEBSDPatternsWrapper&#39;</span><span class="p">)</span> 
<a name="ln-3897"></a><span class="c">!DEC$ ATTRIBUTES DLLEXPORT :: getEBSDPatternsWrapper</span>
<a name="ln-3898"></a>
<a name="ln-3899"></a><span class="k">use</span><span class="p">,</span><span class="k">INTRINSIC</span> <span class="kd">::</span> <span class="nb">ISO_C_BINDING</span>
<a name="ln-3900"></a>
<a name="ln-3901"></a><span class="k">IMPLICIT NONE</span>
<a name="ln-3902"></a>
<a name="ln-3903"></a><span class="kt">INTEGER</span><span class="p">(</span><span class="kt">c_size_t</span><span class="p">),</span> <span class="k">VALUE</span><span class="p">,</span> <span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>            <span class="kd">::</span> <span class="n">argc</span> 
<a name="ln-3904"></a><span class="k">type</span><span class="p">(</span><span class="kt">c_ptr</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="n">argc</span><span class="p">),</span> <span class="k">INTENT</span><span class="p">(</span><span class="n">INOUT</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">argv</span>
<a name="ln-3905"></a><span class="kt">REAL</span><span class="p">(</span><span class="kt">c_float</span><span class="p">)</span>                                   <span class="kd">::</span> <span class="n">getEBSDPatternsWrapper</span>
<a name="ln-3906"></a>
<a name="ln-3907"></a><span class="c">! wrapper function dependent declarations; they are all pointers </span>
<a name="ln-3908"></a><span class="c">! since we pass everything by reference from IDL </span>
<a name="ln-3909"></a><span class="kt">integer</span><span class="p">(</span><span class="kt">c_size_t</span><span class="p">)</span>                               <span class="kd">::</span> <span class="n">nipar</span><span class="p">,</span> <span class="n">nfpar</span><span class="p">,</span> <span class="n">nq</span>
<a name="ln-3910"></a><span class="kt">integer</span><span class="p">(</span><span class="kt">c_size_t</span><span class="p">),</span><span class="k">dimension</span><span class="p">(:),</span> <span class="k">pointer</span>         <span class="kd">::</span> <span class="n">ipar</span>
<a name="ln-3911"></a><span class="kt">real</span><span class="p">(</span><span class="kt">c_float</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(:),</span> <span class="k">pointer</span>            <span class="kd">::</span> <span class="n">fpar</span>
<a name="ln-3912"></a><span class="kt">real</span><span class="p">(</span><span class="kt">c_float</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(:,:),</span> <span class="k">pointer</span>          <span class="kd">::</span> <span class="n">quats</span>
<a name="ln-3913"></a><span class="kt">real</span><span class="p">(</span><span class="kt">c_float</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(:,:,:),</span> <span class="k">pointer</span>        <span class="kd">::</span> <span class="n">EBSDpattern</span><span class="p">,</span> <span class="n">accum_e</span> 
<a name="ln-3914"></a><span class="kt">real</span><span class="p">(</span><span class="kt">c_float</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(:,:,:,:),</span><span class="k">pointer</span>       <span class="kd">::</span> <span class="n">mLPNH</span><span class="p">,</span> <span class="n">mLPSH</span>
<a name="ln-3915"></a>
<a name="ln-3916"></a><span class="c">! the following line just helps in identifying the correct order of the subroutine arguments...</span>
<a name="ln-3917"></a><span class="c">!                             1      2      3           4         5       6     7</span>
<a name="ln-3918"></a><span class="c">!subroutine getEBSDPatterns(ipar, fpar, EBSDpattern, quats, accum_e, mLPNH, mLPSH)</span>
<a name="ln-3919"></a><span class="c">!</span>
<a name="ln-3920"></a><span class="c">! transform the C pointers above to fortran pointers, and use them in the regular function call</span>
<a name="ln-3921"></a><span class="n">nipar</span> <span class="o">=</span> <span class="mi">10</span>
<a name="ln-3922"></a><span class="n">nfpar</span> <span class="o">=</span> <span class="mi">10</span>
<a name="ln-3923"></a><span class="n">nq</span> <span class="o">=</span> <span class="mi">4</span>
<a name="ln-3924"></a>
<a name="ln-3925"></a><span class="k">call </span><span class="nb">c_f_pointer</span><span class="p">(</span><span class="n">argv</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="n">ipar</span><span class="p">,(</span><span class="o">/</span><span class="n">nipar</span><span class="o">/</span><span class="p">))</span> 
<a name="ln-3926"></a><span class="k">call </span><span class="nb">c_f_pointer</span><span class="p">(</span><span class="n">argv</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span><span class="n">fpar</span><span class="p">,(</span><span class="o">/</span><span class="n">nfpar</span><span class="o">/</span><span class="p">))</span> 
<a name="ln-3927"></a><span class="k">call </span><span class="nb">c_f_pointer</span><span class="p">(</span><span class="n">argv</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span><span class="n">EBSDpattern</span><span class="p">,(</span><span class="o">/</span><span class="n">ipar</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span><span class="n">ipar</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span><span class="n">ipar</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="o">/</span><span class="p">))</span>
<a name="ln-3928"></a><span class="k">call </span><span class="nb">c_f_pointer</span><span class="p">(</span><span class="n">argv</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span><span class="n">quats</span><span class="p">,(</span><span class="o">/</span><span class="n">nq</span><span class="p">,</span><span class="n">ipar</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="o">/</span><span class="p">))</span>
<a name="ln-3929"></a><span class="k">call </span><span class="nb">c_f_pointer</span><span class="p">(</span><span class="n">argv</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span><span class="n">accum_e</span><span class="p">,(</span><span class="o">/</span><span class="n">ipar</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span><span class="mi">2</span><span class="o">*</span><span class="n">ipar</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="n">ipar</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="o">/</span><span class="p">))</span>
<a name="ln-3930"></a><span class="k">call </span><span class="nb">c_f_pointer</span><span class="p">(</span><span class="n">argv</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span><span class="n">mLPNH</span><span class="p">,(</span><span class="o">/</span><span class="mi">2</span><span class="o">*</span><span class="n">ipar</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">ipar</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">ipar</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="n">ipar</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span><span class="o">/</span><span class="p">))</span>
<a name="ln-3931"></a><span class="k">call </span><span class="nb">c_f_pointer</span><span class="p">(</span><span class="n">argv</span><span class="p">(</span><span class="mi">7</span><span class="p">),</span><span class="n">mLPSH</span><span class="p">,(</span><span class="o">/</span><span class="mi">2</span><span class="o">*</span><span class="n">ipar</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">ipar</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">ipar</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="n">ipar</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span><span class="o">/</span><span class="p">))</span>
<a name="ln-3932"></a>
<a name="ln-3933"></a><span class="k">call </span><span class="n">getEBSDPatterns</span><span class="p">(</span><span class="n">ipar</span><span class="p">,</span> <span class="n">fpar</span><span class="p">,</span> <span class="n">EBSDpattern</span><span class="p">,</span> <span class="n">quats</span><span class="p">,</span> <span class="n">accum_e</span><span class="p">,</span> <span class="n">mLPNH</span><span class="p">,</span> <span class="n">mLPSH</span><span class="p">)</span>
<a name="ln-3934"></a>
<a name="ln-3935"></a><span class="n">getEBSDPatternsWrapper</span> <span class="o">=</span> <span class="mf">1._c_float</span>
<a name="ln-3936"></a><span class="k">end function </span><span class="n">getEBSDPatternsWrapper</span>
<a name="ln-3937"></a>
<a name="ln-3938"></a>
<a name="ln-3939"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-3940"></a><span class="c">!</span>
<a name="ln-3941"></a><span class="c">! SUBROUTINE:getECPatternsWrapper</span>
<a name="ln-3942"></a><span class="c">!</span>
<a name="ln-3943"></a><span class="c">!&gt; @author Saransh Singh, Carnegie Mellon University</span>
<a name="ln-3944"></a><span class="c">!</span>
<a name="ln-3945"></a><span class="c">!&gt; @brief wrapper routine for SingleECPPattern; based on Marc&#39;s routine above</span>
<a name="ln-3946"></a><span class="c">!&gt;</span>
<a name="ln-3947"></a><span class="c">!&gt; see https://groups.google.com/forum/#!topic/comp.lang.idl-pvwave/Gk0xxVFbW8E</span>
<a name="ln-3948"></a><span class="c">!&gt;</span>
<a name="ln-3949"></a><span class="c">!</span>
<a name="ln-3950"></a><span class="c">!&gt; @param argc number of argument</span>
<a name="ln-3951"></a><span class="c">!&gt; @param argv pointers to subroutine parameters</span>
<a name="ln-3952"></a><span class="c">!</span>
<a name="ln-3953"></a><span class="c">!&gt; @date 10/28/15  SS 1.0 original</span>
<a name="ln-3954"></a><span class="c">!&gt; @date 11/02/15 MDG 1.1 simplified parameters</span>
<a name="ln-3955"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-3956"></a><span class="k">recursive function </span><span class="n">getECPatternsWrapper</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">)</span> <span class="k">bind</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;getECPatternsWrapper&#39;</span><span class="p">)</span> 
<a name="ln-3957"></a><span class="c">!DEC$ ATTRIBUTES DLLEXPORT :: getECPatternsWrapper</span>
<a name="ln-3958"></a>
<a name="ln-3959"></a><span class="k">use</span><span class="p">,</span><span class="k">INTRINSIC</span> <span class="kd">::</span> <span class="nb">ISO_C_BINDING</span>
<a name="ln-3960"></a>
<a name="ln-3961"></a><span class="k">IMPLICIT NONE</span>
<a name="ln-3962"></a>
<a name="ln-3963"></a><span class="kt">INTEGER</span><span class="p">(</span><span class="kt">c_size_t</span><span class="p">),</span> <span class="k">VALUE</span><span class="p">,</span> <span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>            <span class="kd">::</span> <span class="n">argc</span> 
<a name="ln-3964"></a><span class="k">type</span><span class="p">(</span><span class="kt">c_ptr</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="n">argc</span><span class="p">),</span> <span class="k">INTENT</span><span class="p">(</span><span class="n">INOUT</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">argv</span>
<a name="ln-3965"></a><span class="kt">REAL</span><span class="p">(</span><span class="kt">c_float</span><span class="p">)</span>                                   <span class="kd">::</span> <span class="n">getECPatternsWrapper</span>
<a name="ln-3966"></a>
<a name="ln-3967"></a><span class="c">! wrapper function dependent declarations; they are all pointers </span>
<a name="ln-3968"></a><span class="c">! since we pass everything by reference from IDL </span>
<a name="ln-3969"></a><span class="kt">integer</span><span class="p">(</span><span class="kt">c_size_t</span><span class="p">)</span>                               <span class="kd">::</span> <span class="n">nipar</span><span class="p">,</span> <span class="n">nfpar</span><span class="p">,</span> <span class="n">nq</span>
<a name="ln-3970"></a><span class="kt">integer</span><span class="p">(</span><span class="kt">c_size_t</span><span class="p">),</span><span class="k">dimension</span><span class="p">(:),</span> <span class="k">pointer</span>         <span class="kd">::</span> <span class="n">ipar</span>
<a name="ln-3971"></a><span class="kt">real</span><span class="p">(</span><span class="kt">c_float</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(:),</span> <span class="k">pointer</span>            <span class="kd">::</span> <span class="n">fpar</span>
<a name="ln-3972"></a><span class="kt">real</span><span class="p">(</span><span class="kt">c_float</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(:,:,:),</span> <span class="k">pointer</span>        <span class="kd">::</span> <span class="n">accum_e</span><span class="p">,</span> <span class="n">mLPNH</span><span class="p">,</span> <span class="n">mLPSH</span><span class="p">,</span> <span class="n">ECPattern</span>
<a name="ln-3973"></a><span class="kt">real</span><span class="p">(</span><span class="kt">c_float</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(:,:),</span> <span class="k">pointer</span>          <span class="kd">::</span> <span class="n">quats</span>
<a name="ln-3974"></a>
<a name="ln-3975"></a><span class="c">! the following line just helps in identifying the correct order of the subroutine arguments...</span>
<a name="ln-3976"></a><span class="c">!                             1      2     3       4       5       6       7</span>
<a name="ln-3977"></a><span class="c">!subroutine getECPatterns(ipar, fpar, ECPattern, quats, accum_e, mLPNH, mLPSH)</span>
<a name="ln-3978"></a><span class="c">!</span>
<a name="ln-3979"></a><span class="c">! transform the C pointers above to fortran pointers, and use them in the regular function call</span>
<a name="ln-3980"></a><span class="n">nipar</span> <span class="o">=</span> <span class="mi">8</span>
<a name="ln-3981"></a><span class="n">nfpar</span> <span class="o">=</span> <span class="mi">8</span>
<a name="ln-3982"></a><span class="n">nq</span> <span class="o">=</span> <span class="mi">4</span>
<a name="ln-3983"></a><span class="k">call </span><span class="nb">c_f_pointer</span><span class="p">(</span><span class="n">argv</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="n">ipar</span><span class="p">,(</span><span class="o">/</span><span class="n">nipar</span><span class="o">/</span><span class="p">))</span> 
<a name="ln-3984"></a><span class="k">call </span><span class="nb">c_f_pointer</span><span class="p">(</span><span class="n">argv</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span><span class="n">fpar</span><span class="p">,(</span><span class="o">/</span><span class="n">nfpar</span><span class="o">/</span><span class="p">))</span> 
<a name="ln-3985"></a><span class="k">call </span><span class="nb">c_f_pointer</span><span class="p">(</span><span class="n">argv</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span><span class="n">ECpattern</span><span class="p">,(</span><span class="o">/</span><span class="n">ipar</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span><span class="n">ipar</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span><span class="n">ipar</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="o">/</span><span class="p">))</span>
<a name="ln-3986"></a><span class="k">call </span><span class="nb">c_f_pointer</span><span class="p">(</span><span class="n">argv</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span><span class="n">quats</span><span class="p">,(</span><span class="o">/</span><span class="n">nq</span><span class="p">,</span><span class="n">ipar</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="o">/</span><span class="p">))</span>
<a name="ln-3987"></a><span class="k">call </span><span class="nb">c_f_pointer</span><span class="p">(</span><span class="n">argv</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span><span class="n">accum_e</span><span class="p">,(</span><span class="o">/</span><span class="n">ipar</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span><span class="mi">2</span><span class="o">*</span><span class="n">ipar</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="n">ipar</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="o">/</span><span class="p">))</span>
<a name="ln-3988"></a><span class="k">call </span><span class="nb">c_f_pointer</span><span class="p">(</span><span class="n">argv</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span><span class="n">mLPNH</span><span class="p">,(</span><span class="o">/</span><span class="mi">2</span><span class="o">*</span><span class="n">ipar</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">ipar</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">ipar</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span><span class="o">/</span><span class="p">))</span>
<a name="ln-3989"></a><span class="k">call </span><span class="nb">c_f_pointer</span><span class="p">(</span><span class="n">argv</span><span class="p">(</span><span class="mi">7</span><span class="p">),</span><span class="n">mLPSH</span><span class="p">,(</span><span class="o">/</span><span class="mi">2</span><span class="o">*</span><span class="n">ipar</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">ipar</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">ipar</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span><span class="o">/</span><span class="p">))</span>
<a name="ln-3990"></a>
<a name="ln-3991"></a><span class="k">call </span><span class="n">getECPatterns</span><span class="p">(</span><span class="n">ipar</span><span class="p">,</span> <span class="n">fpar</span><span class="p">,</span> <span class="n">ECpattern</span><span class="p">,</span> <span class="n">quats</span><span class="p">,</span> <span class="n">accum_e</span><span class="p">,</span> <span class="n">mLPNH</span><span class="p">,</span> <span class="n">mLPSH</span><span class="p">)</span>
<a name="ln-3992"></a>
<a name="ln-3993"></a><span class="n">getECPatternsWrapper</span> <span class="o">=</span> <span class="mf">1._c_float</span>
<a name="ln-3994"></a><span class="k">end function </span><span class="n">getECPatternsWrapper</span>
<a name="ln-3995"></a>
<a name="ln-3996"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-3997"></a><span class="c">!</span>
<a name="ln-3998"></a><span class="c">! SUBROUTINE: getKosselPatternsWrapper</span>
<a name="ln-3999"></a><span class="c">!</span>
<a name="ln-4000"></a><span class="c">!&gt; @author Marc De Graef, Carnegie Mellon University</span>
<a name="ln-4001"></a><span class="c">!</span>
<a name="ln-4002"></a><span class="c">!&gt; @brief wrapper routine for SingleKosselPattern; nearly identical to ECP case</span>
<a name="ln-4003"></a><span class="c">!&gt;</span>
<a name="ln-4004"></a><span class="c">!&gt; see https://groups.google.com/forum/#!topic/comp.lang.idl-pvwave/Gk0xxVFbW8E</span>
<a name="ln-4005"></a><span class="c">!</span>
<a name="ln-4006"></a><span class="c">!&gt; @param argc number of argument</span>
<a name="ln-4007"></a><span class="c">!&gt; @param argv pointers to subroutine parameters</span>
<a name="ln-4008"></a><span class="c">!</span>
<a name="ln-4009"></a><span class="c">!&gt; @date 11/09/15 MDG 1.0 first version</span>
<a name="ln-4010"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-4011"></a><span class="k">recursive function </span><span class="n">getKosselPatternsWrapper</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">)</span> <span class="k">bind</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;getKosselPatternsWrapper&#39;</span><span class="p">)</span> 
<a name="ln-4012"></a><span class="c">!DEC$ ATTRIBUTES DLLEXPORT :: getKosselPatternsWrapper</span>
<a name="ln-4013"></a>
<a name="ln-4014"></a><span class="k">use</span><span class="p">,</span><span class="k">INTRINSIC</span> <span class="kd">::</span> <span class="nb">ISO_C_BINDING</span>
<a name="ln-4015"></a>
<a name="ln-4016"></a><span class="k">IMPLICIT NONE</span>
<a name="ln-4017"></a>
<a name="ln-4018"></a><span class="kt">INTEGER</span><span class="p">(</span><span class="kt">c_size_t</span><span class="p">),</span> <span class="k">VALUE</span><span class="p">,</span> <span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>            <span class="kd">::</span> <span class="n">argc</span> 
<a name="ln-4019"></a><span class="k">type</span><span class="p">(</span><span class="kt">c_ptr</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="n">argc</span><span class="p">),</span> <span class="k">INTENT</span><span class="p">(</span><span class="n">INOUT</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">argv</span>
<a name="ln-4020"></a><span class="kt">REAL</span><span class="p">(</span><span class="kt">c_float</span><span class="p">)</span>                                   <span class="kd">::</span> <span class="n">getKosselPatternsWrapper</span>
<a name="ln-4021"></a>
<a name="ln-4022"></a><span class="c">! wrapper function dependent declarations; they are all pointers </span>
<a name="ln-4023"></a><span class="c">! since we pass everything by reference from IDL </span>
<a name="ln-4024"></a><span class="kt">integer</span><span class="p">(</span><span class="kt">c_size_t</span><span class="p">)</span>                               <span class="kd">::</span> <span class="n">nipar</span><span class="p">,</span> <span class="n">nfpar</span><span class="p">,</span> <span class="n">nq</span>
<a name="ln-4025"></a><span class="kt">integer</span><span class="p">(</span><span class="kt">c_size_t</span><span class="p">),</span><span class="k">dimension</span><span class="p">(:),</span> <span class="k">pointer</span>         <span class="kd">::</span> <span class="n">ipar</span>
<a name="ln-4026"></a><span class="kt">real</span><span class="p">(</span><span class="kt">c_float</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(:),</span> <span class="k">pointer</span>            <span class="kd">::</span> <span class="n">fpar</span>
<a name="ln-4027"></a><span class="kt">real</span><span class="p">(</span><span class="kt">c_float</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(:,:),</span> <span class="k">pointer</span>          <span class="kd">::</span> <span class="n">quats</span>
<a name="ln-4028"></a><span class="kt">real</span><span class="p">(</span><span class="kt">c_float</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(:,:,:),</span> <span class="k">pointer</span>        <span class="kd">::</span> <span class="n">KosselPattern</span><span class="p">,</span> <span class="n">mLPNH</span><span class="p">,</span> <span class="n">mLPSH</span>
<a name="ln-4029"></a>
<a name="ln-4030"></a><span class="c">! the following line just helps in identifying the correct order of the subroutine arguments...</span>
<a name="ln-4031"></a><span class="c">!                             1      2     3             4       5       6</span>
<a name="ln-4032"></a><span class="c">!subroutine getKosselPatterns(ipar, fpar, KosselPattern, quats, mLPNH, mLPSH)</span>
<a name="ln-4033"></a><span class="c">!</span>
<a name="ln-4034"></a><span class="c">! transform the C pointers above to fortran pointers, and use them in the regular function call</span>
<a name="ln-4035"></a><span class="n">nipar</span> <span class="o">=</span> <span class="mi">6</span>
<a name="ln-4036"></a><span class="n">nfpar</span> <span class="o">=</span> <span class="mi">1</span>
<a name="ln-4037"></a><span class="n">nq</span> <span class="o">=</span> <span class="mi">4</span>
<a name="ln-4038"></a><span class="k">call </span><span class="nb">c_f_pointer</span><span class="p">(</span><span class="n">argv</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="n">ipar</span><span class="p">,(</span><span class="o">/</span><span class="n">nipar</span><span class="o">/</span><span class="p">))</span> 
<a name="ln-4039"></a><span class="k">call </span><span class="nb">c_f_pointer</span><span class="p">(</span><span class="n">argv</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span><span class="n">fpar</span><span class="p">,(</span><span class="o">/</span><span class="n">nfpar</span><span class="o">/</span><span class="p">))</span> 
<a name="ln-4040"></a><span class="k">call </span><span class="nb">c_f_pointer</span><span class="p">(</span><span class="n">argv</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span><span class="n">Kosselpattern</span><span class="p">,(</span><span class="o">/</span><span class="n">ipar</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span><span class="n">ipar</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span><span class="n">ipar</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">/</span><span class="p">))</span>
<a name="ln-4041"></a><span class="k">call </span><span class="nb">c_f_pointer</span><span class="p">(</span><span class="n">argv</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span><span class="n">quats</span><span class="p">,(</span><span class="o">/</span><span class="n">nq</span><span class="p">,</span><span class="n">ipar</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">/</span><span class="p">))</span>
<a name="ln-4042"></a><span class="k">call </span><span class="nb">c_f_pointer</span><span class="p">(</span><span class="n">argv</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span><span class="n">mLPNH</span><span class="p">,(</span><span class="o">/</span><span class="mi">2</span><span class="o">*</span><span class="n">ipar</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">ipar</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">ipar</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">/</span><span class="p">))</span>
<a name="ln-4043"></a><span class="k">call </span><span class="nb">c_f_pointer</span><span class="p">(</span><span class="n">argv</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span><span class="n">mLPSH</span><span class="p">,(</span><span class="o">/</span><span class="mi">2</span><span class="o">*</span><span class="n">ipar</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">ipar</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">ipar</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">/</span><span class="p">))</span>
<a name="ln-4044"></a>
<a name="ln-4045"></a><span class="k">call </span><span class="n">getKosselPatterns</span><span class="p">(</span><span class="n">ipar</span><span class="p">,</span> <span class="n">fpar</span><span class="p">,</span> <span class="n">Kosselpattern</span><span class="p">,</span> <span class="n">quats</span><span class="p">,</span> <span class="n">mLPNH</span><span class="p">,</span> <span class="n">mLPSH</span><span class="p">)</span>
<a name="ln-4046"></a>
<a name="ln-4047"></a><span class="n">getKosselPatternsWrapper</span> <span class="o">=</span> <span class="mf">1._c_float</span>
<a name="ln-4048"></a><span class="k">end function </span><span class="n">getKosselPatternsWrapper</span>
<a name="ln-4049"></a>
<a name="ln-4050"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-4051"></a><span class="c">!</span>
<a name="ln-4052"></a><span class="c">! SUBROUTINE:efitECPWrapper</span>
<a name="ln-4053"></a><span class="c">!</span>
<a name="ln-4054"></a><span class="c">!&gt; @author Saransh Singh, Carnegie Mellon University</span>
<a name="ln-4055"></a><span class="c">!</span>
<a name="ln-4056"></a><span class="c">!&gt; @brief wrapper routine for fitting ECP pattern</span>
<a name="ln-4057"></a><span class="c">!&gt;</span>
<a name="ln-4058"></a><span class="c">!&gt; see https://groups.google.com/forum/#!topic/comp.lang.idl-pvwave/Gk0xxVFbW8E</span>
<a name="ln-4059"></a><span class="c">!&gt;</span>
<a name="ln-4060"></a><span class="c">!</span>
<a name="ln-4061"></a><span class="c">!&gt; @param argc number of argument</span>
<a name="ln-4062"></a><span class="c">!&gt; @param argv pointers to subroutine parameters</span>
<a name="ln-4063"></a><span class="c">!</span>
<a name="ln-4064"></a><span class="c">!&gt; @date 12/15/15  SS 1.0 original</span>
<a name="ln-4065"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-4066"></a><span class="k">recursive function </span><span class="n">efitECPWrapper</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">)</span> <span class="k">bind</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;efitECPWrapper&#39;</span><span class="p">)</span> 
<a name="ln-4067"></a><span class="c">!DEC$ ATTRIBUTES DLLEXPORT :: efitECPWrapper</span>
<a name="ln-4068"></a>
<a name="ln-4069"></a><span class="k">use</span><span class="p">,</span><span class="k">INTRINSIC</span> <span class="kd">::</span> <span class="nb">ISO_C_BINDING</span>
<a name="ln-4070"></a><span class="c">! use bobyqa_module</span>
<a name="ln-4071"></a><span class="k">use </span><span class="n">local</span>
<a name="ln-4072"></a>
<a name="ln-4073"></a><span class="k">IMPLICIT NONE</span>
<a name="ln-4074"></a>
<a name="ln-4075"></a><span class="kt">INTEGER</span><span class="p">(</span><span class="kt">c_size_t</span><span class="p">),</span> <span class="k">VALUE</span><span class="p">,</span> <span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>            <span class="kd">::</span> <span class="n">argc</span> 
<a name="ln-4076"></a><span class="k">type</span><span class="p">(</span><span class="kt">c_ptr</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="n">argc</span><span class="p">),</span> <span class="k">INTENT</span><span class="p">(</span><span class="n">INOUT</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">argv</span>
<a name="ln-4077"></a><span class="kt">REAL</span><span class="p">(</span><span class="kt">c_float</span><span class="p">)</span>                                   <span class="kd">::</span> <span class="n">efitECPWrapper</span>
<a name="ln-4078"></a>
<a name="ln-4079"></a><span class="c">! wrapper function dependent declarations; they are all pointers </span>
<a name="ln-4080"></a><span class="c">! since we pass everything by reference from IDL </span>
<a name="ln-4081"></a><span class="kt">integer</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>                                      <span class="kd">::</span> <span class="n">nipar</span><span class="p">,</span> <span class="n">nfpar</span><span class="p">,</span> <span class="n">ninit</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">iprint</span><span class="p">,</span> <span class="n">maxfun</span><span class="p">,</span> <span class="n">npt</span>
<a name="ln-4082"></a><span class="kt">real</span><span class="p">(</span><span class="kt">c_double</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(:),</span> <span class="k">pointer</span>           <span class="kd">::</span> <span class="n">rhobeg</span><span class="p">,</span> <span class="n">rhoend</span>
<a name="ln-4083"></a><span class="kt">integer</span><span class="p">(</span><span class="kt">c_size_t</span><span class="p">),</span><span class="k">dimension</span><span class="p">(:),</span> <span class="k">pointer</span>         <span class="kd">::</span> <span class="n">ipar</span>
<a name="ln-4084"></a><span class="kt">real</span><span class="p">(</span><span class="kt">c_float</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(:),</span> <span class="k">pointer</span>            <span class="kd">::</span> <span class="n">fpar</span>
<a name="ln-4085"></a><span class="kt">real</span><span class="p">(</span><span class="kt">c_float</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(:),</span> <span class="k">pointer</span>            <span class="kd">::</span> <span class="n">initmeanval</span>
<a name="ln-4086"></a><span class="kt">real</span><span class="p">(</span><span class="kt">c_float</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(:),</span> <span class="k">pointer</span>            <span class="kd">::</span> <span class="n">expt</span>
<a name="ln-4087"></a><span class="kt">real</span><span class="p">(</span><span class="kt">c_float</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(:,:,:),</span> <span class="k">pointer</span>        <span class="kd">::</span> <span class="n">accum_e</span>
<a name="ln-4088"></a><span class="kt">real</span><span class="p">(</span><span class="kt">c_float</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(:,:,:,:),</span> <span class="k">pointer</span>      <span class="kd">::</span> <span class="n">mLPNH</span>
<a name="ln-4089"></a><span class="kt">real</span><span class="p">(</span><span class="kt">c_float</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(:,:,:,:),</span> <span class="k">pointer</span>      <span class="kd">::</span> <span class="n">mLPSH</span>
<a name="ln-4090"></a><span class="kt">real</span><span class="p">(</span><span class="kt">c_double</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(:),</span> <span class="k">pointer</span>           <span class="kd">::</span> <span class="n">X</span>
<a name="ln-4091"></a><span class="kt">real</span><span class="p">(</span><span class="kt">c_double</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(:),</span> <span class="k">pointer</span>           <span class="kd">::</span> <span class="n">XL</span>
<a name="ln-4092"></a><span class="kt">real</span><span class="p">(</span><span class="kt">c_double</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(:),</span> <span class="k">pointer</span>           <span class="kd">::</span> <span class="n">XU</span>
<a name="ln-4093"></a>
<a name="ln-4094"></a>
<a name="ln-4095"></a><span class="c">! the following line just helps in identifying the correct order of the subroutine arguments...</span>
<a name="ln-4096"></a><span class="c">!                                        </span>
<a name="ln-4097"></a><span class="c">!subroutine BOBYQA(nipar, nfpar, ninit, ipar, fpar, initmeanval, expt, N, NPT, X, XL, XU, RHOBEG, RHOEND, IPRINT, MAXFUN, ECPCALFUN, ACCUM_E, mLPNH, mLPSH)</span>
<a name="ln-4098"></a><span class="c">!</span>
<a name="ln-4099"></a><span class="c">! transform the C pointers above to fortran pointers, and use them in the regular function call</span>
<a name="ln-4100"></a><span class="n">nipar</span> <span class="o">=</span> <span class="mi">9</span>
<a name="ln-4101"></a><span class="n">nfpar</span> <span class="o">=</span> <span class="mi">10</span>
<a name="ln-4102"></a><span class="n">ninit</span> <span class="o">=</span> <span class="mi">6</span>
<a name="ln-4103"></a><span class="n">n</span> <span class="o">=</span> <span class="mi">6</span>
<a name="ln-4104"></a><span class="n">iprint</span> <span class="o">=</span> <span class="mi">2</span>
<a name="ln-4105"></a><span class="n">maxfun</span> <span class="o">=</span> <span class="mi">10000</span>
<a name="ln-4106"></a><span class="n">npt</span> <span class="o">=</span> <span class="n">n</span> <span class="o">+</span> <span class="mi">6</span>
<a name="ln-4107"></a>
<a name="ln-4108"></a><span class="k">call </span><span class="nb">c_f_pointer</span><span class="p">(</span><span class="n">argv</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="n">ipar</span><span class="p">,(</span><span class="o">/</span><span class="n">nipar</span><span class="o">/</span><span class="p">))</span> 
<a name="ln-4109"></a><span class="k">call </span><span class="nb">c_f_pointer</span><span class="p">(</span><span class="n">argv</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span><span class="n">fpar</span><span class="p">,(</span><span class="o">/</span><span class="n">nfpar</span><span class="o">/</span><span class="p">))</span> 
<a name="ln-4110"></a><span class="k">call </span><span class="nb">c_f_pointer</span><span class="p">(</span><span class="n">argv</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span><span class="n">initmeanval</span><span class="p">,(</span><span class="o">/</span><span class="n">n</span><span class="o">/</span><span class="p">))</span>
<a name="ln-4111"></a><span class="k">call </span><span class="nb">c_f_pointer</span><span class="p">(</span><span class="n">argv</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span><span class="n">expt</span><span class="p">,(</span><span class="o">/</span><span class="n">ipar</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">ipar</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">/</span><span class="p">))</span>
<a name="ln-4112"></a><span class="k">call </span><span class="nb">c_f_pointer</span><span class="p">(</span><span class="n">argv</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span><span class="n">X</span><span class="p">,(</span><span class="o">/</span><span class="n">n</span><span class="o">/</span><span class="p">))</span>
<a name="ln-4113"></a><span class="k">call </span><span class="nb">c_f_pointer</span><span class="p">(</span><span class="n">argv</span><span class="p">(</span><span class="mi">7</span><span class="p">),</span><span class="n">XL</span><span class="p">,(</span><span class="o">/</span><span class="n">n</span><span class="o">/</span><span class="p">))</span>
<a name="ln-4114"></a><span class="k">call </span><span class="nb">c_f_pointer</span><span class="p">(</span><span class="n">argv</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="n">XU</span><span class="p">,(</span><span class="o">/</span><span class="n">n</span><span class="o">/</span><span class="p">))</span>
<a name="ln-4115"></a><span class="k">call </span><span class="nb">c_f_pointer</span><span class="p">(</span><span class="n">argv</span><span class="p">(</span><span class="mi">9</span><span class="p">),</span><span class="n">RHOBEG</span><span class="p">,(</span><span class="o">/</span><span class="mi">1</span><span class="o">/</span><span class="p">))</span>
<a name="ln-4116"></a><span class="k">call </span><span class="nb">c_f_pointer</span><span class="p">(</span><span class="n">argv</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span><span class="n">RHOEND</span><span class="p">,(</span><span class="o">/</span><span class="mi">1</span><span class="o">/</span><span class="p">))</span>
<a name="ln-4117"></a><span class="k">call </span><span class="nb">c_f_pointer</span><span class="p">(</span><span class="n">argv</span><span class="p">(</span><span class="mi">11</span><span class="p">),</span><span class="n">accum_e</span><span class="p">,(</span><span class="o">/</span><span class="n">ipar</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span><span class="mi">2</span><span class="o">*</span><span class="n">ipar</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="n">ipar</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="o">/</span><span class="p">))</span>
<a name="ln-4118"></a><span class="k">call </span><span class="nb">c_f_pointer</span><span class="p">(</span><span class="n">argv</span><span class="p">(</span><span class="mi">12</span><span class="p">),</span><span class="n">mLPNH</span><span class="p">,(</span><span class="o">/</span><span class="mi">2</span><span class="o">*</span><span class="n">ipar</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">ipar</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">ipar</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="n">ipar</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span><span class="o">/</span><span class="p">))</span>
<a name="ln-4119"></a><span class="k">call </span><span class="nb">c_f_pointer</span><span class="p">(</span><span class="n">argv</span><span class="p">(</span><span class="mi">13</span><span class="p">),</span><span class="n">mLPSH</span><span class="p">,(</span><span class="o">/</span><span class="mi">2</span><span class="o">*</span><span class="n">ipar</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">ipar</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">ipar</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="n">ipar</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span><span class="o">/</span><span class="p">))</span>
<a name="ln-4120"></a>
<a name="ln-4121"></a><span class="c">! call BOBYQA(NIPAR, NFPAR, NINIT, IPAR, FPAR, INITMEANVAL, EXPT, N, NPT, X, XL, XU, RHOBEG(1), RHOEND(1),&amp;</span>
<a name="ln-4122"></a><span class="c">!      IPRINT, MAXFUN, ECPCALFUN, accum_e, mLPNH, mLPSH)</span>
<a name="ln-4123"></a>
<a name="ln-4124"></a><span class="n">efitECPWrapper</span> <span class="o">=</span> <span class="mf">1._c_float</span>
<a name="ln-4125"></a>
<a name="ln-4126"></a><span class="k">end function </span><span class="n">efitECPWrapper</span>
<a name="ln-4127"></a>
<a name="ln-4128"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-4129"></a><span class="c">!</span>
<a name="ln-4130"></a><span class="c">! SUBROUTINE:efitEBSDWrapper</span>
<a name="ln-4131"></a><span class="c">!</span>
<a name="ln-4132"></a><span class="c">!&gt; @author Saransh Singh, Carnegie Mellon University</span>
<a name="ln-4133"></a><span class="c">!</span>
<a name="ln-4134"></a><span class="c">!&gt; @brief wrapper routine for fitting EBSD pattern</span>
<a name="ln-4135"></a><span class="c">!&gt;</span>
<a name="ln-4136"></a><span class="c">!&gt; see https://groups.google.com/forum/#!topic/comp.lang.idl-pvwave/Gk0xxVFbW8E</span>
<a name="ln-4137"></a><span class="c">!&gt;</span>
<a name="ln-4138"></a><span class="c">!</span>
<a name="ln-4139"></a><span class="c">!&gt; @param argc number of argument</span>
<a name="ln-4140"></a><span class="c">!&gt; @param argv pointers to subroutine parameters</span>
<a name="ln-4141"></a><span class="c">!</span>
<a name="ln-4142"></a><span class="c">!&gt; @date 12/15/15  SS 1.0 original</span>
<a name="ln-4143"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-4144"></a><span class="k">recursive function </span><span class="n">efitEBSDWrapper</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">)</span> <span class="k">bind</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;efitEBSDWrapper&#39;</span><span class="p">)</span> 
<a name="ln-4145"></a><span class="c">!DEC$ ATTRIBUTES DLLEXPORT :: efitEBSDWrapper</span>
<a name="ln-4146"></a>
<a name="ln-4147"></a><span class="k">use</span><span class="p">,</span><span class="k">INTRINSIC</span> <span class="kd">::</span> <span class="nb">ISO_C_BINDING</span>
<a name="ln-4148"></a><span class="c">!use bobyqa_module</span>
<a name="ln-4149"></a><span class="k">use </span><span class="n">local</span>
<a name="ln-4150"></a>
<a name="ln-4151"></a><span class="k">IMPLICIT NONE</span>
<a name="ln-4152"></a>
<a name="ln-4153"></a><span class="kt">INTEGER</span><span class="p">(</span><span class="kt">c_size_t</span><span class="p">),</span> <span class="k">VALUE</span><span class="p">,</span> <span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>            <span class="kd">::</span> <span class="n">argc</span> 
<a name="ln-4154"></a><span class="k">type</span><span class="p">(</span><span class="kt">c_ptr</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="n">argc</span><span class="p">),</span> <span class="k">INTENT</span><span class="p">(</span><span class="n">INOUT</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">argv</span>
<a name="ln-4155"></a><span class="kt">REAL</span><span class="p">(</span><span class="kt">c_float</span><span class="p">)</span>                                   <span class="kd">::</span> <span class="n">efitEBSDWrapper</span>
<a name="ln-4156"></a>
<a name="ln-4157"></a><span class="c">! wrapper function dependent declarations; they are all pointers </span>
<a name="ln-4158"></a><span class="c">! since we pass everything by reference from IDL </span>
<a name="ln-4159"></a><span class="kt">integer</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>                                      <span class="kd">::</span> <span class="n">nipar</span><span class="p">,</span> <span class="n">nfpar</span><span class="p">,</span> <span class="n">ninit</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">iprint</span><span class="p">,</span> <span class="n">maxfun</span><span class="p">,</span> <span class="n">npt</span>
<a name="ln-4160"></a><span class="kt">real</span><span class="p">(</span><span class="kt">c_double</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(:),</span> <span class="k">pointer</span>           <span class="kd">::</span> <span class="n">rhobeg</span><span class="p">,</span> <span class="n">rhoend</span>
<a name="ln-4161"></a><span class="kt">integer</span><span class="p">(</span><span class="kt">c_size_t</span><span class="p">),</span><span class="k">dimension</span><span class="p">(:),</span> <span class="k">pointer</span>         <span class="kd">::</span> <span class="n">ipar</span>
<a name="ln-4162"></a><span class="kt">real</span><span class="p">(</span><span class="kt">c_float</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(:),</span> <span class="k">pointer</span>            <span class="kd">::</span> <span class="n">fpar</span>
<a name="ln-4163"></a><span class="kt">real</span><span class="p">(</span><span class="kt">c_float</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(:),</span> <span class="k">pointer</span>            <span class="kd">::</span> <span class="n">initmeanval</span>
<a name="ln-4164"></a><span class="kt">real</span><span class="p">(</span><span class="kt">c_float</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(:),</span> <span class="k">pointer</span>            <span class="kd">::</span> <span class="n">expt</span>
<a name="ln-4165"></a><span class="kt">real</span><span class="p">(</span><span class="kt">c_float</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(:,:,:),</span> <span class="k">pointer</span>        <span class="kd">::</span> <span class="n">accum_e</span>
<a name="ln-4166"></a><span class="kt">real</span><span class="p">(</span><span class="kt">c_float</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(:,:,:,:),</span> <span class="k">pointer</span>      <span class="kd">::</span> <span class="n">mLPNH</span>
<a name="ln-4167"></a><span class="kt">real</span><span class="p">(</span><span class="kt">c_float</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(:,:,:,:),</span> <span class="k">pointer</span>      <span class="kd">::</span> <span class="n">mLPSH</span>
<a name="ln-4168"></a><span class="kt">real</span><span class="p">(</span><span class="kt">c_double</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(:),</span> <span class="k">pointer</span>           <span class="kd">::</span> <span class="n">X</span>
<a name="ln-4169"></a><span class="kt">real</span><span class="p">(</span><span class="kt">c_double</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(:),</span> <span class="k">pointer</span>           <span class="kd">::</span> <span class="n">XL</span>
<a name="ln-4170"></a><span class="kt">real</span><span class="p">(</span><span class="kt">c_double</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(:),</span> <span class="k">pointer</span>           <span class="kd">::</span> <span class="n">XU</span>
<a name="ln-4171"></a>
<a name="ln-4172"></a>
<a name="ln-4173"></a>
<a name="ln-4174"></a><span class="c">! the following line just helps in identifying the correct order of the subroutine arguments...</span>
<a name="ln-4175"></a><span class="c">!                                        1      2     3       4           5           6   7   8   9        10</span>
<a name="ln-4176"></a><span class="c">!subroutine BOBYQA(nipar, nfpar, ninit, ipar, fpar, fname, initmeanval, expt, N, NPT, X, XL, XU, RHOBEG, RHOEND, IPRINT, MAXFUN, EBSDCALFUN)</span>
<a name="ln-4177"></a><span class="c">!</span>
<a name="ln-4178"></a><span class="c">! transform the C pointers above to fortran pointers, and use them in the regular function call</span>
<a name="ln-4179"></a><span class="n">nipar</span> <span class="o">=</span> <span class="mi">9</span>
<a name="ln-4180"></a><span class="n">nfpar</span> <span class="o">=</span> <span class="mi">11</span>
<a name="ln-4181"></a><span class="n">ninit</span> <span class="o">=</span> <span class="mi">4</span>
<a name="ln-4182"></a><span class="n">n</span> <span class="o">=</span> <span class="mi">7</span>
<a name="ln-4183"></a><span class="n">iprint</span> <span class="o">=</span> <span class="mi">2</span>
<a name="ln-4184"></a><span class="n">maxfun</span> <span class="o">=</span> <span class="mi">10000</span>
<a name="ln-4185"></a><span class="n">npt</span> <span class="o">=</span> <span class="n">n</span> <span class="o">+</span> <span class="mi">6</span>
<a name="ln-4186"></a>
<a name="ln-4187"></a><span class="k">call </span><span class="nb">c_f_pointer</span><span class="p">(</span><span class="n">argv</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="n">ipar</span><span class="p">,(</span><span class="o">/</span><span class="n">nipar</span><span class="o">/</span><span class="p">))</span> 
<a name="ln-4188"></a><span class="k">call </span><span class="nb">c_f_pointer</span><span class="p">(</span><span class="n">argv</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span><span class="n">fpar</span><span class="p">,(</span><span class="o">/</span><span class="n">nfpar</span><span class="o">/</span><span class="p">))</span> 
<a name="ln-4189"></a><span class="k">call </span><span class="nb">c_f_pointer</span><span class="p">(</span><span class="n">argv</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span><span class="n">initmeanval</span><span class="p">,(</span><span class="o">/</span><span class="n">n</span><span class="o">/</span><span class="p">))</span>
<a name="ln-4190"></a><span class="k">call </span><span class="nb">c_f_pointer</span><span class="p">(</span><span class="n">argv</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span><span class="n">expt</span><span class="p">,(</span><span class="o">/</span><span class="n">ipar</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">ipar</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">/</span><span class="p">))</span>
<a name="ln-4191"></a><span class="k">call </span><span class="nb">c_f_pointer</span><span class="p">(</span><span class="n">argv</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span><span class="n">X</span><span class="p">,(</span><span class="o">/</span><span class="n">n</span><span class="o">/</span><span class="p">))</span>
<a name="ln-4192"></a><span class="k">call </span><span class="nb">c_f_pointer</span><span class="p">(</span><span class="n">argv</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span><span class="n">XL</span><span class="p">,(</span><span class="o">/</span><span class="n">n</span><span class="o">/</span><span class="p">))</span>
<a name="ln-4193"></a><span class="k">call </span><span class="nb">c_f_pointer</span><span class="p">(</span><span class="n">argv</span><span class="p">(</span><span class="mi">7</span><span class="p">),</span><span class="n">XU</span><span class="p">,(</span><span class="o">/</span><span class="n">n</span><span class="o">/</span><span class="p">))</span>
<a name="ln-4194"></a><span class="k">call </span><span class="nb">c_f_pointer</span><span class="p">(</span><span class="n">argv</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span><span class="n">RHOBEG</span><span class="p">,(</span><span class="o">/</span><span class="mi">1</span><span class="o">/</span><span class="p">))</span>
<a name="ln-4195"></a><span class="k">call </span><span class="nb">c_f_pointer</span><span class="p">(</span><span class="n">argv</span><span class="p">(</span><span class="mi">9</span><span class="p">),</span><span class="n">RHOEND</span><span class="p">,(</span><span class="o">/</span><span class="mi">1</span><span class="o">/</span><span class="p">))</span>
<a name="ln-4196"></a><span class="k">call </span><span class="nb">c_f_pointer</span><span class="p">(</span><span class="n">argv</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span><span class="n">accum_e</span><span class="p">,(</span><span class="o">/</span><span class="n">ipar</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span><span class="mi">2</span><span class="o">*</span><span class="n">ipar</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="n">ipar</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="o">/</span><span class="p">))</span>
<a name="ln-4197"></a><span class="k">call </span><span class="nb">c_f_pointer</span><span class="p">(</span><span class="n">argv</span><span class="p">(</span><span class="mi">11</span><span class="p">),</span><span class="n">mLPNH</span><span class="p">,(</span><span class="o">/</span><span class="mi">2</span><span class="o">*</span><span class="n">ipar</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">ipar</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">ipar</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="n">ipar</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span><span class="o">/</span><span class="p">))</span>
<a name="ln-4198"></a><span class="k">call </span><span class="nb">c_f_pointer</span><span class="p">(</span><span class="n">argv</span><span class="p">(</span><span class="mi">12</span><span class="p">),</span><span class="n">mLPSH</span><span class="p">,(</span><span class="o">/</span><span class="mi">2</span><span class="o">*</span><span class="n">ipar</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">ipar</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">ipar</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="n">ipar</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span><span class="o">/</span><span class="p">))</span>
<a name="ln-4199"></a>
<a name="ln-4200"></a><span class="c">! call BOBYQA(NIPAR, NFPAR, NINIT, IPAR, FPAR, INITMEANVAL, EXPT, N, NPT, X, XL, XU, RHOBEG(1), RHOEND(1),&amp;</span>
<a name="ln-4201"></a><span class="c">!      IPRINT, MAXFUN, EBSDCALFUN, accum_e, mLPNH, mLPSH)</span>
<a name="ln-4202"></a>
<a name="ln-4203"></a><span class="n">efitEBSDWrapper</span> <span class="o">=</span> <span class="mf">1._c_float</span>
<a name="ln-4204"></a>
<a name="ln-4205"></a><span class="k">end function </span><span class="n">efitEBSDWrapper</span>
<a name="ln-4206"></a>
<a name="ln-4207"></a><span class="k">end module </span><span class="n">EMdymod</span>
</pre></div>

    </section>
    </div>
  </div>

  <section class="visible-xs visible-sm hidden-md">
    <hr>
    

<div class="panel panel-default">
  <div class="panel-heading text-left"><h3 class="panel-title"><a data-toggle="collapse" href="#allfiles-1">All Source Files</a></h3></div>
  <div id="allfiles-1" class="panel-collapse collapse">
    <div class="list-group">
      
      <a class="list-group-item" href="../sourcefile/apb.f90.html">apb.f90</a>
      
      <a class="list-group-item" href="../sourcefile/bobyqa.f90.html">bobyqa.f90</a>
      
      <a class="list-group-item" href="../sourcefile/bobyqa_refinement.f90.html">bobyqa_refinement.f90</a>
      
      <a class="list-group-item" href="../sourcefile/clsupport.f90.html">CLsupport.f90</a>
      
      <a class="list-group-item" href="../sourcefile/constants.f90.html">constants.f90</a>
      
      <a class="list-group-item" href="../sourcefile/defectmodule.f90.html">defectmodule.f90</a>
      
      <a class="list-group-item" href="../sourcefile/dictmod.f90.html">dictmod.f90</a>
      
      <a class="list-group-item" href="../sourcefile/dispfield.f90.html">dispfield.f90</a>
      
      <a class="list-group-item" href="../sourcefile/distortion.f90.html">distortion.f90</a>
      
      <a class="list-group-item" href="../sourcefile/eccimod.f90.html">ECCImod.f90</a>
      
      <a class="list-group-item" href="../sourcefile/eispack.f90.html">eispack.f90</a>
      
      <a class="list-group-item" href="../sourcefile/emdymod.f90.html">EMdymod.f90</a>
      
      <a class="list-group-item" href="../sourcefile/filters.f90.html">filters.f90</a>
      
      <a class="list-group-item" href="../sourcefile/hdftest.f90.html">hdftest.f90</a>
      
      <a class="list-group-item" href="../sourcefile/indexingmod.f90.html">Indexingmod.f90</a>
      
      <a class="list-group-item" href="../sourcefile/initializers.f90.html">initializers.f90</a>
      
      <a class="list-group-item" href="../sourcefile/jsonsupport.f90.html">JSONsupport.f90</a>
      
      <a class="list-group-item" href="../sourcefile/muellercalculus.f90.html">MuellerCalculus.f90</a>
      
      <a class="list-group-item" href="../sourcefile/multibeams.f90.html">multibeams.f90</a>
      
      <a class="list-group-item" href="../sourcefile/namelisthandlers.f90.html">NameListHandlers.f90</a>
      
      <a class="list-group-item" href="../sourcefile/namelistjsonwriters.f90.html">NameListJSONwriters.f90</a>
      
      <a class="list-group-item" href="../sourcefile/namelisttypedefs.f90.html">NameListTypedefs.f90</a>
      
      <a class="list-group-item" href="../sourcefile/noise.f90.html">noise.f90</a>
      
      <a class="list-group-item" href="../sourcefile/others.f90.html">others.f90</a>
      
      <a class="list-group-item" href="../sourcefile/pedmod.f90.html">PEDmod.f90</a>
      
      <a class="list-group-item" href="../sourcefile/pfinversion.f90.html">PFInversion.f90</a>
      
      <a class="list-group-item" href="../sourcefile/pgm.f90.html">pgm.f90</a>
      
      <a class="list-group-item" href="../sourcefile/povray.f90.html">povray.f90</a>
      
      <a class="list-group-item" href="../sourcefile/rng.f90.html">rng.f90</a>
      
      <a class="list-group-item" href="../sourcefile/simulated_annealing.f90.html">simulated_annealing.f90</a>
      
      <a class="list-group-item" href="../sourcefile/so3.f90.html">so3.f90</a>
      
      <a class="list-group-item" href="../sourcefile/stemmodule.f90.html">STEMmodule.f90</a>
      
      <a class="list-group-item" href="../sourcefile/timing.f90.html">timing.f90</a>
      
    </div>
  </div>
</div>


  </section>
  
    <hr>    
    </div> <!-- /container -->
    <footer>
      <div class="container">
      <div class="row">
        <div class="col-xs-6 col-md-4"><p>&copy; 2017 <a rel="license" href="http://www.freebsd.org/copyright/freebsd-doc-license.html">FreeBSD Documentation License</a></p></div>
        <div class="col-xs-6 col-md-4 col-md-push-4">
          <p class="text-right">
            Documentation generated by 
            <a href="https://github.com/cmacmackin/ford">FORD</a>
            
          </p>
        </div>
        <div class="col-xs-12 col-md-4 col-md-pull-4"><p class="text-center"> Fortran Program was developed by Marc De Graef Research Group/Carnegie Mellon University</p></div>
      </div>
      <br>
      </div> <!-- /container -->    
    </footer>

    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
<!--
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
-->
    <script src="../js/bootstrap.min.js"></script>
    <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
    <script src="../js/ie10-viewport-bug-workaround.js"></script>

    <!-- MathJax JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        TeX: { extensions: ['AMSmath.js','AMSsymbols.js','noErrors.js','noUndefined.js'], equationNumbers: { autoNumber: 'AMS' } },
        jax: ['input/TeX','input/MathML','output/HTML-CSS'],
        extensions: ['tex2jax.js','mml2jax.js','MathMenu.js','MathZoom.js'],
        'HTML-CSS': { 
           styles: { '.MathJax_Display, .MathJax .mo, .MathJax .mi, .MathJax .mn': {color: '#000000 ! important'} }
        }
      });
    </script>
    <script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
  </body>
</html>