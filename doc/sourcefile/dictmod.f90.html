<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
	 
	 <meta name="description" content="EMsoft main library">
    
    <meta name="author" content="Marc De Graef Research Group/Carnegie Mellon University" >
    <link rel="icon" href="../favicon.png">

    <title>dictmod.f90 &ndash; Fortran Program</title>

    <link href="../css/bootstrap.min.css" rel="stylesheet">
    <link href="../css/pygments.css" rel="stylesheet">
    <link href="../css/font-awesome.min.css" rel="stylesheet">
    <link href="../css/local.css" rel="stylesheet">
    

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    
    <script src="../js/jquery-2.1.3.min.js"></script>
    <script src="../js/svg-pan-zoom.min.js"></script>

    
    <script src="../tipuesearch/tipuesearch_content.js"></script>
    <link  href="../tipuesearch/tipuesearch.css" rel="stylesheet">
    <script src="../tipuesearch/tipuesearch_set.js"></script>
    <script src="../tipuesearch/tipuesearch.js"></script>
    

  </head>

  <body>

    <!-- Fixed navbar -->
    <nav class="navbar navbar-inverse navbar-fixed-top">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="../index.html">Fortran Program </a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
				
            <li class="dropdown hidden-xs visible-sm visible-md hidden-lg">
              <a href="#" class="dropdown-toggle"
              data-toggle="dropdown" role="button"
              aria-haspopup="true"
		 aria-expanded="false">Contents <span class="caret"></span></a>
	      <ul class="dropdown-menu">
              
            <li><a href="../lists/files.html">Source Files</a></li>
				
				
            <li><a href="../lists/modules.html">Modules</a></li>
				
            
                                
            <li><a href="../lists/procedures.html">Procedures</a></li>
				
				
            <li><a href="../lists/absint.html">Abstract Interfaces</a></li>
								
            <li><a href="../lists/types.html">Derived Types</a></li>
				
				
            <li><a href="../lists/programs.html">Programs</a></li>
				
            </ul>
            </li>

<li class="visible-xs hidden-sm visible-lg"><a href="../lists/files.html">Source Files</a></li>


<li class="visible-xs hidden-sm visible-lg"><a href="../lists/modules.html">Modules</a></li>



<li class="visible-xs hidden-sm visible-lg"><a href="../lists/procedures.html">Procedures</a></li>


<li class="visible-xs hidden-sm visible-lg"><a href="../lists/absint.html">Abstract Interfaces</a></li>
                             
<li class="visible-xs hidden-sm visible-lg"><a href="../lists/types.html">Derived Types</a></li>


<li class="visible-xs hidden-sm visible-lg"><a href="../lists/programs.html">Programs</a></li>

          </ul>
        
        <form action="../search.html" class="navbar-form navbar-right" role="search">
        <div class="form-group">
          <input type="text" class="form-control" placeholder="Search" name="q" id="tipue_search_input" autocomplete="off" required>
        </div>
<!--
        <button type="submit" class="btn btn-default">Submit</button>
-->
        </form>
        
        </div><!--/.nav-collapse -->
      </div>
    </nav>

    <div class="container">
    
  
  <div class="row">
    <h1>dictmod.f90
    <small>Source File</small>
    
    </h1>
    
<div class="row">
  <div class="col-lg-12">
<div class="well well-sm">
  <ul class="list-inline" style="margin-bottom:0px;display:inline">
     
     
     
     
    
    
     <li><i class="fa fa-list-ol"></i>
       <a data-toggle="tooltip"
	  data-placement="bottom" data-html="true"
	  title=" 2.7% of total for source files.">832 statements</a>
     </li> 
     
     
    <li><i class="fa fa-code"></i><a href="../src/dictmod.f90"> Source File</a></li>
     
  </ul>
  <ol class="breadcrumb in-well text-right">
  
     <li class="active">dictmod.f90</li>
  </ol>
</div>
</div>
</div>
<script>
  $(function () {
  $('[data-toggle="tooltip"]').tooltip()
  })
</script>

  </div>
  <div class="row">
    <div class="col-md-3 hidden-xs hidden-sm visible-md visible-lg">
    
<div id="sidebar">
  






<div class="panel panel-primary">
  <div class="panel-heading text-left"><h3 class="panel-title"><a data-toggle="collapse" href="#mods-0">Modules</a></h3></div>
  <div id="mods-0" class="panel-collapse collapse">
    <div class="list-group">
      
      <a class="list-group-item" href="../module/dictmod.html">dictmod</a>
      
    </div>
  </div>
</div>















<div class="panel panel-primary">
  <div class="panel-heading text-left"><h3 class="panel-title">Source Code</h3></div>
  <div class="list-group">
    <a class="list-group-item" href="../sourcefile/dictmod.f90.html#src">dictmod.f90</a>
  </div>
</div>


  <hr>
  

<div class="panel panel-default">
  <div class="panel-heading text-left"><h3 class="panel-title"><a data-toggle="collapse" href="#allfiles-0">All Source Files</a></h3></div>
  <div id="allfiles-0" class="panel-collapse collapse">
    <div class="list-group">
      
      <a class="list-group-item" href="../sourcefile/apb.f90.html">apb.f90</a>
      
      <a class="list-group-item" href="../sourcefile/bobyqa.f90.html">bobyqa.f90</a>
      
      <a class="list-group-item" href="../sourcefile/bobyqa_refinement.f90.html">bobyqa_refinement.f90</a>
      
      <a class="list-group-item" href="../sourcefile/clsupport.f90.html">CLsupport.f90</a>
      
      <a class="list-group-item" href="../sourcefile/constants.f90.html">constants.f90</a>
      
      <a class="list-group-item" href="../sourcefile/defectmodule.f90.html">defectmodule.f90</a>
      
      <a class="list-group-item" href="../sourcefile/dictmod.f90.html">dictmod.f90</a>
      
      <a class="list-group-item" href="../sourcefile/dispfield.f90.html">dispfield.f90</a>
      
      <a class="list-group-item" href="../sourcefile/distortion.f90.html">distortion.f90</a>
      
      <a class="list-group-item" href="../sourcefile/eccimod.f90.html">ECCImod.f90</a>
      
      <a class="list-group-item" href="../sourcefile/eispack.f90.html">eispack.f90</a>
      
      <a class="list-group-item" href="../sourcefile/emdymod.f90.html">EMdymod.f90</a>
      
      <a class="list-group-item" href="../sourcefile/filters.f90.html">filters.f90</a>
      
      <a class="list-group-item" href="../sourcefile/hdftest.f90.html">hdftest.f90</a>
      
      <a class="list-group-item" href="../sourcefile/indexingmod.f90.html">Indexingmod.f90</a>
      
      <a class="list-group-item" href="../sourcefile/initializers.f90.html">initializers.f90</a>
      
      <a class="list-group-item" href="../sourcefile/jsonsupport.f90.html">JSONsupport.f90</a>
      
      <a class="list-group-item" href="../sourcefile/muellercalculus.f90.html">MuellerCalculus.f90</a>
      
      <a class="list-group-item" href="../sourcefile/multibeams.f90.html">multibeams.f90</a>
      
      <a class="list-group-item" href="../sourcefile/namelisthandlers.f90.html">NameListHandlers.f90</a>
      
      <a class="list-group-item" href="../sourcefile/namelistjsonwriters.f90.html">NameListJSONwriters.f90</a>
      
      <a class="list-group-item" href="../sourcefile/namelisttypedefs.f90.html">NameListTypedefs.f90</a>
      
      <a class="list-group-item" href="../sourcefile/noise.f90.html">noise.f90</a>
      
      <a class="list-group-item" href="../sourcefile/others.f90.html">others.f90</a>
      
      <a class="list-group-item" href="../sourcefile/pedmod.f90.html">PEDmod.f90</a>
      
      <a class="list-group-item" href="../sourcefile/pfinversion.f90.html">PFInversion.f90</a>
      
      <a class="list-group-item" href="../sourcefile/pgm.f90.html">pgm.f90</a>
      
      <a class="list-group-item" href="../sourcefile/povray.f90.html">povray.f90</a>
      
      <a class="list-group-item" href="../sourcefile/rng.f90.html">rng.f90</a>
      
      <a class="list-group-item" href="../sourcefile/simulated_annealing.f90.html">simulated_annealing.f90</a>
      
      <a class="list-group-item" href="../sourcefile/so3.f90.html">so3.f90</a>
      
      <a class="list-group-item" href="../sourcefile/stemmodule.f90.html">STEMmodule.f90</a>
      
      <a class="list-group-item" href="../sourcefile/timing.f90.html">timing.f90</a>
      
    </div>
  </div>
</div>


</div>  

    </div>
    <div class="col-md-9" id='text'>
    
    
    <h3>This File Depends On</h3>
    
                <div class="depgraph"><?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.38.0 (20140413.2041)
 -->
<!-- Title: sourcefile~~dictmod.f90~~EfferentGraph Pages: 1 -->
<svg id="sourcefiledictmodf90EfferentGraph" width="276pt" height="52pt"
 viewBox="0.00 0.00 276.00 52.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="sourcefile~~dictmod.f90~~EfferentGraph" class="graph" transform="scale(1 1) rotate(0) translate(4 48)">
<title>sourcefile~~dictmod.f90~~EfferentGraph</title>
<polygon fill="white" stroke="none" points="-4,4 -4,-48 272,-48 272,4 -4,4"/>
<!-- sourcefile~dictmod.f90 -->
<g id="sourcefile~~dictmod.f90~~EfferentGraph_node1" class="node"><title>sourcefile~dictmod.f90</title>
<polygon fill="none" stroke="black" points="268,-44 201,-44 201,-20 268,-20 268,-44"/>
<text text-anchor="middle" x="234.5" y="-29.6" font-family="Helvetica,sans-Serif" font-size="10.50">dictmod.f90</text>
</g>
<!-- sourcefile~constants.f90 -->
<g id="sourcefile~~dictmod.f90~~EfferentGraph_node2" class="node"><title>sourcefile~constants.f90</title>
<g id="a_sourcefile~~dictmod.f90~~EfferentGraph_node2"><a xlink:href="../sourcefile/constants.f90.html" xlink:title="constants.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="75,-44 0,-44 0,-20 75,-20 75,-44"/>
<text text-anchor="middle" x="37.5" y="-29.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">constants.f90</text>
</a>
</g>
</g>
<!-- sourcefile~constants.f90&#45;&gt;sourcefile~dictmod.f90 -->
<g id="sourcefile~~dictmod.f90~~EfferentGraph_edge2" class="edge"><title>sourcefile~constants.f90&#45;&gt;sourcefile~dictmod.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M75.0097,-32.6018C86.5244,-32.7652 99.2934,-32.9193 111,-33 134.999,-33.1655 141.001,-33.1752 165,-33 173.286,-32.9395 182.136,-32.8379 190.629,-32.722"/>
<polygon fill="#ff0000" stroke="#ff0000" points="190.801,-36.22 200.749,-32.5753 190.699,-29.2207 190.801,-36.22"/>
</g>
<!-- sourcefile~so3.f90 -->
<g id="sourcefile~~dictmod.f90~~EfferentGraph_node3" class="node"><title>sourcefile~so3.f90</title>
<g id="a_sourcefile~~dictmod.f90~~EfferentGraph_node3"><a xlink:href="../sourcefile/so3.f90.html" xlink:title="so3.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="165,-24 111,-24 111,-0 165,-0 165,-24"/>
<text text-anchor="middle" x="138" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">so3.f90</text>
</a>
</g>
</g>
<!-- sourcefile~constants.f90&#45;&gt;sourcefile~so3.f90 -->
<g id="sourcefile~~dictmod.f90~~EfferentGraph_edge1" class="edge"><title>sourcefile~constants.f90&#45;&gt;sourcefile~so3.f90</title>
<path fill="none" stroke="#00ffff" stroke-dasharray="5,2" d="M75.1778,-24.5527C83.5772,-22.8473 92.4995,-21.0356 100.875,-19.3349"/>
<polygon fill="#00ffff" stroke="#00ffff" points="101.646,-22.75 110.749,-17.3301 100.253,-15.89 101.646,-22.75"/>
</g>
<!-- sourcefile~so3.f90&#45;&gt;sourcefile~dictmod.f90 -->
<g id="sourcefile~~dictmod.f90~~EfferentGraph_edge3" class="edge"><title>sourcefile~so3.f90&#45;&gt;sourcefile~dictmod.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M165.073,-17.518C173.091,-19.215 182.135,-21.129 190.957,-22.9963"/>
<polygon fill="#ff0000" stroke="#ff0000" points="190.25,-26.4241 200.758,-25.0705 191.7,-19.5757 190.25,-26.4241"/>
</g>
</g>
</svg>
</div>
                <div><a type="button" class="graph-help" data-toggle="modal" href="#graph-help-text">Help</a></div>
                <div class="modal fade" id="graph-help-text" tabindex="-1" role="dialog">
                  <div class="modal-dialog modal-lg" role="document">
                    <div class="modal-content">
                      <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                        <h4 class="modal-title" id="-graph-help-label">Graph Key</h4>
                      </div>
                      <div class="modal-body">
                        
    <p>Nodes of different colours represent the following: </p>
    <?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.38.0 (20140413.2041)
 -->
<!-- Title: Graph Key Pages: 1 -->
<svg width="188pt" height="32pt"
 viewBox="0.00 0.00 188.00 32.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 28)">
<title>Graph Key</title>
<polygon fill="white" stroke="none" points="-4,4 -4,-28 184,-28 184,4 -4,4"/>
<!-- Source File -->
<g id="node1" class="node"><title>Source File</title>
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="66,-24 0,-24 0,-0 66,-0 66,-24"/>
<text text-anchor="middle" x="33" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Source File</text>
</g>
<!-- This Page&#39;s Entity -->
<g id="node2" class="node"><title>This Page&#39;s Entity</title>
<polygon fill="none" stroke="black" points="180,-24 84,-24 84,-0 180,-0 180,-24"/>
<text text-anchor="middle" x="132" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50">This Page&#39;s Entity</text>
</g>
</g>
</svg>

    
    <p>Solid arrows point from a file to a file which depends upon it. A file 
    is dependent upon another if the latter must be compiled before the former
    can be. Where possible, edges connecting nodes are given different colours to make them easier to distinguish in large graphs.
    </p>
    
                      </div>
                    </div>
                  </div>
                </div>
                
    
      
      <h3>Files Dependent On This One</h3>
      
                <div class="depgraph"><?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.38.0 (20140413.2041)
 -->
<!-- Title: sourcefile~~dictmod.f90~~AfferentGraph Pages: 1 -->
<svg id="sourcefiledictmodf90AfferentGraph" width="197pt" height="32pt"
 viewBox="0.00 0.00 197.00 32.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="sourcefile~~dictmod.f90~~AfferentGraph" class="graph" transform="scale(1 1) rotate(0) translate(4 28)">
<title>sourcefile~~dictmod.f90~~AfferentGraph</title>
<polygon fill="white" stroke="none" points="-4,4 -4,-28 193,-28 193,4 -4,4"/>
<!-- sourcefile~dictmod.f90 -->
<g id="sourcefile~~dictmod.f90~~AfferentGraph_node1" class="node"><title>sourcefile~dictmod.f90</title>
<polygon fill="none" stroke="black" points="67,-24 0,-24 0,-0 67,-0 67,-24"/>
<text text-anchor="middle" x="33.5" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50">dictmod.f90</text>
</g>
<!-- sourcefile~pfinversion.f90 -->
<g id="sourcefile~~dictmod.f90~~AfferentGraph_node2" class="node"><title>sourcefile~pfinversion.f90</title>
<g id="a_sourcefile~~dictmod.f90~~AfferentGraph_node2"><a xlink:href="../sourcefile/pfinversion.f90.html" xlink:title="PFInversion.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="189,-24 103,-24 103,-0 189,-0 189,-24"/>
<text text-anchor="middle" x="146" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">PFInversion.f90</text>
</a>
</g>
</g>
<!-- sourcefile~dictmod.f90&#45;&gt;sourcefile~pfinversion.f90 -->
<g id="sourcefile~~dictmod.f90~~AfferentGraph_edge1" class="edge"><title>sourcefile~dictmod.f90&#45;&gt;sourcefile~pfinversion.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M67.056,-12C75.1092,-12 83.941,-12 92.675,-12"/>
<polygon fill="#ff0000" stroke="#ff0000" points="92.8306,-15.5001 102.831,-12 92.8306,-8.5001 92.8306,-15.5001"/>
</g>
</g>
</svg>
</div>
                <div><a type="button" class="graph-help" data-toggle="modal" href="#graph-help-text">Help</a></div>
                <div class="modal fade" id="graph-help-text" tabindex="-1" role="dialog">
                  <div class="modal-dialog modal-lg" role="document">
                    <div class="modal-content">
                      <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                        <h4 class="modal-title" id="-graph-help-label">Graph Key</h4>
                      </div>
                      <div class="modal-body">
                        
    <p>Nodes of different colours represent the following: </p>
    <?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.38.0 (20140413.2041)
 -->
<!-- Title: Graph Key Pages: 1 -->
<svg width="188pt" height="32pt"
 viewBox="0.00 0.00 188.00 32.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 28)">
<title>Graph Key</title>
<polygon fill="white" stroke="none" points="-4,4 -4,-28 184,-28 184,4 -4,4"/>
<!-- Source File -->
<g id="node1" class="node"><title>Source File</title>
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="66,-24 0,-24 0,-0 66,-0 66,-24"/>
<text text-anchor="middle" x="33" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Source File</text>
</g>
<!-- This Page&#39;s Entity -->
<g id="node2" class="node"><title>This Page&#39;s Entity</title>
<polygon fill="none" stroke="black" points="180,-24 84,-24 84,-0 180,-0 180,-24"/>
<text text-anchor="middle" x="132" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50">This Page&#39;s Entity</text>
</g>
</g>
</svg>

    
    <p>Solid arrows point from a file to a file which depends upon it. A file 
    is dependent upon another if the latter must be compiled before the former
    can be. Where possible, edges connecting nodes are given different colours to make them easier to distinguish in large graphs.
    </p>
    
                      </div>
                    </div>
                  </div>
                </div>
                
      
      <br>

    <section class="visible-xs visible-sm hidden-md">
      






<div class="panel panel-primary">
  <div class="panel-heading text-left"><h3 class="panel-title"><a data-toggle="collapse" href="#mods-1">Modules</a></h3></div>
  <div id="mods-1" class="panel-collapse collapse">
    <div class="list-group">
      
      <a class="list-group-item" href="../module/dictmod.html">dictmod</a>
      
    </div>
  </div>
</div>















<div class="panel panel-primary">
  <div class="panel-heading text-left"><h3 class="panel-title">Source Code</h3></div>
  <div class="list-group">
    <a class="list-group-item" href="../sourcefile/dictmod.f90.html#src">dictmod.f90</a>
  </div>
</div>


    </section>
    <br class="visible-xs visible-sm hidden-md">

    <section>
      <h2><span class="anchor" id="src"></span>Source Code</h2>
    <div class="hl"><pre><span></span><a name="ln-1"></a><span class="c">! ###################################################################</span>
<a name="ln-2"></a><span class="c">! Copyright (c) 2014-2016, Marc De Graef Research Group/Carnegie Mellon University</span>
<a name="ln-3"></a><span class="c">! All rights reserved.</span>
<a name="ln-4"></a><span class="c">!</span>
<a name="ln-5"></a><span class="c">! Redistribution and use in source and binary forms, with or without modification, are </span>
<a name="ln-6"></a><span class="c">! permitted provided that the following conditions are met:</span>
<a name="ln-7"></a><span class="c">!</span>
<a name="ln-8"></a><span class="c">!     - Redistributions of source code must retain the above copyright notice, this list </span>
<a name="ln-9"></a><span class="c">!        of conditions and the following disclaimer.</span>
<a name="ln-10"></a><span class="c">!     - Redistributions in binary form must reproduce the above copyright notice, this </span>
<a name="ln-11"></a><span class="c">!        list of conditions and the following disclaimer in the documentation and/or </span>
<a name="ln-12"></a><span class="c">!        other materials provided with the distribution.</span>
<a name="ln-13"></a><span class="c">!     - Neither the names of Marc De Graef, Carnegie Mellon University nor the names </span>
<a name="ln-14"></a><span class="c">!        of its contributors may be used to endorse or promote products derived from </span>
<a name="ln-15"></a><span class="c">!        this software without specific prior written permission.</span>
<a name="ln-16"></a><span class="c">!</span>
<a name="ln-17"></a><span class="c">! THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &quot;AS IS&quot; </span>
<a name="ln-18"></a><span class="c">! AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE </span>
<a name="ln-19"></a><span class="c">! IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE </span>
<a name="ln-20"></a><span class="c">! ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE </span>
<a name="ln-21"></a><span class="c">! LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL </span>
<a name="ln-22"></a><span class="c">! DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR </span>
<a name="ln-23"></a><span class="c">! SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER </span>
<a name="ln-24"></a><span class="c">! CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, </span>
<a name="ln-25"></a><span class="c">! OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE </span>
<a name="ln-26"></a><span class="c">! USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span>
<a name="ln-27"></a><span class="c">! ###################################################################</span>
<a name="ln-28"></a>
<a name="ln-29"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-30"></a><span class="c">! EMsoft:dictmod.f90</span>
<a name="ln-31"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-32"></a><span class="c">!</span>
<a name="ln-33"></a><span class="c">! MODULE: dictmod</span>
<a name="ln-34"></a><span class="c">!</span>
<a name="ln-35"></a><span class="c">!&gt; @author Marc De Graef, Carnegie Mellon University</span>
<a name="ln-36"></a><span class="c">!</span>
<a name="ln-37"></a><span class="c">!&gt; @brief Dictionary indexing routines</span>
<a name="ln-38"></a><span class="c">!</span>
<a name="ln-39"></a><span class="c">!&gt; @details This module contains all the routines that deal with the dictionary</span>
<a name="ln-40"></a><span class="c">!&gt; indexing approach, both in terms of computing all the dot products (which uses</span>
<a name="ln-41"></a><span class="c">!&gt; OpenCL kernels) and in terms of the subsequent indexing on the symmetrized </span>
<a name="ln-42"></a><span class="c">!&gt; quaternion unit sphere using the modified von Mises-Fisher distribution, or the</span>
<a name="ln-43"></a><span class="c">!&gt; modified mixture of axial Watson distributinos.  All</span>
<a name="ln-44"></a><span class="c">!&gt; the details for this approach can be found in two papers:</span>
<a name="ln-45"></a><span class="c">!&gt;</span>
<a name="ln-46"></a><span class="c">!&gt; &quot;A dictionary based approach for EBSD indexing&quot;, Yu Hui Chen, Se Un Park, Dennis Wei, </span>
<a name="ln-47"></a><span class="c">!&gt; Greg Newstadt, Michael Jackson, Jeff Simmons, Alfred Hero, and Marc De Graef, </span>
<a name="ln-48"></a><span class="c">!&gt; Microscopy &amp; Microanalysis, under review (2015).</span>
<a name="ln-49"></a><span class="c">!&gt;</span>
<a name="ln-50"></a><span class="c">!&gt; &quot;Parameter estimation in spherical symmetry groups&quot;, Yu Hui Chen, Dennis Wei,</span>
<a name="ln-51"></a><span class="c">!&gt; Gregory Newstadt, Marc De Graef, Jeff Simmons, and Al Hero, IEEE Signal Processing </span>
<a name="ln-52"></a><span class="c">!&gt; Letters, in print (2015)</span>
<a name="ln-53"></a><span class="c">!&gt;</span>
<a name="ln-54"></a><span class="c">!&gt; Here is an example program showing how the routines can be called:</span>
<a name="ln-55"></a><span class="c">!&gt;</span>
<a name="ln-56"></a><span class="c">!&gt; program t</span>
<a name="ln-57"></a><span class="c">!&gt; </span>
<a name="ln-58"></a><span class="c">!&gt; use local</span>
<a name="ln-59"></a><span class="c">!&gt; use typedefs</span>
<a name="ln-60"></a><span class="c">!&gt; use dictmod</span>
<a name="ln-61"></a><span class="c">!&gt; use quaternions</span>
<a name="ln-62"></a><span class="c">!&gt; use constants</span>
<a name="ln-63"></a><span class="c">!&gt; </span>
<a name="ln-64"></a><span class="c">!&gt; integer(kind=irg)               :: nums, seed</span>
<a name="ln-65"></a><span class="c">!&gt; real(kind=dbl),allocatable      :: samples(:,:)</span>
<a name="ln-66"></a><span class="c">!&gt; type(dicttype)                  :: dict</span>
<a name="ln-67"></a><span class="c">!&gt; real(kind=dbl)                  :: muhat(4), kappahat</span>
<a name="ln-68"></a><span class="c">!&gt; </span>
<a name="ln-69"></a><span class="c">!&gt; ! this is a test of the dictionary indexing portion that deals with the </span>
<a name="ln-70"></a><span class="c">!&gt; ! modified von Mises-Fisher distribution; the results must be the same </span>
<a name="ln-71"></a><span class="c">!&gt; ! as those produced by the original Matlab code...</span>
<a name="ln-72"></a><span class="c">!&gt; </span>
<a name="ln-73"></a><span class="c">!&gt; seed = 432514</span>
<a name="ln-74"></a><span class="c">!&gt; nums = 1000</span>
<a name="ln-75"></a><span class="c">!&gt; allocate(samples(4,nums))</span>
<a name="ln-76"></a><span class="c">!&gt; </span>
<a name="ln-77"></a><span class="c">!&gt; allocate(dict)</span>
<a name="ln-78"></a><span class="c">!&gt; dict%Num_of_init = 3</span>
<a name="ln-79"></a><span class="c">!&gt; dict%Num_of_iterations = 30</span>
<a name="ln-80"></a><span class="c">!&gt; dict%pgnum = 32</span>
<a name="ln-81"></a><span class="c">!&gt; </span>
<a name="ln-82"></a><span class="c">!&gt; ! read a bunch of quaternions from a file... and store them in samples</span>
<a name="ln-83"></a><span class="c">!&gt; </span>
<a name="ln-84"></a><span class="c">!&gt; call DI_Init(dict,&#39;VMF&#39;) ! replace &#39;VMF&#39; by &#39;WAT&#39; to use the axial Watson distribution</span>
<a name="ln-85"></a><span class="c">!&gt; </span>
<a name="ln-86"></a><span class="c">!&gt; do i=1,10</span>
<a name="ln-87"></a><span class="c">!&gt;   call DI_EMforDD(samples, dict, nums, seed, muhat, kappahat,&#39;VMF&#39;)  ! replace &#39;VMF&#39; by &#39;WAT&#39; to use the Watson distribution</span>
<a name="ln-88"></a><span class="c">!&gt; </span>
<a name="ln-89"></a><span class="c">!&gt;   write (*,*) &#39;  &#39;</span>
<a name="ln-90"></a><span class="c">!&gt;   write (*,*) &#39;mu    = &#39;,muhat</span>
<a name="ln-91"></a><span class="c">!&gt;   write (*,*) &#39;kappa = &#39;,kappahat</span>
<a name="ln-92"></a><span class="c">!&gt;   write (*,*) &#39;equivalent angular precision : &#39;,180.D0*dacos(1.D0-1.D0/kappahat)/cPi</span>
<a name="ln-93"></a><span class="c">!&gt; end do</span>
<a name="ln-94"></a><span class="c">!&gt; </span>
<a name="ln-95"></a><span class="c">!&gt; end program</span>
<a name="ln-96"></a><span class="c">!&gt; </span>
<a name="ln-97"></a><span class="c">! </span>
<a name="ln-98"></a><span class="c">!&gt; @date 12/31/14 MDG 1.0 original (based on UMich Matlab code and IDL intermediate version)</span>
<a name="ln-99"></a><span class="c">!&gt; @date 01/02/15 MDG 1.1 debug of code; produces same result as Matlab code</span>
<a name="ln-100"></a><span class="c">!&gt; @date 01/04/15 MDG 1.2 trial implementation of model using hyperbolic functions instead of exponential</span>
<a name="ln-101"></a><span class="c">!&gt; @date 01/06/15 MDG 1.3 changed public routine names with DI_ in front</span>
<a name="ln-102"></a><span class="c">!&gt; @date 01/07/15 MDG 1.4 added VMF sampling routines </span>
<a name="ln-103"></a><span class="c">!&gt; @date 01/09/15 MDG 1.5 replaced several computations by numerically more stable versions</span>
<a name="ln-104"></a><span class="c">!&gt; @date 02/05/15 MDG 1.6 added sampling for axial Watson distribution</span>
<a name="ln-105"></a><span class="c">!&gt; @date 02/06/15 MDG 1.7 streamlined sampling code by removing duplications; VMF vs. Watson is now an argument </span>
<a name="ln-106"></a><span class="c">!&gt; @date 02/06/15 MDG 1.8 general rewrite and removal of duplications in indexing routines; some name changes</span>
<a name="ln-107"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-108"></a><span class="k">module </span><span class="n">dictmod</span>
<a name="ln-109"></a>
<a name="ln-110"></a><span class="k">IMPLICIT NONE</span>
<a name="ln-111"></a>
<a name="ln-112"></a><span class="k">public</span>  <span class="kd">::</span> <span class="n">DI_Init</span><span class="p">,</span> <span class="n">DI_EMforDD</span><span class="p">,</span> <span class="n">DD_Density</span><span class="p">,</span> <span class="n">DI_Similarity_Classifier</span><span class="p">,</span> <span class="n">DI_SampleDD</span><span class="p">,</span> <span class="n">getDisorientationAngle</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-113"></a>           <span class="n">ReduceOrientationtoRFZ</span>
<a name="ln-114"></a><span class="k">private</span> <span class="kd">::</span> <span class="n">DD_Estep</span><span class="p">,</span> <span class="n">DD_Mstep</span><span class="p">,</span> <span class="n">DD_getQandL</span><span class="p">,</span> <span class="n">CardIntersection</span><span class="p">,</span> <span class="n">randDDMarginal</span><span class="p">,</span> <span class="n">randUniformSphere</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-115"></a>           <span class="n">getDDDensityLBM</span><span class="p">,</span>  <span class="n">VMFMeanDirDensity</span><span class="p">,</span> <span class="n">WatsonMeanDirDensity</span><span class="p">,</span> <span class="n">DI_RotateToMu</span><span class="p">,</span> <span class="n">logCp</span> 
<a name="ln-116"></a>
<a name="ln-117"></a><span class="k">interface </span><span class="n">getDisorientationAngle</span>
<a name="ln-118"></a>        <span class="k">module procedure </span><span class="n">getDisorientationAngleSingle</span>
<a name="ln-119"></a>        <span class="k">module procedure </span><span class="n">getDisorientationAngleDouble</span>
<a name="ln-120"></a><span class="k">end interface</span>
<a name="ln-121"></a>
<a name="ln-122"></a><span class="k">contains</span>
<a name="ln-123"></a>
<a name="ln-124"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-125"></a><span class="c">!</span>
<a name="ln-126"></a><span class="c">! FUNCTION: DI_RotateToMu</span>
<a name="ln-127"></a><span class="c">!</span>
<a name="ln-128"></a><span class="c">!&gt; @author Marc De Graef, Carnegie Mellon University </span>
<a name="ln-129"></a><span class="c">!</span>
<a name="ln-130"></a><span class="c">!&gt; @brief Rotate an array of quaternions to an average direction lmu using the null space approach</span>
<a name="ln-131"></a><span class="c">!</span>
<a name="ln-132"></a><span class="c">!&gt; @param N number of samples to return</span>
<a name="ln-133"></a><span class="c">!&gt; @param seed random number generator seed value</span>
<a name="ln-134"></a><span class="c">!&gt; @param mu mean direction (unit quaternion)</span>
<a name="ln-135"></a><span class="c">!&gt; @param kappa concentration</span>
<a name="ln-136"></a><span class="c">!</span>
<a name="ln-137"></a><span class="c">!&gt; @date 02/05/15 MDG 1.0 original</span>
<a name="ln-138"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-139"></a><span class="k">recursive function </span><span class="n">DI_RotateToMu</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">lmu</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="k">result</span><span class="p">(</span><span class="n">ymu</span><span class="p">)</span>
<a name="ln-140"></a><span class="c">!DEC$ ATTRIBUTES DLLEXPORT :: DI_RotateToMu</span>
<a name="ln-141"></a>
<a name="ln-142"></a><span class="k">use </span><span class="n">local</span>
<a name="ln-143"></a>
<a name="ln-144"></a><span class="k">IMPLICIT NONE</span>
<a name="ln-145"></a>
<a name="ln-146"></a><span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">irg</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>            <span class="kd">::</span> <span class="n">N</span>
<a name="ln-147"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">dbl</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>               <span class="kd">::</span> <span class="n">lmu</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<a name="ln-148"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">dbl</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>               <span class="kd">::</span> <span class="n">y</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="n">N</span><span class="p">)</span>
<a name="ln-149"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">dbl</span><span class="p">)</span>                          <span class="kd">::</span> <span class="n">ymu</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="n">N</span><span class="p">)</span>
<a name="ln-150"></a>
<a name="ln-151"></a><span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">irg</span><span class="p">)</span>                       <span class="kd">::</span> <span class="n">i</span>
<a name="ln-152"></a>
<a name="ln-153"></a><span class="c">! parameters for the singular value decomposition</span>
<a name="ln-154"></a><span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">irg</span><span class="p">)</span>                       <span class="kd">::</span> <span class="n">nr</span><span class="p">,</span> <span class="n">LDA</span><span class="p">,</span> <span class="n">LDU</span><span class="p">,</span> <span class="n">LDVT</span><span class="p">,</span> <span class="n">lwork</span><span class="p">,</span> <span class="n">info</span>
<a name="ln-155"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">dbl</span><span class="p">)</span>                          <span class="kd">::</span> <span class="n">mA</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span> <span class="n">ss</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="n">u</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span> <span class="n">vt</span><span class="p">,</span> <span class="n">work</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
<a name="ln-156"></a>
<a name="ln-157"></a><span class="c">! Rotate the distribution along the desired mean direction mu</span>
<a name="ln-158"></a><span class="c">! In Matlab, one uses the null() operator which returns the null space of the argument</span>
<a name="ln-159"></a><span class="c">! This is then inserted into a 4x4 rotation matrix and multiplied with the quaternions</span>
<a name="ln-160"></a><span class="c">! from the random sample.  The null space of the input quaternion can be computed with</span>
<a name="ln-161"></a><span class="c">! singular value decomposition, which is done with the dgesvd Lapack routine. The matrix</span>
<a name="ln-162"></a><span class="c">! returned as u is the desired rotation matrix, except that the numbers in the first </span>
<a name="ln-163"></a><span class="c">! column must have their signs reversed.</span>
<a name="ln-164"></a>
<a name="ln-165"></a><span class="n">mA</span> <span class="o">=</span> <span class="mf">0.D0</span>
<a name="ln-166"></a><span class="n">mA</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">lmu</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">)</span>
<a name="ln-167"></a><span class="n">nr</span> <span class="o">=</span> <span class="mi">4</span>
<a name="ln-168"></a><span class="n">LDA</span> <span class="o">=</span> <span class="mi">4</span>
<a name="ln-169"></a><span class="n">LDVT</span> <span class="o">=</span> <span class="mi">1</span>
<a name="ln-170"></a><span class="n">LDU</span> <span class="o">=</span> <span class="mi">4</span>
<a name="ln-171"></a><span class="n">lwork</span> <span class="o">=</span> <span class="mi">20</span>
<a name="ln-172"></a><span class="k">call </span><span class="n">DGESVD</span><span class="p">(</span><span class="s1">&#39;A&#39;</span><span class="p">,</span><span class="s1">&#39;N&#39;</span><span class="p">,</span><span class="n">nr</span><span class="p">,</span><span class="n">nr</span><span class="p">,</span><span class="n">mA</span><span class="p">,</span><span class="n">LDA</span><span class="p">,</span><span class="n">ss</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">LDU</span><span class="p">,</span> <span class="n">vt</span><span class="p">,</span> <span class="n">LDVT</span><span class="p">,</span> <span class="n">work</span><span class="p">,</span> <span class="n">lwork</span><span class="p">,</span> <span class="n">info</span><span class="p">)</span>
<a name="ln-173"></a><span class="n">u</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="n">u</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-174"></a>
<a name="ln-175"></a><span class="c">! next, apply this 4x4 rotation matrix to all of the generated quaternions to</span>
<a name="ln-176"></a><span class="c">! rotate them along the mean direction mu</span>
<a name="ln-177"></a><span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">N</span>
<a name="ln-178"></a>        <span class="n">ymu</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="nb">matmul</span><span class="p">(</span><span class="n">u</span><span class="p">,</span><span class="n">y</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span><span class="n">i</span><span class="p">))</span>
<a name="ln-179"></a><span class="k">end do</span>
<a name="ln-180"></a>
<a name="ln-181"></a><span class="k">end function </span><span class="n">DI_RotateToMu</span>
<a name="ln-182"></a>
<a name="ln-183"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-184"></a><span class="c">!</span>
<a name="ln-185"></a><span class="c">! FUNCTION: randUniformSphere</span>
<a name="ln-186"></a><span class="c">!</span>
<a name="ln-187"></a><span class="c">!&gt; @author Marc De Graef, Carnegie Mellon University / Yu-Hui Chen, U. Michigan</span>
<a name="ln-188"></a><span class="c">!</span>
<a name="ln-189"></a><span class="c">!&gt; @brief Return a set of random vectors on the sphere S^2 using normal random sampling</span>
<a name="ln-190"></a><span class="c">!</span>
<a name="ln-191"></a><span class="c">!&gt; @param N number of samples to return</span>
<a name="ln-192"></a><span class="c">!&gt; @param seed random number generator seed value</span>
<a name="ln-193"></a><span class="c">!</span>
<a name="ln-194"></a><span class="c">!&gt; @date 01/07/15 MDG 1.0 original, based on Yu-Hui&#39;s Matlab code, output transposed</span>
<a name="ln-195"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-196"></a><span class="k">recursive function </span><span class="n">randUniformSphere</span><span class="p">(</span><span class="n">N</span><span class="p">,</span><span class="n">seed</span><span class="p">)</span> <span class="k">result</span><span class="p">(</span><span class="n">ranSphere</span><span class="p">)</span>
<a name="ln-197"></a><span class="c">!DEC$ ATTRIBUTES DLLEXPORT :: randUniformSphere</span>
<a name="ln-198"></a>
<a name="ln-199"></a><span class="k">use </span><span class="n">local</span>
<a name="ln-200"></a><span class="k">use </span><span class="n">math</span>
<a name="ln-201"></a>
<a name="ln-202"></a><span class="k">IMPLICIT NONE</span>
<a name="ln-203"></a>
<a name="ln-204"></a><span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">irg</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>            <span class="kd">::</span> <span class="n">N</span>
<a name="ln-205"></a><span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">irg</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">INOUT</span><span class="p">)</span>         <span class="kd">::</span> <span class="n">seed</span>
<a name="ln-206"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">dbl</span><span class="p">)</span>                          <span class="kd">::</span> <span class="n">ranSphere</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="n">N</span><span class="p">)</span>
<a name="ln-207"></a>
<a name="ln-208"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">dbl</span><span class="p">)</span>                          <span class="kd">::</span> <span class="n">nq</span><span class="p">,</span> <span class="n">NR</span><span class="p">(</span><span class="n">N</span><span class="o">*</span><span class="mi">3</span><span class="p">),</span> <span class="n">randNorm</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="n">N</span><span class="p">)</span>
<a name="ln-209"></a><span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">irg</span><span class="p">)</span>                       <span class="kd">::</span> <span class="n">i</span>
<a name="ln-210"></a>
<a name="ln-211"></a><span class="n">ranSphere</span> <span class="o">=</span> <span class="mf">0.D0</span>
<a name="ln-212"></a><span class="k">call </span><span class="n">R8VEC_normal_01</span><span class="p">(</span><span class="n">N</span><span class="o">*</span><span class="mi">3</span><span class="p">,</span><span class="n">seed</span><span class="p">,</span><span class="n">NR</span><span class="p">)</span>
<a name="ln-213"></a><span class="n">randNorm</span> <span class="o">=</span> <span class="nb">reshape</span><span class="p">(</span> <span class="n">NR</span><span class="p">,</span> <span class="p">(</span><span class="o">/</span> <span class="mi">3</span><span class="p">,</span> <span class="n">N</span> <span class="o">/</span><span class="p">)</span> <span class="p">)</span>
<a name="ln-214"></a>
<a name="ln-215"></a><span class="c">! and normalize the three-vectors</span>
<a name="ln-216"></a><span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">N</span>
<a name="ln-217"></a>  <span class="n">nq</span> <span class="o">=</span> <span class="nb">dsqrt</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">randNorm</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span><span class="n">i</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
<a name="ln-218"></a>  <span class="n">RanSphere</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="n">randNorm</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span><span class="n">i</span><span class="p">)</span><span class="o">/</span><span class="n">nq</span>
<a name="ln-219"></a><span class="k">end do</span>
<a name="ln-220"></a>
<a name="ln-221"></a><span class="k">end function </span><span class="n">randUniformSphere</span>
<a name="ln-222"></a>
<a name="ln-223"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-224"></a><span class="c">!</span>
<a name="ln-225"></a><span class="c">! FUNCTION: DI_SampleDD</span>
<a name="ln-226"></a><span class="c">!</span>
<a name="ln-227"></a><span class="c">!&gt; @author Marc De Graef, Carnegie Mellon University / Yu-Hui Chen, U. Michigan</span>
<a name="ln-228"></a><span class="c">!</span>
<a name="ln-229"></a><span class="c">!&gt; @brief Sample a directional distribution (VMF or WAT) on the quaternion unit sphere</span>
<a name="ln-230"></a><span class="c">!</span>
<a name="ln-231"></a><span class="c">!&gt; @param N number of samples to return</span>
<a name="ln-232"></a><span class="c">!&gt; @param seed random number generator seed value</span>
<a name="ln-233"></a><span class="c">!&gt; @param mu mean direction (unit quaternion)</span>
<a name="ln-234"></a><span class="c">!&gt; @param kappa concentration</span>
<a name="ln-235"></a><span class="c">!&gt; @param Dtype &#39;VMF&#39; for von-Mises-Fisher  or &#39;WAT&#39; for axial Watson</span>
<a name="ln-236"></a><span class="c">!</span>
<a name="ln-237"></a><span class="c">!&gt; @date 01/07/15 MDG 1.0 original, based on Yu-Hui&#39;s Matlab code</span>
<a name="ln-238"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-239"></a><span class="k">recursive function </span><span class="n">DI_SampleDD</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">seed</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">kappa</span><span class="p">,</span> <span class="n">Dtype</span><span class="p">)</span> <span class="k">result</span><span class="p">(</span><span class="n">sDD</span><span class="p">)</span>
<a name="ln-240"></a><span class="c">!DEC$ ATTRIBUTES DLLEXPORT :: DI_SampleDD</span>
<a name="ln-241"></a>
<a name="ln-242"></a><span class="k">use </span><span class="n">local</span>
<a name="ln-243"></a><span class="k">use </span><span class="n">error</span>
<a name="ln-244"></a>
<a name="ln-245"></a><span class="k">IMPLICIT NONE</span>
<a name="ln-246"></a>
<a name="ln-247"></a><span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">irg</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>            <span class="kd">::</span> <span class="n">N</span>
<a name="ln-248"></a><span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">irg</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">INOUT</span><span class="p">)</span>         <span class="kd">::</span> <span class="n">seed</span>
<a name="ln-249"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">dbl</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>               <span class="kd">::</span> <span class="n">mu</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<a name="ln-250"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">dbl</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>               <span class="kd">::</span> <span class="n">kappa</span>
<a name="ln-251"></a><span class="kt">character</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>                 <span class="kd">::</span> <span class="n">Dtype</span>
<a name="ln-252"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">dbl</span><span class="p">)</span>                          <span class="kd">::</span> <span class="n">sDD</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="n">N</span><span class="p">)</span>
<a name="ln-253"></a>
<a name="ln-254"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">dbl</span><span class="p">)</span>                          <span class="kd">::</span> <span class="n">nq</span><span class="p">,</span> <span class="n">tmpmu</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="n">RandSphere</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="n">N</span><span class="p">),</span> <span class="n">t</span><span class="p">(</span><span class="n">N</span><span class="p">),</span> <span class="n">RS</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="n">N</span><span class="p">),</span> <span class="n">lmu</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="n">y</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="n">N</span><span class="p">)</span>
<a name="ln-255"></a><span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">irg</span><span class="p">)</span>                       <span class="kd">::</span> <span class="n">i</span>
<a name="ln-256"></a>
<a name="ln-257"></a><span class="c">! make sure the input quaternion is normalized</span>
<a name="ln-258"></a><span class="n">nq</span> <span class="o">=</span> <span class="nb">dsqrt</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">mu</span><span class="o">*</span><span class="n">mu</span><span class="p">))</span>
<a name="ln-259"></a><span class="k">if</span> <span class="p">(</span><span class="n">nq</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mf">0.D0</span><span class="p">)</span> <span class="k">call </span><span class="n">FatalError</span><span class="p">(</span><span class="s1">&#39;DI_SampleDD&#39;</span><span class="p">,</span><span class="s1">&#39;Input quaternion has zero length&#39;</span><span class="p">)</span>
<a name="ln-260"></a><span class="n">lmu</span> <span class="o">=</span> <span class="n">mu</span><span class="o">/</span><span class="n">nq</span>
<a name="ln-261"></a>
<a name="ln-262"></a><span class="c">! initialize a bunch of parameters</span>
<a name="ln-263"></a><span class="n">tmpmu</span> <span class="o">=</span> <span class="p">(</span><span class="o">/</span> <span class="mf">1.D0</span><span class="p">,</span> <span class="mf">0.D0</span><span class="p">,</span> <span class="mf">0.D0</span><span class="p">,</span> <span class="mf">0.D0</span> <span class="o">/</span><span class="p">)</span>
<a name="ln-264"></a><span class="n">sDD</span> <span class="o">=</span> <span class="mf">0.D0</span>
<a name="ln-265"></a><span class="n">RS</span> <span class="o">=</span> <span class="mf">0.D0</span>
<a name="ln-266"></a>
<a name="ln-267"></a><span class="c">! get the t-parameter </span>
<a name="ln-268"></a><span class="n">t</span> <span class="o">=</span> <span class="n">randDDMarginal</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">kappa</span><span class="p">,</span> <span class="n">seed</span><span class="p">,</span> <span class="n">Dtype</span><span class="p">)</span>
<a name="ln-269"></a>
<a name="ln-270"></a><span class="c">! and the distribution of random directions on the 2-sphere</span>
<a name="ln-271"></a><span class="n">RandSphere</span> <span class="o">=</span> <span class="n">randUniformSphere</span><span class="p">(</span><span class="n">N</span><span class="p">,</span><span class="n">seed</span><span class="p">)</span>
<a name="ln-272"></a><span class="n">RS</span><span class="p">(</span><span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">N</span><span class="p">)</span> <span class="o">=</span> <span class="n">RandSphere</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">N</span><span class="p">)</span>
<a name="ln-273"></a>
<a name="ln-274"></a><span class="c">! merge these two parameters into the desired random variables</span>
<a name="ln-275"></a><span class="n">y</span> <span class="o">=</span> <span class="nb">transpose</span><span class="p">(</span> <span class="nb">spread</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="nb">DIM</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">NCOPIES</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span> <span class="o">*</span> <span class="nb">spread</span><span class="p">(</span><span class="n">tmpmu</span><span class="p">,</span><span class="nb">DIM</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">NCOPIES</span><span class="o">=</span><span class="n">N</span><span class="p">)</span> <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-276"></a>               <span class="nb">spread</span><span class="p">(</span><span class="nb">dsqrt</span><span class="p">(</span><span class="mf">1.D0</span><span class="o">-</span><span class="n">t</span><span class="o">*</span><span class="n">t</span><span class="p">),</span><span class="nb">DIM</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">NCOPIES</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span> <span class="o">*</span> <span class="nb">transpose</span><span class="p">(</span><span class="n">RS</span><span class="p">)</span> <span class="p">)</span>
<a name="ln-277"></a>
<a name="ln-278"></a><span class="c">! Rotate the distribution along the desired mean direction mu</span>
<a name="ln-279"></a><span class="n">sDD</span> <span class="o">=</span> <span class="n">DI_RotateToMu</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">lmu</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
<a name="ln-280"></a>
<a name="ln-281"></a><span class="k">end function </span><span class="n">DI_SampleDD</span>
<a name="ln-282"></a>
<a name="ln-283"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-284"></a><span class="c">!</span>
<a name="ln-285"></a><span class="c">! FUNCTION: randDDMarginal</span>
<a name="ln-286"></a><span class="c">!</span>
<a name="ln-287"></a><span class="c">!&gt; @author Marc De Graef, Carnegie Mellon University / Yu-Hui Chen, U. Michigan</span>
<a name="ln-288"></a><span class="c">!</span>
<a name="ln-289"></a><span class="c">!&gt; @brief rejection sampling for the t parameter for the marginal directional distribution</span>
<a name="ln-290"></a><span class="c">!</span>
<a name="ln-291"></a><span class="c">!&gt; @details This algorithm samples the parameter t from a marginal distribution f(t), which</span>
<a name="ln-292"></a><span class="c">!&gt; by itself is the VMF or Watson distribution integrated around the mean direction.  These</span>
<a name="ln-293"></a><span class="c">!&gt; expressions were derived by Yu-Hui and verified by MDG [02/05/15] and then implemented;</span>
<a name="ln-294"></a><span class="c">!&gt; there are some typographical errors in the literature, and the versions documented here</span>
<a name="ln-295"></a><span class="c">!&gt; are correct [numerical verification].</span>
<a name="ln-296"></a><span class="c">!</span>
<a name="ln-297"></a><span class="c">!&gt; @param N number of samples to return</span>
<a name="ln-298"></a><span class="c">!&gt; @param k concentration</span>
<a name="ln-299"></a><span class="c">!&gt; @param seed random number generator seed value</span>
<a name="ln-300"></a><span class="c">!&gt; @param Dtype &#39;VMF&#39; or &#39;WAT&#39;</span>
<a name="ln-301"></a><span class="c">!</span>
<a name="ln-302"></a><span class="c">!&gt; @date 01/07/15 MDG 1.0 original, based on Yu-Hui&#39;s Matlab code</span>
<a name="ln-303"></a><span class="c">!&gt; @date 02/05/15 MDG 1.1 consolidated routines for VMF and WAT distributions</span>
<a name="ln-304"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-305"></a><span class="k">recursive function </span><span class="n">randDDMarginal</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">seed</span><span class="p">,</span> <span class="n">Dtype</span><span class="p">)</span> <span class="k">result</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
<a name="ln-306"></a><span class="c">!DEC$ ATTRIBUTES DLLEXPORT :: randDDMarginal</span>
<a name="ln-307"></a>
<a name="ln-308"></a><span class="k">use </span><span class="n">local</span>
<a name="ln-309"></a><span class="k">use </span><span class="n">math</span>
<a name="ln-310"></a>
<a name="ln-311"></a><span class="k">IMPLICIT NONE</span>
<a name="ln-312"></a>
<a name="ln-313"></a><span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">irg</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>            <span class="kd">::</span> <span class="n">N</span>
<a name="ln-314"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">dbl</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>               <span class="kd">::</span> <span class="n">k</span>
<a name="ln-315"></a><span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">irg</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">INOUT</span><span class="p">)</span>         <span class="kd">::</span> <span class="n">seed</span>
<a name="ln-316"></a><span class="kt">character</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>                 <span class="kd">::</span> <span class="n">Dtype</span>
<a name="ln-317"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">dbl</span><span class="p">)</span>                          <span class="kd">::</span> <span class="n">t</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
<a name="ln-318"></a>
<a name="ln-319"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">dbl</span><span class="p">)</span>                          <span class="kd">::</span> <span class="n">LBM</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">h</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">C</span>
<a name="ln-320"></a><span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">irg</span><span class="p">)</span>                       <span class="kd">::</span> <span class="n">i</span>
<a name="ln-321"></a>
<a name="ln-322"></a><span class="c">! Find the left bound and maximum needed for rejection sampling</span>
<a name="ln-323"></a><span class="n">C</span> <span class="o">=</span> <span class="mf">0.D0</span>
<a name="ln-324"></a><span class="n">LBM</span> <span class="o">=</span> <span class="n">getDDDensityLBM</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">C</span><span class="p">,</span> <span class="n">Dtype</span><span class="p">)</span>
<a name="ln-325"></a>
<a name="ln-326"></a><span class="c">! apply the rejection sampling algorithm to either VMF or Watson marginal distributions</span>
<a name="ln-327"></a><span class="n">t</span> <span class="o">=</span> <span class="mf">0.D0</span>
<a name="ln-328"></a><span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">N</span>
<a name="ln-329"></a>  <span class="k">do </span>
<a name="ln-330"></a><span class="k">    </span><span class="n">x</span> <span class="o">=</span> <span class="n">r8_uniform_01</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mf">1.D0</span><span class="o">-</span><span class="n">LBM</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="o">+</span><span class="n">LBM</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-331"></a>    <span class="k">if</span> <span class="p">(</span><span class="n">Dtype</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="s1">&#39;VMF&#39;</span><span class="p">)</span> <span class="n">h</span> <span class="o">=</span> <span class="n">VMFMeanDirDensity</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">C</span><span class="p">)</span>
<a name="ln-332"></a>    <span class="k">if</span> <span class="p">(</span><span class="n">Dtype</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="s1">&#39;WAT&#39;</span><span class="p">)</span> <span class="n">h</span> <span class="o">=</span> <span class="n">WatsonMeanDirDensity</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">C</span><span class="p">)</span>
<a name="ln-333"></a>    <span class="k">if</span> <span class="p">(</span><span class="n">r8_uniform_01</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span><span class="o">*</span><span class="n">LBM</span><span class="p">(</span><span class="mi">2</span><span class="p">).</span><span class="n">le</span><span class="p">.</span><span class="n">h</span><span class="p">)</span> <span class="k">EXIT </span>
<a name="ln-334"></a><span class="k">  end do</span>
<a name="ln-335"></a><span class="k">  </span><span class="n">t</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="n">x</span>
<a name="ln-336"></a><span class="k">end do </span>
<a name="ln-337"></a>
<a name="ln-338"></a><span class="k">end function </span><span class="n">randDDMarginal</span>
<a name="ln-339"></a>
<a name="ln-340"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-341"></a><span class="c">!</span>
<a name="ln-342"></a><span class="c">! FUNCTION: getDDDensityLBM</span>
<a name="ln-343"></a><span class="c">!</span>
<a name="ln-344"></a><span class="c">!&gt; @author Marc De Graef, Carnegie Mellon University / Yu-Hui Chen, U. Michigan</span>
<a name="ln-345"></a><span class="c">!</span>
<a name="ln-346"></a><span class="c">!&gt; @brief determines the left bound and maximum for rejection sampling</span>
<a name="ln-347"></a><span class="c">!</span>
<a name="ln-348"></a><span class="c">!&gt; @param k concentration</span>
<a name="ln-349"></a><span class="c">!&gt; @param C constant prefactor of distribution function</span>
<a name="ln-350"></a><span class="c">!&gt; @param Dtype &#39;VMF&#39; or &#39;WAT&#39;</span>
<a name="ln-351"></a><span class="c">!</span>
<a name="ln-352"></a><span class="c">!&gt; @date 01/07/15 MDG 1.0 original, based on Yu-Hui&#39;s Matlab code</span>
<a name="ln-353"></a><span class="c">!&gt; @date 02/05/15 MDG 1.1 consolidated routines for VMF and WAT distributions</span>
<a name="ln-354"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-355"></a><span class="k">recursive function </span><span class="n">getDDDensityLBM</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">C</span><span class="p">,</span><span class="n">Dtype</span><span class="p">)</span> <span class="k">result</span><span class="p">(</span><span class="n">LBM</span><span class="p">)</span>
<a name="ln-356"></a><span class="c">!DEC$ ATTRIBUTES DLLEXPORT :: getDDDensityLBM</span>
<a name="ln-357"></a><span class="k">use </span><span class="n">local</span>
<a name="ln-358"></a><span class="k">use </span><span class="n">error</span>
<a name="ln-359"></a>
<a name="ln-360"></a><span class="k">IMPLICIT NONE</span>
<a name="ln-361"></a>
<a name="ln-362"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">dbl</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>               <span class="kd">::</span> <span class="n">k</span>
<a name="ln-363"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">dbl</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">INOUT</span><span class="p">)</span>            <span class="kd">::</span> <span class="n">C</span>
<a name="ln-364"></a><span class="kt">character</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>                 <span class="kd">::</span> <span class="n">Dtype</span>
<a name="ln-365"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">dbl</span><span class="p">)</span>                          <span class="kd">::</span> <span class="n">LBM</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<a name="ln-366"></a>
<a name="ln-367"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">dbl</span><span class="p">),</span><span class="k">parameter</span>                <span class="kd">::</span> <span class="n">min_thresh</span><span class="o">=</span><span class="mf">0.00001D0</span>
<a name="ln-368"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">dbl</span><span class="p">)</span>                          <span class="kd">::</span> <span class="n">s</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">start</span>
<a name="ln-369"></a><span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">irg</span><span class="p">)</span>                       <span class="kd">::</span> <span class="n">f</span>
<a name="ln-370"></a>
<a name="ln-371"></a><span class="n">start</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.D0</span>
<a name="ln-372"></a><span class="k">if</span> <span class="p">(</span><span class="n">Dtype</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="s1">&#39;WAT&#39;</span><span class="p">)</span> <span class="n">start</span> <span class="o">=</span> <span class="mf">0.D0</span>
<a name="ln-373"></a>
<a name="ln-374"></a><span class="c">! first we look for the left bound</span>
<a name="ln-375"></a><span class="n">f</span> <span class="o">=</span> <span class="mi">1</span>
<a name="ln-376"></a><span class="k">do </span>
<a name="ln-377"></a><span class="k"> </span><span class="n">x</span> <span class="o">=</span> <span class="n">start</span><span class="o">+</span><span class="nb">dble</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">*</span><span class="mf">0.00001D0</span>
<a name="ln-378"></a> <span class="k">if</span> <span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mf">1.D0</span><span class="p">)</span> <span class="k">call </span><span class="n">FatalError</span><span class="p">(</span><span class="s1">&#39;getDDDensityLBM&#39;</span><span class="p">,</span><span class="s1">&#39;reached +1 in leftbound determination&#39;</span><span class="p">)</span>
<a name="ln-379"></a> <span class="k">if</span> <span class="p">(</span><span class="n">Dtype</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="s1">&#39;VMF&#39;</span><span class="p">)</span> <span class="n">s</span> <span class="o">=</span> <span class="n">VMFMeanDirDensity</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">C</span><span class="p">)</span>
<a name="ln-380"></a> <span class="k">if</span> <span class="p">(</span><span class="n">Dtype</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="s1">&#39;WAT&#39;</span><span class="p">)</span> <span class="n">s</span> <span class="o">=</span> <span class="n">WatsonMeanDirDensity</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">C</span><span class="p">)</span>
<a name="ln-381"></a> <span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">ge</span><span class="p">.</span><span class="n">min_thresh</span><span class="p">)</span> <span class="k">EXIT</span>
<a name="ln-382"></a><span class="k"> </span><span class="n">f</span> <span class="o">=</span> <span class="n">f</span><span class="o">+</span><span class="mi">1</span>
<a name="ln-383"></a><span class="k">end do</span>
<a name="ln-384"></a><span class="c">!</span>
<a name="ln-385"></a><span class="n">LBM</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span>  <span class="n">start</span><span class="o">+</span><span class="nb">dble</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">*</span><span class="mf">0.00001D0</span>
<a name="ln-386"></a>
<a name="ln-387"></a><span class="k">if</span> <span class="p">(</span><span class="n">Dtype</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="s1">&#39;VMF&#39;</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-388"></a><span class="c">! for the simplified version of the density function, we have an analytical</span>
<a name="ln-389"></a><span class="c">! expression for where the maximum of the function occurs [convert the BesselI(3/2,x)</span>
<a name="ln-390"></a><span class="c">! to hyperbolic functions, then to exponential, and ignore the negative exponential</span>
<a name="ln-391"></a><span class="c">! which will be very small for reasonably sized k and t...]</span>
<a name="ln-392"></a>  <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mf">1.D0</span><span class="o">+</span><span class="nb">dsqrt</span><span class="p">(</span><span class="mf">1.D0</span><span class="o">+</span><span class="mf">4.D0</span><span class="o">*</span><span class="n">k</span><span class="o">*</span><span class="n">k</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="mf">2.D0</span><span class="o">*</span><span class="n">k</span><span class="p">)</span>
<a name="ln-393"></a>  <span class="n">LBM</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">VMFMeanDirDensity</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">C</span><span class="p">)</span>
<a name="ln-394"></a><span class="k">end if</span>
<a name="ln-395"></a>
<a name="ln-396"></a><span class="k">if</span> <span class="p">(</span><span class="n">Dtype</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="s1">&#39;WAT&#39;</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-397"></a><span class="c">! for the simplified version of the density function, we have an analytical</span>
<a name="ln-398"></a><span class="c">! expression for where the maximum of the function occurs </span>
<a name="ln-399"></a>  <span class="n">x</span> <span class="o">=</span> <span class="nb">dsqrt</span><span class="p">((</span><span class="mf">2.D0</span><span class="o">*</span><span class="n">k</span><span class="o">-</span><span class="mf">1.D0</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mf">2.D0</span><span class="o">*</span><span class="n">k</span><span class="p">))</span>
<a name="ln-400"></a>  <span class="n">LBM</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">WatsonMeanDirDensity</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">C</span><span class="p">)</span>
<a name="ln-401"></a><span class="k">end if</span>
<a name="ln-402"></a>
<a name="ln-403"></a><span class="k">end function </span><span class="n">getDDDensityLBM</span>
<a name="ln-404"></a>
<a name="ln-405"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-406"></a><span class="c">!</span>
<a name="ln-407"></a><span class="c">! FUNCTION: VMFMeanDirDensity</span>
<a name="ln-408"></a><span class="c">!</span>
<a name="ln-409"></a><span class="c">!&gt; @author Marc De Graef, Carnegie Mellon University / Yu-Hui Chen, U. Michigan</span>
<a name="ln-410"></a><span class="c">!</span>
<a name="ln-411"></a><span class="c">!&gt; @brief function to be sampled for VMF random sampling; we&#39;re using a close approximation</span>
<a name="ln-412"></a><span class="c">!</span>
<a name="ln-413"></a><span class="c">!&gt; @param x argument value</span>
<a name="ln-414"></a><span class="c">!&gt; @param k concentration</span>
<a name="ln-415"></a><span class="c">!&gt; @param C constant prefactor</span>
<a name="ln-416"></a><span class="c">!</span>
<a name="ln-417"></a><span class="c">!&gt; @date 01/07/15 MDG 1.0 original, based on Yu-Hui&#39;s Matlab code</span>
<a name="ln-418"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-419"></a><span class="k">recursive function </span><span class="n">VMFMeanDirDensity</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">C</span><span class="p">)</span> <span class="k">result</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
<a name="ln-420"></a><span class="c">!DEC$ ATTRIBUTES DLLEXPORT :: VMFMeanDirDensity</span>
<a name="ln-421"></a>
<a name="ln-422"></a><span class="k">use </span><span class="n">local</span>
<a name="ln-423"></a><span class="k">use </span><span class="n">constants</span>
<a name="ln-424"></a><span class="k">use </span><span class="n">math</span>
<a name="ln-425"></a><span class="k">use </span><span class="n">error</span>
<a name="ln-426"></a>
<a name="ln-427"></a><span class="k">IMPLICIT NONE</span>
<a name="ln-428"></a>
<a name="ln-429"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">dbl</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>       <span class="kd">::</span> <span class="n">x</span>
<a name="ln-430"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">dbl</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>       <span class="kd">::</span> <span class="n">k</span>
<a name="ln-431"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">dbl</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">INOUT</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">C</span>
<a name="ln-432"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">dbl</span><span class="p">)</span>                  <span class="kd">::</span> <span class="n">y</span>
<a name="ln-433"></a>
<a name="ln-434"></a>
<a name="ln-435"></a><span class="k">if</span> <span class="p">(</span><span class="nb">dabs</span><span class="p">(</span><span class="n">x</span><span class="p">).</span><span class="n">gt</span><span class="p">.</span><span class="mf">1.D0</span><span class="p">)</span> <span class="k">call </span><span class="n">FatalError</span><span class="p">(</span><span class="s1">&#39;VMFMeanDirDensity&#39;</span><span class="p">,</span><span class="s1">&#39;argument must be in [-1,1]&#39;</span><span class="p">)</span>
<a name="ln-436"></a>
<a name="ln-437"></a><span class="c">! explicit expression for p=4 (Gamma[3/2]Gamma[1/2] = pi/2)</span>
<a name="ln-438"></a><span class="c">! and the BesselI(3/2) function reduces to hyperbolic functions</span>
<a name="ln-439"></a><span class="c">! diverges for k-&gt;0, and becomes really small for large k</span>
<a name="ln-440"></a><span class="k">if</span> <span class="p">(</span><span class="n">C</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mf">0.D0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-441"></a><span class="k">  </span><span class="n">C</span> <span class="o">=</span> <span class="mf">2.D0</span><span class="o">*</span><span class="n">k</span><span class="o">**</span><span class="p">(</span><span class="mf">2.5D0</span><span class="p">)</span><span class="o">/</span><span class="nb">dsqrt</span><span class="p">(</span><span class="mf">2.D0</span><span class="o">*</span><span class="n">cPi</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">k</span><span class="o">-</span><span class="mf">1.D0</span><span class="p">)</span>
<a name="ln-442"></a><span class="k">end if</span>
<a name="ln-443"></a>
<a name="ln-444"></a><span class="c">! this is a close approximation, really good for larger values of k</span>
<a name="ln-445"></a><span class="c">! and numerically more stable than the original, which has problems for k&gt;600 or so</span>
<a name="ln-446"></a><span class="n">y</span> <span class="o">=</span> <span class="n">C</span> <span class="o">*</span> <span class="nb">dexp</span><span class="p">(</span><span class="n">k</span><span class="o">*</span><span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="mf">1.D0</span><span class="p">))</span><span class="o">*</span><span class="nb">dsqrt</span><span class="p">(</span><span class="mf">1.D0</span><span class="o">-</span><span class="n">x</span><span class="o">*</span><span class="n">x</span><span class="p">)</span>
<a name="ln-447"></a>
<a name="ln-448"></a><span class="k">end function </span><span class="n">VMFMeanDirDensity</span>
<a name="ln-449"></a>
<a name="ln-450"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-451"></a><span class="c">!</span>
<a name="ln-452"></a><span class="c">! FUNCTION: WatsonMeanDirDensity</span>
<a name="ln-453"></a><span class="c">!</span>
<a name="ln-454"></a><span class="c">!&gt; @author Marc De Graef, Carnegie Mellon University</span>
<a name="ln-455"></a><span class="c">!</span>
<a name="ln-456"></a><span class="c">!&gt; @brief function to be sampled for Watson random sampling; we&#39;re using a close approximation</span>
<a name="ln-457"></a><span class="c">!</span>
<a name="ln-458"></a><span class="c">!&gt; @param x argument value</span>
<a name="ln-459"></a><span class="c">!&gt; @param k concentration</span>
<a name="ln-460"></a><span class="c">!&gt; @param C constant prefactor</span>
<a name="ln-461"></a><span class="c">!</span>
<a name="ln-462"></a><span class="c">!&gt; @date 02/05/15 MDG 1.0 original</span>
<a name="ln-463"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-464"></a><span class="k">recursive function </span><span class="n">WatsonMeanDirDensity</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">C</span><span class="p">)</span> <span class="k">result</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
<a name="ln-465"></a><span class="c">!DEC$ ATTRIBUTES DLLEXPORT :: WatsonMeanDirDensity</span>
<a name="ln-466"></a>
<a name="ln-467"></a><span class="k">use </span><span class="n">local</span>
<a name="ln-468"></a><span class="k">use </span><span class="n">constants</span>
<a name="ln-469"></a><span class="k">use </span><span class="n">math</span>
<a name="ln-470"></a><span class="k">use </span><span class="n">error</span>
<a name="ln-471"></a>
<a name="ln-472"></a><span class="k">IMPLICIT NONE</span>
<a name="ln-473"></a>
<a name="ln-474"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">dbl</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>       <span class="kd">::</span> <span class="n">x</span>
<a name="ln-475"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">dbl</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>       <span class="kd">::</span> <span class="n">k</span>
<a name="ln-476"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">dbl</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">INOUT</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">C</span>
<a name="ln-477"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">dbl</span><span class="p">)</span>                  <span class="kd">::</span> <span class="n">y</span>
<a name="ln-478"></a>
<a name="ln-479"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">dbl</span><span class="p">),</span><span class="k">parameter</span>        <span class="kd">::</span> <span class="n">CC</span> <span class="o">=</span> <span class="mi">14</span><span class="mf">4.43253338822560946D0</span>         <span class="c">! 256/sqrt(pi)</span>
<a name="ln-480"></a>
<a name="ln-481"></a>
<a name="ln-482"></a><span class="k">if</span> <span class="p">(</span><span class="nb">dabs</span><span class="p">(</span><span class="n">x</span><span class="p">).</span><span class="n">gt</span><span class="p">.</span><span class="mf">1.D0</span><span class="p">)</span> <span class="k">call </span><span class="n">FatalError</span><span class="p">(</span><span class="s1">&#39;WatsonMeanDirDensity&#39;</span><span class="p">,</span><span class="s1">&#39;argument must be in [-1,1]&#39;</span><span class="p">)</span>
<a name="ln-483"></a>
<a name="ln-484"></a><span class="c">! approximate expression for p=4 </span>
<a name="ln-485"></a><span class="k">if</span> <span class="p">(</span><span class="n">C</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mf">0.D0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-486"></a><span class="k">  </span><span class="n">C</span> <span class="o">=</span> <span class="n">CC</span><span class="o">*</span><span class="n">k</span><span class="o">**</span><span class="mf">4.5D0</span><span class="o">/</span><span class="p">(</span><span class="mi">52</span><span class="mf">5.D0</span><span class="o">+</span><span class="mf">4.D0</span><span class="o">*</span><span class="n">k</span><span class="o">*</span><span class="p">(</span><span class="mi">4</span><span class="mf">5.D0</span><span class="o">+</span><span class="mf">8.D0</span><span class="o">*</span><span class="n">k</span><span class="o">*</span><span class="p">(</span><span class="mf">3.D0</span><span class="o">+</span><span class="mf">4.D0</span><span class="o">*</span><span class="n">k</span><span class="p">)))</span>
<a name="ln-487"></a><span class="k">end if</span>
<a name="ln-488"></a>
<a name="ln-489"></a><span class="c">! this is a close approximation, really good for larger values of k</span>
<a name="ln-490"></a><span class="c">! and numerically more stable than the original, which has problems for k&gt;600 or so</span>
<a name="ln-491"></a><span class="n">y</span> <span class="o">=</span> <span class="n">C</span> <span class="o">*</span> <span class="nb">dexp</span><span class="p">(</span><span class="n">k</span><span class="o">*</span><span class="p">(</span><span class="n">x</span><span class="o">*</span><span class="n">x</span><span class="o">-</span><span class="mf">1.D0</span><span class="p">))</span><span class="o">*</span><span class="nb">dsqrt</span><span class="p">(</span><span class="mf">1.D0</span><span class="o">-</span><span class="n">x</span><span class="o">*</span><span class="n">x</span><span class="p">)</span>
<a name="ln-492"></a>
<a name="ln-493"></a><span class="k">end function </span><span class="n">WatsonMeanDirDensity</span>
<a name="ln-494"></a>
<a name="ln-495"></a>
<a name="ln-496"></a>
<a name="ln-497"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-498"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-499"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-500"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-501"></a><span class="c">! below we have a series of functions/subroutines used to index patterns based</span>
<a name="ln-502"></a><span class="c">! on the set of 40 or so closest matches in the dictionary; these routines perform</span>
<a name="ln-503"></a><span class="c">! an averaging on the quaternion unit sphere and return the mean direction and</span>
<a name="ln-504"></a><span class="c">! the concentration parameter for either the von Mises-Fisher or the axial Watson distribution.</span>
<a name="ln-505"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-506"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-507"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-508"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-509"></a><span class="c">!</span>
<a name="ln-510"></a><span class="c">! SUBROUTINE: DI_Init</span>
<a name="ln-511"></a><span class="c">!</span>
<a name="ln-512"></a><span class="c">!&gt; @author Marc De Graef, Carnegie Mellon University / Yu-Hui Chen, U. Michigan</span>
<a name="ln-513"></a><span class="c">!</span>
<a name="ln-514"></a><span class="c">!&gt; @brief initialize the dictionary indexing parameters (symmetry operators and precomputed Ap lookup table)</span>
<a name="ln-515"></a><span class="c">!</span>
<a name="ln-516"></a><span class="c">!&gt; @details For all details, see following paper:</span>
<a name="ln-517"></a><span class="c">!</span>
<a name="ln-518"></a><span class="c">!&gt; @param dict dictionary parameter (must be declared in calling routine)</span>
<a name="ln-519"></a><span class="c">!&gt; @param Dtype  &#39;VMF&#39; or &#39;WAT&#39; for von Mises-Fisher and Watson distributions, respectively.</span>
<a name="ln-520"></a><span class="c">!</span>
<a name="ln-521"></a><span class="c">!&gt; @date 12/31/14 MDG 1.0 original</span>
<a name="ln-522"></a><span class="c">!&gt; @date 01/06/15 MDG 1.1 added optional argument full</span>
<a name="ln-523"></a><span class="c">!&gt; @date 02/06/15 MDG 1.2 removed full again after extensive testing; no need to use 2M operators</span>
<a name="ln-524"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-525"></a><span class="k">recursive subroutine </span><span class="n">DI_Init</span><span class="p">(</span><span class="n">dict</span><span class="p">,</span><span class="n">Dtype</span><span class="p">)</span> 
<a name="ln-526"></a><span class="c">!DEC$ ATTRIBUTES DLLEXPORT :: DI_Init</span>
<a name="ln-527"></a>
<a name="ln-528"></a><span class="k">use </span><span class="n">local</span>
<a name="ln-529"></a><span class="k">use </span><span class="n">typedefs</span>
<a name="ln-530"></a><span class="k">use </span><span class="n">error</span>
<a name="ln-531"></a><span class="k">use </span><span class="n">math</span>
<a name="ln-532"></a>
<a name="ln-533"></a><span class="k">IMPLICIT NONE</span>
<a name="ln-534"></a>
<a name="ln-535"></a><span class="k">type</span><span class="p">(</span><span class="n">dicttype</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">INOUT</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">dict</span>
<a name="ln-536"></a><span class="kt">character</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>                 <span class="kd">::</span> <span class="n">Dtype</span>
<a name="ln-537"></a>
<a name="ln-538"></a><span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">irg</span><span class="p">)</span>                       <span class="kd">::</span> <span class="n">i</span>
<a name="ln-539"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">dbl</span><span class="p">)</span>                          <span class="kd">::</span> <span class="n">y1</span><span class="p">,</span> <span class="n">y2</span>
<a name="ln-540"></a>
<a name="ln-541"></a>
<a name="ln-542"></a><span class="c">! here we need to analyze the rotational symmetry group, and copy the appropriate </span>
<a name="ln-543"></a><span class="c">! quaternion symmetry operators into the dict%Pm array</span>
<a name="ln-544"></a>
<a name="ln-545"></a><span class="c">! first get the number of the rotational point group that corresponds to the crystal point group</span>
<a name="ln-546"></a><span class="n">dict</span><span class="p">%</span><span class="n">prot</span> <span class="o">=</span> <span class="n">PGrot</span><span class="p">(</span><span class="n">dict</span><span class="p">%</span><span class="n">pgnum</span><span class="p">)</span>
<a name="ln-547"></a><span class="c">! possible values for dict%prot are: (/1,3,6,9,12,16,18,21,24,28,30/)</span>
<a name="ln-548"></a><span class="c">! corresponding to the point groups 1, 2, 222, 4, 422, 3, 32, 6, 622, 23, and 432, respectively</span>
<a name="ln-549"></a>
<a name="ln-550"></a><span class="c">!------------</span>
<a name="ln-551"></a><span class="c">! IMPORTANT NOTE: the original von Mises-Fischer (VMF) approach requires that q and -q are considered to </span>
<a name="ln-552"></a><span class="c">! be separate quaternions, so the original Matlab code included the negatives of all quaternion symmetry operators </span>
<a name="ln-553"></a><span class="c">! as well, leading to a cardinality of twice the rotational point group order.  It appears that we do not have to</span>
<a name="ln-554"></a><span class="c">! do so if we replace the exponential in the VMF by a hyperbolic cosine function, which would account directly</span>
<a name="ln-555"></a><span class="c">! for the q, -q duplicity... Alternatively, one can use the axial Watson distribution.</span>
<a name="ln-556"></a><span class="c">!------------</span>
<a name="ln-557"></a>
<a name="ln-558"></a><span class="c">! identity operator is part of all point groups</span>
<a name="ln-559"></a><span class="n">dict</span><span class="p">%</span><span class="n">Pm</span> <span class="o">=</span> <span class="mf">0.D0</span>                  <span class="c">! initialize all entries to zero</span>
<a name="ln-560"></a><span class="n">dict</span><span class="p">%</span><span class="n">Pm</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">SYM_Qsymop</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-561"></a>
<a name="ln-562"></a><span class="c">! select statement for each individual rotational point group (see typedefs.f90 for SYM_Qsymop definitions)</span>
<a name="ln-563"></a><span class="k">select case</span> <span class="p">(</span><span class="n">dict</span><span class="p">%</span><span class="n">prot</span><span class="p">)</span> 
<a name="ln-564"></a>        <span class="k">case</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>         <span class="c">! 1 (no additional symmetry elements)</span>
<a name="ln-565"></a>                <span class="n">dict</span><span class="p">%</span><span class="n">Nqsym</span> <span class="o">=</span> <span class="mi">1</span>
<a name="ln-566"></a>                <span class="n">dict</span><span class="p">%</span><span class="n">Pm</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="n">dict</span><span class="p">%</span><span class="n">Pm</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-567"></a>
<a name="ln-568"></a>        <span class="k">case</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>         <span class="c">! 2  (we&#39;ll assume that the two-fold axis lies along the e_y-axis)</span>
<a name="ln-569"></a>                <span class="n">dict</span><span class="p">%</span><span class="n">Nqsym</span> <span class="o">=</span> <span class="mi">2</span>
<a name="ln-570"></a>                <span class="n">dict</span><span class="p">%</span><span class="n">Pm</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">SYM_Qsymop</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-571"></a>
<a name="ln-572"></a>        <span class="k">case</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>         <span class="c">! 222</span>
<a name="ln-573"></a>                <span class="n">dict</span><span class="p">%</span><span class="n">Nqsym</span> <span class="o">=</span> <span class="mi">4</span>
<a name="ln-574"></a>                <span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span>
<a name="ln-575"></a>                  <span class="n">dict</span><span class="p">%</span><span class="n">Pm</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="n">SYM_Qsymop</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
<a name="ln-576"></a>                <span class="k">end do</span>
<a name="ln-577"></a>
<a name="ln-578"></a><span class="k">        case</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span>         <span class="c">! 4</span>
<a name="ln-579"></a>                <span class="n">dict</span><span class="p">%</span><span class="n">Nqsym</span> <span class="o">=</span> <span class="mi">4</span>
<a name="ln-580"></a>                <span class="n">dict</span><span class="p">%</span><span class="n">Pm</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">SYM_Qsymop</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>
<a name="ln-581"></a>                <span class="n">dict</span><span class="p">%</span><span class="n">Pm</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">SYM_Qsymop</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span><span class="mi">7</span><span class="p">)</span>
<a name="ln-582"></a>                <span class="n">dict</span><span class="p">%</span><span class="n">Pm</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="n">SYM_Qsymop</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span>
<a name="ln-583"></a>
<a name="ln-584"></a>        <span class="k">case</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span>        <span class="c">! 422</span>
<a name="ln-585"></a>                <span class="n">dict</span><span class="p">%</span><span class="n">Nqsym</span> <span class="o">=</span> <span class="mi">8</span>
<a name="ln-586"></a>                <span class="n">dict</span><span class="p">%</span><span class="n">Pm</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">SYM_Qsymop</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>
<a name="ln-587"></a>                <span class="n">dict</span><span class="p">%</span><span class="n">Pm</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">SYM_Qsymop</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span><span class="mi">7</span><span class="p">)</span>
<a name="ln-588"></a>                <span class="n">dict</span><span class="p">%</span><span class="n">Pm</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="n">SYM_Qsymop</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span>
<a name="ln-589"></a>                <span class="n">dict</span><span class="p">%</span><span class="n">Pm</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="n">SYM_Qsymop</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
<a name="ln-590"></a>                <span class="n">dict</span><span class="p">%</span><span class="n">Pm</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span> <span class="o">=</span> <span class="n">SYM_Qsymop</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-591"></a>                <span class="n">dict</span><span class="p">%</span><span class="n">Pm</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span><span class="mi">7</span><span class="p">)</span> <span class="o">=</span> <span class="n">SYM_Qsymop</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span><span class="mi">11</span><span class="p">)</span>
<a name="ln-592"></a>                <span class="n">dict</span><span class="p">%</span><span class="n">Pm</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span><span class="mi">8</span><span class="p">)</span> <span class="o">=</span> <span class="n">SYM_Qsymop</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span><span class="mi">12</span><span class="p">)</span>
<a name="ln-593"></a>
<a name="ln-594"></a>        <span class="k">case</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span>        <span class="c">! 3</span>
<a name="ln-595"></a>                <span class="n">dict</span><span class="p">%</span><span class="n">Nqsym</span> <span class="o">=</span> <span class="mi">2</span>
<a name="ln-596"></a>                <span class="k">call </span><span class="n">FatalError</span><span class="p">(</span><span class="s1">&#39;InitDictionaryIndexing&#39;</span><span class="p">,</span><span class="s1">&#39;this symmetry has not yet been implemented (pg 3)&#39;</span><span class="p">)</span>
<a name="ln-597"></a>
<a name="ln-598"></a>        <span class="k">case</span><span class="p">(</span><span class="mi">18</span><span class="p">)</span>        <span class="c">! 32 (needs special handling)</span>
<a name="ln-599"></a>                <span class="n">dict</span><span class="p">%</span><span class="n">Nqsym</span> <span class="o">=</span> <span class="mi">2</span>
<a name="ln-600"></a>                <span class="k">call </span><span class="n">FatalError</span><span class="p">(</span><span class="s1">&#39;InitDictionaryIndexing&#39;</span><span class="p">,</span><span class="s1">&#39;this symmetry has not yet been implemented (pg 32)&#39;</span><span class="p">)</span>
<a name="ln-601"></a>
<a name="ln-602"></a>        <span class="k">case</span><span class="p">(</span><span class="mi">21</span><span class="p">)</span>        <span class="c">! 6</span>
<a name="ln-603"></a>                <span class="n">dict</span><span class="p">%</span><span class="n">Nqsym</span> <span class="o">=</span> <span class="mi">6</span>
<a name="ln-604"></a>                <span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span><span class="mi">29</span>
<a name="ln-605"></a>                  <span class="n">dict</span><span class="p">%</span><span class="n">Pm</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span><span class="n">i</span><span class="o">-</span><span class="mi">23</span><span class="p">)</span> <span class="o">=</span> <span class="n">SYM_Qsymop</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
<a name="ln-606"></a>                <span class="k">end do</span>
<a name="ln-607"></a>
<a name="ln-608"></a><span class="k">        case</span><span class="p">(</span><span class="mi">24</span><span class="p">)</span>        <span class="c">! 622</span>
<a name="ln-609"></a>                <span class="n">dict</span><span class="p">%</span><span class="n">Nqsym</span> <span class="o">=</span> <span class="mi">12</span>
<a name="ln-610"></a>                <span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span><span class="mi">35</span>
<a name="ln-611"></a>                  <span class="n">dict</span><span class="p">%</span><span class="n">Pm</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span><span class="n">i</span><span class="o">-</span><span class="mi">23</span><span class="p">)</span> <span class="o">=</span> <span class="n">SYM_Qsymop</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
<a name="ln-612"></a>                <span class="k">end do</span>
<a name="ln-613"></a>
<a name="ln-614"></a><span class="k">        case</span><span class="p">(</span><span class="mi">28</span><span class="p">)</span>        <span class="c">! 23</span>
<a name="ln-615"></a>                <span class="n">dict</span><span class="p">%</span><span class="n">Nqsym</span> <span class="o">=</span> <span class="mi">12</span>
<a name="ln-616"></a>                <span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span>
<a name="ln-617"></a>                  <span class="n">dict</span><span class="p">%</span><span class="n">Pm</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="n">SYM_Qsymop</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
<a name="ln-618"></a>                <span class="k">end do</span>
<a name="ln-619"></a><span class="k">                do </span><span class="n">i</span><span class="o">=</span><span class="mi">17</span><span class="p">,</span><span class="mi">24</span>
<a name="ln-620"></a>                  <span class="n">dict</span><span class="p">%</span><span class="n">Pm</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="o">+</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">16</span><span class="p">))</span> <span class="o">=</span> <span class="n">SYM_Qsymop</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
<a name="ln-621"></a>                <span class="k">end do</span>
<a name="ln-622"></a>
<a name="ln-623"></a><span class="k">        case</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span>        <span class="c">! 432</span>
<a name="ln-624"></a>                <span class="n">dict</span><span class="p">%</span><span class="n">Nqsym</span> <span class="o">=</span> <span class="mi">24</span>
<a name="ln-625"></a>                <span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="mi">24</span>
<a name="ln-626"></a>                  <span class="n">dict</span><span class="p">%</span><span class="n">Pm</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="n">SYM_Qsymop</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
<a name="ln-627"></a>                <span class="k">end do</span>
<a name="ln-628"></a>
<a name="ln-629"></a><span class="k">        case </span><span class="n">default</span>    <span class="c">! this should never happen ...</span>
<a name="ln-630"></a>                <span class="k">call </span><span class="n">FatalError</span><span class="p">(</span><span class="s1">&#39;InitDictionaryIndexing&#39;</span><span class="p">,</span><span class="s1">&#39;unknown rotational point group number&#39;</span><span class="p">)</span>
<a name="ln-631"></a><span class="k">end select</span>
<a name="ln-632"></a>
<a name="ln-633"></a><span class="c">! von Mises-Fisher mode:</span>
<a name="ln-634"></a><span class="c">! the next part of the initial Matlab code computes a lookup table for the parameter Ap(u) (Appendix in paper)</span>
<a name="ln-635"></a><span class="c">! this lookup table is only used when the ratio of the BesselI functions is between 0 and 0.95; for the </span>
<a name="ln-636"></a><span class="c">! region between 0.95 and 1, we use an analytical approximation (see VMF_Mstep routine).</span>
<a name="ln-637"></a><span class="c">!</span>
<a name="ln-638"></a><span class="c">! Watson mode:</span>
<a name="ln-639"></a><span class="c">! we&#39;ve used a similar approach to create a lookup table for values of kappa that are smaller than 35, in</span>
<a name="ln-640"></a><span class="c">! which case we use the standard ratio of Kummer functions:  Kummer[3/2,3,k]/Kummer[1/2,2,k]/k.  For</span>
<a name="ln-641"></a><span class="c">! larger kappa values, we have an expansion using the large argument behavior of the modified Bessel functions.</span>
<a name="ln-642"></a><span class="c">! </span>
<a name="ln-643"></a><span class="n">dict</span><span class="p">%</span><span class="n">Apnum</span> <span class="o">=</span> <span class="mi">35000</span>
<a name="ln-644"></a><span class="k">allocate</span><span class="p">(</span><span class="n">dict</span><span class="p">%</span><span class="n">xAp</span><span class="p">(</span><span class="n">dict</span><span class="p">%</span><span class="n">Apnum</span><span class="p">),</span> <span class="n">dict</span><span class="p">%</span><span class="n">yAp</span><span class="p">(</span><span class="n">dict</span><span class="p">%</span><span class="n">Apnum</span><span class="p">))</span>
<a name="ln-645"></a>
<a name="ln-646"></a>  <span class="c">! define the xAp array</span>
<a name="ln-647"></a><span class="n">dict</span><span class="p">%</span><span class="n">xAp</span> <span class="o">=</span> <span class="p">(</span><span class="o">/</span> <span class="p">(</span><span class="mf">0.001D0</span><span class="o">+</span><span class="nb">dble</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mf">0.001D0</span><span class="p">,</span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">dict</span><span class="p">%</span><span class="n">Apnum</span><span class="p">)</span>  <span class="o">/</span><span class="p">)</span>
<a name="ln-648"></a>
<a name="ln-649"></a><span class="k">if</span> <span class="p">(</span><span class="n">Dtype</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="s1">&#39;VMF&#39;</span><span class="p">)</span> <span class="k">then</span> <span class="c">! von Mises-Fisher distribution</span>
<a name="ln-650"></a>  <span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">dict</span><span class="p">%</span><span class="n">Apnum</span>
<a name="ln-651"></a>    <span class="n">dict</span><span class="p">%</span><span class="n">yAp</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="n">BesselIn</span><span class="p">(</span><span class="n">dict</span><span class="p">%</span><span class="n">xAp</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">BesselI1</span><span class="p">(</span><span class="n">dict</span><span class="p">%</span><span class="n">xAp</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
<a name="ln-652"></a>  <span class="k">end do</span>
<a name="ln-653"></a><span class="k">end if</span>
<a name="ln-654"></a>
<a name="ln-655"></a><span class="k">if</span> <span class="p">(</span><span class="n">Dtype</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="s1">&#39;WAT&#39;</span><span class="p">)</span> <span class="k">then</span> <span class="c">! Watson distribution</span>
<a name="ln-656"></a>  <span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">dict</span><span class="p">%</span><span class="n">Apnum</span>
<a name="ln-657"></a>    <span class="n">y1</span> <span class="o">=</span> <span class="n">BesselI1</span><span class="p">(</span><span class="n">dict</span><span class="p">%</span><span class="n">xAp</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">*</span><span class="mf">0.5D0</span><span class="p">)</span>
<a name="ln-658"></a>    <span class="n">y2</span> <span class="o">=</span> <span class="n">BesselI0</span><span class="p">(</span><span class="n">dict</span><span class="p">%</span><span class="n">xAp</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">*</span><span class="mf">0.5D0</span><span class="p">)</span>
<a name="ln-659"></a>    <span class="n">dict</span><span class="p">%</span><span class="n">yAp</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="n">y1</span> <span class="o">/</span> <span class="p">(</span><span class="n">y2</span><span class="o">-</span><span class="n">y1</span><span class="p">)</span> <span class="o">/</span> <span class="n">dict</span><span class="p">%</span><span class="n">xAp</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
<a name="ln-660"></a>  <span class="k">end do</span>
<a name="ln-661"></a><span class="k">end if</span>
<a name="ln-662"></a>
<a name="ln-663"></a><span class="k">end subroutine </span><span class="n">DI_Init</span>
<a name="ln-664"></a>
<a name="ln-665"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-666"></a><span class="c">!</span>
<a name="ln-667"></a><span class="c">! SUBROUTINE: DI_EMforDD</span>
<a name="ln-668"></a><span class="c">!</span>
<a name="ln-669"></a><span class="c">!&gt; @author Yu-Hui Chen, U. Michigan / Marc De Graef, Carnegie Mellon University</span>
<a name="ln-670"></a><span class="c">!</span>
<a name="ln-671"></a><span class="c">!&gt; @brief Expectation maximization approach to maximum likelihood problem for mu and kappa</span>
<a name="ln-672"></a><span class="c">!</span>
<a name="ln-673"></a><span class="c">!&gt; @details For all details, see following paper:</span>
<a name="ln-674"></a><span class="c">!</span>
<a name="ln-675"></a><span class="c">!&gt; @param X list of input quaternions</span>
<a name="ln-676"></a><span class="c">!&gt; @param dict dictionary parameter (must be declared in calling routine)</span>
<a name="ln-677"></a><span class="c">!&gt; @param nums number of input quaternions</span>
<a name="ln-678"></a><span class="c">!&gt; @param seed for normal random number generator </span>
<a name="ln-679"></a><span class="c">!&gt; @param muhat output mean orientation</span>
<a name="ln-680"></a><span class="c">!&gt; @param kappahat output concentration parameter</span>
<a name="ln-681"></a><span class="c">!&gt; @param Dtype &#39;VMF&#39; or &#39;WAT&#39;</span>
<a name="ln-682"></a><span class="c">!</span>
<a name="ln-683"></a><span class="c">!&gt; @date 01/01/15 MDG 1.0 original, based on Chen&#39;s Matlab version + simplifications</span>
<a name="ln-684"></a><span class="c">!&gt; @date 01/06/15 MDG 1.1 added optional argument full</span>
<a name="ln-685"></a><span class="c">!&gt; @date 02/06/15 MDG 1.2 removed full again, added Dtype and streamlined code; removed duplications</span>
<a name="ln-686"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-687"></a><span class="k">recursive subroutine </span><span class="n">DI_EMforDD</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">dict</span><span class="p">,</span> <span class="n">nums</span><span class="p">,</span> <span class="n">seed</span><span class="p">,</span> <span class="n">muhat</span><span class="p">,</span> <span class="n">kappahat</span><span class="p">,</span> <span class="n">Dtype</span><span class="p">)</span>
<a name="ln-688"></a><span class="c">!DEC$ ATTRIBUTES DLLEXPORT :: DI_EMforDD</span>
<a name="ln-689"></a>
<a name="ln-690"></a><span class="k">use </span><span class="n">local</span>
<a name="ln-691"></a><span class="k">use </span><span class="n">constants</span>
<a name="ln-692"></a><span class="k">use </span><span class="n">typedefs</span>
<a name="ln-693"></a><span class="k">use </span><span class="n">math</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span><span class="n">r8vec_normal_01</span><span class="p">,</span> <span class="n">r4_uniform_01</span>          <span class="c">! array of normal random numbers</span>
<a name="ln-694"></a><span class="k">use </span><span class="n">quaternions</span>
<a name="ln-695"></a><span class="k">use </span><span class="n">rotations</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span><span class="n">qu2ro</span>               <span class="c">! we only need to move to Rodrigues-Frank space</span>
<a name="ln-696"></a><span class="k">use </span><span class="n">so3</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span><span class="n">IsinsideFZ</span>                <span class="c">! we only need to do a test ...</span>
<a name="ln-697"></a>
<a name="ln-698"></a><span class="k">IMPLICIT NONE</span>
<a name="ln-699"></a>
<a name="ln-700"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">dbl</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>               <span class="kd">::</span> <span class="n">X</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="n">nums</span><span class="p">)</span>
<a name="ln-701"></a><span class="k">type</span><span class="p">(</span><span class="n">dicttype</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">INOUT</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">dict</span>
<a name="ln-702"></a><span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">irg</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>            <span class="kd">::</span> <span class="n">nums</span>
<a name="ln-703"></a><span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">irg</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">INOUT</span><span class="p">)</span>         <span class="kd">::</span> <span class="n">seed</span>
<a name="ln-704"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">dbl</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">OUT</span><span class="p">)</span>              <span class="kd">::</span> <span class="n">muhat</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<a name="ln-705"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">dbl</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">OUT</span><span class="p">)</span>              <span class="kd">::</span> <span class="n">kappahat</span>
<a name="ln-706"></a><span class="kt">character</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>                 <span class="kd">::</span> <span class="n">Dtype</span>
<a name="ln-707"></a>
<a name="ln-708"></a><span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">irg</span><span class="p">)</span>                       <span class="kd">::</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">Pmdims</span><span class="p">,</span> <span class="n">init</span><span class="p">,</span> <span class="n">dd</span>
<a name="ln-709"></a><span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">irg</span><span class="p">)</span>                       <span class="kd">::</span> <span class="n">FZtype</span><span class="p">,</span> <span class="n">FZorder</span>
<a name="ln-710"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">dbl</span><span class="p">),</span><span class="k">allocatable</span>              <span class="kd">::</span> <span class="n">Mu_All</span><span class="p">(:,:),</span> <span class="n">Kappa_All</span><span class="p">(:),</span> <span class="n">R_All</span><span class="p">(:,:,:),</span> <span class="n">L_All</span><span class="p">(:),</span> <span class="p">&amp;</span>
<a name="ln-711"></a>                                           <span class="n">R</span><span class="p">(:,:),</span> <span class="n">Q</span><span class="p">(:),</span> <span class="n">L</span><span class="p">(:)</span>
<a name="ln-712"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">dbl</span><span class="p">)</span>                          <span class="kd">::</span> <span class="n">Mu</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="n">PmMu</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="n">MuKa</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span> <span class="n">Qi</span><span class="p">,</span> <span class="n">Li</span><span class="p">,</span> <span class="n">rod</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="n">qu</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="n">Kappa</span>
<a name="ln-713"></a>
<a name="ln-714"></a><span class="c">! In this routine, we perform the EM algorithm to obtain an estimate for the </span>
<a name="ln-715"></a><span class="c">! mean direction and concentration parameter of the modified von Mises-Fisher (mVMF)</span>
<a name="ln-716"></a><span class="c">! distribution that models the statistics of the orientation point cloud.</span>
<a name="ln-717"></a>
<a name="ln-718"></a><span class="c">! array sizes (we use shorthand notations)</span>
<a name="ln-719"></a><span class="n">N</span> <span class="o">=</span> <span class="n">nums</span>
<a name="ln-720"></a><span class="n">Pmdims</span> <span class="o">=</span> <span class="n">dict</span><span class="p">%</span><span class="n">Nqsym</span>
<a name="ln-721"></a>
<a name="ln-722"></a><span class="c">! initialize some auxiliary arrays</span>
<a name="ln-723"></a><span class="k">allocate</span><span class="p">(</span><span class="n">Mu_All</span><span class="p">(</span><span class="n">dict</span><span class="p">%</span><span class="n">Num_of_init</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span> <span class="n">Kappa_All</span><span class="p">(</span><span class="n">dict</span><span class="p">%</span><span class="n">Num_of_init</span><span class="p">),</span> <span class="p">&amp;</span>
<a name="ln-724"></a>         <span class="n">R_All</span><span class="p">(</span><span class="n">N</span><span class="p">,</span><span class="n">Pmdims</span><span class="p">,</span><span class="n">dict</span><span class="p">%</span><span class="n">Num_of_init</span><span class="p">),</span><span class="n">L_All</span><span class="p">(</span><span class="n">dict</span><span class="p">%</span><span class="n">num_of_init</span><span class="p">))</span>
<a name="ln-725"></a><span class="n">Mu_All</span> <span class="o">=</span> <span class="mf">0.D0</span>
<a name="ln-726"></a><span class="n">Kappa_All</span> <span class="o">=</span> <span class="mf">0.D0</span>
<a name="ln-727"></a><span class="n">R_All</span> <span class="o">=</span> <span class="mf">0.D0</span>
<a name="ln-728"></a><span class="n">L_All</span> <span class="o">=</span> <span class="mf">0.D0</span>
<a name="ln-729"></a>
<a name="ln-730"></a>
<a name="ln-731"></a><span class="c">! main loop (EM typically uses a few starting parameter sets to make sure we don&#39;t get stuck in a local maximum)</span>
<a name="ln-732"></a><span class="k">do </span><span class="n">init</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">dict</span><span class="p">%</span><span class="n">Num_of_init</span> 
<a name="ln-733"></a><span class="c">! create a vector to hold the results</span>
<a name="ln-734"></a>  <span class="k">allocate</span><span class="p">(</span><span class="n">R</span><span class="p">(</span><span class="n">N</span><span class="p">,</span><span class="n">Pmdims</span><span class="p">))</span>
<a name="ln-735"></a>  <span class="n">R</span> <span class="o">=</span> <span class="mf">0.D0</span>
<a name="ln-736"></a>
<a name="ln-737"></a><span class="c">! generate a normal random vector and normalize it as a starting guess for Mu (i.e., a unit quaternion)</span>
<a name="ln-738"></a>  <span class="k">call </span><span class="n">R8VEC_normal_01</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="n">seed</span><span class="p">,</span><span class="n">Mu</span><span class="p">)</span>
<a name="ln-739"></a>  <span class="n">Mu</span> <span class="o">=</span> <span class="n">Mu</span><span class="o">/</span><span class="nb">cabs</span><span class="p">(</span><span class="n">Mu</span><span class="p">)</span>
<a name="ln-740"></a>
<a name="ln-741"></a><span class="c">! the EMsoft package only considers quaternions with positive first component, </span>
<a name="ln-742"></a><span class="c">! so we may need to change all the signs</span>
<a name="ln-743"></a>  <span class="k">if</span> <span class="p">(</span><span class="n">Mu</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="n">lt</span><span class="p">.</span><span class="mf">0.D0</span><span class="p">)</span> <span class="n">Mu</span> <span class="o">=</span> <span class="o">-</span><span class="n">Mu</span>
<a name="ln-744"></a>
<a name="ln-745"></a><span class="c">! starting value for Kappa</span>
<a name="ln-746"></a>  <span class="n">Kappa</span> <span class="o">=</span> <span class="mi">3</span><span class="mf">0.D0</span>
<a name="ln-747"></a>
<a name="ln-748"></a><span class="c">! define the number of iterations and the Q and L function arrays</span>
<a name="ln-749"></a>  <span class="k">allocate</span> <span class="p">(</span><span class="n">Q</span><span class="p">(</span><span class="n">dict</span><span class="p">%</span><span class="n">Num_of_iterations</span><span class="p">),</span> <span class="n">L</span><span class="p">(</span><span class="n">dict</span><span class="p">%</span><span class="n">Num_of_iterations</span><span class="p">))</span>
<a name="ln-750"></a>  <span class="n">Q</span> <span class="o">=</span> <span class="mf">0.D0</span>
<a name="ln-751"></a>  <span class="n">L</span> <span class="o">=</span> <span class="mf">0.D0</span>
<a name="ln-752"></a>
<a name="ln-753"></a><span class="c">! and here we go with the EM iteration...</span>
<a name="ln-754"></a><span class="c">! we use quaternion multiplication throughout instead of the matrix version in the Matlab version</span>
<a name="ln-755"></a><span class="c">! quaternion multiplication has been verified against the 4x4 matrix multiplication of the Matlab code on 01/02/15 </span>
<a name="ln-756"></a>  <span class="n">iloop</span><span class="p">:</span> <span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">dict</span><span class="p">%</span><span class="n">Num_of_iterations</span> 
<a name="ln-757"></a><span class="c">! E-step</span>
<a name="ln-758"></a>    <span class="n">R</span> <span class="o">=</span> <span class="n">DD_Estep</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">dict</span><span class="p">,</span><span class="n">Pmdims</span><span class="p">,</span><span class="n">N</span><span class="p">,</span><span class="n">Mu</span><span class="p">,</span><span class="n">Kappa</span><span class="p">,</span><span class="n">Dtype</span><span class="p">)</span>
<a name="ln-759"></a><span class="c">! M-step</span>
<a name="ln-760"></a>    <span class="n">MuKa</span> <span class="o">=</span> <span class="n">DD_Mstep</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">dict</span><span class="p">,</span><span class="n">Pmdims</span><span class="p">,</span><span class="n">N</span><span class="p">,</span><span class="n">R</span><span class="p">,</span><span class="n">Dtype</span><span class="p">)</span>
<a name="ln-761"></a><span class="c">! calculate the Q and Likelihood function values</span>
<a name="ln-762"></a>    <span class="k">call </span><span class="n">DD_getQandL</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">dict</span><span class="p">,</span><span class="n">Pmdims</span><span class="p">,</span><span class="n">nums</span><span class="p">,</span><span class="n">MuKa</span><span class="p">,</span><span class="n">R</span><span class="p">,</span><span class="n">Qi</span><span class="p">,</span><span class="n">Li</span><span class="p">,</span><span class="n">Dtype</span><span class="p">)</span>
<a name="ln-763"></a>    <span class="n">L</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="n">Li</span>
<a name="ln-764"></a>    <span class="n">Q</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="n">Qi</span>
<a name="ln-765"></a>
<a name="ln-766"></a><span class="c">! update the containers</span>
<a name="ln-767"></a>    <span class="n">Mu_All</span><span class="p">(</span><span class="n">init</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="n">MuKa</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">)</span>
<a name="ln-768"></a>    <span class="n">Kappa_All</span><span class="p">(</span><span class="n">init</span><span class="p">)</span> <span class="o">=</span> <span class="n">MuKa</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<a name="ln-769"></a>    <span class="n">R_All</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">N</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">Pmdims</span><span class="p">,</span><span class="n">init</span><span class="p">)</span> <span class="o">=</span> <span class="n">R</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">N</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">Pmdims</span><span class="p">)</span>
<a name="ln-770"></a>    <span class="n">L_All</span><span class="p">(</span><span class="n">init</span><span class="p">)</span> <span class="o">=</span> <span class="n">L</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
<a name="ln-771"></a>    <span class="n">Mu</span> <span class="o">=</span> <span class="n">MuKa</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">)</span>
<a name="ln-772"></a>    <span class="n">Kappa</span> <span class="o">=</span> <span class="n">MuKa</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<a name="ln-773"></a>
<a name="ln-774"></a><span class="c">! and terminate if necessary</span>
<a name="ln-775"></a>    <span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="p">.</span><span class="n">ge</span><span class="p">.</span><span class="mi">2</span><span class="p">)</span> <span class="k">then </span>
<a name="ln-776"></a><span class="k">      if</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">Q</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">-</span><span class="n">Q</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">)).</span><span class="n">lt</span><span class="p">.</span><span class="mf">0.01</span><span class="p">)</span> <span class="k">then </span>
<a name="ln-777"></a><span class="k">        EXIT </span><span class="n">iloop</span>
<a name="ln-778"></a>      <span class="k">end if</span>
<a name="ln-779"></a><span class="k">    end if</span>
<a name="ln-780"></a><span class="k">  end do </span><span class="n">iloop</span>
<a name="ln-781"></a>  <span class="k">deallocate</span><span class="p">(</span><span class="n">R</span><span class="p">,</span><span class="n">Q</span><span class="p">,</span><span class="n">L</span><span class="p">)</span>
<a name="ln-782"></a><span class="k">end do</span>
<a name="ln-783"></a>
<a name="ln-784"></a><span class="n">dd</span> <span class="o">=</span> <span class="nb">maxloc</span><span class="p">(</span><span class="n">L_All</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-785"></a><span class="n">Mu</span> <span class="o">=</span> <span class="n">Mu_all</span><span class="p">(</span><span class="n">dd</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">)</span>
<a name="ln-786"></a><span class="n">kappahat</span> <span class="o">=</span> <span class="n">Kappa_All</span><span class="p">(</span><span class="n">dd</span><span class="p">)</span>
<a name="ln-787"></a>
<a name="ln-788"></a><span class="c">! the EMsoft package only considers quaternions with positive first component, </span>
<a name="ln-789"></a><span class="c">! so we may need to change all the signs</span>
<a name="ln-790"></a><span class="k">if</span> <span class="p">(</span><span class="n">Mu</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="n">lt</span><span class="p">.</span><span class="mf">0.D0</span><span class="p">)</span> <span class="n">Mu</span> <span class="o">=</span> <span class="o">-</span><span class="n">Mu</span>
<a name="ln-791"></a>
<a name="ln-792"></a><span class="c">! the final step is to make sure that the resulting Mu lies in the same</span>
<a name="ln-793"></a><span class="c">! fundamental zone that the dictionary elements are located in; since we start</span>
<a name="ln-794"></a><span class="c">! the EM iterations from a random quaternion, there is no guarantee that the </span>
<a name="ln-795"></a><span class="c">! result lies in the same fundamental zone. Therefore, we cycle through all the </span>
<a name="ln-796"></a><span class="c">! equivalent quaternions, and stop as soon as we find one in the Rodrigues </span>
<a name="ln-797"></a><span class="c">! fundamental zone, which requires routines from the rotations and so3 modules. </span>
<a name="ln-798"></a><span class="n">FZtype</span> <span class="o">=</span> <span class="n">FZtarray</span><span class="p">(</span><span class="n">dict</span><span class="p">%</span><span class="n">pgnum</span><span class="p">)</span>
<a name="ln-799"></a><span class="n">FZorder</span> <span class="o">=</span> <span class="n">FZoarray</span><span class="p">(</span><span class="n">dict</span><span class="p">%</span><span class="n">pgnum</span><span class="p">)</span>
<a name="ln-800"></a>
<a name="ln-801"></a><span class="n">FZloop</span><span class="p">:</span> <span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">Pmdims</span>
<a name="ln-802"></a>  <span class="n">qu</span> <span class="o">=</span> <span class="n">quat_mult</span><span class="p">(</span><span class="n">Mu</span><span class="p">,</span><span class="n">dict</span><span class="p">%</span><span class="n">Pm</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span><span class="n">i</span><span class="p">))</span>
<a name="ln-803"></a>  <span class="k">if</span> <span class="p">(</span><span class="n">qu</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="n">lt</span><span class="p">.</span><span class="mf">0.D0</span><span class="p">)</span> <span class="n">qu</span> <span class="o">=</span> <span class="o">-</span><span class="n">qu</span>
<a name="ln-804"></a>  <span class="n">rod</span> <span class="o">=</span> <span class="n">qu2ro</span><span class="p">(</span><span class="n">qu</span><span class="p">)</span>
<a name="ln-805"></a>  <span class="k">if</span> <span class="p">(</span><span class="n">IsinsideFZ</span><span class="p">(</span><span class="n">rod</span><span class="p">,</span><span class="n">FZtype</span><span class="p">,</span><span class="n">FZorder</span><span class="p">))</span> <span class="k">EXIT </span><span class="n">FZloop</span>
<a name="ln-806"></a><span class="k">end do </span><span class="n">FZloop</span>
<a name="ln-807"></a><span class="n">muhat</span> <span class="o">=</span> <span class="n">qu</span>
<a name="ln-808"></a>
<a name="ln-809"></a><span class="k">deallocate</span><span class="p">(</span><span class="n">Mu_All</span><span class="p">,</span> <span class="n">Kappa_All</span><span class="p">,</span> <span class="n">R_All</span><span class="p">,</span> <span class="n">L_All</span><span class="p">)</span>
<a name="ln-810"></a>
<a name="ln-811"></a><span class="k">end subroutine </span><span class="n">DI_EMforDD</span>
<a name="ln-812"></a>
<a name="ln-813"></a>
<a name="ln-814"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-815"></a><span class="c">!</span>
<a name="ln-816"></a><span class="c">! FUNCTION: DD_Estep</span>
<a name="ln-817"></a><span class="c">!</span>
<a name="ln-818"></a><span class="c">!&gt; @author Marc De Graef, Carnegie Mellon University / Yu-Hui Chen, U. Michigan</span>
<a name="ln-819"></a><span class="c">!</span>
<a name="ln-820"></a><span class="c">!&gt; @brief computes the E step of the EM process, verified against Matlab code on 01/02/15</span>
<a name="ln-821"></a><span class="c">!</span>
<a name="ln-822"></a><span class="c">!&gt; @param X list of input quaternions</span>
<a name="ln-823"></a><span class="c">!&gt; @param dict dictionary type</span>
<a name="ln-824"></a><span class="c">!&gt; @param Pmdims number of quaternion symmetry operators</span>
<a name="ln-825"></a><span class="c">!&gt; @param nums number of samples</span>
<a name="ln-826"></a><span class="c">!&gt; @param Mu current guess for mean quaternion</span>
<a name="ln-827"></a><span class="c">!&gt; @param Kappa input parameter</span>
<a name="ln-828"></a><span class="c">!</span>
<a name="ln-829"></a><span class="c">!&gt; @date 01/01/15 MDG 1.0 original</span>
<a name="ln-830"></a><span class="c">!&gt; @date 01/06/15 MDG 1.1 added optional argument full</span>
<a name="ln-831"></a><span class="c">!&gt; @date 01/09/15 MDG 1.2 removed optional argument full (incorporated in dicttype)</span>
<a name="ln-832"></a><span class="c">!&gt; @date 02/06/15 MDG 1.3 removed full handling after extensive checking</span>
<a name="ln-833"></a><span class="c">!&gt; @date 02/06/15 MDG 1.4 merged VMF and Watson Esteps into a single routine and renamed</span>
<a name="ln-834"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-835"></a><span class="k">recursive function </span><span class="n">DD_Estep</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">dict</span><span class="p">,</span><span class="n">Pmdims</span><span class="p">,</span><span class="n">nums</span><span class="p">,</span><span class="n">Mu</span><span class="p">,</span><span class="n">Kappa</span><span class="p">,</span><span class="n">Dtype</span><span class="p">)</span> <span class="k">result</span><span class="p">(</span><span class="n">R</span><span class="p">)</span>
<a name="ln-836"></a><span class="c">!DEC$ ATTRIBUTES DLLEXPORT :: DD_Estep</span>
<a name="ln-837"></a>
<a name="ln-838"></a><span class="k">use </span><span class="n">local</span>
<a name="ln-839"></a><span class="k">use </span><span class="n">typedefs</span>
<a name="ln-840"></a><span class="k">use </span><span class="n">quaternions</span>
<a name="ln-841"></a>
<a name="ln-842"></a><span class="k">IMPLICIT NONE</span>
<a name="ln-843"></a>
<a name="ln-844"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">dbl</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>               <span class="kd">::</span> <span class="n">X</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="n">nums</span><span class="p">)</span>
<a name="ln-845"></a><span class="k">type</span><span class="p">(</span><span class="n">dicttype</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>       <span class="kd">::</span> <span class="n">dict</span>
<a name="ln-846"></a><span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">irg</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>            <span class="kd">::</span> <span class="n">Pmdims</span>
<a name="ln-847"></a><span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">irg</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>            <span class="kd">::</span> <span class="n">nums</span>
<a name="ln-848"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">dbl</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>               <span class="kd">::</span> <span class="n">Mu</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<a name="ln-849"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">dbl</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>               <span class="kd">::</span> <span class="n">Kappa</span>
<a name="ln-850"></a><span class="kt">character</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>                 <span class="kd">::</span> <span class="n">Dtype</span>
<a name="ln-851"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">dbl</span><span class="p">)</span>                          <span class="kd">::</span> <span class="n">R</span><span class="p">(</span><span class="n">nums</span><span class="p">,</span><span class="n">Pmdims</span><span class="p">)</span>
<a name="ln-852"></a>
<a name="ln-853"></a><span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">irg</span><span class="p">)</span>                       <span class="kd">::</span> <span class="n">j</span> 
<a name="ln-854"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">dbl</span><span class="p">)</span>                          <span class="kd">::</span> <span class="n">Rdenom</span><span class="p">(</span><span class="n">nums</span><span class="p">),</span> <span class="n">PmMu</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="n">C</span>
<a name="ln-855"></a>
<a name="ln-856"></a><span class="n">C</span> <span class="o">=</span> <span class="n">logCp</span><span class="p">(</span><span class="n">kappa</span><span class="p">,</span><span class="n">Dtype</span><span class="p">)</span>
<a name="ln-857"></a>
<a name="ln-858"></a><span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">Pmdims</span>
<a name="ln-859"></a>  <span class="n">PmMu</span> <span class="o">=</span> <span class="n">quat_mult</span><span class="p">(</span><span class="n">Mu</span><span class="p">,</span><span class="n">dict</span><span class="p">%</span><span class="n">Pm</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span><span class="n">j</span><span class="p">))</span>
<a name="ln-860"></a>  <span class="n">R</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">nums</span><span class="p">,</span><span class="n">j</span><span class="p">)</span> <span class="o">=</span> <span class="n">DD_Density</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">nums</span><span class="p">,</span> <span class="n">PmMu</span><span class="p">,</span> <span class="n">Kappa</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">Dtype</span><span class="p">)</span>
<a name="ln-861"></a><span class="k">end do</span>
<a name="ln-862"></a><span class="c">! and determine the normalization factors</span>
<a name="ln-863"></a><span class="n">Rdenom</span> <span class="o">=</span> <span class="mf">1.D0</span><span class="o">/</span><span class="nb">sum</span><span class="p">(</span><span class="n">R</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
<a name="ln-864"></a>
<a name="ln-865"></a><span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">Pmdims</span> 
<a name="ln-866"></a>  <span class="n">R</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">nums</span><span class="p">,</span><span class="n">j</span><span class="p">)</span> <span class="o">=</span> <span class="n">R</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">nums</span><span class="p">,</span><span class="n">j</span><span class="p">)</span><span class="o">*</span><span class="n">Rdenom</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">nums</span><span class="p">)</span>
<a name="ln-867"></a><span class="k">end do</span>
<a name="ln-868"></a>
<a name="ln-869"></a><span class="k">end function </span><span class="n">DD_Estep</span>
<a name="ln-870"></a>
<a name="ln-871"></a>
<a name="ln-872"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-873"></a><span class="c">!</span>
<a name="ln-874"></a><span class="c">! FUNCTION: DD_Mstep</span>
<a name="ln-875"></a><span class="c">!</span>
<a name="ln-876"></a><span class="c">!&gt; @author Marc De Graef, Carnegie Mellon University / Yu-Hui Chen, U. Michigan</span>
<a name="ln-877"></a><span class="c">!</span>
<a name="ln-878"></a><span class="c">!&gt; @brief computes the M step of the EM process</span>
<a name="ln-879"></a><span class="c">!</span>
<a name="ln-880"></a><span class="c">!&gt; @param X list of input quaternions</span>
<a name="ln-881"></a><span class="c">!&gt; @param dict dictionary type</span>
<a name="ln-882"></a><span class="c">!&gt; @param Pmdims number of quaternion symmetry operators</span>
<a name="ln-883"></a><span class="c">!&gt; @param nums number of samples</span>
<a name="ln-884"></a><span class="c">!&gt; @param R weight factors form the E step</span>
<a name="ln-885"></a><span class="c">!&gt; @param Dtype &#39;VMF&#39; or &#39;WAT&#39;</span>
<a name="ln-886"></a><span class="c">!</span>
<a name="ln-887"></a><span class="c">!&gt; @date 01/01/15 MDG 1.0 original</span>
<a name="ln-888"></a><span class="c">!&gt; @date 01/06/15 MDG 1.1 added optional full parameter</span>
<a name="ln-889"></a><span class="c">!&gt; @date 01/09/15 MDG 1.2 removed optional argument full (incorporated in dicttype)</span>
<a name="ln-890"></a><span class="c">!&gt; @date 01/09/15 MDG 1.3 introduced accurate numerical approximation for kappa determination</span>
<a name="ln-891"></a><span class="c">!&gt; @date 02/06/15 MDG 1.4 removed full handling after extensive checking</span>
<a name="ln-892"></a><span class="c">!&gt; @date 02/06/15 MDG 1.5 merged Msteps for VMF and WAT and renamed</span>
<a name="ln-893"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-894"></a><span class="k">recursive function </span><span class="n">DD_Mstep</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">dict</span><span class="p">,</span><span class="n">Pmdims</span><span class="p">,</span><span class="n">nums</span><span class="p">,</span><span class="n">R</span><span class="p">,</span><span class="n">Dtype</span><span class="p">)</span> <span class="k">result</span><span class="p">(</span><span class="n">MuKa</span><span class="p">)</span>
<a name="ln-895"></a><span class="c">!DEC$ ATTRIBUTES DLLEXPORT :: DD_Mstep</span>
<a name="ln-896"></a>
<a name="ln-897"></a><span class="k">use </span><span class="n">local</span>
<a name="ln-898"></a><span class="k">use </span><span class="n">typedefs</span>
<a name="ln-899"></a><span class="k">use </span><span class="n">quaternions</span>
<a name="ln-900"></a>
<a name="ln-901"></a><span class="k">IMPLICIT NONE</span>
<a name="ln-902"></a>
<a name="ln-903"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">dbl</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>               <span class="kd">::</span> <span class="n">X</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="n">nums</span><span class="p">)</span>
<a name="ln-904"></a><span class="k">type</span><span class="p">(</span><span class="n">dicttype</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>       <span class="kd">::</span> <span class="n">dict</span>
<a name="ln-905"></a><span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">irg</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>            <span class="kd">::</span> <span class="n">Pmdims</span>
<a name="ln-906"></a><span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">irg</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>            <span class="kd">::</span> <span class="n">nums</span>
<a name="ln-907"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">dbl</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>               <span class="kd">::</span> <span class="n">R</span><span class="p">(</span><span class="n">nums</span><span class="p">,</span><span class="n">Pmdims</span><span class="p">)</span>
<a name="ln-908"></a><span class="kt">character</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>                 <span class="kd">::</span> <span class="n">Dtype</span>
<a name="ln-909"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">dbl</span><span class="p">)</span>                          <span class="kd">::</span> <span class="n">MuKa</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<a name="ln-910"></a>
<a name="ln-911"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">dbl</span><span class="p">)</span>                          <span class="kd">::</span> <span class="n">tmpGamma</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="n">nGamma</span><span class="p">,</span> <span class="n">diff</span><span class="p">(</span><span class="n">dict</span><span class="p">%</span><span class="n">Apnum</span><span class="p">),</span> <span class="n">qu</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="n">y</span><span class="p">,</span> <span class="n">Tscatt</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span> <span class="n">tmp</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>
<a name="ln-912"></a><span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">irg</span><span class="p">)</span>                       <span class="kd">::</span> <span class="n">minp</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span>
<a name="ln-913"></a>
<a name="ln-914"></a><span class="c">! variables needed for the dsyev Lapack eigenvalue routine</span>
<a name="ln-915"></a><span class="kt">CHARACTER</span>                               <span class="kd">::</span> <span class="n">JOBZ</span><span class="p">,</span> <span class="n">UPLO</span>
<a name="ln-916"></a><span class="kt">INTEGER</span>                                 <span class="kd">::</span> <span class="n">INFO</span><span class="p">,</span> <span class="n">LDA</span><span class="p">,</span> <span class="n">LWORK</span><span class="p">,</span> <span class="n">NN</span>
<a name="ln-917"></a><span class="kt">DOUBLE PRECISION</span>                        <span class="kd">::</span> <span class="n">A</span><span class="p">(</span> <span class="mi">4</span> <span class="p">,</span> <span class="mi">4</span> <span class="p">),</span> <span class="n">W</span><span class="p">(</span> <span class="mi">4</span> <span class="p">),</span> <span class="n">WORK</span><span class="p">(</span> <span class="mi">20</span> <span class="p">)</span>
<a name="ln-918"></a>
<a name="ln-919"></a><span class="k">if</span> <span class="p">(</span><span class="n">Dtype</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="s1">&#39;VMF&#39;</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-920"></a><span class="c">! this is simplified from the Matlab routine and uses straight summations and</span>
<a name="ln-921"></a><span class="c">! quaternion multiplication instead of arrays</span>
<a name="ln-922"></a>  <span class="n">tmpGamma</span> <span class="o">=</span> <span class="mf">0.D0</span>
<a name="ln-923"></a>  <span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">Pmdims</span> 
<a name="ln-924"></a>    <span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">nums</span>
<a name="ln-925"></a>      <span class="n">qu</span> <span class="o">=</span> <span class="n">quat_mult</span><span class="p">(</span><span class="n">X</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span><span class="n">i</span><span class="p">),</span><span class="nb">conjg</span><span class="p">(</span><span class="n">dict</span><span class="p">%</span><span class="n">Pm</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span><span class="n">j</span><span class="p">)))</span>
<a name="ln-926"></a>      <span class="n">tmpGamma</span> <span class="o">=</span> <span class="n">tmpGamma</span> <span class="o">+</span>  <span class="n">R</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span> <span class="o">*</span> <span class="n">qu</span>
<a name="ln-927"></a>    <span class="k">end do</span>
<a name="ln-928"></a><span class="k">  end do</span>
<a name="ln-929"></a><span class="k">  </span><span class="n">nGamma</span> <span class="o">=</span> <span class="nb">cabs</span><span class="p">(</span><span class="n">tmpGamma</span><span class="p">)</span>
<a name="ln-930"></a>  <span class="n">MuKa</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="n">tmpGamma</span><span class="o">/</span><span class="n">nGamma</span>
<a name="ln-931"></a>  <span class="n">y</span> <span class="o">=</span> <span class="n">nGamma</span><span class="o">/</span><span class="nb">dble</span><span class="p">(</span><span class="n">nums</span><span class="p">)</span>
<a name="ln-932"></a><span class="k">end if</span>
<a name="ln-933"></a>
<a name="ln-934"></a><span class="k">if</span> <span class="p">(</span><span class="n">Dtype</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="s1">&#39;WAT&#39;</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-935"></a><span class="c">! here, we compute the modified scattering matrix Tscatt and compute its largest eigenvalue</span>
<a name="ln-936"></a><span class="c">! under the assumption that kappa will always be positive for the types of problems that we</span>
<a name="ln-937"></a><span class="c">! need to consider; we need to use the outer product, implemented using spread calls</span>
<a name="ln-938"></a>  <span class="n">Tscatt</span> <span class="o">=</span> <span class="mf">0.D0</span>
<a name="ln-939"></a>  <span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">Pmdims</span> 
<a name="ln-940"></a>    <span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">nums</span>
<a name="ln-941"></a>      <span class="n">qu</span> <span class="o">=</span> <span class="n">quat_mult</span><span class="p">(</span><span class="n">X</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span><span class="n">i</span><span class="p">),</span><span class="nb">conjg</span><span class="p">(</span><span class="n">dict</span><span class="p">%</span><span class="n">Pm</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span><span class="n">j</span><span class="p">)))</span>
<a name="ln-942"></a>      <span class="n">tmp</span> <span class="o">=</span> <span class="nb">spread</span><span class="p">(</span><span class="n">qu</span><span class="p">,</span><span class="nb">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">ncopies</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span><span class="o">*</span><span class="nb">spread</span><span class="p">(</span><span class="n">qu</span><span class="p">,</span><span class="nb">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">ncopies</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
<a name="ln-943"></a>      <span class="n">Tscatt</span> <span class="o">=</span> <span class="n">Tscatt</span> <span class="o">+</span> <span class="n">R</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span> <span class="o">*</span> <span class="n">tmp</span>
<a name="ln-944"></a>    <span class="k">end do</span>
<a name="ln-945"></a><span class="k">  end do</span>
<a name="ln-946"></a><span class="k">  </span><span class="n">Tscatt</span> <span class="o">=</span> <span class="n">Tscatt</span><span class="o">/</span><span class="nb">dble</span><span class="p">(</span><span class="n">nums</span><span class="p">)</span>
<a name="ln-947"></a>
<a name="ln-948"></a>  <span class="n">JOBZ</span> <span class="o">=</span> <span class="s1">&#39;V&#39;</span>
<a name="ln-949"></a>  <span class="n">UPLO</span> <span class="o">=</span> <span class="s1">&#39;U&#39;</span>
<a name="ln-950"></a>  <span class="n">NN</span> <span class="o">=</span> <span class="mi">4</span>
<a name="ln-951"></a>  <span class="n">LDA</span> <span class="o">=</span> <span class="mi">4</span>
<a name="ln-952"></a>  <span class="n">LWORK</span> <span class="o">=</span> <span class="mi">20</span>
<a name="ln-953"></a>  <span class="n">A</span> <span class="o">=</span> <span class="n">Tscatt</span>
<a name="ln-954"></a>  <span class="k">call </span><span class="n">DSYEV</span><span class="p">(</span> <span class="n">JOBZ</span><span class="p">,</span> <span class="n">UPLO</span><span class="p">,</span> <span class="n">NN</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">LDA</span><span class="p">,</span> <span class="n">W</span><span class="p">,</span> <span class="n">WORK</span><span class="p">,</span> <span class="n">LWORK</span><span class="p">,</span> <span class="n">INFO</span> <span class="p">)</span>
<a name="ln-955"></a>  <span class="n">qu</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="n">A</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span>
<a name="ln-956"></a>  <span class="n">MuKa</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="n">qu</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">)</span>
<a name="ln-957"></a>  <span class="n">y</span> <span class="o">=</span> <span class="nb">dot_product</span><span class="p">(</span><span class="n">qu</span><span class="p">,</span><span class="nb">matmul</span><span class="p">(</span><span class="n">Tscatt</span><span class="p">,</span><span class="n">qu</span><span class="p">))</span>
<a name="ln-958"></a><span class="k">end if</span>
<a name="ln-959"></a>
<a name="ln-960"></a><span class="c">! find kappa corresponding to this value of gamma (equation 17 in appendix of paper)</span>
<a name="ln-961"></a><span class="c">! we split this into two regionds: 0&lt;=y&lt;0.94, for which we use the look-up table </span>
<a name="ln-962"></a><span class="c">! approach, and 0.94&lt;=y&lt;=1, for which we have derived an analytical approximation</span>
<a name="ln-963"></a><span class="c">! that is pretty accurate in the relevant region of kappa&gt;30.</span>
<a name="ln-964"></a><span class="k">if</span> <span class="p">(</span><span class="n">y</span><span class="p">.</span><span class="n">ge</span><span class="p">.</span><span class="mf">0.94D0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-965"></a><span class="k">  if</span> <span class="p">(</span><span class="n">Dtype</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="s1">&#39;VMF&#39;</span><span class="p">)</span> <span class="n">MuKa</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="mf">5.D0</span><span class="o">-</span><span class="mf">3.D0</span><span class="o">*</span><span class="n">y</span><span class="o">+</span><span class="nb">dsqrt</span><span class="p">(</span><span class="mi">1</span><span class="mf">5.D0</span><span class="o">+</span><span class="mi">9</span><span class="mf">0.D0</span><span class="o">*</span><span class="n">y</span><span class="o">+</span><span class="mi">3</span><span class="mf">9.D0</span><span class="o">*</span><span class="n">y</span><span class="o">*</span><span class="n">y</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="mf">6.D0</span><span class="o">*</span><span class="p">(</span><span class="mf">1.0D0</span><span class="o">-</span><span class="n">y</span><span class="p">))</span>
<a name="ln-966"></a>  <span class="k">if</span> <span class="p">(</span><span class="n">Dtype</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="s1">&#39;WAT&#39;</span><span class="p">)</span> <span class="n">MuKa</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="mf">5.D0</span><span class="o">*</span><span class="n">y</span><span class="o">-</span><span class="mi">1</span><span class="mf">1.D0</span><span class="o">-</span><span class="nb">dsqrt</span><span class="p">(</span><span class="mi">3</span><span class="mf">9.D0</span><span class="o">-</span><span class="mi">1</span><span class="mf">2.D0</span><span class="o">*</span><span class="n">y</span><span class="o">+</span><span class="mf">9.D0</span><span class="o">*</span><span class="n">y</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="mf">8.D0</span><span class="o">*</span><span class="p">(</span><span class="n">y</span><span class="o">-</span><span class="mf">1.D0</span><span class="p">))</span>
<a name="ln-967"></a><span class="k">else</span>
<a name="ln-968"></a><span class="k">  </span><span class="n">diff</span> <span class="o">=</span> <span class="nb">dabs</span><span class="p">(</span> <span class="n">y</span> <span class="o">-</span> <span class="n">dict</span><span class="p">%</span><span class="n">yAp</span> <span class="p">)</span> 
<a name="ln-969"></a>  <span class="n">minp</span> <span class="o">=</span> <span class="nb">minloc</span><span class="p">(</span> <span class="n">diff</span><span class="p">,</span> <span class="mi">1</span> <span class="p">)</span>
<a name="ln-970"></a>  <span class="k">if</span> <span class="p">(</span><span class="n">minp</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span> <span class="n">minp</span> <span class="o">=</span> <span class="mi">2</span> 
<a name="ln-971"></a>  <span class="n">MuKa</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="n">dict</span><span class="p">%</span><span class="n">xAp</span><span class="p">(</span><span class="n">minp</span><span class="p">)</span>
<a name="ln-972"></a><span class="k">end if</span>
<a name="ln-973"></a>
<a name="ln-974"></a><span class="k">end function </span><span class="n">DD_Mstep</span>
<a name="ln-975"></a>
<a name="ln-976"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-977"></a><span class="c">!</span>
<a name="ln-978"></a><span class="c">! SUBROUTINE: DD_getQandL</span>
<a name="ln-979"></a><span class="c">!</span>
<a name="ln-980"></a><span class="c">!&gt; @author Yu-Hui Chen, U. Michigan / Marc De Graef, Carnegie Mellon University</span>
<a name="ln-981"></a><span class="c">!</span>
<a name="ln-982"></a><span class="c">!&gt; @brief Computes the Q array and the log-likelihood array</span>
<a name="ln-983"></a><span class="c">!</span>
<a name="ln-984"></a><span class="c">!&gt; @details For all details, see following paper:</span>
<a name="ln-985"></a><span class="c">!</span>
<a name="ln-986"></a><span class="c">!&gt; @param X list of input quaternions</span>
<a name="ln-987"></a><span class="c">!&gt; @param dict dictionary parameter (must be declared in calling routine)</span>
<a name="ln-988"></a><span class="c">!&gt; @param Pmdims number of quaternion symmetry operators to consider</span>
<a name="ln-989"></a><span class="c">!&gt; @param number of input quaternions</span>
<a name="ln-990"></a><span class="c">!&gt; @param MuKa  vector with Mu and Kappa</span>
<a name="ln-991"></a><span class="c">!&gt; @param R output from the E step</span>
<a name="ln-992"></a><span class="c">!&gt; @param Q output Q </span>
<a name="ln-993"></a><span class="c">!&gt; @param L output L </span>
<a name="ln-994"></a><span class="c">!&gt; @param Dtype &#39;VMF&#39; or &#39;WAT&#39;</span>
<a name="ln-995"></a><span class="c">!</span>
<a name="ln-996"></a><span class="c">!&gt; @date 01/01/15 MDG 1.0 original, based on Chen&#39;s Matlab version + simplifications</span>
<a name="ln-997"></a><span class="c">!&gt; @date 01.06/15 MDG 1.1 added optional full parameter</span>
<a name="ln-998"></a><span class="c">!&gt; @date 01/09/15 MDG 1.2 removed optional argument full (incorporated in dicttype)</span>
<a name="ln-999"></a><span class="c">!&gt; @date 02/06/15 MDG 1.3 removed full handling after extensive checking</span>
<a name="ln-1000"></a><span class="c">!&gt; @date 02/06/15 MDG 1.4 merged VMF and WAT routines and renamed</span>
<a name="ln-1001"></a><span class="c">!&gt; @date 12/05/16 MDG 1.5 intercepted case when Phi becomes zero for a VERY sharp texture...</span>
<a name="ln-1002"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-1003"></a><span class="k">recursive subroutine </span><span class="n">DD_getQandL</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">dict</span><span class="p">,</span><span class="n">Pmdims</span><span class="p">,</span><span class="n">nums</span><span class="p">,</span><span class="n">MuKa</span><span class="p">,</span><span class="n">R</span><span class="p">,</span><span class="n">Q</span><span class="p">,</span><span class="n">L</span><span class="p">,</span><span class="n">Dtype</span><span class="p">)</span>
<a name="ln-1004"></a><span class="c">!DEC$ ATTRIBUTES DLLEXPORT :: DD_getQandL</span>
<a name="ln-1005"></a>
<a name="ln-1006"></a><span class="k">use </span><span class="n">local</span>
<a name="ln-1007"></a><span class="k">use </span><span class="n">typedefs</span>
<a name="ln-1008"></a><span class="k">use </span><span class="n">quaternions</span>
<a name="ln-1009"></a>
<a name="ln-1010"></a><span class="k">IMPLICIT NONE</span>
<a name="ln-1011"></a>
<a name="ln-1012"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">dbl</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>               <span class="kd">::</span> <span class="n">X</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="n">nums</span><span class="p">)</span>
<a name="ln-1013"></a><span class="k">type</span><span class="p">(</span><span class="n">dicttype</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">INOUT</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">dict</span>
<a name="ln-1014"></a><span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">irg</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>            <span class="kd">::</span> <span class="n">Pmdims</span>
<a name="ln-1015"></a><span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">irg</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>            <span class="kd">::</span> <span class="n">nums</span>
<a name="ln-1016"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">dbl</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>               <span class="kd">::</span> <span class="n">MuKa</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<a name="ln-1017"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">dbl</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>               <span class="kd">::</span> <span class="n">R</span><span class="p">(</span><span class="n">nums</span><span class="p">,</span><span class="n">Pmdims</span><span class="p">)</span>
<a name="ln-1018"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">dbl</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">INOUT</span><span class="p">)</span>            <span class="kd">::</span> <span class="n">Q</span>
<a name="ln-1019"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">dbl</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">INOUT</span><span class="p">)</span>            <span class="kd">::</span> <span class="n">L</span>
<a name="ln-1020"></a><span class="kt">character</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>                 <span class="kd">::</span> <span class="n">Dtype</span>
<a name="ln-1021"></a>
<a name="ln-1022"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">dbl</span><span class="p">)</span>                          <span class="kd">::</span> <span class="n">Phi</span><span class="p">(</span><span class="n">nums</span><span class="p">,</span><span class="n">Pmdims</span><span class="p">),</span> <span class="n">PmMu</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="n">qu</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="n">C</span><span class="p">,</span> <span class="n">oldQ</span><span class="p">,</span> <span class="n">oldL</span>
<a name="ln-1023"></a><span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">irg</span><span class="p">)</span>                       <span class="kd">::</span> <span class="n">j</span>
<a name="ln-1024"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">dbl</span><span class="p">),</span><span class="k">parameter</span>                <span class="kd">::</span> <span class="n">eps</span> <span class="o">=</span> <span class="mf">0.00001D0</span>
<a name="ln-1025"></a>
<a name="ln-1026"></a>  <span class="n">oldQ</span> <span class="o">=</span> <span class="n">Q</span>
<a name="ln-1027"></a>  <span class="n">oldL</span> <span class="o">=</span> <span class="n">L</span>
<a name="ln-1028"></a>
<a name="ln-1029"></a>  <span class="n">C</span> <span class="o">=</span> <span class="n">logCp</span><span class="p">(</span><span class="n">MuKa</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span><span class="n">Dtype</span><span class="p">)</span>
<a name="ln-1030"></a>  <span class="k">if</span> <span class="p">(</span><span class="n">Dtype</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="s1">&#39;VMF&#39;</span><span class="p">)</span> <span class="n">C</span> <span class="o">=</span> <span class="nb">dexp</span><span class="p">(</span><span class="n">C</span><span class="p">)</span>
<a name="ln-1031"></a>
<a name="ln-1032"></a><span class="c">! compute the auxiliary Phi array</span>
<a name="ln-1033"></a>  <span class="n">Phi</span> <span class="o">=</span> <span class="mf">0.D0</span>
<a name="ln-1034"></a>  <span class="n">qu</span> <span class="o">=</span> <span class="n">MuKa</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">)</span>
<a name="ln-1035"></a>  <span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">Pmdims</span>
<a name="ln-1036"></a>    <span class="n">PmMu</span> <span class="o">=</span> <span class="n">quat_mult</span><span class="p">(</span><span class="n">dict</span><span class="p">%</span><span class="n">Pm</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span><span class="n">j</span><span class="p">),</span> <span class="n">qu</span><span class="p">)</span>
<a name="ln-1037"></a>    <span class="n">Phi</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">nums</span><span class="p">,</span><span class="n">j</span><span class="p">)</span> <span class="o">=</span> <span class="n">DD_Density</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">nums</span><span class="p">,</span> <span class="n">PmMu</span><span class="p">,</span> <span class="n">MuKa</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span> <span class="n">C</span><span class="p">,</span> <span class="n">Dtype</span><span class="p">)</span>
<a name="ln-1038"></a>  <span class="k">end do</span>
<a name="ln-1039"></a><span class="k">  </span><span class="n">Phi</span> <span class="o">=</span> <span class="n">Phi</span><span class="o">/</span><span class="nb">dble</span><span class="p">(</span><span class="n">dict</span><span class="p">%</span><span class="n">Nqsym</span><span class="p">)</span>
<a name="ln-1040"></a>  <span class="k">if</span> <span class="p">(</span><span class="nb">minval</span><span class="p">(</span><span class="n">Phi</span><span class="p">).</span><span class="n">gt</span><span class="p">.</span><span class="mf">0.D0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1041"></a><span class="c">! and convert the array into the Q and L parameters.</span>
<a name="ln-1042"></a>   <span class="n">L</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">dlog</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">Phi</span><span class="p">,</span><span class="mi">2</span><span class="p">)))</span>
<a name="ln-1043"></a>   <span class="n">Q</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">R</span><span class="o">*</span><span class="nb">dlog</span><span class="p">(</span><span class="n">Phi</span><span class="p">))</span>
<a name="ln-1044"></a>  <span class="k">else</span>
<a name="ln-1045"></a><span class="k">   </span><span class="n">L</span> <span class="o">=</span> <span class="n">oldL</span>
<a name="ln-1046"></a>   <span class="n">Q</span> <span class="o">=</span> <span class="n">oldQ</span>
<a name="ln-1047"></a>  <span class="k">end if</span> <span class="c">! else, we reuse the old values</span>
<a name="ln-1048"></a><span class="k">end subroutine </span><span class="n">DD_getQandL</span>
<a name="ln-1049"></a>
<a name="ln-1050"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-1051"></a><span class="c">!</span>
<a name="ln-1052"></a><span class="c">! FUNCTION: DD_Density</span>
<a name="ln-1053"></a><span class="c">!</span>
<a name="ln-1054"></a><span class="c">!&gt; @author Marc De Graef, Carnegie Mellon University / Yu-Hui Chen, U. Michigan</span>
<a name="ln-1055"></a><span class="c">!</span>
<a name="ln-1056"></a><span class="c">!&gt; @brief computes the VMF or Watson density function</span>
<a name="ln-1057"></a><span class="c">!</span>
<a name="ln-1058"></a><span class="c">!&gt; @details </span>
<a name="ln-1059"></a><span class="c">!&gt; original in Matlab by Yu-Hui Chen, U. Michigan</span>
<a name="ln-1060"></a><span class="c">!&gt; converted to IDL by MDG, 12/18/14, simplified arguments</span>
<a name="ln-1061"></a><span class="c">!&gt; converted to f90 by MDG, 12/31/14, further simplifications</span>
<a name="ln-1062"></a><span class="c">!&gt; output validated against Matlab output on 12/31/14</span>
<a name="ln-1063"></a><span class="c">!</span>
<a name="ln-1064"></a><span class="c">!&gt; @param X input quaternion samples</span>
<a name="ln-1065"></a><span class="c">!&gt; @param nums number of samples</span>
<a name="ln-1066"></a><span class="c">!&gt; @param mu mean direction</span>
<a name="ln-1067"></a><span class="c">!&gt; @param kappa concentration</span>
<a name="ln-1068"></a><span class="c">!&gt; @param C logCp(kappa) or exp(logCp(kappa) (precomputed in calling routine)</span>
<a name="ln-1069"></a><span class="c">!&gt; @param Dtype &#39;VMF&#39; or &#39;WAT&#39;</span>
<a name="ln-1070"></a><span class="c">!</span>
<a name="ln-1071"></a><span class="c">!&gt; @date 01/01/15 MDG 1.0 original</span>
<a name="ln-1072"></a><span class="c">!&gt; @date 01/06/15 MDG 1.1 added C and full parameters</span>
<a name="ln-1073"></a><span class="c">!&gt; @date 02/06/15 MDG 1.2 removed full handling</span>
<a name="ln-1074"></a><span class="c">!&gt; @date 02/06/15 MDG 1.3 merged &#39;VMF&#39; and &#39;WAT&#39; routines and renamed</span>
<a name="ln-1075"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-1076"></a><span class="k">recursive function </span><span class="n">DD_Density</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">nums</span><span class="p">,</span><span class="n">mu</span><span class="p">,</span><span class="n">kappa</span><span class="p">,</span><span class="n">C</span><span class="p">,</span><span class="n">Dtype</span><span class="p">)</span> <span class="k">result</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
<a name="ln-1077"></a><span class="c">!DEC$ ATTRIBUTES DLLEXPORT :: DD_Density</span>
<a name="ln-1078"></a>
<a name="ln-1079"></a><span class="k">use </span><span class="n">local</span>
<a name="ln-1080"></a>
<a name="ln-1081"></a><span class="k">IMPLICIT NONE</span>
<a name="ln-1082"></a>
<a name="ln-1083"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">dbl</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>               <span class="kd">::</span> <span class="n">X</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="n">nums</span><span class="p">)</span>
<a name="ln-1084"></a><span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">irg</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>            <span class="kd">::</span> <span class="n">nums</span>
<a name="ln-1085"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">dbl</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>               <span class="kd">::</span> <span class="n">mu</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<a name="ln-1086"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">dbl</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>               <span class="kd">::</span> <span class="n">kappa</span>
<a name="ln-1087"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">dbl</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>               <span class="kd">::</span> <span class="n">C</span>
<a name="ln-1088"></a><span class="kt">character</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>                 <span class="kd">::</span> <span class="n">Dtype</span>
<a name="ln-1089"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">dbl</span><span class="p">)</span>                          <span class="kd">::</span> <span class="n">y</span><span class="p">(</span><span class="n">nums</span><span class="p">)</span>
<a name="ln-1090"></a>
<a name="ln-1091"></a><span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">irg</span><span class="p">)</span>                       <span class="kd">::</span> <span class="n">j</span>
<a name="ln-1092"></a>
<a name="ln-1093"></a><span class="k">if</span> <span class="p">(</span><span class="n">Dtype</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="s1">&#39;VMF&#39;</span><span class="p">)</span> <span class="k">then </span>
<a name="ln-1094"></a><span class="k"> do </span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">nums</span>
<a name="ln-1095"></a>  <span class="n">y</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="o">=</span> <span class="nb">dexp</span><span class="p">(</span><span class="n">C</span><span class="o">+</span><span class="n">kappa</span><span class="o">*</span><span class="nb">dot_product</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span><span class="n">X</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span><span class="n">j</span><span class="p">)))</span>
<a name="ln-1096"></a> <span class="k">end do</span>
<a name="ln-1097"></a><span class="k">end if</span>
<a name="ln-1098"></a>
<a name="ln-1099"></a><span class="k">if</span> <span class="p">(</span><span class="n">Dtype</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="s1">&#39;WAT&#39;</span><span class="p">)</span> <span class="k">then </span>
<a name="ln-1100"></a><span class="k"> do </span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">nums</span>
<a name="ln-1101"></a>  <span class="n">y</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="o">=</span> <span class="nb">dexp</span><span class="p">(</span><span class="n">C</span><span class="o">+</span><span class="n">kappa</span><span class="o">*</span><span class="nb">dot_product</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span><span class="n">X</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span><span class="n">j</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
<a name="ln-1102"></a> <span class="k">end do</span>
<a name="ln-1103"></a><span class="k">end if</span>
<a name="ln-1104"></a>
<a name="ln-1105"></a><span class="k">end function </span><span class="n">DD_Density</span>
<a name="ln-1106"></a>
<a name="ln-1107"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-1108"></a><span class="c">!</span>
<a name="ln-1109"></a><span class="c">! FUNCTION: logCp</span>
<a name="ln-1110"></a><span class="c">!</span>
<a name="ln-1111"></a><span class="c">!&gt; @author Marc De Graef, Carnegie Mellon University / Yu-Hui Chen, U. Michigan</span>
<a name="ln-1112"></a><span class="c">!</span>
<a name="ln-1113"></a><span class="c">!&gt; @brief computes the logarithm of Cp for VMF and Watson distributions</span>
<a name="ln-1114"></a><span class="c">!</span>
<a name="ln-1115"></a><span class="c">!&gt; @details </span>
<a name="ln-1116"></a><span class="c">!&gt; original in Matlab by Yu-Hui Chen, U. Michigan</span>
<a name="ln-1117"></a><span class="c">!&gt; converted to IDL by MDG, 12/18/14, simplified arguments</span>
<a name="ln-1118"></a><span class="c">!&gt; converted to f90 by MDG, 12/31/14, further simplifications</span>
<a name="ln-1119"></a><span class="c">!&gt; output validated against Matlab output on 12/31/14</span>
<a name="ln-1120"></a><span class="c">!</span>
<a name="ln-1121"></a><span class="c">!&gt; @param kappa input parameter</span>
<a name="ln-1122"></a><span class="c">!&gt; @param Dtype &#39;VMF&#39; or &#39;WAT&#39;</span>
<a name="ln-1123"></a><span class="c">!</span>
<a name="ln-1124"></a><span class="c">!&gt; @date 12/31/14 MDG 1.0 original</span>
<a name="ln-1125"></a><span class="c">!&gt; @date 01/09/14 MDG 1.1 introduced more accurate numerical approximation for Cp</span>
<a name="ln-1126"></a><span class="c">!&gt; @date 01/09/14 MDG 1.2 moved some of the constants in front of the logarithm</span>
<a name="ln-1127"></a><span class="c">!&gt; @date 02/06/15 MDG 1.3 merged VMF and WAT routines</span>
<a name="ln-1128"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-1129"></a><span class="k">recursive function </span><span class="n">logCp</span><span class="p">(</span><span class="n">kappa</span><span class="p">,</span><span class="n">Dtype</span><span class="p">)</span> <span class="k">result</span><span class="p">(</span><span class="n">lCp</span><span class="p">)</span>
<a name="ln-1130"></a><span class="c">!DEC$ ATTRIBUTES DLLEXPORT :: logCp</span>
<a name="ln-1131"></a>
<a name="ln-1132"></a><span class="k">use </span><span class="n">local</span>
<a name="ln-1133"></a><span class="k">use </span><span class="n">constants</span>
<a name="ln-1134"></a><span class="k">use </span><span class="n">math</span> 
<a name="ln-1135"></a>
<a name="ln-1136"></a><span class="k">IMPLICIT NONE</span>
<a name="ln-1137"></a>
<a name="ln-1138"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">dbl</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>       <span class="kd">::</span> <span class="n">kappa</span>
<a name="ln-1139"></a><span class="kt">character</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>         <span class="kd">::</span> <span class="n">Dtype</span>
<a name="ln-1140"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">dbl</span><span class="p">)</span>                  <span class="kd">::</span> <span class="n">lCp</span>
<a name="ln-1141"></a>
<a name="ln-1142"></a><span class="c">! pre-computed constants</span>
<a name="ln-1143"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">dbl</span><span class="p">),</span><span class="k">parameter</span>        <span class="kd">::</span> <span class="n">C</span><span class="o">=-</span><span class="mf">3.675754132818690967D0</span>    <span class="c">! C = ln(1.D0/(2.D0*cPi)**2)</span>
<a name="ln-1144"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">dbl</span><span class="p">),</span><span class="k">parameter</span>        <span class="kd">::</span> <span class="n">C2</span><span class="o">=</span><span class="mf">4.1746562059854348688D0</span>   <span class="c">! C2 = ln(512/sqrt(2)/pi^(3/2))</span>
<a name="ln-1145"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">dbl</span><span class="p">),</span><span class="k">parameter</span>        <span class="kd">::</span> <span class="n">C2W</span><span class="o">=</span><span class="mf">5.4243952068443172530D0</span>  <span class="c">! C2 = ln(128*sqrt(pi))</span>
<a name="ln-1146"></a>
<a name="ln-1147"></a><span class="k">if</span> <span class="p">(</span><span class="n">Dtype</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="s1">&#39;VMF&#39;</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1148"></a><span class="c">! for arguments larger than kappa=30, we use a simple numerical approximation</span>
<a name="ln-1149"></a>  <span class="k">if</span> <span class="p">(</span><span class="n">kappa</span><span class="p">.</span><span class="n">gt</span><span class="p">.</span><span class="mi">3</span><span class="mf">0.D0</span><span class="p">)</span> <span class="k">then </span>
<a name="ln-1150"></a><span class="k">    </span><span class="n">lCp</span> <span class="o">=</span> <span class="n">kappa</span><span class="o">**</span><span class="mf">4.5D0</span><span class="o">/</span><span class="p">(</span><span class="o">-</span><span class="mi">105</span><span class="n">D0</span><span class="o">+</span><span class="mf">8.D0</span><span class="o">*</span><span class="n">kappa</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="mf">5.D0</span><span class="o">+</span><span class="mi">1</span><span class="mf">6.D0</span><span class="o">*</span><span class="n">kappa</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="mf">3.D0</span><span class="o">+</span><span class="mf">8.D0</span><span class="o">*</span><span class="n">kappa</span><span class="p">)))</span>
<a name="ln-1151"></a>    <span class="n">lCp</span> <span class="o">=</span> <span class="n">C2</span> <span class="o">-</span> <span class="n">kappa</span> <span class="o">+</span> <span class="nb">dlog</span><span class="p">(</span><span class="n">lCp</span><span class="p">)</span>
<a name="ln-1152"></a>  <span class="k">else </span>
<a name="ln-1153"></a><span class="k">    </span><span class="n">lCp</span> <span class="o">=</span> <span class="n">C</span> <span class="o">+</span> <span class="nb">dlog</span><span class="p">(</span> <span class="n">kappa</span> <span class="o">/</span> <span class="n">BesselI1</span><span class="p">(</span><span class="n">kappa</span><span class="p">)</span> <span class="p">)</span>
<a name="ln-1154"></a>  <span class="k">end if</span>
<a name="ln-1155"></a><span class="k">end if </span>
<a name="ln-1156"></a>
<a name="ln-1157"></a><span class="k">if</span> <span class="p">(</span><span class="n">Dtype</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="s1">&#39;WAT&#39;</span><span class="p">)</span> <span class="k">then</span> 
<a name="ln-1158"></a><span class="c">! for arguments larger than kappa=20, we use a simple numerical approximation</span>
<a name="ln-1159"></a>  <span class="k">if</span> <span class="p">(</span><span class="n">kappa</span><span class="p">.</span><span class="n">gt</span><span class="p">.</span><span class="mi">2</span><span class="mf">0.D0</span><span class="p">)</span> <span class="k">then </span>
<a name="ln-1160"></a><span class="k">    </span><span class="n">lCp</span> <span class="o">=</span> <span class="n">kappa</span><span class="o">**</span><span class="mf">4.5D0</span><span class="o">/</span><span class="p">(</span><span class="mi">52</span><span class="mf">5.D0</span> <span class="o">+</span> <span class="mf">4.D0</span><span class="o">*</span><span class="n">kappa</span><span class="o">*</span><span class="p">(</span><span class="mi">4</span><span class="mf">5.D0</span> <span class="o">+</span> <span class="mf">8.D0</span><span class="o">*</span><span class="n">kappa</span><span class="o">*</span><span class="p">(</span><span class="mf">3.D0</span> <span class="o">+</span> <span class="mf">4.D0</span><span class="o">*</span><span class="n">kappa</span><span class="p">)))</span>
<a name="ln-1161"></a>    <span class="n">lCp</span> <span class="o">=</span> <span class="n">C2W</span> <span class="o">-</span> <span class="n">kappa</span> <span class="o">+</span> <span class="nb">dlog</span><span class="p">(</span><span class="n">lCp</span><span class="p">)</span>
<a name="ln-1162"></a>  <span class="k">else </span>
<a name="ln-1163"></a><span class="k">    </span><span class="n">lCp</span> <span class="o">=</span> <span class="o">-</span><span class="n">kappa</span><span class="o">*</span><span class="mf">0.5D0</span> <span class="o">-</span> <span class="nb">dlog</span><span class="p">(</span> <span class="n">BesselI0</span><span class="p">(</span><span class="n">kappa</span><span class="o">*</span><span class="mf">0.5D0</span><span class="p">)</span> <span class="o">-</span> <span class="n">BesselI1</span><span class="p">(</span><span class="n">kappa</span><span class="o">*</span><span class="mf">0.5D0</span><span class="p">)</span> <span class="p">)</span>
<a name="ln-1164"></a>  <span class="k">end if</span>
<a name="ln-1165"></a><span class="k">end if</span>
<a name="ln-1166"></a>
<a name="ln-1167"></a><span class="k">end function </span><span class="n">logCp</span>
<a name="ln-1168"></a>
<a name="ln-1169"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-1170"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-1171"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-1172"></a><span class="c">! the following routines have to do with the neighborhood similarity analysis</span>
<a name="ln-1173"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-1174"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-1175"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-1176"></a><span class="c">!</span>
<a name="ln-1177"></a><span class="c">! SUBROUTINE: DI_similarity_classifier</span>
<a name="ln-1178"></a><span class="c">!</span>
<a name="ln-1179"></a><span class="c">!&gt; @author Saransh Singh, Carnegie Mellon University / Yu-Hui Chen, U. Michigan</span>
<a name="ln-1180"></a><span class="c">!</span>
<a name="ln-1181"></a><span class="c">!&gt; @brief classify the point as grain interior or anomalous point</span>
<a name="ln-1182"></a><span class="c">!</span>
<a name="ln-1183"></a><span class="c">!&gt; @details takes the kNN neighbor information as input and returns the </span>
<a name="ln-1184"></a><span class="c">!  whether the point lies in the interior of the grain or lies on the </span>
<a name="ln-1185"></a><span class="c">!  grain boundary. Details in pg 11 of the dictionary indexing paper</span>
<a name="ln-1186"></a><span class="c">!</span>
<a name="ln-1187"></a><span class="c">!&gt; @param array input array</span>
<a name="ln-1188"></a><span class="c">!&gt; @param k number of top matches for each pixel</span>
<a name="ln-1189"></a><span class="c">!&gt; @param npx number of pixels in the x direction</span>
<a name="ln-1190"></a><span class="c">!&gt; @param npy number of pixels in the y direction</span>
<a name="ln-1191"></a><span class="c">!</span>
<a name="ln-1192"></a><span class="c">!&gt; @date 01/05/15 SS 1.0 original</span>
<a name="ln-1193"></a><span class="c">!&gt; @date 01/06/15 MDG 1.1 simplified summation loop and renamed routine</span>
<a name="ln-1194"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-1195"></a><span class="k">recursive subroutine </span><span class="n">DI_Similarity_Classifier</span><span class="p">(</span><span class="k">array</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">npx</span><span class="p">,</span><span class="n">npy</span><span class="p">,</span><span class="n">returnarr</span><span class="p">)</span>
<a name="ln-1196"></a><span class="c">!DEC$ ATTRIBUTES DLLEXPORT :: DI_Similarity_Classifier</span>
<a name="ln-1197"></a>
<a name="ln-1198"></a><span class="k">use </span><span class="n">local</span>
<a name="ln-1199"></a>
<a name="ln-1200"></a><span class="k">IMPLICIT NONE</span>
<a name="ln-1201"></a>
<a name="ln-1202"></a><span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>            <span class="kd">::</span> <span class="k">array</span><span class="p">(</span><span class="n">npx</span><span class="p">,</span><span class="n">npy</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>
<a name="ln-1203"></a><span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">irg</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>            <span class="kd">::</span> <span class="n">k</span>
<a name="ln-1204"></a><span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">irg</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>            <span class="kd">::</span> <span class="n">npx</span>
<a name="ln-1205"></a><span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">irg</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>            <span class="kd">::</span> <span class="n">npy</span>
<a name="ln-1206"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">OUT</span><span class="p">)</span>              <span class="kd">::</span> <span class="n">returnarr</span><span class="p">(</span><span class="n">npx</span><span class="p">,</span><span class="n">npy</span><span class="p">)</span>
<a name="ln-1207"></a>
<a name="ln-1208"></a><span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">irg</span><span class="p">)</span>                       <span class="kd">::</span> <span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">,</span><span class="n">ki</span><span class="p">,</span><span class="n">kj</span><span class="p">,</span><span class="n">similarity_measure_sum</span><span class="p">,</span><span class="n">res</span>
<a name="ln-1209"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">)</span>                          <span class="kd">::</span> <span class="n">similarity_measure</span>
<a name="ln-1210"></a>
<a name="ln-1211"></a>
<a name="ln-1212"></a><span class="n">similarity_measure_sum</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-1213"></a><span class="n">similarity_measure</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-1214"></a><span class="n">returnarr</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-1215"></a>
<a name="ln-1216"></a><span class="k">do </span><span class="n">ii</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span><span class="n">npx</span><span class="o">-</span><span class="mi">1</span>
<a name="ln-1217"></a>    <span class="k">do </span><span class="n">jj</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span><span class="n">npy</span><span class="o">-</span><span class="mi">1</span>
<a name="ln-1218"></a>      <span class="k">do </span><span class="n">ki</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span>
<a name="ln-1219"></a>        <span class="k">do </span><span class="n">kj</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span>
<a name="ln-1220"></a>          <span class="k">if</span> <span class="p">((</span><span class="nb">abs</span><span class="p">(</span><span class="n">ki</span><span class="p">)</span><span class="o">+</span><span class="nb">abs</span><span class="p">(</span><span class="n">kj</span><span class="p">)).</span><span class="n">ne</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span> <span class="k">then </span>
<a name="ln-1221"></a><span class="k">            call </span><span class="n">CardIntersection</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="n">ii</span><span class="o">+</span><span class="n">ki</span><span class="p">,</span><span class="n">jj</span><span class="o">+</span><span class="n">kj</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">k</span><span class="p">),</span><span class="k">array</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">k</span><span class="p">),</span><span class="n">k</span><span class="p">,</span><span class="n">res</span><span class="p">)</span>
<a name="ln-1222"></a>            <span class="n">similarity_measure_sum</span> <span class="o">=</span> <span class="n">similarity_measure_sum</span> <span class="o">+</span> <span class="n">res</span>
<a name="ln-1223"></a>
<a name="ln-1224"></a>            <span class="n">similarity_measure</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">similarity_measure_sum</span><span class="p">)</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="mi">8</span><span class="o">*</span><span class="n">k</span><span class="p">)</span>
<a name="ln-1225"></a>            <span class="n">returnarr</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">)</span> <span class="o">=</span> <span class="n">similarity_measure</span>
<a name="ln-1226"></a>
<a name="ln-1227"></a>            <span class="n">similarity_measure</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-1228"></a>            <span class="n">similarity_measure_sum</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-1229"></a>          <span class="k">end if</span>
<a name="ln-1230"></a><span class="k">        end do</span>
<a name="ln-1231"></a><span class="k">      end do</span>
<a name="ln-1232"></a><span class="k">    end do</span>
<a name="ln-1233"></a><span class="k">end do</span>
<a name="ln-1234"></a>
<a name="ln-1235"></a><span class="k">end subroutine </span><span class="n">DI_Similarity_Classifier</span>
<a name="ln-1236"></a>
<a name="ln-1237"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-1238"></a><span class="c">!</span>
<a name="ln-1239"></a><span class="c">! SUBROUTINE: CardIntersection</span>
<a name="ln-1240"></a><span class="c">!</span>
<a name="ln-1241"></a><span class="c">!&gt; @author Saransh Singh, Carnegie Mellon University / Yu-Hui Chen, U. Michigan</span>
<a name="ln-1242"></a><span class="c">!</span>
<a name="ln-1243"></a><span class="c">!&gt; @brief calculate the cardinality of the intersection of two sets</span>
<a name="ln-1244"></a><span class="c">!</span>
<a name="ln-1245"></a><span class="c">!&gt; @param set1</span>
<a name="ln-1246"></a><span class="c">!&gt; @param set2</span>
<a name="ln-1247"></a><span class="c">!&gt; @param k number of elements in each set</span>
<a name="ln-1248"></a><span class="c">!</span>
<a name="ln-1249"></a><span class="c">!&gt; @date 01/05/15 SS 1.0 original</span>
<a name="ln-1250"></a><span class="c">!&gt; @date MDG 1.1 changed types to integer </span>
<a name="ln-1251"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-1252"></a><span class="k">recursive subroutine </span><span class="n">CardIntersection</span><span class="p">(</span><span class="n">set1</span><span class="p">,</span><span class="n">set2</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">res</span><span class="p">)</span>
<a name="ln-1253"></a><span class="c">!DEC$ ATTRIBUTES DLLEXPORT :: CardIntersection</span>
<a name="ln-1254"></a>
<a name="ln-1255"></a><span class="k">use </span><span class="n">local</span>
<a name="ln-1256"></a>
<a name="ln-1257"></a><span class="k">IMPLICIT NONE</span>
<a name="ln-1258"></a>
<a name="ln-1259"></a><span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">irg</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>            <span class="kd">::</span> <span class="n">set1</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<a name="ln-1260"></a><span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">irg</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>            <span class="kd">::</span> <span class="n">set2</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<a name="ln-1261"></a><span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">irg</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>            <span class="kd">::</span> <span class="n">k</span>
<a name="ln-1262"></a><span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">irg</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">OUT</span><span class="p">)</span>           <span class="kd">::</span> <span class="n">res</span>
<a name="ln-1263"></a>
<a name="ln-1264"></a><span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">irg</span><span class="p">)</span>                       <span class="kd">::</span> <span class="n">ii</span><span class="p">,</span><span class="n">jj</span>
<a name="ln-1265"></a><span class="n">jj</span> <span class="o">=</span> <span class="mi">1</span>
<a name="ln-1266"></a><span class="n">res</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-1267"></a>
<a name="ln-1268"></a><span class="k">do </span><span class="n">ii</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="n">k</span>
<a name="ln-1269"></a>    <span class="k">do </span><span class="n">jj</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="n">k</span>
<a name="ln-1270"></a>        <span class="k">if</span> <span class="p">(</span><span class="n">set1</span><span class="p">(</span><span class="n">ii</span><span class="p">)</span> <span class="p">.</span><span class="n">eq</span><span class="p">.</span> <span class="n">set2</span><span class="p">(</span><span class="n">jj</span><span class="p">))</span> <span class="k">then</span>
<a name="ln-1271"></a><span class="k">            </span><span class="n">res</span> <span class="o">=</span> <span class="n">res</span> <span class="o">+</span> <span class="mi">1</span>
<a name="ln-1272"></a>            <span class="k">EXIT</span>
<a name="ln-1273"></a><span class="k">        end if</span>
<a name="ln-1274"></a><span class="k">    end do</span>
<a name="ln-1275"></a><span class="k">end do</span>
<a name="ln-1276"></a>
<a name="ln-1277"></a><span class="k">end subroutine </span><span class="n">CardIntersection</span>
<a name="ln-1278"></a>
<a name="ln-1279"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-1280"></a><span class="c">!</span>
<a name="ln-1281"></a><span class="c">! SUBROUTINE: ReduceDisorientationtoMFZ</span>
<a name="ln-1282"></a><span class="c">!</span>
<a name="ln-1283"></a><span class="c">!&gt; @author Marc De Graef, Carnegie Mellon University</span>
<a name="ln-1284"></a><span class="c">!</span>
<a name="ln-1285"></a><span class="c">!&gt; @brief Reduce a disorientation (Rodrigues) to the Mackenzie Fundamental Zone</span>
<a name="ln-1286"></a><span class="c">!</span>
<a name="ln-1287"></a><span class="c">!&gt; @details This requires the symmetry operations of the Rodrigues FZ, which </span>
<a name="ln-1288"></a><span class="c">!&gt; includes mirrors and inversion symmetry, i.e., the regular (full) point group</span>
<a name="ln-1289"></a><span class="c">!&gt; symmetry of the shape of the RFZ.  We already have those implemented in the </span>
<a name="ln-1290"></a><span class="c">!&gt; regular symmetry module, and we assume that those symmetry matrices have been</span>
<a name="ln-1291"></a><span class="c">!&gt; initialized and are present in the cell structure.  Then we just call the regular</span>
<a name="ln-1292"></a><span class="c">!&gt; CalcStar routine to generate the equivalents and pick the one that is inside</span>
<a name="ln-1293"></a><span class="c">!&gt; the MFZ.</span>
<a name="ln-1294"></a><span class="c">!</span>
<a name="ln-1295"></a><span class="c">!&gt; @param ro Rodrigues vector</span>
<a name="ln-1296"></a><span class="c">!&gt; @param cell cell pointer</span>
<a name="ln-1297"></a><span class="c">!&gt; @param FZtype Fundamental Zone type</span>
<a name="ln-1298"></a><span class="c">!&gt; @param FZorder Fundamental Zone order</span>
<a name="ln-1299"></a><span class="c">!&gt; @param euFZ Euler triplet in fundamental zone (in radians)</span>
<a name="ln-1300"></a><span class="c">!</span>
<a name="ln-1301"></a><span class="c">!&gt; @date 07/29/16 MDG 1.0 original</span>
<a name="ln-1302"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-1303"></a><span class="k">recursive subroutine </span><span class="n">ReduceDisorientationtoMFZ</span><span class="p">(</span><span class="n">ro</span><span class="p">,</span> <span class="n">cell</span><span class="p">,</span> <span class="n">FZtype</span><span class="p">,</span> <span class="n">FZorder</span><span class="p">,</span> <span class="n">roMFZ</span><span class="p">)</span>
<a name="ln-1304"></a><span class="c">!DEC$ ATTRIBUTES DLLEXPORT :: ReduceDisorientationtoMFZ</span>
<a name="ln-1305"></a>
<a name="ln-1306"></a><span class="k">use </span><span class="n">local</span>
<a name="ln-1307"></a><span class="k">use </span><span class="n">rotations</span>
<a name="ln-1308"></a><span class="k">use </span><span class="n">quaternions</span>
<a name="ln-1309"></a><span class="k">use </span><span class="n">so3</span>
<a name="ln-1310"></a><span class="k">use </span><span class="n">typedefs</span>
<a name="ln-1311"></a><span class="k">use </span><span class="n">symmetry</span>
<a name="ln-1312"></a>
<a name="ln-1313"></a><span class="k">IMPLICIT NONE</span>
<a name="ln-1314"></a>
<a name="ln-1315"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">dbl</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>               <span class="kd">::</span> <span class="n">ro</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<a name="ln-1316"></a><span class="k">type</span><span class="p">(</span><span class="n">unitcell</span><span class="p">),</span><span class="k">pointer</span><span class="p">,</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>       <span class="kd">::</span> <span class="n">cell</span>
<a name="ln-1317"></a><span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">irg</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>            <span class="kd">::</span> <span class="n">FZtype</span>
<a name="ln-1318"></a><span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">irg</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>            <span class="kd">::</span> <span class="n">FZorder</span>
<a name="ln-1319"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">dbl</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">OUT</span><span class="p">)</span>              <span class="kd">::</span> <span class="n">roMFZ</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<a name="ln-1320"></a>
<a name="ln-1321"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">dbl</span><span class="p">)</span>                          <span class="kd">::</span> <span class="n">r</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">rod</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="n">mag</span>
<a name="ln-1322"></a><span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">irg</span><span class="p">)</span>                       <span class="kd">::</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">n</span>
<a name="ln-1323"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">dbl</span><span class="p">)</span>                          <span class="kd">::</span> <span class="n">stmp</span><span class="p">(</span><span class="mi">48</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-1324"></a><span class="kt">logical</span>                                 <span class="kd">::</span> <span class="n">inMFZ</span>
<a name="ln-1325"></a>
<a name="ln-1326"></a><span class="n">roMFZ</span> <span class="o">=</span> <span class="mf">0.D0</span>
<a name="ln-1327"></a><span class="n">r</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">ro</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">ro</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<a name="ln-1328"></a><span class="n">stmp</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-1329"></a><span class="k">call </span><span class="n">CalcStar</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="n">stmp</span><span class="p">,</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>
<a name="ln-1330"></a>
<a name="ln-1331"></a>
<a name="ln-1332"></a><span class="n">MFZloop</span><span class="p">:</span> <span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">n</span>
<a name="ln-1333"></a>  <span class="n">mag</span> <span class="o">=</span> <span class="nb">dsqrt</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">stmp</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
<a name="ln-1334"></a>  <span class="n">rod</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="n">mag</span>
<a name="ln-1335"></a>  <span class="n">rod</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">stmp</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span><span class="o">/</span><span class="n">mag</span>
<a name="ln-1336"></a>  <span class="n">inMFZ</span> <span class="o">=</span> <span class="n">IsinsideMFZ</span><span class="p">(</span><span class="n">rod</span><span class="p">,</span> <span class="n">FZtype</span><span class="p">,</span> <span class="n">FZorder</span><span class="p">)</span>
<a name="ln-1337"></a>  <span class="k">if</span> <span class="p">(</span><span class="n">inMFZ</span><span class="p">)</span> <span class="k">EXIT </span><span class="n">MFZloop</span>
<a name="ln-1338"></a><span class="c">! we really should never get to the following line ...</span>
<a name="ln-1339"></a>  <span class="k">if</span> <span class="p">(</span><span class="n">j</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="n">n</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1340"></a><span class="k">    write</span> <span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s1">&#39;problem ... &#39;</span><span class="p">,</span><span class="n">j</span><span class="p">,</span> <span class="n">inMFZ</span>
<a name="ln-1341"></a>    <span class="k">write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="n">r</span><span class="p">,</span> <span class="n">n</span>
<a name="ln-1342"></a>    <span class="k">write</span><span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="n">mag</span><span class="p">,</span> <span class="n">rod</span>
<a name="ln-1343"></a>    <span class="k">write</span> <span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="nb">transpose</span><span class="p">(</span><span class="n">stmp</span><span class="p">)</span>
<a name="ln-1344"></a>    <span class="k">stop</span>
<a name="ln-1345"></a><span class="k">  end if</span>
<a name="ln-1346"></a><span class="k">end do </span><span class="n">MFZloop</span>
<a name="ln-1347"></a><span class="n">roMFZ</span> <span class="o">=</span> <span class="n">rod</span>
<a name="ln-1348"></a>
<a name="ln-1349"></a><span class="k">end subroutine </span><span class="n">ReduceDisorientationtoMFZ</span>
<a name="ln-1350"></a>
<a name="ln-1351"></a>
<a name="ln-1352"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-1353"></a><span class="c">!</span>
<a name="ln-1354"></a><span class="c">! SUBROUTINE: ReduceOrientationtoCubicEFZ</span>
<a name="ln-1355"></a><span class="c">!</span>
<a name="ln-1356"></a><span class="c">!&gt; @author Marc De Graef, Carnegie Mellon University</span>
<a name="ln-1357"></a><span class="c">!</span>
<a name="ln-1358"></a><span class="c">!&gt; @brief Reduce an orientation (Euler angles) to the cubic FZ in Euler space</span>
<a name="ln-1359"></a><span class="c">!</span>
<a name="ln-1360"></a><span class="c">!&gt; @param eu Euler triplet (in radians)</span>
<a name="ln-1361"></a><span class="c">!&gt; @param dict dict structure</span>
<a name="ln-1362"></a><span class="c">!&gt; @param euFZ Euler triplet in Euler fundamental zone (in radians)</span>
<a name="ln-1363"></a><span class="c">!</span>
<a name="ln-1364"></a><span class="c">!&gt; @date 07/29/16 MDG 1.0 original</span>
<a name="ln-1365"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-1366"></a><span class="k">recursive subroutine </span><span class="n">ReduceOrientationtoCubicEFZ</span><span class="p">(</span><span class="n">eu</span><span class="p">,</span> <span class="n">dict</span><span class="p">,</span> <span class="n">euFZ</span><span class="p">)</span>
<a name="ln-1367"></a><span class="c">!DEC$ ATTRIBUTES DLLEXPORT :: ReduceOrientationtoCubicEFZ</span>
<a name="ln-1368"></a>
<a name="ln-1369"></a><span class="k">use </span><span class="n">local</span>
<a name="ln-1370"></a><span class="k">use </span><span class="n">rotations</span>
<a name="ln-1371"></a><span class="k">use </span><span class="n">quaternions</span>
<a name="ln-1372"></a><span class="k">use </span><span class="n">constants</span>
<a name="ln-1373"></a><span class="k">use </span><span class="n">so3</span>
<a name="ln-1374"></a>
<a name="ln-1375"></a><span class="k">IMPLICIT NONE</span>
<a name="ln-1376"></a>
<a name="ln-1377"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">dbl</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>               <span class="kd">::</span> <span class="n">eu</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-1378"></a><span class="k">type</span><span class="p">(</span><span class="n">dicttype</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>               <span class="kd">::</span> <span class="n">dict</span>
<a name="ln-1379"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">dbl</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">OUT</span><span class="p">)</span>              <span class="kd">::</span> <span class="n">euFZ</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-1380"></a>
<a name="ln-1381"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">dbl</span><span class="p">)</span>                          <span class="kd">::</span> <span class="n">Mu</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="n">qu</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="n">rod</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="n">c</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">z</span>
<a name="ln-1382"></a><span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">irg</span><span class="p">)</span>                       <span class="kd">::</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">Pmdims</span>
<a name="ln-1383"></a>
<a name="ln-1384"></a><span class="n">euFZ</span> <span class="o">=</span> <span class="mf">0.D0</span>
<a name="ln-1385"></a><span class="n">Pmdims</span> <span class="o">=</span> <span class="n">dict</span><span class="p">%</span><span class="n">Nqsym</span>
<a name="ln-1386"></a>
<a name="ln-1387"></a><span class="n">Mu</span> <span class="o">=</span> <span class="n">eu2qu</span><span class="p">(</span><span class="n">eu</span><span class="p">)</span>
<a name="ln-1388"></a><span class="k">if</span> <span class="p">(</span><span class="n">Mu</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="n">lt</span><span class="p">.</span><span class="mf">0.D0</span><span class="p">)</span> <span class="n">Mu</span> <span class="o">=</span> <span class="o">-</span><span class="n">Mu</span>
<a name="ln-1389"></a><span class="n">FZloop</span><span class="p">:</span> <span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">Pmdims</span>
<a name="ln-1390"></a>  <span class="n">qu</span> <span class="o">=</span> <span class="n">quat_mult</span><span class="p">(</span><span class="n">dict</span><span class="p">%</span><span class="n">Pm</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span><span class="n">j</span><span class="p">),</span><span class="n">Mu</span><span class="p">)</span>
<a name="ln-1391"></a>  <span class="k">if</span> <span class="p">(</span><span class="n">qu</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="n">lt</span><span class="p">.</span><span class="mf">0.D0</span><span class="p">)</span> <span class="n">qu</span> <span class="o">=</span> <span class="o">-</span><span class="n">qu</span>
<a name="ln-1392"></a>  <span class="n">euFZ</span> <span class="o">=</span> <span class="n">qu2eu</span><span class="p">(</span><span class="n">qu</span><span class="p">)</span>
<a name="ln-1393"></a>  <span class="c">! apply the cubic Euler FZ boundary conditions</span>
<a name="ln-1394"></a>  <span class="n">c</span> <span class="o">=</span> <span class="nb">cos</span><span class="p">(</span><span class="n">euFZ</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
<a name="ln-1395"></a>  <span class="n">s</span> <span class="o">=</span> <span class="nb">sin</span><span class="p">(</span><span class="n">euFZ</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
<a name="ln-1396"></a>  <span class="n">z</span> <span class="o">=</span> <span class="nb">acos</span><span class="p">(</span><span class="nb">minval</span><span class="p">(</span> <span class="p">(</span><span class="o">/</span> <span class="n">c</span><span class="o">/</span><span class="nb">sqrt</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">c</span><span class="o">*</span><span class="n">c</span><span class="p">),</span> <span class="n">s</span><span class="o">/</span><span class="nb">sqrt</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">s</span><span class="o">*</span><span class="n">s</span><span class="p">)</span> <span class="o">/</span><span class="p">)</span> <span class="p">))</span>
<a name="ln-1397"></a>  <span class="k">if</span> <span class="p">((</span><span class="n">euFZ</span><span class="p">(</span><span class="mi">2</span><span class="p">).</span><span class="n">gt</span><span class="p">.</span><span class="n">z</span><span class="p">).</span><span class="nb">and</span><span class="p">.(</span><span class="n">euFZ</span><span class="p">(</span><span class="mi">2</span><span class="p">).</span><span class="n">lt</span><span class="p">.</span><span class="n">cPi</span><span class="o">/</span><span class="mi">2</span><span class="n">D0</span><span class="p">).</span><span class="nb">and</span><span class="p">.(</span><span class="n">euFZ</span><span class="p">(</span><span class="mi">3</span><span class="p">).</span><span class="n">lt</span><span class="p">.</span><span class="n">cPi</span><span class="o">/</span><span class="mf">2.D0</span><span class="p">))</span> <span class="k">EXIT </span><span class="n">FZloop</span>
<a name="ln-1398"></a><span class="c">! we really should never get to the following line ...</span>
<a name="ln-1399"></a>  <span class="k">if</span> <span class="p">(</span><span class="n">j</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="n">Pmdims</span><span class="p">)</span> <span class="k">write</span> <span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s1">&#39;problem ... &#39;</span><span class="p">,</span><span class="n">i</span>
<a name="ln-1400"></a><span class="k">end do </span><span class="n">FZloop</span>
<a name="ln-1401"></a>
<a name="ln-1402"></a><span class="k">end subroutine </span><span class="n">ReduceOrientationtoCubicEFZ</span>
<a name="ln-1403"></a>
<a name="ln-1404"></a>
<a name="ln-1405"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-1406"></a><span class="c">!</span>
<a name="ln-1407"></a><span class="c">! SUBROUTINE: ReduceOrientationtoRFZ</span>
<a name="ln-1408"></a><span class="c">!</span>
<a name="ln-1409"></a><span class="c">!&gt; @author Marc De Graef, Carnegie Mellon University</span>
<a name="ln-1410"></a><span class="c">!</span>
<a name="ln-1411"></a><span class="c">!&gt; @brief Reduce an orientation (Euler angles) to the Rodrigues Fundamental Zone</span>
<a name="ln-1412"></a><span class="c">!</span>
<a name="ln-1413"></a><span class="c">!&gt; @param eu Euler triplet (in radians)</span>
<a name="ln-1414"></a><span class="c">!&gt; @param dict dict structure</span>
<a name="ln-1415"></a><span class="c">!&gt; @param FZtype Fundamental Zone type</span>
<a name="ln-1416"></a><span class="c">!&gt; @param FZorder Fundamental Zone order</span>
<a name="ln-1417"></a><span class="c">!&gt; @param euFZ Euler triplet in fundamental zone (in radians)</span>
<a name="ln-1418"></a><span class="c">!&gt; @param MFZ (optonal) apply MacKenzie cell</span>
<a name="ln-1419"></a><span class="c">!</span>
<a name="ln-1420"></a><span class="c">!&gt; @date 07/29/16 MDG 1.0 original</span>
<a name="ln-1421"></a><span class="c">!&gt; @date 03/27/17 MDG 1.1 added checking of MacKenzie cell</span>
<a name="ln-1422"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-1423"></a><span class="k">recursive subroutine </span><span class="n">ReduceOrientationtoRFZ</span><span class="p">(</span><span class="n">eu</span><span class="p">,</span> <span class="n">dict</span><span class="p">,</span> <span class="n">FZtype</span><span class="p">,</span> <span class="n">FZorder</span><span class="p">,</span> <span class="n">euFZ</span><span class="p">,</span> <span class="n">MFZ</span><span class="p">)</span>
<a name="ln-1424"></a><span class="c">!DEC$ ATTRIBUTES DLLEXPORT :: ReduceOrientationtoRFZ</span>
<a name="ln-1425"></a>
<a name="ln-1426"></a><span class="k">use </span><span class="n">local</span>
<a name="ln-1427"></a><span class="k">use </span><span class="n">rotations</span>
<a name="ln-1428"></a><span class="k">use </span><span class="n">quaternions</span>
<a name="ln-1429"></a><span class="k">use </span><span class="n">so3</span>
<a name="ln-1430"></a><span class="k">use </span><span class="n">constants</span>
<a name="ln-1431"></a>
<a name="ln-1432"></a><span class="k">IMPLICIT NONE</span>
<a name="ln-1433"></a>
<a name="ln-1434"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">dbl</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>               <span class="kd">::</span> <span class="n">eu</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-1435"></a><span class="k">type</span><span class="p">(</span><span class="n">dicttype</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>               <span class="kd">::</span> <span class="n">dict</span>
<a name="ln-1436"></a><span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">irg</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>            <span class="kd">::</span> <span class="n">FZtype</span>
<a name="ln-1437"></a><span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">irg</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>            <span class="kd">::</span> <span class="n">FZorder</span>
<a name="ln-1438"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">dbl</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">OUT</span><span class="p">)</span>              <span class="kd">::</span> <span class="n">euFZ</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-1439"></a><span class="kt">logical</span><span class="p">,</span><span class="k">OPTIONAL</span><span class="p">,</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>             <span class="kd">::</span> <span class="n">MFZ</span>
<a name="ln-1440"></a>
<a name="ln-1441"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">dbl</span><span class="p">)</span>                          <span class="kd">::</span> <span class="n">Mu</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="n">qu</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="n">rod</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<a name="ln-1442"></a><span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">irg</span><span class="p">)</span>                       <span class="kd">::</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">Pmdims</span>
<a name="ln-1443"></a><span class="kt">logical</span>                                 <span class="kd">::</span> <span class="n">useMFZ</span>
<a name="ln-1444"></a>
<a name="ln-1445"></a><span class="n">useMFZ</span> <span class="o">=</span> <span class="p">.</span><span class="n">FALSE</span><span class="p">.</span>
<a name="ln-1446"></a><span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">MFZ</span><span class="p">))</span> <span class="k">then </span>
<a name="ln-1447"></a><span class="k">  if</span> <span class="p">(</span><span class="n">MFZ</span><span class="p">.</span><span class="n">eqv</span><span class="p">..</span><span class="n">TRUE</span><span class="p">.)</span> <span class="k">then</span>
<a name="ln-1448"></a><span class="k">    </span><span class="n">useMFZ</span> <span class="o">=</span> <span class="p">.</span><span class="n">TRUE</span><span class="p">.</span>
<a name="ln-1449"></a>  <span class="k">end if </span>
<a name="ln-1450"></a><span class="n">endif</span>
<a name="ln-1451"></a>
<a name="ln-1452"></a><span class="n">euFZ</span> <span class="o">=</span> <span class="mf">0.D0</span>
<a name="ln-1453"></a><span class="n">Pmdims</span> <span class="o">=</span> <span class="n">dict</span><span class="p">%</span><span class="n">Nqsym</span>
<a name="ln-1454"></a>
<a name="ln-1455"></a><span class="n">Mu</span> <span class="o">=</span> <span class="n">eu2qu</span><span class="p">(</span><span class="n">eu</span><span class="p">)</span>
<a name="ln-1456"></a><span class="k">if</span> <span class="p">(</span><span class="n">Mu</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="n">lt</span><span class="p">.</span><span class="mf">0.D0</span><span class="p">)</span> <span class="n">Mu</span> <span class="o">=</span> <span class="o">-</span><span class="n">Mu</span>
<a name="ln-1457"></a><span class="n">FZloop</span><span class="p">:</span> <span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">Pmdims</span>
<a name="ln-1458"></a>  <span class="n">qu</span> <span class="o">=</span> <span class="n">quat_mult</span><span class="p">(</span><span class="n">dict</span><span class="p">%</span><span class="n">Pm</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span><span class="n">j</span><span class="p">),</span><span class="n">Mu</span><span class="p">)</span>
<a name="ln-1459"></a>  <span class="k">if</span> <span class="p">(</span><span class="n">qu</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="n">lt</span><span class="p">.</span><span class="mf">0.D0</span><span class="p">)</span> <span class="n">qu</span> <span class="o">=</span> <span class="o">-</span><span class="n">qu</span>
<a name="ln-1460"></a>  <span class="n">rod</span> <span class="o">=</span> <span class="n">qu2ro</span><span class="p">(</span><span class="n">qu</span><span class="p">)</span>
<a name="ln-1461"></a>  <span class="k">if</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">rod</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span> <span class="p">.</span><span class="n">gt</span><span class="p">.</span> <span class="mf">1.0D10</span><span class="p">)</span> <span class="n">rod</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="n">inftyd</span>
<a name="ln-1462"></a>  
<a name="ln-1463"></a>  <span class="k">if</span> <span class="p">(</span><span class="n">useMFZ</span><span class="p">.</span><span class="n">eqv</span><span class="p">..</span><span class="n">TRUE</span><span class="p">.)</span> <span class="k">then</span>
<a name="ln-1464"></a><span class="k">    if</span> <span class="p">(</span><span class="n">IsinsideMFZ</span><span class="p">(</span><span class="n">rod</span><span class="p">,</span><span class="n">FZtype</span><span class="p">,</span><span class="n">FZorder</span><span class="p">))</span> <span class="k">EXIT </span><span class="n">FZloop</span>
<a name="ln-1465"></a>  <span class="k">else</span>
<a name="ln-1466"></a><span class="k">    if</span> <span class="p">(</span><span class="n">IsinsideFZ</span><span class="p">(</span><span class="n">rod</span><span class="p">,</span><span class="n">FZtype</span><span class="p">,</span><span class="n">FZorder</span><span class="p">))</span> <span class="k">EXIT </span><span class="n">FZloop</span>
<a name="ln-1467"></a>  <span class="k">end if</span>
<a name="ln-1468"></a>  <span class="c">! we really should never get to the following line ...</span>
<a name="ln-1469"></a>  <span class="c">!if (j.eq.Pmdims) write (*,*) &#39;problem ... &#39;,180.0*eu(1:3)/cPi,eu2ro(eu)</span>
<a name="ln-1470"></a><span class="k">end do </span><span class="n">FZloop</span>
<a name="ln-1471"></a><span class="n">euFZ</span> <span class="o">=</span> <span class="n">ro2eu</span><span class="p">(</span><span class="n">rod</span><span class="p">)</span>
<a name="ln-1472"></a>
<a name="ln-1473"></a><span class="k">end subroutine </span><span class="n">ReduceOrientationtoRFZ</span>
<a name="ln-1474"></a>
<a name="ln-1475"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-1476"></a><span class="c">!</span>
<a name="ln-1477"></a><span class="c">! SUBROUTINE: getDisorientationAngleDouble</span>
<a name="ln-1478"></a><span class="c">!</span>
<a name="ln-1479"></a><span class="c">!&gt; @author Marc De Graef, Carnegie Mellon University</span>
<a name="ln-1480"></a><span class="c">!</span>
<a name="ln-1481"></a><span class="c">!&gt; @brief Determine the disorientation angle between two orientations (in radians)</span>
<a name="ln-1482"></a><span class="c">!</span>
<a name="ln-1483"></a><span class="c">!&gt; @param eu1 first Euler triplet (in radians)</span>
<a name="ln-1484"></a><span class="c">!&gt; @param eu2 first Euler triplet (in radians)</span>
<a name="ln-1485"></a><span class="c">!&gt; @param dict dict structure</span>
<a name="ln-1486"></a><span class="c">!&gt; @param Pmdims number of symmetry operators to consider</span>
<a name="ln-1487"></a><span class="c">!</span>
<a name="ln-1488"></a><span class="c">!&gt; @date 07/29/16 MDG 1.0 original</span>
<a name="ln-1489"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-1490"></a><span class="k">recursive subroutine </span><span class="n">getDisorientationAngleDouble</span><span class="p">(</span><span class="n">eu1</span><span class="p">,</span> <span class="n">eu2</span><span class="p">,</span> <span class="n">dict</span><span class="p">,</span> <span class="n">disang</span><span class="p">,</span> <span class="n">ax</span><span class="p">)</span>
<a name="ln-1491"></a><span class="c">!DEC$ ATTRIBUTES DLLEXPORT :: getDisorientationAngleDouble</span>
<a name="ln-1492"></a>
<a name="ln-1493"></a><span class="k">use </span><span class="n">local</span>
<a name="ln-1494"></a><span class="k">use </span><span class="n">rotations</span>
<a name="ln-1495"></a><span class="k">use </span><span class="n">quaternions</span>
<a name="ln-1496"></a>
<a name="ln-1497"></a><span class="k">IMPLICIT NONE</span>
<a name="ln-1498"></a>
<a name="ln-1499"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">dbl</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>               <span class="kd">::</span> <span class="n">eu1</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-1500"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">dbl</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>               <span class="kd">::</span> <span class="n">eu2</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-1501"></a><span class="k">type</span><span class="p">(</span><span class="n">dicttype</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>               <span class="kd">::</span> <span class="n">dict</span>
<a name="ln-1502"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">dbl</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">OUT</span><span class="p">)</span>              <span class="kd">::</span> <span class="n">disang</span>
<a name="ln-1503"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">dbl</span><span class="p">),</span><span class="k">OPTIONAL</span><span class="p">,</span><span class="k">INTENT</span><span class="p">(</span><span class="n">OUT</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">ax</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-1504"></a>
<a name="ln-1505"></a>
<a name="ln-1506"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">dbl</span><span class="p">)</span>                          <span class="kd">::</span> <span class="n">Mu</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="n">qu</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="n">Mus</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="n">qus</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="n">p</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="n">ac</span><span class="p">,</span> <span class="n">a</span>
<a name="ln-1507"></a><span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">irg</span><span class="p">)</span>                       <span class="kd">::</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">Pmdims</span>
<a name="ln-1508"></a>
<a name="ln-1509"></a><span class="n">disang</span> <span class="o">=</span> <span class="mf">0.D0</span>
<a name="ln-1510"></a><span class="n">Pmdims</span> <span class="o">=</span> <span class="n">dict</span><span class="p">%</span><span class="n">Nqsym</span>
<a name="ln-1511"></a><span class="n">a</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">eu1</span><span class="o">-</span><span class="n">eu2</span><span class="p">))</span>
<a name="ln-1512"></a>
<a name="ln-1513"></a><span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="mf">0.D0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1514"></a><span class="k">  </span><span class="n">Mu</span> <span class="o">=</span> <span class="n">eu2qu</span><span class="p">(</span><span class="n">eu1</span><span class="p">)</span>
<a name="ln-1515"></a>  <span class="k">if</span> <span class="p">(</span><span class="n">Mu</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="n">lt</span><span class="p">.</span><span class="mf">0.D0</span><span class="p">)</span> <span class="n">Mu</span><span class="o">=-</span><span class="n">Mu</span>
<a name="ln-1516"></a>  <span class="n">qu</span> <span class="o">=</span> <span class="n">eu2qu</span><span class="p">(</span><span class="n">eu2</span><span class="p">)</span>
<a name="ln-1517"></a>  <span class="k">if</span> <span class="p">(</span><span class="n">qu</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="n">lt</span><span class="p">.</span><span class="mf">0.D0</span><span class="p">)</span> <span class="n">qu</span><span class="o">=-</span><span class="n">qu</span>
<a name="ln-1518"></a>  <span class="n">ac</span> <span class="o">=</span> <span class="mi">100</span><span class="mf">0.D0</span>
<a name="ln-1519"></a>  <span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">Pmdims</span> <span class="c">! loop over the symmetric equivalents of Mu</span>
<a name="ln-1520"></a>    <span class="n">Mus</span> <span class="o">=</span>  <span class="n">quat_mult</span><span class="p">(</span><span class="n">dict</span><span class="p">%</span><span class="n">Pm</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span><span class="n">j</span><span class="p">),</span><span class="n">Mu</span><span class="p">)</span>
<a name="ln-1521"></a>    <span class="k">if</span> <span class="p">(</span><span class="n">Mus</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="n">lt</span><span class="p">.</span><span class="mf">0.D0</span><span class="p">)</span> <span class="n">Mus</span><span class="o">=-</span><span class="n">Mus</span>
<a name="ln-1522"></a>    <span class="k">do </span><span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">Pmdims</span>
<a name="ln-1523"></a>      <span class="n">qus</span> <span class="o">=</span>  <span class="n">quat_mult</span><span class="p">(</span><span class="n">dict</span><span class="p">%</span><span class="n">Pm</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span><span class="n">k</span><span class="p">),</span><span class="n">qu</span><span class="p">)</span>
<a name="ln-1524"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">qus</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="n">lt</span><span class="p">.</span><span class="mf">0.D0</span><span class="p">)</span> <span class="n">qus</span><span class="o">=-</span><span class="n">qus</span>
<a name="ln-1525"></a>      <span class="n">p</span> <span class="o">=</span> <span class="n">quat_mult</span><span class="p">(</span><span class="n">Mus</span><span class="p">,</span><span class="nb">conjg</span><span class="p">(</span><span class="n">qus</span><span class="p">))</span>
<a name="ln-1526"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="n">lt</span><span class="p">.</span><span class="mf">0.D0</span><span class="p">)</span> <span class="n">p</span><span class="o">=-</span><span class="n">p</span>
<a name="ln-1527"></a>      <span class="n">a</span> <span class="o">=</span> <span class="mf">2.0</span><span class="o">*</span><span class="nb">acos</span><span class="p">(</span><span class="n">p</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
<a name="ln-1528"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">lt</span><span class="p">.</span><span class="n">ac</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1529"></a><span class="k">          </span><span class="n">ac</span> <span class="o">=</span> <span class="n">a</span>
<a name="ln-1530"></a>          <span class="k">if</span><span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">ax</span><span class="p">))</span> <span class="k">then</span>
<a name="ln-1531"></a><span class="k">              </span><span class="n">ax</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">p</span><span class="p">(</span><span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">)</span><span class="o">/</span><span class="nb">NORM2</span><span class="p">(</span><span class="n">p</span><span class="p">(</span><span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">))</span>
<a name="ln-1532"></a>          <span class="k">end if</span>
<a name="ln-1533"></a><span class="k">      end if</span>
<a name="ln-1534"></a><span class="k">      </span><span class="n">p</span> <span class="o">=</span> <span class="n">quat_mult</span><span class="p">(</span><span class="n">qus</span><span class="p">,</span><span class="nb">conjg</span><span class="p">(</span><span class="n">Mus</span><span class="p">))</span>
<a name="ln-1535"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="n">lt</span><span class="p">.</span><span class="mf">0.D0</span><span class="p">)</span> <span class="n">p</span><span class="o">=-</span><span class="n">p</span>
<a name="ln-1536"></a>      <span class="n">a</span> <span class="o">=</span> <span class="mf">2.0</span><span class="o">*</span><span class="nb">acos</span><span class="p">(</span><span class="n">p</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
<a name="ln-1537"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">lt</span><span class="p">.</span><span class="n">ac</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1538"></a><span class="k">          </span><span class="n">ac</span> <span class="o">=</span> <span class="n">a</span>
<a name="ln-1539"></a>          <span class="k">if</span><span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">ax</span><span class="p">))</span> <span class="k">then</span>
<a name="ln-1540"></a><span class="k">              </span><span class="n">ax</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">p</span><span class="p">(</span><span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">)</span><span class="o">/</span><span class="nb">NORM2</span><span class="p">(</span><span class="n">p</span><span class="p">(</span><span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">))</span>
<a name="ln-1541"></a>          <span class="k">end if</span>
<a name="ln-1542"></a><span class="k">      end if</span>
<a name="ln-1543"></a><span class="k">    end do</span>
<a name="ln-1544"></a><span class="k">  end do </span>
<a name="ln-1545"></a><span class="k">  </span><span class="n">disang</span> <span class="o">=</span> <span class="n">ac</span>
<a name="ln-1546"></a><span class="k">end if</span>
<a name="ln-1547"></a>
<a name="ln-1548"></a><span class="k">end subroutine </span><span class="n">getDisorientationAngleDouble</span>
<a name="ln-1549"></a>
<a name="ln-1550"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-1551"></a><span class="c">!</span>
<a name="ln-1552"></a><span class="c">! SUBROUTINE: getDisorientationAngleSingle</span>
<a name="ln-1553"></a><span class="c">!</span>
<a name="ln-1554"></a><span class="c">!&gt; @author Marc De Graef, Carnegie Mellon University</span>
<a name="ln-1555"></a><span class="c">!</span>
<a name="ln-1556"></a><span class="c">!&gt; @brief Determine the disorientation angle between two orientations (in radians, single precision)</span>
<a name="ln-1557"></a><span class="c">!</span>
<a name="ln-1558"></a><span class="c">!&gt; @param eu1 first Euler triplet (in radians)</span>
<a name="ln-1559"></a><span class="c">!&gt; @param eu2 first Euler triplet (in radians)</span>
<a name="ln-1560"></a><span class="c">!&gt; @param dict dict structure</span>
<a name="ln-1561"></a><span class="c">!&gt; @param Pmdims number of symmetry operators to consider</span>
<a name="ln-1562"></a><span class="c">!</span>
<a name="ln-1563"></a><span class="c">!&gt; @date 07/29/16 MDG 1.0 original</span>
<a name="ln-1564"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-1565"></a><span class="k">recursive subroutine </span><span class="n">getDisorientationAngleSingle</span><span class="p">(</span><span class="n">eu1</span><span class="p">,</span> <span class="n">eu2</span><span class="p">,</span> <span class="n">dict</span><span class="p">,</span> <span class="n">disang</span><span class="p">,</span> <span class="n">ax</span><span class="p">)</span> <span class="c">! result(disang)</span>
<a name="ln-1566"></a><span class="c">!DEC$ ATTRIBUTES DLLEXPORT :: getDisorientationAngleSingle</span>
<a name="ln-1567"></a>
<a name="ln-1568"></a><span class="k">use </span><span class="n">local</span>
<a name="ln-1569"></a><span class="k">use </span><span class="n">rotations</span>
<a name="ln-1570"></a><span class="k">use </span><span class="n">quaternions</span>
<a name="ln-1571"></a>
<a name="ln-1572"></a><span class="k">IMPLICIT NONE</span>
<a name="ln-1573"></a>
<a name="ln-1574"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>               <span class="kd">::</span> <span class="n">eu1</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-1575"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>               <span class="kd">::</span> <span class="n">eu2</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-1576"></a><span class="k">type</span><span class="p">(</span><span class="n">dicttype</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">INOUT</span><span class="p">)</span>            <span class="kd">::</span> <span class="n">dict</span>
<a name="ln-1577"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">OUT</span><span class="p">)</span>              <span class="kd">::</span> <span class="n">disang</span>
<a name="ln-1578"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">dbl</span><span class="p">),</span><span class="k">OPTIONAL</span><span class="p">,</span><span class="k">INTENT</span><span class="p">(</span><span class="n">OUT</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">ax</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-1579"></a>
<a name="ln-1580"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">)</span>                          <span class="kd">::</span> <span class="n">Mu</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="n">qu</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="n">Mus</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="n">qus</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="n">p</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="n">ac</span><span class="p">,</span> <span class="n">a</span>
<a name="ln-1581"></a><span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">irg</span><span class="p">)</span>                       <span class="kd">::</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">Pmdims</span>
<a name="ln-1582"></a>
<a name="ln-1583"></a><span class="n">disang</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-1584"></a><span class="n">Pmdims</span> <span class="o">=</span> <span class="n">dict</span><span class="p">%</span><span class="n">Nqsym</span>
<a name="ln-1585"></a><span class="n">a</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">eu1</span><span class="o">-</span><span class="n">eu2</span><span class="p">))</span>
<a name="ln-1586"></a>
<a name="ln-1587"></a><span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="mf">0.0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1588"></a><span class="k">  </span><span class="n">Mu</span> <span class="o">=</span> <span class="n">eu2qu</span><span class="p">(</span><span class="n">eu1</span><span class="p">)</span>
<a name="ln-1589"></a>  <span class="k">if</span> <span class="p">(</span><span class="n">Mu</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="n">lt</span><span class="p">.</span><span class="mf">0.0</span><span class="p">)</span> <span class="n">Mu</span><span class="o">=-</span><span class="n">Mu</span>
<a name="ln-1590"></a>  <span class="n">qu</span> <span class="o">=</span> <span class="n">eu2qu</span><span class="p">(</span><span class="n">eu2</span><span class="p">)</span>
<a name="ln-1591"></a>  <span class="k">if</span> <span class="p">(</span><span class="n">qu</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="n">lt</span><span class="p">.</span><span class="mf">0.0</span><span class="p">)</span> <span class="n">qu</span><span class="o">=-</span><span class="n">qu</span>
<a name="ln-1592"></a>  <span class="n">ac</span> <span class="o">=</span> <span class="mi">100</span><span class="mf">0.0</span>
<a name="ln-1593"></a>  <span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">Pmdims</span> <span class="c">! loop over the symmetric equivalents of Mu</span>
<a name="ln-1594"></a>    <span class="n">Mus</span> <span class="o">=</span>  <span class="n">quat_mult</span><span class="p">(</span><span class="nb">sngl</span><span class="p">(</span><span class="n">dict</span><span class="p">%</span><span class="n">Pm</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span><span class="n">j</span><span class="p">)),</span><span class="n">Mu</span><span class="p">)</span>
<a name="ln-1595"></a>    <span class="k">if</span> <span class="p">(</span><span class="n">Mus</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="n">lt</span><span class="p">.</span><span class="mf">0.0</span><span class="p">)</span> <span class="n">Mus</span><span class="o">=-</span><span class="n">Mus</span>
<a name="ln-1596"></a>    <span class="k">do </span><span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">Pmdims</span>
<a name="ln-1597"></a>      <span class="n">qus</span> <span class="o">=</span>  <span class="n">quat_mult</span><span class="p">(</span><span class="nb">sngl</span><span class="p">(</span><span class="n">dict</span><span class="p">%</span><span class="n">Pm</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span><span class="n">k</span><span class="p">)),</span><span class="n">qu</span><span class="p">)</span>
<a name="ln-1598"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">qus</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="n">lt</span><span class="p">.</span><span class="mf">0.0</span><span class="p">)</span> <span class="n">qus</span><span class="o">=-</span><span class="n">qus</span>
<a name="ln-1599"></a>      <span class="n">p</span> <span class="o">=</span> <span class="n">quat_mult</span><span class="p">(</span><span class="n">Mus</span><span class="p">,</span><span class="nb">conjg</span><span class="p">(</span><span class="n">qus</span><span class="p">))</span>
<a name="ln-1600"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="n">lt</span><span class="p">.</span><span class="mf">0.0</span><span class="p">)</span> <span class="n">p</span><span class="o">=-</span><span class="n">p</span>
<a name="ln-1601"></a>      <span class="n">a</span> <span class="o">=</span> <span class="mf">2.0</span><span class="o">*</span><span class="nb">acos</span><span class="p">(</span><span class="n">p</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
<a name="ln-1602"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">lt</span><span class="p">.</span><span class="n">ac</span><span class="p">)</span> <span class="k">then </span>
<a name="ln-1603"></a><span class="k">          </span><span class="n">ac</span> <span class="o">=</span> <span class="n">a</span>
<a name="ln-1604"></a>          <span class="k">if</span><span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">ax</span><span class="p">))</span> <span class="k">then</span>
<a name="ln-1605"></a><span class="k">              </span><span class="n">ax</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">p</span><span class="p">(</span><span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">)</span><span class="o">/</span><span class="nb">NORM2</span><span class="p">(</span><span class="n">p</span><span class="p">(</span><span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">))</span>
<a name="ln-1606"></a>          <span class="k">end if</span>
<a name="ln-1607"></a><span class="k">      end if</span>
<a name="ln-1608"></a><span class="k">      </span><span class="n">p</span> <span class="o">=</span> <span class="n">quat_mult</span><span class="p">(</span><span class="n">qus</span><span class="p">,</span><span class="nb">conjg</span><span class="p">(</span><span class="n">Mus</span><span class="p">))</span>
<a name="ln-1609"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="n">lt</span><span class="p">.</span><span class="mf">0.0</span><span class="p">)</span> <span class="n">p</span><span class="o">=-</span><span class="n">p</span>
<a name="ln-1610"></a>      <span class="n">a</span> <span class="o">=</span> <span class="mf">2.0</span><span class="o">*</span><span class="nb">acos</span><span class="p">(</span><span class="n">p</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
<a name="ln-1611"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">lt</span><span class="p">.</span><span class="n">ac</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1612"></a><span class="k">          </span><span class="n">ac</span> <span class="o">=</span> <span class="n">a</span>
<a name="ln-1613"></a>          <span class="k">if</span><span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">ax</span><span class="p">))</span> <span class="k">then</span>
<a name="ln-1614"></a><span class="k">              </span><span class="n">ax</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">p</span><span class="p">(</span><span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">)</span><span class="o">/</span><span class="nb">NORM2</span><span class="p">(</span><span class="n">p</span><span class="p">(</span><span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">))</span>
<a name="ln-1615"></a>          <span class="k">end if</span>
<a name="ln-1616"></a><span class="k">      end if </span>
<a name="ln-1617"></a><span class="k">    end do</span>
<a name="ln-1618"></a><span class="k">  end do </span>
<a name="ln-1619"></a><span class="k">  </span><span class="n">disang</span> <span class="o">=</span> <span class="n">ac</span>
<a name="ln-1620"></a><span class="k">end if</span>
<a name="ln-1621"></a>
<a name="ln-1622"></a><span class="k">end subroutine </span><span class="n">getDisorientationAngleSingle</span>
<a name="ln-1623"></a>
<a name="ln-1624"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-1625"></a><span class="c">!</span>
<a name="ln-1626"></a><span class="c">! SUBROUTINE: getDisorientationAngleAxis</span>
<a name="ln-1627"></a><span class="c">!</span>
<a name="ln-1628"></a><span class="c">!&gt; @author Saransh Singh, Carnegie Mellon University</span>
<a name="ln-1629"></a><span class="c">!</span>
<a name="ln-1630"></a><span class="c">!&gt; @brief Determine the disorientation angle and axis between two orientations (in radians)</span>
<a name="ln-1631"></a><span class="c">!</span>
<a name="ln-1632"></a><span class="c">!&gt; @param eu1 first Euler triplet (in radians)</span>
<a name="ln-1633"></a><span class="c">!&gt; @param eu2 first Euler triplet (in radians)</span>
<a name="ln-1634"></a><span class="c">!&gt; @param dict dict structure</span>
<a name="ln-1635"></a><span class="c">!</span>
<a name="ln-1636"></a><span class="c">!&gt; @date 02/14/17 SS 1.0 original</span>
<a name="ln-1637"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-1638"></a><span class="k">recursive subroutine </span><span class="n">getDisorientationAngleAxis</span><span class="p">(</span><span class="n">eu1</span><span class="p">,</span> <span class="n">eu2</span><span class="p">,</span> <span class="n">dict</span><span class="p">,</span> <span class="n">disax</span><span class="p">)</span>
<a name="ln-1639"></a><span class="c">!DEC$ ATTRIBUTES DLLEXPORT :: getDisorientationAngleAxis</span>
<a name="ln-1640"></a>
<a name="ln-1641"></a><span class="k">use </span><span class="n">local</span>
<a name="ln-1642"></a><span class="k">use </span><span class="n">rotations</span>
<a name="ln-1643"></a><span class="k">use </span><span class="n">quaternions</span>
<a name="ln-1644"></a>
<a name="ln-1645"></a><span class="k">IMPLICIT NONE</span>
<a name="ln-1646"></a>
<a name="ln-1647"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">dbl</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>               <span class="kd">::</span> <span class="n">eu1</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-1648"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">dbl</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>               <span class="kd">::</span> <span class="n">eu2</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-1649"></a><span class="k">type</span><span class="p">(</span><span class="n">dicttype</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>               <span class="kd">::</span> <span class="n">dict</span>
<a name="ln-1650"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">dbl</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">OUT</span><span class="p">)</span>              <span class="kd">::</span> <span class="n">disax</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<a name="ln-1651"></a>
<a name="ln-1652"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">dbl</span><span class="p">)</span>                          <span class="kd">::</span> <span class="n">Mu</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="n">qu</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="n">Mus</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="n">qus</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="n">p</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="n">ac</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">ax</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-1653"></a><span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">irg</span><span class="p">)</span>                       <span class="kd">::</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">Pmdims</span>
<a name="ln-1654"></a>
<a name="ln-1655"></a><span class="n">disax</span> <span class="o">=</span> <span class="mf">0.D0</span>
<a name="ln-1656"></a><span class="n">Pmdims</span> <span class="o">=</span> <span class="n">dict</span><span class="p">%</span><span class="n">Nqsym</span>
<a name="ln-1657"></a><span class="n">a</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">eu1</span><span class="o">-</span><span class="n">eu2</span><span class="p">))</span>
<a name="ln-1658"></a>
<a name="ln-1659"></a><span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="mf">0.D0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1660"></a><span class="k">  </span><span class="n">Mu</span> <span class="o">=</span> <span class="n">eu2qu</span><span class="p">(</span><span class="n">eu1</span><span class="p">)</span>
<a name="ln-1661"></a>  <span class="k">if</span> <span class="p">(</span><span class="n">Mu</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="n">lt</span><span class="p">.</span><span class="mf">0.D0</span><span class="p">)</span> <span class="n">Mu</span><span class="o">=-</span><span class="n">Mu</span>
<a name="ln-1662"></a>  <span class="n">qu</span> <span class="o">=</span> <span class="n">eu2qu</span><span class="p">(</span><span class="n">eu2</span><span class="p">)</span>
<a name="ln-1663"></a>  <span class="k">if</span> <span class="p">(</span><span class="n">qu</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="n">lt</span><span class="p">.</span><span class="mf">0.D0</span><span class="p">)</span> <span class="n">qu</span><span class="o">=-</span><span class="n">qu</span>
<a name="ln-1664"></a>  <span class="n">ac</span> <span class="o">=</span> <span class="mi">100</span><span class="mf">0.D0</span>
<a name="ln-1665"></a>  <span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">Pmdims</span> <span class="c">! loop over the symmetric equivalents of Mu</span>
<a name="ln-1666"></a>    <span class="n">Mus</span> <span class="o">=</span>  <span class="n">quat_mult</span><span class="p">(</span><span class="n">dict</span><span class="p">%</span><span class="n">Pm</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span><span class="n">j</span><span class="p">),</span><span class="n">Mu</span><span class="p">)</span>
<a name="ln-1667"></a>    <span class="k">if</span> <span class="p">(</span><span class="n">Mus</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="n">lt</span><span class="p">.</span><span class="mf">0.D0</span><span class="p">)</span> <span class="n">Mus</span><span class="o">=-</span><span class="n">Mus</span>
<a name="ln-1668"></a>    <span class="k">do </span><span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">Pmdims</span>
<a name="ln-1669"></a>      <span class="n">qus</span> <span class="o">=</span>  <span class="n">quat_mult</span><span class="p">(</span><span class="n">dict</span><span class="p">%</span><span class="n">Pm</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span><span class="n">k</span><span class="p">),</span><span class="n">qu</span><span class="p">)</span>
<a name="ln-1670"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">qus</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="n">lt</span><span class="p">.</span><span class="mf">0.D0</span><span class="p">)</span> <span class="n">qus</span><span class="o">=-</span><span class="n">qus</span>
<a name="ln-1671"></a>      <span class="n">p</span> <span class="o">=</span> <span class="n">quat_mult</span><span class="p">(</span><span class="n">Mus</span><span class="p">,</span><span class="nb">conjg</span><span class="p">(</span><span class="n">qus</span><span class="p">))</span>
<a name="ln-1672"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="n">lt</span><span class="p">.</span><span class="mf">0.D0</span><span class="p">)</span> <span class="n">p</span><span class="o">=-</span><span class="n">p</span>
<a name="ln-1673"></a>      <span class="n">a</span> <span class="o">=</span> <span class="mf">2.0</span><span class="o">*</span><span class="nb">acos</span><span class="p">(</span><span class="n">p</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
<a name="ln-1674"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">lt</span><span class="p">.</span><span class="n">ac</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1675"></a><span class="k">        </span><span class="n">ac</span> <span class="o">=</span> <span class="n">a</span>
<a name="ln-1676"></a>        <span class="n">ax</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">p</span><span class="p">(</span><span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">)</span><span class="o">/</span><span class="nb">NORM2</span><span class="p">(</span><span class="n">p</span><span class="p">(</span><span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">))</span>
<a name="ln-1677"></a>      <span class="k">end if</span>
<a name="ln-1678"></a><span class="k">      </span><span class="n">p</span> <span class="o">=</span> <span class="n">quat_mult</span><span class="p">(</span><span class="n">qus</span><span class="p">,</span><span class="nb">conjg</span><span class="p">(</span><span class="n">Mus</span><span class="p">))</span>
<a name="ln-1679"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="n">lt</span><span class="p">.</span><span class="mf">0.D0</span><span class="p">)</span> <span class="n">p</span><span class="o">=-</span><span class="n">p</span>
<a name="ln-1680"></a>      <span class="n">a</span> <span class="o">=</span> <span class="mf">2.0</span><span class="o">*</span><span class="nb">acos</span><span class="p">(</span><span class="n">p</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
<a name="ln-1681"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">lt</span><span class="p">.</span><span class="n">ac</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1682"></a><span class="k">        </span><span class="n">ac</span> <span class="o">=</span> <span class="n">a</span>
<a name="ln-1683"></a>        <span class="n">ax</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">p</span><span class="p">(</span><span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">)</span><span class="o">/</span><span class="nb">NORM2</span><span class="p">(</span><span class="n">p</span><span class="p">(</span><span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">))</span>
<a name="ln-1684"></a>      <span class="k">end if</span>
<a name="ln-1685"></a><span class="k">    end do</span>
<a name="ln-1686"></a><span class="k">  end do </span>
<a name="ln-1687"></a><span class="k">  </span><span class="n">disax</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">ax</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-1688"></a>  <span class="n">disax</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="n">ac</span>
<a name="ln-1689"></a><span class="k">end if</span>
<a name="ln-1690"></a>
<a name="ln-1691"></a><span class="k">end subroutine </span><span class="n">getDisorientationAngleAxis</span>
<a name="ln-1692"></a>
<a name="ln-1693"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-1694"></a><span class="c">!</span>
<a name="ln-1695"></a><span class="c">! SUBROUTINE: getDisorientationAngleAxisTwoPhases</span>
<a name="ln-1696"></a><span class="c">!</span>
<a name="ln-1697"></a><span class="c">!&gt; @author Saransh Singh, Carnegie Mellon University</span>
<a name="ln-1698"></a><span class="c">!</span>
<a name="ln-1699"></a><span class="c">!&gt; @brief Determine the disorientation angle and axis between two orientations (in radians)</span>
<a name="ln-1700"></a><span class="c">!</span>
<a name="ln-1701"></a><span class="c">!&gt; @param eu1 first Euler triplet (in radians)</span>
<a name="ln-1702"></a><span class="c">!&gt; @param eu2 first Euler triplet (in radians)</span>
<a name="ln-1703"></a><span class="c">!&gt; @param dict1 dict1 structure</span>
<a name="ln-1704"></a><span class="c">!&gt; @param dict2 dict2 structure</span>
<a name="ln-1705"></a><span class="c">!&gt; @param disax smallest rotation angle disorientation axis-angle pair</span>
<a name="ln-1706"></a><span class="c">!</span>
<a name="ln-1707"></a><span class="c">!&gt; @date 02/14/17 SS 1.0 original</span>
<a name="ln-1708"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-1709"></a><span class="k">recursive subroutine </span><span class="n">getDisorientationAngleAxisTwoPhases</span><span class="p">(</span><span class="n">eu1</span><span class="p">,</span> <span class="n">eu2</span><span class="p">,</span> <span class="n">dict1</span><span class="p">,</span> <span class="n">dict2</span><span class="p">,</span> <span class="n">disax</span><span class="p">)</span>
<a name="ln-1710"></a><span class="c">!DEC$ ATTRIBUTES DLLEXPORT :: getDisorientationAngleAxisTwoPhases</span>
<a name="ln-1711"></a>
<a name="ln-1712"></a><span class="k">use </span><span class="n">local</span>
<a name="ln-1713"></a><span class="k">use </span><span class="n">rotations</span>
<a name="ln-1714"></a><span class="k">use </span><span class="n">quaternions</span>
<a name="ln-1715"></a>
<a name="ln-1716"></a><span class="k">IMPLICIT NONE</span>
<a name="ln-1717"></a>
<a name="ln-1718"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">dbl</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>               <span class="kd">::</span> <span class="n">eu1</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-1719"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">dbl</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>               <span class="kd">::</span> <span class="n">eu2</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-1720"></a><span class="k">type</span><span class="p">(</span><span class="n">dicttype</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>               <span class="kd">::</span> <span class="n">dict1</span>
<a name="ln-1721"></a><span class="k">type</span><span class="p">(</span><span class="n">dicttype</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>               <span class="kd">::</span> <span class="n">dict2</span>
<a name="ln-1722"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">dbl</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">OUT</span><span class="p">)</span>              <span class="kd">::</span> <span class="n">disax</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<a name="ln-1723"></a>
<a name="ln-1724"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">dbl</span><span class="p">)</span>                          <span class="kd">::</span> <span class="n">Mu</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="n">qu</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="n">Mus</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="n">qus</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="n">p</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="n">ac</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">ax</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">axax</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<a name="ln-1725"></a><span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">irg</span><span class="p">)</span>                       <span class="kd">::</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">Pmdims1</span><span class="p">,</span> <span class="n">Pmdims2</span>
<a name="ln-1726"></a>
<a name="ln-1727"></a><span class="n">disax</span> <span class="o">=</span> <span class="mf">0.D0</span>
<a name="ln-1728"></a><span class="n">Pmdims1</span> <span class="o">=</span> <span class="n">dict1</span><span class="p">%</span><span class="n">Nqsym</span>
<a name="ln-1729"></a><span class="n">Pmdims2</span> <span class="o">=</span> <span class="n">dict2</span><span class="p">%</span><span class="n">Nqsym</span>
<a name="ln-1730"></a><span class="n">a</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">eu1</span><span class="o">-</span><span class="n">eu2</span><span class="p">))</span>
<a name="ln-1731"></a>
<a name="ln-1732"></a><span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="mf">0.D0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1733"></a><span class="k">  </span><span class="n">Mu</span> <span class="o">=</span> <span class="n">eu2qu</span><span class="p">(</span><span class="n">eu1</span><span class="p">)</span>
<a name="ln-1734"></a>  <span class="k">if</span> <span class="p">(</span><span class="n">Mu</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="n">lt</span><span class="p">.</span><span class="mf">0.D0</span><span class="p">)</span> <span class="n">Mu</span><span class="o">=-</span><span class="n">Mu</span>
<a name="ln-1735"></a>  <span class="n">qu</span> <span class="o">=</span> <span class="n">eu2qu</span><span class="p">(</span><span class="n">eu2</span><span class="p">)</span>
<a name="ln-1736"></a>  <span class="k">if</span> <span class="p">(</span><span class="n">qu</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="n">lt</span><span class="p">.</span><span class="mf">0.D0</span><span class="p">)</span> <span class="n">qu</span><span class="o">=-</span><span class="n">qu</span>
<a name="ln-1737"></a>  <span class="n">ac</span> <span class="o">=</span> <span class="mi">100</span><span class="mf">0.D0</span>
<a name="ln-1738"></a>  <span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">Pmdims1</span> <span class="c">! loop over the symmetric equivalents of Mu</span>
<a name="ln-1739"></a>    <span class="n">Mus</span> <span class="o">=</span>  <span class="n">quat_mult</span><span class="p">(</span><span class="n">dict1</span><span class="p">%</span><span class="n">Pm</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span><span class="n">j</span><span class="p">),</span><span class="n">Mu</span><span class="p">)</span>
<a name="ln-1740"></a>    <span class="k">if</span> <span class="p">(</span><span class="n">Mus</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="n">lt</span><span class="p">.</span><span class="mf">0.D0</span><span class="p">)</span> <span class="n">Mus</span><span class="o">=-</span><span class="n">Mus</span>
<a name="ln-1741"></a>    <span class="k">do </span><span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">Pmdims2</span>
<a name="ln-1742"></a>      <span class="n">qus</span> <span class="o">=</span>  <span class="n">quat_mult</span><span class="p">(</span><span class="n">dict2</span><span class="p">%</span><span class="n">Pm</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span><span class="n">k</span><span class="p">),</span><span class="n">qu</span><span class="p">)</span>
<a name="ln-1743"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">qus</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="n">lt</span><span class="p">.</span><span class="mf">0.D0</span><span class="p">)</span> <span class="n">qus</span><span class="o">=-</span><span class="n">qus</span>
<a name="ln-1744"></a>      <span class="n">p</span> <span class="o">=</span> <span class="n">quat_mult</span><span class="p">(</span><span class="n">Mus</span><span class="p">,</span><span class="nb">conjg</span><span class="p">(</span><span class="n">qus</span><span class="p">))</span>
<a name="ln-1745"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="n">lt</span><span class="p">.</span><span class="mf">0.D0</span><span class="p">)</span> <span class="n">p</span><span class="o">=-</span><span class="n">p</span>
<a name="ln-1746"></a>      <span class="n">a</span> <span class="o">=</span> <span class="mf">2.0</span><span class="o">*</span><span class="nb">acos</span><span class="p">(</span><span class="n">p</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
<a name="ln-1747"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="p">.</span><span class="n">lt</span><span class="p">.</span><span class="n">ac</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1748"></a><span class="k">        </span><span class="n">ac</span> <span class="o">=</span> <span class="n">a</span>
<a name="ln-1749"></a>        <span class="n">ax</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">p</span><span class="p">(</span><span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">)</span><span class="o">/</span><span class="nb">NORM2</span><span class="p">(</span><span class="n">p</span><span class="p">(</span><span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">))</span>
<a name="ln-1750"></a>      <span class="k">end if</span>
<a name="ln-1751"></a><span class="k">    end do</span>
<a name="ln-1752"></a><span class="k">  end do </span>
<a name="ln-1753"></a><span class="k">  </span><span class="n">disax</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">ax</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-1754"></a>  <span class="n">disax</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="n">ac</span>
<a name="ln-1755"></a><span class="k">end if</span>
<a name="ln-1756"></a>
<a name="ln-1757"></a><span class="k">end subroutine </span><span class="n">getDisorientationAngleAxisTwoPhases</span>
<a name="ln-1758"></a>
<a name="ln-1759"></a>
<a name="ln-1760"></a><span class="k">end module </span><span class="n">dictmod</span>
</pre></div>

    </section>
    </div>
  </div>

  <section class="visible-xs visible-sm hidden-md">
    <hr>
    

<div class="panel panel-default">
  <div class="panel-heading text-left"><h3 class="panel-title"><a data-toggle="collapse" href="#allfiles-1">All Source Files</a></h3></div>
  <div id="allfiles-1" class="panel-collapse collapse">
    <div class="list-group">
      
      <a class="list-group-item" href="../sourcefile/apb.f90.html">apb.f90</a>
      
      <a class="list-group-item" href="../sourcefile/bobyqa.f90.html">bobyqa.f90</a>
      
      <a class="list-group-item" href="../sourcefile/bobyqa_refinement.f90.html">bobyqa_refinement.f90</a>
      
      <a class="list-group-item" href="../sourcefile/clsupport.f90.html">CLsupport.f90</a>
      
      <a class="list-group-item" href="../sourcefile/constants.f90.html">constants.f90</a>
      
      <a class="list-group-item" href="../sourcefile/defectmodule.f90.html">defectmodule.f90</a>
      
      <a class="list-group-item" href="../sourcefile/dictmod.f90.html">dictmod.f90</a>
      
      <a class="list-group-item" href="../sourcefile/dispfield.f90.html">dispfield.f90</a>
      
      <a class="list-group-item" href="../sourcefile/distortion.f90.html">distortion.f90</a>
      
      <a class="list-group-item" href="../sourcefile/eccimod.f90.html">ECCImod.f90</a>
      
      <a class="list-group-item" href="../sourcefile/eispack.f90.html">eispack.f90</a>
      
      <a class="list-group-item" href="../sourcefile/emdymod.f90.html">EMdymod.f90</a>
      
      <a class="list-group-item" href="../sourcefile/filters.f90.html">filters.f90</a>
      
      <a class="list-group-item" href="../sourcefile/hdftest.f90.html">hdftest.f90</a>
      
      <a class="list-group-item" href="../sourcefile/indexingmod.f90.html">Indexingmod.f90</a>
      
      <a class="list-group-item" href="../sourcefile/initializers.f90.html">initializers.f90</a>
      
      <a class="list-group-item" href="../sourcefile/jsonsupport.f90.html">JSONsupport.f90</a>
      
      <a class="list-group-item" href="../sourcefile/muellercalculus.f90.html">MuellerCalculus.f90</a>
      
      <a class="list-group-item" href="../sourcefile/multibeams.f90.html">multibeams.f90</a>
      
      <a class="list-group-item" href="../sourcefile/namelisthandlers.f90.html">NameListHandlers.f90</a>
      
      <a class="list-group-item" href="../sourcefile/namelistjsonwriters.f90.html">NameListJSONwriters.f90</a>
      
      <a class="list-group-item" href="../sourcefile/namelisttypedefs.f90.html">NameListTypedefs.f90</a>
      
      <a class="list-group-item" href="../sourcefile/noise.f90.html">noise.f90</a>
      
      <a class="list-group-item" href="../sourcefile/others.f90.html">others.f90</a>
      
      <a class="list-group-item" href="../sourcefile/pedmod.f90.html">PEDmod.f90</a>
      
      <a class="list-group-item" href="../sourcefile/pfinversion.f90.html">PFInversion.f90</a>
      
      <a class="list-group-item" href="../sourcefile/pgm.f90.html">pgm.f90</a>
      
      <a class="list-group-item" href="../sourcefile/povray.f90.html">povray.f90</a>
      
      <a class="list-group-item" href="../sourcefile/rng.f90.html">rng.f90</a>
      
      <a class="list-group-item" href="../sourcefile/simulated_annealing.f90.html">simulated_annealing.f90</a>
      
      <a class="list-group-item" href="../sourcefile/so3.f90.html">so3.f90</a>
      
      <a class="list-group-item" href="../sourcefile/stemmodule.f90.html">STEMmodule.f90</a>
      
      <a class="list-group-item" href="../sourcefile/timing.f90.html">timing.f90</a>
      
    </div>
  </div>
</div>


  </section>
  
    <hr>    
    </div> <!-- /container -->
    <footer>
      <div class="container">
      <div class="row">
        <div class="col-xs-6 col-md-4"><p>&copy; 2017 <a rel="license" href="http://www.freebsd.org/copyright/freebsd-doc-license.html">FreeBSD Documentation License</a></p></div>
        <div class="col-xs-6 col-md-4 col-md-push-4">
          <p class="text-right">
            Documentation generated by 
            <a href="https://github.com/cmacmackin/ford">FORD</a>
            
          </p>
        </div>
        <div class="col-xs-12 col-md-4 col-md-pull-4"><p class="text-center"> Fortran Program was developed by Marc De Graef Research Group/Carnegie Mellon University</p></div>
      </div>
      <br>
      </div> <!-- /container -->    
    </footer>

    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
<!--
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
-->
    <script src="../js/bootstrap.min.js"></script>
    <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
    <script src="../js/ie10-viewport-bug-workaround.js"></script>

    <!-- MathJax JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        TeX: { extensions: ['AMSmath.js','AMSsymbols.js','noErrors.js','noUndefined.js'], equationNumbers: { autoNumber: 'AMS' } },
        jax: ['input/TeX','input/MathML','output/HTML-CSS'],
        extensions: ['tex2jax.js','mml2jax.js','MathMenu.js','MathZoom.js'],
        'HTML-CSS': { 
           styles: { '.MathJax_Display, .MathJax .mo, .MathJax .mi, .MathJax .mn': {color: '#000000 ! important'} }
        }
      });
    </script>
    <script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
  </body>
</html>