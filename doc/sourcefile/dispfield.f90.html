<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
	 
	 <meta name="description" content="EMsoft main library">
    
    <meta name="author" content="Marc De Graef Research Group/Carnegie Mellon University" >
    <link rel="icon" href="../favicon.png">

    <title>dispfield.f90 &ndash; Fortran Program</title>

    <link href="../css/bootstrap.min.css" rel="stylesheet">
    <link href="../css/pygments.css" rel="stylesheet">
    <link href="../css/font-awesome.min.css" rel="stylesheet">
    <link href="../css/local.css" rel="stylesheet">
    

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    
    <script src="../js/jquery-2.1.3.min.js"></script>
    <script src="../js/svg-pan-zoom.min.js"></script>

    
    <script src="../tipuesearch/tipuesearch_content.js"></script>
    <link  href="../tipuesearch/tipuesearch.css" rel="stylesheet">
    <script src="../tipuesearch/tipuesearch_set.js"></script>
    <script src="../tipuesearch/tipuesearch.js"></script>
    

  </head>

  <body>

    <!-- Fixed navbar -->
    <nav class="navbar navbar-inverse navbar-fixed-top">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="../index.html">Fortran Program </a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
				
            <li class="dropdown hidden-xs visible-sm visible-md hidden-lg">
              <a href="#" class="dropdown-toggle"
              data-toggle="dropdown" role="button"
              aria-haspopup="true"
		 aria-expanded="false">Contents <span class="caret"></span></a>
	      <ul class="dropdown-menu">
              
            <li><a href="../lists/files.html">Source Files</a></li>
				
				
            <li><a href="../lists/modules.html">Modules</a></li>
				
            
                                
            <li><a href="../lists/procedures.html">Procedures</a></li>
				
				
            <li><a href="../lists/absint.html">Abstract Interfaces</a></li>
								
            <li><a href="../lists/types.html">Derived Types</a></li>
				
				
            <li><a href="../lists/programs.html">Programs</a></li>
				
            </ul>
            </li>

<li class="visible-xs hidden-sm visible-lg"><a href="../lists/files.html">Source Files</a></li>


<li class="visible-xs hidden-sm visible-lg"><a href="../lists/modules.html">Modules</a></li>



<li class="visible-xs hidden-sm visible-lg"><a href="../lists/procedures.html">Procedures</a></li>


<li class="visible-xs hidden-sm visible-lg"><a href="../lists/absint.html">Abstract Interfaces</a></li>
                             
<li class="visible-xs hidden-sm visible-lg"><a href="../lists/types.html">Derived Types</a></li>


<li class="visible-xs hidden-sm visible-lg"><a href="../lists/programs.html">Programs</a></li>

          </ul>
        
        <form action="../search.html" class="navbar-form navbar-right" role="search">
        <div class="form-group">
          <input type="text" class="form-control" placeholder="Search" name="q" id="tipue_search_input" autocomplete="off" required>
        </div>
<!--
        <button type="submit" class="btn btn-default">Submit</button>
-->
        </form>
        
        </div><!--/.nav-collapse -->
      </div>
    </nav>

    <div class="container">
    
  
  <div class="row">
    <h1>dispfield.f90
    <small>Source File</small>
    
    </h1>
    
<div class="row">
  <div class="col-lg-12">
<div class="well well-sm">
  <ul class="list-inline" style="margin-bottom:0px;display:inline">
     
     
     
     
    
    
     <li><i class="fa fa-list-ol"></i>
       <a data-toggle="tooltip"
	  data-placement="bottom" data-html="true"
	  title=" 1.4% of total for source files.">415 statements</a>
     </li> 
     
     
    <li><i class="fa fa-code"></i><a href="../src/dispfield.f90"> Source File</a></li>
     
  </ul>
  <ol class="breadcrumb in-well text-right">
  
     <li class="active">dispfield.f90</li>
  </ol>
</div>
</div>
</div>
<script>
  $(function () {
  $('[data-toggle="tooltip"]').tooltip()
  })
</script>

  </div>
  <div class="row">
    <div class="col-md-3 hidden-xs hidden-sm visible-md visible-lg">
    
<div id="sidebar">
  





<div class="panel panel-primary">
  <div class="panel-heading text-left"><h3 class="panel-title"><a data-toggle="collapse" href="#progs-0">Programs</a></h3></div>
  <div id="progs-0" class="panel-collapse collapse">
    <div class="list-group">
      
      <a class="list-group-item" href="../program/dispfield.html">dispfield</a>
      
    </div>
  </div>
</div>


<div class="panel panel-primary">
  <div class="panel-heading text-left"><h3 class="panel-title"><a data-toggle="collapse" href="#mods-0">Modules</a></h3></div>
  <div id="mods-0" class="panel-collapse collapse">
    <div class="list-group">
      
      <a class="list-group-item" href="../module/yshmodule.html">YSHModule</a>
      
    </div>
  </div>
</div>








<div class="panel panel-primary">
  <div class="panel-heading text-left"><h3 class="panel-title"><a data-toggle="collapse" href="#subs-0">Subroutines</a></h3></div>
  <div class="list-group">
    <div id="subs-0" class="panel-collapse collapse">
      
      <a class="list-group-item" href="../proc/calcrlocal.html">CalcRLocal</a>
      
    </div>
  </div>
</div>








<div class="panel panel-primary">
  <div class="panel-heading text-left"><h3 class="panel-title">Source Code</h3></div>
  <div class="list-group">
    <a class="list-group-item" href="../sourcefile/dispfield.f90.html#src">dispfield.f90</a>
  </div>
</div>


  <hr>
  

<div class="panel panel-default">
  <div class="panel-heading text-left"><h3 class="panel-title"><a data-toggle="collapse" href="#allfiles-0">All Source Files</a></h3></div>
  <div id="allfiles-0" class="panel-collapse collapse">
    <div class="list-group">
      
      <a class="list-group-item" href="../sourcefile/apb.f90.html">apb.f90</a>
      
      <a class="list-group-item" href="../sourcefile/bobyqa.f90.html">bobyqa.f90</a>
      
      <a class="list-group-item" href="../sourcefile/bobyqa_refinement.f90.html">bobyqa_refinement.f90</a>
      
      <a class="list-group-item" href="../sourcefile/clsupport.f90.html">CLsupport.f90</a>
      
      <a class="list-group-item" href="../sourcefile/constants.f90.html">constants.f90</a>
      
      <a class="list-group-item" href="../sourcefile/defectmodule.f90.html">defectmodule.f90</a>
      
      <a class="list-group-item" href="../sourcefile/dictmod.f90.html">dictmod.f90</a>
      
      <a class="list-group-item" href="../sourcefile/dispfield.f90.html">dispfield.f90</a>
      
      <a class="list-group-item" href="../sourcefile/distortion.f90.html">distortion.f90</a>
      
      <a class="list-group-item" href="../sourcefile/eccimod.f90.html">ECCImod.f90</a>
      
      <a class="list-group-item" href="../sourcefile/eispack.f90.html">eispack.f90</a>
      
      <a class="list-group-item" href="../sourcefile/emdymod.f90.html">EMdymod.f90</a>
      
      <a class="list-group-item" href="../sourcefile/filters.f90.html">filters.f90</a>
      
      <a class="list-group-item" href="../sourcefile/hdftest.f90.html">hdftest.f90</a>
      
      <a class="list-group-item" href="../sourcefile/indexingmod.f90.html">Indexingmod.f90</a>
      
      <a class="list-group-item" href="../sourcefile/initializers.f90.html">initializers.f90</a>
      
      <a class="list-group-item" href="../sourcefile/jsonsupport.f90.html">JSONsupport.f90</a>
      
      <a class="list-group-item" href="../sourcefile/muellercalculus.f90.html">MuellerCalculus.f90</a>
      
      <a class="list-group-item" href="../sourcefile/multibeams.f90.html">multibeams.f90</a>
      
      <a class="list-group-item" href="../sourcefile/namelisthandlers.f90.html">NameListHandlers.f90</a>
      
      <a class="list-group-item" href="../sourcefile/namelistjsonwriters.f90.html">NameListJSONwriters.f90</a>
      
      <a class="list-group-item" href="../sourcefile/namelisttypedefs.f90.html">NameListTypedefs.f90</a>
      
      <a class="list-group-item" href="../sourcefile/noise.f90.html">noise.f90</a>
      
      <a class="list-group-item" href="../sourcefile/others.f90.html">others.f90</a>
      
      <a class="list-group-item" href="../sourcefile/pedmod.f90.html">PEDmod.f90</a>
      
      <a class="list-group-item" href="../sourcefile/pfinversion.f90.html">PFInversion.f90</a>
      
      <a class="list-group-item" href="../sourcefile/pgm.f90.html">pgm.f90</a>
      
      <a class="list-group-item" href="../sourcefile/povray.f90.html">povray.f90</a>
      
      <a class="list-group-item" href="../sourcefile/rng.f90.html">rng.f90</a>
      
      <a class="list-group-item" href="../sourcefile/simulated_annealing.f90.html">simulated_annealing.f90</a>
      
      <a class="list-group-item" href="../sourcefile/so3.f90.html">so3.f90</a>
      
      <a class="list-group-item" href="../sourcefile/stemmodule.f90.html">STEMmodule.f90</a>
      
      <a class="list-group-item" href="../sourcefile/timing.f90.html">timing.f90</a>
      
    </div>
  </div>
</div>


</div>  

    </div>
    <div class="col-md-9" id='text'>
    
    
    <h3>This File Depends On</h3>
    
                <div class="depgraph"><?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.38.0 (20140413.2041)
 -->
<!-- Title: sourcefile~~dispfield.f90~~EfferentGraph Pages: 1 -->
<svg id="sourcefiledispfieldf90EfferentGraph" width="641pt" height="196pt"
 viewBox="0.00 0.00 641.00 195.69" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="sourcefile~~dispfield.f90~~EfferentGraph" class="graph" transform="scale(0.998442 0.998442) rotate(0) translate(4 192)">
<title>sourcefile~~dispfield.f90~~EfferentGraph</title>
<polygon fill="white" stroke="none" points="-4,4 -4,-192 638,-192 638,4 -4,4"/>
<!-- sourcefile~dispfield.f90 -->
<g id="sourcefile~~dispfield.f90~~EfferentGraph_node1" class="node"><title>sourcefile~dispfield.f90</title>
<polygon fill="none" stroke="black" points="634,-108 565,-108 565,-84 634,-84 634,-108"/>
<text text-anchor="middle" x="599.5" y="-93.6" font-family="Helvetica,sans-Serif" font-size="10.50">dispfield.f90</text>
</g>
<!-- sourcefile~pgm.f90 -->
<g id="sourcefile~~dispfield.f90~~EfferentGraph_node2" class="node"><title>sourcefile~pgm.f90</title>
<g id="a_sourcefile~~dispfield.f90~~EfferentGraph_node2"><a xlink:href="../sourcefile/pgm.f90.html" xlink:title="pgm.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="509,-188 455,-188 455,-164 509,-164 509,-188"/>
<text text-anchor="middle" x="482" y="-173.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">pgm.f90</text>
</a>
</g>
</g>
<!-- sourcefile~pgm.f90&#45;&gt;sourcefile~dispfield.f90 -->
<g id="sourcefile~~dispfield.f90~~EfferentGraph_edge7" class="edge"><title>sourcefile~pgm.f90&#45;&gt;sourcefile~dispfield.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M505.856,-163.947C513.369,-159.758 521.67,-154.881 529,-150 545.535,-138.988 563.202,-125.233 576.585,-114.362"/>
<polygon fill="#ff0000" stroke="#ff0000" points="578.807,-117.066 584.316,-108.015 574.366,-111.655 578.807,-117.066"/>
</g>
<!-- sourcefile~defectmodule.f90 -->
<g id="sourcefile~~dispfield.f90~~EfferentGraph_node3" class="node"><title>sourcefile~defectmodule.f90</title>
<g id="a_sourcefile~~dispfield.f90~~EfferentGraph_node3"><a xlink:href="../sourcefile/defectmodule.f90.html" xlink:title="defectmodule.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="528.5,-108 435.5,-108 435.5,-84 528.5,-84 528.5,-108"/>
<text text-anchor="middle" x="482" y="-93.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">defectmodule.f90</text>
</a>
</g>
</g>
<!-- sourcefile~defectmodule.f90&#45;&gt;sourcefile~dispfield.f90 -->
<g id="sourcefile~~dispfield.f90~~EfferentGraph_edge8" class="edge"><title>sourcefile~defectmodule.f90&#45;&gt;sourcefile~dispfield.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M528.649,-96C537.256,-96 546.238,-96 554.784,-96"/>
<polygon fill="#ff0000" stroke="#ff0000" points="554.938,-99.5001 564.937,-96 554.937,-92.5001 554.938,-99.5001"/>
</g>
<!-- sourcefile~stemmodule.f90 -->
<g id="sourcefile~~dispfield.f90~~EfferentGraph_node4" class="node"><title>sourcefile~stemmodule.f90</title>
<g id="a_sourcefile~~dispfield.f90~~EfferentGraph_node4"><a xlink:href="../sourcefile/stemmodule.f90.html" xlink:title="STEMmodule.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="529,-66 435,-66 435,-42 529,-42 529,-66"/>
<text text-anchor="middle" x="482" y="-51.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">STEMmodule.f90</text>
</a>
</g>
</g>
<!-- sourcefile~stemmodule.f90&#45;&gt;sourcefile~dispfield.f90 -->
<g id="sourcefile~~dispfield.f90~~EfferentGraph_edge9" class="edge"><title>sourcefile~stemmodule.f90&#45;&gt;sourcefile~dispfield.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M516.098,-66.0355C528.421,-70.5169 542.589,-75.6688 555.662,-80.4227"/>
<polygon fill="#ff0000" stroke="#ff0000" points="554.803,-83.8345 565.398,-83.9627 557.196,-77.256 554.803,-83.8345"/>
</g>
<!-- sourcefile~constants.f90 -->
<g id="sourcefile~~dispfield.f90~~EfferentGraph_node5" class="node"><title>sourcefile~constants.f90</title>
<g id="a_sourcefile~~dispfield.f90~~EfferentGraph_node5"><a xlink:href="../sourcefile/constants.f90.html" xlink:title="constants.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="96.5,-138 21.5,-138 21.5,-114 96.5,-114 96.5,-138"/>
<text text-anchor="middle" x="59" y="-123.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">constants.f90</text>
</a>
</g>
</g>
<!-- sourcefile~constants.f90&#45;&gt;sourcefile~dispfield.f90 -->
<g id="sourcefile~~dispfield.f90~~EfferentGraph_edge10" class="edge"><title>sourcefile~constants.f90&#45;&gt;sourcefile~dispfield.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M353.5,-136C431.726,-129.995 452.118,-132.636 529,-117 537.523,-115.267 546.5,-112.942 555.068,-110.471"/>
<polygon fill="#ff0000" stroke="#ff0000" points="556.311,-113.752 564.886,-107.529 554.302,-107.047 556.311,-113.752"/>
</g>
<!-- sourcefile~constants.f90&#45;&gt;sourcefile~defectmodule.f90 -->
<g id="sourcefile~~dispfield.f90~~EfferentGraph_edge6" class="edge"><title>sourcefile~constants.f90&#45;&gt;sourcefile~defectmodule.f90</title>
<path fill="none" stroke="#cbff00" stroke-dasharray="5,2" d="M353.5,-136C385.56,-133.539 420.278,-122.018 445.379,-111.968"/>
<polygon fill="#cbff00" stroke="#cbff00" points="446.927,-115.116 454.838,-108.069 444.258,-108.644 446.927,-115.116"/>
<path fill="none" stroke="#cbff00" stroke-dasharray="5,2" d="M96.8681,-129.878C152.235,-135.112 260.115,-143.015 351.5,-136"/>
</g>
<!-- sourcefile~namelisthandlers.f90 -->
<g id="sourcefile~~dispfield.f90~~EfferentGraph_node8" class="node"><title>sourcefile~namelisthandlers.f90</title>
<g id="a_sourcefile~~dispfield.f90~~EfferentGraph_node8"><a xlink:href="../sourcefile/namelisthandlers.f90.html" xlink:title="NameListHandlers.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="270,-108 154,-108 154,-84 270,-84 270,-108"/>
<text text-anchor="middle" x="212" y="-93.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">NameListHandlers.f90</text>
</a>
</g>
</g>
<!-- sourcefile~constants.f90&#45;&gt;sourcefile~namelisthandlers.f90 -->
<g id="sourcefile~~dispfield.f90~~EfferentGraph_edge2" class="edge"><title>sourcefile~constants.f90&#45;&gt;sourcefile~namelisthandlers.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M96.5529,-118.738C110.792,-115.909 127.577,-112.574 143.839,-109.343"/>
<polygon fill="#ff0000" stroke="#ff0000" points="144.743,-112.732 153.87,-107.35 143.379,-105.866 144.743,-112.732"/>
</g>
<!-- sourcefile~timing.f90 -->
<g id="sourcefile~~dispfield.f90~~EfferentGraph_node6" class="node"><title>sourcefile~timing.f90</title>
<g id="a_sourcefile~~dispfield.f90~~EfferentGraph_node6"><a xlink:href="../sourcefile/timing.f90.html" xlink:title="timing.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="511,-24 453,-24 453,-0 511,-0 511,-24"/>
<text text-anchor="middle" x="482" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">timing.f90</text>
</a>
</g>
</g>
<!-- sourcefile~timing.f90&#45;&gt;sourcefile~dispfield.f90 -->
<g id="sourcefile~~dispfield.f90~~EfferentGraph_edge11" class="edge"><title>sourcefile~timing.f90&#45;&gt;sourcefile~dispfield.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M511.464,-23.3329C517.442,-26.1652 523.574,-29.4272 529,-33 547.874,-45.4285 566.707,-62.8939 579.998,-76.284"/>
<polygon fill="#ff0000" stroke="#ff0000" points="577.66,-78.9001 587.142,-83.628 582.678,-74.0193 577.66,-78.9001"/>
</g>
<!-- sourcefile~jsonsupport.f90 -->
<g id="sourcefile~~dispfield.f90~~EfferentGraph_node7" class="node"><title>sourcefile~jsonsupport.f90</title>
<g id="a_sourcefile~~dispfield.f90~~EfferentGraph_node7"><a xlink:href="../sourcefile/jsonsupport.f90.html" xlink:title="JSONsupport.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="399,-108 306,-108 306,-84 399,-84 399,-108"/>
<text text-anchor="middle" x="352.5" y="-93.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">JSONsupport.f90</text>
</a>
</g>
</g>
<!-- sourcefile~jsonsupport.f90&#45;&gt;sourcefile~defectmodule.f90 -->
<g id="sourcefile~~dispfield.f90~~EfferentGraph_edge5" class="edge"><title>sourcefile~jsonsupport.f90&#45;&gt;sourcefile~defectmodule.f90</title>
<path fill="none" stroke="#cbff00" stroke-dasharray="5,2" d="M399.17,-96C407.593,-96 416.475,-96 425.158,-96"/>
<polygon fill="#cbff00" stroke="#cbff00" points="425.22,-99.5001 435.22,-96 425.22,-92.5001 425.22,-99.5001"/>
</g>
<!-- sourcefile~namelisthandlers.f90&#45;&gt;sourcefile~jsonsupport.f90 -->
<g id="sourcefile~~dispfield.f90~~EfferentGraph_edge3" class="edge"><title>sourcefile~namelisthandlers.f90&#45;&gt;sourcefile~jsonsupport.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M270.133,-96C278.609,-96 287.335,-96 295.781,-96"/>
<polygon fill="#ff0000" stroke="#ff0000" points="295.91,-99.5001 305.91,-96 295.91,-92.5001 295.91,-99.5001"/>
</g>
<!-- sourcefile~namelisttypedefs.f90 -->
<g id="sourcefile~~dispfield.f90~~EfferentGraph_node9" class="node"><title>sourcefile~namelisttypedefs.f90</title>
<g id="a_sourcefile~~dispfield.f90~~EfferentGraph_node9"><a xlink:href="../sourcefile/namelisttypedefs.f90.html" xlink:title="NameListTypedefs.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="118,-87 0,-87 0,-63 118,-63 118,-87"/>
<text text-anchor="middle" x="59" y="-72.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">NameListTypedefs.f90</text>
</a>
</g>
</g>
<!-- sourcefile~namelisttypedefs.f90&#45;&gt;sourcefile~jsonsupport.f90 -->
<g id="sourcefile~~dispfield.f90~~EfferentGraph_edge4" class="edge"><title>sourcefile~namelisttypedefs.f90&#45;&gt;sourcefile~jsonsupport.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M118.185,-71.0863C160.476,-69.1918 219.002,-68.5353 270,-75 280.876,-76.3787 292.378,-78.7532 303.204,-81.4213"/>
<polygon fill="#ff0000" stroke="#ff0000" points="302.362,-84.8185 312.92,-83.934 304.115,-78.0415 302.362,-84.8185"/>
</g>
<!-- sourcefile~namelisttypedefs.f90&#45;&gt;sourcefile~namelisthandlers.f90 -->
<g id="sourcefile~~dispfield.f90~~EfferentGraph_edge1" class="edge"><title>sourcefile~namelisttypedefs.f90&#45;&gt;sourcefile~namelisthandlers.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M118.381,-83.1191C126.641,-84.2679 135.19,-85.4568 143.603,-86.6268"/>
<polygon fill="#ff0000" stroke="#ff0000" points="143.382,-90.1298 153.769,-88.0407 144.346,-83.1965 143.382,-90.1298"/>
</g>
</g>
</svg>
</div>
                <script>var pansourcefiledispfieldf90EfferentGraph = svgPanZoom('#sourcefiledispfieldf90EfferentGraph', {
                    zoomEnabled: true,
                    controlIconsEnabled: true,
                    fit: true,
                    center: true,});
                    </script>
                <div><a type="button" class="graph-help" data-toggle="modal" href="#graph-help-text">Help</a></div>
                <div class="modal fade" id="graph-help-text" tabindex="-1" role="dialog">
                  <div class="modal-dialog modal-lg" role="document">
                    <div class="modal-content">
                      <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                        <h4 class="modal-title" id="-graph-help-label">Graph Key</h4>
                      </div>
                      <div class="modal-body">
                        
    <p>Nodes of different colours represent the following: </p>
    <?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.38.0 (20140413.2041)
 -->
<!-- Title: Graph Key Pages: 1 -->
<svg width="188pt" height="32pt"
 viewBox="0.00 0.00 188.00 32.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 28)">
<title>Graph Key</title>
<polygon fill="white" stroke="none" points="-4,4 -4,-28 184,-28 184,4 -4,4"/>
<!-- Source File -->
<g id="node1" class="node"><title>Source File</title>
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="66,-24 0,-24 0,-0 66,-0 66,-24"/>
<text text-anchor="middle" x="33" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Source File</text>
</g>
<!-- This Page&#39;s Entity -->
<g id="node2" class="node"><title>This Page&#39;s Entity</title>
<polygon fill="none" stroke="black" points="180,-24 84,-24 84,-0 180,-0 180,-24"/>
<text text-anchor="middle" x="132" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50">This Page&#39;s Entity</text>
</g>
</g>
</svg>

    
    <p>Solid arrows point from a file to a file which depends upon it. A file 
    is dependent upon another if the latter must be compiled before the former
    can be. Where possible, edges connecting nodes are given different colours to make them easier to distinguish in large graphs.
    </p>
    
                      </div>
                    </div>
                  </div>
                </div>
                
    
      
      <br>

    <section class="visible-xs visible-sm hidden-md">
      





<div class="panel panel-primary">
  <div class="panel-heading text-left"><h3 class="panel-title"><a data-toggle="collapse" href="#progs-1">Programs</a></h3></div>
  <div id="progs-1" class="panel-collapse collapse">
    <div class="list-group">
      
      <a class="list-group-item" href="../program/dispfield.html">dispfield</a>
      
    </div>
  </div>
</div>


<div class="panel panel-primary">
  <div class="panel-heading text-left"><h3 class="panel-title"><a data-toggle="collapse" href="#mods-1">Modules</a></h3></div>
  <div id="mods-1" class="panel-collapse collapse">
    <div class="list-group">
      
      <a class="list-group-item" href="../module/yshmodule.html">YSHModule</a>
      
    </div>
  </div>
</div>








<div class="panel panel-primary">
  <div class="panel-heading text-left"><h3 class="panel-title"><a data-toggle="collapse" href="#subs-1">Subroutines</a></h3></div>
  <div class="list-group">
    <div id="subs-1" class="panel-collapse collapse">
      
      <a class="list-group-item" href="../proc/calcrlocal.html">CalcRLocal</a>
      
    </div>
  </div>
</div>








<div class="panel panel-primary">
  <div class="panel-heading text-left"><h3 class="panel-title">Source Code</h3></div>
  <div class="list-group">
    <a class="list-group-item" href="../sourcefile/dispfield.f90.html#src">dispfield.f90</a>
  </div>
</div>


    </section>
    <br class="visible-xs visible-sm hidden-md">

    <section>
      <h2><span class="anchor" id="src"></span>Source Code</h2>
    <div class="hl"><pre><span></span><a name="ln-1"></a><span class="k">module </span><span class="n">YSHModule</span>
<a name="ln-2"></a>
<a name="ln-3"></a><span class="k">use </span><span class="n">local</span>
<a name="ln-4"></a>
<a name="ln-5"></a><span class="k">IMPLICIT NONE</span>
<a name="ln-6"></a>
<a name="ln-7"></a><span class="k">type </span><span class="n">YDtype</span>
<a name="ln-8"></a>  <span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">burg</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">burgd</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">u</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">un</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">g</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">gn</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">id</span><span class="p">,</span> <span class="n">jd</span><span class="p">,</span> <span class="n">zu</span><span class="p">,</span> <span class="n">bs</span><span class="p">,</span> <span class="n">be</span><span class="p">,</span> <span class="n">bx</span><span class="p">,</span> <span class="n">beta</span>
<a name="ln-9"></a>  <span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">ca</span><span class="p">,</span> <span class="n">sa</span><span class="p">,</span> <span class="n">ta</span><span class="p">,</span> <span class="n">cota</span><span class="p">,</span> <span class="n">a_dc</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="n">a_id</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="n">a_di</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">top</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">bottom</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">sig</span>
<a name="ln-10"></a><span class="k">end type </span><span class="n">YDtype</span>
<a name="ln-11"></a>
<a name="ln-12"></a><span class="k">type</span> <span class="p">(</span><span class="n">YDtype</span><span class="p">),</span> <span class="k">allocatable</span>  <span class="kd">::</span> <span class="n">YD</span><span class="p">(:)</span>    
<a name="ln-13"></a><span class="c">!DEC$ ATTRIBUTES DLLEXPORT :: YD</span>
<a name="ln-14"></a>
<a name="ln-15"></a>
<a name="ln-16"></a><span class="k">contains</span>
<a name="ln-17"></a>
<a name="ln-18"></a>
<a name="ln-19"></a>
<a name="ln-20"></a>
<a name="ln-21"></a><span class="k">recursive function </span><span class="n">YSHDisp</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="n">ii</span><span class="p">)</span>
<a name="ln-22"></a><span class="c">!DEC$ ATTRIBUTES DLLEXPORT :: YSHDisp</span>
<a name="ln-23"></a><span class="c">!</span>
<a name="ln-24"></a><span class="c">! compute the displacement field of an inclined dislocation intersection the top surface of </span>
<a name="ln-25"></a><span class="c">! the foil, taking into account surface relaxations for the isotropic elastic case (cubic only) ... </span>
<a name="ln-26"></a><span class="c">!</span>
<a name="ln-27"></a><span class="c">! equations are based on the Shaibani&amp;Hazzledine 1981 paper, along with special limits for </span>
<a name="ln-28"></a><span class="c">! the alpha-&gt;0 case, which were derived by MDG using Mathematica.</span>
<a name="ln-29"></a>
<a name="ln-30"></a><span class="k">use </span><span class="n">local</span>
<a name="ln-31"></a><span class="k">use </span><span class="n">constants</span>
<a name="ln-32"></a>
<a name="ln-33"></a><span class="k">IMPLICIT NONE</span>
<a name="ln-34"></a>
<a name="ln-35"></a><span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">irg</span><span class="p">)</span>  <span class="kd">::</span>  <span class="n">ii</span>
<a name="ln-36"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">dbl</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">eta</span><span class="p">,</span> <span class="n">zeta</span><span class="p">,</span> <span class="n">etap</span><span class="p">,</span> <span class="n">zetap</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">oms</span><span class="p">,</span> <span class="n">omts</span><span class="p">,</span> <span class="n">xx</span><span class="p">,</span> <span class="n">sgn</span><span class="p">,</span> <span class="n">om</span><span class="p">,</span> <span class="n">omp</span><span class="p">,</span> <span class="n">AA</span><span class="p">,</span> <span class="n">BB</span><span class="p">,</span> <span class="n">BBp</span><span class="p">,</span> <span class="n">th</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-37"></a>                             <span class="n">k</span><span class="p">,</span> <span class="n">lam</span><span class="p">,</span> <span class="n">alA</span><span class="p">,</span> <span class="n">alB</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">ms</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">du</span><span class="p">,</span> <span class="n">dv</span><span class="p">,</span> <span class="n">dw</span><span class="p">,</span> <span class="n">qe</span><span class="p">,</span> <span class="n">me</span><span class="p">,</span> <span class="n">De</span><span class="p">,</span> <span class="n">qx</span><span class="p">,</span> <span class="n">mx</span><span class="p">,</span> <span class="n">Dx</span><span class="p">,</span> <span class="n">rr</span><span class="p">,</span> <span class="n">eps</span>
<a name="ln-38"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">dbl</span><span class="p">)</span> <span class="kd">::</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span>
<a name="ln-39"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">dbl</span><span class="p">)</span> <span class="kd">::</span> <span class="n">YSHDisp</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> 
<a name="ln-40"></a>
<a name="ln-41"></a><span class="c">! initialize the geometrical parameters</span>
<a name="ln-42"></a><span class="n">eta</span>  <span class="o">=</span> <span class="n">y</span><span class="o">*</span><span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">ca</span> <span class="o">-</span> <span class="n">z</span><span class="o">*</span><span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">sa</span>
<a name="ln-43"></a><span class="n">zeta</span> <span class="o">=</span> <span class="n">y</span><span class="o">*</span><span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">sa</span> <span class="o">+</span> <span class="n">z</span><span class="o">*</span><span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">ca</span>
<a name="ln-44"></a><span class="n">etap</span>  <span class="o">=</span> <span class="o">-</span><span class="n">y</span><span class="o">*</span><span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">ca</span> <span class="o">-</span> <span class="n">z</span><span class="o">*</span><span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">sa</span>
<a name="ln-45"></a><span class="n">zetap</span> <span class="o">=</span> <span class="n">y</span><span class="o">*</span><span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">sa</span> <span class="o">-</span> <span class="n">z</span><span class="o">*</span><span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">ca</span>
<a name="ln-46"></a><span class="n">r</span> <span class="o">=</span> <span class="nb">sqrt</span><span class="p">(</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">y</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">z</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> 
<a name="ln-47"></a><span class="n">oms</span> <span class="o">=</span> <span class="mf">1.D0</span><span class="o">-</span><span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">sig</span>
<a name="ln-48"></a><span class="n">omts</span> <span class="o">=</span> <span class="mf">1.D0</span><span class="o">-</span><span class="mf">2.D0</span><span class="o">*</span><span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">sig</span>
<a name="ln-49"></a>
<a name="ln-50"></a><span class="c">! cover the special case of negative x values (based on IDL tests)</span>
<a name="ln-51"></a><span class="n">xx</span> <span class="o">=</span> <span class="n">x</span>
<a name="ln-52"></a><span class="k">if</span> <span class="p">(</span><span class="n">xx</span><span class="p">.</span><span class="n">lt</span><span class="p">.</span><span class="mf">0.D0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-53"></a><span class="k">  </span><span class="n">x</span> <span class="o">=</span> <span class="nb">dabs</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<a name="ln-54"></a>  <span class="n">sgn</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.D0</span>
<a name="ln-55"></a><span class="k">else </span>
<a name="ln-56"></a><span class="k">  </span><span class="n">sgn</span> <span class="o">=</span> <span class="mf">1.D0</span>
<a name="ln-57"></a><span class="k">end if</span>
<a name="ln-58"></a>
<a name="ln-59"></a><span class="c">! more parameters</span>
<a name="ln-60"></a><span class="n">om</span> <span class="o">=</span>  <span class="p">(</span><span class="n">datan2</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">x</span><span class="p">)</span><span class="o">-</span><span class="n">datan2</span><span class="p">(</span><span class="n">eta</span><span class="p">,</span><span class="n">x</span><span class="p">)</span><span class="o">+</span><span class="n">datan2</span><span class="p">(</span><span class="n">x</span><span class="o">*</span><span class="n">r</span><span class="o">*</span><span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">sa</span><span class="p">,</span><span class="n">eta</span><span class="o">*</span><span class="n">y</span><span class="o">+</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">ca</span><span class="p">))</span>
<a name="ln-61"></a><span class="n">omp</span><span class="o">=</span> <span class="p">(</span><span class="n">datan2</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">x</span><span class="p">)</span><span class="o">-</span><span class="n">datan2</span><span class="p">(</span><span class="n">etap</span><span class="p">,</span><span class="n">x</span><span class="p">)</span><span class="o">+</span><span class="n">datan2</span><span class="p">(</span><span class="n">x</span><span class="o">*</span><span class="n">r</span><span class="o">*</span><span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">sa</span><span class="p">,</span><span class="n">etap</span><span class="o">*</span><span class="n">y</span><span class="o">-</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">ca</span><span class="p">))</span>
<a name="ln-62"></a>
<a name="ln-63"></a><span class="n">AA</span> <span class="o">=</span> <span class="n">r</span><span class="o">-</span><span class="n">z</span>
<a name="ln-64"></a><span class="n">BB</span>  <span class="o">=</span> <span class="n">r</span><span class="o">-</span><span class="n">zeta</span>
<a name="ln-65"></a><span class="n">BBp</span> <span class="o">=</span> <span class="n">r</span><span class="o">-</span><span class="n">zetap</span> 
<a name="ln-66"></a><span class="n">th</span> <span class="o">=</span> <span class="mf">2.D0</span><span class="o">*</span><span class="n">oms</span><span class="o">*</span><span class="p">(</span><span class="n">omp</span><span class="o">-</span><span class="n">om</span><span class="p">)</span>
<a name="ln-67"></a><span class="n">k</span> <span class="o">=</span> <span class="mf">4.D0</span><span class="o">*</span><span class="n">oms</span><span class="o">*</span><span class="n">omts</span><span class="o">*</span><span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">cota</span><span class="o">**</span><span class="mi">2</span>
<a name="ln-68"></a><span class="n">lam</span> <span class="o">=</span> <span class="n">omts</span><span class="o">*</span><span class="nb">dlog</span><span class="p">(</span><span class="n">BBp</span><span class="o">/</span><span class="n">BB</span><span class="p">)</span>
<a name="ln-69"></a><span class="n">alA</span> <span class="o">=</span> <span class="nb">dlog</span><span class="p">(</span><span class="n">AA</span><span class="p">)</span>
<a name="ln-70"></a><span class="n">alB</span> <span class="o">=</span> <span class="nb">dlog</span><span class="p">(</span><span class="n">BB</span><span class="p">)</span>
<a name="ln-71"></a>
<a name="ln-72"></a>
<a name="ln-73"></a><span class="n">u</span> <span class="o">=</span> <span class="mf">0.D0</span>
<a name="ln-74"></a><span class="n">v</span> <span class="o">=</span> <span class="mf">0.D0</span>
<a name="ln-75"></a><span class="n">w</span> <span class="o">=</span> <span class="mf">0.D0</span>
<a name="ln-76"></a><span class="n">eps</span> <span class="o">=</span> <span class="mf">1.0D-6</span>
<a name="ln-77"></a>
<a name="ln-78"></a><span class="c">! screw component first</span>
<a name="ln-79"></a><span class="k">if</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">bs</span><span class="p">).</span><span class="n">gt</span><span class="p">.</span><span class="n">eps</span><span class="p">)</span> <span class="k">then </span>
<a name="ln-80"></a><span class="k">  </span><span class="n">ms</span> <span class="o">=</span> <span class="n">x</span><span class="o">*</span><span class="nb">sin</span><span class="p">(</span><span class="mf">2.D0</span><span class="o">*</span><span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">alpha</span><span class="p">)</span><span class="o">/</span><span class="n">r</span><span class="o">/</span><span class="n">BB</span>
<a name="ln-81"></a>  <span class="n">S</span> <span class="o">=</span> <span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">bs</span><span class="o">/</span><span class="p">(</span><span class="mf">4.D0</span><span class="o">*</span><span class="n">cPi</span><span class="p">)</span>
<a name="ln-82"></a>  <span class="k">if</span> <span class="p">(</span><span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">alpha</span><span class="p">.</span><span class="n">gt</span><span class="p">.</span><span class="mf">0.01</span><span class="p">)</span> <span class="k">then </span>
<a name="ln-83"></a><span class="k">    </span><span class="n">du</span> <span class="o">=</span> <span class="n">x</span><span class="o">*</span><span class="n">ms</span><span class="o">+</span><span class="mf">2.D0</span><span class="o">*</span><span class="n">eta</span><span class="o">*</span><span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">ca</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="n">BB</span><span class="o">+</span><span class="mf">2.D0</span><span class="o">*</span><span class="n">omts</span><span class="o">*</span><span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">cota</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="mf">1.D0</span><span class="o">+</span><span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">ca</span><span class="o">+</span><span class="p">&amp;</span>
<a name="ln-84"></a>            <span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">ca</span><span class="o">*</span><span class="n">alA</span><span class="o">-</span><span class="n">y</span><span class="o">*</span><span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">sa</span><span class="o">/</span><span class="n">AA</span><span class="o">-</span><span class="n">alB</span><span class="p">)</span><span class="o">-</span><span class="nb">sin</span><span class="p">(</span><span class="mf">2.D0</span><span class="o">*</span><span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">alpha</span><span class="p">)</span>
<a name="ln-85"></a>    <span class="n">dv</span> <span class="o">=</span> <span class="n">y</span><span class="o">*</span><span class="n">ms</span><span class="o">-</span><span class="mf">2.D0</span><span class="o">*</span><span class="n">x</span><span class="o">*</span><span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">ca</span><span class="o">/</span><span class="n">BB</span><span class="o">-</span><span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">sa</span><span class="o">*</span><span class="p">(</span><span class="n">omp</span><span class="o">-</span><span class="n">om</span><span class="p">)</span><span class="o">+</span><span class="mf">2.D0</span><span class="o">*</span><span class="n">omts</span><span class="o">*</span><span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">cota</span><span class="o">*</span><span class="p">(</span><span class="n">x</span><span class="o">*</span><span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">sa</span><span class="o">/</span><span class="n">AA</span><span class="o">-</span><span class="n">om</span><span class="o">*</span><span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">ca</span><span class="p">)</span>
<a name="ln-86"></a>    <span class="n">dw</span> <span class="o">=</span> <span class="n">z</span><span class="o">*</span><span class="n">ms</span><span class="o">+</span><span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">ca</span><span class="o">*</span><span class="p">(</span><span class="n">omp</span><span class="o">-</span><span class="n">om</span><span class="p">)</span><span class="o">-</span><span class="mf">2.D0</span><span class="o">*</span><span class="n">omts</span><span class="o">*</span><span class="n">om</span><span class="o">*</span><span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">ca</span>
<a name="ln-87"></a>  <span class="k">else </span>
<a name="ln-88"></a><span class="k">    </span><span class="n">du</span> <span class="o">=</span> <span class="mf">2.D0</span><span class="o">*</span><span class="n">y</span><span class="o">/</span><span class="p">(</span><span class="n">r</span><span class="o">-</span><span class="n">z</span><span class="p">)</span>
<a name="ln-89"></a>    <span class="n">dv</span> <span class="o">=</span> <span class="mf">2.D0</span><span class="o">*</span><span class="n">x</span><span class="o">/</span><span class="p">(</span><span class="n">r</span><span class="o">-</span><span class="n">z</span><span class="p">)</span>
<a name="ln-90"></a>    <span class="n">dw</span> <span class="o">=</span> <span class="n">cPi</span> <span class="o">+</span> <span class="n">datan2</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="n">datan2</span><span class="p">(</span><span class="o">-</span><span class="n">y</span><span class="p">,</span><span class="n">x</span><span class="p">)</span>
<a name="ln-91"></a>  <span class="k">end if</span>
<a name="ln-92"></a><span class="k">  </span><span class="n">u</span> <span class="o">=</span> <span class="n">u</span><span class="o">+</span><span class="n">du</span><span class="o">*</span><span class="n">S</span>
<a name="ln-93"></a>  <span class="n">v</span> <span class="o">=</span> <span class="n">v</span><span class="o">-</span><span class="n">sgn</span><span class="o">*</span><span class="n">dv</span><span class="o">*</span><span class="n">S</span>
<a name="ln-94"></a>  <span class="n">w</span> <span class="o">=</span> <span class="n">w</span><span class="o">+</span><span class="n">sgn</span><span class="o">*</span><span class="n">dw</span><span class="o">*</span><span class="n">S</span>
<a name="ln-95"></a><span class="k">end if</span>
<a name="ln-96"></a>
<a name="ln-97"></a><span class="c">! then the edge component in the y-z plane</span>
<a name="ln-98"></a><span class="k">if</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">be</span><span class="p">).</span><span class="n">gt</span><span class="p">.</span><span class="n">eps</span><span class="p">)</span> <span class="k">then </span>
<a name="ln-99"></a><span class="k">  </span><span class="n">qe</span> <span class="o">=</span> <span class="n">x</span><span class="o">*</span><span class="p">(</span><span class="mf">1.D0</span><span class="o">/</span><span class="n">BBp</span><span class="o">-</span><span class="mf">1.D0</span><span class="o">/</span><span class="n">BB</span><span class="o">+</span><span class="mf">2.D0</span><span class="o">*</span><span class="n">z</span><span class="o">*</span><span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">ca</span><span class="o">/</span><span class="n">BB</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
<a name="ln-100"></a>  <span class="n">me</span> <span class="o">=</span> <span class="o">-</span><span class="n">qe</span><span class="o">/</span><span class="n">r</span><span class="o">-</span><span class="mf">4.D0</span><span class="o">*</span><span class="n">oms</span><span class="o">*</span><span class="n">x</span><span class="o">*</span><span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">ca</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="n">r</span><span class="o">/</span><span class="n">BB</span>
<a name="ln-101"></a>  <span class="n">De</span> <span class="o">=</span> <span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">be</span><span class="o">/</span><span class="p">(</span><span class="mf">8.D0</span><span class="o">*</span><span class="n">cPi</span><span class="o">*</span><span class="n">oms</span><span class="p">)</span>
<a name="ln-102"></a>  <span class="k">if</span> <span class="p">(</span><span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">alpha</span><span class="p">.</span><span class="n">gt</span><span class="p">.</span><span class="mf">0.01</span><span class="p">)</span> <span class="k">then </span>
<a name="ln-103"></a><span class="k">    </span><span class="n">du</span> <span class="o">=</span> <span class="n">x</span><span class="o">*</span><span class="n">me</span><span class="o">+</span><span class="n">lam</span><span class="o">+</span><span class="mf">2.D0</span><span class="o">*</span><span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">ca</span><span class="o">*</span><span class="p">(</span><span class="n">z</span><span class="o">+</span><span class="mf">2.D0</span><span class="o">*</span><span class="n">oms</span><span class="o">*</span><span class="n">eta</span><span class="o">*</span><span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">sa</span><span class="p">)</span><span class="o">/</span><span class="n">BB</span><span class="o">-</span><span class="mf">4.D0</span><span class="o">*</span><span class="n">oms</span><span class="o">*</span><span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">sa</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">k</span><span class="o">*</span><span class="p">(</span><span class="mf">1.D0</span><span class="o">-</span><span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">ca</span><span class="o">-</span><span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">ca</span><span class="o">*</span><span class="n">alA</span><span class="o">+</span><span class="p">&amp;</span>
<a name="ln-104"></a>             <span class="n">y</span><span class="o">*</span><span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">sa</span><span class="o">/</span><span class="n">AA</span><span class="o">+</span><span class="n">alB</span><span class="p">)</span>
<a name="ln-105"></a>    <span class="n">dv</span> <span class="o">=</span> <span class="n">y</span><span class="o">*</span><span class="n">me</span><span class="o">+</span><span class="n">qe</span><span class="o">*</span><span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">sa</span><span class="o">+</span><span class="n">th</span><span class="o">*</span><span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">ca</span><span class="o">+</span><span class="n">k</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="n">x</span><span class="o">*</span><span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">sa</span><span class="o">/</span><span class="n">AA</span><span class="o">+</span><span class="n">om</span><span class="o">*</span><span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">ca</span><span class="p">)</span>
<a name="ln-106"></a>    <span class="n">dw</span> <span class="o">=</span> <span class="n">z</span><span class="o">*</span><span class="n">me</span><span class="o">+</span><span class="n">qe</span><span class="o">*</span><span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">ca</span><span class="o">+</span><span class="n">th</span><span class="o">*</span><span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">sa</span><span class="o">-</span><span class="mf">2.D0</span><span class="o">*</span><span class="n">x</span><span class="o">*</span><span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">ca</span><span class="o">*</span><span class="p">(</span><span class="mf">1.D0</span><span class="o">/</span><span class="n">BBp</span><span class="o">+</span><span class="n">omts</span><span class="o">/</span><span class="n">BB</span><span class="p">)</span><span class="o">+</span><span class="n">k</span><span class="o">*</span><span class="n">om</span><span class="o">*</span><span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">sa</span>
<a name="ln-107"></a><span class="c">!    write (*,*) du,dv,dw</span>
<a name="ln-108"></a>  <span class="k">else </span>
<a name="ln-109"></a><span class="k">    </span><span class="n">rr</span> <span class="o">=</span> <span class="n">x</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">y</span><span class="o">**</span><span class="mi">2</span>
<a name="ln-110"></a>    <span class="n">du</span> <span class="o">=</span> <span class="mf">2.D0</span><span class="o">*</span><span class="n">z</span><span class="o">/</span><span class="p">(</span><span class="n">r</span><span class="o">-</span><span class="n">z</span><span class="p">)</span><span class="o">+</span><span class="mf">4.D0</span><span class="o">*</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">sig</span><span class="o">*</span><span class="n">rr</span><span class="o">-</span><span class="n">r</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">r</span><span class="o">/</span><span class="n">AA</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="p">(</span><span class="n">r</span><span class="o">+</span><span class="n">z</span><span class="p">)</span><span class="o">+</span><span class="mf">2.D0</span><span class="o">*</span><span class="n">omts</span><span class="o">*</span><span class="n">oms</span><span class="o">*</span><span class="p">((</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">z</span><span class="o">*</span><span class="p">(</span><span class="n">z</span><span class="o">+</span><span class="n">r</span><span class="p">))</span><span class="o">/</span><span class="n">AA</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">alA</span><span class="p">)</span><span class="o">+</span><span class="n">omts</span><span class="o">*</span><span class="nb">dlog</span><span class="p">((</span><span class="n">r</span><span class="o">+</span><span class="n">z</span><span class="p">)</span><span class="o">/</span><span class="n">AA</span><span class="p">)</span>
<a name="ln-111"></a>    <span class="n">dv</span> <span class="o">=</span> <span class="mf">4.D0</span><span class="o">*</span><span class="n">x</span><span class="o">*</span><span class="n">y</span><span class="o">*</span><span class="p">(</span><span class="n">rr</span><span class="o">*</span><span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">sig</span><span class="o">-</span><span class="n">r</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">r</span><span class="o">/</span><span class="n">AA</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="p">(</span><span class="n">r</span><span class="o">+</span><span class="n">z</span><span class="p">)</span><span class="o">+</span><span class="mf">2.D0</span><span class="o">*</span><span class="n">x</span><span class="o">*</span><span class="n">y</span><span class="o">*</span><span class="p">(</span><span class="n">rr</span><span class="o">+</span><span class="mf">2.D0</span><span class="o">*</span><span class="n">z</span><span class="o">*</span><span class="p">(</span><span class="n">r</span><span class="o">+</span><span class="n">z</span><span class="p">))</span><span class="o">*</span><span class="n">oms</span><span class="o">*</span><span class="n">omts</span><span class="o">/</span><span class="n">rr</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="p">&amp;</span>
<a name="ln-112"></a>            <span class="mf">2.D0</span><span class="o">*</span><span class="n">oms</span><span class="o">*</span><span class="p">(</span><span class="n">cPi</span> <span class="o">+</span> <span class="n">datan2</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="n">datan2</span><span class="p">(</span><span class="o">-</span><span class="n">y</span><span class="p">,</span><span class="n">x</span><span class="p">))</span>
<a name="ln-113"></a>    <span class="n">dw</span> <span class="o">=</span> <span class="mf">4.D0</span><span class="o">*</span><span class="n">x</span><span class="o">*</span><span class="n">rr</span><span class="o">*</span><span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">sig</span><span class="o">*</span><span class="p">(</span><span class="n">z</span><span class="o">-</span><span class="mf">2.D0</span><span class="o">*</span><span class="n">r</span><span class="o">*</span><span class="n">oms</span><span class="p">)</span><span class="o">/</span><span class="n">r</span><span class="o">/</span><span class="n">AA</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="p">(</span><span class="n">r</span><span class="o">+</span><span class="n">z</span><span class="p">)</span>
<a name="ln-114"></a>  <span class="k">end if</span>
<a name="ln-115"></a><span class="k">  </span><span class="n">u</span> <span class="o">=</span> <span class="n">u</span><span class="o">+</span><span class="n">du</span><span class="o">*</span><span class="n">De</span>
<a name="ln-116"></a>  <span class="n">v</span> <span class="o">=</span> <span class="n">v</span><span class="o">+</span><span class="n">sgn</span><span class="o">*</span><span class="n">dv</span><span class="o">*</span><span class="n">De</span>
<a name="ln-117"></a>  <span class="n">w</span> <span class="o">=</span> <span class="n">w</span><span class="o">+</span><span class="n">sgn</span><span class="o">*</span><span class="n">dw</span><span class="o">*</span><span class="n">De</span>
<a name="ln-118"></a><span class="k">end if</span>
<a name="ln-119"></a>
<a name="ln-120"></a><span class="c">! and finally the bx edge component</span>
<a name="ln-121"></a><span class="k">if</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">bx</span><span class="p">).</span><span class="n">gt</span><span class="p">.</span><span class="n">eps</span><span class="p">)</span> <span class="k">then </span>
<a name="ln-122"></a><span class="k">  </span><span class="n">qx</span> <span class="o">=</span> <span class="n">etap</span><span class="o">/</span><span class="n">BBp</span><span class="o">-</span><span class="n">eta</span><span class="o">/</span><span class="n">BB</span><span class="o">-</span><span class="mf">2.D0</span><span class="o">*</span><span class="n">z</span><span class="o">*</span><span class="n">eta</span><span class="o">*</span><span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">ca</span><span class="o">/</span><span class="n">BB</span><span class="o">**</span><span class="mi">2</span>
<a name="ln-123"></a>  <span class="n">mx</span> <span class="o">=</span> <span class="o">-</span><span class="n">qx</span><span class="o">/</span><span class="n">r</span><span class="o">+</span><span class="mf">2.D0</span><span class="o">*</span><span class="n">omts</span><span class="o">*</span><span class="n">y</span><span class="o">*</span><span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">ca</span><span class="o">/</span><span class="n">r</span><span class="o">/</span><span class="n">BB</span>
<a name="ln-124"></a>  <span class="n">Dx</span> <span class="o">=</span> <span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">bx</span><span class="o">/</span><span class="p">(</span><span class="mf">8.D0</span><span class="o">*</span><span class="n">cPi</span><span class="o">*</span><span class="n">oms</span><span class="p">)</span>
<a name="ln-125"></a>  <span class="n">du</span> <span class="o">=</span> <span class="n">x</span><span class="o">*</span><span class="n">mx</span><span class="o">+</span><span class="n">th</span><span class="o">+</span><span class="n">k</span><span class="o">*</span><span class="p">(</span><span class="n">x</span><span class="o">*</span><span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">ta</span><span class="o">/</span><span class="n">AA</span><span class="o">-</span><span class="n">om</span><span class="p">)</span>
<a name="ln-126"></a>  <span class="n">dv</span> <span class="o">=</span> <span class="n">y</span><span class="o">*</span><span class="n">mx</span><span class="o">+</span><span class="n">qx</span><span class="o">*</span><span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">sa</span><span class="o">-</span><span class="n">lam</span><span class="o">*</span><span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">ca</span><span class="o">-</span><span class="mf">2.D0</span><span class="o">*</span><span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">ca</span><span class="o">*</span><span class="p">(</span><span class="n">z</span><span class="o">*</span><span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">ca</span><span class="o">+</span><span class="n">omts</span><span class="o">*</span><span class="n">y</span><span class="o">*</span><span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">sa</span><span class="p">)</span><span class="o">/</span><span class="n">BB</span><span class="o">+</span><span class="n">k</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="mf">1.D0</span><span class="o">+</span><span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">ca</span><span class="o">-</span><span class="n">alA</span><span class="o">+</span><span class="n">y</span><span class="o">*</span><span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">ta</span><span class="o">/</span><span class="n">AA</span><span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-127"></a>          <span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">ca</span><span class="o">*</span><span class="n">alB</span><span class="p">)</span>
<a name="ln-128"></a>  <span class="n">dw</span> <span class="o">=</span> <span class="n">z</span><span class="o">*</span><span class="n">mx</span><span class="o">+</span><span class="n">qx</span><span class="o">*</span><span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">ca</span><span class="o">-</span><span class="n">lam</span><span class="o">*</span><span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">sa</span><span class="o">-</span><span class="mf">2.D0</span><span class="o">*</span><span class="n">etap</span><span class="o">*</span><span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">ca</span><span class="o">/</span><span class="n">BBp</span><span class="o">+</span><span class="mf">4.D0</span><span class="o">*</span><span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">ca</span><span class="o">*</span><span class="p">(</span><span class="n">oms</span><span class="o">*</span><span class="n">y</span><span class="o">*</span><span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">ca</span><span class="o">-</span><span class="n">omts</span><span class="o">*</span><span class="n">z</span><span class="o">*</span><span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">sa</span><span class="p">)</span><span class="o">/</span><span class="n">BB</span><span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-129"></a>           <span class="n">k</span><span class="o">*</span><span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">ta</span><span class="o">*</span><span class="p">(</span><span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">ca</span><span class="o">-</span><span class="n">alA</span><span class="o">+</span><span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">ca</span><span class="o">*</span><span class="n">alB</span><span class="p">)</span><span class="o">+</span><span class="mf">4.D0</span><span class="o">*</span><span class="n">oms</span><span class="o">*</span><span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">ca</span><span class="o">*</span><span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">cota</span>
<a name="ln-130"></a>  <span class="n">u</span> <span class="o">=</span> <span class="n">u</span><span class="o">+</span><span class="n">sgn</span><span class="o">*</span><span class="n">du</span><span class="o">*</span><span class="n">Dx</span>
<a name="ln-131"></a>  <span class="n">v</span> <span class="o">=</span> <span class="n">v</span><span class="o">+</span><span class="n">dv</span><span class="o">*</span><span class="n">Dx</span>
<a name="ln-132"></a>  <span class="n">w</span> <span class="o">=</span> <span class="n">w</span><span class="o">+</span><span class="n">dw</span><span class="o">*</span><span class="n">Dx</span>
<a name="ln-133"></a><span class="k">end if</span>
<a name="ln-134"></a>
<a name="ln-135"></a><span class="c">! and return the displacement components</span>
<a name="ln-136"></a><span class="c">!write (*,*) u,v,w</span>
<a name="ln-137"></a><span class="n">YSHDisp</span> <span class="o">=</span> <span class="p">(</span><span class="o">/</span> <span class="n">u</span><span class="p">,</span><span class="n">v</span><span class="p">,</span><span class="n">w</span> <span class="o">/</span><span class="p">)</span>
<a name="ln-138"></a>
<a name="ln-139"></a><span class="k">end function </span><span class="n">YSHDisp</span>
<a name="ln-140"></a>
<a name="ln-141"></a>
<a name="ln-142"></a><span class="k">recursive subroutine </span><span class="n">makeYSHdislocation</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">dinfo</span><span class="p">,</span> <span class="n">L</span><span class="p">)</span>    
<a name="ln-143"></a><span class="c">!DEC$ ATTRIBUTES DLLEXPORT :: makeYSHdislocation</span>
<a name="ln-144"></a><span class="c">! </span>
<a name="ln-145"></a><span class="c">! this routine pre-computes a number of parameters related to the </span>
<a name="ln-146"></a><span class="c">! geometry of the Yoffe&amp;Shaibani&amp;Hazzledine (YSH) surface-relaxed dislocation in an elastically</span>
<a name="ln-147"></a><span class="c">! isotropic matrix.  These parameters are then used in the CalcR routine.</span>
<a name="ln-148"></a><span class="c">!</span>
<a name="ln-149"></a><span class="c">! We implemented the YSH expressions instead of Yoffe&#39;s </span>
<a name="ln-150"></a><span class="c">! since the former are more easily handled for numerical computations.</span>
<a name="ln-151"></a>
<a name="ln-152"></a><span class="c">! SH have redefined the x-y-z reference frame used by Yoffe to fall along</span>
<a name="ln-153"></a><span class="c">! the dislocation line itself.  As a result, the Burgers vector must be decomposed</span>
<a name="ln-154"></a><span class="c">! into a screw component and two edge components, one in the plane of the </span>
<a name="ln-155"></a><span class="c">! discontinuity, the other normal to that plane (which is by definition the x-axis).</span>
<a name="ln-156"></a><span class="c">! Check the SH paper for more details.</span>
<a name="ln-157"></a>
<a name="ln-158"></a><span class="k">use </span><span class="n">local</span>
<a name="ln-159"></a><span class="k">use </span><span class="n">foilmodule</span>
<a name="ln-160"></a><span class="k">use </span><span class="n">constants</span>
<a name="ln-161"></a><span class="k">use </span><span class="n">crystal</span>
<a name="ln-162"></a>
<a name="ln-163"></a><span class="k">IMPLICIT NONE</span>
<a name="ln-164"></a>
<a name="ln-165"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">)</span>  <span class="kd">::</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">tu</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">tx</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">ty</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">te</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">tb</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">bl</span>
<a name="ln-166"></a><span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">irg</span><span class="p">)</span> <span class="kd">::</span> <span class="n">i</span><span class="p">,</span><span class="n">dinfo</span>
<a name="ln-167"></a>
<a name="ln-168"></a><span class="c">! first, determine the alpha angle between the </span>
<a name="ln-169"></a><span class="c">! negative z-axis, which is really the negative foil normal, and the line direction</span>
<a name="ln-170"></a><span class="c">! (make sure to reduce the angle to [0,90] interval).</span>
<a name="ln-171"></a><span class="n">alpha</span> <span class="o">=</span> <span class="n">CalcAngle</span><span class="p">(</span><span class="o">-</span><span class="n">foil</span><span class="p">%</span><span class="n">F</span><span class="p">,</span><span class="n">YD</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="s1">&#39;d&#39;</span><span class="p">)</span><span class="o">*</span><span class="mi">18</span><span class="mf">0.0</span><span class="o">/</span><span class="n">cPi</span>
<a name="ln-172"></a><span class="k">if</span> <span class="p">(</span><span class="n">alpha</span><span class="p">.</span><span class="n">gt</span><span class="p">.</span><span class="mi">9</span><span class="mf">0.0</span><span class="p">)</span> <span class="k">then </span>
<a name="ln-173"></a><span class="k">  </span><span class="n">alpha</span> <span class="o">=</span> <span class="mi">18</span><span class="mf">0.0</span><span class="o">-</span><span class="n">alpha</span>
<a name="ln-174"></a>  <span class="n">YD</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">u</span> <span class="o">=</span> <span class="o">-</span><span class="n">YD</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">u</span>   <span class="c">! the u-direction should point down into the foil</span>
<a name="ln-175"></a><span class="k">end if</span>
<a name="ln-176"></a><span class="k">write</span> <span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s1">&#39;Foil normal = &#39;</span><span class="p">,</span><span class="n">foil</span><span class="p">%</span><span class="n">F</span>
<a name="ln-177"></a><span class="k">write</span> <span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s1">&#39;line direction = &#39;</span><span class="p">,</span><span class="n">YD</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">u</span>
<a name="ln-178"></a><span class="k">write</span> <span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s1">&#39;  --&gt; alpha angle = &#39;</span><span class="p">,</span><span class="n">alpha</span>
<a name="ln-179"></a><span class="n">alpha</span> <span class="o">=</span> <span class="n">alpha</span><span class="o">*</span><span class="n">cPi</span><span class="o">/</span><span class="mi">18</span><span class="mf">0.0</span>
<a name="ln-180"></a>
<a name="ln-181"></a><span class="k">call </span><span class="n">TransSpace</span><span class="p">(</span><span class="n">YD</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">tu</span><span class="p">,</span><span class="s1">&#39;d&#39;</span><span class="p">,</span><span class="s1">&#39;c&#39;</span><span class="p">)</span>
<a name="ln-182"></a><span class="k">call </span><span class="n">NormVec</span><span class="p">(</span><span class="n">tu</span><span class="p">,</span><span class="s1">&#39;c&#39;</span><span class="p">)</span>
<a name="ln-183"></a><span class="k">call </span><span class="n">TransSpace</span><span class="p">(</span><span class="n">foil</span><span class="p">%</span><span class="n">F</span><span class="p">,</span><span class="n">ty</span><span class="p">,</span><span class="s1">&#39;d&#39;</span><span class="p">,</span><span class="s1">&#39;c&#39;</span><span class="p">)</span>
<a name="ln-184"></a><span class="k">call </span><span class="n">NormVec</span><span class="p">(</span><span class="n">ty</span><span class="p">,</span><span class="s1">&#39;c&#39;</span><span class="p">)</span>
<a name="ln-185"></a><span class="k">call </span><span class="n">CalcCross</span><span class="p">(</span><span class="n">tu</span><span class="p">,</span><span class="n">ty</span><span class="p">,</span><span class="n">tx</span><span class="p">,</span><span class="s1">&#39;c&#39;</span><span class="p">,</span><span class="s1">&#39;c&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>       <span class="c">! x = u x F</span>
<a name="ln-186"></a><span class="k">call </span><span class="n">NormVec</span><span class="p">(</span><span class="n">tx</span><span class="p">,</span><span class="s1">&#39;c&#39;</span><span class="p">)</span>
<a name="ln-187"></a><span class="k">call </span><span class="n">CalcCross</span><span class="p">(</span><span class="n">tx</span><span class="p">,</span><span class="n">tu</span><span class="p">,</span><span class="n">te</span><span class="p">,</span><span class="s1">&#39;c&#39;</span><span class="p">,</span><span class="s1">&#39;c&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>             <span class="c">! e = x x u</span>
<a name="ln-188"></a><span class="k">call </span><span class="n">NormVec</span><span class="p">(</span><span class="n">te</span><span class="p">,</span><span class="s1">&#39;c&#39;</span><span class="p">)</span>
<a name="ln-189"></a><span class="k">call </span><span class="n">CalcCross</span><span class="p">(</span><span class="n">ty</span><span class="p">,</span><span class="n">tx</span><span class="p">,</span><span class="n">ty</span><span class="p">,</span><span class="s1">&#39;c&#39;</span><span class="p">,</span><span class="s1">&#39;c&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
<a name="ln-190"></a><span class="k">call </span><span class="n">NormVec</span><span class="p">(</span><span class="n">ty</span><span class="p">,</span><span class="s1">&#39;c&#39;</span><span class="p">)</span>
<a name="ln-191"></a><span class="n">bl</span> <span class="o">=</span> <span class="n">CalcLength</span><span class="p">(</span><span class="n">YD</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">burg</span><span class="p">,</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>
<a name="ln-192"></a><span class="k">write</span> <span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s1">&#39; tx = &#39;</span><span class="p">,</span><span class="n">tx</span>
<a name="ln-193"></a><span class="k">write</span> <span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s1">&#39; te = &#39;</span><span class="p">,</span><span class="n">te</span>
<a name="ln-194"></a><span class="k">write</span> <span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s1">&#39; tu = &#39;</span><span class="p">,</span><span class="n">tu</span>
<a name="ln-195"></a><span class="k">write</span> <span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s1">&#39; ty = &#39;</span><span class="p">,</span><span class="n">ty</span>
<a name="ln-196"></a><span class="k">write</span> <span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s1">&#39; bl = &#39;</span><span class="p">,</span><span class="n">bl</span>
<a name="ln-197"></a><span class="k">call </span><span class="n">TransSpace</span><span class="p">(</span><span class="n">YD</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">burg</span><span class="p">,</span><span class="n">tb</span><span class="p">,</span><span class="s1">&#39;d&#39;</span><span class="p">,</span><span class="s1">&#39;c&#39;</span><span class="p">)</span>
<a name="ln-198"></a><span class="k">call </span><span class="n">NormVec</span><span class="p">(</span><span class="n">tb</span><span class="p">,</span><span class="s1">&#39;c&#39;</span><span class="p">)</span>
<a name="ln-199"></a><span class="n">YD</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">bx</span> <span class="o">=</span> <span class="n">bl</span> <span class="o">*</span> <span class="n">CalcDot</span><span class="p">(</span><span class="n">tb</span><span class="p">,</span><span class="n">tx</span><span class="p">,</span><span class="s1">&#39;c&#39;</span><span class="p">)</span>   <span class="c">! edge component normal to cut plane</span>
<a name="ln-200"></a><span class="n">YD</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">be</span> <span class="o">=</span> <span class="n">bl</span> <span class="o">*</span> <span class="n">CalcDot</span><span class="p">(</span><span class="n">tb</span><span class="p">,</span><span class="n">te</span><span class="p">,</span><span class="s1">&#39;c&#39;</span><span class="p">)</span>   <span class="c">! edge component in cut plane</span>
<a name="ln-201"></a><span class="n">YD</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">bs</span> <span class="o">=</span> <span class="n">bl</span> <span class="o">*</span> <span class="n">CalcDot</span><span class="p">(</span><span class="n">tb</span><span class="p">,</span><span class="n">tu</span><span class="p">,</span><span class="s1">&#39;c&#39;</span><span class="p">)</span>  <span class="c">! screw component</span>
<a name="ln-202"></a>
<a name="ln-203"></a><span class="k">write</span> <span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s1">&#39;Burgers vector components (bx,be,bs) &#39;</span><span class="p">,</span><span class="n">YD</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">bx</span><span class="p">,</span><span class="n">YD</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">be</span><span class="p">,</span><span class="n">YD</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">bs</span>
<a name="ln-204"></a>
<a name="ln-205"></a><span class="c">! we will also need to know the rotation matrix between the dislocation reference frame </span>
<a name="ln-206"></a><span class="c">! and the foil reference frame, so that we can transform the foil coordinates to defect </span>
<a name="ln-207"></a><span class="c">! coordinates...  We need the angle beta between the defect x axis (tx) and the foil x axis,</span>
<a name="ln-208"></a><span class="c">! which is the first column of the foil%a_fc matrix ...</span>
<a name="ln-209"></a><span class="n">ty</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">foil</span><span class="p">%</span><span class="n">a_fc</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-210"></a><span class="k">write</span> <span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s1">&#39; tx = &#39;</span><span class="p">,</span><span class="n">tx</span>
<a name="ln-211"></a><span class="n">YD</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">beta</span> <span class="o">=</span> <span class="n">CalcAngle</span><span class="p">(</span><span class="n">tx</span><span class="p">,</span><span class="n">ty</span><span class="p">,</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>
<a name="ln-212"></a><span class="k">write</span> <span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s1">&#39; ty = &#39;</span><span class="p">,</span><span class="n">ty</span>
<a name="ln-213"></a><span class="k">write</span> <span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s1">&#39; beta = &#39;</span><span class="p">,</span><span class="n">YD</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">beta</span>
<a name="ln-214"></a><span class="n">beta</span> <span class="o">=</span> <span class="n">YD</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">beta</span>
<a name="ln-215"></a><span class="n">YD</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">a_di</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="o">/</span> <span class="nb">cos</span><span class="p">(</span><span class="n">beta</span><span class="p">),</span> <span class="o">-</span><span class="nb">sin</span><span class="p">(</span><span class="n">beta</span><span class="p">),</span> <span class="mf">0.0</span> <span class="o">/</span><span class="p">)</span>
<a name="ln-216"></a><span class="n">YD</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">a_di</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="o">/</span> <span class="nb">sin</span><span class="p">(</span><span class="n">beta</span><span class="p">),</span> <span class="nb">cos</span><span class="p">(</span><span class="n">beta</span><span class="p">),</span> <span class="mf">0.0</span> <span class="o">/</span><span class="p">)</span>
<a name="ln-217"></a><span class="n">YD</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">a_di</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="o">/</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span> <span class="o">/</span><span class="p">)</span>
<a name="ln-218"></a><span class="n">YD</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">a_id</span> <span class="o">=</span> <span class="nb">transpose</span><span class="p">(</span><span class="n">YD</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">a_di</span><span class="p">)</span>
<a name="ln-219"></a><span class="k">write</span> <span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="n">YD</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">a_di</span>
<a name="ln-220"></a>
<a name="ln-221"></a><span class="c">! finally some geometrical parameters needed for the displacement field computation...</span>
<a name="ln-222"></a><span class="n">YD</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">alpha</span> <span class="o">=</span>  <span class="n">alpha</span>
<a name="ln-223"></a><span class="n">YD</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">ca</span> <span class="o">=</span> <span class="nb">cos</span><span class="p">(</span><span class="n">alpha</span><span class="p">)</span>
<a name="ln-224"></a><span class="n">YD</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">sa</span> <span class="o">=</span> <span class="nb">sin</span><span class="p">(</span><span class="n">alpha</span><span class="p">)</span>
<a name="ln-225"></a><span class="n">YD</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">ta</span> <span class="o">=</span> <span class="nb">tan</span><span class="p">(</span><span class="n">alpha</span><span class="p">)</span>
<a name="ln-226"></a><span class="n">YD</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cota</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">/</span><span class="n">YD</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">ta</span>
<a name="ln-227"></a>
<a name="ln-228"></a><span class="k">write</span> <span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s1">&#39;angulars = &#39;</span><span class="p">,</span><span class="nb">cos</span><span class="p">(</span><span class="n">alpha</span><span class="p">),</span><span class="nb">sin</span><span class="p">(</span><span class="n">alpha</span><span class="p">),</span><span class="nb">tan</span><span class="p">(</span><span class="n">alpha</span><span class="p">)</span>
<a name="ln-229"></a>
<a name="ln-230"></a><span class="c">! that&#39;s it! the rest is handled in the CalcR routine.</span>
<a name="ln-231"></a>
<a name="ln-232"></a><span class="k">end subroutine </span><span class="n">makeYSHdislocation</span>
<a name="ln-233"></a>
<a name="ln-234"></a>
<a name="ln-235"></a>
<a name="ln-236"></a><span class="k">recursive subroutine </span><span class="n">read_YSH_dislocation_data</span><span class="p">(</span><span class="n">dislYname</span><span class="p">,</span><span class="n">numYdisl</span><span class="p">,</span><span class="n">DF_npix</span><span class="p">,</span><span class="n">DF_npiy</span><span class="p">,</span><span class="n">DF_gf</span><span class="p">,</span><span class="n">L</span><span class="p">,</span><span class="n">dinfo</span><span class="p">)</span>
<a name="ln-237"></a><span class="c">!DEC$ ATTRIBUTES DLLEXPORT :: read_YSH_dislocation_data</span>
<a name="ln-238"></a>
<a name="ln-239"></a><span class="k">use </span><span class="n">local</span>
<a name="ln-240"></a><span class="k">use </span><span class="n">io</span>
<a name="ln-241"></a><span class="k">use </span><span class="n">files</span>
<a name="ln-242"></a><span class="k">use </span><span class="n">typedefs</span>
<a name="ln-243"></a>
<a name="ln-244"></a><span class="k">IMPLICIT NONE</span>
<a name="ln-245"></a>
<a name="ln-246"></a><span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">irg</span><span class="p">)</span> <span class="kd">::</span> <span class="n">i</span><span class="p">,</span><span class="n">numYdisl</span><span class="p">,</span><span class="n">dinfo</span><span class="p">,</span><span class="n">DF_npix</span><span class="p">,</span><span class="n">DF_npiy</span>
<a name="ln-247"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">)</span> <span class="kd">::</span> <span class="n">id</span><span class="p">,</span><span class="n">jd</span><span class="p">,</span><span class="n">u</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span><span class="n">bv</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span><span class="n">DF_gf</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span><span class="n">L</span><span class="p">,</span><span class="n">poisson</span>
<a name="ln-248"></a><span class="kt">character</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span> <span class="kd">::</span> <span class="n">dislYname</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">maxdefects</span><span class="p">)</span>
<a name="ln-249"></a>
<a name="ln-250"></a><span class="k">namelist</span> <span class="o">/</span> <span class="n">dislocationdata</span> <span class="o">/</span> <span class="n">id</span><span class="p">,</span> <span class="n">jd</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">bv</span><span class="p">,</span> <span class="n">poisson</span>
<a name="ln-251"></a>
<a name="ln-252"></a><span class="c">! allocate the memory for the dislocation parameters</span>
<a name="ln-253"></a>  <span class="k">allocate</span><span class="p">(</span><span class="n">YD</span><span class="p">(</span><span class="n">numYdisl</span><span class="p">))</span>
<a name="ln-254"></a>
<a name="ln-255"></a><span class="c">! these are just the individual dislocations; the ones that belong to </span>
<a name="ln-256"></a><span class="c">! stacking faults are handled separately</span>
<a name="ln-257"></a>   <span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">numYdisl</span>
<a name="ln-258"></a>    <span class="n">mess</span> <span class="o">=</span> <span class="s1">&#39;opening &#39;</span><span class="o">//</span><span class="n">dislYname</span><span class="p">(</span><span class="n">i</span><span class="p">);</span> <span class="k">call </span><span class="n">Message</span><span class="p">(</span><span class="s2">&quot;(/A)&quot;</span><span class="p">)</span>
<a name="ln-259"></a>    <span class="k">open</span><span class="p">(</span><span class="n">UNIT</span><span class="o">=</span><span class="n">dataunit</span><span class="p">,</span><span class="k">FILE</span><span class="o">=</span><span class="nb">trim</span><span class="p">(</span><span class="n">EMsoft_toNativePath</span><span class="p">(</span><span class="n">dislYname</span><span class="p">(</span><span class="n">i</span><span class="p">))),</span><span class="n">DELIM</span><span class="o">=</span><span class="s1">&#39;APOSTROPHE&#39;</span><span class="p">)</span>
<a name="ln-260"></a>    <span class="k">read</span><span class="p">(</span><span class="n">UNIT</span><span class="o">=</span><span class="n">dataunit</span><span class="p">,</span><span class="n">NML</span><span class="o">=</span><span class="n">dislocationdata</span><span class="p">)</span>
<a name="ln-261"></a>    <span class="k">close</span><span class="p">(</span><span class="n">UNIT</span><span class="o">=</span><span class="n">dataunit</span><span class="p">)</span>
<a name="ln-262"></a>    
<a name="ln-263"></a><span class="c">! top-of-the-foil intersection of dislocation line is transformed to foil coordinates [nm] with DL(i)%kd=0 (center of foil) [verified 4/23/11]</span>
<a name="ln-264"></a><span class="c">! the point (0,0) is at the center of the image ... hence the factor of 0.5</span>
<a name="ln-265"></a>    <span class="n">YD</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">id</span> <span class="o">=</span> <span class="n">id</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="nb">float</span><span class="p">(</span><span class="n">DF_npix</span><span class="p">)</span> <span class="c">! * L   scaling (zooming) is done in the image reference frame...</span>
<a name="ln-266"></a>    <span class="n">YD</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">jd</span> <span class="o">=</span> <span class="n">jd</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="nb">float</span><span class="p">(</span><span class="n">DF_npiy</span><span class="p">)</span> <span class="c">! * L</span>
<a name="ln-267"></a>    <span class="n">YD</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">u</span> <span class="o">=</span> <span class="n">u</span>
<a name="ln-268"></a>    <span class="n">YD</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">burg</span> <span class="o">=</span> <span class="n">bv</span>
<a name="ln-269"></a>    <span class="n">YD</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">g</span> <span class="o">=</span> <span class="n">DF_gf</span>
<a name="ln-270"></a>    <span class="n">YD</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">sig</span> <span class="o">=</span> <span class="n">poisson</span>
<a name="ln-271"></a>    
<a name="ln-272"></a><span class="c">! and pre-compute the dislocation displacement field parameters</span>
<a name="ln-273"></a>       <span class="k">call </span><span class="n">makeYSHdislocation</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">dinfo</span><span class="p">,</span> <span class="n">L</span><span class="p">)</span>    
<a name="ln-274"></a>  <span class="k">end do</span>
<a name="ln-275"></a><span class="k">  </span>
<a name="ln-276"></a><span class="k">end subroutine </span><span class="n">read_YSH_dislocation_data</span>
<a name="ln-277"></a>
<a name="ln-278"></a>
<a name="ln-279"></a>
<a name="ln-280"></a>
<a name="ln-281"></a>
<a name="ln-282"></a><span class="k">end module </span><span class="n">YSHModule</span>
<a name="ln-283"></a>
<a name="ln-284"></a>
<a name="ln-285"></a>
<a name="ln-286"></a>
<a name="ln-287"></a><span class="k">program </span><span class="n">dispfield</span> 
<a name="ln-288"></a><span class="c">! </span>
<a name="ln-289"></a><span class="k">use </span><span class="n">local</span>
<a name="ln-290"></a><span class="k">use </span><span class="n">typedefs</span>
<a name="ln-291"></a><span class="k">use </span><span class="n">crystalvars</span> 
<a name="ln-292"></a><span class="k">use </span><span class="n">crystal</span>
<a name="ln-293"></a><span class="k">use </span><span class="n">symmetryvars</span>
<a name="ln-294"></a><span class="k">use </span><span class="n">symmetry</span>
<a name="ln-295"></a><span class="k">use </span><span class="n">postscript</span>
<a name="ln-296"></a><span class="k">use </span><span class="n">constants</span>
<a name="ln-297"></a><span class="k">use </span><span class="n">diffraction</span>
<a name="ln-298"></a><span class="k">use </span><span class="n">dynamical</span>
<a name="ln-299"></a><span class="k">use </span><span class="n">files</span>
<a name="ln-300"></a><span class="k">use </span><span class="n">io</span>
<a name="ln-301"></a><span class="k">use </span><span class="n">foilmodule</span>
<a name="ln-302"></a><span class="k">use </span><span class="n">stacking_fault</span>
<a name="ln-303"></a><span class="k">use </span><span class="n">dislocation</span>
<a name="ln-304"></a><span class="k">use </span><span class="n">void</span>
<a name="ln-305"></a><span class="k">use </span><span class="n">inclusion</span>
<a name="ln-306"></a><span class="k">use </span><span class="n">defectmodule</span>     
<a name="ln-307"></a><span class="k">use </span><span class="n">TIFF_global</span>
<a name="ln-308"></a><span class="k">use </span><span class="n">TIFF_f90</span>
<a name="ln-309"></a><span class="k">use </span><span class="n">pgm</span>
<a name="ln-310"></a><span class="k">use </span><span class="n">timing</span>
<a name="ln-311"></a><span class="k">use </span><span class="n">STEMmodule</span>
<a name="ln-312"></a><span class="k">use </span><span class="n">YSHModule</span>
<a name="ln-313"></a>
<a name="ln-314"></a><span class="k">IMPLICIT NONE</span>
<a name="ln-315"></a>
<a name="ln-316"></a><span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">irg</span><span class="p">)</span>       <span class="kd">::</span> <span class="n">ira</span><span class="p">,</span><span class="n">nn</span><span class="p">,</span><span class="n">izero</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="n">nsl</span><span class="p">,</span><span class="n">numi</span><span class="p">,</span><span class="n">npix</span><span class="p">,</span><span class="n">npiy</span><span class="p">,</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">,</span><span class="n">numvoids</span><span class="p">,</span><span class="n">numdisl</span><span class="p">,</span><span class="n">numsf</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-317"></a>                                  <span class="n">numinc</span><span class="p">,</span><span class="n">dinfo</span><span class="p">,</span><span class="n">t_interval</span><span class="p">,</span><span class="n">outputfirst</span><span class="p">,</span><span class="n">outputlast</span><span class="p">,</span><span class="n">DF_nums_new</span><span class="p">,</span> <span class="n">numYdisl</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-318"></a>                                  <span class="n">DF_npix_new</span><span class="p">,</span><span class="n">DF_npiy_new</span><span class="p">,</span> <span class="n">numstart</span><span class="p">,</span><span class="n">numstop</span><span class="p">,</span> <span class="n">isg</span><span class="p">,</span> <span class="n">TID</span><span class="p">,</span> <span class="n">NTHR</span><span class="p">,</span> <span class="n">jcnt</span><span class="p">,</span> <span class="n">numCL</span><span class="p">,</span> <span class="n">iCL</span>
<a name="ln-319"></a><span class="c">!                                  OMP_GET_THREAD_NUM,OMP_GET_NUM_THREADS</span>
<a name="ln-320"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">)</span>          <span class="kd">::</span> <span class="n">ind</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span><span class="n">hkl</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span><span class="n">exerg</span><span class="p">,</span><span class="n">cosom</span><span class="p">,</span><span class="n">glen</span><span class="p">,</span><span class="n">exer</span><span class="p">,</span><span class="n">dgr</span><span class="p">,</span><span class="n">sl</span><span class="p">,</span><span class="n">thr</span><span class="p">,</span><span class="n">arg</span><span class="p">,</span><span class="n">zmax</span><span class="p">,</span><span class="n">thick</span><span class="p">,</span><span class="n">mi</span><span class="p">,</span><span class="n">ma</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-321"></a>                                  <span class="n">att</span><span class="p">,</span><span class="n">xgp</span><span class="p">,</span><span class="n">DF_gf</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span><span class="n">DF_gd</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="n">maxdefects</span><span class="p">)</span>
<a name="ln-322"></a><span class="kt">character</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span>           <span class="kd">::</span> <span class="n">fname</span><span class="p">,</span><span class="n">sgname</span><span class="p">,</span><span class="n">voidname</span><span class="p">,</span><span class="n">dislname</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">maxdefects</span><span class="p">),</span><span class="n">sfname</span><span class="p">(</span><span class="n">maxdefects</span><span class="p">),</span><span class="n">outputroot</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-323"></a>                                  <span class="n">incname</span><span class="p">,</span><span class="n">dispfile</span><span class="p">,</span> <span class="n">dislYname</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">maxdefects</span><span class="p">)</span>
<a name="ln-324"></a><span class="kt">character</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>          <span class="kd">::</span> <span class="n">imname</span>
<a name="ln-325"></a><span class="kt">character</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>            <span class="kd">::</span> <span class="n">outputformat</span><span class="p">,</span> <span class="n">illumination_mode</span><span class="p">,</span> <span class="n">dispmode</span>
<a name="ln-326"></a><span class="kt">character</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>            <span class="kd">::</span> <span class="n">fnumber</span><span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">:</span><span class="mi">10</span><span class="p">)</span>
<a name="ln-327"></a><span class="kt">character</span><span class="p">(</span><span class="nb">len</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>       <span class="kd">::</span> <span class="n">ci</span>
<a name="ln-328"></a>
<a name="ln-329"></a><span class="kt">complex</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">dbl</span><span class="p">)</span>                <span class="kd">::</span> <span class="n">czero</span><span class="p">,</span><span class="n">cone</span>
<a name="ln-330"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">),</span><span class="k">allocatable</span>    <span class="kd">::</span> <span class="n">disparray</span><span class="p">(:,:,:,:)</span>
<a name="ln-331"></a>
<a name="ln-332"></a>
<a name="ln-333"></a><span class="k">namelist</span> <span class="o">/</span> <span class="n">rundata</span> <span class="o">/</span> <span class="n">DF_L</span><span class="p">,</span> <span class="n">DF_npix</span><span class="p">,</span> <span class="n">DF_npiy</span><span class="p">,</span> <span class="n">DF_slice</span><span class="p">,</span> <span class="n">Nmat</span><span class="p">,</span> <span class="n">sgname</span><span class="p">,</span> <span class="n">numvoids</span><span class="p">,</span> <span class="n">incname</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-334"></a>                                 <span class="n">voidname</span><span class="p">,</span> <span class="n">numdisl</span><span class="p">,</span> <span class="n">dislname</span><span class="p">,</span> <span class="n">numYdisl</span><span class="p">,</span> <span class="n">dislYname</span><span class="p">,</span> <span class="n">numsf</span><span class="p">,</span> <span class="n">sfname</span><span class="p">,</span> <span class="n">dinfo</span><span class="p">,</span> <span class="n">outputformat</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-335"></a>				 <span class="n">outputroot</span><span class="p">,</span><span class="n">t_interval</span><span class="p">,</span><span class="n">illumination_mode</span><span class="p">,</span><span class="n">outputfirst</span><span class="p">,</span><span class="n">outputlast</span><span class="p">,</span> <span class="n">dispfile</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-336"></a>				 <span class="n">dispmode</span>
<a name="ln-337"></a>
<a name="ln-338"></a><span class="c">! display the standard program info</span>
<a name="ln-339"></a> <span class="n">progname</span> <span class="o">=</span> <span class="s1">&#39;dispfield.f90&#39;</span>
<a name="ln-340"></a> <span class="n">progdesc</span> <span class="o">=</span> <span class="s1">&#39;Defect displacement field simulation program&#39;</span>
<a name="ln-341"></a> <span class="k">call </span><span class="n">EMsoft</span>
<a name="ln-342"></a> 
<a name="ln-343"></a><span class="c">! get the crystal data and microscope voltage</span>
<a name="ln-344"></a> <span class="n">SG</span> <span class="p">%</span> <span class="n">SYM_reduce</span><span class="o">=</span><span class="p">.</span><span class="n">TRUE</span><span class="p">.</span>
<a name="ln-345"></a> <span class="k">call </span><span class="n">CrystalData</span>             <span class="c">! read crystal structure</span>
<a name="ln-346"></a> <span class="n">hexset</span> <span class="o">=</span> <span class="p">.</span><span class="n">FALSE</span><span class="p">.</span>
<a name="ln-347"></a> 
<a name="ln-348"></a> <span class="n">czero</span><span class="o">=</span><span class="nb">cmplx</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">0.0</span><span class="p">,</span><span class="n">dbl</span><span class="p">)</span>
<a name="ln-349"></a> <span class="n">cone</span><span class="o">=</span><span class="nb">cmplx</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span><span class="mf">0.0</span><span class="p">,</span><span class="n">dbl</span><span class="p">)</span>
<a name="ln-350"></a>  
<a name="ln-351"></a><span class="c">! here we read the general simulation information from a namelist file SRdef_rundata.nml</span>
<a name="ln-352"></a><span class="c">! first we define the default values</span>
<a name="ln-353"></a> <span class="n">DF_L</span> <span class="o">=</span> <span class="mf">1.0</span>             <span class="c">! edge length of column in nanometers</span>
<a name="ln-354"></a> <span class="n">DF_npix</span> <span class="o">=</span> <span class="mi">256</span>       <span class="c">! number of image pixels along x</span>
<a name="ln-355"></a> <span class="n">DF_npiy</span> <span class="o">=</span> <span class="mi">256</span>       <span class="c">! number of image pixels along y </span>
<a name="ln-356"></a> <span class="n">DF_slice</span> <span class="o">=</span> <span class="mf">1.0</span>       <span class="c">! slice thickness in nanometers</span>
<a name="ln-357"></a> <span class="n">Nmat</span> <span class="o">=</span> <span class="mi">10000</span>       <span class="c">! number of precomputed A matrices to be stored</span>
<a name="ln-358"></a> <span class="n">dinfo</span> <span class="o">=</span> <span class="mi">0</span>               <span class="c">! switch to make makedislocation verbose</span>
<a name="ln-359"></a> <span class="n">sgname</span> <span class="o">=</span> <span class="s1">&#39;nofile&#39;</span>   <span class="c">! if this variable is different from &#39;nofile&#39;, then an external sg array is read (to be implemented)</span>
<a name="ln-360"></a> <span class="n">numdisl</span> <span class="o">=</span> <span class="mi">0</span>           <span class="c">! number of dislocation files</span>
<a name="ln-361"></a> <span class="n">numYdisl</span> <span class="o">=</span> <span class="mi">0</span>           <span class="c">! number of Yoffe dislocation files</span>
<a name="ln-362"></a> <span class="n">numsf</span> <span class="o">=</span> <span class="mi">0</span>             <span class="c">! number of stacking fault files</span>
<a name="ln-363"></a> <span class="n">numinc</span> <span class="o">=</span> <span class="mi">0</span>           <span class="c">! number of inclusions</span>
<a name="ln-364"></a> <span class="n">numvoids</span> <span class="o">=</span> <span class="mi">0</span>       <span class="c">! number of voids</span>
<a name="ln-365"></a> <span class="n">voidname</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span> <span class="c">! filename for void data</span>
<a name="ln-366"></a> <span class="n">dislname</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>         <span class="c">! filenames for dislocation data</span>
<a name="ln-367"></a> <span class="n">dislYname</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>         <span class="c">! filenames for Yoffe dislocation data</span>
<a name="ln-368"></a> <span class="n">sfname</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>            <span class="c">! filenames for stacking fault data</span>
<a name="ln-369"></a> <span class="n">incname</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span>   <span class="c">! filename for inclusion data</span>
<a name="ln-370"></a> <span class="n">outputformat</span> <span class="o">=</span> <span class="s1">&#39;data&#39;</span>  <span class="c">! format for output data, can be &#39;data&#39;, &#39;pgm&#39;, or &#39;tiff&#39;</span>
<a name="ln-371"></a> <span class="n">outputroot</span> <span class="o">=</span> <span class="s1">&#39;image&#39;</span>  <span class="c">! default root name for output files</span>
<a name="ln-372"></a> <span class="n">outputfirst</span> <span class="o">=</span> <span class="mi">1</span>       <span class="c">! first image number to be written to file (will be set to first image in SR)</span>
<a name="ln-373"></a> <span class="n">outputlast</span> <span class="o">=</span> <span class="n">nn</span>       <span class="c">! last image number to be written to file (will be set to last image in SR)</span>
<a name="ln-374"></a> <span class="n">t_interval</span> <span class="o">=</span> <span class="mi">10</span>       <span class="c">! default timing interval (output every t_interval image columns)</span>
<a name="ln-375"></a> <span class="n">dispfile</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span>     <span class="c">! name of the displacement field output file (will be created if different from none)</span>
<a name="ln-376"></a> <span class="n">dispmode</span> <span class="o">=</span> <span class="s1">&#39;not&#39;</span>  <span class="c">! should a diplacement file be written (&#39;new&#39;) or read (&#39;old&#39;) or neither (&#39;not&#39;)?</span>
<a name="ln-377"></a> <span class="n">illumination_mode</span> <span class="o">=</span> <span class="s1">&#39;EM&#39;</span>  <span class="c">! default illumination mode (can be &#39;EM&#39; or &#39;STEM&#39;)</span>
<a name="ln-378"></a> 
<a name="ln-379"></a> 
<a name="ln-380"></a><span class="c">! then we read the rundata namelist, which may override some of these defaults  </span>
<a name="ln-381"></a> <span class="k">OPEN</span><span class="p">(</span><span class="n">UNIT</span><span class="o">=</span><span class="n">dataunit</span><span class="p">,</span><span class="k">FILE</span><span class="o">=</span><span class="s1">&#39;SRdef_rundata.nml&#39;</span><span class="p">,</span><span class="n">DELIM</span><span class="o">=</span><span class="s1">&#39;APOSTROPHE&#39;</span><span class="p">)</span>
<a name="ln-382"></a> <span class="k">READ</span><span class="p">(</span><span class="n">UNIT</span><span class="o">=</span><span class="n">dataunit</span><span class="p">,</span><span class="n">NML</span><span class="o">=</span><span class="n">rundata</span><span class="p">)</span>
<a name="ln-383"></a> <span class="k">CLOSE</span><span class="p">(</span><span class="n">UNIT</span><span class="o">=</span><span class="n">dataunit</span><span class="p">)</span>
<a name="ln-384"></a>
<a name="ln-385"></a>
<a name="ln-386"></a>
<a name="ln-387"></a><span class="c">! next, we read the foildata namelist from the SRdef_foildata.nml file</span>
<a name="ln-388"></a><span class="c">! this includes material property data, in this case the elastic moduli</span>
<a name="ln-389"></a><span class="c">! in particular, the foilmodule MUST compute the beam direction from</span>
<a name="ln-390"></a><span class="c">! the sample tilt angles !!!</span>
<a name="ln-391"></a>  <span class="k">call </span><span class="n">read_foil_data</span><span class="p">(</span><span class="n">DF_npix</span><span class="p">,</span><span class="n">DF_npiy</span><span class="p">,</span><span class="n">DF_L</span><span class="p">)</span>
<a name="ln-392"></a>  
<a name="ln-393"></a>  
<a name="ln-394"></a><span class="c">! define the foil thickness, attenuation, and number slices per column</span>
<a name="ln-395"></a><span class="n">thick</span> <span class="o">=</span> <span class="n">foil</span><span class="p">%</span><span class="n">zb</span>    <span class="c">! this is the same everywhere for this version; needs to be updated in the next version</span>
<a name="ln-396"></a><span class="n">DF_nums</span> <span class="o">=</span> <span class="nb">nint</span><span class="p">(</span><span class="n">thick</span><span class="o">/</span><span class="n">DF_slice</span><span class="p">)</span>  <span class="c">! this is the number of slices for this particular column</span>
<a name="ln-397"></a>
<a name="ln-398"></a>
<a name="ln-399"></a><span class="c">! next, deal with all the defects</span>
<a name="ln-400"></a><span class="c">!</span>
<a name="ln-401"></a><span class="c">! if there is a diplacement field file entered in the STEM_rundata.nml file,  </span>
<a name="ln-402"></a><span class="c">! then we simply read that file in; otherwise, we read all the defect descriptor files</span>
<a name="ln-403"></a>
<a name="ln-404"></a><span class="c">! is there a void data filename? If so, then read it  </span>
<a name="ln-405"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">voidname</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="s1">&#39;none&#39;</span><span class="p">)</span> <span class="k">call </span><span class="n">read_void_data</span><span class="p">(</span><span class="n">numvoids</span><span class="p">,</span><span class="n">voidname</span><span class="p">,</span><span class="n">DF_L</span><span class="p">,</span><span class="n">DF_npix</span><span class="p">,</span><span class="n">DF_npiy</span><span class="p">,</span><span class="n">dinfo</span><span class="p">)</span>
<a name="ln-406"></a>
<a name="ln-407"></a><span class="c">! read namelist files for all dislocations, if any</span>
<a name="ln-408"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">numdisl</span><span class="p">.</span><span class="n">gt</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span> <span class="k">call </span><span class="n">read_dislocation_data</span><span class="p">(</span><span class="n">dislname</span><span class="p">,</span><span class="n">numdisl</span><span class="p">,</span><span class="n">numsf</span><span class="p">,</span><span class="n">DF_npix</span><span class="p">,</span><span class="n">DF_npiy</span><span class="p">,</span><span class="n">DF_gf</span><span class="p">,</span><span class="n">DF_L</span><span class="p">,</span><span class="n">dinfo</span><span class="p">)</span>
<a name="ln-409"></a>
<a name="ln-410"></a><span class="c">! read namelist files for all Yoffe dislocations, if any</span>
<a name="ln-411"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">numYdisl</span><span class="p">.</span><span class="n">gt</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span> <span class="k">call </span><span class="n">read_YSH_dislocation_data</span><span class="p">(</span><span class="n">dislYname</span><span class="p">,</span><span class="n">numYdisl</span><span class="p">,</span><span class="n">DF_npix</span><span class="p">,</span><span class="n">DF_npiy</span><span class="p">,</span><span class="n">DF_gf</span><span class="p">,</span><span class="n">DF_L</span><span class="p">,</span><span class="n">dinfo</span><span class="p">)</span>
<a name="ln-412"></a>
<a name="ln-413"></a><span class="c">! read namelist files for all stacking faults, if any</span>
<a name="ln-414"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">numsf</span><span class="p">.</span><span class="n">gt</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span> <span class="k">call </span><span class="n">read_stacking_fault_data</span><span class="p">(</span><span class="n">numsf</span><span class="p">,</span><span class="n">numdisl</span><span class="p">,</span><span class="n">sfname</span><span class="p">,</span><span class="n">DF_L</span><span class="p">,</span><span class="n">DF_npix</span><span class="p">,</span><span class="n">DF_npiy</span><span class="p">,</span><span class="n">DF_g</span><span class="p">,</span><span class="n">dinfo</span><span class="p">)</span>
<a name="ln-415"></a>
<a name="ln-416"></a><span class="c">! is there an inclusion data file? if so, then read it</span>
<a name="ln-417"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">incname</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="s1">&#39;none&#39;</span><span class="p">)</span> <span class="k">call </span><span class="n">read_inclusion_data</span><span class="p">(</span><span class="n">numinc</span><span class="p">,</span><span class="n">incname</span><span class="p">,</span><span class="n">DF_L</span><span class="p">,</span><span class="n">DF_npix</span><span class="p">,</span><span class="n">DF_npiy</span><span class="p">,</span><span class="n">dinfo</span><span class="p">)</span>
<a name="ln-418"></a>
<a name="ln-419"></a><span class="c">! transform the g-vector to the defect reference frames (needed for all dislocations in CalcR).</span>
<a name="ln-420"></a><span class="c">! this can only be done AFTER all dislocations and stacking faults have been created.</span>
<a name="ln-421"></a>   <span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">numdisl</span>
<a name="ln-422"></a>     <span class="n">DF_gd</span><span class="p">(</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="nb">matmul</span><span class="p">(</span><span class="n">DL</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">a_dc</span><span class="p">,</span><span class="n">DF_gc</span><span class="p">)</span>
<a name="ln-423"></a>   <span class="k">end do</span>
<a name="ln-424"></a>   
<a name="ln-425"></a><span class="c">! precompute ALL the defect columns and, if needed, store them in dispfile</span>
<a name="ln-426"></a><span class="c">! this portion should be carried out in multi-threaded mode as much as possible</span>
<a name="ln-427"></a>  <span class="k">allocate</span><span class="p">(</span><span class="n">disparray</span><span class="p">(</span><span class="n">DF_nums</span><span class="p">,</span><span class="n">DF_npix</span><span class="p">,</span><span class="n">DF_npiy</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
<a name="ln-428"></a>  <span class="n">disparray</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-429"></a>  <span class="n">mess</span> <span class="o">=</span> <span class="s1">&#39; Starting Displacement Field Computation &#39;</span><span class="p">;</span> <span class="k">call </span><span class="n">Message</span><span class="p">(</span><span class="s2">&quot;(A/)&quot;</span><span class="p">)</span>
<a name="ln-430"></a>
<a name="ln-431"></a>  <span class="k">call </span><span class="n">CalcRLocal</span><span class="p">(</span><span class="n">numvoids</span><span class="p">,</span><span class="n">numdisl</span><span class="p">,</span><span class="n">numYdisl</span><span class="p">,</span><span class="n">numsf</span><span class="p">,</span><span class="n">numinc</span><span class="p">,</span><span class="n">DF_nums</span><span class="p">,</span><span class="n">DF_npix</span><span class="p">,</span><span class="n">DF_npiy</span><span class="p">,</span><span class="n">t_interval</span><span class="p">,</span><span class="n">disparray</span><span class="p">)</span>
<a name="ln-432"></a>   
<a name="ln-433"></a>   <span class="k">write</span> <span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="nb">maxval</span><span class="p">(</span><span class="n">disparray</span><span class="p">),</span><span class="nb">minval</span><span class="p">(</span><span class="n">disparray</span><span class="p">)</span>
<a name="ln-434"></a>   
<a name="ln-435"></a><span class="c">! and, if needed, store the defect displacement field for re-runs</span>
<a name="ln-436"></a>    <span class="n">mess</span> <span class="o">=</span> <span class="s1">&#39;Displacement field data stored in file &#39;</span><span class="o">//</span><span class="n">dispfile</span><span class="p">;</span> <span class="k">call </span><span class="n">Message</span><span class="p">(</span><span class="s2">&quot;(/A/)&quot;</span><span class="p">)</span>
<a name="ln-437"></a>    <span class="k">open</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">dataunit</span><span class="p">,</span><span class="k">file</span><span class="o">=</span><span class="nb">trim</span><span class="p">(</span><span class="n">EMsoft_toNativePath</span><span class="p">(</span><span class="n">dispfile</span><span class="p">)),</span><span class="n">status</span><span class="o">=</span><span class="s1">&#39;new&#39;</span><span class="p">,</span><span class="n">action</span><span class="o">=</span><span class="s1">&#39;write&#39;</span><span class="p">,</span><span class="n">form</span><span class="o">=</span><span class="s1">&#39;unformatted&#39;</span><span class="p">)</span>
<a name="ln-438"></a>    <span class="n">i</span><span class="o">=</span><span class="mi">3</span>
<a name="ln-439"></a>    <span class="k">write</span> <span class="p">(</span><span class="n">dataunit</span><span class="p">)</span> <span class="n">DF_nums</span><span class="p">,</span><span class="n">DF_npix</span><span class="p">,</span><span class="n">DF_npiy</span><span class="p">,</span><span class="n">i</span>
<a name="ln-440"></a>    <span class="k">write</span> <span class="p">(</span><span class="n">dataunit</span><span class="p">)</span> <span class="n">disparray</span>
<a name="ln-441"></a>    <span class="k">call </span><span class="n">SafeCloseFile</span><span class="p">(</span><span class="s1">&#39;d1&#39;</span><span class="p">,</span><span class="s1">&#39;keep&#39;</span><span class="p">,</span><span class="n">dispfile</span><span class="p">,.</span><span class="n">FALSE</span><span class="p">.)</span>
<a name="ln-442"></a>
<a name="ln-443"></a><span class="k">end program </span><span class="n">dispfield</span>
<a name="ln-444"></a>
<a name="ln-445"></a>
<a name="ln-446"></a>
<a name="ln-447"></a><span class="k">recursive subroutine </span><span class="n">CalcRLocal</span><span class="p">(</span><span class="n">numvoids</span><span class="p">,</span><span class="n">numdisl</span><span class="p">,</span><span class="n">numYdisl</span><span class="p">,</span><span class="n">numsf</span><span class="p">,</span><span class="n">numinc</span><span class="p">,</span><span class="n">lDFnums</span><span class="p">,</span><span class="n">lDFnpix</span><span class="p">,</span><span class="n">lDFnpiy</span><span class="p">,</span><span class="n">t_interval</span><span class="p">,</span><span class="n">disparray</span><span class="p">)</span>
<a name="ln-448"></a>
<a name="ln-449"></a><span class="c">! this routine returns the total displacement field (multithreaded with OPENMP)</span>
<a name="ln-450"></a>
<a name="ln-451"></a><span class="k">use </span><span class="n">local</span>
<a name="ln-452"></a><span class="k">use </span><span class="n">constants</span>
<a name="ln-453"></a><span class="k">use </span><span class="n">crystal</span>
<a name="ln-454"></a><span class="k">use </span><span class="n">crystalvars</span>
<a name="ln-455"></a><span class="k">use </span><span class="n">dislocation</span>
<a name="ln-456"></a><span class="k">use </span><span class="n">foilmodule</span>
<a name="ln-457"></a><span class="k">use </span><span class="n">void</span>
<a name="ln-458"></a><span class="k">use </span><span class="n">stacking_fault</span>
<a name="ln-459"></a><span class="k">use </span><span class="n">inclusion</span>
<a name="ln-460"></a><span class="k">use </span><span class="n">defectmodule</span>
<a name="ln-461"></a><span class="k">use </span><span class="n">timing</span>
<a name="ln-462"></a><span class="k">use </span><span class="n">YSHModule</span>
<a name="ln-463"></a>
<a name="ln-464"></a><span class="k">IMPLICIT NONE</span>
<a name="ln-465"></a>
<a name="ln-466"></a><span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">irg</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">ii</span><span class="p">,</span><span class="n">islice</span><span class="p">,</span><span class="n">numvoids</span><span class="p">,</span><span class="n">numdisl</span><span class="p">,</span><span class="n">numYdisl</span><span class="p">,</span><span class="n">numsf</span><span class="p">,</span><span class="n">numinc</span><span class="p">,</span><span class="n">lDFnums</span><span class="p">,</span><span class="n">lDFnpix</span><span class="p">,</span><span class="n">lDFnpiy</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-467"></a>                                  <span class="n">TID</span><span class="p">,</span><span class="n">NTHR</span><span class="p">,</span><span class="n">imat</span><span class="p">,</span><span class="n">t_interval</span><span class="p">,</span><span class="n">jcnt</span>
<a name="ln-468"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">)</span>          <span class="kd">::</span> <span class="n">disparray</span><span class="p">(</span><span class="n">lDFnums</span><span class="p">,</span><span class="n">lDFnpix</span><span class="p">,</span><span class="n">lDFnpiy</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-469"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">)</span>          <span class="kd">::</span> <span class="n">rx</span><span class="p">,</span><span class="n">ry</span><span class="p">,</span><span class="n">rz</span><span class="p">,</span><span class="n">dis</span><span class="p">,</span><span class="n">xpos</span><span class="p">,</span><span class="n">ypos</span><span class="p">,</span><span class="n">zpos</span><span class="p">,</span><span class="n">RR</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span><span class="n">sumR</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span><span class="n">thick</span><span class="p">,</span><span class="n">tmp</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span><span class="n">tmpf</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span><span class="n">u</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span><span class="n">zaamp</span><span class="p">,</span><span class="n">zaphase</span><span class="p">,</span><span class="n">zar</span><span class="p">,</span><span class="n">zai</span><span class="p">,</span><span class="n">zr</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span><span class="n">zi</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="p">&amp;</span>
<a name="ln-470"></a>                                 <span class="n">zt</span><span class="p">,</span><span class="n">fx</span><span class="p">,</span><span class="n">fy</span><span class="p">,</span><span class="n">fz</span><span class="p">,</span><span class="n">z0</span><span class="p">,</span><span class="n">gdotR</span><span class="p">,</span><span class="n">nunit</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>    <span class="c">!,&amp;</span>
<a name="ln-471"></a><span class="c">!                                nu,x,y,z,zn,t,pre,r1,r2,r3,th,rn </span>
<a name="ln-472"></a>                         
<a name="ln-473"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">dbl</span><span class="p">)</span>            <span class="kd">::</span> <span class="n">afi</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">afc</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">lDFR</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-474"></a><span class="kt">complex</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">dbl</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">za</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-475"></a><span class="kt">complex</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">zero</span>
<a name="ln-476"></a><span class="kt">logical</span>               <span class="kd">::</span> <span class="n">void</span>
<a name="ln-477"></a><span class="k">type</span> <span class="p">(</span><span class="n">voidtype</span><span class="p">),</span> <span class="k">allocatable</span>  <span class="kd">::</span> <span class="n">lvoids</span><span class="p">(:)</span>
<a name="ln-478"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">),</span><span class="k">allocatable</span> <span class="kd">::</span> <span class="n">lsg</span><span class="p">(:,:)</span>
<a name="ln-479"></a><span class="k">type</span> <span class="p">(</span><span class="n">dislocationtype</span><span class="p">),</span> <span class="k">allocatable</span>  <span class="kd">::</span> <span class="n">lDL</span><span class="p">(:)</span>    
<a name="ln-480"></a><span class="k">type</span> <span class="p">(</span><span class="n">YDtype</span><span class="p">),</span> <span class="k">allocatable</span>  <span class="kd">::</span> <span class="n">YDL</span><span class="p">(:)</span>    
<a name="ln-481"></a><span class="k">type</span> <span class="p">(</span><span class="n">stackingfaulttype</span><span class="p">),</span> <span class="k">allocatable</span>  <span class="kd">::</span> <span class="n">lSF</span><span class="p">(:)</span>
<a name="ln-482"></a><span class="k">type</span> <span class="p">(</span><span class="n">inclusiontype</span><span class="p">),</span> <span class="k">allocatable</span>  <span class="kd">::</span> <span class="n">linclusions</span><span class="p">(:)</span>
<a name="ln-483"></a>
<a name="ln-484"></a><span class="c">! before we start the threads, we need to copy data from various modules</span>
<a name="ln-485"></a><span class="c">! into local variables that can then be accessed by the threads ...</span>
<a name="ln-486"></a> <span class="n">Nmat</span> <span class="o">=</span> <span class="mi">10000</span>
<a name="ln-487"></a><span class="c">! foil unit normal in microscope frame </span>
<a name="ln-488"></a> <span class="n">nunit</span> <span class="o">=</span> <span class="nb">matmul</span><span class="p">(</span><span class="n">foil</span><span class="p">%</span><span class="n">Fn</span><span class="p">,</span><span class="nb">transpose</span><span class="p">(</span><span class="n">foil</span><span class="p">%</span><span class="n">a_mc</span><span class="p">))</span>
<a name="ln-489"></a><span class="c">! foil normal parameters for zpos computation</span>
<a name="ln-490"></a> <span class="n">fx</span> <span class="o">=</span> <span class="o">-</span><span class="n">nunit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">nunit</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-491"></a> <span class="n">fy</span> <span class="o">=</span> <span class="o">-</span><span class="n">nunit</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">nunit</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-492"></a> <span class="n">fz</span> <span class="o">=</span> <span class="n">foil</span><span class="p">%</span><span class="n">zb</span><span class="o">*</span><span class="mf">0.5</span>
<a name="ln-493"></a><span class="c">! other parameters</span>
<a name="ln-494"></a> <span class="n">z0</span> <span class="o">=</span> <span class="n">foil</span><span class="p">%</span><span class="n">z0</span>
<a name="ln-495"></a> <span class="n">thick</span> <span class="o">=</span> <span class="n">foil</span><span class="p">%</span><span class="n">zb</span>
<a name="ln-496"></a> <span class="n">zero</span> <span class="o">=</span> <span class="nb">cmplx</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">0.0</span><span class="p">)</span>
<a name="ln-497"></a> <span class="n">afi</span> <span class="o">=</span> <span class="n">foil</span><span class="p">%</span><span class="n">a_fi</span>
<a name="ln-498"></a> <span class="n">afc</span> <span class="o">=</span> <span class="n">foil</span><span class="p">%</span><span class="n">a_fc</span>
<a name="ln-499"></a> <span class="k">if</span> <span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">voids</span><span class="p">))</span> <span class="k">then</span>
<a name="ln-500"></a><span class="k">   allocate</span><span class="p">(</span><span class="n">lvoids</span><span class="p">(</span><span class="n">numvoids</span><span class="p">))</span>
<a name="ln-501"></a>   <span class="n">lvoids</span> <span class="o">=</span> <span class="n">voids</span>
<a name="ln-502"></a> <span class="n">endif</span>
<a name="ln-503"></a> <span class="k">allocate</span><span class="p">(</span><span class="n">lsg</span><span class="p">(</span><span class="n">foil</span><span class="p">%</span><span class="n">npix</span><span class="p">,</span><span class="n">foil</span><span class="p">%</span><span class="n">npiy</span><span class="p">))</span>
<a name="ln-504"></a> <span class="n">lsg</span> <span class="o">=</span> <span class="n">foil</span><span class="p">%</span><span class="n">sg</span>
<a name="ln-505"></a> <span class="k">if</span> <span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">DL</span><span class="p">))</span> <span class="k">then </span>
<a name="ln-506"></a><span class="k">   allocate</span><span class="p">(</span><span class="n">lDL</span><span class="p">(</span><span class="n">numdisl</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">numsf</span><span class="p">))</span>
<a name="ln-507"></a>   <span class="n">lDL</span> <span class="o">=</span> <span class="n">DL</span>
<a name="ln-508"></a> <span class="n">endif</span>
<a name="ln-509"></a> <span class="k">if</span> <span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">YD</span><span class="p">))</span> <span class="k">then </span>
<a name="ln-510"></a><span class="k">   allocate</span><span class="p">(</span><span class="n">YDL</span><span class="p">(</span><span class="n">numYdisl</span><span class="p">))</span>
<a name="ln-511"></a>   <span class="n">YDL</span> <span class="o">=</span> <span class="n">YD</span>
<a name="ln-512"></a> <span class="n">endif</span>
<a name="ln-513"></a> <span class="k">if</span> <span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">SF</span><span class="p">))</span> <span class="k">then </span>
<a name="ln-514"></a><span class="k">   allocate</span><span class="p">(</span><span class="n">lSF</span><span class="p">(</span><span class="n">numsf</span><span class="p">))</span>
<a name="ln-515"></a>   <span class="k">do </span><span class="n">ii</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">numsf</span> 
<a name="ln-516"></a>     <span class="k">allocate</span><span class="p">(</span><span class="n">lSF</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">zpos</span><span class="p">(</span><span class="n">foil</span><span class="p">%</span><span class="n">npix</span><span class="p">,</span><span class="n">foil</span><span class="p">%</span><span class="n">npiy</span><span class="p">))</span>
<a name="ln-517"></a>   <span class="k">end do</span>
<a name="ln-518"></a><span class="k">   </span><span class="n">lSF</span> <span class="o">=</span> <span class="n">SF</span>
<a name="ln-519"></a> <span class="n">endif</span>
<a name="ln-520"></a> <span class="k">if</span> <span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">inclusions</span><span class="p">))</span> <span class="k">then</span>
<a name="ln-521"></a><span class="k">   allocate</span><span class="p">(</span><span class="n">linclusions</span><span class="p">(</span><span class="n">numinc</span><span class="p">))</span>
<a name="ln-522"></a>   <span class="n">linclusions</span> <span class="o">=</span> <span class="n">inclusions</span>
<a name="ln-523"></a> <span class="k">end if</span>
<a name="ln-524"></a> 
<a name="ln-525"></a><span class="c">! ok, we&#39;ve copied all the necessary variables into local structures</span>
<a name="ln-526"></a><span class="c">! now we can perform the multi-threaded loop</span>
<a name="ln-527"></a>
<a name="ln-528"></a><span class="c">! initiate multi-threaded segment</span>
<a name="ln-529"></a><span class="c">!$OMP     PARALLEL PRIVATE(TID,lDFR,gdotR,i,j,k,imat,zt,xpos,ypos,zpos,islice,dis,sumR,tmp,tmpf, &amp;</span>
<a name="ln-530"></a><span class="c">!$OMP&amp;   ii,void,za,zar,zai,zaamp,zaphase,zr,zi,u,jcnt) &amp;</span>
<a name="ln-531"></a><span class="c">!$OMP&amp;   SHARED(NTHR,lDFnpix,lDFnpiy,lDFnums,DF_L,numvoids,numdisl,numsf,numinc,disparray,t_interval, &amp;</span>
<a name="ln-532"></a><span class="c">!$OMP&amp;    fx,fy,fz,z0,thick,zero,afi,afc,lvoids,lsg,lSF,linclusions,lDL,Nmat,YDL)</span>
<a name="ln-533"></a><span class="c">!  NTHR = OMP_GET_NUM_THREADS()</span>
<a name="ln-534"></a><span class="c">!  TID = OMP_GET_THREAD_NUM()</span>
<a name="ln-535"></a><span class="n">TID</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-536"></a><span class="n">NTHR</span> <span class="o">=</span> <span class="mi">1</span>
<a name="ln-537"></a>  <span class="k">if</span> <span class="p">(</span><span class="n">TID</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-538"></a><span class="c">! do time reporting only in the master thread</span>
<a name="ln-539"></a>    <span class="k">write</span> <span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s1">&#39;Message from master thread &#39;</span><span class="p">,</span><span class="n">TID</span><span class="p">,</span><span class="s1">&#39;: splitting into &#39;</span><span class="p">,</span><span class="n">NTHR</span><span class="p">,</span><span class="s1">&#39; threads &#39;</span>
<a name="ln-540"></a>    <span class="k">call </span><span class="n">Time_reset</span>
<a name="ln-541"></a>    <span class="k">call </span><span class="n">Time_report</span><span class="p">(</span><span class="mf">0.01</span><span class="o">*</span><span class="n">t_interval</span><span class="p">)</span>
<a name="ln-542"></a>    <span class="k">call </span><span class="n">Time_start</span>
<a name="ln-543"></a>    <span class="n">jcnt</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-544"></a>  <span class="k">end if</span>
<a name="ln-545"></a>
<a name="ln-546"></a><span class="c">!$OMP barrier</span>
<a name="ln-547"></a><span class="c">!$OMP DO SCHEDULE (GUIDED)</span>
<a name="ln-548"></a>  <span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">lDFnpix</span>  
<a name="ln-549"></a>    <span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">lDFnpiy</span>
<a name="ln-550"></a><span class="c">! compute the displacement vectors lDFR for all points in this column</span>
<a name="ln-551"></a>     
<a name="ln-552"></a><span class="c">! scale the image coordinates with respect to the origin at the center of the image;</span>
<a name="ln-553"></a><span class="c">! this is where we need to include the zoom factor ...</span>
<a name="ln-554"></a>      <span class="n">xpos</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="n">lDFnpix</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">DF_L</span>
<a name="ln-555"></a>      <span class="n">ypos</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">j</span><span class="o">-</span><span class="n">lDFnpiy</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">DF_L</span>
<a name="ln-556"></a>      <span class="n">zt</span> <span class="o">=</span>  <span class="p">(</span><span class="n">xpos</span><span class="o">*</span><span class="n">fx</span><span class="o">+</span><span class="n">ypos</span><span class="o">*</span><span class="n">fy</span><span class="o">+</span><span class="n">fz</span><span class="p">)</span>
<a name="ln-557"></a>       
<a name="ln-558"></a><span class="c">! loop over all slices (this is the main loop)</span>
<a name="ln-559"></a> <span class="n">sliceloop</span><span class="p">:</span> <span class="k">do </span><span class="n">islice</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="n">lDFnums</span> 
<a name="ln-560"></a>      <span class="n">lDFR</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-561"></a>
<a name="ln-562"></a><span class="c">! zpos is the position down the column, starting at zt (in image coordinates)</span>
<a name="ln-563"></a>      <span class="n">zpos</span> <span class="o">=</span> <span class="n">zt</span> <span class="o">-</span> <span class="nb">float</span><span class="p">(</span><span class="n">islice</span><span class="p">)</span><span class="o">*</span><span class="n">DF_slice</span>
<a name="ln-564"></a>      
<a name="ln-565"></a>    
<a name="ln-566"></a><span class="c">! set the displacements to zero</span>
<a name="ln-567"></a>       <span class="n">sumR</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-568"></a>    
<a name="ln-569"></a><span class="c">! convert image point (xpos,ypos,zpos) to tmpf in the foil reference frame</span>
<a name="ln-570"></a><span class="c">!       tmpf = matmul(matmul( (/ xpos, ypos, zpos /),transpose(afi)),afc)</span>
<a name="ln-571"></a>       <span class="n">tmpf</span> <span class="o">=</span> <span class="nb">matmul</span><span class="p">(</span> <span class="p">(</span><span class="o">/</span> <span class="n">xpos</span><span class="p">,</span> <span class="n">ypos</span><span class="p">,</span> <span class="n">zpos</span> <span class="o">/</span><span class="p">),</span><span class="nb">transpose</span><span class="p">(</span><span class="n">afi</span><span class="p">))</span>
<a name="ln-572"></a>    
<a name="ln-573"></a><span class="c">! let&#39;s put a few dislocations in ... (see section 8.4.2)</span>
<a name="ln-574"></a>
<a name="ln-575"></a>       <span class="k">do </span><span class="n">ii</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">numdisl</span>
<a name="ln-576"></a><span class="c">! convert the defect location from untilted image space to the tilted foil reference frame, and subtract it from the current</span>
<a name="ln-577"></a><span class="c">! column and slice position</span>
<a name="ln-578"></a>         <span class="n">tmp</span> <span class="o">=</span>  <span class="p">(</span><span class="o">/</span> <span class="n">xpos</span><span class="p">,</span> <span class="n">ypos</span><span class="p">,</span> <span class="n">zpos</span> <span class="o">/</span><span class="p">)</span> <span class="o">-</span> <span class="nb">matmul</span><span class="p">(</span> <span class="p">(</span><span class="o">/</span> <span class="n">DF_L</span><span class="o">*</span><span class="n">lDL</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">id</span><span class="p">,</span> <span class="n">DF_L</span><span class="o">*</span><span class="n">lDL</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">jd</span><span class="p">,</span> <span class="n">lDL</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">zfrac</span><span class="o">*</span><span class="n">z0</span> <span class="o">/</span><span class="p">),</span> <span class="nb">transpose</span><span class="p">(</span><span class="n">afi</span><span class="p">)</span> <span class="p">)</span>
<a name="ln-579"></a><span class="c">! then convert the difference vector to the defect reference frame for this dislocation (we will only need the x and y coordinates)</span>
<a name="ln-580"></a>         <span class="n">tmp</span> <span class="o">=</span> <span class="nb">matmul</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span><span class="n">lDL</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">a_id</span><span class="p">)</span>
<a name="ln-581"></a><span class="c">! check the z-coordinate; if it falls beyond the dislocation line that is inside the foil, then skip</span>
<a name="ln-582"></a><span class="c">! the displacement computation... the top and bottom coordinates of the dislocation intersections</span>
<a name="ln-583"></a><span class="c">! measured along the dislocation line were pre-computed when the dislocations were first read from</span>
<a name="ln-584"></a><span class="c">! the namelist files...</span>
<a name="ln-585"></a><span class="c">!         if (abs(tmp(3)).le.lDL(ii)%zu) then</span>
<a name="ln-586"></a><span class="c">! compute x1 + p_alpha x2  (eq. 8.38)</span>
<a name="ln-587"></a>          <span class="n">za</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">lDL</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">pa</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">tmp</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<a name="ln-588"></a><span class="c">! compute the displacement vector u (eq. 8.38) [this expands the log of a complex number and takes the real part only] </span>
<a name="ln-589"></a>          <span class="k">if</span> <span class="p">(</span><span class="n">tmp</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="n">gt</span><span class="p">.</span><span class="mf">0.0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-590"></a><span class="k">           do </span><span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span>
<a name="ln-591"></a>            <span class="n">zar</span> <span class="o">=</span>  <span class="kt">real</span><span class="p">(</span><span class="n">za</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
<a name="ln-592"></a>            <span class="n">zai</span> <span class="o">=</span> <span class="nb">aimag</span><span class="p">(</span><span class="n">za</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
<a name="ln-593"></a>            <span class="n">zaamp</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">za</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
<a name="ln-594"></a>            <span class="n">zaphase</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">zai</span><span class="o">/</span><span class="n">zar</span><span class="p">)</span>
<a name="ln-595"></a>            <span class="n">zr</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="nb">log</span><span class="p">(</span><span class="n">zaamp</span><span class="p">)</span>
<a name="ln-596"></a>            <span class="n">zi</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="nb">atan</span><span class="p">(</span><span class="n">zaphase</span><span class="p">)</span>
<a name="ln-597"></a>            <span class="k">if</span> <span class="p">(</span><span class="n">zar</span><span class="p">.</span><span class="n">le</span><span class="p">.</span><span class="mf">0.0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-598"></a><span class="k">              if</span> <span class="p">(</span><span class="n">zai</span><span class="p">.</span><span class="n">lt</span><span class="p">.</span><span class="mf">0.0</span><span class="p">)</span> <span class="n">zi</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="n">cPi</span><span class="o">+</span><span class="n">zi</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<a name="ln-599"></a>              <span class="k">if</span> <span class="p">(</span><span class="n">zai</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mf">0.0</span><span class="p">)</span> <span class="n">zi</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">cPi</span>
<a name="ln-600"></a>              <span class="k">if</span> <span class="p">(</span><span class="n">zai</span><span class="p">.</span><span class="n">gt</span><span class="p">.</span><span class="mf">0.0</span><span class="p">)</span> <span class="n">zi</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">cPi</span><span class="o">-</span><span class="n">zi</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<a name="ln-601"></a>            <span class="k">else</span>
<a name="ln-602"></a><span class="k">              if</span> <span class="p">(</span><span class="n">zai</span><span class="p">.</span><span class="n">lt</span><span class="p">.</span><span class="mf">0.0</span><span class="p">)</span> <span class="n">zi</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="n">zi</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<a name="ln-603"></a>            <span class="k">end if</span>
<a name="ln-604"></a><span class="k">           end do</span>
<a name="ln-605"></a><span class="k">          else</span>
<a name="ln-606"></a><span class="k">           do </span><span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span>
<a name="ln-607"></a>            <span class="n">zar</span> <span class="o">=</span>  <span class="kt">real</span><span class="p">(</span><span class="n">za</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
<a name="ln-608"></a>            <span class="n">zai</span> <span class="o">=</span> <span class="nb">aimag</span><span class="p">(</span><span class="n">za</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
<a name="ln-609"></a>            <span class="n">zaamp</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">za</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
<a name="ln-610"></a>            <span class="n">zaphase</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">zai</span><span class="o">/</span><span class="n">zar</span><span class="p">)</span>
<a name="ln-611"></a>            <span class="n">zr</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="nb">log</span><span class="p">(</span><span class="n">zaamp</span><span class="p">)</span>
<a name="ln-612"></a>            <span class="n">zi</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="nb">atan</span><span class="p">(</span><span class="n">zaphase</span><span class="p">)</span>
<a name="ln-613"></a>            <span class="k">if</span> <span class="p">(</span><span class="n">zar</span><span class="p">.</span><span class="n">le</span><span class="p">.</span><span class="mf">0.0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-614"></a><span class="k">              if</span> <span class="p">(</span><span class="n">zai</span><span class="p">.</span><span class="n">gt</span><span class="p">.</span><span class="mf">0.0</span><span class="p">)</span> <span class="n">zi</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">cPi</span><span class="o">-</span><span class="n">zi</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<a name="ln-615"></a>              <span class="k">if</span> <span class="p">(</span><span class="n">zai</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mf">0.0</span><span class="p">)</span> <span class="n">zi</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">cPi</span>
<a name="ln-616"></a>              <span class="k">if</span> <span class="p">(</span><span class="n">zai</span><span class="p">.</span><span class="n">lt</span><span class="p">.</span><span class="mf">0.0</span><span class="p">)</span> <span class="n">zi</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">cPi</span><span class="o">+</span><span class="n">zi</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<a name="ln-617"></a>            <span class="k">else</span>
<a name="ln-618"></a><span class="k">              if</span> <span class="p">(</span><span class="n">zai</span><span class="p">.</span><span class="n">lt</span><span class="p">.</span><span class="mf">0.0</span><span class="p">)</span> <span class="n">zi</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">cPi</span><span class="o">-</span><span class="n">zi</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<a name="ln-619"></a>              <span class="k">if</span> <span class="p">(</span><span class="n">zai</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mf">0.0</span><span class="p">)</span> <span class="n">zi</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-620"></a>            <span class="k">end if</span>
<a name="ln-621"></a><span class="k">           end do  </span>
<a name="ln-622"></a><span class="k">          end if</span>
<a name="ln-623"></a><span class="k">          </span><span class="n">u</span> <span class="o">=</span> <span class="mf">2.0</span><span class="o">*</span><span class="kt">real</span><span class="p">(</span><span class="nb">matmul</span><span class="p">(</span><span class="n">lDL</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">dismat</span><span class="p">,</span><span class="nb">cmplx</span><span class="p">(</span><span class="n">zr</span><span class="p">,</span><span class="n">zi</span><span class="p">)))</span>
<a name="ln-624"></a><span class="c">! transform displacement vector u to the Cartesian crystal reference frame and then to the foil frame</span>
<a name="ln-625"></a>          <span class="n">u</span> <span class="o">=</span> <span class="nb">matmul</span><span class="p">(</span><span class="nb">matmul</span><span class="p">(</span><span class="n">u</span><span class="p">,</span><span class="n">lDL</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">a_dc</span><span class="p">),</span><span class="nb">transpose</span><span class="p">(</span><span class="n">afc</span><span class="p">))</span>
<a name="ln-626"></a>          <span class="n">sumR</span> <span class="o">=</span> <span class="n">sumR</span> <span class="o">+</span> <span class="n">u</span>
<a name="ln-627"></a><span class="c">!         end if </span>
<a name="ln-628"></a>       <span class="k">end do</span>
<a name="ln-629"></a>
<a name="ln-630"></a><span class="c">! do we have any dislocations with surface relaxations ?  YSH model</span>
<a name="ln-631"></a>       <span class="k">if</span> <span class="p">(</span><span class="n">numYdisl</span><span class="p">.</span><span class="n">gt</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span> <span class="k">then </span>
<a name="ln-632"></a><span class="k">        do </span><span class="n">ii</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">numYdisl</span>
<a name="ln-633"></a><span class="c">! first, figure out what the coordinates are in the YSH reference frame for this dislocation ... </span>
<a name="ln-634"></a><span class="c">! translate to the defect origin</span>
<a name="ln-635"></a>         <span class="n">tmp</span> <span class="o">=</span>  <span class="p">(</span><span class="o">/</span> <span class="n">xpos</span><span class="p">,</span> <span class="n">ypos</span><span class="p">,</span> <span class="n">zpos</span> <span class="o">/</span><span class="p">)</span> <span class="o">-</span>  <span class="p">(</span><span class="o">/</span> <span class="n">DF_L</span><span class="o">*</span><span class="n">YDL</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">id</span><span class="p">,</span> <span class="n">DF_L</span><span class="o">*</span><span class="n">YDL</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">jd</span><span class="p">,</span> <span class="n">z0</span><span class="o">*</span><span class="mf">0.5</span> <span class="o">/</span><span class="p">)</span>
<a name="ln-636"></a><span class="c">! rotate into the defect reference frame</span>
<a name="ln-637"></a>         <span class="n">tmp</span> <span class="o">=</span> <span class="nb">matmul</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span><span class="n">YDL</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">a_id</span><span class="p">)</span>
<a name="ln-638"></a><span class="c">! compute the displacement vector</span>
<a name="ln-639"></a>         <span class="n">u</span> <span class="o">=</span> <span class="nb">sngl</span><span class="p">(</span><span class="n">YSHDisp</span><span class="p">(</span><span class="nb">dble</span><span class="p">(</span><span class="n">tmp</span><span class="p">(</span><span class="mi">1</span><span class="p">)),</span><span class="nb">dble</span><span class="p">(</span><span class="n">tmp</span><span class="p">(</span><span class="mi">2</span><span class="p">)),</span><span class="nb">dble</span><span class="p">(</span><span class="n">tmp</span><span class="p">(</span><span class="mi">3</span><span class="p">)),</span><span class="n">ii</span><span class="p">))</span>
<a name="ln-640"></a><span class="c">!         write (*,*) u</span>
<a name="ln-641"></a><span class="c">! and rotate back to the image reference frame</span>
<a name="ln-642"></a>         <span class="n">u</span> <span class="o">=</span> <span class="nb">matmul</span><span class="p">(</span><span class="n">u</span><span class="p">,</span><span class="n">YDL</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">a_di</span><span class="p">)</span>
<a name="ln-643"></a><span class="c">! that should do it !</span>
<a name="ln-644"></a>         <span class="n">sumR</span> <span class="o">=</span> <span class="n">sumR</span> <span class="o">+</span> <span class="n">u</span>
<a name="ln-645"></a>       <span class="k">end do</span>
<a name="ln-646"></a><span class="k">      end if</span>
<a name="ln-647"></a>
<a name="ln-648"></a>
<a name="ln-649"></a><span class="c">! stacking faults (this is easy because we&#39;ve already done all the work in the stacking_fault module)</span>
<a name="ln-650"></a><span class="c">!       do ii=1,numsf</span>
<a name="ln-651"></a><span class="c">!         if ((zpos.lt.lSF(ii)%zpos(i,j)).and.(lSF(ii)%zpos(i,j).ne.-10000.0)) then </span>
<a name="ln-652"></a><span class="c">!           sumR = sumR + lSF(ii)%lpbc</span>
<a name="ln-653"></a><span class="c">!         end if</span>
<a name="ln-654"></a><span class="c">!       end do</span>
<a name="ln-655"></a>
<a name="ln-656"></a><span class="c">! write(*,*) sumR(1:3)</span>
<a name="ln-657"></a>      <span class="n">disparray</span><span class="p">(</span><span class="n">islice</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">sumR</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-658"></a><span class="c">!      if (i.eq.10) write (*,*) sumR(1:3)</span>
<a name="ln-659"></a>      
<a name="ln-660"></a>    <span class="k">end do </span><span class="n">sliceloop</span>
<a name="ln-661"></a>    
<a name="ln-662"></a>   <span class="k">end do</span>  <span class="c">! j-loop</span>
<a name="ln-663"></a>  <span class="k">if</span> <span class="p">(</span><span class="n">TID</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span> <span class="k">then </span>
<a name="ln-664"></a><span class="k">    </span><span class="n">jcnt</span> <span class="o">=</span> <span class="n">jcnt</span><span class="o">+</span><span class="mi">1</span>
<a name="ln-665"></a>    <span class="k">if</span> <span class="p">(</span><span class="nb">mod</span><span class="p">(</span><span class="n">jcnt</span><span class="p">,</span><span class="n">t_interval</span><span class="p">).</span><span class="n">eq</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span> <span class="k">call </span><span class="n">Time_remaining</span><span class="p">(</span><span class="n">jcnt</span><span class="p">,</span><span class="n">lDFnpix</span><span class="o">/</span><span class="n">NTHR</span><span class="p">)</span>
<a name="ln-666"></a>  <span class="n">endif</span>
<a name="ln-667"></a><span class="k">end do</span>  <span class="c">! i-loop</span>
<a name="ln-668"></a><span class="c">!$OMP END DO </span>
<a name="ln-669"></a> <span class="k">if</span> <span class="p">(</span><span class="n">TID</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span> <span class="k">call </span><span class="n">Time_stop</span><span class="p">(</span><span class="n">DF_npix</span><span class="o">*</span><span class="n">DF_npiy</span><span class="p">)</span>
<a name="ln-670"></a><span class="c">!$OMP END PARALLEL</span>
<a name="ln-671"></a>
<a name="ln-672"></a><span class="k">end subroutine </span><span class="n">CalcRLocal</span>
<a name="ln-673"></a>
<a name="ln-674"></a>
<a name="ln-675"></a>
<a name="ln-676"></a>
<a name="ln-677"></a>       
</pre></div>

    </section>
    </div>
  </div>

  <section class="visible-xs visible-sm hidden-md">
    <hr>
    

<div class="panel panel-default">
  <div class="panel-heading text-left"><h3 class="panel-title"><a data-toggle="collapse" href="#allfiles-1">All Source Files</a></h3></div>
  <div id="allfiles-1" class="panel-collapse collapse">
    <div class="list-group">
      
      <a class="list-group-item" href="../sourcefile/apb.f90.html">apb.f90</a>
      
      <a class="list-group-item" href="../sourcefile/bobyqa.f90.html">bobyqa.f90</a>
      
      <a class="list-group-item" href="../sourcefile/bobyqa_refinement.f90.html">bobyqa_refinement.f90</a>
      
      <a class="list-group-item" href="../sourcefile/clsupport.f90.html">CLsupport.f90</a>
      
      <a class="list-group-item" href="../sourcefile/constants.f90.html">constants.f90</a>
      
      <a class="list-group-item" href="../sourcefile/defectmodule.f90.html">defectmodule.f90</a>
      
      <a class="list-group-item" href="../sourcefile/dictmod.f90.html">dictmod.f90</a>
      
      <a class="list-group-item" href="../sourcefile/dispfield.f90.html">dispfield.f90</a>
      
      <a class="list-group-item" href="../sourcefile/distortion.f90.html">distortion.f90</a>
      
      <a class="list-group-item" href="../sourcefile/eccimod.f90.html">ECCImod.f90</a>
      
      <a class="list-group-item" href="../sourcefile/eispack.f90.html">eispack.f90</a>
      
      <a class="list-group-item" href="../sourcefile/emdymod.f90.html">EMdymod.f90</a>
      
      <a class="list-group-item" href="../sourcefile/filters.f90.html">filters.f90</a>
      
      <a class="list-group-item" href="../sourcefile/hdftest.f90.html">hdftest.f90</a>
      
      <a class="list-group-item" href="../sourcefile/indexingmod.f90.html">Indexingmod.f90</a>
      
      <a class="list-group-item" href="../sourcefile/initializers.f90.html">initializers.f90</a>
      
      <a class="list-group-item" href="../sourcefile/jsonsupport.f90.html">JSONsupport.f90</a>
      
      <a class="list-group-item" href="../sourcefile/muellercalculus.f90.html">MuellerCalculus.f90</a>
      
      <a class="list-group-item" href="../sourcefile/multibeams.f90.html">multibeams.f90</a>
      
      <a class="list-group-item" href="../sourcefile/namelisthandlers.f90.html">NameListHandlers.f90</a>
      
      <a class="list-group-item" href="../sourcefile/namelistjsonwriters.f90.html">NameListJSONwriters.f90</a>
      
      <a class="list-group-item" href="../sourcefile/namelisttypedefs.f90.html">NameListTypedefs.f90</a>
      
      <a class="list-group-item" href="../sourcefile/noise.f90.html">noise.f90</a>
      
      <a class="list-group-item" href="../sourcefile/others.f90.html">others.f90</a>
      
      <a class="list-group-item" href="../sourcefile/pedmod.f90.html">PEDmod.f90</a>
      
      <a class="list-group-item" href="../sourcefile/pfinversion.f90.html">PFInversion.f90</a>
      
      <a class="list-group-item" href="../sourcefile/pgm.f90.html">pgm.f90</a>
      
      <a class="list-group-item" href="../sourcefile/povray.f90.html">povray.f90</a>
      
      <a class="list-group-item" href="../sourcefile/rng.f90.html">rng.f90</a>
      
      <a class="list-group-item" href="../sourcefile/simulated_annealing.f90.html">simulated_annealing.f90</a>
      
      <a class="list-group-item" href="../sourcefile/so3.f90.html">so3.f90</a>
      
      <a class="list-group-item" href="../sourcefile/stemmodule.f90.html">STEMmodule.f90</a>
      
      <a class="list-group-item" href="../sourcefile/timing.f90.html">timing.f90</a>
      
    </div>
  </div>
</div>


  </section>
  
    <hr>    
    </div> <!-- /container -->
    <footer>
      <div class="container">
      <div class="row">
        <div class="col-xs-6 col-md-4"><p>&copy; 2017 <a rel="license" href="http://www.freebsd.org/copyright/freebsd-doc-license.html">FreeBSD Documentation License</a></p></div>
        <div class="col-xs-6 col-md-4 col-md-push-4">
          <p class="text-right">
            Documentation generated by 
            <a href="https://github.com/cmacmackin/ford">FORD</a>
            
          </p>
        </div>
        <div class="col-xs-12 col-md-4 col-md-pull-4"><p class="text-center"> Fortran Program was developed by Marc De Graef Research Group/Carnegie Mellon University</p></div>
      </div>
      <br>
      </div> <!-- /container -->    
    </footer>

    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
<!--
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
-->
    <script src="../js/bootstrap.min.js"></script>
    <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
    <script src="../js/ie10-viewport-bug-workaround.js"></script>

    <!-- MathJax JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        TeX: { extensions: ['AMSmath.js','AMSsymbols.js','noErrors.js','noUndefined.js'], equationNumbers: { autoNumber: 'AMS' } },
        jax: ['input/TeX','input/MathML','output/HTML-CSS'],
        extensions: ['tex2jax.js','mml2jax.js','MathMenu.js','MathZoom.js'],
        'HTML-CSS': { 
           styles: { '.MathJax_Display, .MathJax .mo, .MathJax .mi, .MathJax .mn': {color: '#000000 ! important'} }
        }
      });
    </script>
    <script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
  </body>
</html>