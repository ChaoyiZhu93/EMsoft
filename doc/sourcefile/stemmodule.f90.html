<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
	 
	 <meta name="description" content="EMsoft main library">
    
    <meta name="author" content="Marc De Graef Research Group/Carnegie Mellon University" >
    <link rel="icon" href="../favicon.png">

    <title>STEMmodule.f90 &ndash; Fortran Program</title>

    <link href="../css/bootstrap.min.css" rel="stylesheet">
    <link href="../css/pygments.css" rel="stylesheet">
    <link href="../css/font-awesome.min.css" rel="stylesheet">
    <link href="../css/local.css" rel="stylesheet">
    

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    
    <script src="../js/jquery-2.1.3.min.js"></script>
    <script src="../js/svg-pan-zoom.min.js"></script>

    
    <script src="../tipuesearch/tipuesearch_content.js"></script>
    <link  href="../tipuesearch/tipuesearch.css" rel="stylesheet">
    <script src="../tipuesearch/tipuesearch_set.js"></script>
    <script src="../tipuesearch/tipuesearch.js"></script>
    

  </head>

  <body>

    <!-- Fixed navbar -->
    <nav class="navbar navbar-inverse navbar-fixed-top">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="../index.html">Fortran Program </a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
				
            <li class="dropdown hidden-xs visible-sm visible-md hidden-lg">
              <a href="#" class="dropdown-toggle"
              data-toggle="dropdown" role="button"
              aria-haspopup="true"
		 aria-expanded="false">Contents <span class="caret"></span></a>
	      <ul class="dropdown-menu">
              
            <li><a href="../lists/files.html">Source Files</a></li>
				
				
            <li><a href="../lists/modules.html">Modules</a></li>
				
            
                                
            <li><a href="../lists/procedures.html">Procedures</a></li>
				
				
            <li><a href="../lists/absint.html">Abstract Interfaces</a></li>
								
            <li><a href="../lists/types.html">Derived Types</a></li>
				
				
            <li><a href="../lists/programs.html">Programs</a></li>
				
            </ul>
            </li>

<li class="visible-xs hidden-sm visible-lg"><a href="../lists/files.html">Source Files</a></li>


<li class="visible-xs hidden-sm visible-lg"><a href="../lists/modules.html">Modules</a></li>



<li class="visible-xs hidden-sm visible-lg"><a href="../lists/procedures.html">Procedures</a></li>


<li class="visible-xs hidden-sm visible-lg"><a href="../lists/absint.html">Abstract Interfaces</a></li>
                             
<li class="visible-xs hidden-sm visible-lg"><a href="../lists/types.html">Derived Types</a></li>


<li class="visible-xs hidden-sm visible-lg"><a href="../lists/programs.html">Programs</a></li>

          </ul>
        
        <form action="../search.html" class="navbar-form navbar-right" role="search">
        <div class="form-group">
          <input type="text" class="form-control" placeholder="Search" name="q" id="tipue_search_input" autocomplete="off" required>
        </div>
<!--
        <button type="submit" class="btn btn-default">Submit</button>
-->
        </form>
        
        </div><!--/.nav-collapse -->
      </div>
    </nav>

    <div class="container">
    
  
  <div class="row">
    <h1>STEMmodule.f90
    <small>Source File</small>
    
    </h1>
    
<div class="row">
  <div class="col-lg-12">
<div class="well well-sm">
  <ul class="list-inline" style="margin-bottom:0px;display:inline">
     
     
     
     
    
    
     <li><i class="fa fa-list-ol"></i>
       <a data-toggle="tooltip"
	  data-placement="bottom" data-html="true"
	  title=" 1.3% of total for source files.">397 statements</a>
     </li> 
     
     
    <li><i class="fa fa-code"></i><a href="../src/STEMmodule.f90"> Source File</a></li>
     
  </ul>
  <ol class="breadcrumb in-well text-right">
  
     <li class="active">STEMmodule.f90</li>
  </ol>
</div>
</div>
</div>
<script>
  $(function () {
  $('[data-toggle="tooltip"]').tooltip()
  })
</script>

  </div>
  <div class="row">
    <div class="col-md-3 hidden-xs hidden-sm visible-md visible-lg">
    
<div id="sidebar">
  






<div class="panel panel-primary">
  <div class="panel-heading text-left"><h3 class="panel-title"><a data-toggle="collapse" href="#mods-0">Modules</a></h3></div>
  <div id="mods-0" class="panel-collapse collapse">
    <div class="list-group">
      
      <a class="list-group-item" href="../module/stemmodule.html">STEMmodule</a>
      
    </div>
  </div>
</div>















<div class="panel panel-primary">
  <div class="panel-heading text-left"><h3 class="panel-title">Source Code</h3></div>
  <div class="list-group">
    <a class="list-group-item" href="../sourcefile/stemmodule.f90.html#src">STEMmodule.f90</a>
  </div>
</div>


  <hr>
  

<div class="panel panel-default">
  <div class="panel-heading text-left"><h3 class="panel-title"><a data-toggle="collapse" href="#allfiles-0">All Source Files</a></h3></div>
  <div id="allfiles-0" class="panel-collapse collapse">
    <div class="list-group">
      
      <a class="list-group-item" href="../sourcefile/apb.f90.html">apb.f90</a>
      
      <a class="list-group-item" href="../sourcefile/bobyqa.f90.html">bobyqa.f90</a>
      
      <a class="list-group-item" href="../sourcefile/bobyqa_refinement.f90.html">bobyqa_refinement.f90</a>
      
      <a class="list-group-item" href="../sourcefile/clsupport.f90.html">CLsupport.f90</a>
      
      <a class="list-group-item" href="../sourcefile/constants.f90.html">constants.f90</a>
      
      <a class="list-group-item" href="../sourcefile/defectmodule.f90.html">defectmodule.f90</a>
      
      <a class="list-group-item" href="../sourcefile/dictmod.f90.html">dictmod.f90</a>
      
      <a class="list-group-item" href="../sourcefile/dispfield.f90.html">dispfield.f90</a>
      
      <a class="list-group-item" href="../sourcefile/distortion.f90.html">distortion.f90</a>
      
      <a class="list-group-item" href="../sourcefile/eccimod.f90.html">ECCImod.f90</a>
      
      <a class="list-group-item" href="../sourcefile/eispack.f90.html">eispack.f90</a>
      
      <a class="list-group-item" href="../sourcefile/emdymod.f90.html">EMdymod.f90</a>
      
      <a class="list-group-item" href="../sourcefile/filters.f90.html">filters.f90</a>
      
      <a class="list-group-item" href="../sourcefile/hdftest.f90.html">hdftest.f90</a>
      
      <a class="list-group-item" href="../sourcefile/indexingmod.f90.html">Indexingmod.f90</a>
      
      <a class="list-group-item" href="../sourcefile/initializers.f90.html">initializers.f90</a>
      
      <a class="list-group-item" href="../sourcefile/jsonsupport.f90.html">JSONsupport.f90</a>
      
      <a class="list-group-item" href="../sourcefile/muellercalculus.f90.html">MuellerCalculus.f90</a>
      
      <a class="list-group-item" href="../sourcefile/multibeams.f90.html">multibeams.f90</a>
      
      <a class="list-group-item" href="../sourcefile/namelisthandlers.f90.html">NameListHandlers.f90</a>
      
      <a class="list-group-item" href="../sourcefile/namelistjsonwriters.f90.html">NameListJSONwriters.f90</a>
      
      <a class="list-group-item" href="../sourcefile/namelisttypedefs.f90.html">NameListTypedefs.f90</a>
      
      <a class="list-group-item" href="../sourcefile/noise.f90.html">noise.f90</a>
      
      <a class="list-group-item" href="../sourcefile/others.f90.html">others.f90</a>
      
      <a class="list-group-item" href="../sourcefile/pedmod.f90.html">PEDmod.f90</a>
      
      <a class="list-group-item" href="../sourcefile/pfinversion.f90.html">PFInversion.f90</a>
      
      <a class="list-group-item" href="../sourcefile/pgm.f90.html">pgm.f90</a>
      
      <a class="list-group-item" href="../sourcefile/povray.f90.html">povray.f90</a>
      
      <a class="list-group-item" href="../sourcefile/rng.f90.html">rng.f90</a>
      
      <a class="list-group-item" href="../sourcefile/simulated_annealing.f90.html">simulated_annealing.f90</a>
      
      <a class="list-group-item" href="../sourcefile/so3.f90.html">so3.f90</a>
      
      <a class="list-group-item" href="../sourcefile/stemmodule.f90.html">STEMmodule.f90</a>
      
      <a class="list-group-item" href="../sourcefile/timing.f90.html">timing.f90</a>
      
    </div>
  </div>
</div>


</div>  

    </div>
    <div class="col-md-9" id='text'>
    
    
      
      <h3>Files Dependent On This One</h3>
      
                <div class="depgraph"><?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.38.0 (20140413.2041)
 -->
<!-- Title: sourcefile~~stemmodule.f90~~AfferentGraph Pages: 1 -->
<svg id="sourcefilestemmodulef90AfferentGraph" width="207pt" height="32pt"
 viewBox="0.00 0.00 207.00 32.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="sourcefile~~stemmodule.f90~~AfferentGraph" class="graph" transform="scale(1 1) rotate(0) translate(4 28)">
<title>sourcefile~~stemmodule.f90~~AfferentGraph</title>
<polygon fill="white" stroke="none" points="-4,4 -4,-28 203,-28 203,4 -4,4"/>
<!-- sourcefile~stemmodule.f90 -->
<g id="sourcefile~~stemmodule.f90~~AfferentGraph_node1" class="node"><title>sourcefile~stemmodule.f90</title>
<polygon fill="none" stroke="black" points="94,-24 -7.10543e-15,-24 -7.10543e-15,-0 94,-0 94,-24"/>
<text text-anchor="middle" x="47" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50">STEMmodule.f90</text>
</g>
<!-- sourcefile~dispfield.f90 -->
<g id="sourcefile~~stemmodule.f90~~AfferentGraph_node2" class="node"><title>sourcefile~dispfield.f90</title>
<g id="a_sourcefile~~stemmodule.f90~~AfferentGraph_node2"><a xlink:href="../sourcefile/dispfield.f90.html" xlink:title="dispfield.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="199,-24 130,-24 130,-0 199,-0 199,-24"/>
<text text-anchor="middle" x="164.5" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">dispfield.f90</text>
</a>
</g>
</g>
<!-- sourcefile~stemmodule.f90&#45;&gt;sourcefile~dispfield.f90 -->
<g id="sourcefile~~stemmodule.f90~~AfferentGraph_edge1" class="edge"><title>sourcefile~stemmodule.f90&#45;&gt;sourcefile~dispfield.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M94.3128,-12C102.697,-12 111.416,-12 119.725,-12"/>
<polygon fill="#ff0000" stroke="#ff0000" points="119.974,-15.5001 129.974,-12 119.974,-8.5001 119.974,-15.5001"/>
</g>
</g>
</svg>
</div>
                <div><a type="button" class="graph-help" data-toggle="modal" href="#graph-help-text">Help</a></div>
                <div class="modal fade" id="graph-help-text" tabindex="-1" role="dialog">
                  <div class="modal-dialog modal-lg" role="document">
                    <div class="modal-content">
                      <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                        <h4 class="modal-title" id="-graph-help-label">Graph Key</h4>
                      </div>
                      <div class="modal-body">
                        
    <p>Nodes of different colours represent the following: </p>
    <?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.38.0 (20140413.2041)
 -->
<!-- Title: Graph Key Pages: 1 -->
<svg width="188pt" height="32pt"
 viewBox="0.00 0.00 188.00 32.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 28)">
<title>Graph Key</title>
<polygon fill="white" stroke="none" points="-4,4 -4,-28 184,-28 184,4 -4,4"/>
<!-- Source File -->
<g id="node1" class="node"><title>Source File</title>
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="66,-24 0,-24 0,-0 66,-0 66,-24"/>
<text text-anchor="middle" x="33" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Source File</text>
</g>
<!-- This Page&#39;s Entity -->
<g id="node2" class="node"><title>This Page&#39;s Entity</title>
<polygon fill="none" stroke="black" points="180,-24 84,-24 84,-0 180,-0 180,-24"/>
<text text-anchor="middle" x="132" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50">This Page&#39;s Entity</text>
</g>
</g>
</svg>

    
    <p>Solid arrows point from a file to a file which depends upon it. A file 
    is dependent upon another if the latter must be compiled before the former
    can be. Where possible, edges connecting nodes are given different colours to make them easier to distinguish in large graphs.
    </p>
    
                      </div>
                    </div>
                  </div>
                </div>
                
      
      <br>

    <section class="visible-xs visible-sm hidden-md">
      






<div class="panel panel-primary">
  <div class="panel-heading text-left"><h3 class="panel-title"><a data-toggle="collapse" href="#mods-1">Modules</a></h3></div>
  <div id="mods-1" class="panel-collapse collapse">
    <div class="list-group">
      
      <a class="list-group-item" href="../module/stemmodule.html">STEMmodule</a>
      
    </div>
  </div>
</div>















<div class="panel panel-primary">
  <div class="panel-heading text-left"><h3 class="panel-title">Source Code</h3></div>
  <div class="list-group">
    <a class="list-group-item" href="../sourcefile/stemmodule.f90.html#src">STEMmodule.f90</a>
  </div>
</div>


    </section>
    <br class="visible-xs visible-sm hidden-md">

    <section>
      <h2><span class="anchor" id="src"></span>Source Code</h2>
    <div class="hl"><pre><span></span><a name="ln-1"></a><span class="c">! ###################################################################</span>
<a name="ln-2"></a><span class="c">! Copyright (c) 2013-2014, Marc De Graef/Carnegie Mellon University</span>
<a name="ln-3"></a><span class="c">! All rights reserved.</span>
<a name="ln-4"></a><span class="c">!</span>
<a name="ln-5"></a><span class="c">! Redistribution and use in source and binary forms, with or without modification, are </span>
<a name="ln-6"></a><span class="c">! permitted provided that the following conditions are met:</span>
<a name="ln-7"></a><span class="c">!</span>
<a name="ln-8"></a><span class="c">!     - Redistributions of source code must retain the above copyright notice, this list </span>
<a name="ln-9"></a><span class="c">!        of conditions and the following disclaimer.</span>
<a name="ln-10"></a><span class="c">!     - Redistributions in binary form must reproduce the above copyright notice, this </span>
<a name="ln-11"></a><span class="c">!        list of conditions and the following disclaimer in the documentation and/or </span>
<a name="ln-12"></a><span class="c">!        other materials provided with the distribution.</span>
<a name="ln-13"></a><span class="c">!     - Neither the names of Marc De Graef, Carnegie Mellon University nor the names </span>
<a name="ln-14"></a><span class="c">!        of its contributors may be used to endorse or promote products derived from </span>
<a name="ln-15"></a><span class="c">!        this software without specific prior written permission.</span>
<a name="ln-16"></a><span class="c">!</span>
<a name="ln-17"></a><span class="c">! THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &quot;AS IS&quot; </span>
<a name="ln-18"></a><span class="c">! AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE </span>
<a name="ln-19"></a><span class="c">! IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE </span>
<a name="ln-20"></a><span class="c">! ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE </span>
<a name="ln-21"></a><span class="c">! LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL </span>
<a name="ln-22"></a><span class="c">! DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR </span>
<a name="ln-23"></a><span class="c">! SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER </span>
<a name="ln-24"></a><span class="c">! CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, </span>
<a name="ln-25"></a><span class="c">! OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE </span>
<a name="ln-26"></a><span class="c">! USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span>
<a name="ln-27"></a><span class="c">! ###################################################################</span>
<a name="ln-28"></a>
<a name="ln-29"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-30"></a><span class="c">! EMsoft:STEMmodule.f90</span>
<a name="ln-31"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-32"></a><span class="c">!</span>
<a name="ln-33"></a><span class="c">! MODULE: STEMmodule</span>
<a name="ln-34"></a><span class="c">!</span>
<a name="ln-35"></a><span class="c">!&gt; @author Marc De Graef, Carnegie Mellon University</span>
<a name="ln-36"></a><span class="c">!</span>
<a name="ln-37"></a><span class="c">!&gt; @brief Provides routines to handle the STEM detector geometry and weightfactors.</span>
<a name="ln-38"></a><span class="c">! </span>
<a name="ln-39"></a><span class="c">!&gt; @date   04/29/11 MDG 1.0 original</span>
<a name="ln-40"></a><span class="c">!&gt; @date   06/12/13 MDG 2.0 rewrite </span>
<a name="ln-41"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-42"></a><span class="k">module </span><span class="n">STEMmodule</span>
<a name="ln-43"></a>
<a name="ln-44"></a><span class="k">use </span><span class="n">local</span>
<a name="ln-45"></a><span class="k">use </span><span class="n">typedefs</span>
<a name="ln-46"></a>
<a name="ln-47"></a><span class="k">contains</span>
<a name="ln-48"></a>
<a name="ln-49"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-50"></a><span class="c">!</span>
<a name="ln-51"></a><span class="c">! SUBROUTINE: init_STEM</span>
<a name="ln-52"></a><span class="c">!</span>
<a name="ln-53"></a><span class="c">!&gt; @author Marc De Graef, Carnegie Mellon University</span>
<a name="ln-54"></a><span class="c">!</span>
<a name="ln-55"></a><span class="c">!&gt; @brief initialize the weight factors for the systematic row case.</span>
<a name="ln-56"></a><span class="c">!</span>
<a name="ln-57"></a><span class="c">!&gt; @param STEM STEM structure</span>
<a name="ln-58"></a><span class="c">!&gt; @param cell unit cell pointer</span>
<a name="ln-59"></a><span class="c">!&gt; @param nn number of beams</span>
<a name="ln-60"></a><span class="c">!&gt; @param g systematic row basic vector</span>
<a name="ln-61"></a><span class="c">! </span>
<a name="ln-62"></a><span class="c">!&gt; @date   04/29/11 MDG 1.0 original</span>
<a name="ln-63"></a><span class="c">!&gt; @date   06/12/13 MDG 2.0 rewrite </span>
<a name="ln-64"></a><span class="c">!&gt; @date   06/09/14 MDG 3.0 added STEM and cell arguments</span>
<a name="ln-65"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-66"></a><span class="k">recursive subroutine </span><span class="n">init_STEM</span><span class="p">(</span><span class="n">STEM</span><span class="p">,</span><span class="n">cell</span><span class="p">,</span><span class="n">nn</span><span class="p">,</span><span class="n">g</span><span class="p">)</span>
<a name="ln-67"></a><span class="c">!DEC$ ATTRIBUTES DLLEXPORT :: init_STEM</span>
<a name="ln-68"></a>
<a name="ln-69"></a><span class="k">use </span><span class="n">io</span>
<a name="ln-70"></a><span class="k">use </span><span class="n">crystal</span>
<a name="ln-71"></a><span class="k">use </span><span class="n">diffraction</span>
<a name="ln-72"></a>
<a name="ln-73"></a><span class="k">IMPLICIT NONE</span>
<a name="ln-74"></a>
<a name="ln-75"></a><span class="k">type</span><span class="p">(</span><span class="n">STEMtype</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">INOUT</span><span class="p">)</span>          <span class="kd">::</span> <span class="n">STEM</span>
<a name="ln-76"></a><span class="k">type</span><span class="p">(</span><span class="n">unitcell</span><span class="p">),</span><span class="k">pointer</span>                  <span class="kd">::</span> <span class="n">cell</span>
<a name="ln-77"></a><span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">irg</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>            <span class="kd">::</span> <span class="n">nn</span>
<a name="ln-78"></a><span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">irg</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>            <span class="kd">::</span> <span class="n">g</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-79"></a>
<a name="ln-80"></a><span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">irg</span><span class="p">)</span>                       <span class="kd">::</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="n">ira</span><span class="p">,</span><span class="n">jj</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">kk</span><span class="p">,</span> <span class="n">iCL</span>
<a name="ln-81"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">)</span>                          <span class="kd">::</span> <span class="n">glen</span><span class="p">,</span> <span class="n">thb</span><span class="p">,</span> <span class="n">alp</span><span class="p">,</span> <span class="n">omega_c</span><span class="p">,</span> <span class="n">omega_min</span><span class="p">,</span> <span class="n">omega_max</span><span class="p">,</span><span class="n">omega</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">th</span><span class="p">,</span><span class="n">dom</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">q</span><span class="p">,</span><span class="n">dr</span><span class="p">,</span><span class="n">dx</span>
<a name="ln-82"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">),</span><span class="k">parameter</span>                <span class="kd">::</span> <span class="n">cPi</span><span class="o">=</span><span class="mf">3.141592654</span>
<a name="ln-83"></a>
<a name="ln-84"></a><span class="c">! these are only used to debug this routine</span>
<a name="ln-85"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">),</span><span class="k">allocatable</span>              <span class="kd">::</span> <span class="n">thetar</span><span class="p">(:),</span><span class="n">outar</span><span class="p">(:,:,:)</span>
<a name="ln-86"></a><span class="kt">logical</span>                                 <span class="kd">::</span> <span class="n">debug</span> <span class="o">=</span> <span class="p">.</span><span class="n">FALSE</span><span class="p">.,</span> <span class="n">diffappresent</span> <span class="o">=</span> <span class="p">.</span><span class="n">FALSE</span><span class="p">.,</span> <span class="n">apinBF</span><span class="o">=</span><span class="p">.</span><span class="n">FALSE</span><span class="p">.</span> <span class="p">,</span> <span class="n">apinADF</span> <span class="o">=</span> <span class="p">.</span><span class="n">FALSE</span><span class="p">.</span>
<a name="ln-87"></a>
<a name="ln-88"></a><span class="c">! this routine initializes the excitation error arrays and the weight-factor arrays for systematic row STEM signals</span>
<a name="ln-89"></a><span class="c">! we&#39;ll assume that the central beam is centered on the BF detector; then we can </span>
<a name="ln-90"></a><span class="c">! compute the complete geometry by working in mrad units throughout.</span>
<a name="ln-91"></a>
<a name="ln-92"></a><span class="c">! allocate the excitation error array areal(1..nn,1..STEM%numberofsvalues)</span>
<a name="ln-93"></a>  <span class="k">allocate</span><span class="p">(</span><span class="n">STEM</span><span class="p">%</span><span class="n">sgarray</span><span class="p">(</span><span class="n">nn</span><span class="p">,</span><span class="n">STEM</span><span class="p">%</span><span class="n">numberofsvalues</span><span class="p">))</span>
<a name="ln-94"></a>
<a name="ln-95"></a><span class="c">! determine the lower and upper bounds of the excitation error for the fundamental reflection G</span>
<a name="ln-96"></a>  <span class="n">thb</span> <span class="o">=</span> <span class="n">CalcDiffAngle</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span><span class="n">g</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="n">g</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span><span class="n">g</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span><span class="o">*</span><span class="mf">0.5</span>  <span class="c">! Bragg angle in radians</span>
<a name="ln-97"></a>
<a name="ln-98"></a><span class="c">! convert k_t to the alp and omega angles (in radians)</span>
<a name="ln-99"></a>  <span class="n">glen</span> <span class="o">=</span> <span class="n">CalcLength</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span><span class="nb">float</span><span class="p">(</span><span class="n">g</span><span class="p">),</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
<a name="ln-100"></a>  <span class="n">alp</span> <span class="o">=</span> <span class="o">-</span><span class="mf">2.0</span><span class="o">*</span><span class="n">STEM</span><span class="p">%</span><span class="n">kt</span><span class="o">*</span><span class="n">thb</span>
<a name="ln-101"></a>  <span class="n">omega_c</span> <span class="o">=</span> <span class="n">cPi</span><span class="o">*</span><span class="mf">0.5</span><span class="o">+</span><span class="n">alp</span>
<a name="ln-102"></a>  <span class="n">omega_min</span> <span class="o">=</span> <span class="n">omega_c</span> <span class="o">-</span> <span class="n">STEM</span><span class="p">%</span><span class="n">beamconvergence</span><span class="o">/</span><span class="mi">100</span><span class="mf">0.0</span>
<a name="ln-103"></a>  <span class="n">omega_max</span> <span class="o">=</span> <span class="n">omega_c</span> <span class="o">+</span> <span class="n">STEM</span><span class="p">%</span><span class="n">beamconvergence</span><span class="o">/</span><span class="mi">100</span><span class="mf">0.0</span>
<a name="ln-104"></a>
<a name="ln-105"></a><span class="c">! step size</span>
<a name="ln-106"></a>  <span class="n">dom</span> <span class="o">=</span> <span class="p">(</span><span class="n">omega_max</span> <span class="o">-</span> <span class="n">omega_min</span><span class="p">)</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">STEM</span><span class="p">%</span><span class="n">numberofsvalues</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-107"></a>
<a name="ln-108"></a><span class="c">! and for each value in between, compute each reflection&#39;s excitation error</span>
<a name="ln-109"></a><span class="n">ira</span> <span class="o">=</span> <span class="p">(</span><span class="n">nn</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
<a name="ln-110"></a>
<a name="ln-111"></a><span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">STEM</span><span class="p">%</span><span class="n">numberofsvalues</span>
<a name="ln-112"></a><span class="c">! set omega angle</span>
<a name="ln-113"></a>   <span class="n">omega</span> <span class="o">=</span> <span class="n">omega_min</span><span class="o">+</span><span class="nb">float</span><span class="p">(</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">dom</span>
<a name="ln-114"></a>   <span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">nn</span>
<a name="ln-115"></a>    <span class="n">n</span> <span class="o">=</span> <span class="o">-</span><span class="n">ira</span><span class="o">+</span><span class="n">i</span>
<a name="ln-116"></a><span class="c">! excitation error</span>
<a name="ln-117"></a>    <span class="n">STEM</span><span class="p">%</span><span class="n">sgarray</span><span class="p">(</span><span class="n">nn</span><span class="o">+</span><span class="mi">1</span><span class="o">-</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="n">n</span><span class="o">*</span><span class="n">glen</span><span class="o">*</span><span class="nb">cos</span><span class="p">(</span><span class="n">omega</span><span class="p">)</span><span class="o">-</span><span class="p">(</span><span class="mf">1.0</span><span class="o">-</span><span class="nb">sqrt</span><span class="p">(</span><span class="mf">1.0</span><span class="o">-</span><span class="p">(</span><span class="n">n</span><span class="o">*</span><span class="n">cell</span><span class="p">%</span><span class="n">mLambda</span><span class="o">*</span><span class="n">glen</span><span class="o">*</span><span class="nb">sin</span><span class="p">(</span><span class="n">omega</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span><span class="o">/</span><span class="n">cell</span><span class="p">%</span><span class="n">mLambda</span>
<a name="ln-118"></a>   <span class="k">end do</span>
<a name="ln-119"></a><span class="k">end do</span>
<a name="ln-120"></a>
<a name="ln-121"></a><span class="k">if</span> <span class="p">(</span><span class="n">debug</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-122"></a><span class="k">  allocate</span><span class="p">(</span><span class="n">thetar</span><span class="p">(</span><span class="mi">25</span><span class="p">))</span>
<a name="ln-123"></a>  <span class="n">thetar</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-124"></a>  <span class="n">thetar</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="o">/</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">th</span><span class="p">,</span><span class="n">dom</span><span class="p">,</span><span class="n">dr</span><span class="p">,</span><span class="n">dx</span> <span class="o">/</span><span class="p">)</span>
<a name="ln-125"></a><span class="k">end if</span> 
<a name="ln-126"></a>
<a name="ln-127"></a><span class="c">! next, we compute the weightfactors, i.e., how much does each excitation error value contribute</span>
<a name="ln-128"></a><span class="c">! to the BF or ADF signal?  The weight factor is basically the length of the chord across the overlap</span>
<a name="ln-129"></a><span class="c">! area of the diffraction disk and the detector, which requires a little bit of math to figure out;</span>
<a name="ln-130"></a><span class="c">! the math employs the concept of the radical line (see mathworld.com section on circle-circle intersections)</span>
<a name="ln-131"></a>
<a name="ln-132"></a><span class="c">! this computation is carried out in mrad units !</span>
<a name="ln-133"></a><span class="k">allocate</span><span class="p">(</span><span class="n">STEM</span><span class="p">%</span><span class="n">BFweightsarray</span><span class="p">(</span><span class="n">nn</span><span class="p">,</span><span class="n">STEM</span><span class="p">%</span><span class="n">numberofsvalues</span><span class="p">,</span><span class="n">STEM</span><span class="p">%</span><span class="n">numCL</span><span class="p">),</span><span class="n">STEM</span><span class="p">%</span><span class="n">ADFweightsarray</span><span class="p">(</span><span class="n">nn</span><span class="p">,</span><span class="n">STEM</span><span class="p">%</span><span class="n">numberofsvalues</span><span class="p">,</span><span class="n">STEM</span><span class="p">%</span><span class="n">numCL</span><span class="p">))</span>
<a name="ln-134"></a>
<a name="ln-135"></a><span class="n">STEM</span><span class="p">%</span><span class="n">BFweightsarray</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-136"></a><span class="n">STEM</span><span class="p">%</span><span class="n">ADFweightsarray</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-137"></a>
<a name="ln-138"></a>
<a name="ln-139"></a><span class="n">outerCLloop</span><span class="p">:</span> <span class="k">do </span><span class="n">iCL</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">STEM</span><span class="p">%</span><span class="n">numCL</span>    <span class="c">! this is the outer loop over the microscope camera lengths (very long loop !!!)</span>
<a name="ln-140"></a>
<a name="ln-141"></a><span class="c">! fist, convert the detector parameters to mrad units</span>
<a name="ln-142"></a><span class="n">STEM</span><span class="p">%</span><span class="n">BFmrad</span> <span class="o">=</span> <span class="nb">atan</span><span class="p">(</span><span class="n">STEM</span><span class="p">%</span><span class="n">BFradius</span><span class="o">/</span><span class="n">STEM</span><span class="p">%</span><span class="n">CLarray</span><span class="p">(</span><span class="n">iCL</span><span class="p">))</span><span class="o">*</span><span class="mi">100</span><span class="mf">0.0</span>
<a name="ln-143"></a><span class="n">STEM</span><span class="p">%</span><span class="n">ADFimrad</span> <span class="o">=</span> <span class="nb">atan</span><span class="p">(</span><span class="n">STEM</span><span class="p">%</span><span class="n">ADFinnerradius</span><span class="o">/</span><span class="n">STEM</span><span class="p">%</span><span class="n">CLarray</span><span class="p">(</span><span class="n">iCL</span><span class="p">))</span><span class="o">*</span><span class="mi">100</span><span class="mf">0.0</span>
<a name="ln-144"></a><span class="n">STEM</span><span class="p">%</span><span class="n">ADFomrad</span> <span class="o">=</span> <span class="nb">atan</span><span class="p">(</span><span class="n">STEM</span><span class="p">%</span><span class="n">ADFouterradius</span><span class="o">/</span><span class="n">STEM</span><span class="p">%</span><span class="n">CLarray</span><span class="p">(</span><span class="n">iCL</span><span class="p">))</span><span class="o">*</span><span class="mi">100</span><span class="mf">0.0</span>
<a name="ln-145"></a><span class="k">if</span> <span class="p">(</span><span class="n">STEM</span><span class="p">%</span><span class="n">diffapmrad</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="mf">0.0</span><span class="p">)</span> <span class="n">diffappresent</span> <span class="o">=</span> <span class="p">.</span><span class="n">TRUE</span><span class="p">.</span>
<a name="ln-146"></a>
<a name="ln-147"></a><span class="c">! then, for each point inside each diffraction disk, determine where it falls with respect to</span>
<a name="ln-148"></a><span class="c">! the BD and ADF detectors ... Also, look for disk overlaps as they might require amplitudes</span>
<a name="ln-149"></a><span class="c">! to be added in instead of intensities (for starters, we could just not allow that to happen...)</span>
<a name="ln-150"></a>
<a name="ln-151"></a><span class="c">! rename some variables to short symbols</span>
<a name="ln-152"></a><span class="n">a</span> <span class="o">=</span> <span class="n">STEM</span><span class="p">%</span><span class="n">ADFimrad</span>
<a name="ln-153"></a><span class="n">b</span> <span class="o">=</span> <span class="n">STEM</span><span class="p">%</span><span class="n">ADFomrad</span>
<a name="ln-154"></a><span class="n">c</span> <span class="o">=</span> <span class="n">STEM</span><span class="p">%</span><span class="n">BFmrad</span>
<a name="ln-155"></a><span class="n">th</span> <span class="o">=</span> <span class="n">STEM</span><span class="p">%</span><span class="n">beamconvergence</span>
<a name="ln-156"></a><span class="n">n</span> <span class="o">=</span> <span class="n">STEM</span><span class="p">%</span><span class="n">numberofsvalues</span>
<a name="ln-157"></a><span class="k">if</span> <span class="p">(</span><span class="n">diffappresent</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-158"></a><span class="k">  </span><span class="n">dr</span> <span class="o">=</span> <span class="n">STEM</span><span class="p">%</span><span class="n">diffapmrad</span>
<a name="ln-159"></a>  <span class="n">dx</span> <span class="o">=</span> <span class="n">STEM</span><span class="p">%</span><span class="n">diffapmcenter</span>
<a name="ln-160"></a><span class="k">end if</span>
<a name="ln-161"></a><span class="n">omega_min</span> <span class="o">=</span>  <span class="o">-</span><span class="n">th</span>
<a name="ln-162"></a><span class="n">omega_max</span> <span class="o">=</span> <span class="n">th</span>
<a name="ln-163"></a><span class="n">dom</span> <span class="o">=</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">th</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-164"></a>
<a name="ln-165"></a><span class="k">if</span> <span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="n">diffappresent</span><span class="p">)</span> <span class="k">then</span>   <span class="c">! there is no diffraction aperture, so compute the regular weight factors</span>
<a name="ln-166"></a><span class="c">! first, do the math for the g=0 disk  (we&#39;re dropping common factors of 2 for the weights) </span>
<a name="ln-167"></a><span class="n">i</span> <span class="o">=</span> <span class="n">ira</span>
<a name="ln-168"></a><span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="p">(</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span><span class="n">n</span>
<a name="ln-169"></a>  <span class="n">omega</span> <span class="o">=</span> <span class="n">omega_min</span><span class="o">+</span><span class="nb">float</span><span class="p">(</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">dom</span>
<a name="ln-170"></a>  <span class="k">if</span> <span class="p">(</span><span class="n">th</span><span class="p">.</span><span class="n">gt</span><span class="p">.</span><span class="n">c</span><span class="p">)</span> <span class="k">then</span>       <span class="c">! the zero disk is larger than the BF detector, so it (potentially) gives two signals</span>
<a name="ln-171"></a>    <span class="k">if</span> <span class="p">(</span><span class="n">omega</span><span class="p">.</span><span class="n">le</span><span class="p">.</span><span class="n">c</span><span class="p">)</span> <span class="n">STEM</span><span class="p">%</span><span class="n">BFweightsarray</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">iCL</span><span class="p">)</span> <span class="o">=</span> <span class="nb">sqrt</span><span class="p">(</span><span class="n">c</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="n">omega</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
<a name="ln-172"></a>    <span class="k">if</span> <span class="p">(</span><span class="n">th</span><span class="p">.</span><span class="n">ge</span><span class="p">.</span><span class="n">a</span><span class="p">)</span> <span class="k">then</span>    <span class="c">! there&#39;s overlap with the ADF detector</span>
<a name="ln-173"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">omega</span><span class="p">.</span><span class="n">le</span><span class="p">.</span><span class="n">a</span><span class="p">)</span> <span class="k">then</span>  <span class="c">! the first part needs to have a bit subtracted</span>
<a name="ln-174"></a>        <span class="n">STEM</span><span class="p">%</span><span class="n">ADFweightsarray</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">iCL</span><span class="p">)</span> <span class="o">=</span> <span class="nb">sqrt</span><span class="p">((</span><span class="n">th</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="n">omega</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span> <span class="o">-</span> <span class="nb">sqrt</span><span class="p">((</span><span class="n">a</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="n">omega</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
<a name="ln-175"></a>      <span class="k">else</span>   <span class="c">! the second part does not</span>
<a name="ln-176"></a>        <span class="n">STEM</span><span class="p">%</span><span class="n">ADFweightsarray</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">iCL</span><span class="p">)</span> <span class="o">=</span> <span class="nb">sqrt</span><span class="p">((</span><span class="n">th</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="n">omega</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span> 
<a name="ln-177"></a>      <span class="k">end if</span>
<a name="ln-178"></a><span class="k">    end if</span>
<a name="ln-179"></a><span class="k">  else</span>                         <span class="c">! the zero disk is smaller than the BF detector, so only a BF signal</span>
<a name="ln-180"></a>   <span class="n">STEM</span><span class="p">%</span><span class="n">BFweightsarray</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">iCL</span><span class="p">)</span> <span class="o">=</span> <span class="nb">sqrt</span><span class="p">((</span><span class="n">th</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="n">omega</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
<a name="ln-181"></a>  <span class="k">end if</span>
<a name="ln-182"></a><span class="c">! then apply symmetry for the other half of the g=0 disk</span>
<a name="ln-183"></a>  <span class="k">if</span> <span class="p">(</span><span class="n">j</span><span class="p">.</span><span class="n">ne</span><span class="p">.(</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-184"></a><span class="k">    </span><span class="n">jj</span> <span class="o">=</span> <span class="n">n</span><span class="o">+</span><span class="mi">1</span> <span class="o">-</span> <span class="n">j</span>
<a name="ln-185"></a>    <span class="n">STEM</span><span class="p">%</span><span class="n">BFweightsarray</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">jj</span><span class="p">,</span><span class="n">iCL</span><span class="p">)</span> <span class="o">=</span> <span class="n">STEM</span><span class="p">%</span><span class="n">BFweightsarray</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">iCL</span><span class="p">)</span>
<a name="ln-186"></a>    <span class="n">STEM</span><span class="p">%</span><span class="n">ADFweightsarray</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">jj</span><span class="p">,</span><span class="n">iCL</span><span class="p">)</span> <span class="o">=</span> <span class="n">STEM</span><span class="p">%</span><span class="n">ADFweightsarray</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">iCL</span><span class="p">)</span>
<a name="ln-187"></a>  <span class="k">end if  </span>
<a name="ln-188"></a><span class="k">end do</span>  <span class="c">! that completes the central disk weight factors</span>
<a name="ln-189"></a>
<a name="ln-190"></a><span class="c">! the other disks are quite a bit more difficult to deal with ... there are a lot of possible cases to consider ...</span>
<a name="ln-191"></a><span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="n">ira</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">nn</span>      <span class="c">! loop over the positive reflections of the systematic row (the rest follows by symmetry)</span>
<a name="ln-192"></a><span class="c">! redefine a couple of parameters</span>
<a name="ln-193"></a>  <span class="n">j</span> <span class="o">=</span> <span class="n">i</span> <span class="o">-</span> <span class="n">ira</span>
<a name="ln-194"></a>  <span class="n">thb</span> <span class="o">=</span> <span class="n">CalcDiffAngle</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span><span class="n">j</span><span class="o">*</span><span class="n">g</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="n">j</span><span class="o">*</span><span class="n">g</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span><span class="n">j</span><span class="o">*</span><span class="n">g</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span><span class="o">*</span><span class="mi">100</span><span class="mf">0.0</span>  <span class="c">! diffraction angle in mrad</span>
<a name="ln-195"></a>  <span class="n">omega_min</span> <span class="o">=</span> <span class="n">thb</span> <span class="o">-</span> <span class="n">th</span>
<a name="ln-196"></a>  <span class="n">omega_max</span> <span class="o">=</span> <span class="n">thb</span> <span class="o">+</span> <span class="n">th</span>
<a name="ln-197"></a><span class="c">! only used for debugging</span>
<a name="ln-198"></a> <span class="k">if</span> <span class="p">(</span><span class="n">debug</span><span class="p">)</span>  <span class="n">thetar</span><span class="p">(</span><span class="mi">7</span><span class="o">+</span><span class="n">j</span><span class="p">)</span> <span class="o">=</span> <span class="n">thb</span>
<a name="ln-199"></a><span class="c">! first check if a part of this disk lies inside the BF detector</span>
<a name="ln-200"></a>  <span class="k">if</span> <span class="p">(</span><span class="n">omega_min</span><span class="p">.</span><span class="n">lt</span><span class="p">.</span><span class="n">c</span><span class="p">)</span> <span class="k">then</span>     <span class="c">! yes, it does, so determine the BF weight factors for this disk</span>
<a name="ln-201"></a>    <span class="k">if</span> <span class="p">(</span><span class="n">omega_max</span><span class="p">.</span><span class="n">le</span><span class="p">.</span><span class="n">c</span><span class="p">)</span> <span class="k">then</span>  <span class="c">! does it lie completely inside the BF detector?</span>
<a name="ln-202"></a>      <span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">n</span>   <span class="c">! yes it does, so compute all weight factors</span>
<a name="ln-203"></a>        <span class="n">omega</span> <span class="o">=</span> <span class="n">omega_min</span> <span class="o">+</span> <span class="nb">float</span><span class="p">(</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">dom</span>
<a name="ln-204"></a>        <span class="n">STEM</span><span class="p">%</span><span class="n">BFweightsarray</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">iCL</span><span class="p">)</span> <span class="o">=</span> <span class="nb">sqrt</span><span class="p">(</span><span class="n">th</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="p">(</span><span class="n">thb</span><span class="o">-</span><span class="n">omega</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
<a name="ln-205"></a>        <span class="n">STEM</span><span class="p">%</span><span class="n">BFweightsarray</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">ira</span><span class="o">-</span><span class="n">i</span><span class="p">,</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="o">-</span><span class="n">j</span><span class="p">,</span><span class="n">iCL</span><span class="p">)</span> <span class="o">=</span> <span class="n">STEM</span><span class="p">%</span><span class="n">BFweightsarray</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">iCL</span><span class="p">)</span>
<a name="ln-206"></a>      <span class="k">end do</span>
<a name="ln-207"></a><span class="k">    else</span>  <span class="c">! no, there&#39;s some potential overlap with the ADF detector </span>
<a name="ln-208"></a>      <span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">n</span>   <span class="c">! once again, there are a few cases</span>
<a name="ln-209"></a>        <span class="n">omega</span> <span class="o">=</span> <span class="n">omega_min</span> <span class="o">+</span> <span class="nb">float</span><span class="p">(</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">dom</span>    <span class="c">! this is the position</span>
<a name="ln-210"></a>        <span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">thb</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="n">th</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">a</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="mf">0.5</span><span class="o">/</span><span class="n">thb</span>             <span class="c">! this is the location of the radical line for the ADF detector</span>
<a name="ln-211"></a>        <span class="n">q</span> <span class="o">=</span> <span class="p">(</span><span class="n">thb</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="n">th</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">c</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="mf">0.5</span><span class="o">/</span><span class="n">thb</span>             <span class="c">! this is the location of the radical line for the BF detector</span>
<a name="ln-212"></a>        <span class="k">if</span> <span class="p">(</span><span class="n">omega</span><span class="p">.</span><span class="n">le</span><span class="p">.</span><span class="n">q</span><span class="p">)</span> <span class="k">then</span>   <span class="c">! this point contributes to the BF detector</span>
<a name="ln-213"></a>          <span class="n">STEM</span><span class="p">%</span><span class="n">BFweightsarray</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">iCL</span><span class="p">)</span> <span class="o">=</span> <span class="nb">sqrt</span><span class="p">(</span><span class="n">th</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="p">(</span><span class="n">thb</span><span class="o">-</span><span class="n">omega</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
<a name="ln-214"></a>        <span class="k">end if</span>
<a name="ln-215"></a><span class="k">        if</span> <span class="p">((</span><span class="n">omega</span><span class="p">.</span><span class="n">gt</span><span class="p">.</span><span class="n">q</span><span class="p">).</span><span class="nb">and</span><span class="p">.(</span><span class="n">omega</span><span class="p">.</span><span class="n">le</span><span class="p">.</span><span class="n">c</span><span class="p">))</span> <span class="k">then</span>   <span class="c">! this point contributes to the BF detector</span>
<a name="ln-216"></a>          <span class="n">STEM</span><span class="p">%</span><span class="n">BFweightsarray</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">iCL</span><span class="p">)</span> <span class="o">=</span> <span class="nb">sqrt</span><span class="p">(</span><span class="n">c</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">omega</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
<a name="ln-217"></a>        <span class="k">end if</span>
<a name="ln-218"></a><span class="k">        if</span> <span class="p">((</span><span class="n">omega_max</span><span class="p">.</span><span class="n">ge</span><span class="p">.</span><span class="n">a</span><span class="p">).</span><span class="nb">and</span><span class="p">.(</span><span class="n">omega</span><span class="p">.</span><span class="n">ge</span><span class="p">.</span><span class="n">p</span><span class="p">).</span><span class="nb">and</span><span class="p">.(</span><span class="n">omega</span><span class="p">.</span><span class="n">le</span><span class="p">.</span><span class="n">a</span><span class="p">))</span> <span class="k">then</span> <span class="c">! this point contributes to the ADF detector (using radical line position)</span>
<a name="ln-219"></a>          <span class="n">STEM</span><span class="p">%</span><span class="n">ADFweightsarray</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">iCL</span><span class="p">)</span> <span class="o">=</span> <span class="nb">sqrt</span><span class="p">(</span><span class="n">th</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span>  <span class="p">(</span><span class="n">thb</span><span class="o">-</span><span class="n">omega</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>  <span class="o">-</span> <span class="nb">sqrt</span><span class="p">(</span><span class="n">a</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">omega</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
<a name="ln-220"></a>        <span class="k">end if</span>
<a name="ln-221"></a><span class="k">         if</span> <span class="p">((</span><span class="n">omega_max</span><span class="p">.</span><span class="n">ge</span><span class="p">.</span><span class="n">a</span><span class="p">).</span><span class="nb">and</span><span class="p">.(</span><span class="n">omega</span><span class="p">.</span><span class="n">gt</span><span class="p">.</span><span class="n">a</span><span class="p">))</span> <span class="k">then</span> <span class="c">! this point lies on the ADF detector </span>
<a name="ln-222"></a>          <span class="n">STEM</span><span class="p">%</span><span class="n">ADFweightsarray</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">iCL</span><span class="p">)</span> <span class="o">=</span> <span class="nb">sqrt</span><span class="p">(</span><span class="n">th</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span>  <span class="p">(</span><span class="n">thb</span><span class="o">-</span><span class="n">omega</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
<a name="ln-223"></a>        <span class="k">end if</span>
<a name="ln-224"></a><span class="k">       </span><span class="n">STEM</span><span class="p">%</span><span class="n">BFweightsarray</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">ira</span><span class="o">-</span><span class="n">i</span><span class="p">,</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="o">-</span><span class="n">j</span><span class="p">,</span><span class="n">iCL</span><span class="p">)</span> <span class="o">=</span> <span class="n">STEM</span><span class="p">%</span><span class="n">BFweightsarray</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">iCL</span><span class="p">)</span>       
<a name="ln-225"></a>       <span class="n">STEM</span><span class="p">%</span><span class="n">ADFweightsarray</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">ira</span><span class="o">-</span><span class="n">i</span><span class="p">,</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="o">-</span><span class="n">j</span><span class="p">,</span><span class="n">iCL</span><span class="p">)</span> <span class="o">=</span> <span class="n">STEM</span><span class="p">%</span><span class="n">ADFweightsarray</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">iCL</span><span class="p">)</span>
<a name="ln-226"></a>      <span class="k">end do</span>
<a name="ln-227"></a><span class="k">    end if </span>
<a name="ln-228"></a><span class="k">  else</span>    <span class="c">! no, it does not intersect the BF detector, so this disk can only contribute to the ADF weight factors</span>
<a name="ln-229"></a><span class="c">! once more there are several cases which we&#39;ll treat in increasing value of the position...</span>
<a name="ln-230"></a>      <span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">n</span> 
<a name="ln-231"></a>        <span class="n">omega</span> <span class="o">=</span> <span class="n">omega_min</span> <span class="o">+</span> <span class="nb">float</span><span class="p">(</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">dom</span>    <span class="c">! this is the position</span>
<a name="ln-232"></a>        <span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">thb</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="n">th</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">a</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="mf">0.5</span><span class="o">/</span><span class="n">thb</span>             <span class="c">! this is the location of the radical line for the inner ADF detector edge</span>
<a name="ln-233"></a>        <span class="n">q</span> <span class="o">=</span> <span class="p">(</span><span class="n">thb</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="n">th</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">b</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="mf">0.5</span><span class="o">/</span><span class="n">thb</span>             <span class="c">! this is the location of the radical line for the outer ADF detector edge</span>
<a name="ln-234"></a>        <span class="k">if</span> <span class="p">((</span><span class="n">omega</span><span class="p">.</span><span class="n">lt</span><span class="p">.</span><span class="n">a</span><span class="p">).</span><span class="nb">and</span><span class="p">.(</span><span class="n">omega</span><span class="p">.</span><span class="n">ge</span><span class="p">.</span><span class="n">p</span><span class="p">))</span>  <span class="k">then</span>    <span class="c">! inside the inner ADF edge, but close enough to contribute</span>
<a name="ln-235"></a>          <span class="n">STEM</span><span class="p">%</span><span class="n">ADFweightsarray</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">iCL</span><span class="p">)</span> <span class="o">=</span> <span class="nb">sqrt</span><span class="p">(</span><span class="n">th</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span>  <span class="p">(</span><span class="n">thb</span><span class="o">-</span><span class="n">omega</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>  <span class="o">-</span> <span class="nb">sqrt</span><span class="p">(</span><span class="n">a</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">omega</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
<a name="ln-236"></a>        <span class="k">end if</span>
<a name="ln-237"></a><span class="k">         if</span> <span class="p">((</span><span class="n">omega</span><span class="p">.</span><span class="n">ge</span><span class="p">.</span><span class="n">a</span><span class="p">).</span><span class="nb">and</span><span class="p">.(</span><span class="n">omega_max</span><span class="p">.</span><span class="n">le</span><span class="p">.</span><span class="n">b</span><span class="p">))</span> <span class="k">then</span> <span class="c">! this point lies on the ADF detector </span>
<a name="ln-238"></a>          <span class="n">STEM</span><span class="p">%</span><span class="n">ADFweightsarray</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">iCL</span><span class="p">)</span> <span class="o">=</span> <span class="nb">sqrt</span><span class="p">(</span><span class="n">th</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span>  <span class="p">(</span><span class="n">thb</span><span class="o">-</span><span class="n">omega</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
<a name="ln-239"></a>        <span class="k">end if</span>
<a name="ln-240"></a><span class="k">        if</span> <span class="p">((</span><span class="n">omega_max</span><span class="p">.</span><span class="n">gt</span><span class="p">.</span><span class="n">b</span><span class="p">).</span><span class="nb">and</span><span class="p">.(</span><span class="n">omega</span><span class="p">.</span><span class="n">le</span><span class="p">.</span><span class="n">q</span><span class="p">))</span> <span class="k">then</span>   <span class="c">! this point lies on the ADF detector</span>
<a name="ln-241"></a>          <span class="n">STEM</span><span class="p">%</span><span class="n">ADFweightsarray</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">iCL</span><span class="p">)</span> <span class="o">=</span> <span class="nb">sqrt</span><span class="p">(</span><span class="n">th</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="p">(</span><span class="n">thb</span><span class="o">-</span><span class="n">omega</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
<a name="ln-242"></a>        <span class="k">end if</span>
<a name="ln-243"></a><span class="k">        if</span> <span class="p">((</span><span class="n">omega_max</span><span class="p">.</span><span class="n">gt</span><span class="p">.</span><span class="n">b</span><span class="p">).</span><span class="nb">and</span><span class="p">.(</span><span class="n">omega</span><span class="p">.</span><span class="n">gt</span><span class="p">.</span><span class="n">q</span><span class="p">).</span><span class="nb">and</span><span class="p">.(</span><span class="n">omega</span><span class="p">.</span><span class="n">le</span><span class="p">.</span><span class="n">b</span><span class="p">))</span>  <span class="k">then</span>   <span class="c">! this point contributes to the ADF detector</span>
<a name="ln-244"></a>          <span class="n">STEM</span><span class="p">%</span><span class="n">ADFweightsarray</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">iCL</span><span class="p">)</span> <span class="o">=</span> <span class="nb">sqrt</span><span class="p">(</span><span class="n">b</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">omega</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
<a name="ln-245"></a>        <span class="k">end if</span>
<a name="ln-246"></a><span class="k">        </span><span class="n">STEM</span><span class="p">%</span><span class="n">ADFweightsarray</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">ira</span><span class="o">-</span><span class="n">i</span><span class="p">,</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="o">-</span><span class="n">j</span><span class="p">,</span><span class="n">iCL</span><span class="p">)</span> <span class="o">=</span> <span class="n">STEM</span><span class="p">%</span><span class="n">ADFweightsarray</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">iCL</span><span class="p">)</span>
<a name="ln-247"></a>      <span class="k">end do</span>
<a name="ln-248"></a><span class="k">  end if</span>
<a name="ln-249"></a>
<a name="ln-250"></a><span class="k">end do</span>
<a name="ln-251"></a><span class="k">end if</span> <span class="c">! end of regular weight factors without a diffraction aperture</span>
<a name="ln-252"></a>
<a name="ln-253"></a>
<a name="ln-254"></a>
<a name="ln-255"></a><span class="k">if</span> <span class="p">(</span><span class="n">diffappresent</span><span class="p">)</span> <span class="k">then</span>   <span class="c">! there is a diffraction aperture, so revisit the weight factors.</span>
<a name="ln-256"></a><span class="c">! once again, there are many different cases that need to be addressed...</span>
<a name="ln-257"></a>  
<a name="ln-258"></a><span class="c">! we do not allow for a diffraction aperture that overlaps the boundary between BF and ADF detectors,</span>
<a name="ln-259"></a><span class="c">! nor an aperture that lies entirely beyond the ADF detector</span>
<a name="ln-260"></a><span class="c">! first the BF test</span>
<a name="ln-261"></a>  <span class="k">if</span> <span class="p">(</span> <span class="p">((</span><span class="n">dx</span><span class="o">-</span><span class="n">dr</span><span class="p">).</span><span class="n">gt</span><span class="p">.</span><span class="o">-</span><span class="n">c</span><span class="p">).</span><span class="nb">and</span><span class="p">.((</span><span class="n">dx</span><span class="o">+</span><span class="n">dr</span><span class="p">).</span><span class="n">lt</span><span class="p">.</span><span class="n">c</span><span class="p">))</span>  <span class="n">apinBF</span> <span class="o">=</span> <span class="p">.</span><span class="n">TRUE</span><span class="p">.</span>
<a name="ln-262"></a>
<a name="ln-263"></a><span class="c">! then the ADF detector</span>
<a name="ln-264"></a>  <span class="k">if</span> <span class="p">(</span> <span class="p">(((</span><span class="n">dx</span><span class="o">-</span><span class="n">dr</span><span class="p">).</span><span class="n">gt</span><span class="p">.</span><span class="o">-</span><span class="n">b</span><span class="p">).</span><span class="nb">and</span><span class="p">.((</span><span class="n">dx</span><span class="o">+</span><span class="n">dr</span><span class="p">).</span><span class="n">lt</span><span class="p">.</span><span class="o">-</span><span class="n">c</span><span class="p">))</span> <span class="p">.</span><span class="nb">or</span><span class="p">.(((</span><span class="n">dx</span><span class="o">-</span><span class="n">dr</span><span class="p">).</span><span class="n">gt</span><span class="p">.</span><span class="n">a</span><span class="p">).</span><span class="nb">and</span><span class="p">.((</span><span class="n">dx</span><span class="o">+</span><span class="n">dr</span><span class="p">).</span><span class="n">lt</span><span class="p">.</span><span class="n">b</span><span class="p">))</span> <span class="p">)</span>  <span class="n">apinADF</span> <span class="o">=</span> <span class="p">.</span><span class="n">TRUE</span><span class="p">.</span> 
<a name="ln-265"></a>
<a name="ln-266"></a><span class="c">! if the aperture is outside the ADF detector, or it overlaps the space between the detectors, then abort</span>
<a name="ln-267"></a>  <span class="k">if</span> <span class="p">(</span> <span class="p">.</span><span class="nb">not</span><span class="p">.</span><span class="n">apinBF</span> <span class="p">.</span><span class="nb">and</span><span class="p">.</span> <span class="p">.</span><span class="nb">not</span><span class="p">.</span><span class="n">apinADF</span> <span class="p">)</span> <span class="k">then</span>
<a name="ln-268"></a><span class="k">    call </span><span class="n">Message</span><span class="p">(</span><span class="s1">&#39;Please fix input: Diffraction aperture outside BF detector disk or ADF ring !&#39;</span><span class="p">,</span> <span class="n">frm</span> <span class="o">=</span> <span class="s2">&quot;(A)&quot;</span><span class="p">)</span>
<a name="ln-269"></a>    <span class="k">stop</span>
<a name="ln-270"></a><span class="k">  end if</span>
<a name="ln-271"></a>
<a name="ln-272"></a>
<a name="ln-273"></a>
<a name="ln-274"></a><span class="k">if</span> <span class="p">(</span><span class="n">apinBF</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-275"></a><span class="c">! figure out which diffraction disk(s) contribute to the BF detector</span>
<a name="ln-276"></a> <span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">nn</span>      <span class="c">! loop over all reflections of the systematic row</span>
<a name="ln-277"></a><span class="c">! redefine a couple of parameters</span>
<a name="ln-278"></a>  <span class="n">j</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">nn</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="o">-</span><span class="mi">1</span><span class="o">+</span><span class="n">i</span>
<a name="ln-279"></a>  <span class="k">if</span> <span class="p">(</span><span class="n">j</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span> <span class="k">then </span>
<a name="ln-280"></a><span class="k">    </span><span class="n">thb</span> <span class="o">=</span> <span class="p">(</span><span class="n">j</span><span class="o">/</span><span class="nb">abs</span><span class="p">(</span><span class="n">j</span><span class="p">))</span> <span class="o">*</span> <span class="n">CalcDiffAngle</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span><span class="n">j</span><span class="o">*</span><span class="n">g</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="n">j</span><span class="o">*</span><span class="n">g</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span><span class="n">j</span><span class="o">*</span><span class="n">g</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span><span class="o">*</span><span class="mi">100</span><span class="mf">0.0</span>  <span class="c">! diffraction angle in mrad</span>
<a name="ln-281"></a>  <span class="k">else</span>
<a name="ln-282"></a><span class="k">    </span><span class="n">thb</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-283"></a>  <span class="k">end if</span>  
<a name="ln-284"></a> <span class="c">! only used for debugging</span>
<a name="ln-285"></a> <span class="k">if</span> <span class="p">(</span><span class="n">debug</span><span class="p">)</span>  <span class="n">thetar</span><span class="p">(</span><span class="mi">7</span><span class="o">+</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="n">thb</span>
<a name="ln-286"></a>  <span class="n">omega_min</span> <span class="o">=</span> <span class="n">thb</span> <span class="o">-</span> <span class="n">th</span>
<a name="ln-287"></a>  <span class="n">omega_max</span> <span class="o">=</span> <span class="n">thb</span> <span class="o">+</span> <span class="n">th</span>
<a name="ln-288"></a><span class="c">! check whether or not there is any overlap between this disk and the diffraction aperture opening</span>
<a name="ln-289"></a>  <span class="k">if</span> <span class="p">((</span><span class="n">omega_max</span><span class="p">.</span><span class="n">lt</span><span class="p">.(</span><span class="n">dx</span><span class="o">-</span><span class="n">dr</span><span class="p">)).</span><span class="nb">or</span><span class="p">.(</span><span class="n">omega_min</span><span class="p">.</span><span class="n">gt</span><span class="p">.(</span><span class="n">dx</span><span class="o">+</span><span class="n">dr</span><span class="p">)))</span> <span class="k">then</span>  <span class="c">! this disks does not fall inside the diffraction aperture </span>
<a name="ln-290"></a>    <span class="n">STEM</span><span class="p">%</span><span class="n">BFweightsarray</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">n</span><span class="p">,</span><span class="n">iCL</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-291"></a>  <span class="k">else</span>
<a name="ln-292"></a><span class="c">! case 1: dx-dr &lt; omega_min &lt; omega_max &lt; dx+dr</span>
<a name="ln-293"></a>    <span class="k">if</span> <span class="p">((</span><span class="n">omega_max</span><span class="p">.</span><span class="n">lt</span><span class="p">.(</span><span class="n">dx</span><span class="o">+</span><span class="n">dr</span><span class="p">)).</span><span class="nb">and</span><span class="p">.(</span><span class="n">omega_min</span><span class="p">.</span><span class="n">gt</span><span class="p">.(</span><span class="n">dx</span><span class="o">-</span><span class="n">dr</span><span class="p">)))</span> <span class="k">then</span>
<a name="ln-294"></a><span class="k">      do </span><span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">n</span>
<a name="ln-295"></a>        <span class="n">omega</span> <span class="o">=</span> <span class="n">omega_min</span><span class="o">+</span><span class="nb">float</span><span class="p">(</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">dom</span>
<a name="ln-296"></a>        <span class="n">kk</span> <span class="o">=</span> <span class="n">k</span>
<a name="ln-297"></a>        <span class="k">if</span> <span class="p">(</span><span class="n">j</span><span class="p">.</span><span class="n">lt</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span> <span class="n">kk</span> <span class="o">=</span> <span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="o">-</span><span class="n">k</span> 
<a name="ln-298"></a>        <span class="n">STEM</span><span class="p">%</span><span class="n">BFweightsarray</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">kk</span><span class="p">,</span><span class="n">iCL</span><span class="p">)</span> <span class="o">=</span>  <span class="nb">sqrt</span><span class="p">((</span><span class="n">th</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="p">(</span><span class="n">thb</span><span class="o">-</span><span class="n">omega</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
<a name="ln-299"></a>     <span class="k">end do </span>
<a name="ln-300"></a><span class="k">    end if</span>
<a name="ln-301"></a><span class="c">! case 2: omega_min &lt; dx-dr  &lt; dx+dr &lt; omega_max </span>
<a name="ln-302"></a>    <span class="k">if</span> <span class="p">((</span><span class="n">omega_max</span><span class="p">.</span><span class="n">gt</span><span class="p">.(</span><span class="n">dx</span><span class="o">+</span><span class="n">dr</span><span class="p">)).</span><span class="nb">and</span><span class="p">.(</span><span class="n">omega_min</span><span class="p">.</span><span class="n">lt</span><span class="p">.(</span><span class="n">dx</span><span class="o">-</span><span class="n">dr</span><span class="p">)))</span> <span class="k">then</span>
<a name="ln-303"></a><span class="k">      do </span><span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">n</span>
<a name="ln-304"></a>        <span class="n">omega</span> <span class="o">=</span> <span class="n">omega_min</span><span class="o">+</span><span class="nb">float</span><span class="p">(</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">dom</span>
<a name="ln-305"></a>        <span class="n">kk</span> <span class="o">=</span> <span class="n">k</span>
<a name="ln-306"></a>        <span class="k">if</span> <span class="p">(</span><span class="n">j</span><span class="p">.</span><span class="n">lt</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span> <span class="n">kk</span> <span class="o">=</span> <span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="o">-</span><span class="n">k</span> 
<a name="ln-307"></a>        <span class="k">if</span> <span class="p">((</span><span class="n">omega</span><span class="p">.</span><span class="n">gt</span><span class="p">.</span><span class="n">dx</span><span class="o">-</span><span class="n">dr</span><span class="p">).</span><span class="nb">and</span><span class="p">.(</span><span class="n">omega</span><span class="p">.</span><span class="n">lt</span><span class="p">.</span><span class="n">dx</span><span class="o">+</span><span class="n">dr</span><span class="p">))</span> <span class="k">then</span>
<a name="ln-308"></a><span class="k">           </span><span class="n">STEM</span><span class="p">%</span><span class="n">BFweightsarray</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">kk</span><span class="p">,</span><span class="n">iCL</span><span class="p">)</span> <span class="o">=</span>  <span class="nb">sqrt</span><span class="p">((</span><span class="n">dr</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="p">(</span><span class="n">omega</span><span class="o">-</span><span class="n">dx</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
<a name="ln-309"></a>        <span class="k">end if</span>
<a name="ln-310"></a><span class="k">      end do </span>
<a name="ln-311"></a><span class="k">    end if</span>
<a name="ln-312"></a><span class="c">! case 3: omega_min &lt; dx-dr   &lt; omega_max &lt; dx+dr</span>
<a name="ln-313"></a>    <span class="k">if</span> <span class="p">((</span><span class="n">omega_min</span><span class="p">.</span><span class="n">lt</span><span class="p">.(</span><span class="n">dx</span><span class="o">-</span><span class="n">dr</span><span class="p">)).</span><span class="nb">and</span><span class="p">.(</span><span class="n">omega_max</span><span class="p">.</span><span class="n">lt</span><span class="p">.(</span><span class="n">dx</span><span class="o">+</span><span class="n">dr</span><span class="p">)))</span> <span class="k">then</span>
<a name="ln-314"></a><span class="k">       </span><span class="n">p</span> <span class="o">=</span> <span class="p">((</span><span class="n">dx</span><span class="o">-</span><span class="n">thb</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="n">dr</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">th</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="mf">2.0</span><span class="o">/</span><span class="p">(</span><span class="n">dx</span><span class="o">-</span><span class="n">thb</span><span class="p">)</span><span class="o">+</span><span class="n">thb</span>
<a name="ln-315"></a>       <span class="k">do </span><span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">n</span>
<a name="ln-316"></a>         <span class="n">omega</span> <span class="o">=</span> <span class="n">omega_min</span><span class="o">+</span><span class="nb">float</span><span class="p">(</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">dom</span>
<a name="ln-317"></a>         <span class="n">kk</span> <span class="o">=</span> <span class="n">k</span>
<a name="ln-318"></a><span class="c">!         if (j.lt.0) kk = n+1-k </span>
<a name="ln-319"></a>        <span class="k">if</span> <span class="p">((</span><span class="n">omega</span><span class="p">.</span><span class="n">gt</span><span class="p">.</span><span class="n">dx</span><span class="o">-</span><span class="n">dr</span><span class="p">).</span><span class="nb">and</span><span class="p">.(</span><span class="n">omega</span><span class="p">.</span><span class="n">le</span><span class="p">.</span><span class="n">p</span><span class="p">))</span> <span class="k">then</span>
<a name="ln-320"></a><span class="k">          </span><span class="n">STEM</span><span class="p">%</span><span class="n">BFweightsarray</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">kk</span><span class="p">,</span><span class="n">iCL</span><span class="p">)</span> <span class="o">=</span>  <span class="nb">sqrt</span><span class="p">(</span><span class="n">dr</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="p">(</span><span class="n">omega</span><span class="o">-</span><span class="n">dx</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
<a name="ln-321"></a>        <span class="k">end if</span>
<a name="ln-322"></a><span class="k">        if</span> <span class="p">((</span><span class="n">omega</span><span class="p">.</span><span class="n">gt</span><span class="p">.</span><span class="n">p</span><span class="p">).</span><span class="nb">and</span><span class="p">.(</span><span class="n">omega</span><span class="p">.</span><span class="n">le</span><span class="p">.</span><span class="n">omega_max</span><span class="p">))</span> <span class="k">then</span>
<a name="ln-323"></a><span class="k">          </span><span class="n">STEM</span><span class="p">%</span><span class="n">BFweightsarray</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">kk</span><span class="p">,</span><span class="n">iCL</span><span class="p">)</span> <span class="o">=</span>  <span class="nb">sqrt</span><span class="p">((</span><span class="n">th</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="p">(</span><span class="n">thb</span><span class="o">-</span><span class="n">omega</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>       
<a name="ln-324"></a>        <span class="k">end if</span>
<a name="ln-325"></a><span class="k">      end do </span>
<a name="ln-326"></a><span class="k">    end if</span>
<a name="ln-327"></a> <span class="c">! case 4:  dx-dr   &lt; omega_min &lt; dx+dr &lt; omega_max</span>
<a name="ln-328"></a>    <span class="k">if</span> <span class="p">((</span><span class="n">omega_min</span><span class="p">.</span><span class="n">gt</span><span class="p">.(</span><span class="n">dx</span><span class="o">-</span><span class="n">dr</span><span class="p">)).</span><span class="nb">and</span><span class="p">.(</span><span class="n">omega_max</span><span class="p">.</span><span class="n">gt</span><span class="p">.(</span><span class="n">dx</span><span class="o">+</span><span class="n">dr</span><span class="p">)))</span> <span class="k">then</span>
<a name="ln-329"></a><span class="k">       </span><span class="n">p</span> <span class="o">=</span> <span class="p">((</span><span class="n">dx</span><span class="o">-</span><span class="n">thb</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="n">th</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">dr</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="mf">2.0</span><span class="o">/</span><span class="p">(</span><span class="n">thb</span><span class="o">-</span><span class="n">dx</span><span class="p">)</span> <span class="o">+</span> <span class="n">dx</span>
<a name="ln-330"></a>        <span class="k">do </span><span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">n</span>
<a name="ln-331"></a>        <span class="n">omega</span> <span class="o">=</span> <span class="n">omega_min</span><span class="o">+</span><span class="nb">float</span><span class="p">(</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">dom</span>
<a name="ln-332"></a>        <span class="n">kk</span> <span class="o">=</span> <span class="n">k</span>
<a name="ln-333"></a><span class="c">!        if (j.lt.0) kk = n+1-k </span>
<a name="ln-334"></a>        <span class="k">if</span> <span class="p">((</span><span class="n">omega</span><span class="p">.</span><span class="n">gt</span><span class="p">.</span><span class="n">p</span><span class="p">).</span><span class="nb">and</span><span class="p">.(</span><span class="n">omega</span><span class="p">.</span><span class="n">le</span><span class="p">.</span><span class="n">dx</span><span class="o">+</span><span class="n">dr</span><span class="p">))</span> <span class="k">then</span>
<a name="ln-335"></a><span class="k">          </span><span class="n">STEM</span><span class="p">%</span><span class="n">BFweightsarray</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">kk</span><span class="p">,</span><span class="n">iCL</span><span class="p">)</span> <span class="o">=</span> <span class="nb">sqrt</span><span class="p">((</span><span class="n">dr</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="p">(</span><span class="n">omega</span><span class="o">-</span><span class="n">dx</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span> 
<a name="ln-336"></a>        <span class="k">end if</span>
<a name="ln-337"></a><span class="k">        if</span> <span class="p">((</span><span class="n">omega</span><span class="p">.</span><span class="n">gt</span><span class="p">.</span><span class="n">omega_min</span><span class="p">).</span><span class="nb">and</span><span class="p">.(</span><span class="n">omega</span><span class="p">.</span><span class="n">le</span><span class="p">.</span><span class="n">p</span><span class="p">))</span> <span class="k">then</span>
<a name="ln-338"></a><span class="k">           </span><span class="n">STEM</span><span class="p">%</span><span class="n">BFweightsarray</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">kk</span><span class="p">,</span><span class="n">iCL</span><span class="p">)</span> <span class="o">=</span>  <span class="nb">sqrt</span><span class="p">((</span><span class="n">th</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="p">(</span><span class="n">thb</span><span class="o">-</span><span class="n">omega</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
<a name="ln-339"></a>        <span class="k">end if</span>
<a name="ln-340"></a><span class="k">      end do </span>
<a name="ln-341"></a><span class="k">    end if </span>
<a name="ln-342"></a><span class="k">  end if</span>
<a name="ln-343"></a><span class="k"> end do</span>  <span class="c">! this completes the BF weight factors when a diffraction aperture is present and apinBF=.TRUE.</span>
<a name="ln-344"></a><span class="k">end if</span> 
<a name="ln-345"></a>
<a name="ln-346"></a>
<a name="ln-347"></a><span class="c">! next determine the ADF weight factors in the presence of an aperture</span>
<a name="ln-348"></a><span class="k">if</span> <span class="p">(</span><span class="n">apinADF</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-349"></a><span class="c">! figure out which diffraction disk(s) contribute to the ADF detector</span>
<a name="ln-350"></a> <span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">nn</span>      <span class="c">! loop over all reflections of the systematic row</span>
<a name="ln-351"></a><span class="c">! redefine a couple of parameters</span>
<a name="ln-352"></a>    <span class="n">j</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">nn</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="o">-</span><span class="mi">1</span><span class="o">+</span><span class="n">i</span>
<a name="ln-353"></a>    <span class="k">if</span> <span class="p">(</span><span class="n">j</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span> <span class="k">then </span>
<a name="ln-354"></a><span class="k">      </span><span class="n">thb</span> <span class="o">=</span> <span class="p">(</span><span class="n">j</span><span class="o">/</span><span class="nb">abs</span><span class="p">(</span><span class="n">j</span><span class="p">))</span> <span class="o">*</span> <span class="n">CalcDiffAngle</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span><span class="n">j</span><span class="o">*</span><span class="n">g</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="n">j</span><span class="o">*</span><span class="n">g</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span><span class="n">j</span><span class="o">*</span><span class="n">g</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span><span class="o">*</span><span class="mi">100</span><span class="mf">0.0</span>  <span class="c">! diffraction angle in mrad</span>
<a name="ln-355"></a>    <span class="k">else</span>
<a name="ln-356"></a><span class="k">      </span><span class="n">thb</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-357"></a>   <span class="k">end if</span>  
<a name="ln-358"></a> <span class="c">! only used for debugging</span>
<a name="ln-359"></a> <span class="k">if</span> <span class="p">(</span><span class="n">debug</span><span class="p">)</span>  <span class="n">thetar</span><span class="p">(</span><span class="mi">7</span><span class="o">+</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="n">thb</span>
<a name="ln-360"></a>  <span class="n">omega_min</span> <span class="o">=</span> <span class="n">thb</span> <span class="o">-</span> <span class="n">th</span>
<a name="ln-361"></a>  <span class="n">omega_max</span> <span class="o">=</span> <span class="n">thb</span> <span class="o">+</span> <span class="n">th</span>
<a name="ln-362"></a><span class="c">! check whether or not there is any overlap between this disk and the diffraction aperture opening</span>
<a name="ln-363"></a>  <span class="k">if</span> <span class="p">((</span><span class="n">omega_max</span><span class="p">.</span><span class="n">lt</span><span class="p">.(</span><span class="n">dx</span><span class="o">-</span><span class="n">dr</span><span class="p">)).</span><span class="nb">or</span><span class="p">.(</span><span class="n">omega_min</span><span class="p">.</span><span class="n">gt</span><span class="p">.(</span><span class="n">dx</span><span class="o">+</span><span class="n">dr</span><span class="p">)))</span> <span class="k">then</span>  <span class="c">! this disks does not fall inside the diffraction aperture </span>
<a name="ln-364"></a>    <span class="n">STEM</span><span class="p">%</span><span class="n">ADFweightsarray</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">n</span><span class="p">,</span><span class="n">iCL</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-365"></a>  <span class="k">else</span>
<a name="ln-366"></a><span class="c">! case 1: dx-dr &lt; omega_min &lt; omega_max &lt; dx+dr</span>
<a name="ln-367"></a>    <span class="k">if</span> <span class="p">((</span><span class="n">omega_max</span><span class="p">.</span><span class="n">lt</span><span class="p">.(</span><span class="n">dx</span><span class="o">+</span><span class="n">dr</span><span class="p">)).</span><span class="nb">and</span><span class="p">.(</span><span class="n">omega_min</span><span class="p">.</span><span class="n">gt</span><span class="p">.(</span><span class="n">dx</span><span class="o">-</span><span class="n">dr</span><span class="p">)))</span> <span class="k">then</span>
<a name="ln-368"></a><span class="k">      do </span><span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">n</span>
<a name="ln-369"></a>        <span class="n">omega</span> <span class="o">=</span> <span class="n">omega_min</span><span class="o">+</span><span class="nb">float</span><span class="p">(</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">dom</span>
<a name="ln-370"></a>        <span class="n">kk</span> <span class="o">=</span> <span class="n">k</span>
<a name="ln-371"></a>        <span class="k">if</span> <span class="p">(</span><span class="n">j</span><span class="p">.</span><span class="n">lt</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span> <span class="n">kk</span> <span class="o">=</span> <span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="o">-</span><span class="n">k</span> 
<a name="ln-372"></a>        <span class="n">STEM</span><span class="p">%</span><span class="n">ADFweightsarray</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">kk</span><span class="p">,</span><span class="n">iCL</span><span class="p">)</span> <span class="o">=</span>  <span class="nb">sqrt</span><span class="p">((</span><span class="n">th</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="p">(</span><span class="n">thb</span><span class="o">-</span><span class="n">omega</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
<a name="ln-373"></a>     <span class="k">end do </span>
<a name="ln-374"></a><span class="k">    end if</span>
<a name="ln-375"></a><span class="c">! case 2: omega_min &lt; dx-dr  &lt; dx+dr &lt; omega_max </span>
<a name="ln-376"></a>    <span class="k">if</span> <span class="p">((</span><span class="n">omega_max</span><span class="p">.</span><span class="n">gt</span><span class="p">.(</span><span class="n">dx</span><span class="o">+</span><span class="n">dr</span><span class="p">)).</span><span class="nb">and</span><span class="p">.(</span><span class="n">omega_min</span><span class="p">.</span><span class="n">lt</span><span class="p">.(</span><span class="n">dx</span><span class="o">-</span><span class="n">dr</span><span class="p">)))</span> <span class="k">then</span>
<a name="ln-377"></a><span class="k">      do </span><span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">n</span>
<a name="ln-378"></a>        <span class="n">omega</span> <span class="o">=</span> <span class="n">omega_min</span><span class="o">+</span><span class="nb">float</span><span class="p">(</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">dom</span>
<a name="ln-379"></a>        <span class="n">kk</span> <span class="o">=</span> <span class="n">k</span>
<a name="ln-380"></a>        <span class="k">if</span> <span class="p">(</span><span class="n">j</span><span class="p">.</span><span class="n">lt</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span> <span class="n">kk</span> <span class="o">=</span> <span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="o">-</span><span class="n">k</span> 
<a name="ln-381"></a>        <span class="k">if</span> <span class="p">((</span><span class="n">omega</span><span class="p">.</span><span class="n">gt</span><span class="p">.</span><span class="n">dx</span><span class="o">-</span><span class="n">dr</span><span class="p">).</span><span class="nb">and</span><span class="p">.(</span><span class="n">omega</span><span class="p">.</span><span class="n">lt</span><span class="p">.</span><span class="n">dx</span><span class="o">+</span><span class="n">dr</span><span class="p">))</span> <span class="k">then</span>
<a name="ln-382"></a><span class="k">           </span><span class="n">STEM</span><span class="p">%</span><span class="n">ADFweightsarray</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">kk</span><span class="p">,</span><span class="n">iCL</span><span class="p">)</span> <span class="o">=</span>  <span class="nb">sqrt</span><span class="p">((</span><span class="n">dr</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="p">(</span><span class="n">omega</span><span class="o">-</span><span class="n">dx</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
<a name="ln-383"></a>        <span class="k">end if</span>
<a name="ln-384"></a><span class="k">      end do </span>
<a name="ln-385"></a><span class="k">    end if</span>
<a name="ln-386"></a><span class="c">! case 3: omega_min &lt; dx-dr   &lt; omega_max &lt; dx+dr</span>
<a name="ln-387"></a>    <span class="k">if</span> <span class="p">((</span><span class="n">omega_min</span><span class="p">.</span><span class="n">lt</span><span class="p">.(</span><span class="n">dx</span><span class="o">-</span><span class="n">dr</span><span class="p">)).</span><span class="nb">and</span><span class="p">.(</span><span class="n">omega_max</span><span class="p">.</span><span class="n">lt</span><span class="p">.(</span><span class="n">dx</span><span class="o">+</span><span class="n">dr</span><span class="p">)))</span> <span class="k">then</span>
<a name="ln-388"></a><span class="k">       </span><span class="n">p</span> <span class="o">=</span> <span class="p">((</span><span class="n">dx</span><span class="o">-</span><span class="n">thb</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="n">dr</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">th</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="mf">2.0</span><span class="o">/</span><span class="p">(</span><span class="n">dx</span><span class="o">-</span><span class="n">thb</span><span class="p">)</span><span class="o">+</span><span class="n">thb</span>
<a name="ln-389"></a>       <span class="k">do </span><span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">n</span>
<a name="ln-390"></a>         <span class="n">omega</span> <span class="o">=</span> <span class="n">omega_min</span><span class="o">+</span><span class="nb">float</span><span class="p">(</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">dom</span>
<a name="ln-391"></a>         <span class="n">kk</span> <span class="o">=</span> <span class="n">k</span>
<a name="ln-392"></a><span class="c">!         if (j.lt.0) kk = n+1-k </span>
<a name="ln-393"></a>        <span class="k">if</span> <span class="p">((</span><span class="n">omega</span><span class="p">.</span><span class="n">gt</span><span class="p">.</span><span class="n">dx</span><span class="o">-</span><span class="n">dr</span><span class="p">).</span><span class="nb">and</span><span class="p">.(</span><span class="n">omega</span><span class="p">.</span><span class="n">le</span><span class="p">.</span><span class="n">p</span><span class="p">))</span> <span class="k">then</span>
<a name="ln-394"></a><span class="k">          </span><span class="n">STEM</span><span class="p">%</span><span class="n">ADFweightsarray</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">kk</span><span class="p">,</span><span class="n">iCL</span><span class="p">)</span> <span class="o">=</span>  <span class="nb">sqrt</span><span class="p">(</span><span class="n">dr</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="p">(</span><span class="n">omega</span><span class="o">-</span><span class="n">dx</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
<a name="ln-395"></a>        <span class="k">end if</span>
<a name="ln-396"></a><span class="k">        if</span> <span class="p">((</span><span class="n">omega</span><span class="p">.</span><span class="n">gt</span><span class="p">.</span><span class="n">p</span><span class="p">).</span><span class="nb">and</span><span class="p">.(</span><span class="n">omega</span><span class="p">.</span><span class="n">le</span><span class="p">.</span><span class="n">omega_max</span><span class="p">))</span> <span class="k">then</span>
<a name="ln-397"></a><span class="k">          </span><span class="n">STEM</span><span class="p">%</span><span class="n">ADFweightsarray</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">kk</span><span class="p">,</span><span class="n">iCL</span><span class="p">)</span> <span class="o">=</span>  <span class="nb">sqrt</span><span class="p">((</span><span class="n">th</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="p">(</span><span class="n">thb</span><span class="o">-</span><span class="n">omega</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>       
<a name="ln-398"></a>        <span class="k">end if</span>
<a name="ln-399"></a><span class="k">      end do </span>
<a name="ln-400"></a><span class="k">    end if</span>
<a name="ln-401"></a> <span class="c">! case 4:  dx-dr   &lt; omega_min &lt; dx+dr &lt; omega_max</span>
<a name="ln-402"></a>    <span class="k">if</span> <span class="p">((</span><span class="n">omega_min</span><span class="p">.</span><span class="n">gt</span><span class="p">.(</span><span class="n">dx</span><span class="o">-</span><span class="n">dr</span><span class="p">)).</span><span class="nb">and</span><span class="p">.(</span><span class="n">omega_max</span><span class="p">.</span><span class="n">gt</span><span class="p">.(</span><span class="n">dx</span><span class="o">+</span><span class="n">dr</span><span class="p">)))</span> <span class="k">then</span>
<a name="ln-403"></a><span class="k">       </span><span class="n">p</span> <span class="o">=</span> <span class="p">((</span><span class="n">dx</span><span class="o">-</span><span class="n">thb</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="n">th</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">dr</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="mf">2.0</span><span class="o">/</span><span class="p">(</span><span class="n">thb</span><span class="o">-</span><span class="n">dx</span><span class="p">)</span> <span class="o">+</span> <span class="n">dx</span>
<a name="ln-404"></a>        <span class="k">do </span><span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">n</span>
<a name="ln-405"></a>        <span class="n">omega</span> <span class="o">=</span> <span class="n">omega_min</span><span class="o">+</span><span class="nb">float</span><span class="p">(</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">dom</span>
<a name="ln-406"></a>        <span class="n">kk</span> <span class="o">=</span> <span class="n">k</span>
<a name="ln-407"></a><span class="c">!        if (j.lt.0) kk = n+1-k </span>
<a name="ln-408"></a>        <span class="k">if</span> <span class="p">((</span><span class="n">omega</span><span class="p">.</span><span class="n">gt</span><span class="p">.</span><span class="n">p</span><span class="p">).</span><span class="nb">and</span><span class="p">.(</span><span class="n">omega</span><span class="p">.</span><span class="n">le</span><span class="p">.</span><span class="n">dx</span><span class="o">+</span><span class="n">dr</span><span class="p">))</span> <span class="k">then</span>
<a name="ln-409"></a><span class="k">          </span><span class="n">STEM</span><span class="p">%</span><span class="n">ADFweightsarray</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">kk</span><span class="p">,</span><span class="n">iCL</span><span class="p">)</span> <span class="o">=</span> <span class="nb">sqrt</span><span class="p">((</span><span class="n">dr</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="p">(</span><span class="n">omega</span><span class="o">-</span><span class="n">dx</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span> 
<a name="ln-410"></a>        <span class="k">end if</span>
<a name="ln-411"></a><span class="k">        if</span> <span class="p">((</span><span class="n">omega</span><span class="p">.</span><span class="n">gt</span><span class="p">.</span><span class="n">omega_min</span><span class="p">).</span><span class="nb">and</span><span class="p">.(</span><span class="n">omega</span><span class="p">.</span><span class="n">le</span><span class="p">.</span><span class="n">p</span><span class="p">))</span> <span class="k">then</span>
<a name="ln-412"></a><span class="k">           </span><span class="n">STEM</span><span class="p">%</span><span class="n">ADFweightsarray</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">kk</span><span class="p">,</span><span class="n">iCL</span><span class="p">)</span> <span class="o">=</span>  <span class="nb">sqrt</span><span class="p">((</span><span class="n">th</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="p">(</span><span class="n">thb</span><span class="o">-</span><span class="n">omega</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
<a name="ln-413"></a>        <span class="k">end if</span>
<a name="ln-414"></a><span class="k">      end do </span>
<a name="ln-415"></a><span class="k">    end if </span>
<a name="ln-416"></a><span class="k">  end if</span>
<a name="ln-417"></a><span class="k"> end do</span>  <span class="c">! this completes the ADF weight factors when a diffraction aperture is present and apinADF=.TRUE.</span>
<a name="ln-418"></a> 
<a name="ln-419"></a><span class="k">end if</span>
<a name="ln-420"></a>
<a name="ln-421"></a><span class="k">end if</span> <span class="c">! if aperture is present</span>
<a name="ln-422"></a>
<a name="ln-423"></a>
<a name="ln-424"></a><span class="k">end do </span><span class="n">outerCLloop</span>   <span class="c">! see line 146</span>
<a name="ln-425"></a>
<a name="ln-426"></a>
<a name="ln-427"></a><span class="c">! and the rest is also only used for debugging purposes</span>
<a name="ln-428"></a><span class="k">if</span> <span class="p">(</span><span class="n">debug</span><span class="p">)</span> <span class="k">then </span>
<a name="ln-429"></a><span class="k">  allocate</span><span class="p">(</span><span class="n">outar</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">nn</span><span class="p">,</span><span class="n">STEM</span><span class="p">%</span><span class="n">numberofsvalues</span><span class="p">,</span><span class="n">STEM</span><span class="p">%</span><span class="n">numCL</span><span class="p">))</span>
<a name="ln-430"></a>  <span class="n">outar</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">nn</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">STEM</span><span class="p">%</span><span class="n">numberofsvalues</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">STEM</span><span class="p">%</span><span class="n">numCL</span><span class="p">)</span> <span class="o">=</span> <span class="n">STEM</span><span class="p">%</span><span class="n">BFweightsarray</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">nn</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">STEM</span><span class="p">%</span><span class="n">numberofsvalues</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">STEM</span><span class="p">%</span><span class="n">numCL</span><span class="p">)</span>
<a name="ln-431"></a>  <span class="n">outar</span><span class="p">(</span><span class="n">nn</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="o">*</span><span class="n">nn</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">STEM</span><span class="p">%</span><span class="n">numberofsvalues</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">STEM</span><span class="p">%</span><span class="n">numCL</span><span class="p">)</span> <span class="o">=</span> <span class="n">STEM</span><span class="p">%</span><span class="n">ADFweightsarray</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">nn</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">STEM</span><span class="p">%</span><span class="n">numberofsvalues</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">STEM</span><span class="p">%</span><span class="n">numCL</span><span class="p">)</span>
<a name="ln-432"></a><span class="c">! to make sure that everything is correct, let&#39;s export this array so that we can display it in IDL</span>
<a name="ln-433"></a>  <span class="k">open</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">dataunit</span><span class="p">,</span><span class="k">file</span><span class="o">=</span><span class="s1">&#39;STEMprofiles.data&#39;</span><span class="p">,</span><span class="n">status</span><span class="o">=</span><span class="s1">&#39;unknown&#39;</span><span class="p">,</span><span class="n">form</span><span class="o">=</span><span class="s1">&#39;unformatted&#39;</span><span class="p">)</span>
<a name="ln-434"></a>  <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">dataunit</span><span class="p">)</span> <span class="n">nn</span><span class="p">,</span><span class="n">STEM</span><span class="p">%</span><span class="n">numberofsvalues</span><span class="p">,</span><span class="n">STEM</span><span class="p">%</span><span class="n">numCL</span>
<a name="ln-435"></a>  <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">dataunit</span><span class="p">)</span> <span class="n">thetar</span>
<a name="ln-436"></a>  <span class="k">write</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">dataunit</span><span class="p">)</span> <span class="n">outar</span>
<a name="ln-437"></a>  <span class="k">close</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="n">dataunit</span><span class="p">,</span><span class="n">status</span><span class="o">=</span><span class="s1">&#39;keep&#39;</span><span class="p">)</span>
<a name="ln-438"></a><span class="k">end if</span>
<a name="ln-439"></a>
<a name="ln-440"></a><span class="k">end subroutine </span><span class="n">init_STEM</span>
<a name="ln-441"></a>
<a name="ln-442"></a>
<a name="ln-443"></a>
<a name="ln-444"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-445"></a><span class="c">!</span>
<a name="ln-446"></a><span class="c">! SUBROUTINE: init_STEM_ZA</span>
<a name="ln-447"></a><span class="c">!</span>
<a name="ln-448"></a><span class="c">!&gt; @author Marc De Graef, Carnegie Mellon University</span>
<a name="ln-449"></a><span class="c">!</span>
<a name="ln-450"></a><span class="c">!&gt; @brief initialize weight factors for zone-axis STEM case</span>
<a name="ln-451"></a><span class="c">! </span>
<a name="ln-452"></a><span class="c">!&gt; @note This will need to be reconsidered when we implement sectored detectors ... </span>
<a name="ln-453"></a><span class="c">!</span>
<a name="ln-454"></a><span class="c">!&gt; @param STEM STEM structure</span>
<a name="ln-455"></a><span class="c">!&gt; @param cell unit cell pointer</span>
<a name="ln-456"></a><span class="c">!&gt; @param F foil normal</span>
<a name="ln-457"></a><span class="c">!&gt; @param khead top of kvector list</span>
<a name="ln-458"></a><span class="c">!&gt; @param reflist top of reflection list</span>
<a name="ln-459"></a><span class="c">!&gt; @param nn number of reflections</span>
<a name="ln-460"></a><span class="c">! </span>
<a name="ln-461"></a><span class="c">!&gt; @date   04/29/11 MDG 1.0 original</span>
<a name="ln-462"></a><span class="c">!&gt; @date   06/12/13 MDG 2.0 rewrite </span>
<a name="ln-463"></a><span class="c">!&gt; @date   06/09/14 MDG 3.0 added STEM and cell structures and khead+reflist linked lists</span>
<a name="ln-464"></a><span class="c">!&gt; @date   06/10/14 MDG 3.1 added F, Dyn argument</span>
<a name="ln-465"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-466"></a><span class="k">recursive subroutine </span><span class="n">init_STEM_ZA</span><span class="p">(</span><span class="n">STEM</span><span class="p">,</span><span class="n">cell</span><span class="p">,</span><span class="n">F</span><span class="p">,</span><span class="n">Dyn</span><span class="p">,</span><span class="n">khead</span><span class="p">,</span><span class="n">reflist</span><span class="p">,</span><span class="n">nn</span><span class="p">)</span>
<a name="ln-467"></a><span class="c">!DEC$ ATTRIBUTES DLLEXPORT :: init_STEM_ZA</span>
<a name="ln-468"></a>
<a name="ln-469"></a><span class="k">use </span><span class="n">crystal</span>
<a name="ln-470"></a><span class="k">use </span><span class="n">diffraction</span>
<a name="ln-471"></a><span class="k">use </span><span class="n">kvectors</span>
<a name="ln-472"></a><span class="k">use </span><span class="n">gvectors</span>
<a name="ln-473"></a>
<a name="ln-474"></a><span class="k">IMPLICIT NONE</span>
<a name="ln-475"></a>
<a name="ln-476"></a><span class="k">type</span><span class="p">(</span><span class="n">STEMtype</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">INOUT</span><span class="p">)</span>        <span class="kd">::</span> <span class="n">STEM</span>
<a name="ln-477"></a><span class="k">type</span><span class="p">(</span><span class="n">unitcell</span><span class="p">),</span><span class="k">pointer</span>              <span class="kd">::</span> <span class="n">cell</span>
<a name="ln-478"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">dbl</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">INOUT</span><span class="p">)</span>        <span class="kd">::</span> <span class="n">F</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-479"></a><span class="k">type</span><span class="p">(</span><span class="n">DynType</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">INOUT</span><span class="p">)</span>         <span class="kd">::</span> <span class="n">Dyn</span>
<a name="ln-480"></a><span class="k">type</span><span class="p">(</span><span class="n">kvectorlist</span><span class="p">),</span><span class="k">pointer</span>           <span class="kd">::</span> <span class="n">khead</span>
<a name="ln-481"></a><span class="k">type</span><span class="p">(</span><span class="n">reflisttype</span><span class="p">),</span><span class="k">pointer</span>           <span class="kd">::</span> <span class="n">reflist</span>
<a name="ln-482"></a><span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">irg</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>        <span class="kd">::</span> <span class="n">nn</span>
<a name="ln-483"></a>
<a name="ln-484"></a><span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">irg</span><span class="p">)</span>                   <span class="kd">::</span> <span class="n">ik</span><span class="p">,</span><span class="n">ig</span><span class="p">,</span> <span class="n">iCL</span>
<a name="ln-485"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">)</span>                      <span class="kd">::</span> <span class="n">ll</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">lpg</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">gg</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">glen</span><span class="p">,</span> <span class="n">gplen</span><span class="p">,</span> <span class="n">kpg</span>
<a name="ln-486"></a><span class="k">type</span><span class="p">(</span><span class="n">kvectorlist</span><span class="p">),</span><span class="k">pointer</span>           <span class="kd">::</span> <span class="n">ktmp</span>
<a name="ln-487"></a><span class="k">type</span><span class="p">(</span><span class="n">reflisttype</span><span class="p">),</span><span class="k">pointer</span>           <span class="kd">::</span> <span class="n">rltmpa</span>
<a name="ln-488"></a>
<a name="ln-489"></a><span class="c">! this routine initializes the excitation error arrays and the weight-factor arrays for zone axis STEM signals</span>
<a name="ln-490"></a><span class="c">! the weightfactors are quite a bit different from the ones for the systematic row case;</span>
<a name="ln-491"></a><span class="c">! they are simpler in principle, since each point in the diffracted disk can only lie in one</span>
<a name="ln-492"></a><span class="c">! place, and hence only contributes to one detector.  However, not all points in a disk</span>
<a name="ln-493"></a><span class="c">! contribute to the same detector...  The length of the vector k_t+g, expressed in mrad,</span>
<a name="ln-494"></a><span class="c">! is what needs to be compared to the radii of the BF and ADF detectors.  For each incident </span>
<a name="ln-495"></a><span class="c">! beam direction, we take the tangential component of the wave vector and loop over all</span>
<a name="ln-496"></a><span class="c">! reflections to compute the relevant angle; this then allows us to assign the weight factors</span>
<a name="ln-497"></a><span class="c">! which are now either 1 or 0 (so they can be stored as logicals).</span>
<a name="ln-498"></a>
<a name="ln-499"></a><span class="c">! allocate the excitation error array areal(1..nn,1..STEM%numk)</span>
<a name="ln-500"></a>  <span class="k">allocate</span><span class="p">(</span><span class="n">STEM</span><span class="p">%</span><span class="n">sgarray</span><span class="p">(</span><span class="n">nn</span><span class="p">,</span><span class="n">STEM</span><span class="p">%</span><span class="n">numk</span><span class="p">))</span>
<a name="ln-501"></a>  
<a name="ln-502"></a><span class="c">! transform the foil normal to real space and normalize</span>
<a name="ln-503"></a>  <span class="k">call </span><span class="n">TransSpace</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span><span class="nb">sngl</span><span class="p">(</span><span class="n">F</span><span class="p">),</span><span class="n">Dyn</span><span class="p">%</span><span class="n">FN</span><span class="p">,</span><span class="s1">&#39;d&#39;</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
<a name="ln-504"></a>  <span class="k">call </span><span class="n">NormVec</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span><span class="n">Dyn</span><span class="p">%</span><span class="n">FN</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
<a name="ln-505"></a>
<a name="ln-506"></a><span class="c">! allocate the weight factor arrays, one entry for each beam direction, reflection, and camera length</span>
<a name="ln-507"></a>  <span class="k">allocate</span><span class="p">(</span><span class="n">STEM</span><span class="p">%</span><span class="n">ZABFweightsarray</span><span class="p">(</span><span class="n">nn</span><span class="p">,</span><span class="n">STEM</span><span class="p">%</span><span class="n">numk</span><span class="p">,</span><span class="n">STEM</span><span class="p">%</span><span class="n">numCL</span><span class="p">),</span><span class="n">STEM</span><span class="p">%</span><span class="n">ZAADFweightsarray</span><span class="p">(</span><span class="n">nn</span><span class="p">,</span><span class="n">STEM</span><span class="p">%</span><span class="n">numk</span><span class="p">,</span><span class="n">STEM</span><span class="p">%</span><span class="n">numCL</span><span class="p">))</span>
<a name="ln-508"></a>  <span class="n">STEM</span><span class="p">%</span><span class="n">ZABFweightsarray</span> <span class="o">=</span> <span class="p">.</span><span class="n">FALSE</span><span class="p">.</span>
<a name="ln-509"></a>  <span class="n">STEM</span><span class="p">%</span><span class="n">ZAADFweightsarray</span> <span class="o">=</span> <span class="p">.</span><span class="n">FALSE</span><span class="p">.</span>
<a name="ln-510"></a>
<a name="ln-511"></a><span class="c">! loop over the wave vector linked list</span>
<a name="ln-512"></a>  <span class="n">ktmp</span> <span class="o">=&gt;</span> <span class="n">khead</span>
<a name="ln-513"></a>  <span class="n">beamloopCL</span><span class="p">:</span> <span class="k">do </span><span class="n">ik</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">STEM</span><span class="p">%</span><span class="n">numk</span>
<a name="ln-514"></a>    <span class="n">ll</span> <span class="o">=</span> <span class="n">ktmp</span><span class="p">%</span><span class="n">kt</span>        <span class="c">! this is the tangential component of the wave vector</span>
<a name="ln-515"></a><span class="c">! and loop over all reflections</span>
<a name="ln-516"></a>    <span class="n">rltmpa</span> <span class="o">=&gt;</span> <span class="n">reflist</span><span class="p">%</span><span class="n">next</span>
<a name="ln-517"></a>    <span class="n">reflectionloopCL</span><span class="p">:</span> <span class="k">do </span><span class="n">ig</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">nn</span>
<a name="ln-518"></a>      <span class="n">gg</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">rltmpa</span><span class="p">%</span><span class="n">hkl</span><span class="p">)</span>
<a name="ln-519"></a>      <span class="n">glen</span> <span class="o">=</span> <span class="n">CalcLength</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span><span class="n">gg</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
<a name="ln-520"></a>      <span class="n">lpg</span> <span class="o">=</span> <span class="n">ll</span> <span class="o">+</span> <span class="n">gg</span>                <span class="c">! Laue + g</span>
<a name="ln-521"></a>      <span class="n">gplen</span> <span class="o">=</span> <span class="n">CalcLength</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span><span class="n">lpg</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
<a name="ln-522"></a>      <span class="n">kpg</span> <span class="o">=</span> <span class="mi">200</span><span class="mf">0.0</span><span class="o">*</span><span class="nb">asin</span><span class="p">(</span><span class="mf">0.50</span><span class="o">*</span><span class="nb">sngl</span><span class="p">(</span><span class="n">cell</span><span class="p">%</span><span class="n">mLambda</span><span class="p">)</span><span class="o">*</span><span class="n">gplen</span><span class="p">)</span>    <span class="c">! 2theta in mrad</span>
<a name="ln-523"></a>      <span class="k">do </span><span class="n">iCL</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">STEM</span><span class="p">%</span><span class="n">numCL</span>
<a name="ln-524"></a>        <span class="n">STEM</span><span class="p">%</span><span class="n">BFmrad</span> <span class="o">=</span> <span class="nb">atan</span><span class="p">(</span><span class="n">STEM</span><span class="p">%</span><span class="n">BFradius</span><span class="o">/</span><span class="n">STEM</span><span class="p">%</span><span class="n">CLarray</span><span class="p">(</span><span class="n">iCL</span><span class="p">))</span><span class="o">*</span><span class="mi">100</span><span class="mf">0.0</span>
<a name="ln-525"></a>        <span class="n">STEM</span><span class="p">%</span><span class="n">ADFimrad</span> <span class="o">=</span> <span class="nb">atan</span><span class="p">(</span><span class="n">STEM</span><span class="p">%</span><span class="n">ADFinnerradius</span><span class="o">/</span><span class="n">STEM</span><span class="p">%</span><span class="n">CLarray</span><span class="p">(</span><span class="n">iCL</span><span class="p">))</span><span class="o">*</span><span class="mi">100</span><span class="mf">0.0</span>
<a name="ln-526"></a>        <span class="n">STEM</span><span class="p">%</span><span class="n">ADFomrad</span> <span class="o">=</span> <span class="nb">atan</span><span class="p">(</span><span class="n">STEM</span><span class="p">%</span><span class="n">ADFouterradius</span><span class="o">/</span><span class="n">STEM</span><span class="p">%</span><span class="n">CLarray</span><span class="p">(</span><span class="n">iCL</span><span class="p">))</span><span class="o">*</span><span class="mi">100</span><span class="mf">0.0</span>
<a name="ln-527"></a>        <span class="k">if</span> <span class="p">(</span><span class="n">kpg</span><span class="p">.</span><span class="n">le</span><span class="p">.</span><span class="n">STEM</span><span class="p">%</span><span class="n">BFmrad</span><span class="p">)</span> <span class="n">STEM</span><span class="p">%</span><span class="n">ZABFweightsarray</span><span class="p">(</span><span class="n">ig</span><span class="p">,</span><span class="n">ik</span><span class="p">,</span><span class="n">iCL</span><span class="p">)</span> <span class="o">=</span> <span class="p">.</span><span class="n">TRUE</span><span class="p">.</span>
<a name="ln-528"></a>        <span class="k">if</span> <span class="p">((</span><span class="n">kpg</span><span class="p">.</span><span class="n">ge</span><span class="p">.</span><span class="n">STEM</span><span class="p">%</span><span class="n">ADFimrad</span><span class="p">).</span><span class="nb">AND</span><span class="p">.(</span><span class="n">kpg</span><span class="p">.</span><span class="n">le</span><span class="p">.</span><span class="n">STEM</span><span class="p">%</span><span class="n">ADFomrad</span><span class="p">))</span> <span class="n">STEM</span><span class="p">%</span><span class="n">ZAADFweightsarray</span><span class="p">(</span><span class="n">ig</span><span class="p">,</span><span class="n">ik</span><span class="p">,</span><span class="n">iCL</span><span class="p">)</span> <span class="o">=</span> <span class="p">.</span><span class="n">TRUE</span><span class="p">.</span>
<a name="ln-529"></a>      <span class="k">end do</span>  <span class="c">! loop over camera lengths</span>
<a name="ln-530"></a>      <span class="n">STEM</span><span class="p">%</span><span class="n">sgarray</span><span class="p">(</span><span class="n">ig</span><span class="p">,</span><span class="n">ik</span><span class="p">)</span> <span class="o">=</span> <span class="n">Calcsg</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span><span class="n">gg</span><span class="p">,</span><span class="nb">sngl</span><span class="p">(</span><span class="n">ktmp</span><span class="p">%</span><span class="n">k</span><span class="p">),</span><span class="n">Dyn</span><span class="p">%</span><span class="n">FN</span><span class="p">)</span>
<a name="ln-531"></a> <span class="c">! and we move to the next reflection in the list</span>
<a name="ln-532"></a>      <span class="n">rltmpa</span> <span class="o">=&gt;</span> <span class="n">rltmpa</span><span class="p">%</span><span class="n">next</span>
<a name="ln-533"></a>    <span class="k">end do </span><span class="n">reflectionloopCL</span>  
<a name="ln-534"></a>    <span class="n">ktmp</span> <span class="o">=&gt;</span> <span class="n">ktmp</span><span class="p">%</span><span class="n">next</span>
<a name="ln-535"></a>  <span class="k">end do </span><span class="n">beamloopCL</span>
<a name="ln-536"></a>
<a name="ln-537"></a><span class="c">! that&#39;s it folks!</span>
<a name="ln-538"></a><span class="k">end subroutine </span><span class="n">init_STEM_ZA</span>
<a name="ln-539"></a>
<a name="ln-540"></a>
<a name="ln-541"></a>
<a name="ln-542"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-543"></a><span class="c">!</span>
<a name="ln-544"></a><span class="c">! SUBROUTINE: read_STEM_data</span>
<a name="ln-545"></a><span class="c">!</span>
<a name="ln-546"></a><span class="c">!&gt; @author Marc De Graef, Carnegie Mellon University</span>
<a name="ln-547"></a><span class="c">!</span>
<a name="ln-548"></a><span class="c">!&gt; @brief read detector and other parameters for the STEM case</span>
<a name="ln-549"></a><span class="c">! </span>
<a name="ln-550"></a><span class="c">!&gt; @param STEM STEM structure</span>
<a name="ln-551"></a><span class="c">!&gt; @param cell unit cell pointer</span>
<a name="ln-552"></a><span class="c">!&gt; @param F foil normal</span>
<a name="ln-553"></a><span class="c">!&gt; @param Dyn dynamical scattering structure</span>
<a name="ln-554"></a><span class="c">!&gt; @param STEMnmlfile filename of the namelist file</span>
<a name="ln-555"></a><span class="c">!&gt; @param khead top of kvector list</span>
<a name="ln-556"></a><span class="c">!&gt; @param reflist top of reflection list</span>
<a name="ln-557"></a><span class="c">!&gt; @param geometry &#39;SR&#39; for systematic row or &#39;ZA&#39; for zone axis</span>
<a name="ln-558"></a><span class="c">!&gt; @param nn number of reflections</span>
<a name="ln-559"></a><span class="c">!&gt; @param g fundamental g-vector for systematic row</span>
<a name="ln-560"></a><span class="c">!&gt; @param kt tangential wave vector component</span>
<a name="ln-561"></a><span class="c">!&gt; @param numk number of distinct wave vectors (optional)</span>
<a name="ln-562"></a><span class="c">!&gt; @param beamdiv beam divergence parameter (optional)</span>
<a name="ln-563"></a><span class="c">! </span>
<a name="ln-564"></a><span class="c">!&gt; @date   04/29/11 MDG 1.0 original</span>
<a name="ln-565"></a><span class="c">!&gt; @date   06/12/13 MDG 2.0 rewrite </span>
<a name="ln-566"></a><span class="c">!&gt; @date   11/26/13 MDG 2.1 made geometry an input parameter instead of part of the STEMdata namelist</span>
<a name="ln-567"></a><span class="c">!&gt; @date   06/10/14 MDG 3.0 added STEM, cell, foil, and Dyn arguments</span>
<a name="ln-568"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-569"></a><span class="k">recursive subroutine </span><span class="n">read_STEM_data</span><span class="p">(</span><span class="n">STEM</span><span class="p">,</span><span class="n">cell</span><span class="p">,</span><span class="n">F</span><span class="p">,</span><span class="n">Dyn</span><span class="p">,</span><span class="n">STEMnmlfile</span><span class="p">,</span><span class="n">khead</span><span class="p">,</span><span class="n">reflist</span><span class="p">,</span><span class="n">geometry</span><span class="p">,</span><span class="n">nn</span><span class="p">,</span><span class="n">g</span><span class="p">,</span><span class="n">kt</span><span class="p">,</span><span class="n">numk</span><span class="p">,</span><span class="n">beamdiv</span><span class="p">)</span>
<a name="ln-570"></a><span class="c">!DEC$ ATTRIBUTES DLLEXPORT :: read_STEM_data</span>
<a name="ln-571"></a>
<a name="ln-572"></a><span class="k">use </span><span class="n">io</span>
<a name="ln-573"></a><span class="k">use </span><span class="n">files</span>
<a name="ln-574"></a><span class="k">use </span><span class="n">kvectors</span>
<a name="ln-575"></a><span class="k">use </span><span class="n">gvectors</span>
<a name="ln-576"></a>
<a name="ln-577"></a><span class="k">IMPLICIT NONE</span>
<a name="ln-578"></a>
<a name="ln-579"></a><span class="k">type</span><span class="p">(</span><span class="n">STEMtype</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">INOUT</span><span class="p">)</span>                    <span class="kd">::</span> <span class="n">STEM</span>
<a name="ln-580"></a><span class="k">type</span><span class="p">(</span><span class="n">unitcell</span><span class="p">),</span><span class="k">pointer</span>                          <span class="kd">::</span> <span class="n">cell</span>
<a name="ln-581"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">dbl</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">INOUT</span><span class="p">)</span>                    <span class="kd">::</span> <span class="n">F</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-582"></a><span class="k">type</span><span class="p">(</span><span class="n">DynType</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">INOUT</span><span class="p">)</span>                     <span class="kd">::</span> <span class="n">Dyn</span>
<a name="ln-583"></a><span class="kt">character</span><span class="p">(</span><span class="n">fnlen</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>                     <span class="kd">::</span> <span class="n">STEMnmlfile</span>
<a name="ln-584"></a><span class="k">type</span><span class="p">(</span><span class="n">kvectorlist</span><span class="p">),</span><span class="k">pointer</span>                       <span class="kd">::</span> <span class="n">khead</span>
<a name="ln-585"></a><span class="k">type</span><span class="p">(</span><span class="n">reflisttype</span><span class="p">),</span><span class="k">pointer</span>                       <span class="kd">::</span> <span class="n">reflist</span>
<a name="ln-586"></a><span class="kt">character</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>                         <span class="kd">::</span> <span class="n">geometry</span>  <span class="c">! &#39;SR&#39; or &#39;ZA&#39;</span>
<a name="ln-587"></a><span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">irg</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>                    <span class="kd">::</span> <span class="n">nn</span>
<a name="ln-588"></a><span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">irg</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>                    <span class="kd">::</span> <span class="n">g</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-589"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>                       <span class="kd">::</span> <span class="n">kt</span>
<a name="ln-590"></a><span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">irg</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">),</span><span class="k">OPTIONAL</span>           <span class="kd">::</span> <span class="n">numk</span>
<a name="ln-591"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">OUT</span><span class="p">),</span><span class="k">OPTIONAL</span>             <span class="kd">::</span> <span class="n">beamdiv</span>
<a name="ln-592"></a>
<a name="ln-593"></a><span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">irg</span><span class="p">)</span>                               <span class="kd">::</span> <span class="n">numberofsvalues</span><span class="p">,</span><span class="n">numCL</span>
<a name="ln-594"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">)</span>                                  <span class="kd">::</span> <span class="n">BFradius</span><span class="p">,</span><span class="n">ADFinnerradius</span><span class="p">,</span><span class="n">ADFouterradius</span><span class="p">,</span><span class="n">beamconvergence</span><span class="p">,</span><span class="n">cameralength</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-595"></a>                                                        <span class="n">diffaprad</span><span class="p">,</span> <span class="n">diffapcenter</span><span class="p">,</span><span class="n">CLarray</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
<a name="ln-596"></a><span class="kt">character</span><span class="p">(</span><span class="n">fnlen</span><span class="p">)</span>                                <span class="kd">::</span> <span class="n">weightoutput</span>
<a name="ln-597"></a>
<a name="ln-598"></a><span class="k">namelist</span> <span class="o">/</span> <span class="n">STEMdata</span> <span class="o">/</span> <span class="n">BFradius</span><span class="p">,</span> <span class="n">ADFinnerradius</span><span class="p">,</span> <span class="n">ADFouterradius</span><span class="p">,</span> <span class="n">cameralength</span><span class="p">,</span> <span class="n">numCL</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-599"></a>                      <span class="n">beamconvergence</span><span class="p">,</span> <span class="n">numberofsvalues</span><span class="p">,</span> <span class="n">diffaprad</span><span class="p">,</span> <span class="n">diffapcenter</span><span class="p">,</span> <span class="n">weightoutput</span><span class="p">,</span> <span class="n">CLarray</span>
<a name="ln-600"></a>
<a name="ln-601"></a><span class="c">! set default values (based on OSU Tecnai F20)</span>
<a name="ln-602"></a><span class="n">BFradius</span> <span class="o">=</span> <span class="mf">3.5</span>                  <span class="c">! mm</span>
<a name="ln-603"></a><span class="n">ADFinnerradius</span> <span class="o">=</span> <span class="mf">3.5</span>            <span class="c">! mm</span>
<a name="ln-604"></a><span class="n">ADFouterradius</span> <span class="o">=</span> <span class="mi">1</span><span class="mf">0.0</span>           <span class="c">! mm</span>
<a name="ln-605"></a><span class="n">cameralength</span> <span class="o">=</span> <span class="mi">10</span><span class="mf">0.0</span>            <span class="c">! mm</span>
<a name="ln-606"></a><span class="n">numCL</span> <span class="o">=</span> <span class="mi">0</span>                       <span class="c">! number of camera lengths to be used  (if zero, then use cameralength instead)</span>
<a name="ln-607"></a><span class="n">CLarray</span> <span class="o">=</span> <span class="mf">0.0</span>                   <span class="c">! values for the camera lengths</span>
<a name="ln-608"></a><span class="n">beamconvergence</span> <span class="o">=</span> <span class="mf">2.0</span>           <span class="c">! mrad</span>
<a name="ln-609"></a><span class="n">numberofsvalues</span> <span class="o">=</span> <span class="mi">33</span>            <span class="c">! integer</span>
<a name="ln-610"></a><span class="n">diffaprad</span> <span class="o">=</span> <span class="mf">0.0</span>                 <span class="c">! diffraction aperture radius in mrad, 0.0 if no aperture is present</span>
<a name="ln-611"></a><span class="n">diffapcenter</span> <span class="o">=</span> <span class="mf">0.0</span>              <span class="c">! position of center of diffraction aperture in mrad along systematic row</span>
<a name="ln-612"></a><span class="n">weightoutput</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>               <span class="c">! string with filename root for graphical output of weight profiles, empty if not needed</span>
<a name="ln-613"></a>
<a name="ln-614"></a><span class="c">! read the namelist file</span>
<a name="ln-615"></a><span class="k">call </span><span class="n">Message</span><span class="p">(</span><span class="s1">&#39;opening &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">STEMnmlfile</span><span class="p">),</span> <span class="n">frm</span> <span class="o">=</span> <span class="s2">&quot;(/A)&quot;</span><span class="p">)</span>
<a name="ln-616"></a><span class="k">open</span><span class="p">(</span><span class="n">UNIT</span><span class="o">=</span><span class="n">dataunit</span><span class="p">,</span><span class="k">FILE</span><span class="o">=</span><span class="nb">trim</span><span class="p">(</span><span class="n">EMsoft_toNativePath</span><span class="p">(</span><span class="n">STEMnmlfile</span><span class="p">)),</span><span class="n">DELIM</span><span class="o">=</span><span class="s1">&#39;APOSTROPHE&#39;</span><span class="p">)</span>
<a name="ln-617"></a><span class="k">read</span><span class="p">(</span><span class="n">UNIT</span><span class="o">=</span><span class="n">dataunit</span><span class="p">,</span><span class="n">NML</span><span class="o">=</span><span class="n">STEMdata</span><span class="p">)</span>
<a name="ln-618"></a><span class="k">close</span><span class="p">(</span><span class="n">UNIT</span><span class="o">=</span><span class="n">dataunit</span><span class="p">)</span>
<a name="ln-619"></a>
<a name="ln-620"></a><span class="k">if</span> <span class="p">(</span><span class="nb">PRESENT</span><span class="p">(</span><span class="n">beamdiv</span><span class="p">))</span> <span class="n">beamdiv</span><span class="o">=</span><span class="n">beamconvergence</span>
<a name="ln-621"></a>
<a name="ln-622"></a><span class="c">! set the parameters</span>
<a name="ln-623"></a>  <span class="n">STEM</span><span class="p">%</span><span class="n">BFradius</span> <span class="o">=</span> <span class="n">BFradius</span>
<a name="ln-624"></a>  <span class="n">STEM</span><span class="p">%</span><span class="n">ADFinnerradius</span> <span class="o">=</span> <span class="n">ADFinnerradius</span>
<a name="ln-625"></a>  <span class="n">STEM</span><span class="p">%</span><span class="n">ADFouterradius</span> <span class="o">=</span> <span class="n">ADFouterradius</span>
<a name="ln-626"></a>  <span class="n">STEM</span><span class="p">%</span><span class="n">kt</span> <span class="o">=</span> <span class="n">kt</span>
<a name="ln-627"></a>  <span class="n">STEM</span><span class="p">%</span><span class="n">cameralength</span> <span class="o">=</span> <span class="n">cameralength</span>
<a name="ln-628"></a>  <span class="n">STEM</span><span class="p">%</span><span class="n">beamconvergence</span> <span class="o">=</span> <span class="n">beamconvergence</span>
<a name="ln-629"></a>  <span class="k">if</span> <span class="p">(</span><span class="n">numCL</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span> <span class="k">then </span>
<a name="ln-630"></a><span class="k">    </span><span class="n">STEM</span><span class="p">%</span><span class="n">numCL</span> <span class="o">=</span> <span class="n">numCL</span>
<a name="ln-631"></a>    <span class="n">STEM</span><span class="p">%</span><span class="n">CLarray</span> <span class="o">=</span> <span class="n">CLarray</span>
<a name="ln-632"></a>  <span class="k">else</span>
<a name="ln-633"></a><span class="k">    </span><span class="n">STEM</span><span class="p">%</span><span class="n">numCL</span> <span class="o">=</span> <span class="mi">1</span>
<a name="ln-634"></a>    <span class="n">STEM</span><span class="p">%</span><span class="n">CLarray</span> <span class="o">=</span> <span class="n">cameralength</span>  
<a name="ln-635"></a>  <span class="k">end if</span>
<a name="ln-636"></a><span class="c">! make sure the number of s values is an odd number</span>
<a name="ln-637"></a>  <span class="k">if</span> <span class="p">(</span><span class="nb">mod</span><span class="p">(</span><span class="n">numberofsvalues</span><span class="p">,</span><span class="mi">2</span><span class="p">).</span><span class="n">eq</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span> <span class="n">numberofsvalues</span><span class="o">=</span><span class="n">numberofsvalues</span><span class="o">+</span><span class="mi">1</span>
<a name="ln-638"></a>  <span class="n">STEM</span><span class="p">%</span><span class="n">numberofsvalues</span> <span class="o">=</span> <span class="n">numberofsvalues</span>
<a name="ln-639"></a>  <span class="n">STEM</span><span class="p">%</span><span class="n">diffapmrad</span> <span class="o">=</span> <span class="n">diffaprad</span>
<a name="ln-640"></a>  <span class="n">STEM</span><span class="p">%</span><span class="n">diffapmcenter</span> <span class="o">=</span> <span class="n">diffapcenter</span>
<a name="ln-641"></a>  <span class="n">STEM</span><span class="p">%</span><span class="n">weightoutput</span> <span class="o">=</span> <span class="n">weightoutput</span>
<a name="ln-642"></a>  <span class="n">STEM</span><span class="p">%</span><span class="n">geometry</span> <span class="o">=</span> <span class="n">geometry</span>
<a name="ln-643"></a>  <span class="k">if</span> <span class="p">(</span><span class="nb">PRESENT</span><span class="p">(</span><span class="n">numk</span><span class="p">))</span> <span class="k">then</span>
<a name="ln-644"></a><span class="k">    </span><span class="n">STEM</span><span class="p">%</span><span class="n">numk</span> <span class="o">=</span> <span class="n">numk</span>
<a name="ln-645"></a>  <span class="k">else</span>
<a name="ln-646"></a><span class="k">    </span><span class="n">STEM</span><span class="p">%</span><span class="n">numk</span> <span class="o">=</span> <span class="n">STEM</span><span class="p">%</span><span class="n">numberofsvalues</span>
<a name="ln-647"></a>  <span class="k">end if</span>
<a name="ln-648"></a>
<a name="ln-649"></a><span class="c">! and initialize all other STEM related arrays </span>
<a name="ln-650"></a><span class="k">if</span> <span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="nb">PRESENT</span><span class="p">(</span><span class="n">beamdiv</span><span class="p">))</span> <span class="k">then</span>
<a name="ln-651"></a><span class="k">  if</span> <span class="p">(</span><span class="n">geometry</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="s1">&#39;SR&#39;</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-652"></a><span class="k">    call </span><span class="n">init_STEM</span><span class="p">(</span><span class="n">STEM</span><span class="p">,</span><span class="n">cell</span><span class="p">,</span><span class="n">nn</span><span class="p">,</span><span class="n">g</span><span class="p">)</span>
<a name="ln-653"></a>  <span class="k">else</span>
<a name="ln-654"></a><span class="k">    call </span><span class="n">init_STEM_ZA</span><span class="p">(</span><span class="n">STEM</span><span class="p">,</span><span class="n">cell</span><span class="p">,</span><span class="n">F</span><span class="p">,</span><span class="n">Dyn</span><span class="p">,</span><span class="n">khead</span><span class="p">,</span><span class="n">reflist</span><span class="p">,</span><span class="n">nn</span><span class="p">)</span>
<a name="ln-655"></a>  <span class="k">end if</span>
<a name="ln-656"></a><span class="k">end if </span>
<a name="ln-657"></a>
<a name="ln-658"></a><span class="k">end subroutine </span><span class="n">read_STEM_data</span>
<a name="ln-659"></a>
<a name="ln-660"></a><span class="k">end module </span><span class="n">STEMmodule</span>
</pre></div>

    </section>
    </div>
  </div>

  <section class="visible-xs visible-sm hidden-md">
    <hr>
    

<div class="panel panel-default">
  <div class="panel-heading text-left"><h3 class="panel-title"><a data-toggle="collapse" href="#allfiles-1">All Source Files</a></h3></div>
  <div id="allfiles-1" class="panel-collapse collapse">
    <div class="list-group">
      
      <a class="list-group-item" href="../sourcefile/apb.f90.html">apb.f90</a>
      
      <a class="list-group-item" href="../sourcefile/bobyqa.f90.html">bobyqa.f90</a>
      
      <a class="list-group-item" href="../sourcefile/bobyqa_refinement.f90.html">bobyqa_refinement.f90</a>
      
      <a class="list-group-item" href="../sourcefile/clsupport.f90.html">CLsupport.f90</a>
      
      <a class="list-group-item" href="../sourcefile/constants.f90.html">constants.f90</a>
      
      <a class="list-group-item" href="../sourcefile/defectmodule.f90.html">defectmodule.f90</a>
      
      <a class="list-group-item" href="../sourcefile/dictmod.f90.html">dictmod.f90</a>
      
      <a class="list-group-item" href="../sourcefile/dispfield.f90.html">dispfield.f90</a>
      
      <a class="list-group-item" href="../sourcefile/distortion.f90.html">distortion.f90</a>
      
      <a class="list-group-item" href="../sourcefile/eccimod.f90.html">ECCImod.f90</a>
      
      <a class="list-group-item" href="../sourcefile/eispack.f90.html">eispack.f90</a>
      
      <a class="list-group-item" href="../sourcefile/emdymod.f90.html">EMdymod.f90</a>
      
      <a class="list-group-item" href="../sourcefile/filters.f90.html">filters.f90</a>
      
      <a class="list-group-item" href="../sourcefile/hdftest.f90.html">hdftest.f90</a>
      
      <a class="list-group-item" href="../sourcefile/indexingmod.f90.html">Indexingmod.f90</a>
      
      <a class="list-group-item" href="../sourcefile/initializers.f90.html">initializers.f90</a>
      
      <a class="list-group-item" href="../sourcefile/jsonsupport.f90.html">JSONsupport.f90</a>
      
      <a class="list-group-item" href="../sourcefile/muellercalculus.f90.html">MuellerCalculus.f90</a>
      
      <a class="list-group-item" href="../sourcefile/multibeams.f90.html">multibeams.f90</a>
      
      <a class="list-group-item" href="../sourcefile/namelisthandlers.f90.html">NameListHandlers.f90</a>
      
      <a class="list-group-item" href="../sourcefile/namelistjsonwriters.f90.html">NameListJSONwriters.f90</a>
      
      <a class="list-group-item" href="../sourcefile/namelisttypedefs.f90.html">NameListTypedefs.f90</a>
      
      <a class="list-group-item" href="../sourcefile/noise.f90.html">noise.f90</a>
      
      <a class="list-group-item" href="../sourcefile/others.f90.html">others.f90</a>
      
      <a class="list-group-item" href="../sourcefile/pedmod.f90.html">PEDmod.f90</a>
      
      <a class="list-group-item" href="../sourcefile/pfinversion.f90.html">PFInversion.f90</a>
      
      <a class="list-group-item" href="../sourcefile/pgm.f90.html">pgm.f90</a>
      
      <a class="list-group-item" href="../sourcefile/povray.f90.html">povray.f90</a>
      
      <a class="list-group-item" href="../sourcefile/rng.f90.html">rng.f90</a>
      
      <a class="list-group-item" href="../sourcefile/simulated_annealing.f90.html">simulated_annealing.f90</a>
      
      <a class="list-group-item" href="../sourcefile/so3.f90.html">so3.f90</a>
      
      <a class="list-group-item" href="../sourcefile/stemmodule.f90.html">STEMmodule.f90</a>
      
      <a class="list-group-item" href="../sourcefile/timing.f90.html">timing.f90</a>
      
    </div>
  </div>
</div>


  </section>
  
    <hr>    
    </div> <!-- /container -->
    <footer>
      <div class="container">
      <div class="row">
        <div class="col-xs-6 col-md-4"><p>&copy; 2017 <a rel="license" href="http://www.freebsd.org/copyright/freebsd-doc-license.html">FreeBSD Documentation License</a></p></div>
        <div class="col-xs-6 col-md-4 col-md-push-4">
          <p class="text-right">
            Documentation generated by 
            <a href="https://github.com/cmacmackin/ford">FORD</a>
            
          </p>
        </div>
        <div class="col-xs-12 col-md-4 col-md-pull-4"><p class="text-center"> Fortran Program was developed by Marc De Graef Research Group/Carnegie Mellon University</p></div>
      </div>
      <br>
      </div> <!-- /container -->    
    </footer>

    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
<!--
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
-->
    <script src="../js/bootstrap.min.js"></script>
    <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
    <script src="../js/ie10-viewport-bug-workaround.js"></script>

    <!-- MathJax JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        TeX: { extensions: ['AMSmath.js','AMSsymbols.js','noErrors.js','noUndefined.js'], equationNumbers: { autoNumber: 'AMS' } },
        jax: ['input/TeX','input/MathML','output/HTML-CSS'],
        extensions: ['tex2jax.js','mml2jax.js','MathMenu.js','MathZoom.js'],
        'HTML-CSS': { 
           styles: { '.MathJax_Display, .MathJax .mo, .MathJax .mi, .MathJax .mn': {color: '#000000 ! important'} }
        }
      });
    </script>
    <script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
  </body>
</html>