<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
	 
	 <meta name="description" content="EMsoft main library">
    
    <meta name="author" content="Marc De Graef Research Group/Carnegie Mellon University" >
    <link rel="icon" href="../favicon.png">

    <title>defectmodule.f90 &ndash; Fortran Program</title>

    <link href="../css/bootstrap.min.css" rel="stylesheet">
    <link href="../css/pygments.css" rel="stylesheet">
    <link href="../css/font-awesome.min.css" rel="stylesheet">
    <link href="../css/local.css" rel="stylesheet">
    

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    
    <script src="../js/jquery-2.1.3.min.js"></script>
    <script src="../js/svg-pan-zoom.min.js"></script>

    
    <script src="../tipuesearch/tipuesearch_content.js"></script>
    <link  href="../tipuesearch/tipuesearch.css" rel="stylesheet">
    <script src="../tipuesearch/tipuesearch_set.js"></script>
    <script src="../tipuesearch/tipuesearch.js"></script>
    

  </head>

  <body>

    <!-- Fixed navbar -->
    <nav class="navbar navbar-inverse navbar-fixed-top">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="../index.html">Fortran Program </a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
				
            <li class="dropdown hidden-xs visible-sm visible-md hidden-lg">
              <a href="#" class="dropdown-toggle"
              data-toggle="dropdown" role="button"
              aria-haspopup="true"
		 aria-expanded="false">Contents <span class="caret"></span></a>
	      <ul class="dropdown-menu">
              
            <li><a href="../lists/files.html">Source Files</a></li>
				
				
            <li><a href="../lists/modules.html">Modules</a></li>
				
            
                                
            <li><a href="../lists/procedures.html">Procedures</a></li>
				
				
            <li><a href="../lists/absint.html">Abstract Interfaces</a></li>
								
            <li><a href="../lists/types.html">Derived Types</a></li>
				
				
            <li><a href="../lists/programs.html">Programs</a></li>
				
            </ul>
            </li>

<li class="visible-xs hidden-sm visible-lg"><a href="../lists/files.html">Source Files</a></li>


<li class="visible-xs hidden-sm visible-lg"><a href="../lists/modules.html">Modules</a></li>



<li class="visible-xs hidden-sm visible-lg"><a href="../lists/procedures.html">Procedures</a></li>


<li class="visible-xs hidden-sm visible-lg"><a href="../lists/absint.html">Abstract Interfaces</a></li>
                             
<li class="visible-xs hidden-sm visible-lg"><a href="../lists/types.html">Derived Types</a></li>


<li class="visible-xs hidden-sm visible-lg"><a href="../lists/programs.html">Programs</a></li>

          </ul>
        
        <form action="../search.html" class="navbar-form navbar-right" role="search">
        <div class="form-group">
          <input type="text" class="form-control" placeholder="Search" name="q" id="tipue_search_input" autocomplete="off" required>
        </div>
<!--
        <button type="submit" class="btn btn-default">Submit</button>
-->
        </form>
        
        </div><!--/.nav-collapse -->
      </div>
    </nav>

    <div class="container">
    
  
  <div class="row">
    <h1>defectmodule.f90
    <small>Source File</small>
    
    </h1>
    
<div class="row">
  <div class="col-lg-12">
<div class="well well-sm">
  <ul class="list-inline" style="margin-bottom:0px;display:inline">
     
     
     
     
    
    
     <li><i class="fa fa-list-ol"></i>
       <a data-toggle="tooltip"
	  data-placement="bottom" data-html="true"
	  title=" 4.2% of total for source files.">1291 statements</a>
     </li> 
     
     
    <li><i class="fa fa-code"></i><a href="../src/defectmodule.f90"> Source File</a></li>
     
  </ul>
  <ol class="breadcrumb in-well text-right">
  
     <li class="active">defectmodule.f90</li>
  </ol>
</div>
</div>
</div>
<script>
  $(function () {
  $('[data-toggle="tooltip"]').tooltip()
  })
</script>

  </div>
  <div class="row">
    <div class="col-md-3 hidden-xs hidden-sm visible-md visible-lg">
    
<div id="sidebar">
  






<div class="panel panel-primary">
  <div class="panel-heading text-left"><h3 class="panel-title"><a data-toggle="collapse" href="#mods-0">Modules</a></h3></div>
  <div id="mods-0" class="panel-collapse collapse">
    <div class="list-group">
      
      <a class="list-group-item" href="../module/defectmodule.html">defectmodule</a>
      
    </div>
  </div>
</div>















<div class="panel panel-primary">
  <div class="panel-heading text-left"><h3 class="panel-title">Source Code</h3></div>
  <div class="list-group">
    <a class="list-group-item" href="../sourcefile/defectmodule.f90.html#src">defectmodule.f90</a>
  </div>
</div>


  <hr>
  

<div class="panel panel-default">
  <div class="panel-heading text-left"><h3 class="panel-title"><a data-toggle="collapse" href="#allfiles-0">All Source Files</a></h3></div>
  <div id="allfiles-0" class="panel-collapse collapse">
    <div class="list-group">
      
      <a class="list-group-item" href="../sourcefile/apb.f90.html">apb.f90</a>
      
      <a class="list-group-item" href="../sourcefile/bobyqa.f90.html">bobyqa.f90</a>
      
      <a class="list-group-item" href="../sourcefile/bobyqa_refinement.f90.html">bobyqa_refinement.f90</a>
      
      <a class="list-group-item" href="../sourcefile/clsupport.f90.html">CLsupport.f90</a>
      
      <a class="list-group-item" href="../sourcefile/constants.f90.html">constants.f90</a>
      
      <a class="list-group-item" href="../sourcefile/defectmodule.f90.html">defectmodule.f90</a>
      
      <a class="list-group-item" href="../sourcefile/dictmod.f90.html">dictmod.f90</a>
      
      <a class="list-group-item" href="../sourcefile/dispfield.f90.html">dispfield.f90</a>
      
      <a class="list-group-item" href="../sourcefile/distortion.f90.html">distortion.f90</a>
      
      <a class="list-group-item" href="../sourcefile/eccimod.f90.html">ECCImod.f90</a>
      
      <a class="list-group-item" href="../sourcefile/eispack.f90.html">eispack.f90</a>
      
      <a class="list-group-item" href="../sourcefile/emdymod.f90.html">EMdymod.f90</a>
      
      <a class="list-group-item" href="../sourcefile/filters.f90.html">filters.f90</a>
      
      <a class="list-group-item" href="../sourcefile/hdftest.f90.html">hdftest.f90</a>
      
      <a class="list-group-item" href="../sourcefile/indexingmod.f90.html">Indexingmod.f90</a>
      
      <a class="list-group-item" href="../sourcefile/initializers.f90.html">initializers.f90</a>
      
      <a class="list-group-item" href="../sourcefile/jsonsupport.f90.html">JSONsupport.f90</a>
      
      <a class="list-group-item" href="../sourcefile/muellercalculus.f90.html">MuellerCalculus.f90</a>
      
      <a class="list-group-item" href="../sourcefile/multibeams.f90.html">multibeams.f90</a>
      
      <a class="list-group-item" href="../sourcefile/namelisthandlers.f90.html">NameListHandlers.f90</a>
      
      <a class="list-group-item" href="../sourcefile/namelistjsonwriters.f90.html">NameListJSONwriters.f90</a>
      
      <a class="list-group-item" href="../sourcefile/namelisttypedefs.f90.html">NameListTypedefs.f90</a>
      
      <a class="list-group-item" href="../sourcefile/noise.f90.html">noise.f90</a>
      
      <a class="list-group-item" href="../sourcefile/others.f90.html">others.f90</a>
      
      <a class="list-group-item" href="../sourcefile/pedmod.f90.html">PEDmod.f90</a>
      
      <a class="list-group-item" href="../sourcefile/pfinversion.f90.html">PFInversion.f90</a>
      
      <a class="list-group-item" href="../sourcefile/pgm.f90.html">pgm.f90</a>
      
      <a class="list-group-item" href="../sourcefile/povray.f90.html">povray.f90</a>
      
      <a class="list-group-item" href="../sourcefile/rng.f90.html">rng.f90</a>
      
      <a class="list-group-item" href="../sourcefile/simulated_annealing.f90.html">simulated_annealing.f90</a>
      
      <a class="list-group-item" href="../sourcefile/so3.f90.html">so3.f90</a>
      
      <a class="list-group-item" href="../sourcefile/stemmodule.f90.html">STEMmodule.f90</a>
      
      <a class="list-group-item" href="../sourcefile/timing.f90.html">timing.f90</a>
      
    </div>
  </div>
</div>


</div>  

    </div>
    <div class="col-md-9" id='text'>
    
    
    <h3>This File Depends On</h3>
    
                <div class="depgraph"><?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.38.0 (20140413.2041)
 -->
<!-- Title: sourcefile~~defectmodule.f90~~EfferentGraph Pages: 1 -->
<svg id="sourcefiledefectmodulef90EfferentGraph" width="536pt" height="83pt"
 viewBox="0.00 0.00 536.00 83.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="sourcefile~~defectmodule.f90~~EfferentGraph" class="graph" transform="scale(1 1) rotate(0) translate(4 79)">
<title>sourcefile~~defectmodule.f90~~EfferentGraph</title>
<polygon fill="white" stroke="none" points="-4,4 -4,-79 532,-79 532,4 -4,4"/>
<!-- sourcefile~defectmodule.f90 -->
<g id="sourcefile~~defectmodule.f90~~EfferentGraph_node1" class="node"><title>sourcefile~defectmodule.f90</title>
<polygon fill="none" stroke="black" points="528,-65 435,-65 435,-41 528,-41 528,-65"/>
<text text-anchor="middle" x="481.5" y="-50.6" font-family="Helvetica,sans-Serif" font-size="10.50">defectmodule.f90</text>
</g>
<!-- sourcefile~jsonsupport.f90 -->
<g id="sourcefile~~defectmodule.f90~~EfferentGraph_node2" class="node"><title>sourcefile~jsonsupport.f90</title>
<g id="a_sourcefile~~defectmodule.f90~~EfferentGraph_node2"><a xlink:href="../sourcefile/jsonsupport.f90.html" xlink:title="JSONsupport.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="399,-45 306,-45 306,-21 399,-21 399,-45"/>
<text text-anchor="middle" x="352.5" y="-30.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">JSONsupport.f90</text>
</a>
</g>
</g>
<!-- sourcefile~jsonsupport.f90&#45;&gt;sourcefile~defectmodule.f90 -->
<g id="sourcefile~~defectmodule.f90~~EfferentGraph_edge5" class="edge"><title>sourcefile~jsonsupport.f90&#45;&gt;sourcefile~defectmodule.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M399.35,-40.2205C407.533,-41.5091 416.141,-42.8647 424.568,-44.1918"/>
<polygon fill="#ff0000" stroke="#ff0000" points="424.295,-47.6918 434.717,-45.7901 425.384,-40.777 424.295,-47.6918"/>
</g>
<!-- sourcefile~constants.f90 -->
<g id="sourcefile~~defectmodule.f90~~EfferentGraph_node3" class="node"><title>sourcefile~constants.f90</title>
<g id="a_sourcefile~~defectmodule.f90~~EfferentGraph_node3"><a xlink:href="../sourcefile/constants.f90.html" xlink:title="constants.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="96.5,-75 21.5,-75 21.5,-51 96.5,-51 96.5,-75"/>
<text text-anchor="middle" x="59" y="-60.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">constants.f90</text>
</a>
</g>
</g>
<!-- sourcefile~constants.f90&#45;&gt;sourcefile~defectmodule.f90 -->
<g id="sourcefile~~defectmodule.f90~~EfferentGraph_edge6" class="edge"><title>sourcefile~constants.f90&#45;&gt;sourcefile~defectmodule.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M96.581,-62.1301C170.313,-60.3766 337.18,-56.4083 424.639,-54.3284"/>
<polygon fill="#ff0000" stroke="#ff0000" points="424.985,-57.8213 434.899,-54.0844 424.819,-50.8233 424.985,-57.8213"/>
</g>
<!-- sourcefile~namelisthandlers.f90 -->
<g id="sourcefile~~defectmodule.f90~~EfferentGraph_node4" class="node"><title>sourcefile~namelisthandlers.f90</title>
<g id="a_sourcefile~~defectmodule.f90~~EfferentGraph_node4"><a xlink:href="../sourcefile/namelisthandlers.f90.html" xlink:title="NameListHandlers.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="270,-45 154,-45 154,-21 270,-21 270,-45"/>
<text text-anchor="middle" x="212" y="-30.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">NameListHandlers.f90</text>
</a>
</g>
</g>
<!-- sourcefile~constants.f90&#45;&gt;sourcefile~namelisthandlers.f90 -->
<g id="sourcefile~~defectmodule.f90~~EfferentGraph_edge2" class="edge"><title>sourcefile~constants.f90&#45;&gt;sourcefile~namelisthandlers.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M96.5529,-55.7378C110.792,-52.9088 127.577,-49.5741 143.839,-46.3432"/>
<polygon fill="#ff0000" stroke="#ff0000" points="144.743,-49.7321 153.87,-44.3504 143.379,-42.8662 144.743,-49.7321"/>
</g>
<!-- sourcefile~namelisthandlers.f90&#45;&gt;sourcefile~jsonsupport.f90 -->
<g id="sourcefile~~defectmodule.f90~~EfferentGraph_edge3" class="edge"><title>sourcefile~namelisthandlers.f90&#45;&gt;sourcefile~jsonsupport.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M270.133,-33C278.609,-33 287.335,-33 295.781,-33"/>
<polygon fill="#ff0000" stroke="#ff0000" points="295.91,-36.5001 305.91,-33 295.91,-29.5001 295.91,-36.5001"/>
</g>
<!-- sourcefile~namelisttypedefs.f90 -->
<g id="sourcefile~~defectmodule.f90~~EfferentGraph_node5" class="node"><title>sourcefile~namelisttypedefs.f90</title>
<g id="a_sourcefile~~defectmodule.f90~~EfferentGraph_node5"><a xlink:href="../sourcefile/namelisttypedefs.f90.html" xlink:title="NameListTypedefs.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="118,-24 0,-24 0,-0 118,-0 118,-24"/>
<text text-anchor="middle" x="59" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">NameListTypedefs.f90</text>
</a>
</g>
</g>
<!-- sourcefile~namelisttypedefs.f90&#45;&gt;sourcefile~jsonsupport.f90 -->
<g id="sourcefile~~defectmodule.f90~~EfferentGraph_edge4" class="edge"><title>sourcefile~namelisttypedefs.f90&#45;&gt;sourcefile~jsonsupport.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M118.185,-8.0863C160.476,-6.19184 219.002,-5.53527 270,-12 280.876,-13.3787 292.378,-15.7532 303.204,-18.4213"/>
<polygon fill="#ff0000" stroke="#ff0000" points="302.362,-21.8185 312.92,-20.934 304.115,-15.0415 302.362,-21.8185"/>
</g>
<!-- sourcefile~namelisttypedefs.f90&#45;&gt;sourcefile~namelisthandlers.f90 -->
<g id="sourcefile~~defectmodule.f90~~EfferentGraph_edge1" class="edge"><title>sourcefile~namelisttypedefs.f90&#45;&gt;sourcefile~namelisthandlers.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M118.381,-20.1191C126.641,-21.2679 135.19,-22.4568 143.603,-23.6268"/>
<polygon fill="#ff0000" stroke="#ff0000" points="143.382,-27.1298 153.769,-25.0407 144.346,-20.1965 143.382,-27.1298"/>
</g>
</g>
</svg>
</div>
                <div><a type="button" class="graph-help" data-toggle="modal" href="#graph-help-text">Help</a></div>
                <div class="modal fade" id="graph-help-text" tabindex="-1" role="dialog">
                  <div class="modal-dialog modal-lg" role="document">
                    <div class="modal-content">
                      <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                        <h4 class="modal-title" id="-graph-help-label">Graph Key</h4>
                      </div>
                      <div class="modal-body">
                        
    <p>Nodes of different colours represent the following: </p>
    <?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.38.0 (20140413.2041)
 -->
<!-- Title: Graph Key Pages: 1 -->
<svg width="188pt" height="32pt"
 viewBox="0.00 0.00 188.00 32.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 28)">
<title>Graph Key</title>
<polygon fill="white" stroke="none" points="-4,4 -4,-28 184,-28 184,4 -4,4"/>
<!-- Source File -->
<g id="node1" class="node"><title>Source File</title>
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="66,-24 0,-24 0,-0 66,-0 66,-24"/>
<text text-anchor="middle" x="33" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Source File</text>
</g>
<!-- This Page&#39;s Entity -->
<g id="node2" class="node"><title>This Page&#39;s Entity</title>
<polygon fill="none" stroke="black" points="180,-24 84,-24 84,-0 180,-0 180,-24"/>
<text text-anchor="middle" x="132" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50">This Page&#39;s Entity</text>
</g>
</g>
</svg>

    
    <p>Solid arrows point from a file to a file which depends upon it. A file 
    is dependent upon another if the latter must be compiled before the former
    can be. Where possible, edges connecting nodes are given different colours to make them easier to distinguish in large graphs.
    </p>
    
                      </div>
                    </div>
                  </div>
                </div>
                
    
      
      <h3>Files Dependent On This One</h3>
      
                <div class="depgraph"><?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.38.0 (20140413.2041)
 -->
<!-- Title: sourcefile~~defectmodule.f90~~AfferentGraph Pages: 1 -->
<svg id="sourcefiledefectmodulef90AfferentGraph" width="206pt" height="32pt"
 viewBox="0.00 0.00 206.00 32.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="sourcefile~~defectmodule.f90~~AfferentGraph" class="graph" transform="scale(1 1) rotate(0) translate(4 28)">
<title>sourcefile~~defectmodule.f90~~AfferentGraph</title>
<polygon fill="white" stroke="none" points="-4,4 -4,-28 202,-28 202,4 -4,4"/>
<!-- sourcefile~defectmodule.f90 -->
<g id="sourcefile~~defectmodule.f90~~AfferentGraph_node1" class="node"><title>sourcefile~defectmodule.f90</title>
<polygon fill="none" stroke="black" points="93,-24 0,-24 0,-0 93,-0 93,-24"/>
<text text-anchor="middle" x="46.5" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50">defectmodule.f90</text>
</g>
<!-- sourcefile~dispfield.f90 -->
<g id="sourcefile~~defectmodule.f90~~AfferentGraph_node2" class="node"><title>sourcefile~dispfield.f90</title>
<g id="a_sourcefile~~defectmodule.f90~~AfferentGraph_node2"><a xlink:href="../sourcefile/dispfield.f90.html" xlink:title="dispfield.f90">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="198,-24 129,-24 129,-0 198,-0 198,-24"/>
<text text-anchor="middle" x="163.5" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">dispfield.f90</text>
</a>
</g>
</g>
<!-- sourcefile~defectmodule.f90&#45;&gt;sourcefile~dispfield.f90 -->
<g id="sourcefile~~defectmodule.f90~~AfferentGraph_edge1" class="edge"><title>sourcefile~defectmodule.f90&#45;&gt;sourcefile~dispfield.f90</title>
<path fill="none" stroke="#ff0000" stroke-dasharray="5,2" d="M93.2815,-12C101.649,-12 110.363,-12 118.672,-12"/>
<polygon fill="#ff0000" stroke="#ff0000" points="118.925,-15.5001 128.924,-12 118.924,-8.5001 118.925,-15.5001"/>
</g>
</g>
</svg>
</div>
                <div><a type="button" class="graph-help" data-toggle="modal" href="#graph-help-text">Help</a></div>
                <div class="modal fade" id="graph-help-text" tabindex="-1" role="dialog">
                  <div class="modal-dialog modal-lg" role="document">
                    <div class="modal-content">
                      <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                        <h4 class="modal-title" id="-graph-help-label">Graph Key</h4>
                      </div>
                      <div class="modal-body">
                        
    <p>Nodes of different colours represent the following: </p>
    <?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.38.0 (20140413.2041)
 -->
<!-- Title: Graph Key Pages: 1 -->
<svg width="188pt" height="32pt"
 viewBox="0.00 0.00 188.00 32.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 28)">
<title>Graph Key</title>
<polygon fill="white" stroke="none" points="-4,4 -4,-28 184,-28 184,4 -4,4"/>
<!-- Source File -->
<g id="node1" class="node"><title>Source File</title>
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="66,-24 0,-24 0,-0 66,-0 66,-24"/>
<text text-anchor="middle" x="33" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Source File</text>
</g>
<!-- This Page&#39;s Entity -->
<g id="node2" class="node"><title>This Page&#39;s Entity</title>
<polygon fill="none" stroke="black" points="180,-24 84,-24 84,-0 180,-0 180,-24"/>
<text text-anchor="middle" x="132" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50">This Page&#39;s Entity</text>
</g>
</g>
</svg>

    
    <p>Solid arrows point from a file to a file which depends upon it. A file 
    is dependent upon another if the latter must be compiled before the former
    can be. Where possible, edges connecting nodes are given different colours to make them easier to distinguish in large graphs.
    </p>
    
                      </div>
                    </div>
                  </div>
                </div>
                
      
      <br>

    <section class="visible-xs visible-sm hidden-md">
      






<div class="panel panel-primary">
  <div class="panel-heading text-left"><h3 class="panel-title"><a data-toggle="collapse" href="#mods-1">Modules</a></h3></div>
  <div id="mods-1" class="panel-collapse collapse">
    <div class="list-group">
      
      <a class="list-group-item" href="../module/defectmodule.html">defectmodule</a>
      
    </div>
  </div>
</div>















<div class="panel panel-primary">
  <div class="panel-heading text-left"><h3 class="panel-title">Source Code</h3></div>
  <div class="list-group">
    <a class="list-group-item" href="../sourcefile/defectmodule.f90.html#src">defectmodule.f90</a>
  </div>
</div>


    </section>
    <br class="visible-xs visible-sm hidden-md">

    <section>
      <h2><span class="anchor" id="src"></span>Source Code</h2>
    <div class="hl"><pre><span></span><a name="ln-1"></a><span class="c">! ###################################################################</span>
<a name="ln-2"></a><span class="c">! Copyright (c) 2013-2015, Marc De Graef/Carnegie Mellon University</span>
<a name="ln-3"></a><span class="c">! All rights reserved.</span>
<a name="ln-4"></a><span class="c">!</span>
<a name="ln-5"></a><span class="c">! Redistribution and use in source and binary forms, with or without modification, are </span>
<a name="ln-6"></a><span class="c">! permitted provided that the following conditions are met:</span>
<a name="ln-7"></a><span class="c">!</span>
<a name="ln-8"></a><span class="c">!     - Redistributions of source code must retain the above copyright notice, this list </span>
<a name="ln-9"></a><span class="c">!        of conditions and the following disclaimer.</span>
<a name="ln-10"></a><span class="c">!     - Redistributions in binary form must reproduce the above copyright notice, this </span>
<a name="ln-11"></a><span class="c">!        list of conditions and the following disclaimer in the documentation and/or </span>
<a name="ln-12"></a><span class="c">!        other materials provided with the distribution.</span>
<a name="ln-13"></a><span class="c">!     - Neither the names of Marc De Graef, Carnegie Mellon University nor the names </span>
<a name="ln-14"></a><span class="c">!        of its contributors may be used to endorse or promote products derived from </span>
<a name="ln-15"></a><span class="c">!        this software without specific prior written permission.</span>
<a name="ln-16"></a><span class="c">!</span>
<a name="ln-17"></a><span class="c">! THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &quot;AS IS&quot; </span>
<a name="ln-18"></a><span class="c">! AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE </span>
<a name="ln-19"></a><span class="c">! IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE </span>
<a name="ln-20"></a><span class="c">! ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE </span>
<a name="ln-21"></a><span class="c">! LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL </span>
<a name="ln-22"></a><span class="c">! DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR </span>
<a name="ln-23"></a><span class="c">! SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER </span>
<a name="ln-24"></a><span class="c">! CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, </span>
<a name="ln-25"></a><span class="c">! OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE </span>
<a name="ln-26"></a><span class="c">! USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span>
<a name="ln-27"></a><span class="c">! ###################################################################</span>
<a name="ln-28"></a>
<a name="ln-29"></a>
<a name="ln-30"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-31"></a><span class="c">! EMsoft:defectmodule.f90</span>
<a name="ln-32"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-33"></a><span class="c">!</span>
<a name="ln-34"></a><span class="c">! MODULE: defectmodule</span>
<a name="ln-35"></a><span class="c">!</span>
<a name="ln-36"></a><span class="c">!&gt; @author Marc De Graef, Carnegie Mellon University</span>
<a name="ln-37"></a><span class="c">!</span>
<a name="ln-38"></a><span class="c">!&gt; @brief Provides a routine to compute the displacement vector for an array of defects.</span>
<a name="ln-39"></a><span class="c">! </span>
<a name="ln-40"></a><span class="c">!&gt; @date 04/29/11 MDG 1.0 original</span>
<a name="ln-41"></a><span class="c">!&gt; @date 06/04/13 MDG 2.0 rewrite + quaternions instead of rotations</span>
<a name="ln-42"></a><span class="c">!&gt; @date 11/13/13 MDG 2.1 fixed error with coordinate transformations (after very long bug search!)</span>
<a name="ln-43"></a><span class="c">!&gt; @date 11/17/15 MDG 3.0 start of complete rewrite; this mod will now include a routine to read all defect info from a json file</span>
<a name="ln-44"></a><span class="c">!&gt; @date 11/23/15 MDG 3.1 inserted all defect mods into this file instead of separate files</span>
<a name="ln-45"></a><span class="c">!&gt; @date 12/08/15 MDG 3.2 added artificial distortion to inclusion field to mimic ellipsoidal shape (needs Eshelby for correct field)</span>
<a name="ln-46"></a><span class="c">!&gt; @date 12/11/15 MDG 3.3 gave up on previous item and implemented full isotropic Eshelby ellipsoidal inclusion</span>
<a name="ln-47"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-48"></a><span class="k">module </span><span class="n">defectmodule</span>
<a name="ln-49"></a>
<a name="ln-50"></a><span class="k">use </span><span class="n">local</span>
<a name="ln-51"></a><span class="k">use </span><span class="n">quaternions</span>
<a name="ln-52"></a><span class="k">use </span><span class="n">typedefs</span>
<a name="ln-53"></a>
<a name="ln-54"></a>
<a name="ln-55"></a><span class="k">contains</span>
<a name="ln-56"></a>
<a name="ln-57"></a>
<a name="ln-58"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-59"></a><span class="c">!</span>
<a name="ln-60"></a><span class="c">! SUBROUTINE: InitializeDefects</span>
<a name="ln-61"></a><span class="c">!</span>
<a name="ln-62"></a><span class="c">!&gt; @author Marc De Graef, Carnegie Mellon University</span>
<a name="ln-63"></a><span class="c">!</span>
<a name="ln-64"></a><span class="c">!&gt; @brief read defect information, and generate all data that can be precomputed for each defect</span>
<a name="ln-65"></a><span class="c">!</span>
<a name="ln-66"></a><span class="c">!&gt; @date  11/22/15 MDG 1.0 original</span>
<a name="ln-67"></a><span class="c">!&gt; @date  11/24/15 MDG 1.1 added Ydislocations, stacking faults, inclusions and voids</span>
<a name="ln-68"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-69"></a><span class="k">recursive subroutine </span><span class="n">InitializeDefects</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span><span class="n">defects</span><span class="p">,</span><span class="n">jsonname</span><span class="p">,</span><span class="n">npix</span><span class="p">,</span><span class="n">npiy</span><span class="p">,</span><span class="n">L</span><span class="p">,</span><span class="n">gf</span><span class="p">,</span><span class="n">error_cnt</span><span class="p">,</span><span class="n">verbose</span><span class="p">)</span>
<a name="ln-70"></a><span class="c">!DEC$ ATTRIBUTES DLLEXPORT :: InitializeDefects</span>
<a name="ln-71"></a>
<a name="ln-72"></a><span class="k">use </span><span class="n">local</span>
<a name="ln-73"></a><span class="k">use </span><span class="n">typedefs</span>
<a name="ln-74"></a><span class="k">use </span><span class="n">io</span>
<a name="ln-75"></a><span class="k">use </span><span class="n">JSONsupport</span>
<a name="ln-76"></a>
<a name="ln-77"></a><span class="k">IMPLICIT NONE</span>
<a name="ln-78"></a>
<a name="ln-79"></a><span class="k">type</span><span class="p">(</span><span class="n">unitcell</span><span class="p">),</span><span class="k">pointer</span>                  <span class="kd">::</span> <span class="n">cell</span>
<a name="ln-80"></a><span class="k">type</span><span class="p">(</span><span class="n">defecttype</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">INOUT</span><span class="p">)</span>          <span class="kd">::</span> <span class="n">defects</span>
<a name="ln-81"></a><span class="kt">character</span><span class="p">(</span><span class="n">fnlen</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>             <span class="kd">::</span> <span class="n">jsonname</span>
<a name="ln-82"></a><span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">irg</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>            <span class="kd">::</span> <span class="n">npix</span>
<a name="ln-83"></a><span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">irg</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>            <span class="kd">::</span> <span class="n">npiy</span>
<a name="ln-84"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>               <span class="kd">::</span> <span class="n">L</span>
<a name="ln-85"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>               <span class="kd">::</span> <span class="n">gf</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-86"></a><span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">irg</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">INOUT</span><span class="p">)</span>         <span class="kd">::</span> <span class="n">error_cnt</span>
<a name="ln-87"></a><span class="kt">logical</span><span class="p">,</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">),</span><span class="k">OPTIONAL</span>             <span class="kd">::</span> <span class="n">verbose</span>
<a name="ln-88"></a>
<a name="ln-89"></a><span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">irg</span><span class="p">)</span>                       <span class="kd">::</span> <span class="n">v</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">io_int</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-90"></a>
<a name="ln-91"></a><span class="n">error_cnt</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-92"></a>
<a name="ln-93"></a><span class="n">v</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-94"></a><span class="k">if</span> <span class="p">(</span><span class="nb">PRESENT</span><span class="p">(</span><span class="n">verbose</span><span class="p">))</span> <span class="k">then</span>
<a name="ln-95"></a><span class="k">  if</span> <span class="p">(</span><span class="n">verbose</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-96"></a><span class="k">    </span><span class="n">v</span> <span class="o">=</span> <span class="mi">1</span>
<a name="ln-97"></a>  <span class="k">end if</span>
<a name="ln-98"></a><span class="k">end if</span>
<a name="ln-99"></a>
<a name="ln-100"></a><span class="n">defects</span><span class="p">%</span><span class="n">numdisl</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-101"></a><span class="n">defects</span><span class="p">%</span><span class="n">numYdisl</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-102"></a><span class="n">defects</span><span class="p">%</span><span class="n">numsf</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-103"></a><span class="n">defects</span><span class="p">%</span><span class="n">numvoids</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-104"></a><span class="n">defects</span><span class="p">%</span><span class="n">numinc</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-105"></a><span class="n">defects</span><span class="p">%</span><span class="n">numEinc</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-106"></a>
<a name="ln-107"></a><span class="c">! first of all, we need to read all the defect data from the jsonname file, including the foil data</span>
<a name="ln-108"></a><span class="k">call </span><span class="n">JSONreadDefectFile</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span> <span class="n">jsonname</span><span class="p">,</span> <span class="n">defects</span><span class="p">,</span> <span class="n">error_cnt</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
<a name="ln-109"></a>
<a name="ln-110"></a><span class="k">call </span><span class="n">Message</span><span class="p">(</span><span class="s1">&#39;The following defects were initialized : &#39;</span><span class="p">)</span>
<a name="ln-111"></a>  <span class="n">io_int</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">defects</span><span class="p">%</span><span class="n">numdisl</span>
<a name="ln-112"></a>  <span class="k">call </span><span class="n">WriteValue</span><span class="p">(</span><span class="s1">&#39;  Number of dislocations       : &#39;</span><span class="p">,</span><span class="n">io_int</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-113"></a>  <span class="n">io_int</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">defects</span><span class="p">%</span><span class="n">numYdisl</span>
<a name="ln-114"></a>  <span class="k">call </span><span class="n">WriteValue</span><span class="p">(</span><span class="s1">&#39;  Number of Yoffe dislocations : &#39;</span><span class="p">,</span><span class="n">io_int</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-115"></a>  <span class="n">io_int</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">defects</span><span class="p">%</span><span class="n">numsf</span>
<a name="ln-116"></a>  <span class="k">call </span><span class="n">WriteValue</span><span class="p">(</span><span class="s1">&#39;  Number of stacking faults    : &#39;</span><span class="p">,</span><span class="n">io_int</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-117"></a>  <span class="n">io_int</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">defects</span><span class="p">%</span><span class="n">numinc</span>
<a name="ln-118"></a>  <span class="k">call </span><span class="n">WriteValue</span><span class="p">(</span><span class="s1">&#39;  Number of inclusions         : &#39;</span><span class="p">,</span><span class="n">io_int</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-119"></a>  <span class="n">io_int</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">defects</span><span class="p">%</span><span class="n">numEinc</span>
<a name="ln-120"></a>  <span class="k">call </span><span class="n">WriteValue</span><span class="p">(</span><span class="s1">&#39;  Number of Eshelby inclusions : &#39;</span><span class="p">,</span><span class="n">io_int</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-121"></a>  <span class="n">io_int</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">defects</span><span class="p">%</span><span class="n">numvoids</span>
<a name="ln-122"></a>  <span class="k">call </span><span class="n">WriteValue</span><span class="p">(</span><span class="s1">&#39;  Number of voids              : &#39;</span><span class="p">,</span><span class="n">io_int</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-123"></a>
<a name="ln-124"></a><span class="c">! once we have this data, we need to initialize all other defect related parameters, including</span>
<a name="ln-125"></a><span class="c">! things like displacement field parameters etc...</span>
<a name="ln-126"></a>
<a name="ln-127"></a><span class="c">! we begin with the foil itself</span>
<a name="ln-128"></a><span class="k">call </span><span class="n">init_foil_data</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span><span class="n">defects</span><span class="p">,</span><span class="n">npix</span><span class="p">,</span><span class="n">npiy</span><span class="p">,</span><span class="n">L</span><span class="p">,</span><span class="n">v</span><span class="p">)</span>
<a name="ln-129"></a>
<a name="ln-130"></a><span class="c">! then we add the defects, starting with all the regular dislocations, if any</span>
<a name="ln-131"></a><span class="k">if</span> <span class="p">(</span><span class="n">defects</span><span class="p">%</span><span class="n">numdisl</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span> <span class="k">call </span><span class="n">init_dislocation_data</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span><span class="n">defects</span><span class="p">,</span><span class="n">npix</span><span class="p">,</span><span class="n">npiy</span><span class="p">,</span><span class="n">gf</span><span class="p">,</span><span class="n">L</span><span class="p">,</span><span class="n">v</span><span class="p">)</span>
<a name="ln-132"></a>
<a name="ln-133"></a><span class="c">! then Ydislocations</span>
<a name="ln-134"></a><span class="k">if</span> <span class="p">(</span><span class="n">defects</span><span class="p">%</span><span class="n">numYdisl</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span> <span class="k">call </span><span class="n">init_YSH_dislocation_data</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span><span class="n">defects</span><span class="p">,</span><span class="n">npix</span><span class="p">,</span><span class="n">npiy</span><span class="p">,</span><span class="n">gf</span><span class="p">,</span><span class="n">L</span><span class="p">,</span><span class="n">v</span><span class="p">)</span>
<a name="ln-135"></a>
<a name="ln-136"></a><span class="c">! stacking faults</span>
<a name="ln-137"></a><span class="k">if</span> <span class="p">(</span><span class="n">defects</span><span class="p">%</span><span class="n">numsf</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span> <span class="k">call </span><span class="n">init_stacking_fault_data</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span><span class="n">defects</span><span class="p">,</span><span class="n">L</span><span class="p">,</span><span class="n">npix</span><span class="p">,</span><span class="n">npiy</span><span class="p">,</span><span class="n">gf</span><span class="p">,</span><span class="n">v</span><span class="p">)</span>
<a name="ln-138"></a>
<a name="ln-139"></a><span class="c">! inclusions</span>
<a name="ln-140"></a><span class="k">if</span> <span class="p">(</span><span class="n">defects</span><span class="p">%</span><span class="n">numinc</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span> <span class="k">call </span><span class="n">init_inclusion_data</span><span class="p">(</span><span class="n">defects</span><span class="p">,</span><span class="n">L</span><span class="p">,</span><span class="n">npix</span><span class="p">,</span><span class="n">npiy</span><span class="p">,</span><span class="n">v</span><span class="p">)</span>
<a name="ln-141"></a>
<a name="ln-142"></a><span class="c">! Eshelby inclusions</span>
<a name="ln-143"></a><span class="k">if</span> <span class="p">(</span><span class="n">defects</span><span class="p">%</span><span class="n">numEinc</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span> <span class="k">then </span>
<a name="ln-144"></a><span class="k">  do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">defects</span><span class="p">%</span><span class="n">numEinc</span> 
<a name="ln-145"></a>    <span class="k">call </span><span class="n">InitializeEshelbyInclusion</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span><span class="n">defects</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">v</span><span class="p">,</span><span class="n">L</span><span class="p">,</span><span class="n">npix</span><span class="p">,</span><span class="n">npiy</span><span class="p">)</span> 
<a name="ln-146"></a>  <span class="k">end do</span>
<a name="ln-147"></a><span class="k">end if</span>
<a name="ln-148"></a>
<a name="ln-149"></a><span class="c">! voids</span>
<a name="ln-150"></a><span class="k">if</span> <span class="p">(</span><span class="n">defects</span><span class="p">%</span><span class="n">numvoids</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span> <span class="k">call </span><span class="n">init_void_data</span><span class="p">(</span><span class="n">defects</span><span class="p">,</span><span class="n">L</span><span class="p">,</span><span class="n">npix</span><span class="p">,</span><span class="n">npiy</span><span class="p">,</span><span class="n">v</span><span class="p">)</span>
<a name="ln-151"></a>
<a name="ln-152"></a>
<a name="ln-153"></a><span class="k">end subroutine </span><span class="n">InitializeDefects</span>
<a name="ln-154"></a>
<a name="ln-155"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-156"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-157"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-158"></a><span class="c">! here are the init_defect_data subroutines</span>
<a name="ln-159"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-160"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-161"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-162"></a>
<a name="ln-163"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-164"></a><span class="c">!</span>
<a name="ln-165"></a><span class="c">! SUBROUTINE: init_foil_data</span>
<a name="ln-166"></a><span class="c">!</span>
<a name="ln-167"></a><span class="c">!&gt; @author Marc De Graef, Carnegie Mellon University</span>
<a name="ln-168"></a><span class="c">!</span>
<a name="ln-169"></a><span class="c">!&gt; @brief  initializes the foil geometry data</span>
<a name="ln-170"></a><span class="c">!</span>
<a name="ln-171"></a><span class="c">!&gt; @param cell unit cell pointer</span>
<a name="ln-172"></a><span class="c">!&gt; @param defects defects structure</span>
<a name="ln-173"></a><span class="c">!&gt; @param npix number of x image pixels</span>
<a name="ln-174"></a><span class="c">!&gt; @param npiy number of y image pixels</span>
<a name="ln-175"></a><span class="c">!&gt; @param L pixel size for column approximation</span>
<a name="ln-176"></a><span class="c">!&gt; @param dinfo flag to print information</span>
<a name="ln-177"></a><span class="c">! </span>
<a name="ln-178"></a><span class="c">!&gt; @date 11/22/15 MDG 1.0 new routine in Release 3.1; read portion replaced with JSONreadFoilData in JSONsupport</span>
<a name="ln-179"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-180"></a><span class="k">recursive subroutine </span><span class="n">init_foil_data</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span><span class="n">defects</span><span class="p">,</span><span class="n">npix</span><span class="p">,</span><span class="n">npiy</span><span class="p">,</span><span class="n">L</span><span class="p">,</span><span class="n">dinfo</span><span class="p">)</span>
<a name="ln-181"></a><span class="c">!DEC$ ATTRIBUTES DLLEXPORT :: init_foil_data</span>
<a name="ln-182"></a>
<a name="ln-183"></a><span class="k">use </span><span class="n">crystal</span>
<a name="ln-184"></a><span class="k">use </span><span class="n">io</span>
<a name="ln-185"></a><span class="k">use </span><span class="n">constants</span>
<a name="ln-186"></a><span class="k">use </span><span class="n">files</span>
<a name="ln-187"></a><span class="k">use </span><span class="n">rotations</span>
<a name="ln-188"></a><span class="k">use </span><span class="n">typedefs</span>
<a name="ln-189"></a>
<a name="ln-190"></a><span class="k">IMPLICIT NONE</span>
<a name="ln-191"></a>
<a name="ln-192"></a><span class="k">type</span><span class="p">(</span><span class="n">unitcell</span><span class="p">),</span><span class="k">pointer</span>          <span class="kd">::</span> <span class="n">cell</span>
<a name="ln-193"></a><span class="k">type</span><span class="p">(</span><span class="n">defecttype</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">INOUT</span><span class="p">)</span>  <span class="kd">::</span> <span class="n">defects</span>
<a name="ln-194"></a><span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">irg</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">npix</span><span class="p">,</span> <span class="n">npiy</span><span class="p">,</span> <span class="n">dinfo</span>
<a name="ln-195"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>       <span class="kd">::</span> <span class="n">L</span>
<a name="ln-196"></a>
<a name="ln-197"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">)</span>                  <span class="kd">::</span> <span class="n">io_real</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-198"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">dbl</span><span class="p">)</span>                  <span class="kd">::</span> <span class="n">amat</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-199"></a>
<a name="ln-200"></a><span class="c">! assign these values to the appropriate slots in foil%   [verified 4/23/11]</span>
<a name="ln-201"></a><span class="n">defects</span><span class="p">%</span><span class="n">foil</span><span class="p">%</span><span class="n">alP</span> <span class="o">=</span> <span class="n">defects</span><span class="p">%</span><span class="n">foil</span><span class="p">%</span><span class="n">alP</span><span class="o">*</span><span class="n">cPi</span><span class="o">/</span><span class="mi">18</span><span class="mf">0.0</span>            <span class="c">! convert the tilt and rotation angles to radians</span>
<a name="ln-202"></a><span class="n">defects</span><span class="p">%</span><span class="n">foil</span><span class="p">%</span><span class="n">alS</span> <span class="o">=</span> <span class="n">defects</span><span class="p">%</span><span class="n">foil</span><span class="p">%</span><span class="n">alS</span><span class="o">*</span><span class="n">cPi</span><span class="o">/</span><span class="mi">18</span><span class="mf">0.0</span>
<a name="ln-203"></a><span class="n">defects</span><span class="p">%</span><span class="n">foil</span><span class="p">%</span><span class="n">alR</span> <span class="o">=</span> <span class="n">defects</span><span class="p">%</span><span class="n">foil</span><span class="p">%</span><span class="n">alR</span><span class="o">*</span><span class="n">cPi</span><span class="o">/</span><span class="mi">18</span><span class="mf">0.0</span>
<a name="ln-204"></a><span class="n">defects</span><span class="p">%</span><span class="n">foil</span><span class="p">%</span><span class="n">npix</span> <span class="o">=</span> <span class="n">npix</span>                        <span class="c">! image size (this duplicates some values, but it&#39;s easier this way)</span>
<a name="ln-205"></a><span class="n">defects</span><span class="p">%</span><span class="n">foil</span><span class="p">%</span><span class="n">npiy</span> <span class="o">=</span> <span class="n">npiy</span>
<a name="ln-206"></a>
<a name="ln-207"></a><span class="c">! shape parameters</span>
<a name="ln-208"></a><span class="n">defects</span><span class="p">%</span><span class="n">foil</span><span class="p">%</span><span class="n">cpx</span> <span class="o">=</span> <span class="n">defects</span><span class="p">%</span><span class="n">foil</span><span class="p">%</span><span class="n">cpx</span> <span class="o">*</span> <span class="nb">float</span><span class="p">(</span><span class="n">npix</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">L</span>  <span class="c">! we&#39;ll define the foil shape center w.r.t. to the center of the image in [nm] coordinates</span>
<a name="ln-209"></a><span class="n">defects</span><span class="p">%</span><span class="n">foil</span><span class="p">%</span><span class="n">cpy</span> <span class="o">=</span> <span class="n">defects</span><span class="p">%</span><span class="n">foil</span><span class="p">%</span><span class="n">cpy</span> <span class="o">*</span> <span class="nb">float</span><span class="p">(</span><span class="n">npiy</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">L</span>  <span class="c">! </span>
<a name="ln-210"></a>
<a name="ln-211"></a><span class="c">! initialize a bunch of foil related quantities, using quaternions for all rotations</span>
<a name="ln-212"></a><span class="k">call </span><span class="n">initialize_foil_geometry</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span><span class="n">defects</span><span class="p">%</span><span class="n">foil</span><span class="p">,</span><span class="n">dinfo</span><span class="p">)</span>
<a name="ln-213"></a>
<a name="ln-214"></a><span class="c">! compute the projected thickness</span>
<a name="ln-215"></a><span class="n">amat</span> <span class="o">=</span> <span class="n">qu2om</span><span class="p">(</span><span class="n">defects</span><span class="p">%</span><span class="n">foil</span><span class="p">%</span><span class="n">a_fm</span><span class="p">)</span>
<a name="ln-216"></a><span class="n">defects</span><span class="p">%</span><span class="n">foil</span><span class="p">%</span><span class="n">zb</span> <span class="o">=</span> <span class="n">defects</span><span class="p">%</span><span class="n">foil</span><span class="p">%</span><span class="n">z0</span><span class="o">/</span><span class="n">amat</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-217"></a><span class="k">if</span> <span class="p">(</span><span class="n">dinfo</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-218"></a><span class="k">  </span><span class="n">io_real</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">=</span><span class="n">defects</span><span class="p">%</span><span class="n">foil</span><span class="p">%</span><span class="n">z0</span>
<a name="ln-219"></a>  <span class="k">call </span><span class="n">WriteValue</span><span class="p">(</span><span class="s1">&#39;Nominal foil thickness = &#39;</span><span class="p">,</span> <span class="n">io_real</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;(F8.3)&quot;</span><span class="p">)</span>
<a name="ln-220"></a>  <span class="n">io_real</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">=</span><span class="n">defects</span><span class="p">%</span><span class="n">foil</span><span class="p">%</span><span class="n">zb</span>
<a name="ln-221"></a>  <span class="k">call </span><span class="n">WriteValue</span><span class="p">(</span><span class="s1">&#39;Effective foil thickness = &#39;</span><span class="p">,</span> <span class="n">io_real</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;(F8.3/)&quot;</span><span class="p">)</span>
<a name="ln-222"></a><span class="k">end if</span>
<a name="ln-223"></a>
<a name="ln-224"></a><span class="k">end subroutine </span><span class="n">init_foil_data</span>
<a name="ln-225"></a>
<a name="ln-226"></a>
<a name="ln-227"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-228"></a><span class="c">!</span>
<a name="ln-229"></a><span class="c">! SUBROUTINE: init_dislocation_data</span>
<a name="ln-230"></a><span class="c">!</span>
<a name="ln-231"></a><span class="c">!&gt; @author Marc De Graef, Carnegie Mellon University</span>
<a name="ln-232"></a><span class="c">!</span>
<a name="ln-233"></a><span class="c">!&gt; @brief  init dislocation namelist files</span>
<a name="ln-234"></a><span class="c">!</span>
<a name="ln-235"></a><span class="c">!&gt; @param cell unit cell pointer</span>
<a name="ln-236"></a><span class="c">!&gt; @param defects defect structure</span>
<a name="ln-237"></a><span class="c">!&gt; @param DF_npix number of x-pixels</span>
<a name="ln-238"></a><span class="c">!&gt; @param DF_npiy number of y-pixels</span>
<a name="ln-239"></a><span class="c">!&gt; @param DF_gf </span>
<a name="ln-240"></a><span class="c">!&gt; @param L </span>
<a name="ln-241"></a><span class="c">!&gt; @param dinfo logical to trigger verbose output</span>
<a name="ln-242"></a><span class="c">! </span>
<a name="ln-243"></a><span class="c">!&gt; @date 01/05/99 MDG 1.0 original</span>
<a name="ln-244"></a><span class="c">!&gt; @date 05/19/01 MDG 2.0 f90 version</span>
<a name="ln-245"></a><span class="c">!&gt; @date 11/27/01 MDG 2.1 added kind support</span>
<a name="ln-246"></a><span class="c">!&gt; @date 06/04/13 MDG 3.0 rewrite</span>
<a name="ln-247"></a><span class="c">!&gt; @date 06/09/14 MDG 4.0 added cell, DL argument</span>
<a name="ln-248"></a><span class="c">!&gt; @date 11/22/15 MDG 4.1 old routine obsolete with Release 3.1; replaced by JsonreadDefectFile</span>
<a name="ln-249"></a><span class="c">!&gt; @date 11/23/15 MDG 4.2 moved from dislocation.f90 to defectmodule.f90</span>
<a name="ln-250"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-251"></a><span class="k">recursive subroutine </span><span class="n">init_dislocation_data</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span><span class="n">defects</span><span class="p">,</span><span class="n">DF_npix</span><span class="p">,</span><span class="n">DF_npiy</span><span class="p">,</span><span class="n">DF_gf</span><span class="p">,</span><span class="n">L</span><span class="p">,</span><span class="n">dinfo</span><span class="p">)</span>
<a name="ln-252"></a><span class="c">!DEC$ ATTRIBUTES DLLEXPORT :: init_dislocation_data</span>
<a name="ln-253"></a>
<a name="ln-254"></a><span class="k">use </span><span class="n">io</span>
<a name="ln-255"></a><span class="k">use </span><span class="n">files</span>
<a name="ln-256"></a>
<a name="ln-257"></a><span class="k">IMPLICIT NONE</span>
<a name="ln-258"></a>
<a name="ln-259"></a><span class="k">type</span><span class="p">(</span><span class="n">defecttype</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">INOUT</span><span class="p">)</span>          <span class="kd">::</span> <span class="n">defects</span>
<a name="ln-260"></a><span class="k">type</span><span class="p">(</span><span class="n">unitcell</span><span class="p">),</span><span class="k">pointer</span>                  <span class="kd">::</span> <span class="n">cell</span>
<a name="ln-261"></a><span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">irg</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>            <span class="kd">::</span> <span class="n">DF_npix</span><span class="p">,</span> <span class="n">DF_npiy</span><span class="p">,</span> <span class="n">dinfo</span>
<a name="ln-262"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>               <span class="kd">::</span> <span class="n">DF_gf</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">L</span>
<a name="ln-263"></a>
<a name="ln-264"></a><span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">irg</span><span class="p">)</span>                       <span class="kd">::</span> <span class="n">i</span>
<a name="ln-265"></a>
<a name="ln-266"></a><span class="c">! zfrac goes between -0.5 and +0.5, with -0.5 being the top surface and +0.5 the bottom</span>
<a name="ln-267"></a><span class="c">! this only really matters for dislocations that are parallel to the foil surfaces</span>
<a name="ln-268"></a>
<a name="ln-269"></a><span class="c">! loop over all regular dislocations and initialize their displacement field parameters</span>
<a name="ln-270"></a>   <span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">defects</span><span class="p">%</span><span class="n">numdisl</span>  <span class="c">! +2*defects%numsf   ! we do not deal with partials in stacking faults here ...</span>
<a name="ln-271"></a>    
<a name="ln-272"></a><span class="c">! center of dislocation inside the foil is transformed to foil coordinates [nm] with defects%DL(i)%kd=0 (center of foil) [verified 4/23/11]</span>
<a name="ln-273"></a><span class="c">! the point (0,0) is at the center of the image ... hence the factor of 0.5</span>
<a name="ln-274"></a>    <span class="n">defects</span><span class="p">%</span><span class="n">DL</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">id</span> <span class="o">=</span> <span class="n">defects</span><span class="p">%</span><span class="n">DL</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">id</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="nb">float</span><span class="p">(</span><span class="n">DF_npix</span><span class="p">)</span> <span class="c">! * L   scaling (zooming) is done later in the image reference frame...</span>
<a name="ln-275"></a>    <span class="n">defects</span><span class="p">%</span><span class="n">DL</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">jd</span> <span class="o">=</span> <span class="n">defects</span><span class="p">%</span><span class="n">DL</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">jd</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="nb">float</span><span class="p">(</span><span class="n">DF_npiy</span><span class="p">)</span> <span class="c">! * L</span>
<a name="ln-276"></a>    <span class="n">defects</span><span class="p">%</span><span class="n">DL</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">g</span> <span class="o">=</span> <span class="n">DF_gf</span>
<a name="ln-277"></a>     
<a name="ln-278"></a><span class="c">! and pre-compute the dislocation displacement field parameters</span>
<a name="ln-279"></a>    <span class="k">call </span><span class="n">makedislocation</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span><span class="n">defects</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">dinfo</span><span class="p">,</span> <span class="n">L</span><span class="p">)</span>
<a name="ln-280"></a>  <span class="k">end do</span>
<a name="ln-281"></a><span class="k">  </span>
<a name="ln-282"></a><span class="k">end subroutine </span><span class="n">init_dislocation_data</span>
<a name="ln-283"></a>
<a name="ln-284"></a>
<a name="ln-285"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-286"></a><span class="c">!</span>
<a name="ln-287"></a><span class="c">! SUBROUTINE: init_stacking_fault_data</span>
<a name="ln-288"></a><span class="c">!</span>
<a name="ln-289"></a><span class="c">!&gt; @author Marc De Graef, Carnegie Mellon University</span>
<a name="ln-290"></a><span class="c">!</span>
<a name="ln-291"></a><span class="c">!&gt; @brief  read stacking fault namelist files</span>
<a name="ln-292"></a><span class="c">!</span>
<a name="ln-293"></a><span class="c">!&gt; @param cell unit cell pointer</span>
<a name="ln-294"></a><span class="c">!&gt; @param defects defect structure</span>
<a name="ln-295"></a><span class="c">!&gt; @param DF_L </span>
<a name="ln-296"></a><span class="c">!&gt; @param DF_npix number of x-pixels</span>
<a name="ln-297"></a><span class="c">!&gt; @param DF_npiy number of y-pixels</span>
<a name="ln-298"></a><span class="c">!&gt; @param DF_gf </span>
<a name="ln-299"></a><span class="c">!&gt; @param dinfo logical to trigger verbose output</span>
<a name="ln-300"></a><span class="c">!&gt; @param ECCI logical optional to indicate ECCI formatting rather than regular TEM</span>
<a name="ln-301"></a><span class="c">! </span>
<a name="ln-302"></a><span class="c">!&gt; @date    1/5/99  MDG 1.0 original</span>
<a name="ln-303"></a><span class="c">!&gt; @date    5/19/01 MDG 2.0 f90 version</span>
<a name="ln-304"></a><span class="c">!&gt; @date   11/27/01 MDG 2.1 added kind support</span>
<a name="ln-305"></a><span class="c">!&gt; @date   06/04/13 MDG 3.0 rewrite</span>
<a name="ln-306"></a><span class="c">!&gt; @date   12/17/13 MDG 3.1 added ECCI mode</span>
<a name="ln-307"></a><span class="c">!&gt; @date   06/09/14 MDG 4.0 added cell, defects arguments</span>
<a name="ln-308"></a><span class="c">!&gt; @date   06/10/14 MDG 4.1 added foil argument</span>
<a name="ln-309"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-310"></a><span class="k">recursive subroutine </span><span class="n">init_stacking_fault_data</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span><span class="n">defects</span><span class="p">,</span><span class="n">DF_L</span><span class="p">,</span><span class="n">DF_npix</span><span class="p">,</span><span class="n">DF_npiy</span><span class="p">,</span><span class="n">DF_g</span><span class="p">,</span><span class="n">dinfo</span><span class="p">,</span><span class="n">ECCI</span><span class="p">)</span>
<a name="ln-311"></a><span class="c">!DEC$ ATTRIBUTES DLLEXPORT :: init_stacking_fault_data</span>
<a name="ln-312"></a>
<a name="ln-313"></a><span class="k">use </span><span class="n">io</span>
<a name="ln-314"></a><span class="k">use </span><span class="n">files</span>
<a name="ln-315"></a>
<a name="ln-316"></a><span class="k">IMPLICIT NONE</span>
<a name="ln-317"></a>
<a name="ln-318"></a><span class="k">type</span><span class="p">(</span><span class="n">unitcell</span><span class="p">),</span><span class="k">pointer</span>                  <span class="kd">::</span> <span class="n">cell</span>
<a name="ln-319"></a><span class="k">type</span><span class="p">(</span><span class="n">defecttype</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">INOUT</span><span class="p">)</span>          <span class="kd">::</span> <span class="n">defects</span>
<a name="ln-320"></a><span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">irg</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>            <span class="kd">::</span> <span class="n">DF_npix</span><span class="p">,</span> <span class="n">DF_npiy</span><span class="p">,</span> <span class="n">dinfo</span>
<a name="ln-321"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>               <span class="kd">::</span> <span class="n">DF_g</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-322"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>               <span class="kd">::</span> <span class="n">DF_L</span>
<a name="ln-323"></a><span class="kt">logical</span><span class="p">,</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">),</span><span class="k">OPTIONAL</span>             <span class="kd">::</span> <span class="n">ECCI</span>
<a name="ln-324"></a>
<a name="ln-325"></a><span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">irg</span><span class="p">)</span>                       <span class="kd">::</span> <span class="n">i</span>
<a name="ln-326"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">)</span>                          <span class="kd">::</span> <span class="n">poisson</span>
<a name="ln-327"></a>
<a name="ln-328"></a>
<a name="ln-329"></a><span class="c">! read the namelist files for all of the stacking faults</span>
<a name="ln-330"></a> <span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">defects</span><span class="p">%</span><span class="n">numsf</span>
<a name="ln-331"></a><span class="c">!   SFR = (/ 0.0, 0.0, 0.0 /)</span>
<a name="ln-332"></a>    <span class="n">poisson</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-333"></a><span class="c">! transform the fault fractional coordinates to nm in the image reference frame</span>
<a name="ln-334"></a>    <span class="n">defects</span><span class="p">%</span><span class="n">SF</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">id</span> <span class="o">=</span> <span class="n">defects</span><span class="p">%</span><span class="n">SF</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">id</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="nb">float</span><span class="p">(</span><span class="n">DF_npix</span><span class="p">)</span> <span class="c">! * DF_L  (zooming is done later in the image reference frame)</span>
<a name="ln-335"></a>    <span class="n">defects</span><span class="p">%</span><span class="n">SF</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">jd</span> <span class="o">=</span> <span class="n">defects</span><span class="p">%</span><span class="n">SF</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">jd</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="nb">float</span><span class="p">(</span><span class="n">DF_npiy</span><span class="p">)</span> <span class="c">! * DF_L</span>
<a name="ln-336"></a>    <span class="n">defects</span><span class="p">%</span><span class="n">SF</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">poisson</span> <span class="o">=</span> <span class="n">poisson</span>
<a name="ln-337"></a><span class="c">!   if (sum(abs(SFR)).eq.0.0) then  </span>
<a name="ln-338"></a>      <span class="n">defects</span><span class="p">%</span><span class="n">SF</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">Rdisp</span> <span class="o">=</span> <span class="n">defects</span><span class="p">%</span><span class="n">SF</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">lpb</span>
<a name="ln-339"></a><span class="c">!   else</span>
<a name="ln-340"></a><span class="c">!     defects%SF(i)%Rdisp = SFR</span>
<a name="ln-341"></a><span class="c">!   end if</span>
<a name="ln-342"></a><span class="c">! initialize the stacking fault variables and both partial dislocations; this might depend</span>
<a name="ln-343"></a><span class="c">! on the imaging mode (TEM vs. ECCI); careful here, since the counting of dislocations has</span>
<a name="ln-344"></a><span class="c">! changed with respect to release 2.0 !!!</span>
<a name="ln-345"></a>    <span class="k">if</span> <span class="p">(</span><span class="nb">present</span><span class="p">(</span><span class="n">ECCI</span><span class="p">))</span> <span class="k">then</span>
<a name="ln-346"></a><span class="k">      call </span><span class="n">makestackingfaultECCI</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span><span class="n">defects</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">DF_L</span><span class="p">,</span><span class="n">DF_npix</span><span class="p">,</span><span class="n">DF_npiy</span><span class="p">,</span><span class="n">DF_g</span><span class="p">,</span><span class="n">dinfo</span><span class="p">)</span>
<a name="ln-347"></a>      <span class="n">defects</span><span class="p">%</span><span class="n">numYdisl</span> <span class="o">=</span> <span class="n">defects</span><span class="p">%</span><span class="n">numYdisl</span> <span class="o">+</span> <span class="mi">2</span>
<a name="ln-348"></a>    <span class="k">else</span>
<a name="ln-349"></a><span class="k">      call </span><span class="n">makestackingfault</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span><span class="n">defects</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">DF_L</span><span class="p">,</span><span class="n">DF_npix</span><span class="p">,</span><span class="n">DF_npiy</span><span class="p">,</span><span class="n">DF_g</span><span class="p">,</span><span class="n">dinfo</span><span class="p">)</span>
<a name="ln-350"></a>      <span class="n">defects</span><span class="p">%</span><span class="n">numdisl</span> <span class="o">=</span> <span class="n">defects</span><span class="p">%</span><span class="n">numdisl</span> <span class="o">+</span> <span class="mi">2</span>
<a name="ln-351"></a>    <span class="k">end if</span>
<a name="ln-352"></a><span class="k"> end do</span>
<a name="ln-353"></a><span class="k"> </span>
<a name="ln-354"></a><span class="k">end subroutine </span><span class="n">init_stacking_fault_data</span>
<a name="ln-355"></a>
<a name="ln-356"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-357"></a><span class="c">!</span>
<a name="ln-358"></a><span class="c">! SUBROUTINE: init_YSH_dislocation_data</span>
<a name="ln-359"></a><span class="c">!</span>
<a name="ln-360"></a><span class="c">!&gt; @author Marc De Graef, Carnegie Mellon University</span>
<a name="ln-361"></a><span class="c">!</span>
<a name="ln-362"></a><span class="c">!&gt; @brief init Yoffe dislocation </span>
<a name="ln-363"></a><span class="c">! </span>
<a name="ln-364"></a><span class="c">!&gt; @param cell unit cell pointer</span>
<a name="ln-365"></a><span class="c">!&gt; @param defects defects structure</span>
<a name="ln-366"></a><span class="c">!&gt; @param DF_npix number of x-pixels</span>
<a name="ln-367"></a><span class="c">!&gt; @param DF_npiy number of y-pixels</span>
<a name="ln-368"></a><span class="c">!&gt; @param DF_gf </span>
<a name="ln-369"></a><span class="c">!&gt; @param L </span>
<a name="ln-370"></a><span class="c">!&gt; @param dinfo logical to trigger verbose output</span>
<a name="ln-371"></a><span class="c">! </span>
<a name="ln-372"></a><span class="c">!&gt; @date  1/5/99  MDG 1.0 original</span>
<a name="ln-373"></a><span class="c">!&gt; @date  5/19/01 MDG 2.0 f90 version</span>
<a name="ln-374"></a><span class="c">!&gt; @date 11/27/01 MDG 2.1 added kind support</span>
<a name="ln-375"></a><span class="c">!&gt; @date 03/25/13 MDG 3.0 updated IO</span>
<a name="ln-376"></a><span class="c">!&gt; @date 11/21/13 MDG 3.1 verification</span>
<a name="ln-377"></a><span class="c">!&gt; @date 06/10/14 MDG 4.0 added defects, cell and foil arguments</span>
<a name="ln-378"></a><span class="c">!&gt; @date 11/23/15 MDG 4.1 made foil part of defects</span>
<a name="ln-379"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-380"></a><span class="k">recursive subroutine </span><span class="n">init_YSH_dislocation_data</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span><span class="n">defects</span><span class="p">,</span><span class="n">DF_npix</span><span class="p">,</span><span class="n">DF_npiy</span><span class="p">,</span><span class="n">DF_gf</span><span class="p">,</span><span class="n">L</span><span class="p">,</span><span class="n">dinfo</span><span class="p">)</span>
<a name="ln-381"></a><span class="c">!DEC$ ATTRIBUTES DLLEXPORT :: init_YSH_dislocation_data</span>
<a name="ln-382"></a>
<a name="ln-383"></a><span class="k">use </span><span class="n">io</span>
<a name="ln-384"></a><span class="k">use </span><span class="n">files</span>
<a name="ln-385"></a>
<a name="ln-386"></a><span class="k">IMPLICIT NONE</span>
<a name="ln-387"></a>
<a name="ln-388"></a><span class="k">type</span><span class="p">(</span><span class="n">unitcell</span><span class="p">),</span><span class="k">pointer</span>          <span class="kd">::</span> <span class="n">cell</span>
<a name="ln-389"></a><span class="k">type</span><span class="p">(</span><span class="n">defecttype</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">INOUT</span><span class="p">)</span>  <span class="kd">::</span> <span class="n">defects</span>
<a name="ln-390"></a><span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">irg</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">DF_npix</span><span class="p">,</span> <span class="n">DF_npiy</span><span class="p">,</span> <span class="n">dinfo</span>
<a name="ln-391"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>       <span class="kd">::</span> <span class="n">DF_gf</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">L</span>
<a name="ln-392"></a>
<a name="ln-393"></a><span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">irg</span><span class="p">)</span>               <span class="kd">::</span> <span class="n">i</span>
<a name="ln-394"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">)</span>                  <span class="kd">::</span> <span class="n">id</span><span class="p">,</span><span class="n">jd</span><span class="p">,</span><span class="n">u</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span><span class="n">bv</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span><span class="n">poisson</span>
<a name="ln-395"></a>
<a name="ln-396"></a><span class="c">! these are just the individual dislocations; the ones that belong to </span>
<a name="ln-397"></a><span class="c">! stacking faults are handled separately</span>
<a name="ln-398"></a><span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">defects</span><span class="p">%</span><span class="n">numYdisl</span>
<a name="ln-399"></a><span class="c">! top-of-the-foil intersection of dislocation line is transformed to foil coordinates [nm] with DL(i)%kd=0 (center of foil) [verified 4/23/11]</span>
<a name="ln-400"></a><span class="c">! the point (0,0) is at the center of the image ... hence the factor of 0.5</span>
<a name="ln-401"></a>  <span class="n">defects</span><span class="p">%</span><span class="n">YD</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">id</span> <span class="o">=</span> <span class="n">defects</span><span class="p">%</span><span class="n">YD</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">id</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="nb">float</span><span class="p">(</span><span class="n">DF_npix</span><span class="p">)</span> <span class="c">! * L   scaling (zooming) is done later in the image reference frame...</span>
<a name="ln-402"></a>  <span class="n">defects</span><span class="p">%</span><span class="n">YD</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">jd</span> <span class="o">=</span> <span class="n">defects</span><span class="p">%</span><span class="n">YD</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">jd</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="nb">float</span><span class="p">(</span><span class="n">DF_npiy</span><span class="p">)</span> <span class="c">! * L</span>
<a name="ln-403"></a>  <span class="n">defects</span><span class="p">%</span><span class="n">YD</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">g</span> <span class="o">=</span> <span class="n">DF_gf</span>
<a name="ln-404"></a>    
<a name="ln-405"></a><span class="c">! and pre-compute the dislocation displacement field parameters</span>
<a name="ln-406"></a>  <span class="k">call </span><span class="n">makeYSHdislocation</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span><span class="n">defects</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">dinfo</span><span class="p">,</span> <span class="n">L</span><span class="p">)</span>    
<a name="ln-407"></a><span class="k">end do</span>
<a name="ln-408"></a><span class="k">  </span>
<a name="ln-409"></a><span class="k">end subroutine </span><span class="n">init_YSH_dislocation_data</span>
<a name="ln-410"></a>
<a name="ln-411"></a>
<a name="ln-412"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-413"></a><span class="c">!</span>
<a name="ln-414"></a><span class="c">! SUBROUTINE: init_void_data</span>
<a name="ln-415"></a><span class="c">!</span>
<a name="ln-416"></a><span class="c">!&gt; @author Marc De Graef, Carnegie Mellon University</span>
<a name="ln-417"></a><span class="c">!</span>
<a name="ln-418"></a><span class="c">!&gt; @brief  init void parameters </span>
<a name="ln-419"></a><span class="c">! </span>
<a name="ln-420"></a><span class="c">!&gt; @param defects defects structure</span>
<a name="ln-421"></a><span class="c">!&gt; @param DF_L column edge length </span>
<a name="ln-422"></a><span class="c">!&gt; @param DF_npix number of x-pixels</span>
<a name="ln-423"></a><span class="c">!&gt; @param DF_npiy number of y-pixels</span>
<a name="ln-424"></a><span class="c">!&gt; @param dinfo logical to trigger verbose output</span>
<a name="ln-425"></a><span class="c">! </span>
<a name="ln-426"></a><span class="c">!&gt; @date 01/05/99 MDG 1.0 original</span>
<a name="ln-427"></a><span class="c">!&gt; @date 05/19/01 MDG 2.0 f90 version</span>
<a name="ln-428"></a><span class="c">!&gt; @date 11/27/01 MDG 2.1 added kind support</span>
<a name="ln-429"></a><span class="c">!&gt; @date 03/25/13 MDG 3.0 updated IO</span>
<a name="ln-430"></a><span class="c">!&gt; @date 06/09/14 MDG 4.0 added defects argument</span>
<a name="ln-431"></a><span class="c">!&gt; @date 06/10/14 MDG 4.1 added foil argument</span>
<a name="ln-432"></a><span class="c">!&gt; @date 11/23/15 MDG 4.2 removed foil and put it inside defects</span>
<a name="ln-433"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-434"></a><span class="k">recursive subroutine </span><span class="n">init_void_data</span><span class="p">(</span><span class="n">defects</span><span class="p">,</span><span class="n">DF_L</span><span class="p">,</span><span class="n">DF_npix</span><span class="p">,</span><span class="n">DF_npiy</span><span class="p">,</span><span class="n">dinfo</span><span class="p">)</span>
<a name="ln-435"></a><span class="c">!DEC$ ATTRIBUTES DLLEXPORT :: init_void_data</span>
<a name="ln-436"></a>
<a name="ln-437"></a><span class="k">use </span><span class="n">io</span>
<a name="ln-438"></a><span class="k">use </span><span class="n">files</span>
<a name="ln-439"></a>
<a name="ln-440"></a><span class="k">IMPLICIT NONE</span>
<a name="ln-441"></a>
<a name="ln-442"></a><span class="k">type</span><span class="p">(</span><span class="n">defecttype</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">INOUT</span><span class="p">)</span>      <span class="kd">::</span> <span class="n">defects</span>
<a name="ln-443"></a><span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">irg</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>        <span class="kd">::</span> <span class="n">dinfo</span><span class="p">,</span><span class="n">DF_npix</span><span class="p">,</span><span class="n">DF_npiy</span>
<a name="ln-444"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>           <span class="kd">::</span> <span class="n">DF_L</span>
<a name="ln-445"></a>
<a name="ln-446"></a><span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">irg</span><span class="p">)</span>                   <span class="kd">::</span> <span class="n">i</span>
<a name="ln-447"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">)</span>                      <span class="kd">::</span> <span class="n">tmp</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-448"></a>
<a name="ln-449"></a><span class="c">! read each subsequent line </span>
<a name="ln-450"></a><span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">defects</span><span class="p">%</span><span class="n">numvoids</span>
<a name="ln-451"></a>  <span class="n">defects</span><span class="p">%</span><span class="n">voids</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">xpos</span> <span class="o">=</span> <span class="n">defects</span><span class="p">%</span><span class="n">voids</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">xpos</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="nb">float</span><span class="p">(</span><span class="n">DF_npix</span><span class="p">)</span> <span class="o">*</span> <span class="n">DF_L</span>
<a name="ln-452"></a>  <span class="n">defects</span><span class="p">%</span><span class="n">voids</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">ypos</span> <span class="o">=</span> <span class="n">defects</span><span class="p">%</span><span class="n">voids</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">ypos</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="nb">float</span><span class="p">(</span><span class="n">DF_npiy</span><span class="p">)</span> <span class="o">*</span> <span class="n">DF_L</span>
<a name="ln-453"></a>  <span class="n">defects</span><span class="p">%</span><span class="n">voids</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">zpos</span> <span class="o">=</span> <span class="n">defects</span><span class="p">%</span><span class="n">voids</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">zpos</span> <span class="o">*</span> <span class="n">defects</span><span class="p">%</span><span class="n">foil</span><span class="p">%</span><span class="n">z0</span>
<a name="ln-454"></a><span class="c">! transform to the foil reference frame  </span>
<a name="ln-455"></a>  <span class="n">tmp</span> <span class="o">=</span> <span class="n">quat_Lp</span><span class="p">(</span> <span class="nb">conjg</span><span class="p">(</span><span class="n">defects</span><span class="p">%</span><span class="n">foil</span><span class="p">%</span><span class="n">a_fc</span><span class="p">),</span> <span class="nb">dble</span><span class="p">((</span><span class="o">/</span> <span class="n">defects</span><span class="p">%</span><span class="n">voids</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">xpos</span><span class="p">,</span> <span class="n">defects</span><span class="p">%</span><span class="n">voids</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">ypos</span><span class="p">,</span> <span class="n">defects</span><span class="p">%</span><span class="n">voids</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">zpos</span> <span class="o">/</span><span class="p">))</span> <span class="p">)</span>  
<a name="ln-456"></a>  <span class="n">defects</span><span class="p">%</span><span class="n">voids</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">xpos</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-457"></a>  <span class="n">defects</span><span class="p">%</span><span class="n">voids</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">ypos</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<a name="ln-458"></a>  <span class="n">defects</span><span class="p">%</span><span class="n">voids</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">zpos</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-459"></a>  <span class="k">if</span> <span class="p">(</span><span class="n">dinfo</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span> <span class="k">write</span> <span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="n">i</span><span class="p">,</span><span class="n">defects</span><span class="p">%</span><span class="n">voids</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">xpos</span><span class="p">,</span><span class="n">defects</span><span class="p">%</span><span class="n">voids</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">ypos</span><span class="p">,</span><span class="n">defects</span><span class="p">%</span><span class="n">voids</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">zpos</span><span class="p">,</span><span class="n">defects</span><span class="p">%</span><span class="n">voids</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">radius</span>
<a name="ln-460"></a><span class="k">end do</span>
<a name="ln-461"></a>
<a name="ln-462"></a><span class="k">end subroutine </span><span class="n">init_void_data</span>
<a name="ln-463"></a>
<a name="ln-464"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-465"></a><span class="c">!</span>
<a name="ln-466"></a><span class="c">! SUBROUTINE: init_inclusion_data</span>
<a name="ln-467"></a><span class="c">!</span>
<a name="ln-468"></a><span class="c">!&gt; @author Marc De Graef, Carnegie Mellon University</span>
<a name="ln-469"></a><span class="c">!</span>
<a name="ln-470"></a><span class="c">!&gt; @brief  init inclusion parameters </span>
<a name="ln-471"></a><span class="c">! </span>
<a name="ln-472"></a><span class="c">!&gt; @param defects defect structure</span>
<a name="ln-473"></a><span class="c">!&gt; @param DF_L column edge length </span>
<a name="ln-474"></a><span class="c">!&gt; @param DF_npix number of x-pixels</span>
<a name="ln-475"></a><span class="c">!&gt; @param DF_npiy number of y-pixels</span>
<a name="ln-476"></a><span class="c">!&gt; @param dinfo logical to trigger verbose output</span>
<a name="ln-477"></a><span class="c">! </span>
<a name="ln-478"></a><span class="c">!&gt; @date  01/05/99 MDG 1.0 original</span>
<a name="ln-479"></a><span class="c">!&gt; @date  05/19/01 MDG 2.0 f90 version</span>
<a name="ln-480"></a><span class="c">!&gt; @date  11/27/01 MDG 2.1 added kind support</span>
<a name="ln-481"></a><span class="c">!&gt; @date  03/25/13 MDG 3.0 updated IO</span>
<a name="ln-482"></a><span class="c">!&gt; @date  06/09/14 MDG 4.0 added defects argument</span>
<a name="ln-483"></a><span class="c">!&gt; @date  06/10/14 MDG 4.1 added foil argument</span>
<a name="ln-484"></a><span class="c">!&gt; @date  11/23/15 MDG 4.2 made foil part of defects</span>
<a name="ln-485"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-486"></a><span class="k">recursive subroutine </span><span class="n">init_inclusion_data</span><span class="p">(</span><span class="n">defects</span><span class="p">,</span><span class="n">DF_L</span><span class="p">,</span><span class="n">DF_npix</span><span class="p">,</span><span class="n">DF_npiy</span><span class="p">,</span><span class="n">dinfo</span><span class="p">)</span>
<a name="ln-487"></a><span class="c">!DEC$ ATTRIBUTES DLLEXPORT :: init_inclusion_data</span>
<a name="ln-488"></a>
<a name="ln-489"></a><span class="k">use </span><span class="n">io</span>
<a name="ln-490"></a><span class="k">use </span><span class="n">files</span>
<a name="ln-491"></a>
<a name="ln-492"></a><span class="k">IMPLICIT NONE</span>
<a name="ln-493"></a>
<a name="ln-494"></a><span class="k">type</span><span class="p">(</span><span class="n">defecttype</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">INOUT</span><span class="p">)</span>  <span class="kd">::</span> <span class="n">defects</span>
<a name="ln-495"></a><span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">irg</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">dinfo</span><span class="p">,</span><span class="n">DF_npix</span><span class="p">,</span><span class="n">DF_npiy</span>
<a name="ln-496"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>       <span class="kd">::</span> <span class="n">DF_L</span>
<a name="ln-497"></a>
<a name="ln-498"></a><span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">irg</span><span class="p">)</span>               <span class="kd">::</span> <span class="n">i</span>
<a name="ln-499"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">)</span>                  <span class="kd">::</span> <span class="n">tmp</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-500"></a>
<a name="ln-501"></a><span class="c">! read each subsequent line </span>
<a name="ln-502"></a><span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">defects</span><span class="p">%</span><span class="n">numinc</span>
<a name="ln-503"></a>  <span class="n">defects</span><span class="p">%</span><span class="n">inclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">xpos</span> <span class="o">=</span> <span class="n">defects</span><span class="p">%</span><span class="n">inclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">xpos</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="nb">float</span><span class="p">(</span><span class="n">DF_npix</span><span class="p">)</span><span class="o">*</span><span class="n">DF_L</span>
<a name="ln-504"></a>  <span class="n">defects</span><span class="p">%</span><span class="n">inclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">ypos</span> <span class="o">=</span> <span class="n">defects</span><span class="p">%</span><span class="n">inclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">ypos</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="nb">float</span><span class="p">(</span><span class="n">DF_npiy</span><span class="p">)</span><span class="o">*</span><span class="n">DF_L</span>
<a name="ln-505"></a>  <span class="n">defects</span><span class="p">%</span><span class="n">inclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">zpos</span> <span class="o">=</span> <span class="n">defects</span><span class="p">%</span><span class="n">inclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">zpos</span> <span class="o">*</span> <span class="n">defects</span><span class="p">%</span><span class="n">foil</span><span class="p">%</span><span class="n">z0</span>         <span class="c">! vertical fractional location in interval [-1,1]</span>
<a name="ln-506"></a>  <span class="n">tmp</span> <span class="o">=</span> <span class="n">quat_Lp</span><span class="p">(</span> <span class="nb">conjg</span><span class="p">(</span><span class="n">defects</span><span class="p">%</span><span class="n">foil</span><span class="p">%</span><span class="n">a_fc</span><span class="p">),</span> <span class="nb">dble</span><span class="p">((</span><span class="o">/</span> <span class="n">defects</span><span class="p">%</span><span class="n">inclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">xpos</span><span class="p">,</span> <span class="n">defects</span><span class="p">%</span><span class="n">inclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">ypos</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-507"></a>        <span class="n">defects</span><span class="p">%</span><span class="n">inclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">zpos</span> <span class="o">/</span><span class="p">))</span> <span class="p">)</span>  
<a name="ln-508"></a>  <span class="n">defects</span><span class="p">%</span><span class="n">inclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">xpos</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-509"></a>  <span class="n">defects</span><span class="p">%</span><span class="n">inclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">ypos</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<a name="ln-510"></a>  <span class="n">defects</span><span class="p">%</span><span class="n">inclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">zpos</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-511"></a>  <span class="k">if</span> <span class="p">(</span><span class="n">dinfo</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span> <span class="k">write</span> <span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="n">i</span><span class="p">,</span> <span class="n">defects</span><span class="p">%</span><span class="n">inclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">xpos</span><span class="p">,</span> <span class="n">defects</span><span class="p">%</span><span class="n">inclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">ypos</span><span class="p">,</span> <span class="n">defects</span><span class="p">%</span><span class="n">inclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">zpos</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-512"></a>                              <span class="n">defects</span><span class="p">%</span><span class="n">inclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">radius</span><span class="p">,</span> <span class="n">defects</span><span class="p">%</span><span class="n">inclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">C</span>
<a name="ln-513"></a><span class="k">end do</span>
<a name="ln-514"></a>
<a name="ln-515"></a><span class="k">end subroutine </span><span class="n">init_inclusion_data</span>
<a name="ln-516"></a>
<a name="ln-517"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-518"></a><span class="c">!</span>
<a name="ln-519"></a><span class="c">! SUBROUTINE: init_Einclusion_data</span>
<a name="ln-520"></a><span class="c">!</span>
<a name="ln-521"></a><span class="c">!&gt; @author Marc De Graef, Carnegie Mellon University</span>
<a name="ln-522"></a><span class="c">!</span>
<a name="ln-523"></a><span class="c">!&gt; @brief  init inclusion parameters </span>
<a name="ln-524"></a><span class="c">! </span>
<a name="ln-525"></a><span class="c">!&gt; @param cell cell structure pointer</span>
<a name="ln-526"></a><span class="c">!&gt; @param defects defect structure</span>
<a name="ln-527"></a><span class="c">!&gt; @param DF_L column edge length </span>
<a name="ln-528"></a><span class="c">!&gt; @param DF_npix number of x-pixels</span>
<a name="ln-529"></a><span class="c">!&gt; @param DF_npiy number of y-pixels</span>
<a name="ln-530"></a><span class="c">!&gt; @param dinfo logical to trigger verbose output</span>
<a name="ln-531"></a><span class="c">! </span>
<a name="ln-532"></a><span class="c">!&gt; @date  01/05/99 MDG 1.0 original</span>
<a name="ln-533"></a><span class="c">!&gt; @date  05/19/01 MDG 2.0 f90 version</span>
<a name="ln-534"></a><span class="c">!&gt; @date  11/27/01 MDG 2.1 added kind support</span>
<a name="ln-535"></a><span class="c">!&gt; @date  03/25/13 MDG 3.0 updated IO</span>
<a name="ln-536"></a><span class="c">!&gt; @date  06/09/14 MDG 4.0 added defects argument</span>
<a name="ln-537"></a><span class="c">!&gt; @date  06/10/14 MDG 4.1 added foil argument</span>
<a name="ln-538"></a><span class="c">!&gt; @date  11/23/15 MDG 4.2 made foil part of defects</span>
<a name="ln-539"></a><span class="c">!&gt; @date  12/08/15 MDG 4.3 forked from init_inclusion_data</span>
<a name="ln-540"></a><span class="c">!&gt; @date  12/11/15 MDG 4.4 reworked based on IDL ellipsoid.pro script</span>
<a name="ln-541"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-542"></a><span class="k">recursive subroutine </span><span class="n">init_Einclusion_data</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span><span class="n">defects</span><span class="p">,</span><span class="n">DF_L</span><span class="p">,</span><span class="n">DF_npix</span><span class="p">,</span><span class="n">DF_npiy</span><span class="p">,</span><span class="n">dinfo</span><span class="p">)</span>
<a name="ln-543"></a><span class="c">!DEC$ ATTRIBUTES DLLEXPORT :: init_Einclusion_data</span>
<a name="ln-544"></a>
<a name="ln-545"></a><span class="k">use </span><span class="n">io</span>
<a name="ln-546"></a><span class="k">use </span><span class="n">files</span>
<a name="ln-547"></a>
<a name="ln-548"></a><span class="k">IMPLICIT NONE</span>
<a name="ln-549"></a>
<a name="ln-550"></a><span class="k">type</span><span class="p">(</span><span class="n">unitcell</span><span class="p">),</span><span class="k">pointer</span>          <span class="kd">::</span> <span class="n">cell</span>
<a name="ln-551"></a><span class="k">type</span><span class="p">(</span><span class="n">defecttype</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">INOUT</span><span class="p">)</span>  <span class="kd">::</span> <span class="n">defects</span>
<a name="ln-552"></a><span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">irg</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">dinfo</span><span class="p">,</span><span class="n">DF_npix</span><span class="p">,</span><span class="n">DF_npiy</span>
<a name="ln-553"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>       <span class="kd">::</span> <span class="n">DF_L</span>
<a name="ln-554"></a>
<a name="ln-555"></a><span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">irg</span><span class="p">)</span>               <span class="kd">::</span> <span class="n">i</span>
<a name="ln-556"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">)</span>                  <span class="kd">::</span> <span class="n">tmp</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-557"></a>
<a name="ln-558"></a><span class="c">! read each subsequent line </span>
<a name="ln-559"></a><span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">defects</span><span class="p">%</span><span class="n">numEinc</span>
<a name="ln-560"></a>  <span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">xpos</span> <span class="o">=</span> <span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">xyz</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="nb">float</span><span class="p">(</span><span class="n">DF_npix</span><span class="p">)</span><span class="o">*</span><span class="n">DF_L</span>
<a name="ln-561"></a>  <span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">ypos</span> <span class="o">=</span> <span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">xyz</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="nb">float</span><span class="p">(</span><span class="n">DF_npiy</span><span class="p">)</span><span class="o">*</span><span class="n">DF_L</span>
<a name="ln-562"></a>  <span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">zpos</span> <span class="o">=</span> <span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">xyz</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="n">defects</span><span class="p">%</span><span class="n">foil</span><span class="p">%</span><span class="n">z0</span>         <span class="c">! vertical fractional location in interval [-1,1]</span>
<a name="ln-563"></a>  <span class="n">tmp</span> <span class="o">=</span> <span class="n">quat_Lp</span><span class="p">(</span> <span class="nb">conjg</span><span class="p">(</span><span class="n">defects</span><span class="p">%</span><span class="n">foil</span><span class="p">%</span><span class="n">a_fc</span><span class="p">),</span> <span class="nb">dble</span><span class="p">((</span><span class="o">/</span> <span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">xpos</span><span class="p">,</span> <span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">ypos</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-564"></a>        <span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">zpos</span> <span class="o">/</span><span class="p">))</span> <span class="p">)</span>  
<a name="ln-565"></a>  <span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">xpos</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-566"></a>  <span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">ypos</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<a name="ln-567"></a>  <span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">zpos</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-568"></a>
<a name="ln-569"></a><span class="c">! here we call the initialization routine to compute a series of arrays </span>
<a name="ln-570"></a><span class="c">! and look-up tables for elliptic integrals  </span>
<a name="ln-571"></a>  <span class="k">call </span><span class="n">InitializeEshelbyInclusion</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span><span class="n">defects</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">dinfo</span><span class="p">,</span><span class="n">DF_L</span><span class="p">,</span><span class="n">DF_npix</span><span class="p">,</span><span class="n">DF_npiy</span><span class="p">)</span>  
<a name="ln-572"></a>
<a name="ln-573"></a>  <span class="k">if</span> <span class="p">(</span><span class="n">dinfo</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span> <span class="k">write</span> <span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="n">i</span><span class="p">,</span> <span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">xpos</span><span class="p">,</span> <span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">ypos</span><span class="p">,</span> <span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">zpos</span>
<a name="ln-574"></a><span class="k">end do</span>
<a name="ln-575"></a>
<a name="ln-576"></a><span class="k">end subroutine </span><span class="n">init_Einclusion_data</span>
<a name="ln-577"></a>
<a name="ln-578"></a>
<a name="ln-579"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-580"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-581"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-582"></a><span class="c">! and here are the routines that actually compute all the defect parameters</span>
<a name="ln-583"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-584"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-585"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-586"></a>
<a name="ln-587"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-588"></a><span class="c">!</span>
<a name="ln-589"></a><span class="c">! SUBROUTINE: initialize_foil_geometry</span>
<a name="ln-590"></a><span class="c">!</span>
<a name="ln-591"></a><span class="c">!&gt; @author Marc De Graef, Carnegie Mellon University</span>
<a name="ln-592"></a><span class="c">!</span>
<a name="ln-593"></a><span class="c">!&gt; @brief  Initializes the foil geometry</span>
<a name="ln-594"></a><span class="c">!</span>
<a name="ln-595"></a><span class="c">!&gt; @details This new implementation uses quaternions for all rotations. </span>
<a name="ln-596"></a><span class="c">! </span>
<a name="ln-597"></a><span class="c">!&gt; @param cell unit cell pointer</span>
<a name="ln-598"></a><span class="c">!&gt; @param dinfo</span>
<a name="ln-599"></a><span class="c">! </span>
<a name="ln-600"></a><span class="c">!&gt; @date  1/ 5/99 MDG 1.0 original</span>
<a name="ln-601"></a><span class="c">!&gt; @date  1/11/10 MDG 2.0 rewrite of beam direction part</span>
<a name="ln-602"></a><span class="c">!&gt; @date  3/28/11 MDG 2.1 code verified</span>
<a name="ln-603"></a><span class="c">!&gt; @date  4/23/11 MDG 2.2 redefined origin to be at center of image</span>
<a name="ln-604"></a><span class="c">!&gt; @date  6/03/13 MDG 3.0 replaced rotation matrices by quaternions throughout</span>
<a name="ln-605"></a><span class="c">!&gt; @date 10/30/13 MDG 3.1 complete debug of quaternion and rotation implementation </span>
<a name="ln-606"></a><span class="c">!&gt; @date 06/09/14 MDG 4.0 added cell and foil as argument</span>
<a name="ln-607"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-608"></a><span class="k">recursive subroutine </span><span class="n">initialize_foil_geometry</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span><span class="n">foil</span><span class="p">,</span><span class="n">dinfo</span><span class="p">)</span>
<a name="ln-609"></a><span class="c">!DEC$ ATTRIBUTES DLLEXPORT :: initialize_foil_geometry</span>
<a name="ln-610"></a>
<a name="ln-611"></a><span class="k">use </span><span class="n">local</span>
<a name="ln-612"></a><span class="k">use </span><span class="n">typedefs</span>
<a name="ln-613"></a><span class="k">use </span><span class="n">math</span>
<a name="ln-614"></a><span class="k">use </span><span class="n">constants</span>
<a name="ln-615"></a><span class="k">use </span><span class="n">crystal</span>
<a name="ln-616"></a><span class="k">use </span><span class="n">symmetry</span>
<a name="ln-617"></a><span class="k">use </span><span class="n">io</span>
<a name="ln-618"></a><span class="k">use </span><span class="n">rotations</span>
<a name="ln-619"></a>
<a name="ln-620"></a><span class="k">IMPLICIT NONE</span>
<a name="ln-621"></a>
<a name="ln-622"></a><span class="k">type</span><span class="p">(</span><span class="n">unitcell</span><span class="p">),</span><span class="k">pointer</span>          <span class="kd">::</span> <span class="n">cell</span>
<a name="ln-623"></a><span class="k">type</span><span class="p">(</span><span class="n">foiltype</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">INOUT</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">foil</span>
<a name="ln-624"></a><span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">dinfo</span>
<a name="ln-625"></a>
<a name="ln-626"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">dbl</span><span class="p">)</span>                  <span class="kd">::</span> <span class="n">ey</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">ex</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">tt</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span> 
<a name="ln-627"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">)</span>                  <span class="kd">::</span> <span class="n">io_real</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-628"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">dbl</span><span class="p">)</span>                  <span class="kd">::</span> <span class="n">cp</span><span class="p">,</span><span class="n">sp</span><span class="p">,</span><span class="n">cs</span><span class="p">,</span><span class="n">ss</span><span class="p">,</span><span class="n">cr</span><span class="p">,</span><span class="n">sr</span><span class="p">,</span> <span class="n">ca</span><span class="p">,</span> <span class="n">sa</span><span class="p">,</span> <span class="n">a_fc</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-629"></a><span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">irg</span><span class="p">)</span>               <span class="kd">::</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span>
<a name="ln-630"></a><span class="k">type</span><span class="p">(</span><span class="n">orientationtyped</span><span class="p">)</span>          <span class="kd">::</span> <span class="n">ot</span>
<a name="ln-631"></a><span class="kt">character</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>                   <span class="kd">::</span> <span class="n">pret</span>
<a name="ln-632"></a>
<a name="ln-633"></a><span class="c">! determine the foil-to-microscope transformations [verified on 4/23/11, converted to quaternions on 6/4/13, </span>
<a name="ln-634"></a><span class="c">! verified 10/30/13, and again on 11/11/13 after some changes elsewhere]</span>
<a name="ln-635"></a>  <span class="k">if</span> <span class="p">(</span><span class="n">foil</span><span class="p">%</span><span class="n">alR</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mf">0.D0</span><span class="p">)</span> <span class="k">then</span> 
<a name="ln-636"></a><span class="c">! the double tilt holder transformation a_fm; note quaternions, hence we need the half-angles !</span>
<a name="ln-637"></a><span class="c">! a_fm transforms a vector v FROM the microscope reference frame To the foil reference frame</span>
<a name="ln-638"></a><span class="c">! using the quat_rotate_vector routine.</span>
<a name="ln-639"></a>    <span class="n">cp</span> <span class="o">=</span> <span class="nb">dcos</span><span class="p">(</span><span class="n">foil</span><span class="p">%</span><span class="n">alP</span><span class="o">*</span><span class="mf">0.5D0</span><span class="p">)</span>
<a name="ln-640"></a>    <span class="n">sp</span> <span class="o">=</span> <span class="nb">dsin</span><span class="p">(</span><span class="n">foil</span><span class="p">%</span><span class="n">alP</span><span class="o">*</span><span class="mf">0.5D0</span><span class="p">)</span>
<a name="ln-641"></a>    <span class="n">ca</span> <span class="o">=</span> <span class="nb">dcos</span><span class="p">(</span><span class="n">foil</span><span class="p">%</span><span class="n">alP</span><span class="p">)</span>
<a name="ln-642"></a>    <span class="n">sa</span> <span class="o">=</span> <span class="nb">dsin</span><span class="p">(</span><span class="n">foil</span><span class="p">%</span><span class="n">alP</span><span class="p">)</span>
<a name="ln-643"></a>    <span class="n">cs</span> <span class="o">=</span> <span class="nb">dcos</span><span class="p">(</span><span class="n">foil</span><span class="p">%</span><span class="n">alS</span><span class="o">*</span><span class="mf">0.5D0</span><span class="p">)</span>
<a name="ln-644"></a>    <span class="n">ss</span> <span class="o">=</span> <span class="nb">dsin</span><span class="p">(</span><span class="n">foil</span><span class="p">%</span><span class="n">alS</span><span class="o">*</span><span class="mf">0.5D0</span><span class="p">)</span>
<a name="ln-645"></a>    <span class="n">foil</span><span class="p">%</span><span class="n">a_fm</span> <span class="o">=</span> <span class="nb">conjg</span><span class="p">(</span> <span class="n">quat_mult</span><span class="p">(</span> <span class="p">(</span><span class="o">/</span> <span class="n">cs</span><span class="p">,</span> <span class="mf">0.D0</span><span class="p">,</span> <span class="n">ss</span><span class="o">*</span><span class="n">ca</span><span class="p">,</span> <span class="n">ss</span><span class="o">*</span><span class="n">sa</span> <span class="o">/</span><span class="p">),</span> <span class="p">(</span><span class="o">/</span> <span class="n">cp</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="mf">0.D0</span><span class="p">,</span> <span class="mf">0.D0</span> <span class="o">/</span><span class="p">)</span> <span class="p">)</span> <span class="p">)</span>
<a name="ln-646"></a>  <span class="k">else</span>
<a name="ln-647"></a><span class="c">! the rotation tilt holder transformation a_fm [verified on 4/23/11, converted to quaternions on 6/4/13,</span>
<a name="ln-648"></a><span class="c">! and again on 11/11/13 after changes elsewhere]</span>
<a name="ln-649"></a>    <span class="n">cp</span> <span class="o">=</span> <span class="nb">dcos</span><span class="p">(</span><span class="n">foil</span><span class="p">%</span><span class="n">alP</span><span class="o">*</span><span class="mf">0.5D0</span><span class="p">)</span>
<a name="ln-650"></a>    <span class="n">sp</span> <span class="o">=</span> <span class="nb">dsin</span><span class="p">(</span><span class="n">foil</span><span class="p">%</span><span class="n">alP</span><span class="o">*</span><span class="mf">0.5D0</span><span class="p">)</span>
<a name="ln-651"></a>    <span class="n">cr</span> <span class="o">=</span> <span class="nb">dcos</span><span class="p">(</span><span class="n">foil</span><span class="p">%</span><span class="n">alR</span><span class="o">*</span><span class="mf">0.5D0</span><span class="p">)</span>
<a name="ln-652"></a>    <span class="n">sr</span> <span class="o">=</span> <span class="nb">dsin</span><span class="p">(</span><span class="n">foil</span><span class="p">%</span><span class="n">alR</span><span class="o">*</span><span class="mf">0.5D0</span><span class="p">)</span>
<a name="ln-653"></a>    <span class="n">ca</span> <span class="o">=</span> <span class="nb">dcos</span><span class="p">(</span><span class="n">foil</span><span class="p">%</span><span class="n">alP</span><span class="p">)</span>
<a name="ln-654"></a>    <span class="n">sa</span> <span class="o">=</span> <span class="nb">dsin</span><span class="p">(</span><span class="n">foil</span><span class="p">%</span><span class="n">alP</span><span class="p">)</span>
<a name="ln-655"></a>    <span class="n">foil</span><span class="p">%</span><span class="n">a_fm</span> <span class="o">=</span> <span class="nb">conjg</span><span class="p">(</span> <span class="n">quat_mult</span><span class="p">(</span> <span class="p">(</span><span class="o">/</span> <span class="n">cr</span><span class="p">,</span><span class="mf">0.D0</span><span class="p">,</span> <span class="o">-</span><span class="n">sr</span><span class="o">*</span><span class="n">sa</span><span class="p">,</span> <span class="n">sr</span><span class="o">*</span><span class="n">ca</span> <span class="o">/</span><span class="p">),</span> <span class="p">(</span><span class="o">/</span> <span class="n">cp</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span><span class="mf">0.D0</span><span class="p">,</span><span class="mf">0.D0</span>  <span class="o">/</span><span class="p">)</span> <span class="p">)</span> <span class="p">)</span>
<a name="ln-656"></a>  <span class="k">end if  </span>
<a name="ln-657"></a><span class="k">  if</span> <span class="p">(</span><span class="n">dinfo</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-658"></a><span class="k">    </span><span class="n">pret</span> <span class="o">=</span> <span class="s1">&#39;a_fm: &#39;</span>
<a name="ln-659"></a>    <span class="n">ot</span> <span class="o">=</span> <span class="n">init_orientation</span><span class="p">(</span><span class="n">foil</span><span class="p">%</span><span class="n">a_fm</span><span class="p">,</span><span class="s1">&#39;qu&#39;</span><span class="p">)</span>
<a name="ln-660"></a>    <span class="k">call </span><span class="n">print_orientation</span><span class="p">(</span><span class="n">ot</span><span class="p">,</span><span class="s1">&#39;om&#39;</span><span class="p">,</span><span class="n">pret</span><span class="p">)</span> 
<a name="ln-661"></a>  <span class="k">end if</span>
<a name="ln-662"></a>
<a name="ln-663"></a><span class="c">! a_mi (image to microscope) apart from a scale factor, these two are identical </span>
<a name="ln-664"></a><span class="c">! The EM book uses a beta rotation angle between the image and the microscope,</span>
<a name="ln-665"></a><span class="c">! but that is really not necessary because we already fix the image with respect to</span>
<a name="ln-666"></a><span class="c">! the microscope by defining q (the horizontal image direction) to point to the </span>
<a name="ln-667"></a><span class="c">! airlock. [verified 4/23/11, converted to quaternions on 6/4/13]</span>
<a name="ln-668"></a><span class="c">! So we&#39;ll keep this transformation equal to the identity at all times.</span>
<a name="ln-669"></a>  <span class="n">foil</span><span class="p">%</span><span class="n">a_mi</span> <span class="o">=</span> <span class="p">(</span><span class="o">/</span> <span class="mf">1.D0</span><span class="p">,</span><span class="mf">0.D0</span><span class="p">,</span><span class="mf">0.D0</span><span class="p">,</span><span class="mf">0.D0</span> <span class="o">/</span><span class="p">)</span>   <span class="c">! identity quaternion </span>
<a name="ln-670"></a>  <span class="k">if</span> <span class="p">(</span><span class="n">dinfo</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-671"></a><span class="k">    </span><span class="n">pret</span> <span class="o">=</span> <span class="s1">&#39;a_mi: &#39;</span>
<a name="ln-672"></a>    <span class="n">ot</span> <span class="o">=</span> <span class="n">init_orientation</span><span class="p">(</span><span class="n">foil</span><span class="p">%</span><span class="n">a_mi</span><span class="p">,</span><span class="s1">&#39;qu&#39;</span><span class="p">)</span>
<a name="ln-673"></a>    <span class="k">call </span><span class="n">print_orientation</span><span class="p">(</span><span class="n">ot</span><span class="p">,</span><span class="s1">&#39;om&#39;</span><span class="p">,</span><span class="n">pret</span><span class="p">)</span> 
<a name="ln-674"></a>  <span class="k">end if</span>
<a name="ln-675"></a>  
<a name="ln-676"></a><span class="c">! This allows us to get the beam direction, since we know the foil normal and tilt angles</span>
<a name="ln-677"></a><span class="c">! The beam direction is the inverse transform of the microscope e_z-axis to the foil reference frame [verified 11/12/13]</span>
<a name="ln-678"></a>  <span class="n">foil</span><span class="p">%</span><span class="n">B</span> <span class="o">=</span> <span class="n">quat_Lp</span><span class="p">(</span> <span class="nb">conjg</span><span class="p">(</span><span class="n">foil</span><span class="p">%</span><span class="n">a_fm</span><span class="p">),</span> <span class="p">(</span><span class="o">/</span> <span class="mf">0.D0</span><span class="p">,</span><span class="mf">0.D0</span><span class="p">,</span><span class="o">-</span><span class="mf">1.D0</span> <span class="o">/</span><span class="p">)</span> <span class="p">)</span>
<a name="ln-679"></a>  <span class="n">foil</span><span class="p">%</span><span class="n">Bn</span> <span class="o">=</span> <span class="n">foil</span><span class="p">%</span><span class="n">B</span>
<a name="ln-680"></a>  <span class="k">call </span><span class="n">NormVec</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span><span class="n">foil</span><span class="p">%</span><span class="n">Bn</span><span class="p">,</span><span class="s1">&#39;c&#39;</span><span class="p">)</span>
<a name="ln-681"></a>  <span class="k">if</span> <span class="p">(</span><span class="n">dinfo</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-682"></a><span class="k">    </span><span class="n">io_real</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">foil</span><span class="p">%</span><span class="n">B</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-683"></a>    <span class="k">call </span><span class="n">WriteValue</span><span class="p">(</span><span class="s1">&#39;  Beam direction (foil reference frame) = &#39;</span><span class="p">,</span><span class="n">io_real</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="s2">&quot;(&#39;[&#39;,F12.5,&#39;,&#39;,F12.5,&#39;,&#39;,F12.5,&#39;]&#39;)&quot;</span><span class="p">)</span>
<a name="ln-684"></a>  <span class="k">end if</span>
<a name="ln-685"></a>
<a name="ln-686"></a><span class="c">! transform both the foil normal and the q-vector to the crystal cartesian reference frame (eq. 8.8) [verified 4/23/11,</span>
<a name="ln-687"></a><span class="c">! and again on 11/12/13 afterchanges elsewhere]</span>
<a name="ln-688"></a>  <span class="k">call </span><span class="n">TransSpace</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span><span class="n">foil</span><span class="p">%</span><span class="n">F</span><span class="p">,</span><span class="n">foil</span><span class="p">%</span><span class="n">Fn</span><span class="p">,</span><span class="s1">&#39;d&#39;</span><span class="p">,</span><span class="s1">&#39;c&#39;</span><span class="p">)</span>
<a name="ln-689"></a>  <span class="k">call </span><span class="n">TransSpace</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span><span class="n">foil</span><span class="p">%</span><span class="n">q</span><span class="p">,</span><span class="n">foil</span><span class="p">%</span><span class="n">qn</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">,</span><span class="s1">&#39;c&#39;</span><span class="p">)</span>
<a name="ln-690"></a>  <span class="k">call </span><span class="n">NormVec</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span><span class="n">foil</span><span class="p">%</span><span class="n">Fn</span><span class="p">,</span><span class="s1">&#39;c&#39;</span><span class="p">)</span>
<a name="ln-691"></a>  <span class="k">call </span><span class="n">NormVec</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span><span class="n">foil</span><span class="p">%</span><span class="n">qn</span><span class="p">,</span><span class="s1">&#39;c&#39;</span><span class="p">)</span>
<a name="ln-692"></a><span class="c">! a_fc (crystal to foil)  </span>
<a name="ln-693"></a>  <span class="n">a_fc</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">foil</span><span class="p">%</span><span class="n">Fn</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-694"></a>  <span class="n">a_fc</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">foil</span><span class="p">%</span><span class="n">qn</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-695"></a>  <span class="k">call </span><span class="n">CalcCross</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span><span class="n">foil</span><span class="p">%</span><span class="n">Fn</span><span class="p">,</span><span class="n">foil</span><span class="p">%</span><span class="n">qn</span><span class="p">,</span><span class="n">ey</span><span class="p">,</span><span class="s1">&#39;c&#39;</span><span class="p">,</span><span class="s1">&#39;c&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
<a name="ln-696"></a>  <span class="k">call </span><span class="n">NormVec</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span><span class="n">ey</span><span class="p">,</span><span class="s1">&#39;c&#39;</span><span class="p">)</span>
<a name="ln-697"></a>  <span class="n">a_fc</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">ey</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-698"></a>  <span class="n">foil</span><span class="p">%</span><span class="n">a_fc</span> <span class="o">=</span> <span class="n">om2qu</span><span class="p">(</span><span class="n">a_fc</span><span class="p">)</span>
<a name="ln-699"></a>  <span class="k">if</span> <span class="p">(</span><span class="n">dinfo</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-700"></a><span class="k">    </span><span class="n">pret</span> <span class="o">=</span> <span class="s1">&#39;a_fc: &#39;</span>
<a name="ln-701"></a>    <span class="n">ot</span> <span class="o">=</span> <span class="n">init_orientation</span><span class="p">(</span><span class="n">foil</span><span class="p">%</span><span class="n">a_fc</span><span class="p">,</span><span class="s1">&#39;qu&#39;</span><span class="p">)</span>
<a name="ln-702"></a>    <span class="k">call </span><span class="n">print_orientation</span><span class="p">(</span><span class="n">ot</span><span class="p">,</span><span class="s1">&#39;om&#39;</span><span class="p">,</span><span class="n">pret</span><span class="p">)</span> 
<a name="ln-703"></a>  <span class="k">end if</span>
<a name="ln-704"></a>  
<a name="ln-705"></a><span class="c">! a_mc (crystal to microscope)</span>
<a name="ln-706"></a>  <span class="n">foil</span><span class="p">%</span><span class="n">a_mc</span> <span class="o">=</span> <span class="n">quat_mult</span><span class="p">(</span> <span class="nb">conjg</span><span class="p">(</span><span class="n">foil</span><span class="p">%</span><span class="n">a_fm</span><span class="p">),</span> <span class="n">foil</span><span class="p">%</span><span class="n">a_fc</span> <span class="p">)</span>
<a name="ln-707"></a>  <span class="k">if</span> <span class="p">(</span><span class="n">dinfo</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-708"></a><span class="k">    </span><span class="n">pret</span> <span class="o">=</span> <span class="s1">&#39;a_mc: &#39;</span>
<a name="ln-709"></a>    <span class="n">ot</span> <span class="o">=</span> <span class="n">init_orientation</span><span class="p">(</span><span class="n">foil</span><span class="p">%</span><span class="n">a_mc</span><span class="p">,</span><span class="s1">&#39;qu&#39;</span><span class="p">)</span>
<a name="ln-710"></a>    <span class="k">call </span><span class="n">print_orientation</span><span class="p">(</span><span class="n">ot</span><span class="p">,</span><span class="s1">&#39;om&#39;</span><span class="p">,</span><span class="n">pret</span><span class="p">)</span> 
<a name="ln-711"></a>  <span class="k">end if</span>
<a name="ln-712"></a>  
<a name="ln-713"></a><span class="c">! a_ic (crystal to image)</span>
<a name="ln-714"></a>  <span class="n">foil</span><span class="p">%</span><span class="n">a_ic</span> <span class="o">=</span> <span class="n">quat_mult</span><span class="p">(</span> <span class="nb">conjg</span><span class="p">(</span><span class="n">foil</span><span class="p">%</span><span class="n">a_mi</span><span class="p">)</span> <span class="p">,</span> <span class="n">foil</span><span class="p">%</span><span class="n">a_mc</span><span class="p">)</span>
<a name="ln-715"></a>  <span class="k">if</span> <span class="p">(</span><span class="n">dinfo</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-716"></a><span class="k">    </span><span class="n">pret</span> <span class="o">=</span> <span class="s1">&#39;a_ic: &#39;</span>
<a name="ln-717"></a>    <span class="n">ot</span> <span class="o">=</span> <span class="n">init_orientation</span><span class="p">(</span><span class="n">foil</span><span class="p">%</span><span class="n">a_ic</span><span class="p">,</span><span class="s1">&#39;qu&#39;</span><span class="p">)</span>
<a name="ln-718"></a>    <span class="k">call </span><span class="n">print_orientation</span><span class="p">(</span><span class="n">ot</span><span class="p">,</span><span class="s1">&#39;om&#39;</span><span class="p">,</span><span class="n">pret</span><span class="p">)</span> 
<a name="ln-719"></a>  <span class="k">end if</span>
<a name="ln-720"></a>  
<a name="ln-721"></a><span class="c">! a_fi (image to foil)</span>
<a name="ln-722"></a>  <span class="n">foil</span><span class="p">%</span><span class="n">a_fi</span> <span class="o">=</span> <span class="n">quat_mult</span><span class="p">(</span> <span class="n">foil</span><span class="p">%</span><span class="n">a_fc</span> <span class="p">,</span> <span class="nb">conjg</span><span class="p">(</span><span class="n">foil</span><span class="p">%</span><span class="n">a_ic</span><span class="p">)</span> <span class="p">)</span>
<a name="ln-723"></a>  <span class="k">if</span> <span class="p">(</span><span class="n">dinfo</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-724"></a><span class="k">    </span><span class="n">pret</span> <span class="o">=</span> <span class="s1">&#39;a_fi: &#39;</span>
<a name="ln-725"></a>    <span class="n">ot</span> <span class="o">=</span> <span class="n">init_orientation</span><span class="p">(</span><span class="n">foil</span><span class="p">%</span><span class="n">a_fi</span><span class="p">,</span><span class="s1">&#39;qu&#39;</span><span class="p">)</span>
<a name="ln-726"></a>    <span class="k">call </span><span class="n">print_orientation</span><span class="p">(</span><span class="n">ot</span><span class="p">,</span><span class="s1">&#39;om&#39;</span><span class="p">,</span><span class="n">pret</span><span class="p">)</span> 
<a name="ln-727"></a>  <span class="k">end if</span>
<a name="ln-728"></a>  
<a name="ln-729"></a><span class="c">! express the beam direction in the Bravais reference frame [verified 4/23/11, and again on 11/12/13</span>
<a name="ln-730"></a><span class="c">! after changes elsewhere]</span>
<a name="ln-731"></a>  <span class="n">ex</span> <span class="o">=</span> <span class="n">quat_Lp</span><span class="p">(</span> <span class="nb">conjg</span><span class="p">(</span><span class="n">foil</span><span class="p">%</span><span class="n">a_fc</span><span class="p">),</span> <span class="nb">dble</span><span class="p">(</span><span class="n">foil</span><span class="p">%</span><span class="n">Bn</span><span class="p">)</span> <span class="p">)</span> 
<a name="ln-732"></a>  <span class="k">call </span><span class="n">TransSpace</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span><span class="n">ex</span><span class="p">,</span><span class="n">ey</span><span class="p">,</span><span class="s1">&#39;c&#39;</span><span class="p">,</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>
<a name="ln-733"></a>  <span class="k">call </span><span class="n">NormVec</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span><span class="n">ey</span><span class="p">,</span><span class="s1">&#39;c&#39;</span><span class="p">)</span>
<a name="ln-734"></a>  <span class="k">if</span> <span class="p">(</span><span class="n">dinfo</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-735"></a><span class="k">    </span><span class="n">io_real</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">ey</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-736"></a>    <span class="k">call </span><span class="n">WriteValue</span><span class="p">(</span><span class="s1">&#39;  Beam direction (crystal reference frame) = &#39;</span><span class="p">,</span> <span class="n">io_real</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;(&#39;[&#39;,F12.5,&#39;,&#39;,F12.5,&#39;,&#39;,F12.5,&#39;]&#39;/)&quot;</span><span class="p">)</span>
<a name="ln-737"></a>  <span class="k">end if</span>
<a name="ln-738"></a>  
<a name="ln-739"></a><span class="c">! define the foil shape (for now as an elliptic paraboloid z = brx * (x-xc)^2 + bry * (y-yc)^2) </span>
<a name="ln-740"></a><span class="k">if</span> <span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="nb">allocated</span><span class="p">(</span><span class="n">foil</span><span class="p">%</span><span class="n">sg</span><span class="p">))</span> <span class="k">allocate</span><span class="p">(</span><span class="n">foil</span><span class="p">%</span><span class="n">sg</span><span class="p">(</span><span class="n">foil</span><span class="p">%</span><span class="n">npix</span><span class="p">,</span><span class="n">foil</span><span class="p">%</span><span class="n">npiy</span><span class="p">))</span>
<a name="ln-741"></a><span class="c">! if the foil is not bent, then we set this array to zero, otherwise we compute the elliptical paraboloid</span>
<a name="ln-742"></a><span class="k">if</span> <span class="p">((</span><span class="n">foil</span><span class="p">%</span><span class="n">brx</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mf">0.0</span><span class="p">).</span><span class="nb">and</span><span class="p">.(</span><span class="n">foil</span><span class="p">%</span><span class="n">bry</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mf">0.0</span><span class="p">))</span> <span class="k">then</span>
<a name="ln-743"></a><span class="k">  if</span> <span class="p">(</span><span class="n">dinfo</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-744"></a><span class="k">    call </span><span class="n">Message</span><span class="p">(</span><span class="s1">&#39; Initializing a flat foil &#39;</span><span class="p">,</span> <span class="n">frm</span> <span class="o">=</span> <span class="s2">&quot;(A)&quot;</span><span class="p">)</span>
<a name="ln-745"></a>  <span class="k">end if</span>
<a name="ln-746"></a><span class="k">  </span><span class="n">foil</span><span class="p">%</span><span class="n">sg</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-747"></a><span class="k">else</span>
<a name="ln-748"></a><span class="k">  </span><span class="n">dx</span> <span class="o">=</span> <span class="n">foil</span><span class="p">%</span><span class="n">npix</span><span class="o">*</span><span class="mf">0.5</span>
<a name="ln-749"></a>  <span class="n">dy</span> <span class="o">=</span> <span class="n">foil</span><span class="p">%</span><span class="n">npiy</span><span class="o">*</span><span class="mf">0.5</span>
<a name="ln-750"></a>  <span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">foil</span><span class="p">%</span><span class="n">npix</span>
<a name="ln-751"></a>   <span class="n">tt</span> <span class="o">=</span> <span class="n">foil</span><span class="p">%</span><span class="n">brx</span> <span class="o">*</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">-</span><span class="n">dx</span><span class="o">-</span><span class="n">foil</span><span class="p">%</span><span class="n">cpx</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
<a name="ln-752"></a>    <span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">foil</span><span class="p">%</span><span class="n">npiy</span>
<a name="ln-753"></a><span class="c">! initialize the foil shape function; we assume that the center of the elliptic paraboloid is at location (cpx,cpy)</span>
<a name="ln-754"></a><span class="c">! presumably, this surface could also be a saddle point if the brx and bry values have opposite sign ...</span>
<a name="ln-755"></a>      <span class="n">foil</span><span class="p">%</span><span class="n">sg</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span> <span class="o">=</span> <span class="n">tt</span> <span class="o">+</span> <span class="n">foil</span><span class="p">%</span><span class="n">bry</span> <span class="o">*</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">-</span><span class="n">dy</span><span class="o">-</span><span class="n">foil</span><span class="p">%</span><span class="n">cpy</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">foil</span><span class="p">%</span><span class="n">brxy</span> <span class="o">*</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">-</span><span class="n">dy</span><span class="o">-</span><span class="n">foil</span><span class="p">%</span><span class="n">cpy</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">-</span><span class="n">dx</span><span class="o">-</span><span class="n">foil</span><span class="p">%</span><span class="n">cpx</span><span class="p">)</span>
<a name="ln-756"></a>    <span class="k">end do</span>
<a name="ln-757"></a><span class="k">  end do</span>
<a name="ln-758"></a><span class="k">  if</span> <span class="p">(</span><span class="n">dinfo</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-759"></a><span class="k">    call </span><span class="n">Message</span><span class="p">(</span><span class="s1">&#39; Initializing a bent foil &#39;</span><span class="p">,</span> <span class="n">frm</span> <span class="o">=</span> <span class="s2">&quot;(A)&quot;</span><span class="p">)</span>
<a name="ln-760"></a>    <span class="n">io_real</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">=</span><span class="nb">minval</span><span class="p">(</span><span class="n">foil</span><span class="p">%</span><span class="n">sg</span><span class="p">);</span> <span class="n">io_real</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">=</span><span class="nb">maxval</span><span class="p">(</span><span class="n">foil</span><span class="p">%</span><span class="n">sg</span><span class="p">);</span> 
<a name="ln-761"></a>    <span class="k">call </span><span class="n">WriteValue</span><span class="p">(</span><span class="s1">&#39;Range of local excitation error deviations : &#39;</span><span class="p">,</span> <span class="n">io_real</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;(F10.6,&#39;,&#39;,F10.6/)&quot;</span><span class="p">)</span>
<a name="ln-762"></a>  <span class="k">end if</span>
<a name="ln-763"></a><span class="k">end if</span>
<a name="ln-764"></a>
<a name="ln-765"></a><span class="k">end subroutine </span><span class="n">initialize_foil_geometry</span>
<a name="ln-766"></a>
<a name="ln-767"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-768"></a><span class="c">!</span>
<a name="ln-769"></a><span class="c">! SUBROUTINE: makedislocation</span>
<a name="ln-770"></a><span class="c">!</span>
<a name="ln-771"></a><span class="c">!&gt; @author Marc De Graef, Carnegie Mellon University</span>
<a name="ln-772"></a><span class="c">!</span>
<a name="ln-773"></a><span class="c">!&gt; @brief  Compute the dismat displacement matrix for a given dislocation</span>
<a name="ln-774"></a><span class="c">!</span>
<a name="ln-775"></a><span class="c">!&gt; @details This subroutine computes the matrix dismat that describes the displacement field</span>
<a name="ln-776"></a><span class="c">!&gt; of a dislocation.  The routine needs the elastic moduli tensor, the transformation</span>
<a name="ln-777"></a><span class="c">!&gt; matrix between the crystal and dislocation reference frames, and the dislocation</span>
<a name="ln-778"></a><span class="c">!&gt; Burgers vector.  The routine computes the arrays dismat and pa, which should be used as follows:</span>
<a name="ln-779"></a><span class="c">!&gt; </span>
<a name="ln-780"></a><span class="c">!&gt; R_k = 2.0*real([ sum_a=1^3 (dismat(k,a)*log(Z_a)) ]),</span>
<a name="ln-781"></a><span class="c">!&gt; </span>
<a name="ln-782"></a><span class="c">!&gt; with Z_a = x_1 + pa(a)*x_2</span>
<a name="ln-783"></a><span class="c">!&gt;</span>
<a name="ln-784"></a><span class="c">!&gt;  [see CalcR subroutine for more information]</span>
<a name="ln-785"></a><span class="c">!&gt;</span>
<a name="ln-786"></a><span class="c">!&gt; We must also make sure that the x=0 plane of the defect reference frame contains the </span>
<a name="ln-787"></a><span class="c">!&gt; incident beam direction, to avoid getting stacking-fault fringes in the wrong plane...</span>
<a name="ln-788"></a><span class="c">!&gt; Actual stacking faults are added in using a different module (stacking_fault.f90).</span>
<a name="ln-789"></a><span class="c">!&gt;</span>
<a name="ln-790"></a><span class="c">!&gt; @param cell unit cell pointer</span>
<a name="ln-791"></a><span class="c">!&gt; @param defects defect structure</span>
<a name="ln-792"></a><span class="c">!&gt; @param inum</span>
<a name="ln-793"></a><span class="c">!&gt; @param dinfo</span>
<a name="ln-794"></a><span class="c">!&gt; @param DF_L column width</span>
<a name="ln-795"></a><span class="c">! </span>
<a name="ln-796"></a><span class="c">!&gt; @date   1/ 5/99 MDG 1.0 original</span>
<a name="ln-797"></a><span class="c">!&gt; @date   5/19/01 MDG 2.0 f90 version</span>
<a name="ln-798"></a><span class="c">!&gt; @date  11/27/01 MDG 2.1 added kind support</span>
<a name="ln-799"></a><span class="c">!&gt; @date  06/04/13 MDG 3.0 rewrite</span>
<a name="ln-800"></a><span class="c">!&gt; @date  10/30/13 MDG 3.1 debug of all rotation parts</span>
<a name="ln-801"></a><span class="c">!&gt; @date  06/09/14 MDG 4.0 added cell, defects arguments</span>
<a name="ln-802"></a><span class="c">!&gt; @date  06/10/14 MDG 4.1 added foil as argument</span>
<a name="ln-803"></a><span class="c">!&gt; @date  11/21/15 MDG 4.2 moved foil into defects structure</span>
<a name="ln-804"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-805"></a><span class="k">recursive subroutine </span><span class="n">makedislocation</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span><span class="n">defects</span><span class="p">,</span><span class="n">inum</span><span class="p">,</span><span class="n">dinfo</span><span class="p">,</span><span class="n">DF_L</span><span class="p">)</span>
<a name="ln-806"></a><span class="c">!DEC$ ATTRIBUTES DLLEXPORT :: makedislocation</span>
<a name="ln-807"></a>
<a name="ln-808"></a><span class="k">use </span><span class="n">math</span>
<a name="ln-809"></a><span class="k">use </span><span class="n">constants</span>
<a name="ln-810"></a><span class="k">use </span><span class="n">crystal</span>
<a name="ln-811"></a><span class="k">use </span><span class="n">math</span>
<a name="ln-812"></a><span class="k">use </span><span class="n">io</span>
<a name="ln-813"></a><span class="k">use </span><span class="n">symmetry</span>
<a name="ln-814"></a><span class="k">use </span><span class="n">rotations</span>
<a name="ln-815"></a>
<a name="ln-816"></a><span class="k">IMPLICIT NONE</span>
<a name="ln-817"></a>
<a name="ln-818"></a><span class="k">type</span><span class="p">(</span><span class="n">unitcell</span><span class="p">),</span><span class="k">pointer</span>                  <span class="kd">::</span> <span class="n">cell</span>
<a name="ln-819"></a><span class="k">type</span><span class="p">(</span><span class="n">defecttype</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">INOUT</span><span class="p">)</span>          <span class="kd">::</span> <span class="n">defects</span>
<a name="ln-820"></a><span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">irg</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>            <span class="kd">::</span> <span class="n">inum</span>
<a name="ln-821"></a><span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">irg</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>            <span class="kd">::</span> <span class="n">dinfo</span>
<a name="ln-822"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>               <span class="kd">::</span> <span class="n">DF_L</span>
<a name="ln-823"></a>
<a name="ln-824"></a><span class="k">type</span><span class="p">(</span><span class="n">foiltype</span><span class="p">)</span>                          <span class="kd">::</span> <span class="n">foil</span>
<a name="ln-825"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">dbl</span><span class="p">)</span>                          <span class="kd">::</span> <span class="n">zz</span><span class="p">,</span><span class="n">zang</span><span class="p">,</span><span class="n">zmin</span>
<a name="ln-826"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">)</span>                          <span class="kd">::</span> <span class="n">ec</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">6</span><span class="p">),</span><span class="n">lec</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span>
<a name="ln-827"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">dbl</span><span class="p">)</span>                          <span class="kd">::</span> <span class="n">a_dc</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="n">tmp</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span><span class="n">ex</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span><span class="n">ey</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-828"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">dbl</span><span class="p">)</span>                          <span class="kd">::</span> <span class="n">Bij</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="n">Hij</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-829"></a><span class="kt">complex</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">dbl</span><span class="p">)</span>                       <span class="kd">::</span> <span class="n">a</span><span class="p">(</span><span class="mi">0</span><span class="p">:</span><span class="mi">6</span><span class="p">),</span><span class="n">b</span><span class="p">(</span><span class="mi">0</span><span class="p">:</span><span class="mi">6</span><span class="p">),</span><span class="n">c</span><span class="p">(</span><span class="mi">0</span><span class="p">:</span><span class="mi">6</span><span class="p">),</span><span class="n">d</span><span class="p">(</span><span class="mi">0</span><span class="p">:</span><span class="mi">6</span><span class="p">),</span><span class="n">e</span><span class="p">(</span><span class="mi">0</span><span class="p">:</span><span class="mi">6</span><span class="p">),</span><span class="n">ff</span><span class="p">(</span><span class="mi">0</span><span class="p">:</span><span class="mi">6</span><span class="p">),</span><span class="n">tt</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="mi">6</span><span class="p">),</span><span class="n">s</span><span class="p">(</span><span class="mi">0</span><span class="p">:</span><span class="mi">6</span><span class="p">),</span><span class="n">roots</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span> <span class="p">&amp;</span>
<a name="ln-830"></a>                                           <span class="n">zero</span><span class="p">,</span><span class="n">pasq</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span><span class="n">mat</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="n">aka</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="n">Lia</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="n">Mai</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="n">v</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span><span class="n">pas</span>
<a name="ln-831"></a><span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">irg</span><span class="p">)</span>                       <span class="kd">::</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">l</span><span class="p">,</span><span class="n">imin</span><span class="p">,</span><span class="n">ind</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span><span class="n">jnd</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-832"></a>
<a name="ln-833"></a><span class="n">foil</span> <span class="o">=</span> <span class="n">defects</span><span class="p">%</span><span class="n">foil</span>
<a name="ln-834"></a>
<a name="ln-835"></a><span class="c">! convert line direction and g-vector to the Cartesian crystal reference frame</span>
<a name="ln-836"></a><span class="k">call </span><span class="n">TransSpace</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span><span class="n">defects</span><span class="p">%</span><span class="n">DL</span><span class="p">(</span><span class="n">inum</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">defects</span><span class="p">%</span><span class="n">DL</span><span class="p">(</span><span class="n">inum</span><span class="p">)%</span><span class="n">un</span><span class="p">,</span><span class="s1">&#39;d&#39;</span><span class="p">,</span><span class="s1">&#39;c&#39;</span><span class="p">)</span>
<a name="ln-837"></a><span class="k">call </span><span class="n">TransSpace</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span><span class="n">defects</span><span class="p">%</span><span class="n">DL</span><span class="p">(</span><span class="n">inum</span><span class="p">)%</span><span class="n">g</span><span class="p">,</span><span class="n">defects</span><span class="p">%</span><span class="n">DL</span><span class="p">(</span><span class="n">inum</span><span class="p">)%</span><span class="n">gn</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">,</span><span class="s1">&#39;c&#39;</span><span class="p">)</span>
<a name="ln-838"></a><span class="c">! normalize both vectors</span>
<a name="ln-839"></a><span class="k">call </span><span class="n">NormVec</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span><span class="n">defects</span><span class="p">%</span><span class="n">DL</span><span class="p">(</span><span class="n">inum</span><span class="p">)%</span><span class="n">un</span><span class="p">,</span><span class="s1">&#39;c&#39;</span><span class="p">)</span>
<a name="ln-840"></a><span class="k">call </span><span class="n">NormVec</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span><span class="n">defects</span><span class="p">%</span><span class="n">DL</span><span class="p">(</span><span class="n">inum</span><span class="p">)%</span><span class="n">gn</span><span class="p">,</span><span class="s1">&#39;c&#39;</span><span class="p">)</span>
<a name="ln-841"></a>
<a name="ln-842"></a><span class="c">! first find the length of the dislocation line inside the foil along the</span>
<a name="ln-843"></a><span class="c">! dislocation z-axis, which is the line direction; also, compute the intersection</span>
<a name="ln-844"></a><span class="c">! points of the line with the top and bottom surfaces  (all components in [nm])</span>
<a name="ln-845"></a><span class="n">zang</span> <span class="o">=</span> <span class="n">CalcAngle</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span><span class="n">defects</span><span class="p">%</span><span class="n">DL</span><span class="p">(</span><span class="n">inum</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="nb">dble</span><span class="p">(</span><span class="n">foil</span><span class="p">%</span><span class="n">F</span><span class="p">),</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>
<a name="ln-846"></a><span class="n">zz</span> <span class="o">=</span> <span class="nb">cos</span><span class="p">(</span><span class="n">zang</span><span class="p">)</span>
<a name="ln-847"></a><span class="k">if</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">zz</span><span class="p">).</span><span class="n">gt</span><span class="p">.</span><span class="mf">0.00001</span><span class="p">)</span> <span class="k">then </span>
<a name="ln-848"></a><span class="k">  </span><span class="n">defects</span><span class="p">%</span><span class="n">DL</span><span class="p">(</span><span class="n">inum</span><span class="p">)%</span><span class="n">zu</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">foil</span><span class="p">%</span><span class="n">z0</span><span class="o">/</span><span class="n">zz</span>
<a name="ln-849"></a><span class="k">else</span>
<a name="ln-850"></a><span class="k">  </span><span class="n">defects</span><span class="p">%</span><span class="n">DL</span><span class="p">(</span><span class="n">inum</span><span class="p">)%</span><span class="n">zu</span> <span class="o">=</span> <span class="mi">10000</span><span class="mf">0.0</span>         <span class="c">! this is when the dislocation is nearly parallel to the foil</span>
<a name="ln-851"></a><span class="k">end if</span>
<a name="ln-852"></a>
<a name="ln-853"></a><span class="c">! transform the line direction to the foil reference frame</span>
<a name="ln-854"></a><span class="n">tmp</span> <span class="o">=</span> <span class="n">quat_Lp</span><span class="p">(</span> <span class="n">foil</span><span class="p">%</span><span class="n">a_fc</span><span class="p">,</span> <span class="nb">dble</span><span class="p">(</span><span class="n">defects</span><span class="p">%</span><span class="n">DL</span><span class="p">(</span><span class="n">inum</span><span class="p">)%</span><span class="n">un</span><span class="p">)</span> <span class="p">)</span> <span class="o">/</span> <span class="n">DF_L</span>
<a name="ln-855"></a>
<a name="ln-856"></a><span class="k">if</span> <span class="p">(</span><span class="n">dinfo</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-857"></a><span class="k">  write</span> <span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s1">&#39;transformed line direction &#39;</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">zang</span><span class="p">,</span> <span class="n">zz</span>
<a name="ln-858"></a><span class="k">end if</span>
<a name="ln-859"></a>
<a name="ln-860"></a><span class="c">! determine the top and bottom intersection coordinates </span>
<a name="ln-861"></a><span class="k">if</span> <span class="p">(</span><span class="n">zz</span><span class="p">.</span><span class="n">gt</span><span class="p">.</span><span class="mf">0.0</span><span class="p">)</span> <span class="k">then</span>  <span class="c">! u points to the top of the foil</span>
<a name="ln-862"></a>    <span class="n">defects</span><span class="p">%</span><span class="n">DL</span><span class="p">(</span><span class="n">inum</span><span class="p">)%</span><span class="n">top</span> <span class="o">=</span> <span class="p">(</span><span class="o">/</span> <span class="n">defects</span><span class="p">%</span><span class="n">DL</span><span class="p">(</span><span class="n">inum</span><span class="p">)%</span><span class="n">id</span> <span class="o">+</span> <span class="n">tmp</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">defects</span><span class="p">%</span><span class="n">DL</span><span class="p">(</span><span class="n">inum</span><span class="p">)%</span><span class="n">zu</span><span class="p">,</span> <span class="n">defects</span><span class="p">%</span><span class="n">DL</span><span class="p">(</span><span class="n">inum</span><span class="p">)%</span><span class="n">jd</span> <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-863"></a>        <span class="n">tmp</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">defects</span><span class="p">%</span><span class="n">DL</span><span class="p">(</span><span class="n">inum</span><span class="p">)%</span><span class="n">zu</span><span class="p">,</span> <span class="mf">0.5D0</span><span class="o">*</span><span class="n">foil</span><span class="p">%</span><span class="n">z0</span> <span class="o">/</span><span class="p">)</span>
<a name="ln-864"></a>    <span class="n">defects</span><span class="p">%</span><span class="n">DL</span><span class="p">(</span><span class="n">inum</span><span class="p">)%</span><span class="n">bottom</span> <span class="o">=</span> <span class="p">(</span><span class="o">/</span> <span class="n">defects</span><span class="p">%</span><span class="n">DL</span><span class="p">(</span><span class="n">inum</span><span class="p">)%</span><span class="n">id</span> <span class="o">-</span> <span class="n">tmp</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">defects</span><span class="p">%</span><span class="n">DL</span><span class="p">(</span><span class="n">inum</span><span class="p">)%</span><span class="n">zu</span><span class="p">,</span> <span class="n">defects</span><span class="p">%</span><span class="n">DL</span><span class="p">(</span><span class="n">inum</span><span class="p">)%</span><span class="n">jd</span> <span class="o">-</span> <span class="p">&amp;</span>
<a name="ln-865"></a>        <span class="n">tmp</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">defects</span><span class="p">%</span><span class="n">DL</span><span class="p">(</span><span class="n">inum</span><span class="p">)%</span><span class="n">zu</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5D0</span><span class="o">*</span><span class="n">foil</span><span class="p">%</span><span class="n">z0</span> <span class="o">/</span><span class="p">)</span>
<a name="ln-866"></a><span class="k">else</span>                 <span class="c">! u points to the bottom of the foil</span>
<a name="ln-867"></a>    <span class="n">defects</span><span class="p">%</span><span class="n">DL</span><span class="p">(</span><span class="n">inum</span><span class="p">)%</span><span class="n">top</span> <span class="o">=</span> <span class="p">(</span><span class="o">/</span> <span class="n">defects</span><span class="p">%</span><span class="n">DL</span><span class="p">(</span><span class="n">inum</span><span class="p">)%</span><span class="n">id</span> <span class="o">-</span> <span class="n">tmp</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">defects</span><span class="p">%</span><span class="n">DL</span><span class="p">(</span><span class="n">inum</span><span class="p">)%</span><span class="n">zu</span><span class="p">,</span> <span class="n">defects</span><span class="p">%</span><span class="n">DL</span><span class="p">(</span><span class="n">inum</span><span class="p">)%</span><span class="n">jd</span> <span class="o">-</span> <span class="p">&amp;</span>
<a name="ln-868"></a>        <span class="n">tmp</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">defects</span><span class="p">%</span><span class="n">DL</span><span class="p">(</span><span class="n">inum</span><span class="p">)%</span><span class="n">zu</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5D0</span><span class="o">*</span><span class="n">foil</span><span class="p">%</span><span class="n">z0</span> <span class="o">/</span><span class="p">)</span>
<a name="ln-869"></a>    <span class="n">defects</span><span class="p">%</span><span class="n">DL</span><span class="p">(</span><span class="n">inum</span><span class="p">)%</span><span class="n">bottom</span> <span class="o">=</span> <span class="p">(</span><span class="o">/</span> <span class="n">defects</span><span class="p">%</span><span class="n">DL</span><span class="p">(</span><span class="n">inum</span><span class="p">)%</span><span class="n">id</span> <span class="o">+</span> <span class="n">tmp</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">defects</span><span class="p">%</span><span class="n">DL</span><span class="p">(</span><span class="n">inum</span><span class="p">)%</span><span class="n">zu</span><span class="p">,</span> <span class="n">defects</span><span class="p">%</span><span class="n">DL</span><span class="p">(</span><span class="n">inum</span><span class="p">)%</span><span class="n">jd</span> <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-870"></a>        <span class="n">tmp</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">defects</span><span class="p">%</span><span class="n">DL</span><span class="p">(</span><span class="n">inum</span><span class="p">)%</span><span class="n">zu</span><span class="p">,</span> <span class="mf">0.5D0</span><span class="o">*</span><span class="n">foil</span><span class="p">%</span><span class="n">z0</span> <span class="o">/</span><span class="p">)</span>
<a name="ln-871"></a><span class="k">end if  </span>
<a name="ln-872"></a>
<a name="ln-873"></a><span class="k">if</span> <span class="p">(</span><span class="n">dinfo</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-874"></a><span class="k">  write</span> <span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="n">defects</span><span class="p">%</span><span class="n">DL</span><span class="p">(</span><span class="n">inum</span><span class="p">)%</span><span class="n">id</span><span class="p">,</span><span class="n">defects</span><span class="p">%</span><span class="n">DL</span><span class="p">(</span><span class="n">inum</span><span class="p">)%</span><span class="n">jd</span>
<a name="ln-875"></a>  <span class="k">write</span> <span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s1">&#39;dislocation top intersection at &#39;</span><span class="p">,</span><span class="n">defects</span><span class="p">%</span><span class="n">DL</span><span class="p">(</span><span class="n">inum</span><span class="p">)%</span><span class="n">top</span>
<a name="ln-876"></a>  <span class="k">write</span> <span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s1">&#39;dislocation bottom intersection at &#39;</span><span class="p">,</span><span class="n">defects</span><span class="p">%</span><span class="n">DL</span><span class="p">(</span><span class="n">inum</span><span class="p">)%</span><span class="n">bottom</span>
<a name="ln-877"></a><span class="k">end if</span> 
<a name="ln-878"></a>
<a name="ln-879"></a><span class="c">! a_dc (crystal to defect)  matrix corrected on 11/29/10 to put defect x-axis in the plane of u and B</span>
<a name="ln-880"></a><span class="k">if</span> <span class="p">(</span><span class="n">dinfo</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-881"></a><span class="k">  write</span> <span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s1">&#39;cartesian quantities&#39;</span>
<a name="ln-882"></a>  <span class="k">write</span> <span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s1">&#39;unit line direction = &#39;</span><span class="p">,</span><span class="n">defects</span><span class="p">%</span><span class="n">DL</span><span class="p">(</span><span class="n">inum</span><span class="p">)%</span><span class="n">un</span>
<a name="ln-883"></a>  <span class="k">write</span> <span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s1">&#39;unit beam direction = &#39;</span><span class="p">,</span><span class="n">foil</span><span class="p">%</span><span class="n">Bn</span>
<a name="ln-884"></a><span class="k">end if</span>
<a name="ln-885"></a>
<a name="ln-886"></a><span class="c">! transform beam direction (currently in foil frame) to cartesian </span>
<a name="ln-887"></a><span class="n">tmp</span> <span class="o">=</span> <span class="n">quat_Lp</span><span class="p">(</span> <span class="nb">conjg</span><span class="p">(</span><span class="n">foil</span><span class="p">%</span><span class="n">a_fc</span><span class="p">),</span> <span class="nb">dble</span><span class="p">(</span><span class="n">foil</span><span class="p">%</span><span class="n">Bn</span><span class="p">))</span>
<a name="ln-888"></a><span class="c">!tmp = quat_rotate_vector(conjg(foil%a_fc), (/ 0.0D0, 0.0D0, -1.0D0/) )</span>
<a name="ln-889"></a><span class="k">call </span><span class="n">NormVec</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span><span class="n">tmp</span><span class="p">,</span><span class="s1">&#39;c&#39;</span><span class="p">)</span>
<a name="ln-890"></a>
<a name="ln-891"></a><span class="c">! the defect z axis is the line direction and x is in the plane of u and B to avoid the intrinsic discontinuity (cut plane)</span>
<a name="ln-892"></a><span class="n">a_dc</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">defects</span><span class="p">%</span><span class="n">DL</span><span class="p">(</span><span class="n">inum</span><span class="p">)%</span><span class="n">un</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-893"></a><span class="k">call </span><span class="n">CalcCross</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span><span class="nb">dble</span><span class="p">(</span><span class="n">defects</span><span class="p">%</span><span class="n">DL</span><span class="p">(</span><span class="n">inum</span><span class="p">)%</span><span class="n">un</span><span class="p">),</span><span class="n">tmp</span><span class="p">,</span><span class="n">ex</span><span class="p">,</span><span class="s1">&#39;c&#39;</span><span class="p">,</span><span class="s1">&#39;c&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
<a name="ln-894"></a><span class="k">call </span><span class="n">NormVec</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span><span class="n">ex</span><span class="p">,</span><span class="s1">&#39;c&#39;</span><span class="p">)</span>
<a name="ln-895"></a><span class="n">a_dc</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">ex</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-896"></a><span class="k">call </span><span class="n">CalcCross</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span><span class="nb">dble</span><span class="p">(</span><span class="n">defects</span><span class="p">%</span><span class="n">DL</span><span class="p">(</span><span class="n">inum</span><span class="p">)%</span><span class="n">un</span><span class="p">),</span><span class="n">ex</span><span class="p">,</span><span class="n">ey</span><span class="p">,</span><span class="s1">&#39;c&#39;</span><span class="p">,</span><span class="s1">&#39;c&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
<a name="ln-897"></a><span class="k">call </span><span class="n">NormVec</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span><span class="n">ey</span><span class="p">,</span><span class="s1">&#39;c&#39;</span><span class="p">)</span>
<a name="ln-898"></a><span class="n">a_dc</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">ey</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-899"></a><span class="n">defects</span><span class="p">%</span><span class="n">DL</span><span class="p">(</span><span class="n">inum</span><span class="p">)%</span><span class="n">a_dc</span> <span class="o">=</span> <span class="n">om2qu</span><span class="p">(</span><span class="n">a_dc</span><span class="p">)</span>
<a name="ln-900"></a>
<a name="ln-901"></a><span class="k">if</span> <span class="p">(</span><span class="n">dinfo</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-902"></a><span class="k">  call </span><span class="n">PrintMatrixd</span><span class="p">(</span><span class="s1">&#39;a_dc&#39;</span><span class="p">,</span><span class="n">a_dc</span><span class="p">)</span>
<a name="ln-903"></a><span class="k">end if</span>
<a name="ln-904"></a>
<a name="ln-905"></a><span class="c">! a_di (image to defect)</span>
<a name="ln-906"></a><span class="n">defects</span><span class="p">%</span><span class="n">DL</span><span class="p">(</span><span class="n">inum</span><span class="p">)%</span><span class="n">a_di</span> <span class="o">=</span> <span class="n">quat_mult</span><span class="p">(</span> <span class="n">defects</span><span class="p">%</span><span class="n">DL</span><span class="p">(</span><span class="n">inum</span><span class="p">)%</span><span class="n">a_dc</span><span class="p">,</span> <span class="nb">conjg</span><span class="p">(</span><span class="n">foil</span><span class="p">%</span><span class="n">a_ic</span><span class="p">)</span> <span class="p">)</span>
<a name="ln-907"></a><span class="n">defects</span><span class="p">%</span><span class="n">DL</span><span class="p">(</span><span class="n">inum</span><span class="p">)%</span><span class="n">a_id</span> <span class="o">=</span> <span class="nb">conjg</span><span class="p">(</span><span class="n">defects</span><span class="p">%</span><span class="n">DL</span><span class="p">(</span><span class="n">inum</span><span class="p">)%</span><span class="n">a_di</span><span class="p">)</span>
<a name="ln-908"></a>
<a name="ln-909"></a><span class="k">if</span> <span class="p">(</span><span class="n">dinfo</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-910"></a><span class="k">  call </span><span class="n">print_orientation_d</span><span class="p">(</span><span class="n">init_orientation_d</span><span class="p">(</span><span class="n">defects</span><span class="p">%</span><span class="n">DL</span><span class="p">(</span><span class="n">inum</span><span class="p">)%</span><span class="n">a_di</span><span class="p">,</span><span class="s1">&#39;qu&#39;</span><span class="p">),</span><span class="s1">&#39;om&#39;</span><span class="p">,</span><span class="s1">&#39;a_di:     &#39;</span><span class="p">)</span>
<a name="ln-911"></a>  <span class="k">call </span><span class="n">print_orientation_d</span><span class="p">(</span><span class="n">init_orientation_d</span><span class="p">(</span><span class="n">defects</span><span class="p">%</span><span class="n">DL</span><span class="p">(</span><span class="n">inum</span><span class="p">)%</span><span class="n">a_id</span><span class="p">,</span><span class="s1">&#39;qu&#39;</span><span class="p">),</span><span class="s1">&#39;om&#39;</span><span class="p">,</span><span class="s1">&#39;a_id:     &#39;</span><span class="p">)</span>
<a name="ln-912"></a><span class="k">end if</span>
<a name="ln-913"></a>
<a name="ln-914"></a><span class="c">! finally, get the foil to defect transformation (used in defect module)</span>
<a name="ln-915"></a><span class="n">defects</span><span class="p">%</span><span class="n">DL</span><span class="p">(</span><span class="n">inum</span><span class="p">)%</span><span class="n">a_df</span> <span class="o">=</span> <span class="n">quat_mult</span><span class="p">(</span> <span class="n">defects</span><span class="p">%</span><span class="n">DL</span><span class="p">(</span><span class="n">inum</span><span class="p">)%</span><span class="n">a_di</span><span class="p">,</span> <span class="nb">conjg</span><span class="p">(</span><span class="n">foil</span><span class="p">%</span><span class="n">a_fi</span><span class="p">)</span> <span class="p">)</span>
<a name="ln-916"></a>
<a name="ln-917"></a><span class="c">! Burgers vector (in the defect reference frame !!!)</span>
<a name="ln-918"></a><span class="c">! first transform Burgers vector to crystal cartesian reference frame</span>
<a name="ln-919"></a><span class="k">call </span><span class="n">TransSpace</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span><span class="nb">dble</span><span class="p">(</span><span class="n">defects</span><span class="p">%</span><span class="n">DL</span><span class="p">(</span><span class="n">inum</span><span class="p">)%</span><span class="n">burg</span><span class="p">),</span><span class="n">tmp</span><span class="p">,</span><span class="s1">&#39;d&#39;</span><span class="p">,</span><span class="s1">&#39;c&#39;</span><span class="p">)</span>
<a name="ln-920"></a><span class="c">! then convert this to the defect reference frame</span>
<a name="ln-921"></a><span class="n">defects</span><span class="p">%</span><span class="n">DL</span><span class="p">(</span><span class="n">inum</span><span class="p">)%</span><span class="n">burgd</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">quat_Lp</span><span class="p">(</span> <span class="n">defects</span><span class="p">%</span><span class="n">DL</span><span class="p">(</span><span class="n">inum</span><span class="p">)%</span><span class="n">a_dc</span><span class="p">,</span><span class="nb">dble</span><span class="p">(</span><span class="n">tmp</span><span class="p">))</span>
<a name="ln-922"></a>
<a name="ln-923"></a><span class="k">if</span> <span class="p">(</span><span class="n">dinfo</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-924"></a><span class="k">  write</span> <span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s1">&#39;rotated burgers vector  = &#39;</span><span class="p">,</span> <span class="n">defects</span><span class="p">%</span><span class="n">DL</span><span class="p">(</span><span class="n">inum</span><span class="p">)%</span><span class="n">burgd</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span> 
<a name="ln-925"></a><span class="k">end if</span>
<a name="ln-926"></a>
<a name="ln-927"></a><span class="c">! transform the elastic moduli</span>
<a name="ln-928"></a><span class="n">lec</span> <span class="o">=</span> <span class="n">foil</span><span class="p">%</span><span class="n">elmo</span>
<a name="ln-929"></a>
<a name="ln-930"></a><span class="c">! transform lec to defect reference frame</span>
<a name="ln-931"></a><span class="n">a_dc</span> <span class="o">=</span> <span class="n">qu2om</span><span class="p">(</span><span class="n">defects</span><span class="p">%</span><span class="n">DL</span><span class="p">(</span><span class="n">inum</span><span class="p">)%</span><span class="n">a_dc</span><span class="p">)</span>
<a name="ln-932"></a><span class="k">call </span><span class="n">TransFourthRankTensor</span><span class="p">(</span><span class="n">a_dc</span><span class="p">,</span><span class="n">lec</span><span class="p">,</span><span class="n">ec</span><span class="p">)</span>
<a name="ln-933"></a><span class="k">if</span> <span class="p">(</span><span class="n">dinfo</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span>  <span class="k">then </span>
<a name="ln-934"></a><span class="k">  write</span> <span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s1">&#39;Elasticity tensor in defect reference frame&#39;</span>
<a name="ln-935"></a>  <span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="mi">6</span> 
<a name="ln-936"></a>    <span class="k">write</span> <span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="s2">&quot;(6(F8.4,2x))&quot;</span><span class="p">)</span> <span class="p">(</span><span class="n">ec</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">),</span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span>
<a name="ln-937"></a>  <span class="k">end do</span>
<a name="ln-938"></a><span class="k">  write</span> <span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s1">&#39;----&#39;</span>
<a name="ln-939"></a><span class="k">end if</span>
<a name="ln-940"></a>
<a name="ln-941"></a><span class="c">! next, create the sextic polynomial</span>
<a name="ln-942"></a><span class="n">zero</span> <span class="o">=</span> <span class="nb">cmplx</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">0.0</span><span class="p">,</span><span class="n">dbl</span><span class="p">)</span>
<a name="ln-943"></a><span class="n">a</span><span class="o">=</span><span class="n">zero</span><span class="p">;</span> <span class="n">b</span><span class="o">=</span><span class="n">zero</span><span class="p">;</span> <span class="n">c</span><span class="o">=</span><span class="n">zero</span><span class="p">;</span> <span class="n">d</span><span class="o">=</span><span class="n">zero</span><span class="p">;</span> <span class="n">e</span><span class="o">=</span><span class="n">zero</span><span class="p">;</span> <span class="n">ff</span><span class="o">=</span><span class="n">zero</span>
<a name="ln-944"></a><span class="n">a</span><span class="p">(</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="o">/</span> <span class="nb">cmplx</span><span class="p">(</span><span class="n">ec</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="mf">0.0</span><span class="p">,</span><span class="n">dbl</span><span class="p">),</span> <span class="nb">cmplx</span><span class="p">(</span><span class="n">ec</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span><span class="o">*</span><span class="mf">2.0</span><span class="p">,</span><span class="mf">0.0</span><span class="p">,</span><span class="n">dbl</span><span class="p">),</span>     <span class="nb">cmplx</span><span class="p">(</span><span class="n">ec</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">6</span><span class="p">),</span><span class="mf">0.0</span><span class="p">,</span><span class="n">dbl</span><span class="p">)</span> <span class="o">/</span><span class="p">)</span>
<a name="ln-945"></a><span class="n">b</span><span class="p">(</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="o">/</span> <span class="nb">cmplx</span><span class="p">(</span><span class="n">ec</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">6</span><span class="p">),</span><span class="mf">0.0</span><span class="p">,</span><span class="n">dbl</span><span class="p">),</span> <span class="nb">cmplx</span><span class="p">(</span><span class="n">ec</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span><span class="o">*</span><span class="mf">2.0</span><span class="p">,</span><span class="mf">0.0</span><span class="p">,</span><span class="n">dbl</span><span class="p">),</span>     <span class="nb">cmplx</span><span class="p">(</span><span class="n">ec</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="mf">0.0</span><span class="p">,</span><span class="n">dbl</span><span class="p">)</span> <span class="o">/</span><span class="p">)</span>
<a name="ln-946"></a><span class="n">c</span><span class="p">(</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="o">/</span> <span class="nb">cmplx</span><span class="p">(</span><span class="n">ec</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span><span class="mf">0.0</span><span class="p">,</span><span class="n">dbl</span><span class="p">),</span> <span class="nb">cmplx</span><span class="p">(</span><span class="n">ec</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span><span class="o">*</span><span class="mf">2.0</span><span class="p">,</span><span class="mf">0.0</span><span class="p">,</span><span class="n">dbl</span><span class="p">),</span>     <span class="nb">cmplx</span><span class="p">(</span><span class="n">ec</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span><span class="mf">0.0</span><span class="p">,</span><span class="n">dbl</span><span class="p">)</span> <span class="o">/</span><span class="p">)</span>
<a name="ln-947"></a><span class="n">d</span><span class="p">(</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="o">/</span> <span class="nb">cmplx</span><span class="p">(</span><span class="n">ec</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">),</span><span class="mf">0.0</span><span class="p">,</span><span class="n">dbl</span><span class="p">),</span> <span class="nb">cmplx</span><span class="p">(</span><span class="n">ec</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span><span class="o">+</span><span class="n">ec</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span><span class="mf">0.0</span><span class="p">,</span><span class="n">dbl</span><span class="p">),</span> <span class="nb">cmplx</span><span class="p">(</span><span class="n">ec</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span><span class="mf">0.0</span><span class="p">,</span><span class="n">dbl</span><span class="p">)</span> <span class="o">/</span><span class="p">)</span>
<a name="ln-948"></a><span class="n">e</span><span class="p">(</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="o">/</span> <span class="nb">cmplx</span><span class="p">(</span><span class="n">ec</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span><span class="mf">0.0</span><span class="p">,</span><span class="n">dbl</span><span class="p">),</span> <span class="nb">cmplx</span><span class="p">(</span><span class="n">ec</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="o">+</span><span class="n">ec</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">),</span><span class="mf">0.0</span><span class="p">,</span><span class="n">dbl</span><span class="p">),</span> <span class="nb">cmplx</span><span class="p">(</span><span class="n">ec</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">6</span><span class="p">),</span><span class="mf">0.0</span><span class="p">,</span><span class="n">dbl</span><span class="p">)</span> <span class="o">/</span><span class="p">)</span>
<a name="ln-949"></a><span class="n">ff</span><span class="p">(</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="o">/</span> <span class="nb">cmplx</span><span class="p">(</span><span class="n">ec</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">6</span><span class="p">),</span><span class="mf">0.0</span><span class="p">,</span><span class="n">dbl</span><span class="p">),</span> <span class="nb">cmplx</span><span class="p">(</span><span class="n">ec</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="n">ec</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">6</span><span class="p">),</span><span class="mf">0.0</span><span class="p">,</span><span class="n">dbl</span><span class="p">),</span> <span class="nb">cmplx</span><span class="p">(</span><span class="n">ec</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">6</span><span class="p">),</span><span class="mf">0.0</span><span class="p">,</span><span class="n">dbl</span><span class="p">)</span> <span class="o">/</span><span class="p">)</span>
<a name="ln-950"></a><span class="n">tt</span> <span class="o">=</span> <span class="n">zero</span>
<a name="ln-951"></a><span class="n">s</span> <span class="o">=</span> <span class="n">zero</span>
<a name="ln-952"></a>
<a name="ln-953"></a><span class="c">! matrix elements</span>
<a name="ln-954"></a><span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="mi">6</span> 
<a name="ln-955"></a> <span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">j</span> 
<a name="ln-956"></a>  <span class="n">tt</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">)</span> <span class="o">=</span> <span class="n">tt</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">)</span> <span class="o">+</span> <span class="n">a</span><span class="p">(</span><span class="n">j</span><span class="o">-</span><span class="n">i</span><span class="p">)</span><span class="o">*</span><span class="n">b</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
<a name="ln-957"></a>  <span class="n">tt</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="n">j</span><span class="p">)</span> <span class="o">=</span> <span class="n">tt</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="n">j</span><span class="p">)</span> <span class="o">+</span> <span class="n">d</span><span class="p">(</span><span class="n">j</span><span class="o">-</span><span class="n">i</span><span class="p">)</span><span class="o">*</span><span class="n">e</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
<a name="ln-958"></a>  <span class="n">tt</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="n">j</span><span class="p">)</span> <span class="o">=</span> <span class="n">tt</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="n">j</span><span class="p">)</span> <span class="o">+</span> <span class="n">a</span><span class="p">(</span><span class="n">j</span><span class="o">-</span><span class="n">i</span><span class="p">)</span><span class="o">*</span><span class="n">d</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
<a name="ln-959"></a>  <span class="n">tt</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="n">j</span><span class="p">)</span> <span class="o">=</span> <span class="n">tt</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="n">j</span><span class="p">)</span> <span class="o">+</span> <span class="n">b</span><span class="p">(</span><span class="n">j</span><span class="o">-</span><span class="n">i</span><span class="p">)</span><span class="o">*</span><span class="n">e</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
<a name="ln-960"></a>  <span class="n">tt</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="n">j</span><span class="p">)</span> <span class="o">=</span> <span class="n">tt</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="n">j</span><span class="p">)</span> <span class="o">+</span> <span class="n">c</span><span class="p">(</span><span class="n">j</span><span class="o">-</span><span class="n">i</span><span class="p">)</span><span class="o">*</span><span class="n">ff</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
<a name="ln-961"></a> <span class="k">end do</span>
<a name="ln-962"></a><span class="k">end do</span>
<a name="ln-963"></a>
<a name="ln-964"></a><span class="c">! determinant leading to the sextic equation</span>
<a name="ln-965"></a><span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="mi">6</span> 
<a name="ln-966"></a> <span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">j</span> 
<a name="ln-967"></a>  <span class="n">s</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="o">=</span> <span class="n">s</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="o">+</span> <span class="n">tt</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="o">-</span><span class="n">i</span><span class="p">)</span><span class="o">*</span><span class="n">c</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">tt</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="n">j</span><span class="o">-</span><span class="n">i</span><span class="p">)</span><span class="o">*</span><span class="n">ff</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">-</span> <span class="n">tt</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="n">j</span><span class="o">-</span><span class="n">i</span><span class="p">)</span><span class="o">*</span><span class="n">d</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">-</span> <span class="n">tt</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="n">j</span><span class="o">-</span><span class="n">i</span><span class="p">)</span><span class="o">*</span><span class="n">e</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">-</span> <span class="n">tt</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="n">j</span><span class="o">-</span><span class="n">i</span><span class="p">)</span><span class="o">*</span><span class="n">ff</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
<a name="ln-968"></a> <span class="k">end do</span>
<a name="ln-969"></a><span class="k">end do</span>
<a name="ln-970"></a>
<a name="ln-971"></a><span class="c">! get the complex root pairs</span>
<a name="ln-972"></a><span class="k">call </span><span class="n">zroots</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">roots</span><span class="p">)</span>
<a name="ln-973"></a>
<a name="ln-974"></a><span class="c">! then, solve the equation for the vector A_k using the roots with positive imaginary part.</span>
<a name="ln-975"></a><span class="n">k</span><span class="o">=</span><span class="mi">1</span>
<a name="ln-976"></a><span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="mi">6</span>
<a name="ln-977"></a>  <span class="k">if</span> <span class="p">(</span><span class="nb">aimag</span><span class="p">(</span><span class="n">roots</span><span class="p">(</span><span class="n">j</span><span class="p">)).</span><span class="n">gt</span><span class="p">.</span><span class="mf">0.0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-978"></a><span class="k">    </span><span class="n">defects</span><span class="p">%</span><span class="n">DL</span><span class="p">(</span><span class="n">inum</span><span class="p">)%</span><span class="n">pa</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">roots</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
<a name="ln-979"></a>    <span class="n">k</span><span class="o">=</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span>
<a name="ln-980"></a>  <span class="k">end if</span>
<a name="ln-981"></a><span class="k">end do</span>
<a name="ln-982"></a>
<a name="ln-983"></a><span class="c">! renumber them to avoid the symmetry degeneracy (see page 328 Head et al.)</span>
<a name="ln-984"></a><span class="n">v</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">ec</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">defects</span><span class="p">%</span><span class="n">DL</span><span class="p">(</span><span class="n">inum</span><span class="p">)%</span><span class="n">pa</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">ec</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="n">ec</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="o">*</span><span class="n">defects</span><span class="p">%</span><span class="n">DL</span><span class="p">(</span><span class="n">inum</span><span class="p">)%</span><span class="n">pa</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
<a name="ln-985"></a><span class="n">zmin</span> <span class="o">=</span> <span class="mi">10</span><span class="mf">0.0</span>
<a name="ln-986"></a><span class="n">imin</span> <span class="o">=</span> <span class="mi">0</span>
<a name="ln-987"></a>
<a name="ln-988"></a><span class="c">! where is the smallest value ?</span>
<a name="ln-989"></a><span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span>
<a name="ln-990"></a>  <span class="k">if</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">v</span><span class="p">(</span><span class="n">i</span><span class="p">)).</span><span class="n">lt</span><span class="p">.</span><span class="n">zmin</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-991"></a><span class="k">    </span><span class="n">imin</span><span class="o">=</span><span class="n">i</span>
<a name="ln-992"></a>    <span class="n">zmin</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">v</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
<a name="ln-993"></a>  <span class="k">end if</span>
<a name="ln-994"></a><span class="k">end do</span>
<a name="ln-995"></a>
<a name="ln-996"></a><span class="c">! is the 3rd one the smallest ? if not, then swap with the current 3rd one.</span>
<a name="ln-997"></a><span class="k">if</span> <span class="p">(</span><span class="n">imin</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="mi">3</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-998"></a><span class="k">  </span><span class="n">pas</span> <span class="o">=</span> <span class="n">defects</span><span class="p">%</span><span class="n">DL</span><span class="p">(</span><span class="n">inum</span><span class="p">)%</span><span class="n">pa</span><span class="p">(</span><span class="n">imin</span><span class="p">)</span>
<a name="ln-999"></a>  <span class="n">defects</span><span class="p">%</span><span class="n">DL</span><span class="p">(</span><span class="n">inum</span><span class="p">)%</span><span class="n">pa</span><span class="p">(</span><span class="n">imin</span><span class="p">)</span><span class="o">=</span><span class="n">defects</span><span class="p">%</span><span class="n">DL</span><span class="p">(</span><span class="n">inum</span><span class="p">)%</span><span class="n">pa</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-1000"></a>  <span class="n">defects</span><span class="p">%</span><span class="n">DL</span><span class="p">(</span><span class="n">inum</span><span class="p">)%</span><span class="n">pa</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">=</span><span class="n">pas</span>
<a name="ln-1001"></a><span class="k">end if</span>
<a name="ln-1002"></a><span class="k">  </span><span class="n">pas</span> <span class="o">=</span> <span class="n">defects</span><span class="p">%</span><span class="n">DL</span><span class="p">(</span><span class="n">inum</span><span class="p">)%</span><span class="n">pa</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-1003"></a>  <span class="n">defects</span><span class="p">%</span><span class="n">DL</span><span class="p">(</span><span class="n">inum</span><span class="p">)%</span><span class="n">pa</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">=</span><span class="n">defects</span><span class="p">%</span><span class="n">DL</span><span class="p">(</span><span class="n">inum</span><span class="p">)%</span><span class="n">pa</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<a name="ln-1004"></a>  <span class="n">defects</span><span class="p">%</span><span class="n">DL</span><span class="p">(</span><span class="n">inum</span><span class="p">)%</span><span class="n">pa</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">=</span><span class="n">pas</span>
<a name="ln-1005"></a>
<a name="ln-1006"></a><span class="c">! eliminate really small numbers</span>
<a name="ln-1007"></a><span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span>
<a name="ln-1008"></a>  <span class="k">if</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="nb">aimag</span><span class="p">(</span><span class="n">defects</span><span class="p">%</span><span class="n">DL</span><span class="p">(</span><span class="n">inum</span><span class="p">)%</span><span class="n">pa</span><span class="p">(</span><span class="n">i</span><span class="p">))).</span><span class="n">lt</span><span class="p">.</span><span class="mf">1.0e-8</span><span class="p">)</span>  <span class="n">defects</span><span class="p">%</span><span class="n">DL</span><span class="p">(</span><span class="n">inum</span><span class="p">)%</span><span class="n">pa</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">=</span><span class="nb">cmplx</span><span class="p">(</span><span class="kt">real</span><span class="p">(</span><span class="n">defects</span><span class="p">%</span><span class="n">DL</span><span class="p">(</span><span class="n">inum</span><span class="p">)%</span><span class="n">pa</span><span class="p">(</span><span class="n">i</span><span class="p">)),</span><span class="mf">0.0</span><span class="p">,</span><span class="n">dbl</span><span class="p">)</span>
<a name="ln-1009"></a>  <span class="k">if</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="kt">real</span><span class="p">(</span><span class="n">defects</span><span class="p">%</span><span class="n">DL</span><span class="p">(</span><span class="n">inum</span><span class="p">)%</span><span class="n">pa</span><span class="p">(</span><span class="n">i</span><span class="p">))).</span><span class="n">lt</span><span class="p">.</span><span class="mf">1.0e-8</span><span class="p">)</span>   <span class="n">defects</span><span class="p">%</span><span class="n">DL</span><span class="p">(</span><span class="n">inum</span><span class="p">)%</span><span class="n">pa</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">=</span><span class="nb">cmplx</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span><span class="nb">aimag</span><span class="p">(</span><span class="n">defects</span><span class="p">%</span><span class="n">DL</span><span class="p">(</span><span class="n">inum</span><span class="p">)%</span><span class="n">pa</span><span class="p">(</span><span class="n">i</span><span class="p">)),</span><span class="n">dbl</span><span class="p">)</span>
<a name="ln-1010"></a><span class="k">end do</span>
<a name="ln-1011"></a><span class="k">if</span> <span class="p">(</span><span class="n">dinfo</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1012"></a><span class="k">  write</span> <span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s1">&#39; sextic roots&#39;</span>
<a name="ln-1013"></a>  <span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span>
<a name="ln-1014"></a>    <span class="k">write</span> <span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="n">defects</span><span class="p">%</span><span class="n">DL</span><span class="p">(</span><span class="n">inum</span><span class="p">)%</span><span class="n">pa</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
<a name="ln-1015"></a>  <span class="k">end do</span>
<a name="ln-1016"></a><span class="k">  write</span> <span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s1">&#39;---&#39;</span>
<a name="ln-1017"></a><span class="k">end if</span>
<a name="ln-1018"></a>
<a name="ln-1019"></a><span class="c">!  compute the A_ka vectors (see description on page 328 of Head et al.)</span>
<a name="ln-1020"></a><span class="n">pasq</span> <span class="o">=</span> <span class="n">defects</span><span class="p">%</span><span class="n">DL</span><span class="p">(</span><span class="n">inum</span><span class="p">)%</span><span class="n">pa</span><span class="o">**</span><span class="mi">2</span>
<a name="ln-1021"></a><span class="k">if</span> <span class="p">(</span><span class="n">dinfo</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span> <span class="k">write</span> <span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s1">&#39;Aka vectors&#39;</span>
<a name="ln-1022"></a><span class="k">do </span><span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span>
<a name="ln-1023"></a>  <span class="n">mat</span> <span class="o">=</span> <span class="n">zero</span>
<a name="ln-1024"></a>  <span class="n">mat</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">ec</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="mf">2.D0</span><span class="o">*</span><span class="n">defects</span><span class="p">%</span><span class="n">DL</span><span class="p">(</span><span class="n">inum</span><span class="p">)%</span><span class="n">pa</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">ec</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span><span class="o">+</span><span class="n">ec</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span><span class="o">*</span><span class="n">pasq</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<a name="ln-1025"></a>  <span class="n">mat</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">ec</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span><span class="o">+</span><span class="mf">2.D0</span><span class="o">*</span><span class="n">defects</span><span class="p">%</span><span class="n">DL</span><span class="p">(</span><span class="n">inum</span><span class="p">)%</span><span class="n">pa</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">ec</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span><span class="o">+</span><span class="n">ec</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">pasq</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<a name="ln-1026"></a>  <span class="n">mat</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">ec</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span><span class="o">+</span><span class="mf">2.D0</span><span class="o">*</span><span class="n">defects</span><span class="p">%</span><span class="n">DL</span><span class="p">(</span><span class="n">inum</span><span class="p">)%</span><span class="n">pa</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">ec</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span><span class="o">+</span><span class="n">ec</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="o">*</span><span class="n">pasq</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<a name="ln-1027"></a>  <span class="n">mat</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">ec</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span><span class="o">+</span><span class="n">defects</span><span class="p">%</span><span class="n">DL</span><span class="p">(</span><span class="n">inum</span><span class="p">)%</span><span class="n">pa</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">ec</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span><span class="o">+</span><span class="n">ec</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span><span class="o">+</span><span class="n">ec</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="o">*</span><span class="n">pasq</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<a name="ln-1028"></a>  <span class="n">mat</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">ec</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span><span class="o">+</span><span class="n">defects</span><span class="p">%</span><span class="n">DL</span><span class="p">(</span><span class="n">inum</span><span class="p">)%</span><span class="n">pa</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">ec</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="o">+</span><span class="n">ec</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span><span class="o">+</span><span class="n">ec</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span><span class="o">*</span><span class="n">pasq</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<a name="ln-1029"></a>  <span class="n">mat</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">ec</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span><span class="o">+</span><span class="n">defects</span><span class="p">%</span><span class="n">DL</span><span class="p">(</span><span class="n">inum</span><span class="p">)%</span><span class="n">pa</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">ec</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="n">ec</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span><span class="o">+</span><span class="n">ec</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span><span class="o">*</span><span class="n">pasq</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<a name="ln-1030"></a>  <span class="k">if</span> <span class="p">(</span><span class="n">k</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1031"></a><span class="k">    </span><span class="n">aka</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">mat</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">mat</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">-</span><span class="n">mat</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">mat</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-1032"></a>    <span class="n">aka</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">mat</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">mat</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">-</span><span class="n">mat</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">mat</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-1033"></a>    <span class="n">aka</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">mat</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">mat</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">-</span><span class="n">mat</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">mat</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
<a name="ln-1034"></a>  <span class="k">end if</span>
<a name="ln-1035"></a><span class="k">  if</span> <span class="p">(</span><span class="n">k</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mi">2</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1036"></a><span class="k">    </span><span class="n">aka</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">mat</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">mat</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">-</span><span class="n">mat</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">mat</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-1037"></a>    <span class="n">aka</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">mat</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">mat</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">-</span><span class="n">mat</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">mat</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-1038"></a>    <span class="n">aka</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">mat</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">mat</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">-</span><span class="n">mat</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">mat</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-1039"></a>  <span class="k">end if</span>
<a name="ln-1040"></a><span class="k">  if</span> <span class="p">(</span><span class="n">k</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mi">3</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1041"></a><span class="k">    </span><span class="n">aka</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">mat</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">mat</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">-</span><span class="n">mat</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">mat</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
<a name="ln-1042"></a>    <span class="n">aka</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">mat</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">mat</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">-</span><span class="n">mat</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">mat</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-1043"></a>    <span class="n">aka</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">mat</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">mat</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">-</span><span class="n">mat</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">mat</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
<a name="ln-1044"></a>  <span class="k">end if  </span>
<a name="ln-1045"></a><span class="k">  if</span> <span class="p">(</span><span class="n">dinfo</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span> <span class="k">write</span> <span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="n">k</span><span class="p">,(</span><span class="n">aka</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">j</span><span class="p">),</span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-1046"></a><span class="k">end do</span>
<a name="ln-1047"></a><span class="n">aka</span> <span class="o">=</span> <span class="nb">transpose</span><span class="p">(</span><span class="n">aka</span><span class="p">)</span>
<a name="ln-1048"></a>
<a name="ln-1049"></a><span class="c">! next, create the L_ialpha matrix</span>
<a name="ln-1050"></a><span class="n">ind</span> <span class="o">=</span> <span class="p">(</span><span class="o">/</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span> <span class="o">/</span><span class="p">)</span>
<a name="ln-1051"></a><span class="n">jnd</span> <span class="o">=</span> <span class="p">(</span><span class="o">/</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">5</span> <span class="o">/</span><span class="p">)</span>
<a name="ln-1052"></a><span class="n">Lia</span> <span class="o">=</span> <span class="n">zero</span>
<a name="ln-1053"></a><span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span> 
<a name="ln-1054"></a> <span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span>
<a name="ln-1055"></a>  <span class="k">do </span><span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span>
<a name="ln-1056"></a>   <span class="n">Lia</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span> <span class="o">=</span> <span class="n">Lia</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="n">ec</span><span class="p">(</span><span class="n">ind</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="n">jnd</span><span class="p">(</span><span class="n">k</span><span class="p">))</span><span class="o">+</span><span class="n">defects</span><span class="p">%</span><span class="n">DL</span><span class="p">(</span><span class="n">inum</span><span class="p">)%</span><span class="n">pa</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">*</span><span class="n">ec</span><span class="p">(</span><span class="n">ind</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="n">ind</span><span class="p">(</span><span class="n">k</span><span class="p">)))</span><span class="o">*</span><span class="n">aka</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">j</span><span class="p">)</span>
<a name="ln-1057"></a>  <span class="k">end do</span>
<a name="ln-1058"></a><span class="k"> end do</span>
<a name="ln-1059"></a><span class="k">end do</span>
<a name="ln-1060"></a><span class="k">if</span> <span class="p">(</span><span class="n">dinfo</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span>  <span class="k">call </span><span class="n">PrintMatrixcd</span><span class="p">(</span><span class="s1">&#39;Lia &#39;</span><span class="p">,</span><span class="n">Lia</span><span class="p">)</span>
<a name="ln-1061"></a>
<a name="ln-1062"></a><span class="c">! and invert it</span>
<a name="ln-1063"></a><span class="k">call </span><span class="n">cInvert</span><span class="p">(</span><span class="n">Lia</span><span class="p">,</span><span class="n">Mai</span><span class="p">)</span>
<a name="ln-1064"></a><span class="k">if</span> <span class="p">(</span><span class="n">dinfo</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span>  <span class="k">call </span><span class="n">PrintMatrixcd</span><span class="p">(</span><span class="s1">&#39;Mai &#39;</span><span class="p">,</span><span class="n">Mai</span><span class="p">)</span>
<a name="ln-1065"></a>
<a name="ln-1066"></a><span class="c">! compute Bij ( real matrix )</span>
<a name="ln-1067"></a><span class="n">Bij</span> <span class="o">=</span> <span class="mf">0.D0</span>
<a name="ln-1068"></a><span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span>
<a name="ln-1069"></a> <span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span>
<a name="ln-1070"></a>  <span class="k">do </span><span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span>
<a name="ln-1071"></a>   <span class="n">Bij</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span> <span class="o">=</span> <span class="n">Bij</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span> <span class="o">-</span> <span class="nb">aimag</span><span class="p">(</span><span class="n">aka</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">*</span><span class="kt">real</span><span class="p">(</span><span class="n">Mai</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">j</span><span class="p">))</span> <span class="o">-</span> <span class="kt">real</span><span class="p">(</span><span class="n">aka</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">k</span><span class="p">))</span><span class="o">*</span><span class="nb">aimag</span><span class="p">(</span><span class="n">Mai</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">j</span><span class="p">))</span>
<a name="ln-1072"></a>  <span class="k">end do</span>
<a name="ln-1073"></a><span class="k"> end do</span>
<a name="ln-1074"></a><span class="k">end do</span>
<a name="ln-1075"></a><span class="k">if</span> <span class="p">(</span><span class="n">dinfo</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span>  <span class="k">call </span><span class="n">PrintMatrixd</span><span class="p">(</span><span class="s1">&#39;Bij &#39;</span><span class="p">,</span><span class="n">Bij</span><span class="p">)</span>
<a name="ln-1076"></a>
<a name="ln-1077"></a><span class="c">! and invert to get Hij</span>
<a name="ln-1078"></a><span class="k">call </span><span class="n">mInvert</span><span class="p">(</span><span class="n">Bij</span><span class="p">,</span><span class="n">Hij</span><span class="p">,.</span><span class="n">FALSE</span><span class="p">.)</span>
<a name="ln-1079"></a><span class="k">if</span> <span class="p">(</span><span class="n">dinfo</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span> <span class="k">call </span><span class="n">PrintMatrixd</span><span class="p">(</span><span class="s1">&#39;Hij &#39;</span><span class="p">,</span><span class="n">Hij</span><span class="p">)</span>
<a name="ln-1080"></a>
<a name="ln-1081"></a><span class="c">! compute matrix (this is what actually gets to be used for the </span>
<a name="ln-1082"></a><span class="c">! displacement field); needs to know the Burgers vector.</span>
<a name="ln-1083"></a><span class="n">defects</span><span class="p">%</span><span class="n">DL</span><span class="p">(</span><span class="n">inum</span><span class="p">)%</span><span class="n">dismat</span> <span class="o">=</span> <span class="n">zero</span>
<a name="ln-1084"></a><span class="k">do </span><span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span>
<a name="ln-1085"></a> <span class="k">do </span><span class="n">l</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span>
<a name="ln-1086"></a>   <span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span>
<a name="ln-1087"></a>    <span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span>
<a name="ln-1088"></a>     <span class="n">defects</span><span class="p">%</span><span class="n">DL</span><span class="p">(</span><span class="n">inum</span><span class="p">)%</span><span class="n">dismat</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">l</span><span class="p">)</span> <span class="o">=</span> <span class="n">defects</span><span class="p">%</span><span class="n">DL</span><span class="p">(</span><span class="n">inum</span><span class="p">)%</span><span class="n">dismat</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">l</span><span class="p">)</span> <span class="o">+</span> <span class="n">defects</span><span class="p">%</span><span class="n">DL</span><span class="p">(</span><span class="n">inum</span><span class="p">)%</span><span class="n">burgd</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">*</span><span class="n">Hij</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">)</span><span class="o">*</span><span class="n">Mai</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="n">j</span><span class="p">)</span><span class="o">*</span><span class="n">aka</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">l</span><span class="p">)</span>
<a name="ln-1089"></a>    <span class="k">end do</span>
<a name="ln-1090"></a><span class="k">   end do</span>
<a name="ln-1091"></a><span class="k"> end do</span>
<a name="ln-1092"></a><span class="k">end do</span>
<a name="ln-1093"></a>
<a name="ln-1094"></a><span class="c">! scale by 1/4pi</span>
<a name="ln-1095"></a><span class="n">defects</span><span class="p">%</span><span class="n">DL</span><span class="p">(</span><span class="n">inum</span><span class="p">)%</span><span class="n">dismat</span> <span class="o">=</span> <span class="n">defects</span><span class="p">%</span><span class="n">DL</span><span class="p">(</span><span class="n">inum</span><span class="p">)%</span><span class="n">dismat</span><span class="o">*</span><span class="mf">0.25D0</span><span class="o">/</span><span class="n">cPi</span>
<a name="ln-1096"></a><span class="k">if</span> <span class="p">(</span><span class="n">dinfo</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span>  <span class="k">call </span><span class="n">PrintMatrixcd</span><span class="p">(</span><span class="s1">&#39;dismat&#39;</span><span class="p">,</span><span class="n">defects</span><span class="p">%</span><span class="n">DL</span><span class="p">(</span><span class="n">inum</span><span class="p">)%</span><span class="n">dismat</span><span class="p">)</span>
<a name="ln-1097"></a>
<a name="ln-1098"></a><span class="c">! and return to calling routine</span>
<a name="ln-1099"></a><span class="k">end subroutine </span><span class="n">makedislocation</span>
<a name="ln-1100"></a>
<a name="ln-1101"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-1102"></a><span class="c">!</span>
<a name="ln-1103"></a><span class="c">! SUBROUTINE: makestackingfault</span>
<a name="ln-1104"></a><span class="c">!</span>
<a name="ln-1105"></a><span class="c">!&gt; @author Marc De Graef, Carnegie Mellon University</span>
<a name="ln-1106"></a><span class="c">!</span>
<a name="ln-1107"></a><span class="c">!&gt; @brief compute parameters for a stacking fault</span>
<a name="ln-1108"></a><span class="c">!</span>
<a name="ln-1109"></a><span class="c">!&gt; @details  This subroutine computes the geometrical parameters for a </span>
<a name="ln-1110"></a><span class="c">!&gt; stacking fault.  It computes, among others, the coordinates of the </span>
<a name="ln-1111"></a><span class="c">!&gt; centers of the partial dislocations, the intersections of each dislocation</span>
<a name="ln-1112"></a><span class="c">!&gt; line with the top and bottom foil surface, and an array that indicates, for</span>
<a name="ln-1113"></a><span class="c">!&gt; each image pixel, whether or not the corresponding integration column </span>
<a name="ln-1114"></a><span class="c">!&gt; contains this fault; if it does not, the  value in the array is set to </span>
<a name="ln-1115"></a><span class="c">!&gt; -10000; if it does, then the value is equal to the point where the fault</span>
<a name="ln-1116"></a><span class="c">!&gt; plane intersects with the column, measured from the top surface.</span>
<a name="ln-1117"></a><span class="c">!&gt; In short, anything that is needed in the CalcR routine and can be computed </span>
<a name="ln-1118"></a><span class="c">!&gt; ahead of time, is computed here.  The routine also calls the makedislocation </span>
<a name="ln-1119"></a><span class="c">!&gt; routine to create the partials.</span>
<a name="ln-1120"></a><span class="c">! </span>
<a name="ln-1121"></a><span class="c">!&gt; @param cell unit cell pointer</span>
<a name="ln-1122"></a><span class="c">!&gt; @param defects defect structure</span>
<a name="ln-1123"></a><span class="c">!&gt; @param inum</span>
<a name="ln-1124"></a><span class="c">!&gt; @param DF_L column edge length</span>
<a name="ln-1125"></a><span class="c">!&gt; @param nx</span>
<a name="ln-1126"></a><span class="c">!&gt; @param ny</span>
<a name="ln-1127"></a><span class="c">!&gt; @param DF_g</span>
<a name="ln-1128"></a><span class="c">!&gt; @param ndl</span>
<a name="ln-1129"></a><span class="c">!&gt; @param dinfo trigger for verbose output</span>
<a name="ln-1130"></a><span class="c">!</span>
<a name="ln-1131"></a><span class="c">!&gt; @date   11/05/13 MDG 1.0 new attempt to replace faulty original routine</span>
<a name="ln-1132"></a><span class="c">!&gt; @date   11/13/13 MDG 1.1 traced error to problem with transformations in defectmodule</span>
<a name="ln-1133"></a><span class="c">!&gt; @date   11/13/13 MDG 1.2 changed SF normal transformation for zpos array computation (to be tested)</span>
<a name="ln-1134"></a><span class="c">!&gt; @date   06/09/14 MDG 2.0 added defects and cell as arguments</span>
<a name="ln-1135"></a><span class="c">!&gt; @date   06/10/14 MDG 2.1 added foil as argument </span>
<a name="ln-1136"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-1137"></a><span class="k">recursive subroutine </span><span class="n">makestackingfault</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span><span class="n">defects</span><span class="p">,</span><span class="n">inum</span><span class="p">,</span><span class="n">DF_L</span><span class="p">,</span><span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">,</span><span class="n">DF_g</span><span class="p">,</span><span class="n">dinfo</span><span class="p">)</span>
<a name="ln-1138"></a><span class="c">!DEC$ ATTRIBUTES DLLEXPORT ::  makestackingfault</span>
<a name="ln-1139"></a>
<a name="ln-1140"></a><span class="k">use </span><span class="n">math</span>
<a name="ln-1141"></a><span class="k">use </span><span class="n">constants</span>
<a name="ln-1142"></a><span class="k">use </span><span class="n">files</span>
<a name="ln-1143"></a><span class="k">use </span><span class="n">rotations</span>
<a name="ln-1144"></a><span class="k">use </span><span class="n">crystal</span>
<a name="ln-1145"></a><span class="k">use </span><span class="n">symmetry</span>
<a name="ln-1146"></a><span class="k">use </span><span class="n">math</span>
<a name="ln-1147"></a>
<a name="ln-1148"></a><span class="k">IMPLICIT NONE</span>
<a name="ln-1149"></a>
<a name="ln-1150"></a><span class="k">type</span><span class="p">(</span><span class="n">defecttype</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">INOUT</span><span class="p">)</span>  <span class="kd">::</span> <span class="n">defects</span>
<a name="ln-1151"></a><span class="k">type</span><span class="p">(</span><span class="n">unitcell</span><span class="p">),</span><span class="k">pointer</span>          <span class="kd">::</span> <span class="n">cell</span>
<a name="ln-1152"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>       <span class="kd">::</span> <span class="n">DF_L</span>
<a name="ln-1153"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>       <span class="kd">::</span> <span class="n">DF_g</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-1154"></a><span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">irg</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">inum</span><span class="p">,</span> <span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">dinfo</span>
<a name="ln-1155"></a>
<a name="ln-1156"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">)</span>                  <span class="kd">::</span> <span class="n">fpn</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span><span class="n">am</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span><span class="n">midpoint</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">ex</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">ey</span><span class="p">(</span><span class="mi">3</span><span class="p">),&amp;</span>
<a name="ln-1157"></a>                                 <span class="n">lptopi</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span><span class="n">lpboti</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span><span class="n">tptopi</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span><span class="n">tpboti</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span><span class="n">det</span><span class="p">,</span><span class="n">A</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="n">xx</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="n">yy</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="n">tmp</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="p">&amp;</span>
<a name="ln-1158"></a>                                 <span class="n">planenormal</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">rzero</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">unita</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-1159"></a>
<a name="ln-1160"></a><span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">irg</span><span class="p">)</span>               <span class="kd">::</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">info</span><span class="p">,</span><span class="n">ipiv</span><span class="p">,</span><span class="n">minx</span><span class="p">,</span><span class="n">maxx</span><span class="p">,</span><span class="n">miny</span><span class="p">,</span><span class="n">maxy</span><span class="p">,</span> <span class="n">ndl</span>
<a name="ln-1161"></a>
<a name="ln-1162"></a><span class="n">ndl</span> <span class="o">=</span> <span class="n">defects</span><span class="p">%</span><span class="n">numdisl</span>
<a name="ln-1163"></a>
<a name="ln-1164"></a><span class="c">! we begin by computing the geometry in the foil reference frame, which is the cartesian frame </span>
<a name="ln-1165"></a><span class="c">! for zero sample tilt;  sample tilts are applied once we known the partial dislocation geometry</span>
<a name="ln-1166"></a><span class="k">call </span><span class="n">TransSpace</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span><span class="n">defects</span><span class="p">%</span><span class="n">SF</span><span class="p">(</span><span class="n">inum</span><span class="p">)%</span><span class="n">plane</span><span class="p">,</span><span class="n">tmp</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">,</span><span class="s1">&#39;c&#39;</span><span class="p">)</span>
<a name="ln-1167"></a><span class="k">call </span><span class="n">NormVec</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span><span class="n">tmp</span><span class="p">,</span><span class="s1">&#39;c&#39;</span><span class="p">)</span>
<a name="ln-1168"></a><span class="n">planenormal</span> <span class="o">=</span>  <span class="n">tmp</span>
<a name="ln-1169"></a>
<a name="ln-1170"></a><span class="k">call </span><span class="n">CalcCross</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span> <span class="n">planenormal</span><span class="p">,</span> <span class="p">(</span><span class="o">/</span> <span class="mf">0.0</span><span class="p">,</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">1.0</span> <span class="o">/</span><span class="p">),</span>  <span class="n">unita</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<a name="ln-1171"></a><span class="k">call </span><span class="n">NormVec</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span><span class="n">unita</span><span class="p">,</span><span class="s1">&#39;c&#39;</span><span class="p">)</span>
<a name="ln-1172"></a><span class="n">fpn</span> <span class="o">=</span> <span class="n">planenormal</span>
<a name="ln-1173"></a><span class="k">if</span> <span class="p">(</span><span class="n">dinfo</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span> <span class="k">write</span> <span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s1">&#39; unita should have zero third component &#39;</span><span class="p">,</span><span class="n">unita</span><span class="p">,</span> <span class="n">fpn</span>
<a name="ln-1174"></a>
<a name="ln-1175"></a><span class="c">! the fault plane goes through the point rzero in the foil center plane</span>
<a name="ln-1176"></a><span class="n">rzero</span> <span class="o">=</span> <span class="p">(</span><span class="o">/</span> <span class="n">defects</span><span class="p">%</span><span class="n">SF</span><span class="p">(</span><span class="n">inum</span><span class="p">)%</span><span class="n">id</span><span class="p">,</span> <span class="n">defects</span><span class="p">%</span><span class="n">SF</span><span class="p">(</span><span class="n">inum</span><span class="p">)%</span><span class="n">jd</span><span class="p">,</span> <span class="mf">0.0</span> <span class="o">/</span><span class="p">)</span>
<a name="ln-1177"></a>
<a name="ln-1178"></a><span class="c">! this leads to the location of the partial dislocation centers</span>
<a name="ln-1179"></a><span class="n">defects</span><span class="p">%</span><span class="n">SF</span><span class="p">(</span><span class="n">inum</span><span class="p">)%</span><span class="n">lpr</span> <span class="o">=</span> <span class="n">rzero</span> <span class="o">+</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">defects</span><span class="p">%</span><span class="n">SF</span><span class="p">(</span><span class="n">inum</span><span class="p">)%</span><span class="n">sep</span><span class="o">*</span><span class="n">unita</span> <span class="o">/</span> <span class="n">DF_L</span>
<a name="ln-1180"></a><span class="n">defects</span><span class="p">%</span><span class="n">SF</span><span class="p">(</span><span class="n">inum</span><span class="p">)%</span><span class="n">tpr</span> <span class="o">=</span> <span class="n">rzero</span> <span class="o">-</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">defects</span><span class="p">%</span><span class="n">SF</span><span class="p">(</span><span class="n">inum</span><span class="p">)%</span><span class="n">sep</span><span class="o">*</span><span class="n">unita</span> <span class="o">/</span> <span class="n">DF_L</span>
<a name="ln-1181"></a>
<a name="ln-1182"></a><span class="k">if</span> <span class="p">(</span><span class="n">dinfo</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span> <span class="k">write</span> <span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s1">&#39;lpr_i = &#39;</span><span class="p">,</span><span class="n">defects</span><span class="p">%</span><span class="n">SF</span><span class="p">(</span><span class="n">inum</span><span class="p">)%</span><span class="n">lpr</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-1183"></a><span class="k">if</span> <span class="p">(</span><span class="n">dinfo</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span> <span class="k">write</span> <span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s1">&#39;tpr_i = &#39;</span><span class="p">,</span><span class="n">defects</span><span class="p">%</span><span class="n">SF</span><span class="p">(</span><span class="n">inum</span><span class="p">)%</span><span class="n">tpr</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-1184"></a>
<a name="ln-1185"></a><span class="c">! call makedislocation for each of the partials</span>
<a name="ln-1186"></a>  <span class="n">defects</span><span class="p">%</span><span class="n">DL</span><span class="p">(</span><span class="n">ndl</span><span class="o">+</span><span class="mi">1</span><span class="p">)%</span><span class="n">id</span> <span class="o">=</span> <span class="n">defects</span><span class="p">%</span><span class="n">SF</span><span class="p">(</span><span class="n">inum</span><span class="p">)%</span><span class="n">lpr</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> 
<a name="ln-1187"></a>  <span class="n">defects</span><span class="p">%</span><span class="n">DL</span><span class="p">(</span><span class="n">ndl</span><span class="o">+</span><span class="mi">1</span><span class="p">)%</span><span class="n">jd</span> <span class="o">=</span> <span class="n">defects</span><span class="p">%</span><span class="n">SF</span><span class="p">(</span><span class="n">inum</span><span class="p">)%</span><span class="n">lpr</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> 
<a name="ln-1188"></a>  <span class="n">defects</span><span class="p">%</span><span class="n">DL</span><span class="p">(</span><span class="n">ndl</span><span class="o">+</span><span class="mi">1</span><span class="p">)%</span><span class="n">u</span> <span class="o">=</span>  <span class="n">defects</span><span class="p">%</span><span class="n">SF</span><span class="p">(</span><span class="n">inum</span><span class="p">)%</span><span class="n">lpu</span>
<a name="ln-1189"></a>  <span class="n">defects</span><span class="p">%</span><span class="n">DL</span><span class="p">(</span><span class="n">ndl</span><span class="o">+</span><span class="mi">1</span><span class="p">)%</span><span class="n">burg</span> <span class="o">=</span> <span class="n">defects</span><span class="p">%</span><span class="n">SF</span><span class="p">(</span><span class="n">inum</span><span class="p">)%</span><span class="n">lpb</span>
<a name="ln-1190"></a>  <span class="n">defects</span><span class="p">%</span><span class="n">DL</span><span class="p">(</span><span class="n">ndl</span><span class="o">+</span><span class="mi">1</span><span class="p">)%</span><span class="n">g</span> <span class="o">=</span> <span class="n">DF_g</span>
<a name="ln-1191"></a>  <span class="k">call </span><span class="n">makedislocation</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span><span class="n">defects</span><span class="p">,</span><span class="n">ndl</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">dinfo</span><span class="p">,</span><span class="n">DF_L</span><span class="p">)</span>
<a name="ln-1192"></a>  <span class="k">if</span> <span class="p">(</span><span class="n">dinfo</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span> <span class="k">write</span> <span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s1">&#39;Leading Partial Position &#39;</span><span class="p">,</span><span class="n">defects</span><span class="p">%</span><span class="n">DL</span><span class="p">(</span><span class="n">ndl</span><span class="o">+</span><span class="mi">1</span><span class="p">)%</span><span class="n">id</span><span class="p">,</span><span class="n">defects</span><span class="p">%</span><span class="n">DL</span><span class="p">(</span><span class="n">ndl</span><span class="o">+</span><span class="mi">1</span><span class="p">)%</span><span class="n">jd</span>
<a name="ln-1193"></a>    
<a name="ln-1194"></a>  <span class="n">defects</span><span class="p">%</span><span class="n">DL</span><span class="p">(</span><span class="n">ndl</span><span class="o">+</span><span class="mi">2</span><span class="p">)%</span><span class="n">id</span> <span class="o">=</span> <span class="n">defects</span><span class="p">%</span><span class="n">SF</span><span class="p">(</span><span class="n">inum</span><span class="p">)%</span><span class="n">tpr</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> 
<a name="ln-1195"></a>  <span class="n">defects</span><span class="p">%</span><span class="n">DL</span><span class="p">(</span><span class="n">ndl</span><span class="o">+</span><span class="mi">2</span><span class="p">)%</span><span class="n">jd</span> <span class="o">=</span> <span class="n">defects</span><span class="p">%</span><span class="n">SF</span><span class="p">(</span><span class="n">inum</span><span class="p">)%</span><span class="n">tpr</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> 
<a name="ln-1196"></a>  <span class="n">defects</span><span class="p">%</span><span class="n">DL</span><span class="p">(</span><span class="n">ndl</span><span class="o">+</span><span class="mi">2</span><span class="p">)%</span><span class="n">u</span> <span class="o">=</span> <span class="n">defects</span><span class="p">%</span><span class="n">SF</span><span class="p">(</span><span class="n">inum</span><span class="p">)%</span><span class="n">tpu</span>
<a name="ln-1197"></a>  <span class="n">defects</span><span class="p">%</span><span class="n">DL</span><span class="p">(</span><span class="n">ndl</span><span class="o">+</span><span class="mi">2</span><span class="p">)%</span><span class="n">burg</span> <span class="o">=</span> <span class="n">defects</span><span class="p">%</span><span class="n">SF</span><span class="p">(</span><span class="n">inum</span><span class="p">)%</span><span class="n">tpb</span>
<a name="ln-1198"></a>  <span class="n">defects</span><span class="p">%</span><span class="n">DL</span><span class="p">(</span><span class="n">ndl</span><span class="o">+</span><span class="mi">2</span><span class="p">)%</span><span class="n">g</span> <span class="o">=</span> <span class="n">DF_g</span>
<a name="ln-1199"></a>  <span class="k">call </span><span class="n">makedislocation</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span><span class="n">defects</span><span class="p">,</span><span class="n">ndl</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="n">dinfo</span><span class="p">,</span><span class="n">DF_L</span><span class="p">)</span>
<a name="ln-1200"></a>  <span class="k">if</span> <span class="p">(</span><span class="n">dinfo</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span>  <span class="k">write</span> <span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s1">&#39;Trailing Partial Position &#39;</span><span class="p">,</span><span class="n">defects</span><span class="p">%</span><span class="n">DL</span><span class="p">(</span><span class="n">ndl</span><span class="o">+</span><span class="mi">2</span><span class="p">)%</span><span class="n">id</span><span class="p">,</span><span class="n">defects</span><span class="p">%</span><span class="n">DL</span><span class="p">(</span><span class="n">ndl</span><span class="o">+</span><span class="mi">2</span><span class="p">)%</span><span class="n">jd</span>
<a name="ln-1201"></a>
<a name="ln-1202"></a><span class="c">! copy the top and bottom dislocation intersections (computed in make_dislocation) </span>
<a name="ln-1203"></a><span class="c">! into the corresponding variables of the SF record</span>
<a name="ln-1204"></a>
<a name="ln-1205"></a><span class="n">defects</span><span class="p">%</span><span class="n">SF</span><span class="p">(</span><span class="n">inum</span><span class="p">)%</span><span class="n">lpbot</span> <span class="o">=</span> <span class="n">defects</span><span class="p">%</span><span class="n">DL</span><span class="p">(</span><span class="n">ndl</span><span class="o">+</span><span class="mi">1</span><span class="p">)%</span><span class="n">bottom</span>
<a name="ln-1206"></a><span class="n">defects</span><span class="p">%</span><span class="n">SF</span><span class="p">(</span><span class="n">inum</span><span class="p">)%</span><span class="n">lptop</span> <span class="o">=</span> <span class="n">defects</span><span class="p">%</span><span class="n">DL</span><span class="p">(</span><span class="n">ndl</span><span class="o">+</span><span class="mi">1</span><span class="p">)%</span><span class="n">top</span>
<a name="ln-1207"></a><span class="n">defects</span><span class="p">%</span><span class="n">SF</span><span class="p">(</span><span class="n">inum</span><span class="p">)%</span><span class="n">tpbot</span> <span class="o">=</span> <span class="n">defects</span><span class="p">%</span><span class="n">DL</span><span class="p">(</span><span class="n">ndl</span><span class="o">+</span><span class="mi">2</span><span class="p">)%</span><span class="n">bottom</span>
<a name="ln-1208"></a><span class="n">defects</span><span class="p">%</span><span class="n">SF</span><span class="p">(</span><span class="n">inum</span><span class="p">)%</span><span class="n">tptop</span> <span class="o">=</span> <span class="n">defects</span><span class="p">%</span><span class="n">DL</span><span class="p">(</span><span class="n">ndl</span><span class="o">+</span><span class="mi">2</span><span class="p">)%</span><span class="n">top</span>
<a name="ln-1209"></a>
<a name="ln-1210"></a><span class="c">! obviously, these four points need to lie in a single plane; at this point, we check that this is indeed the case</span>
<a name="ln-1211"></a><span class="c">! by computing the volume of the tetrahedron formed by these four points; if the volume is zero, then the </span>
<a name="ln-1212"></a><span class="c">! points are co-planar.  (Use LAPACK&#39;s LU-decomposition and compute the product of the diagonal elements of U)</span>
<a name="ln-1213"></a><span class="n">am</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="o">/</span> <span class="n">defects</span><span class="p">%</span><span class="n">SF</span><span class="p">(</span><span class="n">inum</span><span class="p">)%</span><span class="n">lptop</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">),</span><span class="mf">1.0</span> <span class="o">/</span><span class="p">)</span>
<a name="ln-1214"></a><span class="n">am</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="o">/</span> <span class="n">defects</span><span class="p">%</span><span class="n">SF</span><span class="p">(</span><span class="n">inum</span><span class="p">)%</span><span class="n">lpbot</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">),</span><span class="mf">1.0</span> <span class="o">/</span><span class="p">)</span> 
<a name="ln-1215"></a><span class="n">am</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="o">/</span> <span class="n">defects</span><span class="p">%</span><span class="n">SF</span><span class="p">(</span><span class="n">inum</span><span class="p">)%</span><span class="n">tptop</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">),</span><span class="mf">1.0</span> <span class="o">/</span><span class="p">)</span> 
<a name="ln-1216"></a><span class="n">am</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="o">/</span> <span class="n">defects</span><span class="p">%</span><span class="n">SF</span><span class="p">(</span><span class="n">inum</span><span class="p">)%</span><span class="n">tpbot</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">),</span><span class="mf">1.0</span> <span class="o">/</span><span class="p">)</span> 
<a name="ln-1217"></a><span class="k">call </span><span class="n">sgetrf</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="n">am</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="n">ipiv</span><span class="p">,</span><span class="n">info</span><span class="p">)</span>
<a name="ln-1218"></a><span class="n">det</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">am</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">am</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">am</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">am</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
<a name="ln-1219"></a><span class="k">if</span> <span class="p">(</span><span class="n">dinfo</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span> <span class="k">write</span> <span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s1">&#39;determinant (should be zero) = &#39;</span><span class="p">,</span><span class="n">det</span>
<a name="ln-1220"></a>
<a name="ln-1221"></a><span class="c">! ok, next we need to figure out which image pixels lie on the projection of the stacking fault plane.</span>
<a name="ln-1222"></a><span class="c">! We need to transform the corner points into the image reference frame !!!</span>
<a name="ln-1223"></a><span class="n">lptopi</span> <span class="o">=</span> <span class="n">quat_Lp</span><span class="p">(</span> <span class="n">defects</span><span class="p">%</span><span class="n">foil</span><span class="p">%</span><span class="n">a_fi</span><span class="p">,</span> <span class="nb">dble</span><span class="p">(</span><span class="n">defects</span><span class="p">%</span><span class="n">SF</span><span class="p">(</span><span class="n">inum</span><span class="p">)%</span><span class="n">lptop</span><span class="p">))</span>
<a name="ln-1224"></a><span class="n">lpboti</span> <span class="o">=</span> <span class="n">quat_Lp</span><span class="p">(</span> <span class="n">defects</span><span class="p">%</span><span class="n">foil</span><span class="p">%</span><span class="n">a_fi</span><span class="p">,</span> <span class="nb">dble</span><span class="p">(</span><span class="n">defects</span><span class="p">%</span><span class="n">SF</span><span class="p">(</span><span class="n">inum</span><span class="p">)%</span><span class="n">lpbot</span><span class="p">))</span>
<a name="ln-1225"></a><span class="n">tptopi</span> <span class="o">=</span> <span class="n">quat_Lp</span><span class="p">(</span> <span class="n">defects</span><span class="p">%</span><span class="n">foil</span><span class="p">%</span><span class="n">a_fi</span><span class="p">,</span> <span class="nb">dble</span><span class="p">(</span><span class="n">defects</span><span class="p">%</span><span class="n">SF</span><span class="p">(</span><span class="n">inum</span><span class="p">)%</span><span class="n">tptop</span><span class="p">))</span>
<a name="ln-1226"></a><span class="n">tpboti</span> <span class="o">=</span> <span class="n">quat_Lp</span><span class="p">(</span> <span class="n">defects</span><span class="p">%</span><span class="n">foil</span><span class="p">%</span><span class="n">a_fi</span><span class="p">,</span> <span class="nb">dble</span><span class="p">(</span><span class="n">defects</span><span class="p">%</span><span class="n">SF</span><span class="p">(</span><span class="n">inum</span><span class="p">)%</span><span class="n">tpbot</span><span class="p">))</span>
<a name="ln-1227"></a><span class="k">if</span> <span class="p">(</span><span class="n">dinfo</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1228"></a><span class="k">  write</span> <span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s1">&#39;SF parameters :&#39;</span>
<a name="ln-1229"></a>  <span class="k">write</span> <span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="n">lptopi</span><span class="p">,</span><span class="s1">&#39; &lt;&gt; &#39;</span><span class="p">,</span><span class="n">lpboti</span>
<a name="ln-1230"></a>  <span class="k">write</span> <span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="n">tptopi</span><span class="p">,</span><span class="s1">&#39; &lt;&gt; &#39;</span><span class="p">,</span><span class="n">tpboti</span>
<a name="ln-1231"></a><span class="k">end if</span>
<a name="ln-1232"></a>
<a name="ln-1233"></a><span class="c">! define the array that will contain the zpos values</span>
<a name="ln-1234"></a><span class="k">allocate</span><span class="p">(</span><span class="n">defects</span><span class="p">%</span><span class="n">SF</span><span class="p">(</span><span class="n">inum</span><span class="p">)%</span><span class="n">zpos</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">))</span>
<a name="ln-1235"></a><span class="n">defects</span><span class="p">%</span><span class="n">SF</span><span class="p">(</span><span class="n">inum</span><span class="p">)%</span><span class="n">zpos</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1000</span><span class="mf">0.0</span>    <span class="c">! set all points to be outside the projected SF</span>
<a name="ln-1236"></a>
<a name="ln-1237"></a><span class="c">! first determine the smaller box</span>
<a name="ln-1238"></a><span class="n">minx</span> <span class="o">=</span> <span class="nb">nint</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span> <span class="n">lptopi</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="n">lpboti</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="n">tptopi</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="n">tpboti</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">))</span> <span class="o">-</span><span class="mi">2</span>
<a name="ln-1239"></a><span class="n">maxx</span> <span class="o">=</span> <span class="nb">nint</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span> <span class="n">lptopi</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="n">lpboti</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="n">tptopi</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="n">tpboti</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">))</span> <span class="o">+</span><span class="mi">2</span>
<a name="ln-1240"></a><span class="n">miny</span> <span class="o">=</span> <span class="nb">nint</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span> <span class="n">lptopi</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span><span class="n">lpboti</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span><span class="n">tptopi</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span><span class="n">tpboti</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="p">))</span> <span class="o">-</span><span class="mi">2</span>
<a name="ln-1241"></a><span class="n">maxy</span> <span class="o">=</span> <span class="nb">nint</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span> <span class="n">lptopi</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span><span class="n">lpboti</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span><span class="n">tptopi</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span><span class="n">tpboti</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="p">))</span> <span class="o">+</span><span class="mi">2</span>
<a name="ln-1242"></a>
<a name="ln-1243"></a><span class="c">! the fault edges may fall outside of the viewing frame (origin at the center !!!)</span>
<a name="ln-1244"></a><span class="k">if</span> <span class="p">(</span><span class="n">minx</span><span class="p">.</span><span class="n">lt</span><span class="p">.(</span><span class="o">-</span><span class="n">nx</span><span class="o">/</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span> <span class="n">minx</span><span class="o">=-</span><span class="n">nx</span><span class="o">/</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span>
<a name="ln-1245"></a><span class="k">if</span> <span class="p">(</span><span class="n">maxx</span><span class="p">.</span><span class="n">gt</span><span class="p">.</span><span class="n">nx</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="n">maxx</span><span class="o">=</span><span class="n">nx</span><span class="o">/</span><span class="mi">2</span>
<a name="ln-1246"></a><span class="k">if</span> <span class="p">(</span><span class="n">miny</span><span class="p">.</span><span class="n">lt</span><span class="p">.(</span><span class="o">-</span><span class="n">ny</span><span class="o">/</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span> <span class="n">miny</span><span class="o">=-</span><span class="n">ny</span><span class="o">/</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span>
<a name="ln-1247"></a><span class="k">if</span> <span class="p">(</span><span class="n">maxy</span><span class="p">.</span><span class="n">gt</span><span class="p">.</span><span class="n">ny</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="n">maxy</span><span class="o">=</span><span class="n">ny</span><span class="o">/</span><span class="mi">2</span>
<a name="ln-1248"></a>
<a name="ln-1249"></a><span class="k">if</span> <span class="p">(</span><span class="n">dinfo</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span> <span class="k">write</span> <span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s1">&#39;Integer fault box = &#39;</span><span class="p">,</span><span class="n">minx</span><span class="p">,</span><span class="n">maxx</span><span class="p">,</span><span class="n">miny</span><span class="p">,</span><span class="n">maxy</span>
<a name="ln-1250"></a>
<a name="ln-1251"></a><span class="c">! get the equation of the stacking fault plane in the image reference frame</span>
<a name="ln-1252"></a><span class="c">! first the unit plane normal in image space</span>
<a name="ln-1253"></a><span class="c">! we&#39;ll take two vectors: ex = from ltop to ttop; ey = from ltop to lbot</span>
<a name="ln-1254"></a><span class="n">ex</span> <span class="o">=</span> <span class="n">tptopi</span> <span class="o">-</span> <span class="n">lptopi</span>
<a name="ln-1255"></a><span class="n">ey</span> <span class="o">=</span> <span class="n">lpboti</span> <span class="o">-</span> <span class="n">lptopi</span>
<a name="ln-1256"></a><span class="k">call </span><span class="n">NormVec</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span><span class="n">ex</span><span class="p">,</span><span class="s1">&#39;c&#39;</span><span class="p">)</span>
<a name="ln-1257"></a><span class="k">call </span><span class="n">NormVec</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span><span class="n">ey</span><span class="p">,</span><span class="s1">&#39;c&#39;</span><span class="p">)</span>
<a name="ln-1258"></a><span class="k">call </span><span class="n">CalcCross</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span><span class="n">ex</span><span class="p">,</span><span class="n">ey</span><span class="p">,</span><span class="n">fpn</span><span class="p">,</span><span class="s1">&#39;c&#39;</span><span class="p">,</span><span class="s1">&#39;c&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
<a name="ln-1259"></a>
<a name="ln-1260"></a><span class="n">A</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">fpn</span> <span class="c">! quat_LPstar( conjg(foil%a_fi), dble(fpn(1:3)) )</span>
<a name="ln-1261"></a><span class="n">midpoint</span> <span class="o">=</span> <span class="mf">0.25</span><span class="o">*</span><span class="p">(</span><span class="n">lptopi</span><span class="o">+</span><span class="n">lpboti</span><span class="o">+</span><span class="n">tptopi</span><span class="o">+</span><span class="n">tpboti</span><span class="p">)</span> <span class="c">! quat_LPstar( conjg(foil%a_fi), dble(0.25*(lptopi+lpboti+tptopi+tpboti) ))</span>
<a name="ln-1262"></a><span class="n">A</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">A</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">midpoint</span><span class="p">)</span>
<a name="ln-1263"></a><span class="k">if</span> <span class="p">(</span><span class="n">dinfo</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span> <span class="k">write</span> <span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s1">&#39;fault plane parameters : &#39;</span><span class="p">,</span><span class="n">A</span><span class="p">,</span> <span class="n">midpoint</span>
<a name="ln-1264"></a>
<a name="ln-1265"></a><span class="c">! rank the corner points so that the polygon is convex</span>
<a name="ln-1266"></a><span class="c">! call rank_points(tpboti(1:2),lpboti(1:2),lptopi(1:2),tptopi(1:2),xx,yy)</span>
<a name="ln-1267"></a><span class="n">xx</span> <span class="o">=</span> <span class="p">(</span><span class="o">/</span> <span class="n">lptopi</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">tptopi</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">tpboti</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="n">lpboti</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span><span class="p">)</span>
<a name="ln-1268"></a><span class="n">yy</span> <span class="o">=</span> <span class="p">(</span><span class="o">/</span> <span class="n">lptopi</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">tptopi</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">tpboti</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span><span class="n">lpboti</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span><span class="p">)</span>
<a name="ln-1269"></a>
<a name="ln-1270"></a><span class="c">! for all of the points inside this box:</span>
<a name="ln-1271"></a><span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="n">minx</span><span class="p">,</span><span class="n">maxx</span>
<a name="ln-1272"></a>  <span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="n">miny</span><span class="p">,</span><span class="n">maxy</span>
<a name="ln-1273"></a>    <span class="k">if</span> <span class="p">(</span><span class="n">point_inside_polygon</span><span class="p">(</span> <span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="n">j</span><span class="p">),</span> <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span> <span class="p">).</span><span class="n">gt</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span> <span class="k">then</span> 
<a name="ln-1274"></a><span class="c">! the point lies inside the projected region, </span>
<a name="ln-1275"></a><span class="c">! so we need the depth of the SF plane at this position, taking into account the </span>
<a name="ln-1276"></a><span class="c">! proper coordinate transformation (depth must be expressed in image reference frame)</span>
<a name="ln-1277"></a>        <span class="n">defects</span><span class="p">%</span><span class="n">SF</span><span class="p">(</span><span class="n">inum</span><span class="p">)%</span><span class="n">zpos</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="n">nx</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="n">ny</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span>  <span class="n">DF_L</span> <span class="o">*</span> <span class="p">(</span> <span class="n">A</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">-</span> <span class="n">A</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">-</span> <span class="n">A</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="nb">float</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="p">)</span><span class="o">/</span><span class="n">A</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-1278"></a>    <span class="k">end if</span>
<a name="ln-1279"></a><span class="k">  end do</span>
<a name="ln-1280"></a><span class="k">end do</span>
<a name="ln-1281"></a><span class="k">if</span> <span class="p">(</span><span class="n">dinfo</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span> <span class="k">write</span> <span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s1">&#39;fault plane pixels determined&#39;</span>
<a name="ln-1282"></a>
<a name="ln-1283"></a><span class="c">! let&#39;s also make sure that the SF displacement vector is translated to the </span>
<a name="ln-1284"></a><span class="c">! cartesian reference frame, so that it can be used directly by the CalcR routine</span>
<a name="ln-1285"></a><span class="n">defects</span><span class="p">%</span><span class="n">SF</span><span class="p">(</span><span class="n">inum</span><span class="p">)%</span><span class="n">lpbc</span> <span class="o">=</span> <span class="nb">matmul</span><span class="p">(</span><span class="n">cell</span><span class="p">%</span><span class="n">dsm</span><span class="p">,</span><span class="n">defects</span><span class="p">%</span><span class="n">SF</span><span class="p">(</span><span class="n">inum</span><span class="p">)%</span><span class="n">Rdisp</span><span class="p">)</span>
<a name="ln-1286"></a>
<a name="ln-1287"></a><span class="c">! that should do it for the stacking fault...  The rest </span>
<a name="ln-1288"></a><span class="c">! takes place in the CalcR routine.</span>
<a name="ln-1289"></a><span class="k">end subroutine </span><span class="n">makestackingfault</span>
<a name="ln-1290"></a>
<a name="ln-1291"></a>
<a name="ln-1292"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-1293"></a><span class="c">!</span>
<a name="ln-1294"></a><span class="c">! SUBROUTINE: makestackingfaultECCI</span>
<a name="ln-1295"></a><span class="c">!</span>
<a name="ln-1296"></a><span class="c">!&gt; @author Marc De Graef, Carnegie Mellon University</span>
<a name="ln-1297"></a><span class="c">!</span>
<a name="ln-1298"></a><span class="c">!&gt; @brief compute parameters for a stacking fault in ECCI mode</span>
<a name="ln-1299"></a><span class="c">!</span>
<a name="ln-1300"></a><span class="c">!&gt; @details  This subroutine computes the geometrical parameters for a </span>
<a name="ln-1301"></a><span class="c">!&gt; stacking fault.  It computes, among others, the coordinates of the surface</span>
<a name="ln-1302"></a><span class="c">!&gt; intersections of the partial dislocations, and an array that indicates, for</span>
<a name="ln-1303"></a><span class="c">!&gt; each image pixel, whether or not the corresponding integration column </span>
<a name="ln-1304"></a><span class="c">!&gt; contains this fault; if it does not, the  value in the array is set to </span>
<a name="ln-1305"></a><span class="c">!&gt; -10000; if it does, then the value is equal to the point where the fault</span>
<a name="ln-1306"></a><span class="c">!&gt; plane intersects with the column, measured from the top surface.</span>
<a name="ln-1307"></a><span class="c">!&gt; In short, anything that is needed in the CalcR routine and can be computed </span>
<a name="ln-1308"></a><span class="c">!&gt; ahead of time, is computed here.  The routine also calls the makedislocation </span>
<a name="ln-1309"></a><span class="c">!&gt; routine to create the partials.</span>
<a name="ln-1310"></a><span class="c">! </span>
<a name="ln-1311"></a><span class="c">!&gt; @param cell unit cell pointer</span>
<a name="ln-1312"></a><span class="c">!&gt; @param defects defect structure</span>
<a name="ln-1313"></a><span class="c">!&gt; @param inum</span>
<a name="ln-1314"></a><span class="c">!&gt; @param DF_L column edge length</span>
<a name="ln-1315"></a><span class="c">!&gt; @param nx</span>
<a name="ln-1316"></a><span class="c">!&gt; @param ny</span>
<a name="ln-1317"></a><span class="c">!&gt; @param DF_g</span>
<a name="ln-1318"></a><span class="c">!&gt; @param ndl</span>
<a name="ln-1319"></a><span class="c">!&gt; @param dinfo trigger for verbose output</span>
<a name="ln-1320"></a><span class="c">!</span>
<a name="ln-1321"></a><span class="c">!&gt; @date   11/05/13 MDG 1.0 new attempt to replace faulty original routine</span>
<a name="ln-1322"></a><span class="c">!&gt; @date   11/13/13 MDG 1.1 traced error to problem with transformations in defectmodule</span>
<a name="ln-1323"></a><span class="c">!&gt; @date   11/13/13 MDG 1.2 changed SF normal transformation for zpos array computation (to be tested)</span>
<a name="ln-1324"></a><span class="c">!&gt; @date   12/17/13 MDG 1.3 branch from original routine to deal with different ECCI geometry</span>
<a name="ln-1325"></a><span class="c">!&gt; @date   12/18/13 MDG 1.4 debug of stacking fault location array</span>
<a name="ln-1326"></a><span class="c">!&gt; @date   06/09/14 MDG 2.0 added cell, SF, YD arguments</span>
<a name="ln-1327"></a><span class="c">!&gt; @date   06/10/14 MDG 2.1 added foil argument</span>
<a name="ln-1328"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-1329"></a><span class="k">recursive subroutine </span><span class="n">makestackingfaultECCI</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span><span class="n">defects</span><span class="p">,</span><span class="n">inum</span><span class="p">,</span><span class="n">DF_L</span><span class="p">,</span><span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">,</span><span class="n">DF_g</span><span class="p">,</span><span class="n">dinfo</span><span class="p">)</span>
<a name="ln-1330"></a><span class="c">!DEC$ ATTRIBUTES DLLEXPORT :: makestackingfaultECCI</span>
<a name="ln-1331"></a>
<a name="ln-1332"></a><span class="k">use </span><span class="n">math</span>
<a name="ln-1333"></a><span class="k">use </span><span class="n">constants</span>
<a name="ln-1334"></a><span class="k">use </span><span class="n">files</span>
<a name="ln-1335"></a><span class="k">use </span><span class="n">rotations</span>
<a name="ln-1336"></a><span class="k">use </span><span class="n">crystal</span>
<a name="ln-1337"></a><span class="k">use </span><span class="n">symmetry</span>
<a name="ln-1338"></a><span class="k">use </span><span class="n">math</span>
<a name="ln-1339"></a>
<a name="ln-1340"></a><span class="k">IMPLICIT NONE</span>
<a name="ln-1341"></a>
<a name="ln-1342"></a><span class="k">type</span><span class="p">(</span><span class="n">defecttype</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">INOUT</span><span class="p">)</span>  <span class="kd">::</span> <span class="n">defects</span>
<a name="ln-1343"></a><span class="k">type</span><span class="p">(</span><span class="n">unitcell</span><span class="p">),</span><span class="k">pointer</span>          <span class="kd">::</span> <span class="n">cell</span>
<a name="ln-1344"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>       <span class="kd">::</span> <span class="n">DF_L</span>
<a name="ln-1345"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>       <span class="kd">::</span> <span class="n">DF_g</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-1346"></a><span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">irg</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">inum</span><span class="p">,</span> <span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">dinfo</span>
<a name="ln-1347"></a>
<a name="ln-1348"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">)</span>                  <span class="kd">::</span> <span class="n">fpn</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span><span class="n">am</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span><span class="n">midpoint</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">ex</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">ey</span><span class="p">(</span><span class="mi">3</span><span class="p">),&amp;</span>
<a name="ln-1349"></a>                                 <span class="n">lptopi</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span><span class="n">lpboti</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span><span class="n">tptopi</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span><span class="n">tpboti</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span><span class="n">det</span><span class="p">,</span><span class="n">A</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="n">xx</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="n">yy</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="n">tmp</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="p">&amp;</span>
<a name="ln-1350"></a>                                 <span class="n">planenormal</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">rzero</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">unita</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">lun</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">tun</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">zang</span><span class="p">,</span> <span class="n">zu</span><span class="p">,</span> <span class="n">zz</span>
<a name="ln-1351"></a>
<a name="ln-1352"></a><span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">irg</span><span class="p">)</span>               <span class="kd">::</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">info</span><span class="p">,</span><span class="n">ipiv</span><span class="p">,</span><span class="n">minx</span><span class="p">,</span><span class="n">maxx</span><span class="p">,</span><span class="n">miny</span><span class="p">,</span><span class="n">maxy</span><span class="p">,</span> <span class="n">ndl</span>
<a name="ln-1353"></a>
<a name="ln-1354"></a><span class="n">ndl</span> <span class="o">=</span> <span class="n">defects</span><span class="p">%</span><span class="n">numYdisl</span>
<a name="ln-1355"></a>
<a name="ln-1356"></a><span class="c">! we begin by computing the geometry in the foil reference frame, which is the cartesian frame </span>
<a name="ln-1357"></a><span class="c">! for zero sample tilt;  sample tilts are applied once we known the partial dislocation geometry</span>
<a name="ln-1358"></a><span class="k">call </span><span class="n">TransSpace</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span><span class="n">defects</span><span class="p">%</span><span class="n">SF</span><span class="p">(</span><span class="n">inum</span><span class="p">)%</span><span class="n">plane</span><span class="p">,</span><span class="n">tmp</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">,</span><span class="s1">&#39;c&#39;</span><span class="p">)</span>
<a name="ln-1359"></a><span class="k">call </span><span class="n">NormVec</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span><span class="n">tmp</span><span class="p">,</span><span class="s1">&#39;c&#39;</span><span class="p">)</span>
<a name="ln-1360"></a><span class="n">planenormal</span> <span class="o">=</span>  <span class="n">tmp</span>
<a name="ln-1361"></a>
<a name="ln-1362"></a><span class="k">call </span><span class="n">CalcCross</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span> <span class="n">planenormal</span><span class="p">,</span> <span class="p">(</span><span class="o">/</span> <span class="mf">0.0</span><span class="p">,</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">1.0</span> <span class="o">/</span><span class="p">),</span>  <span class="n">unita</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<a name="ln-1363"></a><span class="k">call </span><span class="n">NormVec</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span><span class="n">unita</span><span class="p">,</span><span class="s1">&#39;c&#39;</span><span class="p">)</span>
<a name="ln-1364"></a><span class="n">fpn</span> <span class="o">=</span> <span class="n">planenormal</span>
<a name="ln-1365"></a><span class="k">if</span> <span class="p">(</span><span class="n">dinfo</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span> <span class="k">write</span> <span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s1">&#39; unita should have zero third component &#39;</span><span class="p">,</span><span class="n">unita</span><span class="p">,</span> <span class="n">fpn</span>
<a name="ln-1366"></a>
<a name="ln-1367"></a>
<a name="ln-1368"></a><span class="c">! the fault plane goes through the point rzero in the foil top surface</span>
<a name="ln-1369"></a><span class="n">rzero</span> <span class="o">=</span> <span class="p">(</span><span class="o">/</span> <span class="n">defects</span><span class="p">%</span><span class="n">SF</span><span class="p">(</span><span class="n">inum</span><span class="p">)%</span><span class="n">id</span><span class="p">,</span> <span class="n">defects</span><span class="p">%</span><span class="n">SF</span><span class="p">(</span><span class="n">inum</span><span class="p">)%</span><span class="n">jd</span><span class="p">,</span> <span class="nb">sngl</span><span class="p">(</span><span class="n">defects</span><span class="p">%</span><span class="n">foil</span><span class="p">%</span><span class="n">z0</span><span class="p">)</span><span class="o">*</span><span class="mf">0.5</span> <span class="o">/</span><span class="p">)</span>
<a name="ln-1370"></a>
<a name="ln-1371"></a><span class="c">! this leads to the location of the partial dislocation intersections, and these must</span>
<a name="ln-1372"></a><span class="c">! be Yoffe dislocations !!!</span>
<a name="ln-1373"></a><span class="n">defects</span><span class="p">%</span><span class="n">SF</span><span class="p">(</span><span class="n">inum</span><span class="p">)%</span><span class="n">lpr</span> <span class="o">=</span> <span class="n">rzero</span> <span class="o">+</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">defects</span><span class="p">%</span><span class="n">SF</span><span class="p">(</span><span class="n">inum</span><span class="p">)%</span><span class="n">sep</span><span class="o">*</span><span class="n">unita</span> <span class="o">/</span> <span class="n">DF_L</span>
<a name="ln-1374"></a><span class="n">defects</span><span class="p">%</span><span class="n">SF</span><span class="p">(</span><span class="n">inum</span><span class="p">)%</span><span class="n">tpr</span> <span class="o">=</span> <span class="n">rzero</span> <span class="o">-</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">defects</span><span class="p">%</span><span class="n">SF</span><span class="p">(</span><span class="n">inum</span><span class="p">)%</span><span class="n">sep</span><span class="o">*</span><span class="n">unita</span> <span class="o">/</span> <span class="n">DF_L</span>
<a name="ln-1375"></a>
<a name="ln-1376"></a><span class="k">if</span> <span class="p">(</span><span class="n">dinfo</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span> <span class="k">write</span> <span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s1">&#39;lpr_i = &#39;</span><span class="p">,</span><span class="n">defects</span><span class="p">%</span><span class="n">SF</span><span class="p">(</span><span class="n">inum</span><span class="p">)%</span><span class="n">lpr</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-1377"></a><span class="k">if</span> <span class="p">(</span><span class="n">dinfo</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span> <span class="k">write</span> <span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s1">&#39;tpr_i = &#39;</span><span class="p">,</span><span class="n">defects</span><span class="p">%</span><span class="n">SF</span><span class="p">(</span><span class="n">inum</span><span class="p">)%</span><span class="n">tpr</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-1378"></a>
<a name="ln-1379"></a>
<a name="ln-1380"></a><span class="c">! convert line directions to the Cartesian crystal reference frame</span>
<a name="ln-1381"></a><span class="k">call </span><span class="n">TransSpace</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span><span class="n">defects</span><span class="p">%</span><span class="n">SF</span><span class="p">(</span><span class="n">inum</span><span class="p">)%</span><span class="n">lpu</span><span class="p">,</span><span class="n">lun</span><span class="p">,</span><span class="s1">&#39;d&#39;</span><span class="p">,</span><span class="s1">&#39;c&#39;</span><span class="p">)</span>
<a name="ln-1382"></a><span class="k">call </span><span class="n">TransSpace</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span><span class="n">defects</span><span class="p">%</span><span class="n">SF</span><span class="p">(</span><span class="n">inum</span><span class="p">)%</span><span class="n">tpu</span><span class="p">,</span><span class="n">tun</span><span class="p">,</span><span class="s1">&#39;d&#39;</span><span class="p">,</span><span class="s1">&#39;c&#39;</span><span class="p">)</span>
<a name="ln-1383"></a><span class="c">! normalize both vectors</span>
<a name="ln-1384"></a><span class="k">call </span><span class="n">NormVec</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span><span class="n">lun</span><span class="p">,</span><span class="s1">&#39;c&#39;</span><span class="p">)</span>
<a name="ln-1385"></a><span class="k">call </span><span class="n">NormVec</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span><span class="n">tun</span><span class="p">,</span><span class="s1">&#39;c&#39;</span><span class="p">)</span>
<a name="ln-1386"></a>
<a name="ln-1387"></a>
<a name="ln-1388"></a><span class="c">! call makeYSHdislocation for each of the partials [must be done in main program]</span>
<a name="ln-1389"></a><span class="c">!  if (.not. allocated(YD)) allocate(defects%YD(3*maxdefects))</span>
<a name="ln-1390"></a>
<a name="ln-1391"></a>  <span class="n">defects</span><span class="p">%</span><span class="n">YD</span><span class="p">(</span><span class="n">ndl</span><span class="o">+</span><span class="mi">1</span><span class="p">)%</span><span class="n">id</span> <span class="o">=</span> <span class="n">defects</span><span class="p">%</span><span class="n">SF</span><span class="p">(</span><span class="n">inum</span><span class="p">)%</span><span class="n">lpr</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> 
<a name="ln-1392"></a>  <span class="n">defects</span><span class="p">%</span><span class="n">YD</span><span class="p">(</span><span class="n">ndl</span><span class="o">+</span><span class="mi">1</span><span class="p">)%</span><span class="n">jd</span> <span class="o">=</span> <span class="n">defects</span><span class="p">%</span><span class="n">SF</span><span class="p">(</span><span class="n">inum</span><span class="p">)%</span><span class="n">lpr</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<a name="ln-1393"></a>  <span class="n">defects</span><span class="p">%</span><span class="n">YD</span><span class="p">(</span><span class="n">ndl</span><span class="o">+</span><span class="mi">1</span><span class="p">)%</span><span class="n">u</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="nb">dble</span><span class="p">(</span><span class="n">defects</span><span class="p">%</span><span class="n">SF</span><span class="p">(</span><span class="n">inum</span><span class="p">)%</span><span class="n">lpu</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">))</span>
<a name="ln-1394"></a>  <span class="n">defects</span><span class="p">%</span><span class="n">YD</span><span class="p">(</span><span class="n">ndl</span><span class="o">+</span><span class="mi">1</span><span class="p">)%</span><span class="n">burg</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="nb">dble</span><span class="p">(</span><span class="n">defects</span><span class="p">%</span><span class="n">SF</span><span class="p">(</span><span class="n">inum</span><span class="p">)%</span><span class="n">lpb</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">))</span>
<a name="ln-1395"></a>  <span class="n">defects</span><span class="p">%</span><span class="n">YD</span><span class="p">(</span><span class="n">ndl</span><span class="o">+</span><span class="mi">1</span><span class="p">)%</span><span class="n">g</span> <span class="o">=</span> <span class="n">DF_g</span>
<a name="ln-1396"></a>  <span class="n">defects</span><span class="p">%</span><span class="n">YD</span><span class="p">(</span><span class="n">ndl</span><span class="o">+</span><span class="mi">1</span><span class="p">)%</span><span class="n">sig</span> <span class="o">=</span> <span class="n">defects</span><span class="p">%</span><span class="n">SF</span><span class="p">(</span><span class="n">inum</span><span class="p">)%</span><span class="n">poisson</span>
<a name="ln-1397"></a>  
<a name="ln-1398"></a>  <span class="n">defects</span><span class="p">%</span><span class="n">YD</span><span class="p">(</span><span class="n">ndl</span><span class="o">+</span><span class="mi">2</span><span class="p">)%</span><span class="n">id</span> <span class="o">=</span> <span class="n">defects</span><span class="p">%</span><span class="n">SF</span><span class="p">(</span><span class="n">inum</span><span class="p">)%</span><span class="n">tpr</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> 
<a name="ln-1399"></a>  <span class="n">defects</span><span class="p">%</span><span class="n">YD</span><span class="p">(</span><span class="n">ndl</span><span class="o">+</span><span class="mi">2</span><span class="p">)%</span><span class="n">jd</span> <span class="o">=</span> <span class="n">defects</span><span class="p">%</span><span class="n">SF</span><span class="p">(</span><span class="n">inum</span><span class="p">)%</span><span class="n">tpr</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<a name="ln-1400"></a>  <span class="n">defects</span><span class="p">%</span><span class="n">YD</span><span class="p">(</span><span class="n">ndl</span><span class="o">+</span><span class="mi">2</span><span class="p">)%</span><span class="n">u</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="nb">dble</span><span class="p">(</span><span class="n">defects</span><span class="p">%</span><span class="n">SF</span><span class="p">(</span><span class="n">inum</span><span class="p">)%</span><span class="n">tpu</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">))</span>
<a name="ln-1401"></a>  <span class="n">defects</span><span class="p">%</span><span class="n">YD</span><span class="p">(</span><span class="n">ndl</span><span class="o">+</span><span class="mi">2</span><span class="p">)%</span><span class="n">burg</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="nb">dble</span><span class="p">(</span><span class="n">defects</span><span class="p">%</span><span class="n">SF</span><span class="p">(</span><span class="n">inum</span><span class="p">)%</span><span class="n">tpb</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">))</span>
<a name="ln-1402"></a>  <span class="n">defects</span><span class="p">%</span><span class="n">YD</span><span class="p">(</span><span class="n">ndl</span><span class="o">+</span><span class="mi">2</span><span class="p">)%</span><span class="n">g</span> <span class="o">=</span> <span class="n">DF_g</span>
<a name="ln-1403"></a>  <span class="n">defects</span><span class="p">%</span><span class="n">YD</span><span class="p">(</span><span class="n">ndl</span><span class="o">+</span><span class="mi">2</span><span class="p">)%</span><span class="n">sig</span> <span class="o">=</span> <span class="n">defects</span><span class="p">%</span><span class="n">SF</span><span class="p">(</span><span class="n">inum</span><span class="p">)%</span><span class="n">poisson</span>
<a name="ln-1404"></a>
<a name="ln-1405"></a>  <span class="k">call </span><span class="n">makeYSHdislocation</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span><span class="n">defects</span><span class="p">,</span><span class="n">ndl</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">dinfo</span><span class="p">,</span><span class="n">DF_L</span><span class="p">)</span>
<a name="ln-1406"></a>  <span class="k">if</span> <span class="p">(</span><span class="n">dinfo</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span> <span class="k">write</span> <span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s1">&#39;Leading Partial Position &#39;</span><span class="p">,</span><span class="n">defects</span><span class="p">%</span><span class="n">YD</span><span class="p">(</span><span class="n">ndl</span><span class="o">+</span><span class="mi">1</span><span class="p">)%</span><span class="n">id</span><span class="p">,</span><span class="n">defects</span><span class="p">%</span><span class="n">YD</span><span class="p">(</span><span class="n">ndl</span><span class="o">+</span><span class="mi">1</span><span class="p">)%</span><span class="n">jd</span>
<a name="ln-1407"></a>  <span class="k">call </span><span class="n">makeYSHdislocation</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span><span class="n">defects</span><span class="p">,</span><span class="n">ndl</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="n">dinfo</span><span class="p">,</span><span class="n">DF_L</span><span class="p">)</span>
<a name="ln-1408"></a>  <span class="k">if</span> <span class="p">(</span><span class="n">dinfo</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span> <span class="k">write</span> <span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s1">&#39;Trailing Partial Position &#39;</span><span class="p">,</span><span class="n">defects</span><span class="p">%</span><span class="n">YD</span><span class="p">(</span><span class="n">ndl</span><span class="o">+</span><span class="mi">2</span><span class="p">)%</span><span class="n">id</span><span class="p">,</span><span class="n">defects</span><span class="p">%</span><span class="n">YD</span><span class="p">(</span><span class="n">ndl</span><span class="o">+</span><span class="mi">2</span><span class="p">)%</span><span class="n">jd</span>
<a name="ln-1409"></a>
<a name="ln-1410"></a><span class="c">! first find the length of the dislocation line inside the foil along the</span>
<a name="ln-1411"></a><span class="c">! dislocation z-axis, which is the line direction; also, compute the intersection</span>
<a name="ln-1412"></a><span class="c">! points of the line with the top and bottom surfaces  (all components in [nm])</span>
<a name="ln-1413"></a><span class="n">zang</span> <span class="o">=</span> <span class="n">CalcAngle</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span> <span class="n">defects</span><span class="p">%</span><span class="n">YD</span><span class="p">(</span><span class="n">ndl</span><span class="o">+</span><span class="mi">1</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">defects</span><span class="p">%</span><span class="n">foil</span><span class="p">%</span><span class="n">F</span><span class="p">,</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>
<a name="ln-1414"></a><span class="n">zz</span> <span class="o">=</span> <span class="nb">cos</span><span class="p">(</span><span class="n">zang</span><span class="p">)</span>
<a name="ln-1415"></a><span class="k">if</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">zz</span><span class="p">).</span><span class="n">gt</span><span class="p">.</span><span class="mf">0.00001</span><span class="p">)</span> <span class="k">then </span>
<a name="ln-1416"></a><span class="k">  </span><span class="n">zu</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">defects</span><span class="p">%</span><span class="n">foil</span><span class="p">%</span><span class="n">z0</span><span class="o">/</span><span class="n">zz</span><span class="p">)</span>
<a name="ln-1417"></a><span class="k">else</span>
<a name="ln-1418"></a><span class="k">  </span><span class="n">zu</span> <span class="o">=</span> <span class="mi">10000</span><span class="mf">0.0</span>         <span class="c">! this is when the dislocation is nearly parallel to the foil</span>
<a name="ln-1419"></a><span class="k">end if</span>
<a name="ln-1420"></a>
<a name="ln-1421"></a><span class="c">! transform the line direction to the foil reference frame</span>
<a name="ln-1422"></a>  <span class="n">tmp</span> <span class="o">=</span> <span class="n">quat_Lp</span><span class="p">(</span> <span class="nb">conjg</span><span class="p">(</span><span class="n">defects</span><span class="p">%</span><span class="n">foil</span><span class="p">%</span><span class="n">a_fc</span><span class="p">),</span> <span class="nb">dble</span><span class="p">(</span><span class="n">lun</span><span class="p">)</span> <span class="p">)</span> <span class="o">/</span> <span class="n">DF_L</span>
<a name="ln-1423"></a>
<a name="ln-1424"></a><span class="c">! determine the top and bottom intersection coordinates </span>
<a name="ln-1425"></a>  <span class="n">defects</span><span class="p">%</span><span class="n">YD</span><span class="p">(</span><span class="n">ndl</span><span class="o">+</span><span class="mi">1</span><span class="p">)%</span><span class="n">top</span> <span class="o">=</span> <span class="p">(</span><span class="o">/</span> <span class="n">defects</span><span class="p">%</span><span class="n">YD</span><span class="p">(</span><span class="n">ndl</span><span class="o">+</span><span class="mi">1</span><span class="p">)%</span><span class="n">id</span><span class="p">,</span> <span class="n">defects</span><span class="p">%</span><span class="n">YD</span><span class="p">(</span><span class="n">ndl</span><span class="o">+</span><span class="mi">1</span><span class="p">)%</span><span class="n">jd</span><span class="p">,</span> <span class="n">defects</span><span class="p">%</span><span class="n">foil</span><span class="p">%</span><span class="n">z0</span><span class="o">*</span><span class="mf">0.5</span> <span class="o">/</span><span class="p">)</span>
<a name="ln-1426"></a>  <span class="k">if</span> <span class="p">(</span><span class="n">zz</span><span class="p">.</span><span class="n">gt</span><span class="p">.</span><span class="mf">0.0</span><span class="p">)</span> <span class="k">then</span>  <span class="c">! u points to the top of the foil</span>
<a name="ln-1427"></a>    <span class="n">defects</span><span class="p">%</span><span class="n">YD</span><span class="p">(</span><span class="n">ndl</span><span class="o">+</span><span class="mi">1</span><span class="p">)%</span><span class="n">bottom</span> <span class="o">=</span> <span class="p">(</span><span class="o">/</span> <span class="n">defects</span><span class="p">%</span><span class="n">YD</span><span class="p">(</span><span class="n">ndl</span><span class="o">+</span><span class="mi">1</span><span class="p">)%</span><span class="n">id</span> <span class="o">-</span> <span class="n">tmp</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">zu</span><span class="p">,</span> <span class="n">defects</span><span class="p">%</span><span class="n">YD</span><span class="p">(</span><span class="n">ndl</span><span class="o">+</span><span class="mi">1</span><span class="p">)%</span><span class="n">jd</span> <span class="o">-</span> <span class="n">tmp</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">zu</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5D0</span><span class="o">*</span><span class="n">defects</span><span class="p">%</span><span class="n">foil</span><span class="p">%</span><span class="n">z0</span> <span class="o">/</span><span class="p">)</span>
<a name="ln-1428"></a>  <span class="k">else</span>                 <span class="c">! u points to the bottom of the foil</span>
<a name="ln-1429"></a>    <span class="n">defects</span><span class="p">%</span><span class="n">YD</span><span class="p">(</span><span class="n">ndl</span><span class="o">+</span><span class="mi">1</span><span class="p">)%</span><span class="n">bottom</span> <span class="o">=</span> <span class="p">(</span><span class="o">/</span> <span class="n">defects</span><span class="p">%</span><span class="n">YD</span><span class="p">(</span><span class="n">ndl</span><span class="o">+</span><span class="mi">1</span><span class="p">)%</span><span class="n">id</span> <span class="o">+</span> <span class="n">tmp</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">zu</span><span class="p">,</span> <span class="n">defects</span><span class="p">%</span><span class="n">YD</span><span class="p">(</span><span class="n">ndl</span><span class="o">+</span><span class="mi">1</span><span class="p">)%</span><span class="n">jd</span> <span class="o">+</span> <span class="n">tmp</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">zu</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5D0</span><span class="o">*</span><span class="n">defects</span><span class="p">%</span><span class="n">foil</span><span class="p">%</span><span class="n">z0</span> <span class="o">/</span><span class="p">)</span>
<a name="ln-1430"></a>  <span class="k">end if</span>  
<a name="ln-1431"></a>
<a name="ln-1432"></a>
<a name="ln-1433"></a><span class="c">! first find the length of the dislocation line inside the foil along the</span>
<a name="ln-1434"></a><span class="c">! dislocation z-axis, which is the line direction; also, compute the intersection</span>
<a name="ln-1435"></a><span class="c">! points of the line with the top and bottom surfaces  (all components in [nm])</span>
<a name="ln-1436"></a><span class="n">zang</span> <span class="o">=</span> <span class="n">CalcAngle</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span> <span class="n">defects</span><span class="p">%</span><span class="n">YD</span><span class="p">(</span><span class="n">ndl</span><span class="o">+</span><span class="mi">2</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">defects</span><span class="p">%</span><span class="n">foil</span><span class="p">%</span><span class="n">F</span><span class="p">,</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>
<a name="ln-1437"></a><span class="n">zz</span> <span class="o">=</span> <span class="nb">cos</span><span class="p">(</span><span class="n">zang</span><span class="p">)</span>
<a name="ln-1438"></a><span class="k">if</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">zz</span><span class="p">).</span><span class="n">gt</span><span class="p">.</span><span class="mf">0.00001</span><span class="p">)</span> <span class="k">then </span>
<a name="ln-1439"></a><span class="k">  </span><span class="n">zu</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">defects</span><span class="p">%</span><span class="n">foil</span><span class="p">%</span><span class="n">z0</span><span class="o">/</span><span class="n">zz</span><span class="p">)</span>
<a name="ln-1440"></a><span class="k">else</span>
<a name="ln-1441"></a><span class="k">  </span><span class="n">zu</span> <span class="o">=</span> <span class="mi">10000</span><span class="mf">0.0</span>         <span class="c">! this is when the dislocation is nearly parallel to the foil</span>
<a name="ln-1442"></a><span class="k">end if</span>
<a name="ln-1443"></a><span class="c">! transform the line direction to the foil reference frame</span>
<a name="ln-1444"></a>  <span class="n">tmp</span> <span class="o">=</span> <span class="n">quat_Lp</span><span class="p">(</span> <span class="nb">conjg</span><span class="p">(</span><span class="n">defects</span><span class="p">%</span><span class="n">foil</span><span class="p">%</span><span class="n">a_fc</span><span class="p">),</span> <span class="nb">dble</span><span class="p">(</span><span class="n">tun</span><span class="p">)</span> <span class="p">)</span> <span class="o">/</span> <span class="n">DF_L</span>
<a name="ln-1445"></a>
<a name="ln-1446"></a><span class="c">! determine the top and bottom intersection coordinates </span>
<a name="ln-1447"></a>  <span class="n">defects</span><span class="p">%</span><span class="n">YD</span><span class="p">(</span><span class="n">ndl</span><span class="o">+</span><span class="mi">2</span><span class="p">)%</span><span class="n">top</span> <span class="o">=</span> <span class="p">(</span><span class="o">/</span> <span class="n">defects</span><span class="p">%</span><span class="n">YD</span><span class="p">(</span><span class="n">ndl</span><span class="o">+</span><span class="mi">2</span><span class="p">)%</span><span class="n">id</span><span class="p">,</span> <span class="n">defects</span><span class="p">%</span><span class="n">YD</span><span class="p">(</span><span class="n">ndl</span><span class="o">+</span><span class="mi">2</span><span class="p">)%</span><span class="n">jd</span><span class="p">,</span> <span class="n">defects</span><span class="p">%</span><span class="n">foil</span><span class="p">%</span><span class="n">z0</span><span class="o">*</span><span class="mf">0.5</span> <span class="o">/</span><span class="p">)</span>
<a name="ln-1448"></a>  <span class="k">if</span> <span class="p">(</span><span class="n">zz</span><span class="p">.</span><span class="n">gt</span><span class="p">.</span><span class="mf">0.0</span><span class="p">)</span> <span class="k">then</span>  <span class="c">! u points to the top of the foil</span>
<a name="ln-1449"></a>    <span class="n">defects</span><span class="p">%</span><span class="n">YD</span><span class="p">(</span><span class="n">ndl</span><span class="o">+</span><span class="mi">2</span><span class="p">)%</span><span class="n">bottom</span> <span class="o">=</span> <span class="p">(</span><span class="o">/</span> <span class="n">defects</span><span class="p">%</span><span class="n">YD</span><span class="p">(</span><span class="n">ndl</span><span class="o">+</span><span class="mi">2</span><span class="p">)%</span><span class="n">id</span> <span class="o">-</span> <span class="n">tmp</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">zu</span><span class="p">,</span> <span class="n">defects</span><span class="p">%</span><span class="n">YD</span><span class="p">(</span><span class="n">ndl</span><span class="o">+</span><span class="mi">2</span><span class="p">)%</span><span class="n">jd</span> <span class="o">-</span> <span class="n">tmp</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">zu</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5D0</span><span class="o">*</span><span class="n">defects</span><span class="p">%</span><span class="n">foil</span><span class="p">%</span><span class="n">z0</span> <span class="o">/</span><span class="p">)</span>
<a name="ln-1450"></a>  <span class="k">else</span>                 <span class="c">! u points to the bottom of the foil</span>
<a name="ln-1451"></a>    <span class="n">defects</span><span class="p">%</span><span class="n">YD</span><span class="p">(</span><span class="n">ndl</span><span class="o">+</span><span class="mi">2</span><span class="p">)%</span><span class="n">bottom</span> <span class="o">=</span> <span class="p">(</span><span class="o">/</span> <span class="n">defects</span><span class="p">%</span><span class="n">YD</span><span class="p">(</span><span class="n">ndl</span><span class="o">+</span><span class="mi">2</span><span class="p">)%</span><span class="n">id</span> <span class="o">+</span> <span class="n">tmp</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">zu</span><span class="p">,</span> <span class="n">defects</span><span class="p">%</span><span class="n">YD</span><span class="p">(</span><span class="n">ndl</span><span class="o">+</span><span class="mi">2</span><span class="p">)%</span><span class="n">jd</span> <span class="o">+</span> <span class="n">tmp</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">zu</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5D0</span><span class="o">*</span><span class="n">defects</span><span class="p">%</span><span class="n">foil</span><span class="p">%</span><span class="n">z0</span> <span class="o">/</span><span class="p">)</span>
<a name="ln-1452"></a>  <span class="k">end if</span>  
<a name="ln-1453"></a>
<a name="ln-1454"></a>
<a name="ln-1455"></a><span class="c">! copy the top and bottom dislocation intersections</span>
<a name="ln-1456"></a><span class="c">! into the corresponding variables of the SF record</span>
<a name="ln-1457"></a>
<a name="ln-1458"></a><span class="n">defects</span><span class="p">%</span><span class="n">SF</span><span class="p">(</span><span class="n">inum</span><span class="p">)%</span><span class="n">lpbot</span> <span class="o">=</span> <span class="n">defects</span><span class="p">%</span><span class="n">YD</span><span class="p">(</span><span class="n">ndl</span><span class="o">+</span><span class="mi">1</span><span class="p">)%</span><span class="n">bottom</span>
<a name="ln-1459"></a><span class="n">defects</span><span class="p">%</span><span class="n">SF</span><span class="p">(</span><span class="n">inum</span><span class="p">)%</span><span class="n">lptop</span> <span class="o">=</span> <span class="n">defects</span><span class="p">%</span><span class="n">YD</span><span class="p">(</span><span class="n">ndl</span><span class="o">+</span><span class="mi">1</span><span class="p">)%</span><span class="n">top</span>
<a name="ln-1460"></a><span class="n">defects</span><span class="p">%</span><span class="n">SF</span><span class="p">(</span><span class="n">inum</span><span class="p">)%</span><span class="n">tpbot</span> <span class="o">=</span> <span class="n">defects</span><span class="p">%</span><span class="n">YD</span><span class="p">(</span><span class="n">ndl</span><span class="o">+</span><span class="mi">2</span><span class="p">)%</span><span class="n">bottom</span>
<a name="ln-1461"></a><span class="n">defects</span><span class="p">%</span><span class="n">SF</span><span class="p">(</span><span class="n">inum</span><span class="p">)%</span><span class="n">tptop</span> <span class="o">=</span> <span class="n">defects</span><span class="p">%</span><span class="n">YD</span><span class="p">(</span><span class="n">ndl</span><span class="o">+</span><span class="mi">2</span><span class="p">)%</span><span class="n">top</span>
<a name="ln-1462"></a>
<a name="ln-1463"></a><span class="c">! obviously, these four points need to lie in a single plane; at this point, we check that this is indeed the case</span>
<a name="ln-1464"></a><span class="c">! by computing the volume of the tetrahedron formed by these four points; if the volume is zero, then the </span>
<a name="ln-1465"></a><span class="c">! points are co-planar.  (Use LAPACK&#39;s LU-decomposition and compute the product of the diagonal elements of U)</span>
<a name="ln-1466"></a><span class="n">am</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="o">/</span> <span class="n">defects</span><span class="p">%</span><span class="n">SF</span><span class="p">(</span><span class="n">inum</span><span class="p">)%</span><span class="n">lptop</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">),</span><span class="mf">1.0</span> <span class="o">/</span><span class="p">)</span>
<a name="ln-1467"></a><span class="n">am</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="o">/</span> <span class="n">defects</span><span class="p">%</span><span class="n">SF</span><span class="p">(</span><span class="n">inum</span><span class="p">)%</span><span class="n">lpbot</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">),</span><span class="mf">1.0</span> <span class="o">/</span><span class="p">)</span> 
<a name="ln-1468"></a><span class="n">am</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="o">/</span> <span class="n">defects</span><span class="p">%</span><span class="n">SF</span><span class="p">(</span><span class="n">inum</span><span class="p">)%</span><span class="n">tptop</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">),</span><span class="mf">1.0</span> <span class="o">/</span><span class="p">)</span> 
<a name="ln-1469"></a><span class="n">am</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="o">/</span> <span class="n">defects</span><span class="p">%</span><span class="n">SF</span><span class="p">(</span><span class="n">inum</span><span class="p">)%</span><span class="n">tpbot</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">),</span><span class="mf">1.0</span> <span class="o">/</span><span class="p">)</span> 
<a name="ln-1470"></a><span class="k">call </span><span class="n">sgetrf</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="n">am</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="n">ipiv</span><span class="p">,</span><span class="n">info</span><span class="p">)</span>
<a name="ln-1471"></a><span class="n">det</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">am</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">am</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">am</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">am</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
<a name="ln-1472"></a><span class="k">if</span> <span class="p">(</span><span class="n">dinfo</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span> <span class="k">write</span> <span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s1">&#39;determinant (should be zero) = &#39;</span><span class="p">,</span><span class="n">det</span>
<a name="ln-1473"></a>
<a name="ln-1474"></a><span class="c">! ok, next we need to figure out which image pixels lie on the projection of the stacking fault plane.</span>
<a name="ln-1475"></a><span class="c">! We need to transform the corner points into the image reference frame !!!</span>
<a name="ln-1476"></a><span class="n">lptopi</span> <span class="o">=</span> <span class="n">quat_Lp</span><span class="p">(</span> <span class="n">defects</span><span class="p">%</span><span class="n">foil</span><span class="p">%</span><span class="n">a_fi</span><span class="p">,</span> <span class="nb">dble</span><span class="p">(</span><span class="n">defects</span><span class="p">%</span><span class="n">SF</span><span class="p">(</span><span class="n">inum</span><span class="p">)%</span><span class="n">lptop</span><span class="p">))</span>
<a name="ln-1477"></a><span class="n">lpboti</span> <span class="o">=</span> <span class="n">quat_Lp</span><span class="p">(</span> <span class="n">defects</span><span class="p">%</span><span class="n">foil</span><span class="p">%</span><span class="n">a_fi</span><span class="p">,</span> <span class="nb">dble</span><span class="p">(</span><span class="n">defects</span><span class="p">%</span><span class="n">SF</span><span class="p">(</span><span class="n">inum</span><span class="p">)%</span><span class="n">lpbot</span><span class="p">))</span>
<a name="ln-1478"></a><span class="n">tptopi</span> <span class="o">=</span> <span class="n">quat_Lp</span><span class="p">(</span> <span class="n">defects</span><span class="p">%</span><span class="n">foil</span><span class="p">%</span><span class="n">a_fi</span><span class="p">,</span> <span class="nb">dble</span><span class="p">(</span><span class="n">defects</span><span class="p">%</span><span class="n">SF</span><span class="p">(</span><span class="n">inum</span><span class="p">)%</span><span class="n">tptop</span><span class="p">))</span>
<a name="ln-1479"></a><span class="n">tpboti</span> <span class="o">=</span> <span class="n">quat_Lp</span><span class="p">(</span> <span class="n">defects</span><span class="p">%</span><span class="n">foil</span><span class="p">%</span><span class="n">a_fi</span><span class="p">,</span> <span class="nb">dble</span><span class="p">(</span><span class="n">defects</span><span class="p">%</span><span class="n">SF</span><span class="p">(</span><span class="n">inum</span><span class="p">)%</span><span class="n">tpbot</span><span class="p">))</span>
<a name="ln-1480"></a><span class="k">if</span> <span class="p">(</span><span class="n">dinfo</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1481"></a><span class="k">  write</span> <span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s1">&#39;SF parameters :&#39;</span>
<a name="ln-1482"></a>  <span class="k">write</span> <span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="n">lptopi</span><span class="p">,</span><span class="s1">&#39; &lt;&gt; &#39;</span><span class="p">,</span><span class="n">lpboti</span>
<a name="ln-1483"></a>  <span class="k">write</span> <span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="n">tptopi</span><span class="p">,</span><span class="s1">&#39; &lt;&gt; &#39;</span><span class="p">,</span><span class="n">tpboti</span>
<a name="ln-1484"></a><span class="k">end if</span>
<a name="ln-1485"></a>
<a name="ln-1486"></a><span class="c">! define the array that will contain the zpos values</span>
<a name="ln-1487"></a><span class="k">allocate</span><span class="p">(</span><span class="n">defects</span><span class="p">%</span><span class="n">SF</span><span class="p">(</span><span class="n">inum</span><span class="p">)%</span><span class="n">zpos</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span><span class="n">ny</span><span class="p">))</span>
<a name="ln-1488"></a><span class="n">defects</span><span class="p">%</span><span class="n">SF</span><span class="p">(</span><span class="n">inum</span><span class="p">)%</span><span class="n">zpos</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1000</span><span class="mf">0.0</span>    <span class="c">! set all points to be outside the projected SF</span>
<a name="ln-1489"></a>
<a name="ln-1490"></a><span class="c">! first determine the smaller box</span>
<a name="ln-1491"></a><span class="n">minx</span> <span class="o">=</span> <span class="nb">nint</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span> <span class="n">lptopi</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="n">lpboti</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="n">tptopi</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="n">tpboti</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">))</span> <span class="o">-</span><span class="mi">2</span>
<a name="ln-1492"></a><span class="n">maxx</span> <span class="o">=</span> <span class="nb">nint</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span> <span class="n">lptopi</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="n">lpboti</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="n">tptopi</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="n">tpboti</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">))</span> <span class="o">+</span><span class="mi">2</span>
<a name="ln-1493"></a><span class="n">miny</span> <span class="o">=</span> <span class="nb">nint</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span> <span class="n">lptopi</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span><span class="n">lpboti</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span><span class="n">tptopi</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span><span class="n">tpboti</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="p">))</span> <span class="o">-</span><span class="mi">2</span>
<a name="ln-1494"></a><span class="n">maxy</span> <span class="o">=</span> <span class="nb">nint</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span> <span class="n">lptopi</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span><span class="n">lpboti</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span><span class="n">tptopi</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span><span class="n">tpboti</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="p">))</span> <span class="o">+</span><span class="mi">2</span>
<a name="ln-1495"></a>
<a name="ln-1496"></a><span class="c">! the fault edges may fall outside of the viewing frame (origin at the center !!!)</span>
<a name="ln-1497"></a><span class="k">if</span> <span class="p">(</span><span class="n">minx</span><span class="p">.</span><span class="n">lt</span><span class="p">.(</span><span class="o">-</span><span class="n">nx</span><span class="o">/</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span> <span class="n">minx</span><span class="o">=-</span><span class="n">nx</span><span class="o">/</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span>
<a name="ln-1498"></a><span class="k">if</span> <span class="p">(</span><span class="n">maxx</span><span class="p">.</span><span class="n">gt</span><span class="p">.</span><span class="n">nx</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="n">maxx</span><span class="o">=</span><span class="n">nx</span><span class="o">/</span><span class="mi">2</span>
<a name="ln-1499"></a><span class="k">if</span> <span class="p">(</span><span class="n">miny</span><span class="p">.</span><span class="n">lt</span><span class="p">.(</span><span class="o">-</span><span class="n">ny</span><span class="o">/</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span> <span class="n">miny</span><span class="o">=-</span><span class="n">ny</span><span class="o">/</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span>
<a name="ln-1500"></a><span class="k">if</span> <span class="p">(</span><span class="n">maxy</span><span class="p">.</span><span class="n">gt</span><span class="p">.</span><span class="n">ny</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="n">maxy</span><span class="o">=</span><span class="n">ny</span><span class="o">/</span><span class="mi">2</span>
<a name="ln-1501"></a>
<a name="ln-1502"></a><span class="k">if</span> <span class="p">(</span><span class="n">dinfo</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span> <span class="k">write</span> <span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s1">&#39;Integer fault box = &#39;</span><span class="p">,</span><span class="n">minx</span><span class="p">,</span><span class="n">maxx</span><span class="p">,</span><span class="n">miny</span><span class="p">,</span><span class="n">maxy</span>
<a name="ln-1503"></a>
<a name="ln-1504"></a><span class="c">! get the equation of the stacking fault plane in the image reference frame</span>
<a name="ln-1505"></a><span class="c">! first the unit plane normal in image space</span>
<a name="ln-1506"></a><span class="c">! we&#39;ll take two vectors: ex = from ltop to ttop; ey = from ltop to lbot</span>
<a name="ln-1507"></a><span class="n">ex</span> <span class="o">=</span> <span class="n">tptopi</span> <span class="o">-</span> <span class="n">lptopi</span>
<a name="ln-1508"></a><span class="n">ey</span> <span class="o">=</span> <span class="n">lpboti</span> <span class="o">-</span> <span class="n">lptopi</span>
<a name="ln-1509"></a><span class="k">call </span><span class="n">NormVec</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span><span class="n">ex</span><span class="p">,</span><span class="s1">&#39;c&#39;</span><span class="p">)</span>
<a name="ln-1510"></a><span class="k">call </span><span class="n">NormVec</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span><span class="n">ey</span><span class="p">,</span><span class="s1">&#39;c&#39;</span><span class="p">)</span>
<a name="ln-1511"></a><span class="k">call </span><span class="n">CalcCross</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span><span class="n">ex</span><span class="p">,</span><span class="n">ey</span><span class="p">,</span><span class="n">fpn</span><span class="p">,</span><span class="s1">&#39;c&#39;</span><span class="p">,</span><span class="s1">&#39;c&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
<a name="ln-1512"></a>
<a name="ln-1513"></a><span class="n">A</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">fpn</span> <span class="c">! quat_LPstar( conjg(foil%a_fi), dble(fpn(1:3)) )</span>
<a name="ln-1514"></a><span class="n">midpoint</span> <span class="o">=</span> <span class="mf">0.25</span><span class="o">*</span><span class="p">(</span><span class="n">lptopi</span><span class="o">+</span><span class="n">lpboti</span><span class="o">+</span><span class="n">tptopi</span><span class="o">+</span><span class="n">tpboti</span><span class="p">)</span> <span class="c">! quat_LPstar( conjg(foil%a_fi), dble(0.25*(lptopi+lpboti+tptopi+tpboti) ))</span>
<a name="ln-1515"></a><span class="n">A</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">A</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">midpoint</span><span class="p">)</span>
<a name="ln-1516"></a><span class="k">if</span> <span class="p">(</span><span class="n">dinfo</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span> <span class="k">write</span> <span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s1">&#39;fault plane parameters : &#39;</span><span class="p">,</span><span class="n">A</span><span class="p">,</span> <span class="n">midpoint</span>
<a name="ln-1517"></a>
<a name="ln-1518"></a><span class="c">! rank the corner points so that the polygon is convex</span>
<a name="ln-1519"></a><span class="c">! call rank_points(tpboti(1:2),lpboti(1:2),lptopi(1:2),tptopi(1:2),xx,yy)</span>
<a name="ln-1520"></a><span class="n">xx</span> <span class="o">=</span> <span class="p">(</span><span class="o">/</span> <span class="n">lptopi</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">tptopi</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">tpboti</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="n">lpboti</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span><span class="p">)</span>
<a name="ln-1521"></a><span class="n">yy</span> <span class="o">=</span> <span class="p">(</span><span class="o">/</span> <span class="n">lptopi</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">tptopi</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">tpboti</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span><span class="n">lpboti</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span><span class="p">)</span>
<a name="ln-1522"></a>
<a name="ln-1523"></a><span class="c">! for all of the points inside this box:</span>
<a name="ln-1524"></a><span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="n">minx</span><span class="p">,</span><span class="n">maxx</span>
<a name="ln-1525"></a>  <span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="n">miny</span><span class="p">,</span><span class="n">maxy</span>
<a name="ln-1526"></a>    <span class="k">if</span> <span class="p">(</span><span class="n">point_inside_polygon</span><span class="p">(</span> <span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="n">j</span><span class="p">),</span> <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span> <span class="p">).</span><span class="n">gt</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span> <span class="k">then</span> 
<a name="ln-1527"></a><span class="c">! the point lies inside the projected region, </span>
<a name="ln-1528"></a><span class="c">! so we need the depth of the SF plane at this position, taking into account the </span>
<a name="ln-1529"></a><span class="c">! proper coordinate transformation (depth must be expressed in image reference frame)</span>
<a name="ln-1530"></a>        <span class="n">defects</span><span class="p">%</span><span class="n">SF</span><span class="p">(</span><span class="n">inum</span><span class="p">)%</span><span class="n">zpos</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="n">nx</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="n">ny</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span> <span class="n">A</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">-</span> <span class="n">A</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">-</span> <span class="n">A</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="nb">float</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="p">)</span><span class="o">/</span><span class="n">A</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-1531"></a>    <span class="k">end if</span>
<a name="ln-1532"></a><span class="k">  end do</span>
<a name="ln-1533"></a><span class="k">end do</span>
<a name="ln-1534"></a><span class="k">if</span> <span class="p">(</span><span class="n">dinfo</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span> <span class="k">write</span> <span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s1">&#39;fault plane pixels determined&#39;</span>
<a name="ln-1535"></a>
<a name="ln-1536"></a><span class="c">! let&#39;s also make sure that the SF displacement vector is translated to the </span>
<a name="ln-1537"></a><span class="c">! cartesian reference frame, so that it can be used directly by the CalcR routine</span>
<a name="ln-1538"></a><span class="n">defects</span><span class="p">%</span><span class="n">SF</span><span class="p">(</span><span class="n">inum</span><span class="p">)%</span><span class="n">lpbc</span> <span class="o">=</span> <span class="nb">matmul</span><span class="p">(</span><span class="n">cell</span><span class="p">%</span><span class="n">dsm</span><span class="p">,</span><span class="n">defects</span><span class="p">%</span><span class="n">SF</span><span class="p">(</span><span class="n">inum</span><span class="p">)%</span><span class="n">Rdisp</span><span class="p">)</span>
<a name="ln-1539"></a>
<a name="ln-1540"></a><span class="c">! that should do it for the stacking fault...  The rest </span>
<a name="ln-1541"></a><span class="c">! takes place in the CalcR routine.</span>
<a name="ln-1542"></a><span class="k">end subroutine </span><span class="n">makestackingfaultECCI</span>
<a name="ln-1543"></a>
<a name="ln-1544"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-1545"></a><span class="c">!</span>
<a name="ln-1546"></a><span class="c">! FUNCTION: YSHDisp</span>
<a name="ln-1547"></a><span class="c">!</span>
<a name="ln-1548"></a><span class="c">!&gt; @author Marc De Graef, Carnegie Mellon University</span>
<a name="ln-1549"></a><span class="c">!</span>
<a name="ln-1550"></a><span class="c">!&gt; @brief  compute the displacement field of an inclined dislocation intersecting the foil surface</span>
<a name="ln-1551"></a><span class="c">!</span>
<a name="ln-1552"></a><span class="c">!&gt; @details compute the displacement field of an inclined dislocation intersecting the top surface of </span>
<a name="ln-1553"></a><span class="c">!&gt; the foil, taking into account surface relaxations for the isotropic elastic case (cubic only) ... </span>
<a name="ln-1554"></a><span class="c">!&gt;</span>
<a name="ln-1555"></a><span class="c">!&gt; equations are based on the Shaibani&amp;Hazzledine 1981 paper, along with special limits for </span>
<a name="ln-1556"></a><span class="c">!&gt; the alpha-&gt;0 case, which were derived by MDG using Mathematica. </span>
<a name="ln-1557"></a><span class="c">!</span>
<a name="ln-1558"></a><span class="c">!&gt; @paraqm defects defects structure</span>
<a name="ln-1559"></a><span class="c">!&gt; @param x dislocation x-coordinate</span>
<a name="ln-1560"></a><span class="c">!&gt; @param y dislocation y-coordinate</span>
<a name="ln-1561"></a><span class="c">!&gt; @param z dislocation z-coordinate</span>
<a name="ln-1562"></a><span class="c">!&gt; @param ii dislocation number</span>
<a name="ln-1563"></a><span class="c">!</span>
<a name="ln-1564"></a><span class="c">!&gt; @todo There is a problem with dislocations normal to the foil surface, likely a typographical error</span>
<a name="ln-1565"></a><span class="c">!&gt; in the SH paper; this needs to be resolved further, which may require explicit repetition of all </span>
<a name="ln-1566"></a><span class="c">!&gt; analytical computations! Mathematica gives an infinite limit for the bx edge case when normal</span>
<a name="ln-1567"></a><span class="c">!&gt; to the foil surface.</span>
<a name="ln-1568"></a><span class="c">! </span>
<a name="ln-1569"></a><span class="c">!&gt; @date    1/5/99  MDG 1.0 original</span>
<a name="ln-1570"></a><span class="c">!&gt; @date    5/19/01 MDG 2.0 f90 version</span>
<a name="ln-1571"></a><span class="c">!&gt; @date   11/27/01 MDG 2.1 added kind support</span>
<a name="ln-1572"></a><span class="c">!&gt; @date   06/04/13 MDG 3.0 rewrite</span>
<a name="ln-1573"></a><span class="c">!&gt; @date   11/21/13 MDG 3.1 verification</span>
<a name="ln-1574"></a><span class="c">!&gt; @date   06/09/14 MDG 4.0 added defects as argument</span>
<a name="ln-1575"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-1576"></a><span class="k">recursive function </span><span class="n">YSHDisp</span><span class="p">(</span><span class="n">defects</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="n">ii</span><span class="p">)</span> <span class="k">result</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
<a name="ln-1577"></a><span class="c">!DEC$ ATTRIBUTES DLLEXPORT :: YSHDisp</span>
<a name="ln-1578"></a>
<a name="ln-1579"></a><span class="k">use </span><span class="n">constants</span>
<a name="ln-1580"></a>
<a name="ln-1581"></a><span class="k">IMPLICIT NONE</span>
<a name="ln-1582"></a>
<a name="ln-1583"></a><span class="k">type</span><span class="p">(</span><span class="n">defecttype</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">INOUT</span><span class="p">)</span>  <span class="kd">::</span> <span class="n">defects</span>
<a name="ln-1584"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">dbl</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>       <span class="kd">::</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span>
<a name="ln-1585"></a><span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">irg</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">ii</span>
<a name="ln-1586"></a>
<a name="ln-1587"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">dbl</span><span class="p">)</span>                  <span class="kd">::</span> <span class="n">eta</span><span class="p">,</span> <span class="n">zeta</span><span class="p">,</span> <span class="n">etap</span><span class="p">,</span> <span class="n">zetap</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">oms</span><span class="p">,</span> <span class="n">omts</span><span class="p">,</span> <span class="n">xx</span><span class="p">,</span> <span class="n">sgn</span><span class="p">,</span> <span class="n">om</span><span class="p">,</span> <span class="n">omp</span><span class="p">,</span> <span class="n">AA</span><span class="p">,</span> <span class="n">BB</span><span class="p">,</span> <span class="n">BBp</span><span class="p">,</span> <span class="n">th</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-1588"></a>                                 <span class="n">k</span><span class="p">,</span> <span class="n">lam</span><span class="p">,</span> <span class="n">alA</span><span class="p">,</span> <span class="n">alB</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">ms</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">du</span><span class="p">,</span> <span class="n">dv</span><span class="p">,</span> <span class="n">dw</span><span class="p">,</span> <span class="n">qe</span><span class="p">,</span> <span class="n">me</span><span class="p">,</span> <span class="n">De</span><span class="p">,</span> <span class="n">qx</span><span class="p">,</span> <span class="n">mx</span><span class="p">,</span> <span class="n">Dx</span><span class="p">,</span> <span class="n">rr</span><span class="p">,</span> <span class="n">eps</span>
<a name="ln-1589"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">dbl</span><span class="p">)</span>                  <span class="kd">::</span> <span class="n">res</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> 
<a name="ln-1590"></a>
<a name="ln-1591"></a><span class="c">! initialize the geometrical parameters</span>
<a name="ln-1592"></a><span class="n">eta</span>  <span class="o">=</span> <span class="n">y</span><span class="o">*</span><span class="n">defects</span><span class="p">%</span><span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">ca</span> <span class="o">-</span> <span class="n">z</span><span class="o">*</span><span class="n">defects</span><span class="p">%</span><span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">sa</span>
<a name="ln-1593"></a><span class="n">zeta</span> <span class="o">=</span> <span class="n">y</span><span class="o">*</span><span class="n">defects</span><span class="p">%</span><span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">sa</span> <span class="o">+</span> <span class="n">z</span><span class="o">*</span><span class="n">defects</span><span class="p">%</span><span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">ca</span>
<a name="ln-1594"></a><span class="n">etap</span>  <span class="o">=</span> <span class="o">-</span><span class="n">y</span><span class="o">*</span><span class="n">defects</span><span class="p">%</span><span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">ca</span> <span class="o">-</span> <span class="n">z</span><span class="o">*</span><span class="n">defects</span><span class="p">%</span><span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">sa</span>
<a name="ln-1595"></a><span class="n">zetap</span> <span class="o">=</span> <span class="n">y</span><span class="o">*</span><span class="n">defects</span><span class="p">%</span><span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">sa</span> <span class="o">-</span> <span class="n">z</span><span class="o">*</span><span class="n">defects</span><span class="p">%</span><span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">ca</span>
<a name="ln-1596"></a><span class="n">r</span> <span class="o">=</span> <span class="nb">sqrt</span><span class="p">(</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">y</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">z</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> 
<a name="ln-1597"></a><span class="n">oms</span> <span class="o">=</span> <span class="mf">1.D0</span><span class="o">-</span><span class="n">defects</span><span class="p">%</span><span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">sig</span>
<a name="ln-1598"></a><span class="n">omts</span> <span class="o">=</span> <span class="mf">1.D0</span><span class="o">-</span><span class="mf">2.D0</span><span class="o">*</span><span class="n">defects</span><span class="p">%</span><span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">sig</span>
<a name="ln-1599"></a>
<a name="ln-1600"></a><span class="c">! cover the special case of negative x values (based on IDL tests)</span>
<a name="ln-1601"></a><span class="n">xx</span> <span class="o">=</span> <span class="n">x</span>
<a name="ln-1602"></a><span class="n">sgn</span> <span class="o">=</span> <span class="mf">1.D0</span>
<a name="ln-1603"></a><span class="k">if</span> <span class="p">(</span><span class="n">xx</span><span class="p">.</span><span class="n">lt</span><span class="p">.</span><span class="mf">0.D0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1604"></a><span class="k">  </span><span class="n">xx</span> <span class="o">=</span> <span class="nb">dabs</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<a name="ln-1605"></a>  <span class="n">sgn</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.D0</span>
<a name="ln-1606"></a><span class="k">else </span>
<a name="ln-1607"></a><span class="k">  </span><span class="n">sgn</span> <span class="o">=</span> <span class="mf">1.D0</span>
<a name="ln-1608"></a><span class="k">end if</span>
<a name="ln-1609"></a>
<a name="ln-1610"></a><span class="c">! more parameters</span>
<a name="ln-1611"></a><span class="n">om</span> <span class="o">=</span>  <span class="p">(</span><span class="n">datan2</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">xx</span><span class="p">)</span><span class="o">-</span><span class="n">datan2</span><span class="p">(</span><span class="n">eta</span><span class="p">,</span><span class="n">xx</span><span class="p">)</span><span class="o">+</span><span class="n">datan2</span><span class="p">(</span><span class="n">xx</span><span class="o">*</span><span class="n">r</span><span class="o">*</span><span class="n">defects</span><span class="p">%</span><span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">sa</span><span class="p">,</span><span class="n">eta</span><span class="o">*</span><span class="n">y</span><span class="o">+</span><span class="n">xx</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">defects</span><span class="p">%</span><span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">ca</span><span class="p">))</span>
<a name="ln-1612"></a><span class="n">omp</span><span class="o">=</span> <span class="p">(</span><span class="n">datan2</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">xx</span><span class="p">)</span><span class="o">-</span><span class="n">datan2</span><span class="p">(</span><span class="n">etap</span><span class="p">,</span><span class="n">xx</span><span class="p">)</span><span class="o">+</span><span class="n">datan2</span><span class="p">(</span><span class="n">xx</span><span class="o">*</span><span class="n">r</span><span class="o">*</span><span class="n">defects</span><span class="p">%</span><span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">sa</span><span class="p">,</span><span class="n">etap</span><span class="o">*</span><span class="n">y</span><span class="o">-</span><span class="n">xx</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">defects</span><span class="p">%</span><span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">ca</span><span class="p">))</span>
<a name="ln-1613"></a>
<a name="ln-1614"></a><span class="n">AA</span> <span class="o">=</span> <span class="n">r</span><span class="o">-</span><span class="n">z</span>
<a name="ln-1615"></a><span class="n">BB</span>  <span class="o">=</span> <span class="n">r</span><span class="o">-</span><span class="n">zeta</span>
<a name="ln-1616"></a><span class="n">BBp</span> <span class="o">=</span> <span class="n">r</span><span class="o">-</span><span class="n">zetap</span> 
<a name="ln-1617"></a><span class="n">th</span> <span class="o">=</span> <span class="mf">2.D0</span><span class="o">*</span><span class="n">oms</span><span class="o">*</span><span class="p">(</span><span class="n">omp</span><span class="o">-</span><span class="n">om</span><span class="p">)</span>
<a name="ln-1618"></a><span class="n">lam</span> <span class="o">=</span> <span class="n">omts</span><span class="o">*</span><span class="nb">dlog</span><span class="p">(</span><span class="n">BBp</span><span class="o">/</span><span class="n">BB</span><span class="p">)</span>
<a name="ln-1619"></a><span class="n">alA</span> <span class="o">=</span> <span class="nb">dlog</span><span class="p">(</span><span class="n">AA</span><span class="p">)</span>
<a name="ln-1620"></a><span class="n">alB</span> <span class="o">=</span> <span class="nb">dlog</span><span class="p">(</span><span class="n">BB</span><span class="p">)</span>
<a name="ln-1621"></a>
<a name="ln-1622"></a>
<a name="ln-1623"></a><span class="n">u</span> <span class="o">=</span> <span class="mf">0.D0</span>
<a name="ln-1624"></a><span class="n">v</span> <span class="o">=</span> <span class="mf">0.D0</span>
<a name="ln-1625"></a><span class="n">w</span> <span class="o">=</span> <span class="mf">0.D0</span>
<a name="ln-1626"></a><span class="n">eps</span> <span class="o">=</span> <span class="mf">1.0D-6</span>
<a name="ln-1627"></a>
<a name="ln-1628"></a><span class="c">! screw component first</span>
<a name="ln-1629"></a><span class="k">if</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">defects</span><span class="p">%</span><span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">bs</span><span class="p">).</span><span class="n">gt</span><span class="p">.</span><span class="n">eps</span><span class="p">)</span> <span class="k">then </span>
<a name="ln-1630"></a><span class="k">  </span><span class="n">ms</span> <span class="o">=</span> <span class="n">xx</span><span class="o">*</span><span class="nb">sin</span><span class="p">(</span><span class="mf">2.D0</span><span class="o">*</span><span class="n">defects</span><span class="p">%</span><span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">alpha</span><span class="p">)</span><span class="o">/</span><span class="n">r</span><span class="o">/</span><span class="n">BB</span>
<a name="ln-1631"></a>  <span class="n">S</span> <span class="o">=</span> <span class="n">defects</span><span class="p">%</span><span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">bs</span><span class="o">/</span><span class="p">(</span><span class="mf">4.D0</span><span class="o">*</span><span class="n">cPi</span><span class="p">)</span>
<a name="ln-1632"></a>  <span class="k">if</span> <span class="p">(</span><span class="n">defects</span><span class="p">%</span><span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">alpha</span><span class="p">.</span><span class="n">gt</span><span class="p">.</span><span class="mf">0.01</span><span class="p">)</span> <span class="k">then </span>
<a name="ln-1633"></a><span class="k">    </span><span class="n">du</span> <span class="o">=</span> <span class="n">xx</span><span class="o">*</span><span class="n">ms</span><span class="o">+</span><span class="mf">2.D0</span><span class="o">*</span><span class="n">eta</span><span class="o">*</span><span class="n">defects</span><span class="p">%</span><span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">ca</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="n">BB</span><span class="o">+</span><span class="mf">2.D0</span><span class="o">*</span><span class="n">omts</span><span class="o">*</span><span class="n">defects</span><span class="p">%</span><span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">cota</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="mf">1.D0</span><span class="o">+</span><span class="n">defects</span><span class="p">%</span><span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">ca</span><span class="o">+</span><span class="p">&amp;</span>
<a name="ln-1634"></a>            <span class="n">defects</span><span class="p">%</span><span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">ca</span><span class="o">*</span><span class="n">alA</span><span class="o">-</span><span class="n">y</span><span class="o">*</span><span class="n">defects</span><span class="p">%</span><span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">sa</span><span class="o">/</span><span class="n">AA</span><span class="o">-</span><span class="n">alB</span><span class="p">)</span><span class="o">-</span><span class="nb">sin</span><span class="p">(</span><span class="mf">2.D0</span><span class="o">*</span><span class="n">defects</span><span class="p">%</span><span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">alpha</span><span class="p">)</span>
<a name="ln-1635"></a>    <span class="n">dv</span> <span class="o">=</span> <span class="n">y</span><span class="o">*</span><span class="n">ms</span><span class="o">-</span><span class="mf">2.D0</span><span class="o">*</span><span class="n">xx</span><span class="o">*</span><span class="n">defects</span><span class="p">%</span><span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">ca</span><span class="o">/</span><span class="n">BB</span><span class="o">-</span><span class="n">defects</span><span class="p">%</span><span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">sa</span><span class="o">*</span><span class="p">(</span><span class="n">omp</span><span class="o">-</span><span class="n">om</span><span class="p">)</span><span class="o">+</span><span class="mf">2.D0</span><span class="o">*</span><span class="n">omts</span><span class="o">*</span><span class="n">defects</span><span class="p">%</span><span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">cota</span><span class="o">*</span> <span class="p">&amp;</span>
<a name="ln-1636"></a>         <span class="p">(</span><span class="n">xx</span><span class="o">*</span><span class="n">defects</span><span class="p">%</span><span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">sa</span><span class="o">/</span><span class="n">AA</span><span class="o">-</span><span class="n">om</span><span class="o">*</span><span class="n">defects</span><span class="p">%</span><span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">ca</span><span class="p">)</span>
<a name="ln-1637"></a>    <span class="n">dw</span> <span class="o">=</span> <span class="n">z</span><span class="o">*</span><span class="n">ms</span><span class="o">+</span><span class="n">defects</span><span class="p">%</span><span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">ca</span><span class="o">*</span><span class="p">(</span><span class="n">omp</span><span class="o">-</span><span class="n">om</span><span class="p">)</span><span class="o">-</span><span class="mf">2.D0</span><span class="o">*</span><span class="n">omts</span><span class="o">*</span><span class="n">om</span><span class="o">*</span><span class="n">defects</span><span class="p">%</span><span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">ca</span>
<a name="ln-1638"></a>  <span class="k">else </span>
<a name="ln-1639"></a><span class="k">    </span><span class="n">du</span> <span class="o">=</span> <span class="mf">2.D0</span><span class="o">*</span><span class="n">y</span><span class="o">/</span><span class="p">(</span><span class="n">r</span><span class="o">-</span><span class="n">z</span><span class="p">)</span>
<a name="ln-1640"></a>    <span class="n">dv</span> <span class="o">=</span> <span class="o">-</span><span class="mf">2.D0</span><span class="o">*</span><span class="n">xx</span><span class="o">*</span><span class="p">(</span><span class="n">r</span><span class="o">+</span><span class="n">z</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">xx</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">y</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
<a name="ln-1641"></a>    <span class="n">dw</span> <span class="o">=</span> <span class="n">cPi</span> <span class="o">+</span> <span class="n">datan2</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">xx</span><span class="p">)</span> <span class="o">-</span> <span class="n">datan2</span><span class="p">(</span><span class="o">-</span><span class="n">y</span><span class="p">,</span><span class="n">xx</span><span class="p">)</span>
<a name="ln-1642"></a>  <span class="k">end if</span>
<a name="ln-1643"></a><span class="k">  </span><span class="n">u</span> <span class="o">=</span> <span class="n">u</span><span class="o">+</span><span class="n">du</span><span class="o">*</span><span class="n">S</span>
<a name="ln-1644"></a>  <span class="n">v</span> <span class="o">=</span> <span class="n">v</span><span class="o">-</span><span class="n">sgn</span><span class="o">*</span><span class="n">dv</span><span class="o">*</span><span class="n">S</span>
<a name="ln-1645"></a>  <span class="n">w</span> <span class="o">=</span> <span class="n">w</span><span class="o">+</span><span class="n">sgn</span><span class="o">*</span><span class="n">dw</span><span class="o">*</span><span class="n">S</span>
<a name="ln-1646"></a><span class="k">end if</span>
<a name="ln-1647"></a>
<a name="ln-1648"></a><span class="c">! then the edge component in the y-z plane</span>
<a name="ln-1649"></a><span class="k">if</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">defects</span><span class="p">%</span><span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">be</span><span class="p">).</span><span class="n">gt</span><span class="p">.</span><span class="n">eps</span><span class="p">)</span> <span class="k">then </span>
<a name="ln-1650"></a><span class="k">  </span><span class="n">qe</span> <span class="o">=</span> <span class="n">xx</span><span class="o">*</span><span class="p">(</span><span class="mf">1.D0</span><span class="o">/</span><span class="n">BBp</span><span class="o">-</span><span class="mf">1.D0</span><span class="o">/</span><span class="n">BB</span><span class="o">+</span><span class="mf">2.D0</span><span class="o">*</span><span class="n">z</span><span class="o">*</span><span class="n">defects</span><span class="p">%</span><span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">ca</span><span class="o">/</span><span class="n">BB</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
<a name="ln-1651"></a>  <span class="n">me</span> <span class="o">=</span> <span class="o">-</span><span class="n">qe</span><span class="o">/</span><span class="n">r</span><span class="o">-</span><span class="mf">4.D0</span><span class="o">*</span><span class="n">oms</span><span class="o">*</span><span class="n">xx</span><span class="o">*</span><span class="n">defects</span><span class="p">%</span><span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">ca</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="n">r</span><span class="o">/</span><span class="n">BB</span>
<a name="ln-1652"></a>  <span class="n">De</span> <span class="o">=</span> <span class="n">defects</span><span class="p">%</span><span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">be</span><span class="o">/</span><span class="p">(</span><span class="mf">8.D0</span><span class="o">*</span><span class="n">cPi</span><span class="o">*</span><span class="n">oms</span><span class="p">)</span>
<a name="ln-1653"></a>  <span class="k">if</span> <span class="p">(</span><span class="n">defects</span><span class="p">%</span><span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">alpha</span><span class="p">.</span><span class="n">gt</span><span class="p">.</span><span class="mf">0.01</span><span class="p">)</span> <span class="k">then </span>
<a name="ln-1654"></a><span class="k">    </span><span class="n">k</span> <span class="o">=</span> <span class="mf">4.D0</span><span class="o">*</span><span class="n">oms</span><span class="o">*</span><span class="n">omts</span><span class="o">*</span><span class="n">defects</span><span class="p">%</span><span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">cota</span><span class="o">**</span><span class="mi">2</span>
<a name="ln-1655"></a>    <span class="n">du</span> <span class="o">=</span> <span class="n">xx</span><span class="o">*</span><span class="n">me</span><span class="o">+</span><span class="n">lam</span><span class="o">+</span><span class="mf">2.D0</span><span class="o">*</span><span class="n">defects</span><span class="p">%</span><span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">ca</span><span class="o">*</span><span class="p">(</span><span class="n">z</span><span class="o">+</span><span class="mf">2.D0</span><span class="o">*</span><span class="n">oms</span><span class="o">*</span><span class="n">eta</span><span class="o">*</span><span class="n">defects</span><span class="p">%</span><span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">sa</span><span class="p">)</span><span class="o">/</span><span class="n">BB</span><span class="o">-</span><span class="mf">4.D0</span><span class="o">*</span><span class="n">oms</span><span class="o">*</span><span class="n">defects</span><span class="p">%</span><span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">sa</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="p">&amp;</span>
<a name="ln-1656"></a>           <span class="n">k</span><span class="o">*</span><span class="p">(</span><span class="mf">1.D0</span><span class="o">-</span><span class="n">defects</span><span class="p">%</span><span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">ca</span><span class="o">-</span><span class="n">defects</span><span class="p">%</span><span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">ca</span><span class="o">*</span><span class="n">alA</span><span class="o">+</span><span class="n">y</span><span class="o">*</span><span class="n">defects</span><span class="p">%</span><span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">sa</span><span class="o">/</span><span class="n">AA</span><span class="o">+</span><span class="n">alB</span><span class="p">)</span>
<a name="ln-1657"></a>    <span class="n">dv</span> <span class="o">=</span> <span class="n">y</span><span class="o">*</span><span class="n">me</span><span class="o">+</span><span class="n">qe</span><span class="o">*</span><span class="n">defects</span><span class="p">%</span><span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">sa</span><span class="o">+</span><span class="n">th</span><span class="o">*</span><span class="n">defects</span><span class="p">%</span><span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">ca</span><span class="o">+</span><span class="n">k</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="n">xx</span><span class="o">*</span><span class="n">defects</span><span class="p">%</span><span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">sa</span><span class="o">/</span><span class="n">AA</span><span class="o">+</span><span class="n">om</span><span class="o">*</span><span class="n">defects</span><span class="p">%</span><span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">ca</span><span class="p">)</span>
<a name="ln-1658"></a>    <span class="n">dw</span> <span class="o">=</span> <span class="n">z</span><span class="o">*</span><span class="n">me</span><span class="o">+</span><span class="n">qe</span><span class="o">*</span><span class="n">defects</span><span class="p">%</span><span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">ca</span><span class="o">+</span><span class="n">th</span><span class="o">*</span><span class="n">defects</span><span class="p">%</span><span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">sa</span><span class="o">-</span><span class="mf">2.D0</span><span class="o">*</span><span class="n">xx</span><span class="o">*</span><span class="n">defects</span><span class="p">%</span><span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">ca</span><span class="o">*</span><span class="p">(</span><span class="mf">1.D0</span><span class="o">/</span><span class="n">BBp</span><span class="o">+</span><span class="n">omts</span><span class="o">/</span><span class="n">BB</span><span class="p">)</span><span class="o">+</span><span class="n">k</span><span class="o">*</span><span class="n">om</span><span class="o">*</span><span class="n">defects</span><span class="p">%</span><span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">sa</span>
<a name="ln-1659"></a><span class="c">!    write (*,*) du,dv,dw</span>
<a name="ln-1660"></a>  <span class="k">else </span>
<a name="ln-1661"></a><span class="k">    </span><span class="n">rr</span> <span class="o">=</span> <span class="n">xx</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">y</span><span class="o">**</span><span class="mi">2</span>
<a name="ln-1662"></a>    <span class="n">du</span> <span class="o">=</span> <span class="mf">2.D0</span><span class="o">*</span><span class="n">z</span><span class="o">/</span><span class="p">(</span><span class="n">r</span><span class="o">-</span><span class="n">z</span><span class="p">)</span><span class="o">+</span><span class="mf">4.D0</span><span class="o">*</span><span class="n">xx</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">defects</span><span class="p">%</span><span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">sig</span><span class="o">*</span><span class="n">rr</span><span class="o">-</span><span class="n">r</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">r</span><span class="o">/</span><span class="n">AA</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="p">(</span><span class="n">r</span><span class="o">+</span><span class="n">z</span><span class="p">)</span><span class="o">+</span><span class="mf">2.D0</span><span class="o">*</span><span class="n">omts</span><span class="o">*</span><span class="n">oms</span><span class="o">*</span><span class="p">((</span><span class="n">xx</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">z</span><span class="o">*</span><span class="p">(</span><span class="n">z</span><span class="o">-</span><span class="n">r</span><span class="p">))</span><span class="o">/</span><span class="n">AA</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">alA</span><span class="p">)</span><span class="o">+</span><span class="p">&amp;</span>
<a name="ln-1663"></a>         <span class="n">omts</span><span class="o">*</span><span class="nb">dlog</span><span class="p">((</span><span class="n">r</span><span class="o">+</span><span class="n">z</span><span class="p">)</span><span class="o">/</span><span class="n">AA</span><span class="p">)</span>
<a name="ln-1664"></a>    <span class="n">dv</span> <span class="o">=</span> <span class="mf">4.D0</span><span class="o">*</span><span class="n">xx</span><span class="o">*</span><span class="n">y</span><span class="o">*</span><span class="p">(</span><span class="n">rr</span><span class="o">*</span><span class="n">defects</span><span class="p">%</span><span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">sig</span><span class="o">-</span><span class="n">r</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">r</span><span class="o">/</span><span class="n">AA</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="p">(</span><span class="n">r</span><span class="o">+</span><span class="n">z</span><span class="p">)</span><span class="o">+</span><span class="mf">2.D0</span><span class="o">*</span><span class="n">xx</span><span class="o">*</span><span class="n">y</span><span class="o">*</span><span class="p">(</span><span class="n">rr</span><span class="o">+</span><span class="mf">2.D0</span><span class="o">*</span><span class="n">z</span><span class="o">*</span><span class="p">(</span><span class="n">r</span><span class="o">+</span><span class="n">z</span><span class="p">))</span><span class="o">*</span><span class="n">oms</span><span class="o">*</span><span class="n">omts</span><span class="o">/</span><span class="n">rr</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="p">&amp;</span>
<a name="ln-1665"></a>            <span class="mf">2.D0</span><span class="o">*</span><span class="n">oms</span><span class="o">*</span><span class="p">(</span><span class="n">cPi</span> <span class="o">+</span> <span class="n">datan2</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">xx</span><span class="p">)</span> <span class="o">-</span> <span class="n">datan2</span><span class="p">(</span><span class="o">-</span><span class="n">y</span><span class="p">,</span><span class="n">xx</span><span class="p">))</span>
<a name="ln-1666"></a>    <span class="n">dw</span> <span class="o">=</span> <span class="mf">4.D0</span><span class="o">*</span><span class="n">xx</span><span class="o">*</span><span class="n">rr</span><span class="o">*</span><span class="n">defects</span><span class="p">%</span><span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">sig</span><span class="o">*</span><span class="p">(</span><span class="n">z</span><span class="o">-</span><span class="mf">2.D0</span><span class="o">*</span><span class="n">r</span><span class="o">*</span><span class="n">oms</span><span class="p">)</span><span class="o">/</span><span class="n">r</span><span class="o">/</span><span class="n">AA</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="p">(</span><span class="n">r</span><span class="o">+</span><span class="n">z</span><span class="p">)</span>
<a name="ln-1667"></a>  <span class="k">end if</span>
<a name="ln-1668"></a><span class="k">  </span><span class="n">u</span> <span class="o">=</span> <span class="n">u</span><span class="o">+</span><span class="n">du</span><span class="o">*</span><span class="n">De</span>
<a name="ln-1669"></a>  <span class="n">v</span> <span class="o">=</span> <span class="n">v</span><span class="o">+</span><span class="n">sgn</span><span class="o">*</span><span class="n">dv</span><span class="o">*</span><span class="n">De</span>
<a name="ln-1670"></a>  <span class="n">w</span> <span class="o">=</span> <span class="n">w</span><span class="o">+</span><span class="n">sgn</span><span class="o">*</span><span class="n">dw</span><span class="o">*</span><span class="n">De</span>
<a name="ln-1671"></a><span class="k">end if</span>
<a name="ln-1672"></a>
<a name="ln-1673"></a><span class="c">! and finally the bx edge component</span>
<a name="ln-1674"></a><span class="k">if</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">defects</span><span class="p">%</span><span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">bx</span><span class="p">).</span><span class="n">gt</span><span class="p">.</span><span class="n">eps</span><span class="p">)</span> <span class="k">then </span>
<a name="ln-1675"></a><span class="k">  </span><span class="n">qx</span> <span class="o">=</span> <span class="n">etap</span><span class="o">/</span><span class="n">BBp</span><span class="o">-</span><span class="n">eta</span><span class="o">/</span><span class="n">BB</span><span class="o">-</span><span class="mf">2.D0</span><span class="o">*</span><span class="n">z</span><span class="o">*</span><span class="n">eta</span><span class="o">*</span><span class="n">defects</span><span class="p">%</span><span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">ca</span><span class="o">/</span><span class="n">BB</span><span class="o">**</span><span class="mi">2</span>
<a name="ln-1676"></a>  <span class="n">mx</span> <span class="o">=</span> <span class="o">-</span><span class="n">qx</span><span class="o">/</span><span class="n">r</span><span class="o">+</span><span class="mf">2.D0</span><span class="o">*</span><span class="n">omts</span><span class="o">*</span><span class="n">y</span><span class="o">*</span><span class="n">defects</span><span class="p">%</span><span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">ca</span><span class="o">/</span><span class="n">r</span><span class="o">/</span><span class="n">BB</span>
<a name="ln-1677"></a>  <span class="n">Dx</span> <span class="o">=</span> <span class="n">defects</span><span class="p">%</span><span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">bx</span><span class="o">/</span><span class="p">(</span><span class="mf">8.D0</span><span class="o">*</span><span class="n">cPi</span><span class="o">*</span><span class="n">oms</span><span class="p">)</span>
<a name="ln-1678"></a>  <span class="k">if</span> <span class="p">(</span><span class="n">defects</span><span class="p">%</span><span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">alpha</span><span class="p">.</span><span class="n">gt</span><span class="p">.</span><span class="mf">0.01</span><span class="p">)</span> <span class="k">then </span>
<a name="ln-1679"></a><span class="k">    </span><span class="n">k</span> <span class="o">=</span> <span class="mf">4.D0</span><span class="o">*</span><span class="n">oms</span><span class="o">*</span><span class="n">omts</span><span class="o">*</span><span class="n">defects</span><span class="p">%</span><span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">cota</span><span class="o">**</span><span class="mi">2</span>
<a name="ln-1680"></a>    <span class="n">du</span> <span class="o">=</span> <span class="n">xx</span><span class="o">*</span><span class="n">mx</span><span class="o">+</span><span class="n">th</span><span class="o">+</span><span class="n">k</span><span class="o">*</span><span class="p">(</span><span class="n">xx</span><span class="o">*</span><span class="n">defects</span><span class="p">%</span><span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">ta</span><span class="o">/</span><span class="n">AA</span><span class="o">-</span><span class="n">om</span><span class="p">)</span>
<a name="ln-1681"></a>    <span class="n">dv</span> <span class="o">=</span> <span class="n">y</span><span class="o">*</span><span class="n">mx</span><span class="o">+</span><span class="n">qx</span><span class="o">*</span><span class="n">defects</span><span class="p">%</span><span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">sa</span><span class="o">-</span><span class="n">lam</span><span class="o">*</span><span class="n">defects</span><span class="p">%</span><span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">ca</span><span class="o">-</span><span class="mf">2.D0</span><span class="o">*</span><span class="n">defects</span><span class="p">%</span><span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">ca</span><span class="o">*</span><span class="p">&amp;</span>
<a name="ln-1682"></a>        <span class="p">(</span><span class="n">z</span><span class="o">*</span><span class="n">defects</span><span class="p">%</span><span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">ca</span><span class="o">+</span><span class="n">omts</span><span class="o">*</span><span class="n">y</span><span class="o">*</span><span class="n">defects</span><span class="p">%</span><span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">sa</span><span class="p">)</span><span class="o">/</span><span class="n">BB</span><span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-1683"></a>        <span class="n">k</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="mf">1.D0</span><span class="o">+</span><span class="n">defects</span><span class="p">%</span><span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">ca</span><span class="o">-</span><span class="n">alA</span><span class="o">+</span><span class="n">y</span><span class="o">*</span><span class="n">defects</span><span class="p">%</span><span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">ta</span><span class="o">/</span><span class="n">AA</span><span class="o">+</span><span class="n">defects</span><span class="p">%</span><span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">ca</span><span class="o">*</span><span class="n">alB</span><span class="p">)</span>
<a name="ln-1684"></a>    <span class="n">dw</span> <span class="o">=</span> <span class="n">z</span><span class="o">*</span><span class="n">mx</span><span class="o">+</span><span class="n">qx</span><span class="o">*</span><span class="n">defects</span><span class="p">%</span><span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">ca</span><span class="o">-</span><span class="n">lam</span><span class="o">*</span><span class="n">defects</span><span class="p">%</span><span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">sa</span><span class="o">-</span><span class="mf">2.D0</span><span class="o">*</span><span class="n">etap</span><span class="o">*</span><span class="n">defects</span><span class="p">%</span><span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">ca</span><span class="o">/</span><span class="n">BBp</span><span class="o">+</span><span class="p">&amp;</span>
<a name="ln-1685"></a>        <span class="mf">4.D0</span><span class="o">*</span><span class="n">defects</span><span class="p">%</span><span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">ca</span><span class="o">*</span><span class="p">(</span><span class="n">oms</span><span class="o">*</span><span class="n">y</span><span class="o">*</span><span class="n">defects</span><span class="p">%</span><span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">ca</span><span class="o">-</span><span class="n">omts</span><span class="o">*</span><span class="n">z</span><span class="o">*</span><span class="n">defects</span><span class="p">%</span><span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">sa</span><span class="p">)</span><span class="o">/</span><span class="n">BB</span><span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-1686"></a>        <span class="n">k</span><span class="o">*</span><span class="n">defects</span><span class="p">%</span><span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">ta</span><span class="o">*</span><span class="p">(</span><span class="n">defects</span><span class="p">%</span><span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">ca</span><span class="o">-</span><span class="n">alA</span><span class="o">+</span><span class="n">defects</span><span class="p">%</span><span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">ca</span><span class="o">*</span><span class="n">alB</span><span class="p">)</span><span class="o">+</span><span class="mf">4.D0</span><span class="o">*</span><span class="n">oms</span><span class="o">*</span><span class="n">defects</span><span class="p">%</span><span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">ca</span><span class="o">*</span><span class="n">defects</span><span class="p">%</span><span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">cota</span>
<a name="ln-1687"></a> <span class="k">else </span>
<a name="ln-1688"></a><span class="k">    </span><span class="n">rr</span> <span class="o">=</span> <span class="n">xx</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">y</span><span class="o">**</span><span class="mi">2</span>
<a name="ln-1689"></a>    <span class="n">du</span> <span class="o">=</span> <span class="o">-</span><span class="mf">4.D0</span><span class="o">*</span><span class="n">xx</span><span class="o">*</span><span class="n">y</span><span class="o">*</span><span class="p">(</span><span class="n">rr</span><span class="o">*</span><span class="n">defects</span><span class="p">%</span><span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">sig</span><span class="o">-</span><span class="n">r</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">r</span><span class="o">/</span><span class="n">AA</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="p">(</span><span class="n">r</span><span class="o">+</span><span class="n">z</span><span class="p">)</span><span class="o">-</span><span class="mf">2.D0</span><span class="o">*</span><span class="n">xx</span><span class="o">*</span><span class="n">y</span><span class="o">*</span><span class="p">(</span><span class="n">rr</span><span class="o">+</span><span class="mf">2.D0</span><span class="o">*</span><span class="n">z</span><span class="o">*</span><span class="p">(</span><span class="n">r</span><span class="o">+</span><span class="n">z</span><span class="p">))</span><span class="o">*</span><span class="n">oms</span><span class="o">*</span><span class="n">omts</span><span class="o">/</span><span class="n">rr</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="p">&amp;</span>
<a name="ln-1690"></a>            <span class="mf">2.D0</span><span class="o">*</span><span class="n">oms</span><span class="o">*</span><span class="p">(</span><span class="n">cPi</span> <span class="o">+</span> <span class="n">datan2</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">xx</span><span class="p">)</span> <span class="o">-</span> <span class="n">datan2</span><span class="p">(</span><span class="o">-</span><span class="n">y</span><span class="p">,</span><span class="n">xx</span><span class="p">))</span>
<a name="ln-1691"></a>    <span class="n">dv</span> <span class="o">=</span> <span class="mf">2.D0</span><span class="o">*</span><span class="n">z</span><span class="o">/</span><span class="p">(</span><span class="n">r</span><span class="o">-</span><span class="n">z</span><span class="p">)</span><span class="o">-</span><span class="mf">4.D0</span><span class="o">*</span><span class="n">y</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">defects</span><span class="p">%</span><span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">sig</span><span class="o">*</span><span class="n">rr</span><span class="o">-</span><span class="n">r</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">r</span><span class="o">/</span><span class="n">AA</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="p">(</span><span class="n">r</span><span class="o">+</span><span class="n">z</span><span class="p">)</span><span class="o">+</span><span class="mf">2.D0</span><span class="o">*</span><span class="n">omts</span><span class="o">*</span><span class="n">oms</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="mf">1.D0</span><span class="o">+</span><span class="p">(</span><span class="n">z</span><span class="o">*</span><span class="p">(</span><span class="n">r</span><span class="o">-</span><span class="n">z</span><span class="p">)</span><span class="o">-</span><span class="n">y</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">AA</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="n">alA</span><span class="p">)</span><span class="o">-</span> <span class="p">&amp;</span>
<a name="ln-1692"></a>            <span class="n">omts</span><span class="o">*</span><span class="nb">dlog</span><span class="p">((</span><span class="n">r</span><span class="o">+</span><span class="n">z</span><span class="p">)</span><span class="o">/</span><span class="n">AA</span><span class="p">)</span>
<a name="ln-1693"></a>    <span class="n">dw</span> <span class="o">=</span> <span class="mf">0.D0</span>     <span class="c">! not sure if this limit is correct ... Mathematica gives a directedinfinity value for the limit, which might mean that the </span>
<a name="ln-1694"></a>    <span class="c">! original YSH expression in the paper is incorrect for the w component ... this needs to be rederived and verified !!!</span>
<a name="ln-1695"></a>  <span class="k">end if</span>
<a name="ln-1696"></a>
<a name="ln-1697"></a><span class="k">  </span><span class="n">u</span> <span class="o">=</span> <span class="n">u</span><span class="o">+</span><span class="n">sgn</span><span class="o">*</span><span class="n">du</span><span class="o">*</span><span class="n">Dx</span>
<a name="ln-1698"></a>  <span class="n">v</span> <span class="o">=</span> <span class="n">v</span><span class="o">+</span><span class="n">dv</span><span class="o">*</span><span class="n">Dx</span>
<a name="ln-1699"></a>  <span class="n">w</span> <span class="o">=</span> <span class="n">w</span><span class="o">+</span><span class="n">dw</span><span class="o">*</span><span class="n">Dx</span>
<a name="ln-1700"></a><span class="k">end if</span>
<a name="ln-1701"></a>
<a name="ln-1702"></a><span class="c">! and return the displacement components</span>
<a name="ln-1703"></a><span class="n">res</span> <span class="o">=</span> <span class="p">(</span><span class="o">/</span> <span class="n">u</span><span class="p">,</span><span class="n">v</span><span class="p">,</span><span class="n">w</span> <span class="o">/</span><span class="p">)</span>
<a name="ln-1704"></a>
<a name="ln-1705"></a><span class="k">end function </span><span class="n">YSHDisp</span>
<a name="ln-1706"></a>
<a name="ln-1707"></a>
<a name="ln-1708"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-1709"></a><span class="c">!</span>
<a name="ln-1710"></a><span class="c">! FUNCTION: makeYSHdislocation</span>
<a name="ln-1711"></a><span class="c">!</span>
<a name="ln-1712"></a><span class="c">!&gt; @author Marc De Graef, Carnegie Mellon University</span>
<a name="ln-1713"></a><span class="c">!</span>
<a name="ln-1714"></a><span class="c">!&gt; @brief pre-compute geometrical parametersf or the Yoffe&amp;Shaibani&amp;Hazzledine (YSH) </span>
<a name="ln-1715"></a><span class="c">!&gt; surface-relaxed dislocation in an elastically isotropic matrix. </span>
<a name="ln-1716"></a><span class="c">!</span>
<a name="ln-1717"></a><span class="c">!&gt; @details These parameters are then used in the CalcR routine.</span>
<a name="ln-1718"></a><span class="c">!&gt;</span>
<a name="ln-1719"></a><span class="c">!&gt; We implemented the YSH expressions instead of Yoffe&#39;s </span>
<a name="ln-1720"></a><span class="c">!&gt; since the former are more easily handled for numerical computations.</span>
<a name="ln-1721"></a><span class="c">!&gt;</span>
<a name="ln-1722"></a><span class="c">!&gt; SH have redefined the x-y-z reference frame used by Yoffe to fall along</span>
<a name="ln-1723"></a><span class="c">!&gt; the dislocation line itself.  As a result, the Burgers vector must be decomposed</span>
<a name="ln-1724"></a><span class="c">!&gt; into a screw component and two edge components, one in the plane of the </span>
<a name="ln-1725"></a><span class="c">!&gt; discontinuity, the other normal to that plane (which is by definition the x-axis).</span>
<a name="ln-1726"></a><span class="c">!&gt; Check the SH paper for more details.</span>
<a name="ln-1727"></a><span class="c">!</span>
<a name="ln-1728"></a><span class="c">!&gt; @param cell unit cell pointer</span>
<a name="ln-1729"></a><span class="c">!&gt; @param defects defects structure</span>
<a name="ln-1730"></a><span class="c">!&gt; @param i dislocation number</span>
<a name="ln-1731"></a><span class="c">!&gt; @param dinfo triggers verbose output</span>
<a name="ln-1732"></a><span class="c">!&gt; @param L column edge length</span>
<a name="ln-1733"></a><span class="c">!</span>
<a name="ln-1734"></a><span class="c">!&gt; @todo Convert IO to Write_Value calls</span>
<a name="ln-1735"></a><span class="c">! </span>
<a name="ln-1736"></a><span class="c">!&gt; @date  1/5/99  MDG 1.0 original</span>
<a name="ln-1737"></a><span class="c">!&gt; @date  5/19/01 MDG 2.0 f90 version</span>
<a name="ln-1738"></a><span class="c">!&gt; @date 11/27/01 MDG 2.1 added kind support</span>
<a name="ln-1739"></a><span class="c">!&gt; @date 06/04/13 MDG 3.0 rewrite+added quaternions</span>
<a name="ln-1740"></a><span class="c">!&gt; @date 11/21/13 MDG 3.1 verification + rewrite of output handling</span>
<a name="ln-1741"></a><span class="c">!&gt; @date 06/09/14 MDG 4.0 added cell and defects arguments</span>
<a name="ln-1742"></a><span class="c">!&gt; @date 06/10/14 MDG 4.1 added foil argument</span>
<a name="ln-1743"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-1744"></a><span class="k">recursive subroutine </span><span class="n">makeYSHdislocation</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span><span class="n">defects</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">dinfo</span><span class="p">,</span> <span class="n">L</span><span class="p">)</span>    
<a name="ln-1745"></a><span class="c">!DEC$ ATTRIBUTES DLLEXPORT :: makeYSHdislocation</span>
<a name="ln-1746"></a>
<a name="ln-1747"></a><span class="k">use </span><span class="n">constants</span>
<a name="ln-1748"></a><span class="k">use </span><span class="n">crystal</span>
<a name="ln-1749"></a><span class="k">use </span><span class="n">io</span>
<a name="ln-1750"></a><span class="k">use </span><span class="n">error</span>
<a name="ln-1751"></a><span class="k">use </span><span class="n">rotations</span>
<a name="ln-1752"></a>
<a name="ln-1753"></a><span class="k">IMPLICIT NONE</span>
<a name="ln-1754"></a>
<a name="ln-1755"></a><span class="k">type</span><span class="p">(</span><span class="n">unitcell</span><span class="p">),</span><span class="k">pointer</span>              <span class="kd">::</span> <span class="n">cell</span>
<a name="ln-1756"></a><span class="k">type</span><span class="p">(</span><span class="n">defecttype</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">INOUT</span><span class="p">)</span>      <span class="kd">::</span> <span class="n">defects</span>
<a name="ln-1757"></a><span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">irg</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>        <span class="kd">::</span> <span class="n">i</span>
<a name="ln-1758"></a><span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">irg</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>        <span class="kd">::</span> <span class="n">dinfo</span>
<a name="ln-1759"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>           <span class="kd">::</span> <span class="n">L</span>
<a name="ln-1760"></a>
<a name="ln-1761"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">dbl</span><span class="p">)</span>                       <span class="kd">::</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">tu</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">tx</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">ty</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">te</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">tb</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">bl</span><span class="p">,</span> <span class="n">fx</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">fy</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">fz</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="p">&amp;</span>
<a name="ln-1762"></a>                                       <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">a_di</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">io_real</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-1763"></a>
<a name="ln-1764"></a><span class="c">! first, determine the alpha angle between the </span>
<a name="ln-1765"></a><span class="c">! negative z-axis, which is really the negative foil normal, and the line direction</span>
<a name="ln-1766"></a><span class="c">! (make sure to reduce the angle to [0,90] interval).</span>
<a name="ln-1767"></a><span class="c">! Each YSH dislocation must have a line direction that points INTO the foil !!!</span>
<a name="ln-1768"></a><span class="n">alpha</span> <span class="o">=</span> <span class="n">CalcAngle</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span><span class="n">defects</span><span class="p">%</span><span class="n">foil</span><span class="p">%</span><span class="n">F</span><span class="p">,</span><span class="nb">dble</span><span class="p">(</span><span class="n">defects</span><span class="p">%</span><span class="n">YD</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">u</span><span class="p">),</span><span class="s1">&#39;d&#39;</span><span class="p">)</span><span class="o">*</span><span class="mi">18</span><span class="mf">0.0</span><span class="o">/</span><span class="n">cPi</span>
<a name="ln-1769"></a><span class="k">if</span> <span class="p">(</span><span class="n">alpha</span><span class="p">.</span><span class="n">ge</span><span class="p">.</span><span class="mi">9</span><span class="mf">0.0</span><span class="p">)</span> <span class="k">then </span>
<a name="ln-1770"></a><span class="k">  </span><span class="n">alpha</span> <span class="o">=</span> <span class="mi">18</span><span class="mf">0.0</span><span class="o">-</span><span class="n">alpha</span>
<a name="ln-1771"></a>  <span class="k">if</span> <span class="p">(</span><span class="n">dinfo</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span> <span class="k">then </span>
<a name="ln-1772"></a><span class="k">    </span><span class="n">io_real</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">defects</span><span class="p">%</span><span class="n">foil</span><span class="p">%</span><span class="n">F</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-1773"></a>    <span class="k">call </span><span class="n">WriteValue</span><span class="p">(</span><span class="s1">&#39;Foil normal = &#39;</span><span class="p">,</span> <span class="n">io_real</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;(&#39;[&#39;,3F5.1,&#39;]&#39;)&quot;</span><span class="p">)</span>
<a name="ln-1774"></a>    <span class="n">io_real</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">defects</span><span class="p">%</span><span class="n">YD</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">u</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-1775"></a>    <span class="k">call </span><span class="n">WriteValue</span><span class="p">(</span><span class="s1">&#39;line direction = &#39;</span><span class="p">,</span> <span class="n">io_real</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;(&#39;[&#39;,3F5.1,&#39;]&#39;)&quot;</span><span class="p">)</span>
<a name="ln-1776"></a>    <span class="n">io_real</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">alpha</span>
<a name="ln-1777"></a>    <span class="k">call </span><span class="n">WriteValue</span><span class="p">(</span><span class="s1">&#39; --&gt; alpha angle = &#39;</span><span class="p">,</span> <span class="n">io_real</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;(F5.1)&quot;</span><span class="p">)</span>
<a name="ln-1778"></a>  <span class="k">end if</span>
<a name="ln-1779"></a><span class="k">  </span><span class="n">alpha</span> <span class="o">=</span> <span class="n">alpha</span><span class="o">*</span><span class="n">cPi</span><span class="o">/</span><span class="mi">18</span><span class="mf">0.0</span>
<a name="ln-1780"></a><span class="k">else </span>
<a name="ln-1781"></a><span class="k">  call </span><span class="n">FatalError</span><span class="p">(</span><span class="s1">&#39;makeYSHdislocation&#39;</span><span class="p">,</span><span class="s1">&#39;YSH dislocations must have line directions pointing into the foil ! &#39;</span><span class="p">)</span>
<a name="ln-1782"></a><span class="k">end if</span>
<a name="ln-1783"></a>
<a name="ln-1784"></a><span class="c">! normalize the line direction</span>
<a name="ln-1785"></a><span class="k">call </span><span class="n">TransSpace</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span><span class="n">defects</span><span class="p">%</span><span class="n">YD</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">u</span><span class="p">,</span><span class="n">tu</span><span class="p">,</span><span class="s1">&#39;d&#39;</span><span class="p">,</span><span class="s1">&#39;c&#39;</span><span class="p">)</span>
<a name="ln-1786"></a><span class="k">call </span><span class="n">NormVec</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span><span class="n">tu</span><span class="p">,</span><span class="s1">&#39;c&#39;</span><span class="p">)</span>
<a name="ln-1787"></a>
<a name="ln-1788"></a><span class="c">! consider the case of alpha=0 separately</span>
<a name="ln-1789"></a><span class="k">if</span> <span class="p">(</span><span class="n">alpha</span><span class="p">.</span><span class="n">gt</span><span class="p">.</span><span class="mf">0.0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-1790"></a><span class="k">  call </span><span class="n">TransSpace</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span><span class="n">defects</span><span class="p">%</span><span class="n">foil</span><span class="p">%</span><span class="n">F</span><span class="p">,</span><span class="n">ty</span><span class="p">,</span><span class="s1">&#39;d&#39;</span><span class="p">,</span><span class="s1">&#39;c&#39;</span><span class="p">)</span>
<a name="ln-1791"></a>  <span class="k">call </span><span class="n">NormVec</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span><span class="n">ty</span><span class="p">,</span><span class="s1">&#39;c&#39;</span><span class="p">)</span>                     <span class="c">!  F</span>
<a name="ln-1792"></a>  <span class="k">call </span><span class="n">CalcCross</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span><span class="n">tu</span><span class="p">,</span><span class="n">ty</span><span class="p">,</span><span class="n">tx</span><span class="p">,</span><span class="s1">&#39;c&#39;</span><span class="p">,</span><span class="s1">&#39;c&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>       <span class="c">! x = u x F</span>
<a name="ln-1793"></a>  <span class="k">call </span><span class="n">NormVec</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span><span class="n">tx</span><span class="p">,</span><span class="s1">&#39;c&#39;</span><span class="p">)</span>
<a name="ln-1794"></a>  <span class="k">call </span><span class="n">CalcCross</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span><span class="n">tx</span><span class="p">,</span><span class="n">tu</span><span class="p">,</span><span class="n">te</span><span class="p">,</span><span class="s1">&#39;c&#39;</span><span class="p">,</span><span class="s1">&#39;c&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>       <span class="c">! e = x x u</span>
<a name="ln-1795"></a>  <span class="k">call </span><span class="n">NormVec</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span><span class="n">te</span><span class="p">,</span><span class="s1">&#39;c&#39;</span><span class="p">)</span>
<a name="ln-1796"></a>  <span class="k">call </span><span class="n">CalcCross</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span><span class="n">ty</span><span class="p">,</span><span class="n">tx</span><span class="p">,</span><span class="n">ty</span><span class="p">,</span><span class="s1">&#39;c&#39;</span><span class="p">,</span><span class="s1">&#39;c&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
<a name="ln-1797"></a>  <span class="k">call </span><span class="n">NormVec</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span><span class="n">ty</span><span class="p">,</span><span class="s1">&#39;c&#39;</span><span class="p">)</span>
<a name="ln-1798"></a><span class="k">else</span>
<a name="ln-1799"></a><span class="k">  </span><span class="n">tx</span> <span class="o">=</span> <span class="n">defects</span><span class="p">%</span><span class="n">foil</span><span class="p">%</span><span class="n">qn</span>
<a name="ln-1800"></a>  <span class="k">call </span><span class="n">CalcCross</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span><span class="n">tx</span><span class="p">,</span><span class="n">tu</span><span class="p">,</span><span class="n">te</span><span class="p">,</span><span class="s1">&#39;c&#39;</span><span class="p">,</span><span class="s1">&#39;c&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>       <span class="c">! e = x x u</span>
<a name="ln-1801"></a>  <span class="k">call </span><span class="n">NormVec</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span><span class="n">te</span><span class="p">,</span><span class="s1">&#39;c&#39;</span><span class="p">)</span>
<a name="ln-1802"></a><span class="k">end if  </span>
<a name="ln-1803"></a><span class="n">bl</span> <span class="o">=</span> <span class="n">CalcLength</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span><span class="n">defects</span><span class="p">%</span><span class="n">YD</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">burg</span><span class="p">,</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>
<a name="ln-1804"></a>
<a name="ln-1805"></a><span class="k">if</span> <span class="p">(</span><span class="n">dinfo</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span> <span class="k">then </span>
<a name="ln-1806"></a><span class="k">  </span><span class="n">io_real</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">tx</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-1807"></a>  <span class="k">call </span><span class="n">WriteValue</span><span class="p">(</span><span class="s1">&#39; tx = &#39;</span><span class="p">,</span><span class="n">io_real</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;(3F5.1)&quot;</span><span class="p">)</span>
<a name="ln-1808"></a>  <span class="n">io_real</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">te</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-1809"></a>  <span class="k">call </span><span class="n">WriteValue</span><span class="p">(</span><span class="s1">&#39; te = &#39;</span><span class="p">,</span><span class="n">io_real</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;(3F5.1)&quot;</span><span class="p">)</span>
<a name="ln-1810"></a>  <span class="n">io_real</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">tu</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-1811"></a>  <span class="k">call </span><span class="n">WriteValue</span><span class="p">(</span><span class="s1">&#39; tu = &#39;</span><span class="p">,</span><span class="n">io_real</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;(3F5.1)&quot;</span><span class="p">)</span>
<a name="ln-1812"></a>  <span class="n">io_real</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">ty</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-1813"></a>  <span class="k">call </span><span class="n">WriteValue</span><span class="p">(</span><span class="s1">&#39; ty = &#39;</span><span class="p">,</span><span class="n">io_real</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;(3F5.1)&quot;</span><span class="p">)</span>
<a name="ln-1814"></a>  <span class="n">io_real</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">bl</span>
<a name="ln-1815"></a>  <span class="k">call </span><span class="n">WriteValue</span><span class="p">(</span><span class="s1">&#39; bl = &#39;</span><span class="p">,</span><span class="n">io_real</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;(F8.3)&quot;</span><span class="p">)</span>
<a name="ln-1816"></a><span class="k">end if</span>
<a name="ln-1817"></a>
<a name="ln-1818"></a><span class="k">call </span><span class="n">TransSpace</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span><span class="n">defects</span><span class="p">%</span><span class="n">YD</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">burg</span><span class="p">,</span><span class="n">tb</span><span class="p">,</span><span class="s1">&#39;d&#39;</span><span class="p">,</span><span class="s1">&#39;c&#39;</span><span class="p">)</span>
<a name="ln-1819"></a><span class="k">call </span><span class="n">NormVec</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span><span class="n">tb</span><span class="p">,</span><span class="s1">&#39;c&#39;</span><span class="p">)</span>
<a name="ln-1820"></a><span class="n">defects</span><span class="p">%</span><span class="n">YD</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">bx</span> <span class="o">=</span> <span class="n">bl</span> <span class="o">*</span> <span class="n">CalcDot</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span><span class="n">tb</span><span class="p">,</span><span class="n">tx</span><span class="p">,</span><span class="s1">&#39;c&#39;</span><span class="p">)</span>   <span class="c">! edge component normal to cut plane</span>
<a name="ln-1821"></a><span class="n">defects</span><span class="p">%</span><span class="n">YD</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">be</span> <span class="o">=</span> <span class="n">bl</span> <span class="o">*</span> <span class="n">CalcDot</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span><span class="n">tb</span><span class="p">,</span><span class="n">te</span><span class="p">,</span><span class="s1">&#39;c&#39;</span><span class="p">)</span>   <span class="c">! edge component in cut plane</span>
<a name="ln-1822"></a><span class="n">defects</span><span class="p">%</span><span class="n">YD</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">bs</span> <span class="o">=</span> <span class="n">bl</span> <span class="o">*</span> <span class="n">CalcDot</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span><span class="n">tb</span><span class="p">,</span><span class="n">tu</span><span class="p">,</span><span class="s1">&#39;c&#39;</span><span class="p">)</span>   <span class="c">! screw component</span>
<a name="ln-1823"></a>
<a name="ln-1824"></a><span class="k">if</span> <span class="p">(</span><span class="n">dinfo</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span> <span class="k">then </span>
<a name="ln-1825"></a><span class="k">  </span><span class="n">io_real</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="o">/</span> <span class="n">defects</span><span class="p">%</span><span class="n">YD</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">bx</span><span class="p">,</span><span class="n">defects</span><span class="p">%</span><span class="n">YD</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">be</span><span class="p">,</span><span class="n">defects</span><span class="p">%</span><span class="n">YD</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">bs</span> <span class="o">/</span><span class="p">)</span>
<a name="ln-1826"></a>  <span class="k">call </span><span class="n">WriteValue</span><span class="p">(</span><span class="s1">&#39;Burgers vector components (bx,be,bs) &#39;</span><span class="p">,</span> <span class="n">io_real</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;(3F12.6)&quot;</span><span class="p">)</span> 
<a name="ln-1827"></a><span class="k">end if</span>
<a name="ln-1828"></a><span class="c">! verified MDG 7/31/11</span>
<a name="ln-1829"></a>
<a name="ln-1830"></a>
<a name="ln-1831"></a><span class="c">! we will also need to know the quaternion rotation between the dislocation reference frame </span>
<a name="ln-1832"></a><span class="c">! and the foil reference frame, so that we can transform the foil coordinates to defect </span>
<a name="ln-1833"></a><span class="c">! coordinates...  We need the angle beta between the defect x axis (tx) and the foil x axis,</span>
<a name="ln-1834"></a><span class="c">! which is the first column of the foil%a_fc matrix ...   We must make sure that this angle</span>
<a name="ln-1835"></a><span class="c">! is measured in a CCW sense.</span>
<a name="ln-1836"></a>
<a name="ln-1837"></a><span class="c">! projection of defect x axis onto foil x and y axes</span>
<a name="ln-1838"></a><span class="k">call </span><span class="n">TransSpace</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span><span class="n">defects</span><span class="p">%</span><span class="n">foil</span><span class="p">%</span><span class="n">q</span><span class="p">,</span><span class="n">fx</span><span class="p">,</span><span class="s1">&#39;d&#39;</span><span class="p">,</span><span class="s1">&#39;c&#39;</span><span class="p">)</span>
<a name="ln-1839"></a><span class="k">call </span><span class="n">TransSpace</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span><span class="n">defects</span><span class="p">%</span><span class="n">foil</span><span class="p">%</span><span class="n">F</span><span class="p">,</span><span class="n">fz</span><span class="p">,</span><span class="s1">&#39;d&#39;</span><span class="p">,</span><span class="s1">&#39;c&#39;</span><span class="p">)</span>
<a name="ln-1840"></a><span class="k">call </span><span class="n">NormVec</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span><span class="n">fx</span><span class="p">,</span><span class="s1">&#39;c&#39;</span><span class="p">)</span>
<a name="ln-1841"></a><span class="k">call </span><span class="n">NormVec</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span><span class="n">fz</span><span class="p">,</span><span class="s1">&#39;c&#39;</span><span class="p">)</span>
<a name="ln-1842"></a><span class="k">call </span><span class="n">CalcCross</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span><span class="n">fz</span><span class="p">,</span><span class="n">fx</span><span class="p">,</span><span class="n">fy</span><span class="p">,</span><span class="s1">&#39;c&#39;</span><span class="p">,</span><span class="s1">&#39;c&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
<a name="ln-1843"></a><span class="n">dx</span> <span class="o">=</span> <span class="n">CalcDot</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span><span class="n">tx</span><span class="p">,</span><span class="n">fx</span><span class="p">,</span><span class="s1">&#39;c&#39;</span><span class="p">)</span>
<a name="ln-1844"></a><span class="n">dy</span> <span class="o">=</span> <span class="n">CalcDot</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span><span class="n">tx</span><span class="p">,</span><span class="n">fy</span><span class="p">,</span><span class="s1">&#39;c&#39;</span><span class="p">)</span>
<a name="ln-1845"></a>
<a name="ln-1846"></a><span class="c">! use the arctan function to get the angle with correct quadrant computation</span>
<a name="ln-1847"></a><span class="n">defects</span><span class="p">%</span><span class="n">YD</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">beta</span> <span class="o">=</span> <span class="n">atan2</span><span class="p">(</span><span class="n">dy</span><span class="p">,</span><span class="n">dx</span><span class="p">)</span> <span class="c">!+ cPi*0.5</span>
<a name="ln-1848"></a>
<a name="ln-1849"></a><span class="k">if</span> <span class="p">(</span><span class="n">dinfo</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span> <span class="k">then </span>
<a name="ln-1850"></a><span class="k">  </span><span class="n">io_real</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">dx</span>
<a name="ln-1851"></a>  <span class="k">call </span><span class="n">WriteValue</span><span class="p">(</span><span class="s1">&#39; dx = &#39;</span><span class="p">,</span> <span class="n">io_real</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;(F8.3)&quot;</span><span class="p">)</span>
<a name="ln-1852"></a>  <span class="n">io_real</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">dy</span>
<a name="ln-1853"></a>  <span class="k">call </span><span class="n">WriteValue</span><span class="p">(</span><span class="s1">&#39; dy = &#39;</span><span class="p">,</span> <span class="n">io_real</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;(F8.3)&quot;</span><span class="p">)</span>
<a name="ln-1854"></a>  <span class="n">io_real</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">defects</span><span class="p">%</span><span class="n">YD</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">beta</span>
<a name="ln-1855"></a>  <span class="k">call </span><span class="n">WriteValue</span><span class="p">(</span><span class="s1">&#39; beta = &#39;</span><span class="p">,</span> <span class="n">io_real</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;(F8.3)&quot;</span><span class="p">)</span>
<a name="ln-1856"></a><span class="k">end if</span>
<a name="ln-1857"></a>
<a name="ln-1858"></a><span class="c">! convert to a quaternion</span>
<a name="ln-1859"></a><span class="n">beta</span> <span class="o">=</span> <span class="n">defects</span><span class="p">%</span><span class="n">YD</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">beta</span>
<a name="ln-1860"></a><span class="n">a_di</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="o">/</span> <span class="nb">cos</span><span class="p">(</span><span class="n">beta</span><span class="p">),</span> <span class="nb">sin</span><span class="p">(</span><span class="n">beta</span><span class="p">),</span> <span class="mf">0.D0</span> <span class="o">/</span><span class="p">)</span>
<a name="ln-1861"></a><span class="n">a_di</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="o">/</span> <span class="o">-</span><span class="nb">sin</span><span class="p">(</span><span class="n">beta</span><span class="p">),</span> <span class="nb">cos</span><span class="p">(</span><span class="n">beta</span><span class="p">),</span> <span class="mf">0.D0</span> <span class="o">/</span><span class="p">)</span>
<a name="ln-1862"></a><span class="n">a_di</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="o">/</span> <span class="mf">0.D0</span><span class="p">,</span> <span class="mf">0.D0</span><span class="p">,</span> <span class="mf">1.D0</span> <span class="o">/</span><span class="p">)</span>
<a name="ln-1863"></a><span class="n">defects</span><span class="p">%</span><span class="n">YD</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">a_di</span> <span class="o">=</span> <span class="n">om2qu</span><span class="p">(</span><span class="n">a_di</span><span class="p">)</span>
<a name="ln-1864"></a><span class="n">defects</span><span class="p">%</span><span class="n">YD</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">a_id</span> <span class="o">=</span> <span class="nb">conjg</span><span class="p">(</span><span class="n">defects</span><span class="p">%</span><span class="n">YD</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">a_di</span><span class="p">)</span>
<a name="ln-1865"></a>
<a name="ln-1866"></a><span class="k">if</span> <span class="p">(</span><span class="n">dinfo</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span> <span class="k">then </span>
<a name="ln-1867"></a><span class="k">  write</span> <span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="s1">&#39;beta = &#39;</span><span class="p">,</span><span class="n">beta</span>
<a name="ln-1868"></a>  <span class="k">write</span> <span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="n">defects</span><span class="p">%</span><span class="n">YD</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">a_di</span>
<a name="ln-1869"></a>  <span class="k">write</span> <span class="p">(</span><span class="o">*</span><span class="p">,</span><span class="o">*</span><span class="p">)</span> <span class="n">defects</span><span class="p">%</span><span class="n">YD</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">a_id</span>
<a name="ln-1870"></a><span class="k">end if</span>
<a name="ln-1871"></a>
<a name="ln-1872"></a>
<a name="ln-1873"></a><span class="c">! finally some geometrical parameters needed for the displacement field computation...</span>
<a name="ln-1874"></a><span class="n">defects</span><span class="p">%</span><span class="n">YD</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">alpha</span> <span class="o">=</span>  <span class="n">alpha</span>
<a name="ln-1875"></a><span class="n">defects</span><span class="p">%</span><span class="n">YD</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">ca</span> <span class="o">=</span> <span class="nb">cos</span><span class="p">(</span><span class="n">alpha</span><span class="p">)</span>
<a name="ln-1876"></a><span class="n">defects</span><span class="p">%</span><span class="n">YD</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">sa</span> <span class="o">=</span> <span class="nb">sin</span><span class="p">(</span><span class="n">alpha</span><span class="p">)</span>
<a name="ln-1877"></a><span class="n">defects</span><span class="p">%</span><span class="n">YD</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">ta</span> <span class="o">=</span> <span class="nb">tan</span><span class="p">(</span><span class="n">alpha</span><span class="p">)</span>
<a name="ln-1878"></a><span class="n">defects</span><span class="p">%</span><span class="n">YD</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">cota</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">/</span><span class="n">defects</span><span class="p">%</span><span class="n">YD</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">ta</span>
<a name="ln-1879"></a>
<a name="ln-1880"></a><span class="c">! that&#39;s it! the rest is handled in the CalcR routine.</span>
<a name="ln-1881"></a>
<a name="ln-1882"></a><span class="k">end subroutine </span><span class="n">makeYSHdislocation</span>
<a name="ln-1883"></a>
<a name="ln-1884"></a>
<a name="ln-1885"></a>
<a name="ln-1886"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-1887"></a><span class="c">!</span>
<a name="ln-1888"></a><span class="c">! FUNCTION: InitializeEshelbyInclusion</span>
<a name="ln-1889"></a><span class="c">!</span>
<a name="ln-1890"></a><span class="c">!&gt; @author Marc De Graef, Carnegie Mellon University</span>
<a name="ln-1891"></a><span class="c">!</span>
<a name="ln-1892"></a><span class="c">!&gt; @brief pre-compute all parameters for an isotropic Eshelby ellipsoidal inclusion</span>
<a name="ln-1893"></a><span class="c">!</span>
<a name="ln-1894"></a><span class="c">!&gt; @details These parameters are then used in the CalcR routine.</span>
<a name="ln-1895"></a><span class="c">!&gt;</span>
<a name="ln-1896"></a><span class="c">!&gt; We implemented the Eshelby expressions based on Mura&#39;s 1987 book.</span>
<a name="ln-1897"></a><span class="c">!</span>
<a name="ln-1898"></a><span class="c">!&gt; @param cell unit cell pointer</span>
<a name="ln-1899"></a><span class="c">!&gt; @param defects defects structure</span>
<a name="ln-1900"></a><span class="c">!&gt; @param i dislocation number</span>
<a name="ln-1901"></a><span class="c">!&gt; @param dinfo triggers verbose output</span>
<a name="ln-1902"></a><span class="c">!&gt; @param L column edge length</span>
<a name="ln-1903"></a><span class="c">!</span>
<a name="ln-1904"></a><span class="c">!&gt; @date 12/11/15 MDG 1.0 initial version based on trial IDL script</span>
<a name="ln-1905"></a><span class="c">!&gt; @date 12/13/15 MDG 1.1 corrections to some of the auxiliary expressions; sphere limit is now correct</span>
<a name="ln-1906"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-1907"></a><span class="k">recursive subroutine </span><span class="n">InitializeEshelbyInclusion</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span><span class="n">defects</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">dinfo</span><span class="p">,</span><span class="n">L</span><span class="p">,</span><span class="n">npix</span><span class="p">,</span><span class="n">npiy</span><span class="p">)</span>    
<a name="ln-1908"></a><span class="c">!DEC$ ATTRIBUTES DLLEXPORT :: InitalizeEshelbyInclusion</span>
<a name="ln-1909"></a>
<a name="ln-1910"></a><span class="k">use </span><span class="n">local</span>
<a name="ln-1911"></a><span class="k">use </span><span class="n">constants</span>
<a name="ln-1912"></a><span class="k">use </span><span class="n">typedefs</span>
<a name="ln-1913"></a><span class="k">use </span><span class="n">math</span>
<a name="ln-1914"></a>
<a name="ln-1915"></a><span class="k">IMPLICIT NONE</span>
<a name="ln-1916"></a>
<a name="ln-1917"></a><span class="k">type</span><span class="p">(</span><span class="n">unitcell</span><span class="p">),</span><span class="k">pointer</span>              <span class="kd">::</span> <span class="n">cell</span>
<a name="ln-1918"></a><span class="k">type</span><span class="p">(</span><span class="n">defecttype</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">INOUT</span><span class="p">)</span>      <span class="kd">::</span> <span class="n">defects</span>
<a name="ln-1919"></a><span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">irg</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>        <span class="kd">::</span> <span class="n">i</span>
<a name="ln-1920"></a><span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">irg</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>        <span class="kd">::</span> <span class="n">dinfo</span>
<a name="ln-1921"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>           <span class="kd">::</span> <span class="n">L</span>
<a name="ln-1922"></a><span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">irg</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>        <span class="kd">::</span> <span class="n">npix</span>
<a name="ln-1923"></a><span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">irg</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>        <span class="kd">::</span> <span class="n">npiy</span>
<a name="ln-1924"></a>
<a name="ln-1925"></a><span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">irg</span><span class="p">)</span>                   <span class="kd">::</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">ll</span><span class="p">,</span> <span class="n">ii</span>
<a name="ln-1926"></a><span class="kt">complex</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">dbl</span><span class="p">)</span>                   <span class="kd">::</span> <span class="n">t</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">q</span>
<a name="ln-1927"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">dbl</span><span class="p">)</span>                      <span class="kd">::</span> <span class="n">rsq</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">modt</span><span class="p">,</span> <span class="n">lambda</span><span class="p">,</span> <span class="n">II1</span><span class="p">,</span> <span class="n">II3</span><span class="p">,</span> <span class="n">EF</span><span class="p">,</span> <span class="n">EE</span><span class="p">,</span> <span class="n">Delta</span><span class="p">,</span> <span class="n">dth</span>
<a name="ln-1928"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">dbl</span><span class="p">)</span>                      <span class="kd">::</span> <span class="n">r2</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">IIinside</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">IIJinside</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">maxr</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">ES</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">ESV</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span>
<a name="ln-1929"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">dbl</span><span class="p">),</span><span class="k">allocatable</span>          <span class="kd">::</span> <span class="n">z</span><span class="p">(:)</span>
<a name="ln-1930"></a>
<a name="ln-1931"></a><span class="c">! set the size of the elliptic integral lookup tables</span>
<a name="ln-1932"></a><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">nLUT</span> <span class="o">=</span> <span class="mi">500</span>
<a name="ln-1933"></a>
<a name="ln-1934"></a><span class="c">! copy the defect position</span>
<a name="ln-1935"></a><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">xpos</span> <span class="o">=</span> <span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">xyz</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="nb">float</span><span class="p">(</span><span class="n">npix</span><span class="p">)</span>
<a name="ln-1936"></a><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">ypos</span> <span class="o">=</span> <span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">xyz</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="nb">float</span><span class="p">(</span><span class="n">npiy</span><span class="p">)</span>
<a name="ln-1937"></a><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">zpos</span> <span class="o">=</span> <span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">xyz</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="n">defects</span><span class="p">%</span><span class="n">foil</span><span class="p">%</span><span class="n">z0</span>
<a name="ln-1938"></a>
<a name="ln-1939"></a><span class="c">! copy the semi-axis into the individual variables</span>
<a name="ln-1940"></a><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">a1</span> <span class="o">=</span> <span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">a123</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-1941"></a><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">a2</span> <span class="o">=</span> <span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">a123</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<a name="ln-1942"></a><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">a3</span> <span class="o">=</span> <span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">a123</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-1943"></a>
<a name="ln-1944"></a><span class="c">! rearrange the ellipsoid semi-axes from largest to smallest and initialize the </span>
<a name="ln-1945"></a><span class="c">! corresponding permutation matrix as well as the rotation matrix based on the </span>
<a name="ln-1946"></a><span class="c">! eigenvectors...</span>
<a name="ln-1947"></a><span class="c">! to be implemented</span>
<a name="ln-1948"></a>
<a name="ln-1949"></a><span class="c">! determine the maximum vector length for the computation of theta(lambda)</span>
<a name="ln-1950"></a><span class="n">maxr</span> <span class="o">=</span> <span class="p">(</span><span class="o">/</span> <span class="mi">51</span><span class="mf">2.D0</span><span class="p">,</span> <span class="mi">51</span><span class="mf">2.D0</span><span class="p">,</span> <span class="mi">10</span><span class="mf">0.D0</span> <span class="o">/</span><span class="p">)</span>
<a name="ln-1951"></a><span class="c">! to be corrected ...</span>
<a name="ln-1952"></a>
<a name="ln-1953"></a><span class="c">! elastic parameters</span>
<a name="ln-1954"></a><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">omnu</span> <span class="o">=</span> <span class="mf">1.D0</span><span class="o">-</span><span class="mf">2.D0</span><span class="o">*</span><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">nu</span>
<a name="ln-1955"></a><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">pre</span> <span class="o">=</span> <span class="mf">1.D0</span><span class="o">/</span><span class="p">(</span><span class="mf">8.D0</span><span class="o">*</span><span class="n">cPi</span><span class="o">*</span><span class="p">(</span><span class="mf">1.D0</span><span class="o">-</span><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">nu</span><span class="p">))</span>
<a name="ln-1956"></a>
<a name="ln-1957"></a><span class="c">! volume</span>
<a name="ln-1958"></a><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">V</span> <span class="o">=</span> <span class="mf">4.D0</span><span class="o">*</span><span class="n">cPi</span><span class="o">*</span><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">a1</span><span class="o">*</span><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">a2</span><span class="o">*</span><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">a3</span><span class="o">/</span><span class="mf">3.D0</span>
<a name="ln-1959"></a>
<a name="ln-1960"></a><span class="c">! and some other derived constants</span>
<a name="ln-1961"></a><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">a12</span> <span class="o">=</span> <span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">a1</span><span class="o">**</span><span class="mi">2</span>
<a name="ln-1962"></a><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">a22</span> <span class="o">=</span> <span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">a2</span><span class="o">**</span><span class="mi">2</span>
<a name="ln-1963"></a><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">a32</span> <span class="o">=</span> <span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">a3</span><span class="o">**</span><span class="mi">2</span>
<a name="ln-1964"></a><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">asq</span> <span class="o">=</span> <span class="p">(</span><span class="o">/</span> <span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">a12</span><span class="p">,</span> <span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">a22</span><span class="p">,</span> <span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">a32</span> <span class="o">/</span><span class="p">)</span>
<a name="ln-1965"></a><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">eta</span> <span class="o">=</span> <span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">a12</span><span class="o">+</span><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">a22</span><span class="o">+</span><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">a32</span>
<a name="ln-1966"></a>
<a name="ln-1967"></a><span class="c">! used in s variable (to compute lambda)</span>
<a name="ln-1968"></a><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">ss1</span>  <span class="o">=</span> <span class="mf">3.D0</span><span class="o">*</span><span class="p">(</span><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">a12</span><span class="o">*</span><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">a22</span> <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-1969"></a>                                    <span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">a22</span><span class="o">*</span><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">a32</span> <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-1970"></a>                                    <span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">a32</span><span class="o">*</span><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">a12</span><span class="p">)</span>
<a name="ln-1971"></a><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">svec</span> <span class="o">=</span> <span class="mf">3.D0</span><span class="o">*</span><span class="p">(</span><span class="o">/</span> <span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">eta</span><span class="o">-</span><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">a12</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-1972"></a>                                    <span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">eta</span><span class="o">-</span><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">a22</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-1973"></a>                                    <span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">eta</span><span class="o">-</span><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">a32</span> <span class="o">/</span><span class="p">)</span>
<a name="ln-1974"></a>
<a name="ln-1975"></a><span class="c">! used in q variable (to compute lambda)</span>
<a name="ln-1976"></a><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">qs1</span> <span class="o">=</span> <span class="p">(</span><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">eta</span><span class="o">-</span><span class="mf">3.D0</span><span class="o">*</span><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">a12</span><span class="p">)</span><span class="o">*</span> <span class="p">&amp;</span>
<a name="ln-1977"></a>                             <span class="p">(</span><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">eta</span><span class="o">-</span><span class="mf">3.D0</span><span class="o">*</span><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">a22</span><span class="p">)</span><span class="o">*</span> <span class="p">&amp;</span>
<a name="ln-1978"></a>                             <span class="p">(</span><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">eta</span><span class="o">-</span><span class="mf">3.D0</span><span class="o">*</span><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">a32</span><span class="p">)</span>
<a name="ln-1979"></a><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">qvec1</span> <span class="o">=</span> <span class="mf">9.D0</span><span class="o">*</span><span class="p">(</span><span class="o">/</span><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">a12</span><span class="p">,</span> <span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">a22</span><span class="p">,</span> <span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">a32</span><span class="o">/</span><span class="p">)</span>
<a name="ln-1980"></a><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">qvec2</span> <span class="o">=</span> <span class="mf">9.D0</span><span class="o">*</span><span class="p">(</span><span class="o">/</span><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">a12</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="mf">2.D0</span><span class="o">*</span><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">a22</span><span class="o">*</span><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">a32</span><span class="p">,&amp;</span>
<a name="ln-1981"></a>                                      <span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">a22</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="mf">2.D0</span><span class="o">*</span><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">a12</span><span class="o">*</span><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">a32</span><span class="p">,&amp;</span>
<a name="ln-1982"></a>                                      <span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">a32</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="mf">2.D0</span><span class="o">*</span><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">a12</span><span class="o">*</span><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">a22</span><span class="o">/</span><span class="p">)</span>
<a name="ln-1983"></a>
<a name="ln-1984"></a><span class="c">! Delta matrix  (we&#39;ll symmetrize it)</span>
<a name="ln-1985"></a><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">Deltaij</span>  <span class="o">=</span> <span class="mf">0.D0</span>
<a name="ln-1986"></a><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">Deltaij</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">a12</span><span class="o">-</span><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">a22</span>
<a name="ln-1987"></a><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">Deltaij</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">a12</span><span class="o">-</span><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">a32</span>
<a name="ln-1988"></a><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">Deltaij</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">a22</span><span class="o">-</span><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">a32</span>
<a name="ln-1989"></a><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">Deltaij</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">Deltaij</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
<a name="ln-1990"></a><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">Deltaij</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">Deltaij</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-1991"></a><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">Deltaij</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">Deltaij</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-1992"></a><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">Deltaij</span> <span class="o">=</span> <span class="nb">dsqrt</span><span class="p">(</span><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">Deltaij</span><span class="p">)</span>
<a name="ln-1993"></a>
<a name="ln-1994"></a><span class="c">! second argument of Elliptic functions</span>
<a name="ln-1995"></a><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">kEl</span> <span class="o">=</span> <span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">Deltaij</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">Deltaij</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-1996"></a>
<a name="ln-1997"></a><span class="c">! some other prefactors</span>
<a name="ln-1998"></a><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">preI1</span> <span class="o">=</span> <span class="mf">3.D0</span><span class="o">*</span> <span class="p">&amp;</span>
<a name="ln-1999"></a>                        <span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">V</span><span class="o">/</span><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">Deltaij</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">Deltaij</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-2000"></a><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">preI3</span> <span class="o">=</span> <span class="mf">3.D0</span><span class="o">*</span> <span class="p">&amp;</span>
<a name="ln-2001"></a>                        <span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">V</span><span class="o">/</span><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">Deltaij</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">Deltaij</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-2002"></a>
<a name="ln-2003"></a><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">s3</span> <span class="o">=</span> <span class="nb">dsqrt</span><span class="p">(</span><span class="mf">3.D0</span><span class="p">)</span>
<a name="ln-2004"></a><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">c1</span> <span class="o">=</span> <span class="mf">2.D0</span><span class="o">**</span><span class="p">(</span><span class="mf">1.D0</span><span class="o">/</span><span class="mf">3.D0</span><span class="p">)</span>
<a name="ln-2005"></a><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">c2</span> <span class="o">=</span> <span class="mf">6.D0</span><span class="o">*</span><span class="mf">2.D0</span><span class="o">**</span><span class="p">(</span><span class="mf">2.D0</span><span class="o">/</span><span class="mf">3.D0</span><span class="p">)</span>
<a name="ln-2006"></a>
<a name="ln-2007"></a><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">math</span> <span class="o">=</span> <span class="nb">dasin</span><span class="p">(</span><span class="nb">dsqrt</span><span class="p">(</span><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">Deltaij</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">a12</span><span class="p">))</span>
<a name="ln-2008"></a>
<a name="ln-2009"></a><span class="c">! next we need the largest possible lambda value; we&#39;ll have the user pass in the coordinates of the furthest point</span>
<a name="ln-2010"></a><span class="n">r2</span> <span class="o">=</span> <span class="n">maxr</span><span class="o">**</span><span class="mi">2</span>
<a name="ln-2011"></a><span class="n">rsq</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">r2</span><span class="p">)</span>
<a name="ln-2012"></a><span class="n">s</span> <span class="o">=</span> <span class="n">dcmplx</span><span class="p">(</span> <span class="p">(</span><span class="n">rsq</span> <span class="o">-</span> <span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">eta</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="nb">sum</span><span class="p">(</span><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">svec</span><span class="o">*</span><span class="n">r2</span><span class="p">)</span><span class="o">-</span><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">ss1</span><span class="p">,</span> <span class="mf">0.D0</span> <span class="p">)</span>
<a name="ln-2013"></a><span class="n">q</span> <span class="o">=</span> <span class="n">dcmplx</span><span class="p">(</span> <span class="o">-</span><span class="mf">2.D0</span><span class="o">*</span><span class="n">rsq</span><span class="o">**</span><span class="mi">3</span> <span class="o">-</span> <span class="mf">3.D0</span><span class="o">*</span><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">eta</span><span class="o">*</span><span class="n">rsq</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">rsq</span><span class="o">*</span><span class="p">(</span><span class="mf">3.D0</span><span class="o">*</span><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">eta</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-2014"></a>          <span class="nb">sum</span><span class="p">(</span><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">qvec1</span><span class="o">*</span><span class="n">r2</span><span class="p">))</span><span class="o">-</span><span class="nb">sum</span><span class="p">(</span><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">qvec2</span><span class="o">*</span><span class="n">r2</span><span class="p">)</span><span class="o">-</span><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">qs1</span><span class="p">,</span> <span class="mf">0.D0</span> <span class="p">)</span>
<a name="ln-2015"></a><span class="n">t</span> <span class="o">=</span> <span class="p">(</span><span class="n">q</span> <span class="o">+</span> <span class="nb">sqrt</span><span class="p">(</span> <span class="n">q</span><span class="o">*</span><span class="n">q</span> <span class="o">-</span> <span class="mf">4.D0</span><span class="o">*</span><span class="n">s</span><span class="o">*</span><span class="n">s</span><span class="o">*</span><span class="n">s</span><span class="p">)</span> <span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="mf">1.D0</span><span class="o">/</span><span class="mf">3.D0</span><span class="p">)</span>
<a name="ln-2016"></a><span class="n">v</span> <span class="o">=</span> <span class="kt">real</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
<a name="ln-2017"></a><span class="n">w</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="nb">imag</span><span class="p">(</span><span class="n">t</span><span class="p">))</span>
<a name="ln-2018"></a><span class="n">modt</span> <span class="o">=</span> <span class="n">v</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">w</span><span class="o">**</span><span class="mi">2</span>
<a name="ln-2019"></a><span class="n">lambda</span> <span class="o">=</span> <span class="p">(</span><span class="n">rsq</span><span class="o">-</span><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">eta</span><span class="p">)</span><span class="o">/</span><span class="mf">3.D0</span> <span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-2020"></a>         <span class="p">(</span><span class="n">v</span><span class="o">+</span><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">s3</span><span class="o">*</span><span class="n">w</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mf">2.D0</span><span class="o">*</span><span class="kt">real</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">+</span><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">c1</span><span class="o">*</span><span class="n">modt</span><span class="p">)</span><span class="o">/</span><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">c2</span><span class="o">/</span><span class="n">modt</span>
<a name="ln-2021"></a>
<a name="ln-2022"></a><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">mith</span> <span class="o">=</span> <span class="nb">dasin</span><span class="p">(</span><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">Deltaij</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">/</span><span class="nb">dsqrt</span><span class="p">(</span><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">a12</span><span class="o">+</span><span class="n">lambda</span><span class="p">))</span>
<a name="ln-2023"></a>
<a name="ln-2024"></a><span class="c">! pre-compute the look-up tables for the elliptic integrals</span>
<a name="ln-2025"></a><span class="k">allocate</span><span class="p">(</span><span class="n">z</span><span class="p">(</span><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">nLUT</span><span class="p">))</span>
<a name="ln-2026"></a><span class="n">dth</span> <span class="o">=</span> <span class="p">(</span><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">math</span><span class="o">-</span><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">mith</span><span class="p">)</span><span class="o">/</span><span class="nb">dble</span><span class="p">(</span><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">nLUT</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-2027"></a>
<a name="ln-2028"></a><span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">nLUT</span>
<a name="ln-2029"></a>  <span class="n">z</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="o">=</span> <span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">mith</span> <span class="o">+</span> <span class="nb">dble</span><span class="p">(</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">dth</span>
<a name="ln-2030"></a><span class="k">end do</span>
<a name="ln-2031"></a>
<a name="ln-2032"></a><span class="k">allocate</span><span class="p">(</span><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">EFLUT</span><span class="p">(</span><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">nLUT</span><span class="p">))</span>
<a name="ln-2033"></a><span class="k">allocate</span><span class="p">(</span><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">EELUT</span><span class="p">(</span><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">nLUT</span><span class="p">))</span>
<a name="ln-2034"></a>
<a name="ln-2035"></a><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">EFLUT</span> <span class="o">=</span> <span class="mf">0.D0</span>
<a name="ln-2036"></a><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">EELUT</span> <span class="o">=</span> <span class="mf">0.D0</span>
<a name="ln-2037"></a><span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">nLUT</span>  
<a name="ln-2038"></a>  <span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">EFLUT</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="o">=</span> <span class="n">el1k</span><span class="p">(</span><span class="n">z</span><span class="p">(</span><span class="n">j</span><span class="p">),</span><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">kEl</span><span class="p">)</span>
<a name="ln-2039"></a>  <span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">EELUT</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="o">=</span> <span class="n">el2k</span><span class="p">(</span><span class="n">z</span><span class="p">(</span><span class="n">j</span><span class="p">),</span><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">kEl</span><span class="p">)</span>
<a name="ln-2040"></a><span class="k">end do</span>
<a name="ln-2041"></a><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">thpre</span> <span class="o">=</span> <span class="nb">dble</span><span class="p">(</span><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">nLUT</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">math</span><span class="o">-</span><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">mith</span><span class="p">)</span>
<a name="ln-2042"></a><span class="k">deallocate</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
<a name="ln-2043"></a>
<a name="ln-2044"></a><span class="c">! also, when lambda=0 (inside the ellipsoid), we can simplify things a little</span>
<a name="ln-2045"></a><span class="c">! by using precomputed II and IIJ arrays; in that case we use math to compute</span>
<a name="ln-2046"></a><span class="c">! the integrals</span>
<a name="ln-2047"></a><span class="n">EF</span> <span class="o">=</span> <span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">EFLUT</span><span class="p">(</span><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">nLUT</span><span class="p">)</span>
<a name="ln-2048"></a><span class="n">EE</span> <span class="o">=</span> <span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">EELUT</span><span class="p">(</span><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">nLUT</span><span class="p">)</span>
<a name="ln-2049"></a><span class="n">Delta</span> <span class="o">=</span> <span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">a1</span><span class="o">*</span><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">a2</span><span class="o">*</span><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">a3</span>
<a name="ln-2050"></a>
<a name="ln-2051"></a><span class="c">! first order integrals</span>
<a name="ln-2052"></a><span class="n">II1</span> <span class="o">=</span> <span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">preI1</span> <span class="o">*</span> <span class="p">(</span> <span class="n">EF</span> <span class="o">-</span> <span class="n">EE</span> <span class="p">)</span>
<a name="ln-2053"></a><span class="n">II3</span> <span class="o">=</span> <span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">preI3</span> <span class="o">*</span> <span class="p">(</span> <span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">Deltaij</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">a22</span><span class="o">/</span><span class="n">Delta</span> <span class="o">-</span> <span class="n">EE</span> <span class="p">)</span>
<a name="ln-2054"></a><span class="n">IIinside</span> <span class="o">=</span> <span class="p">(</span><span class="o">/</span> <span class="n">II1</span><span class="p">,</span> <span class="mf">3.D0</span><span class="o">*</span><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">V</span><span class="o">/</span><span class="n">Delta</span> <span class="o">-</span> <span class="n">II1</span> <span class="o">-</span> <span class="n">II3</span><span class="p">,</span> <span class="n">II3</span> <span class="o">/</span><span class="p">)</span>
<a name="ln-2055"></a><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">IIinside</span> <span class="o">=</span> <span class="n">IIinside</span>
<a name="ln-2056"></a>
<a name="ln-2057"></a><span class="c">! second order integrals</span>
<a name="ln-2058"></a><span class="n">IIJinside</span> <span class="o">=</span> <span class="mf">0.D0</span>
<a name="ln-2059"></a><span class="n">IIJinside</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">IIinside</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">IIinside</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span><span class="o">/</span><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">Deltaij</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
<a name="ln-2060"></a><span class="n">IIJinside</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">IIJinside</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
<a name="ln-2061"></a><span class="n">IIJinside</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">IIinside</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">IIinside</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span><span class="o">/</span><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">Deltaij</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
<a name="ln-2062"></a><span class="n">IIJinside</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">IIJinside</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-2063"></a><span class="n">IIJinside</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">IIinside</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">-</span><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">IIinside</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span><span class="o">/</span><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">Deltaij</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
<a name="ln-2064"></a><span class="n">IIJinside</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">IIJinside</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-2065"></a><span class="n">IIJinside</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">V</span><span class="o">/</span><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">a12</span><span class="o">/</span><span class="n">Delta</span> <span class="o">-</span> <span class="p">(</span><span class="n">IIJinside</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="n">IIJinside</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span><span class="o">/</span><span class="mf">3.D0</span>
<a name="ln-2066"></a><span class="n">IIJinside</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">V</span><span class="o">/</span><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">a22</span><span class="o">/</span><span class="n">Delta</span> <span class="o">-</span> <span class="p">(</span><span class="n">IIJinside</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="n">IIJinside</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span><span class="o">/</span><span class="mf">3.D0</span>
<a name="ln-2067"></a><span class="n">IIJinside</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">V</span><span class="o">/</span><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">a32</span><span class="o">/</span><span class="n">Delta</span> <span class="o">-</span> <span class="p">(</span><span class="n">IIJinside</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="n">IIJinside</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span><span class="o">/</span><span class="mf">3.D0</span>
<a name="ln-2068"></a><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">IIJinside</span> <span class="o">=</span> <span class="n">IIJinside</span>
<a name="ln-2069"></a>
<a name="ln-2070"></a><span class="c">! and finally the Eshelby S tensor for inside the inclusion (i.e., lambda=0)</span>
<a name="ln-2071"></a><span class="n">ES</span> <span class="o">=</span> <span class="mf">0.D0</span>
<a name="ln-2072"></a><span class="k">do </span><span class="n">ii</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span>
<a name="ln-2073"></a> <span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span>
<a name="ln-2074"></a>  <span class="k">do </span><span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span>
<a name="ln-2075"></a>   <span class="k">do </span><span class="n">ll</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span>
<a name="ln-2076"></a>    <span class="n">Es</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">ll</span><span class="p">)</span> <span class="o">=</span> <span class="n">kdelta</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span><span class="n">j</span><span class="p">)</span><span class="o">*</span><span class="n">kdelta</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">ll</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mf">2.D0</span><span class="o">*</span><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">nu</span> <span class="o">*</span> <span class="n">IIinside</span><span class="p">(</span><span class="n">ii</span><span class="p">)</span><span class="o">-</span><span class="n">IIinside</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-2077"></a>                   <span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">a123</span><span class="p">(</span><span class="n">ii</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">IIJinside</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">ii</span><span class="p">))</span> <span class="o">+</span> <span class="p">(</span><span class="n">kdelta</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">kdelta</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">ll</span><span class="p">)</span><span class="o">+</span><span class="n">kdelta</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">kdelta</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span><span class="n">ll</span><span class="p">))</span> <span class="o">*</span> <span class="p">&amp;</span>
<a name="ln-2078"></a>                   <span class="p">(</span><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">a123</span><span class="p">(</span><span class="n">ii</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">IIJinside</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span><span class="n">j</span><span class="p">)</span><span class="o">-</span><span class="n">IIinside</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="mf">1.D0</span><span class="o">-</span><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">nu</span><span class="p">)</span><span class="o">*</span><span class="p">&amp;</span>
<a name="ln-2079"></a>                   <span class="p">(</span><span class="n">IIinside</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">+</span><span class="n">IIinside</span><span class="p">(</span><span class="n">ll</span><span class="p">)))</span>
<a name="ln-2080"></a>   <span class="k">end do</span>
<a name="ln-2081"></a><span class="k">  end do</span>
<a name="ln-2082"></a><span class="k"> end do                   </span>
<a name="ln-2083"></a><span class="k">end do</span>
<a name="ln-2084"></a>
<a name="ln-2085"></a><span class="n">ES</span> <span class="o">=</span> <span class="n">ES</span><span class="o">/</span><span class="p">(</span><span class="mf">8.0</span><span class="o">*</span><span class="n">cPi</span><span class="o">*</span><span class="p">(</span><span class="mf">1.D0</span><span class="o">-</span><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">nu</span><span class="p">))</span>
<a name="ln-2086"></a>
<a name="ln-2087"></a><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">EshelbyS</span> <span class="o">=</span> <span class="n">ES</span>
<a name="ln-2088"></a>
<a name="ln-2089"></a><span class="c">! convert this tensor to Voigt notation as a 6x6 matrix</span>
<a name="ln-2090"></a><span class="n">ESV</span> <span class="o">=</span> <span class="mf">0.D0</span>
<a name="ln-2091"></a><span class="n">ESV</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">ES</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-2092"></a><span class="n">ESV</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">ES</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
<a name="ln-2093"></a><span class="n">ESV</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">ES</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-2094"></a>
<a name="ln-2095"></a>
<a name="ln-2096"></a><span class="n">ESV</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="n">ES</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-2097"></a><span class="n">ESV</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="n">ES</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-2098"></a><span class="n">ESV</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span> <span class="o">=</span> <span class="n">ES</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
<a name="ln-2099"></a>
<a name="ln-2100"></a><span class="n">ESV</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">ES</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
<a name="ln-2101"></a><span class="n">ESV</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">ES</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-2102"></a>
<a name="ln-2103"></a><span class="n">ESV</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">ES</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-2104"></a><span class="n">ESV</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">ES</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-2105"></a>
<a name="ln-2106"></a><span class="n">ESV</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">ES</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
<a name="ln-2107"></a><span class="n">ESV</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">ES</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-2108"></a>
<a name="ln-2109"></a><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">ESV</span> <span class="o">=</span> <span class="n">ESV</span>
<a name="ln-2110"></a>
<a name="ln-2111"></a><span class="k">end subroutine </span><span class="n">InitializeEshelbyInclusion</span>
<a name="ln-2112"></a>
<a name="ln-2113"></a>
<a name="ln-2114"></a>
<a name="ln-2115"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-2116"></a><span class="c">!</span>
<a name="ln-2117"></a><span class="c">! FUNCTION: Eshelby_disp</span>
<a name="ln-2118"></a><span class="c">!</span>
<a name="ln-2119"></a><span class="c">!&gt; @author Marc De Graef, Carnegie Mellon University</span>
<a name="ln-2120"></a><span class="c">!</span>
<a name="ln-2121"></a><span class="c">!&gt; @brief compute the actual displacement vector for an isotropic Eshelby ellipsoidal inclusion</span>
<a name="ln-2122"></a><span class="c">!</span>
<a name="ln-2123"></a><span class="c">!&gt; We implemented the Eshelby expressions based on Mura&#39;s 1987 book.</span>
<a name="ln-2124"></a><span class="c">!</span>
<a name="ln-2125"></a><span class="c">!&gt; @param defects defects structure</span>
<a name="ln-2126"></a><span class="c">!&gt; @param i Einclusion number</span>
<a name="ln-2127"></a><span class="c">!&gt; @param xyz coordinate triplet</span>
<a name="ln-2128"></a><span class="c">!</span>
<a name="ln-2129"></a><span class="c">!&gt; @date 12/11/15 MDG 1.0 initial version based on trial IDL script</span>
<a name="ln-2130"></a><span class="c">!&gt; @date 12/13/15 MDG 1.1 corrections to some of the auxiliary expressions; sphere limit is now correct</span>
<a name="ln-2131"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-2132"></a><span class="k">recursive function </span><span class="n">Eshelby_disp</span><span class="p">(</span><span class="n">defects</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">xyz</span><span class="p">)</span> <span class="k">result</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
<a name="ln-2133"></a><span class="c">!DEC$ ATTRIBUTES DLLEXPORT :: Eshelby_disp</span>
<a name="ln-2134"></a><span class="c">! </span>
<a name="ln-2135"></a><span class="c">! implement the displacement field equations for an isotropic ellipsoidal inclusion</span>
<a name="ln-2136"></a><span class="c">!</span>
<a name="ln-2137"></a>
<a name="ln-2138"></a><span class="k">use </span><span class="n">local</span>
<a name="ln-2139"></a><span class="k">use </span><span class="n">math</span>
<a name="ln-2140"></a>
<a name="ln-2141"></a><span class="k">IMPLICIT NONE</span>
<a name="ln-2142"></a>
<a name="ln-2143"></a><span class="k">type</span><span class="p">(</span><span class="n">defecttype</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>     <span class="kd">::</span> <span class="n">defects</span>
<a name="ln-2144"></a><span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">irg</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>    <span class="kd">::</span> <span class="n">i</span>
<a name="ln-2145"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">dbl</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>       <span class="kd">::</span> <span class="n">xyz</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-2146"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">dbl</span><span class="p">)</span>                  <span class="kd">::</span> <span class="n">u</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-2147"></a>
<a name="ln-2148"></a><span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">irg</span><span class="p">)</span>               <span class="kd">::</span> <span class="n">itheta</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">k</span>
<a name="ln-2149"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">dbl</span><span class="p">)</span>                  <span class="kd">::</span> <span class="n">Treps</span><span class="p">,</span> <span class="n">r2</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">rsq</span><span class="p">,</span> <span class="n">dd</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">modt</span><span class="p">,</span> <span class="n">lambda</span><span class="p">,</span> <span class="n">xx</span><span class="p">,</span> <span class="n">thetaEl</span><span class="p">,</span> <span class="n">dtheta</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="p">&amp;</span>
<a name="ln-2150"></a>                                   <span class="n">II1</span><span class="p">,</span> <span class="n">II3</span><span class="p">,</span> <span class="n">II</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">IIJ</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">phici</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">psicjli</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">c</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">dt</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">Delta</span><span class="p">,</span> <span class="n">EE</span><span class="p">,</span> <span class="n">EF</span>
<a name="ln-2151"></a><span class="kt">complex</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">dbl</span><span class="p">)</span>               <span class="kd">::</span> <span class="n">t</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">q</span>
<a name="ln-2152"></a>
<a name="ln-2153"></a><span class="n">Treps</span> <span class="o">=</span> <span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">epsstar</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">epsstar</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">epsstar</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-2154"></a>
<a name="ln-2155"></a><span class="n">r2</span> <span class="o">=</span> <span class="n">xyz</span><span class="o">**</span><span class="mi">2</span> 
<a name="ln-2156"></a><span class="n">rsq</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">r2</span><span class="p">)</span>
<a name="ln-2157"></a><span class="n">dd</span> <span class="o">=</span> <span class="nb">dsqrt</span><span class="p">(</span><span class="n">xyz</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">a12</span><span class="o">+</span><span class="n">xyz</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">a22</span><span class="o">+</span><span class="n">xyz</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">a32</span><span class="p">)</span>
<a name="ln-2158"></a>
<a name="ln-2159"></a><span class="c">!  first we need the lambda value for this point</span>
<a name="ln-2160"></a><span class="n">lambda</span> <span class="o">=</span> <span class="mf">0.D0</span>
<a name="ln-2161"></a><span class="k">if</span> <span class="p">(</span><span class="n">dd</span><span class="p">.</span><span class="n">gt</span><span class="p">.</span><span class="mf">1.D0</span><span class="p">)</span> <span class="k">then </span>
<a name="ln-2162"></a><span class="k">  </span><span class="n">s</span> <span class="o">=</span> <span class="n">dcmplx</span><span class="p">(</span> <span class="p">(</span><span class="n">rsq</span> <span class="o">-</span> <span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">eta</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span><span class="nb">sum</span><span class="p">(</span><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">svec</span><span class="o">*</span><span class="n">r2</span><span class="p">)</span><span class="o">-</span><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">ss1</span><span class="p">,</span> <span class="mf">0.D0</span> <span class="p">)</span>
<a name="ln-2163"></a>  <span class="n">q</span> <span class="o">=</span> <span class="n">dcmplx</span><span class="p">(</span> <span class="o">-</span><span class="mf">2.D0</span><span class="o">*</span><span class="n">rsq</span><span class="o">**</span><span class="mi">3</span> <span class="o">-</span> <span class="mf">3.D0</span><span class="o">*</span><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">eta</span><span class="o">*</span><span class="n">rsq</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">rsq</span><span class="o">*</span><span class="p">(</span><span class="mf">3.D0</span><span class="o">*</span><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">eta</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span> <span class="p">&amp;</span>
<a name="ln-2164"></a>      <span class="nb">sum</span><span class="p">(</span><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">qvec1</span><span class="o">*</span><span class="n">r2</span><span class="p">))</span><span class="o">-</span><span class="nb">sum</span><span class="p">(</span><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">qvec2</span><span class="o">*</span><span class="n">r2</span><span class="p">)</span><span class="o">-</span><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">qs1</span><span class="p">,</span> <span class="mf">0.D0</span> <span class="p">)</span>
<a name="ln-2165"></a>  <span class="n">t</span> <span class="o">=</span> <span class="p">(</span><span class="n">q</span> <span class="o">+</span> <span class="nb">sqrt</span><span class="p">(</span> <span class="n">q</span><span class="o">*</span><span class="n">q</span> <span class="o">-</span> <span class="mf">4.D0</span><span class="o">*</span><span class="n">s</span><span class="o">*</span><span class="n">s</span><span class="o">*</span><span class="n">s</span><span class="p">)</span> <span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="mf">1.D0</span><span class="o">/</span><span class="mf">3.D0</span><span class="p">)</span>
<a name="ln-2166"></a>  <span class="n">v</span> <span class="o">=</span> <span class="kt">real</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
<a name="ln-2167"></a>  <span class="n">w</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="nb">imag</span><span class="p">(</span><span class="n">t</span><span class="p">))</span>
<a name="ln-2168"></a>  <span class="n">modt</span> <span class="o">=</span> <span class="n">v</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">w</span><span class="o">**</span><span class="mi">2</span>
<a name="ln-2169"></a>  <span class="n">lambda</span> <span class="o">=</span> <span class="p">(</span><span class="n">rsq</span><span class="o">-</span><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">eta</span><span class="p">)</span><span class="o">/</span><span class="mf">3.D0</span> <span class="o">+</span> <span class="p">(</span><span class="n">v</span><span class="o">+</span><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">s3</span><span class="o">*</span><span class="n">w</span><span class="p">)</span><span class="o">*</span> <span class="p">&amp;</span>
<a name="ln-2170"></a>           <span class="p">(</span><span class="mf">2.D0</span><span class="o">*</span><span class="kt">real</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">+</span><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">c1</span><span class="o">*</span><span class="n">modt</span><span class="p">)</span><span class="o">/</span><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">c2</span><span class="o">/</span><span class="n">modt</span>
<a name="ln-2171"></a><span class="k">end if</span>
<a name="ln-2172"></a>
<a name="ln-2173"></a>
<a name="ln-2174"></a><span class="c">! predefine a couple of parameters</span>
<a name="ln-2175"></a><span class="n">dt</span> <span class="o">=</span> <span class="p">(</span><span class="o">/</span> <span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">a12</span><span class="p">,</span> <span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">a22</span><span class="p">,</span> <span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">a32</span> <span class="o">/</span><span class="p">)</span> <span class="o">+</span> <span class="n">lambda</span>
<a name="ln-2176"></a><span class="n">Delta</span> <span class="o">=</span> <span class="nb">dsqrt</span><span class="p">(</span><span class="n">dt</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">dt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">dt</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
<a name="ln-2177"></a>
<a name="ln-2178"></a>
<a name="ln-2179"></a><span class="k">if</span> <span class="p">(</span><span class="n">lambda</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="mf">0.D0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-2180"></a><span class="c">! next, we compute the elliptic integrals by interpolating the look-up tables</span>
<a name="ln-2181"></a>  <span class="n">thetaEl</span> <span class="o">=</span> <span class="nb">dasin</span><span class="p">(</span><span class="nb">dsqrt</span><span class="p">(</span><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">Deltaij</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="n">dt</span><span class="p">(</span><span class="mi">1</span><span class="p">)))</span>
<a name="ln-2182"></a>  <span class="n">xx</span> <span class="o">=</span> <span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">thpre</span> <span class="o">*</span> <span class="p">(</span><span class="n">thetaEl</span><span class="o">-</span><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">mith</span><span class="p">)</span>
<a name="ln-2183"></a>  <span class="n">itheta</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">xx</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span>
<a name="ln-2184"></a>  <span class="n">dtheta</span> <span class="o">=</span> <span class="n">xx</span><span class="o">-</span><span class="nb">int</span><span class="p">(</span><span class="n">xx</span><span class="p">)</span>
<a name="ln-2185"></a>  <span class="k">if</span> <span class="p">(</span><span class="n">itheta</span><span class="p">.</span><span class="n">lt</span><span class="p">.</span><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">nLUT</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-2186"></a><span class="k">    </span><span class="n">EF</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.D0</span><span class="o">-</span><span class="n">dtheta</span><span class="p">)</span><span class="o">*</span><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">EFLUT</span><span class="p">(</span><span class="n">itheta</span><span class="p">)</span> <span class="o">+</span> <span class="n">dtheta</span><span class="o">*</span><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">EFLUT</span><span class="p">(</span><span class="n">itheta</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-2187"></a>    <span class="n">EE</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.D0</span><span class="o">-</span><span class="n">dtheta</span><span class="p">)</span><span class="o">*</span><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">EELUT</span><span class="p">(</span><span class="n">itheta</span><span class="p">)</span> <span class="o">+</span> <span class="n">dtheta</span><span class="o">*</span><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">EELUT</span><span class="p">(</span><span class="n">itheta</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-2188"></a>  <span class="k">else </span>
<a name="ln-2189"></a><span class="k">    </span><span class="n">EF</span> <span class="o">=</span> <span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">EFLUT</span><span class="p">(</span><span class="n">itheta</span><span class="p">)</span> 
<a name="ln-2190"></a>    <span class="n">EE</span> <span class="o">=</span> <span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">EELUT</span><span class="p">(</span><span class="n">itheta</span><span class="p">)</span> 
<a name="ln-2191"></a>  <span class="k">end if</span>
<a name="ln-2192"></a>
<a name="ln-2193"></a><span class="c">! first order integrals</span>
<a name="ln-2194"></a>  <span class="n">II1</span> <span class="o">=</span> <span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">preI1</span> <span class="o">*</span> <span class="p">(</span> <span class="n">EF</span> <span class="o">-</span> <span class="n">EE</span> <span class="p">)</span>
<a name="ln-2195"></a>  <span class="n">II3</span> <span class="o">=</span> <span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">preI3</span> <span class="o">*</span> <span class="p">(</span> <span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">Deltaij</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">dt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">Delta</span> <span class="o">-</span> <span class="n">EE</span> <span class="p">)</span>
<a name="ln-2196"></a>  <span class="n">II</span> <span class="o">=</span> <span class="p">(</span><span class="o">/</span> <span class="n">II1</span><span class="p">,</span> <span class="mf">3.D0</span><span class="o">*</span><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">V</span><span class="o">/</span><span class="n">Delta</span> <span class="o">-</span> <span class="n">II1</span> <span class="o">-</span> <span class="n">II3</span><span class="p">,</span> <span class="n">II3</span> <span class="o">/</span><span class="p">)</span>
<a name="ln-2197"></a><span class="c">! second order integrals</span>
<a name="ln-2198"></a>  <span class="n">IIJ</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span> <span class="p">(</span><span class="n">II</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">II</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span><span class="o">/</span><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">Deltaij</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
<a name="ln-2199"></a>  <span class="n">IIJ</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">IIJ</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
<a name="ln-2200"></a>  <span class="n">IIJ</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span> <span class="p">(</span><span class="n">II</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">II</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span><span class="o">/</span><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">Deltaij</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
<a name="ln-2201"></a>  <span class="n">IIJ</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">IIJ</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-2202"></a>  <span class="n">IIJ</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span> <span class="p">(</span><span class="n">II</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="n">II</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span><span class="o">/</span><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">Deltaij</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
<a name="ln-2203"></a>  <span class="n">IIJ</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">IIJ</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-2204"></a>  <span class="n">IIJ</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">V</span><span class="o">/</span><span class="n">dt</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">Delta</span> <span class="o">-</span> <span class="p">(</span><span class="n">IIJ</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="n">IIJ</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span><span class="o">/</span><span class="mf">3.0</span>
<a name="ln-2205"></a>  <span class="n">IIJ</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">V</span><span class="o">/</span><span class="n">dt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">Delta</span> <span class="o">-</span> <span class="p">(</span><span class="n">IIJ</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="n">IIJ</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span><span class="o">/</span><span class="mf">3.0</span>
<a name="ln-2206"></a>  <span class="n">IIJ</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">V</span><span class="o">/</span><span class="n">dt</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">/</span><span class="n">Delta</span> <span class="o">-</span> <span class="p">(</span><span class="n">IIJ</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="n">IIJ</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span><span class="o">/</span><span class="mf">3.0</span>
<a name="ln-2207"></a><span class="k">else </span>
<a name="ln-2208"></a><span class="k">  </span><span class="n">II</span> <span class="o">=</span> <span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">IIinside</span>
<a name="ln-2209"></a>  <span class="n">IIJ</span> <span class="o">=</span> <span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">IIJinside</span>
<a name="ln-2210"></a><span class="k">end if</span>
<a name="ln-2211"></a>
<a name="ln-2212"></a><span class="c">! then we need to evaluate the large number of &quot;tensor&quot; components in the phi_{,j}</span>
<a name="ln-2213"></a><span class="c">! and psi_{,jli} arrays, as defined in Muro&#39;s 1987 book; we&#39;ve actually computed the</span>
<a name="ln-2214"></a><span class="c">! derivatives ourselves similar to the computation of eq. (11.40)</span>
<a name="ln-2215"></a><span class="n">phici</span> <span class="o">=</span> <span class="p">(</span><span class="o">/</span> <span class="o">-</span><span class="n">xyz</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">II</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="o">-</span><span class="n">xyz</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">II</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="o">-</span><span class="n">xyz</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">II</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">/</span><span class="p">)</span>
<a name="ln-2216"></a>
<a name="ln-2217"></a><span class="n">c</span> <span class="o">=</span> <span class="mf">0.D0</span>
<a name="ln-2218"></a><span class="n">sigma</span> <span class="o">=</span> <span class="p">(</span><span class="n">xyz</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">dt</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">xyz</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">dt</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">xyz</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">/</span><span class="n">dt</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span>
<a name="ln-2219"></a><span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span> 
<a name="ln-2220"></a> <span class="k">do </span><span class="n">l</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span>
<a name="ln-2221"></a>  <span class="k">do </span><span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span>
<a name="ln-2222"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">lambda</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="mf">0.D0</span><span class="p">)</span> <span class="n">c</span> <span class="o">=</span> <span class="mf">3.D0</span><span class="o">*</span><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">V</span><span class="o">*</span><span class="n">lambda</span><span class="o">*</span><span class="n">xyz</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">xyz</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">*</span><span class="n">xyz</span><span class="p">(</span><span class="n">l</span><span class="p">)</span><span class="o">/</span><span class="n">dt</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="o">/</span><span class="n">dt</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">/</span><span class="n">dt</span><span class="p">(</span><span class="n">l</span><span class="p">)</span><span class="o">/</span><span class="n">Delta</span><span class="o">/</span><span class="n">sigma</span>
<a name="ln-2223"></a>   <span class="n">t1</span> <span class="o">=</span> <span class="n">kdelta</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">l</span><span class="p">)</span> <span class="o">*</span> <span class="n">xyz</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">II</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">-</span> <span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">asq</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">*</span><span class="n">IIJ</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span>
<a name="ln-2224"></a>   <span class="n">t2</span> <span class="o">=</span> <span class="p">(</span><span class="n">kdelta</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">j</span><span class="p">)</span><span class="o">*</span><span class="n">xyz</span><span class="p">(</span><span class="n">l</span><span class="p">)</span><span class="o">+</span><span class="n">kdelta</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">l</span><span class="p">)</span><span class="o">*</span><span class="n">xyz</span><span class="p">(</span><span class="n">j</span><span class="p">))</span><span class="o">*</span><span class="p">(</span><span class="n">II</span><span class="p">(</span><span class="n">l</span><span class="p">)</span><span class="o">-</span><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">asq</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">*</span><span class="n">IIJ</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">l</span><span class="p">))</span>
<a name="ln-2225"></a>   <span class="n">psicjli</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">l</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="n">t1</span> <span class="o">-</span> <span class="n">t2</span> <span class="o">+</span> <span class="n">c</span>
<a name="ln-2226"></a>  <span class="k">end do</span>
<a name="ln-2227"></a><span class="k"> end do</span>
<a name="ln-2228"></a><span class="k">end do</span>
<a name="ln-2229"></a>
<a name="ln-2230"></a><span class="k">do </span><span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span>
<a name="ln-2231"></a><span class="c">! middle term of Mura eq. (11.30)</span>
<a name="ln-2232"></a>  <span class="n">u</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="mf">2.0</span><span class="o">*</span><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">nu</span><span class="o">*</span><span class="n">Treps</span><span class="o">*</span><span class="n">phici</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> 
<a name="ln-2233"></a><span class="c">! last term</span>
<a name="ln-2234"></a>  <span class="k">do </span><span class="n">l</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span>
<a name="ln-2235"></a>    <span class="n">u</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">u</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">-</span> <span class="mf">4.D0</span><span class="o">*</span><span class="p">(</span><span class="mf">1.D0</span><span class="o">-</span><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">nu</span><span class="p">)</span><span class="o">*</span><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">epsstar</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">l</span><span class="p">)</span><span class="o">*</span><span class="n">phici</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
<a name="ln-2236"></a>  <span class="k">end do</span>
<a name="ln-2237"></a><span class="c">! first term</span>
<a name="ln-2238"></a>  <span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span>
<a name="ln-2239"></a>    <span class="k">do </span><span class="n">l</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span>
<a name="ln-2240"></a>      <span class="n">u</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">u</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">+</span> <span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">epsstar</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">l</span><span class="p">)</span> <span class="o">*</span> <span class="n">psicjli</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">l</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>
<a name="ln-2241"></a>    <span class="k">end do</span>
<a name="ln-2242"></a><span class="k">  end do</span>
<a name="ln-2243"></a><span class="k">end do</span>
<a name="ln-2244"></a><span class="n">u</span> <span class="o">=</span> <span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">i</span><span class="p">)%</span><span class="n">pre</span> <span class="o">*</span> <span class="n">u</span>
<a name="ln-2245"></a>
<a name="ln-2246"></a><span class="k">end function </span><span class="n">Eshelby_disp</span>
<a name="ln-2247"></a>
<a name="ln-2248"></a>
<a name="ln-2249"></a>
<a name="ln-2250"></a>
<a name="ln-2251"></a>
<a name="ln-2252"></a>
<a name="ln-2253"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-2254"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-2255"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-2256"></a><span class="c">! and finally, here we compute the total displacements for an integration column</span>
<a name="ln-2257"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-2258"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-2259"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-2260"></a>
<a name="ln-2261"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-2262"></a><span class="c">!</span>
<a name="ln-2263"></a><span class="c">! SUBROUTINE: CalcR</span>
<a name="ln-2264"></a><span class="c">!</span>
<a name="ln-2265"></a><span class="c">!&gt; @author Marc De Graef, Carnegie Mellon University</span>
<a name="ln-2266"></a><span class="c">!</span>
<a name="ln-2267"></a><span class="c">!&gt; @brief returns the total displacement vector for each slice in a column</span>
<a name="ln-2268"></a><span class="c">!</span>
<a name="ln-2269"></a><span class="c">!&gt; @details Note that the end result MUST be expressed in the cartesian reference frame !</span>
<a name="ln-2270"></a><span class="c">!</span>
<a name="ln-2271"></a><span class="c">!&gt; @param cell unit cell pointer</span>
<a name="ln-2272"></a><span class="c">!&gt; @param defects defect structure</span>
<a name="ln-2273"></a><span class="c">!&gt; @param i integer x coordinate </span>
<a name="ln-2274"></a><span class="c">!&gt; @param j integer y coordinate</span>
<a name="ln-2275"></a><span class="c">!</span>
<a name="ln-2276"></a><span class="c">!&gt; @note This entire routine was thoroughly verified after the quaternion conversion !</span>
<a name="ln-2277"></a><span class="c">!&gt;</span>
<a name="ln-2278"></a><span class="c">!&gt; General comment for those who wish to add other defects...</span>
<a name="ln-2279"></a><span class="c">!&gt;</span>
<a name="ln-2280"></a><span class="c">!&gt; the general procedure to implement a defect displacement field is as follows:</span>
<a name="ln-2281"></a><span class="c">!&gt; - if the defect has its own reference frame, then transform (xpos,ypos,zpos) to</span>
<a name="ln-2282"></a><span class="c">!&gt;   that frame (see the dislocation section below for an example), and then do</span>
<a name="ln-2283"></a><span class="c">!&gt;   the computation of the displacement vector and express it in the cartesian frame.</span>
<a name="ln-2284"></a><span class="c">!&gt;</span>
<a name="ln-2285"></a><span class="c">!&gt; - if the defect uses the foil reference frame (e.g., voids, inclusions), then use tmpf</span>
<a name="ln-2286"></a><span class="c">!&gt;  as the current position vector.</span>
<a name="ln-2287"></a>
<a name="ln-2288"></a><span class="c">!&gt; @date  10/20/98 MDG 1.0 original</span>
<a name="ln-2289"></a><span class="c">!&gt; @date   5/22/01 MDG 2.0 f90</span>
<a name="ln-2290"></a><span class="c">!&gt; @date  11/27/01 MDG 2.1 added kind support</span>
<a name="ln-2291"></a><span class="c">!&gt; @date  03/26/13 MDG 3.0 updated IO</span>
<a name="ln-2292"></a><span class="c">!&gt; @date  10/30/13 MDG 3.1 debug of coordinate rotations</span>
<a name="ln-2293"></a><span class="c">!&gt; @date  11/13/13 MDG 3.2 finally, the bug has been found!  </span>
<a name="ln-2294"></a><span class="c">!&gt; @date  06/09/14 MDG 4.0 introduced defects argument and simplified routine</span>
<a name="ln-2295"></a><span class="c">!&gt; @date  06/10/14 MDG 4.1 added foil argument</span>
<a name="ln-2296"></a><span class="c">!&gt; @date  11/23/15 MDG 4.2 removed foil argument and placed it inside defects</span>
<a name="ln-2297"></a><span class="c">!--------------------------------------------------------------------------</span>
<a name="ln-2298"></a><span class="k">recursive subroutine </span><span class="n">CalcR</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span><span class="n">defects</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span>
<a name="ln-2299"></a><span class="c">!DEC$ ATTRIBUTES DLLEXPORT :: CalcR</span>
<a name="ln-2300"></a>
<a name="ln-2301"></a><span class="k">use </span><span class="n">local</span>
<a name="ln-2302"></a><span class="k">use </span><span class="n">constants</span>
<a name="ln-2303"></a><span class="k">use </span><span class="n">crystal</span>
<a name="ln-2304"></a><span class="k">use </span><span class="n">rotations</span>
<a name="ln-2305"></a>
<a name="ln-2306"></a><span class="k">IMPLICIT NONE</span>
<a name="ln-2307"></a>
<a name="ln-2308"></a><span class="k">type</span><span class="p">(</span><span class="n">unitcell</span><span class="p">),</span><span class="k">pointer</span>                  <span class="kd">::</span> <span class="n">cell</span>
<a name="ln-2309"></a><span class="k">type</span><span class="p">(</span><span class="n">defecttype</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">INOUT</span><span class="p">)</span>          <span class="kd">::</span> <span class="n">defects</span>
<a name="ln-2310"></a><span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">irg</span><span class="p">),</span><span class="k">INTENT</span><span class="p">(</span><span class="n">IN</span><span class="p">)</span>            <span class="kd">::</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span>
<a name="ln-2311"></a>
<a name="ln-2312"></a><span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">irg</span><span class="p">)</span>                       <span class="kd">::</span> <span class="n">k</span><span class="p">,</span> <span class="n">islice</span><span class="p">,</span> <span class="n">ii</span>
<a name="ln-2313"></a><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">dbl</span><span class="p">)</span>                          <span class="kd">::</span> <span class="n">dis</span><span class="p">,</span><span class="n">xpos</span><span class="p">,</span><span class="n">ypos</span><span class="p">,</span><span class="n">zpos</span><span class="p">,</span><span class="n">sumR</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span><span class="n">thick</span><span class="p">,</span><span class="n">tmp</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span><span class="n">tmp2</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="p">&amp;</span>
<a name="ln-2314"></a>                                           <span class="n">tmpf</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span><span class="n">u</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span><span class="n">zaamp</span><span class="p">,</span><span class="n">zaphase</span><span class="p">,</span><span class="n">zar</span><span class="p">,</span><span class="n">zai</span><span class="p">,</span><span class="n">zr</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span><span class="n">zi</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="p">&amp;</span>
<a name="ln-2315"></a>                                           <span class="n">zt</span><span class="p">,</span><span class="n">fx</span><span class="p">,</span><span class="n">fy</span><span class="p">,</span><span class="n">fz</span><span class="p">,</span><span class="n">a_fm</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="n">ar</span>    <span class="c">!,&amp;</span>
<a name="ln-2316"></a><span class="c">!                                nu,x,y,z,zn,t,pre,r1,r2,r3,th,rn </span>
<a name="ln-2317"></a>                                                 
<a name="ln-2318"></a><span class="kt">complex</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">dbl</span><span class="p">)</span>                       <span class="kd">::</span> <span class="n">za</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-2319"></a><span class="kt">complex</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="n">sgl</span><span class="p">)</span>                       <span class="kd">::</span> <span class="n">zero</span>
<a name="ln-2320"></a><span class="kt">logical</span>                                 <span class="kd">::</span> <span class="n">isvoid</span>
<a name="ln-2321"></a>
<a name="ln-2322"></a>
<a name="ln-2323"></a><span class="c">! scale the image coordinates with respect to the origin at the center of the image</span>
<a name="ln-2324"></a> <span class="n">xpos</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="n">defects</span><span class="p">%</span><span class="n">DF_npix</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">defects</span><span class="p">%</span><span class="n">DF_L</span>
<a name="ln-2325"></a> <span class="n">ypos</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">j</span><span class="o">-</span><span class="n">defects</span><span class="p">%</span><span class="n">DF_npiy</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">defects</span><span class="p">%</span><span class="n">DF_L</span>
<a name="ln-2326"></a><span class="c">! determine the starting point of the z-integration for the tilted foil</span>
<a name="ln-2327"></a><span class="c">! this depends on the foil normal components which give the equation</span>
<a name="ln-2328"></a><span class="c">! of the top foil plane as F . r = z0/2, from which we get zt...</span>
<a name="ln-2329"></a> <span class="n">a_fm</span> <span class="o">=</span> <span class="n">qu2om</span><span class="p">(</span><span class="n">defects</span><span class="p">%</span><span class="n">foil</span><span class="p">%</span><span class="n">a_fm</span><span class="p">)</span>
<a name="ln-2330"></a> <span class="n">fx</span> <span class="o">=</span> <span class="n">a_fm</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<a name="ln-2331"></a> <span class="n">fy</span> <span class="o">=</span> <span class="n">a_fm</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
<a name="ln-2332"></a> <span class="n">fz</span> <span class="o">=</span> <span class="n">a_fm</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> 
<a name="ln-2333"></a> <span class="n">zt</span> <span class="o">=</span> <span class="n">defects</span><span class="p">%</span><span class="n">foil</span><span class="p">%</span><span class="n">zb</span><span class="o">*</span><span class="mf">0.5</span> <span class="o">-</span> <span class="p">(</span><span class="n">fx</span><span class="o">*</span><span class="n">xpos</span> <span class="o">+</span> <span class="n">fy</span><span class="o">*</span><span class="n">ypos</span><span class="p">)</span><span class="o">/</span><span class="n">fz</span>
<a name="ln-2334"></a>
<a name="ln-2335"></a><span class="c">! initialize some other variables</span>
<a name="ln-2336"></a> <span class="n">thick</span> <span class="o">=</span> <span class="n">defects</span><span class="p">%</span><span class="n">foil</span><span class="p">%</span><span class="n">zb</span>
<a name="ln-2337"></a> <span class="n">zero</span> <span class="o">=</span> <span class="nb">cmplx</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">0.0</span><span class="p">)</span>
<a name="ln-2338"></a>
<a name="ln-2339"></a><span class="c">! loop over all slices (this is the main loop)</span>
<a name="ln-2340"></a> <span class="n">sliceloop</span><span class="p">:</span> <span class="k">do </span><span class="n">islice</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="n">defects</span><span class="p">%</span><span class="n">DF_nums</span> 
<a name="ln-2341"></a>
<a name="ln-2342"></a><span class="c">! zpos is the position down the column, starting at zt (in image coordinates)</span>
<a name="ln-2343"></a>    <span class="n">zpos</span> <span class="o">=</span> <span class="n">zt</span> <span class="o">-</span> <span class="nb">float</span><span class="p">(</span><span class="n">islice</span><span class="p">)</span><span class="o">*</span><span class="n">defects</span><span class="p">%</span><span class="n">DF_slice</span>
<a name="ln-2344"></a>
<a name="ln-2345"></a><span class="c">! set the displacements to zero</span>
<a name="ln-2346"></a>    <span class="n">sumR</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-2347"></a>
<a name="ln-2348"></a><span class="c">! set the position in the foil reference frame</span>
<a name="ln-2349"></a>    <span class="n">tmpf</span> <span class="o">=</span> <span class="n">quat_Lp</span><span class="p">(</span> <span class="n">defects</span><span class="p">%</span><span class="n">foil</span><span class="p">%</span><span class="n">a_fi</span><span class="p">,</span> <span class="nb">dble</span><span class="p">(</span> <span class="p">(</span><span class="o">/</span> <span class="n">xpos</span><span class="p">,</span> <span class="n">ypos</span><span class="p">,</span> <span class="n">zpos</span> <span class="o">/</span><span class="p">))</span> <span class="p">)</span>
<a name="ln-2350"></a>
<a name="ln-2351"></a>
<a name="ln-2352"></a><span class="c">!------------</span>
<a name="ln-2353"></a><span class="c">!----VOIDS---</span>
<a name="ln-2354"></a><span class="c">!------------</span>
<a name="ln-2355"></a><span class="c">! voids are easy to deal with; we simply return -10000 for each point tmpf that lies inside</span>
<a name="ln-2356"></a><span class="c">! one of the voids; the calling routine then knows to use the void scattering matrix.</span>
<a name="ln-2357"></a><span class="k">if</span> <span class="p">(</span><span class="n">defects</span><span class="p">%</span><span class="n">numvoids</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span> <span class="k">then</span> 
<a name="ln-2358"></a><span class="c">! are we inside a void ?</span>
<a name="ln-2359"></a>    <span class="n">isvoid</span> <span class="o">=</span> <span class="p">.</span><span class="n">FALSE</span><span class="p">.</span>
<a name="ln-2360"></a>    <span class="n">voidloop</span><span class="p">:</span> <span class="k">do </span><span class="n">ii</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">defects</span><span class="p">%</span><span class="n">numvoids</span>
<a name="ln-2361"></a><span class="c">! subtract the void position from the current slice position to get the relative position vector</span>
<a name="ln-2362"></a>     <span class="n">tmp</span> <span class="o">=</span> <span class="n">tmpf</span> <span class="o">-</span>  <span class="p">(</span><span class="o">/</span> <span class="n">defects</span><span class="p">%</span><span class="n">voids</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">xpos</span><span class="p">,</span> <span class="n">defects</span><span class="p">%</span><span class="n">voids</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">ypos</span><span class="p">,</span> <span class="n">defects</span><span class="p">%</span><span class="n">voids</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">zpos</span> <span class="o">/</span><span class="p">)</span>
<a name="ln-2363"></a>     <span class="n">dis</span> <span class="o">=</span> <span class="n">CalcLength</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span><span class="n">tmp</span><span class="p">,</span><span class="s1">&#39;c&#39;</span><span class="p">)</span>
<a name="ln-2364"></a>     <span class="k">if</span> <span class="p">(</span><span class="n">dis</span><span class="p">.</span><span class="n">lt</span><span class="p">.</span><span class="n">defects</span><span class="p">%</span><span class="n">voids</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">radius</span><span class="p">)</span> <span class="k">then</span> <span class="c">! inside void</span>
<a name="ln-2365"></a>       <span class="n">isvoid</span> <span class="o">=</span> <span class="p">.</span><span class="n">TRUE</span><span class="p">.</span>
<a name="ln-2366"></a>       <span class="k">exit </span><span class="n">voidloop</span>
<a name="ln-2367"></a>     <span class="k">end if</span>
<a name="ln-2368"></a><span class="k">    end do </span><span class="n">voidloop</span>
<a name="ln-2369"></a><span class="c">! skip the rest of the computation for this slice if we are inside a void</span>
<a name="ln-2370"></a>    <span class="k">if</span> <span class="p">(</span><span class="n">isvoid</span><span class="p">.</span><span class="n">eqv</span><span class="p">..</span><span class="n">TRUE</span><span class="p">.)</span> <span class="k">then </span>
<a name="ln-2371"></a><span class="k">      </span><span class="n">defects</span><span class="p">%</span><span class="n">DF_R</span><span class="p">(</span><span class="n">islice</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1000</span><span class="mf">0.0</span>
<a name="ln-2372"></a>      <span class="k">cycle </span><span class="n">sliceloop</span>
<a name="ln-2373"></a>    <span class="k">end if</span>
<a name="ln-2374"></a><span class="k"> end if</span> 
<a name="ln-2375"></a>
<a name="ln-2376"></a>
<a name="ln-2377"></a><span class="c">! ok, if we get here, then we&#39;re not inside a void...</span>
<a name="ln-2378"></a>
<a name="ln-2379"></a><span class="c">!------------------</span>
<a name="ln-2380"></a><span class="c">!----CURVED FOIL---</span>
<a name="ln-2381"></a><span class="c">!------------------</span>
<a name="ln-2382"></a><span class="c">! first we take the foil shape into account using equations (8.28) and (8.29)</span>
<a name="ln-2383"></a> <span class="n">sumR</span> <span class="o">=</span> <span class="n">sumR</span> <span class="o">+</span> <span class="nb">float</span><span class="p">(</span><span class="n">islice</span><span class="p">)</span><span class="o">*</span><span class="n">defects</span><span class="p">%</span><span class="n">DF_slice</span><span class="o">*</span><span class="n">defects</span><span class="p">%</span><span class="n">foil</span><span class="p">%</span><span class="n">sg</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span><span class="o">*</span><span class="n">defects</span><span class="p">%</span><span class="n">DF_gstar</span>
<a name="ln-2384"></a>
<a name="ln-2385"></a><span class="c">!-----------------</span>
<a name="ln-2386"></a><span class="c">!--DISLOCATIONS--</span>
<a name="ln-2387"></a><span class="c">!-----------------</span>
<a name="ln-2388"></a><span class="c">! let&#39;s put a few dislocations in ... (see section 8.4.2)</span>
<a name="ln-2389"></a><span class="k">do </span><span class="n">ii</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">defects</span><span class="p">%</span><span class="n">numdisl</span>
<a name="ln-2390"></a><span class="c">! compute the difference vector between the current (xpos,ypos,zpos) in the foil reference frame</span>
<a name="ln-2391"></a><span class="c">! and the defect center coordinate</span>
<a name="ln-2392"></a>  <span class="n">tmp2</span> <span class="o">=</span>  <span class="n">tmpf</span> <span class="o">-</span> <span class="nb">dble</span><span class="p">((</span><span class="o">/</span> <span class="n">defects</span><span class="p">%</span><span class="n">DF_L</span><span class="o">*</span><span class="n">defects</span><span class="p">%</span><span class="n">DL</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">id</span><span class="p">,</span> <span class="n">defects</span><span class="p">%</span><span class="n">DF_L</span><span class="o">*</span><span class="n">defects</span><span class="p">%</span><span class="n">DL</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">jd</span><span class="p">,</span> <span class="n">defects</span><span class="p">%</span><span class="n">DL</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">zfrac</span><span class="o">*</span><span class="n">defects</span><span class="p">%</span><span class="n">foil</span><span class="p">%</span><span class="n">z0</span> <span class="o">/</span><span class="p">))</span>
<a name="ln-2393"></a>
<a name="ln-2394"></a><span class="c">! then convert the difference vector to the defect reference frame for this dislocation (we will only need the x and y coordinates)</span>
<a name="ln-2395"></a>  <span class="n">tmp</span> <span class="o">=</span> <span class="n">quat_Lp</span><span class="p">(</span> <span class="n">defects</span><span class="p">%</span><span class="n">DL</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">a_df</span><span class="p">,</span> <span class="n">tmp2</span> <span class="p">)</span> 
<a name="ln-2396"></a>
<a name="ln-2397"></a>
<a name="ln-2398"></a><span class="c">! compute x1 + p_alpha x2  (eq. 8.38)</span>
<a name="ln-2399"></a>  <span class="n">za</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">defects</span><span class="p">%</span><span class="n">DL</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">pa</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">tmp</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<a name="ln-2400"></a><span class="c">! compute the displacement vector u (eq. 8.38) [this expands the log of a complex number and takes the real part only,</span>
<a name="ln-2401"></a><span class="c">! taking proper care of the branch cut] </span>
<a name="ln-2402"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">tmp</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="n">gt</span><span class="p">.</span><span class="mf">0.0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-2403"></a><span class="k">   do </span><span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span>
<a name="ln-2404"></a>    <span class="n">zar</span> <span class="o">=</span>  <span class="kt">real</span><span class="p">(</span><span class="n">za</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
<a name="ln-2405"></a>    <span class="n">zai</span> <span class="o">=</span> <span class="nb">aimag</span><span class="p">(</span><span class="n">za</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
<a name="ln-2406"></a>    <span class="n">zaamp</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">za</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
<a name="ln-2407"></a>    <span class="n">zaphase</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">zai</span><span class="o">/</span><span class="n">zar</span><span class="p">)</span>
<a name="ln-2408"></a>    <span class="n">zr</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="nb">log</span><span class="p">(</span><span class="n">zaamp</span><span class="p">)</span>
<a name="ln-2409"></a>    <span class="n">zi</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="nb">atan</span><span class="p">(</span><span class="n">zaphase</span><span class="p">)</span>
<a name="ln-2410"></a>    <span class="k">if</span> <span class="p">(</span><span class="n">zar</span><span class="p">.</span><span class="n">le</span><span class="p">.</span><span class="mf">0.0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-2411"></a><span class="k">      if</span> <span class="p">(</span><span class="n">zai</span><span class="p">.</span><span class="n">lt</span><span class="p">.</span><span class="mf">0.0</span><span class="p">)</span> <span class="n">zi</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="n">cPi</span><span class="o">+</span><span class="n">zi</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<a name="ln-2412"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">zai</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mf">0.0</span><span class="p">)</span> <span class="n">zi</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">cPi</span>
<a name="ln-2413"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">zai</span><span class="p">.</span><span class="n">gt</span><span class="p">.</span><span class="mf">0.0</span><span class="p">)</span> <span class="n">zi</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">cPi</span><span class="o">-</span><span class="n">zi</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<a name="ln-2414"></a>    <span class="k">else</span>
<a name="ln-2415"></a><span class="k">      if</span> <span class="p">(</span><span class="n">zai</span><span class="p">.</span><span class="n">lt</span><span class="p">.</span><span class="mf">0.0</span><span class="p">)</span> <span class="n">zi</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="o">-</span><span class="n">zi</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<a name="ln-2416"></a>    <span class="k">end if</span>
<a name="ln-2417"></a><span class="k">   end do</span>
<a name="ln-2418"></a><span class="k">  else</span>
<a name="ln-2419"></a><span class="k">   do </span><span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span>
<a name="ln-2420"></a>    <span class="n">zar</span> <span class="o">=</span>  <span class="kt">real</span><span class="p">(</span><span class="n">za</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
<a name="ln-2421"></a>    <span class="n">zai</span> <span class="o">=</span> <span class="nb">aimag</span><span class="p">(</span><span class="n">za</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
<a name="ln-2422"></a>    <span class="n">zaamp</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">za</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
<a name="ln-2423"></a>    <span class="n">zaphase</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">zai</span><span class="o">/</span><span class="n">zar</span><span class="p">)</span>
<a name="ln-2424"></a>    <span class="n">zr</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="nb">log</span><span class="p">(</span><span class="n">zaamp</span><span class="p">)</span>
<a name="ln-2425"></a>    <span class="n">zi</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="nb">atan</span><span class="p">(</span><span class="n">zaphase</span><span class="p">)</span>
<a name="ln-2426"></a>    <span class="k">if</span> <span class="p">(</span><span class="n">zar</span><span class="p">.</span><span class="n">le</span><span class="p">.</span><span class="mf">0.0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-2427"></a><span class="k">      if</span> <span class="p">(</span><span class="n">zai</span><span class="p">.</span><span class="n">gt</span><span class="p">.</span><span class="mf">0.0</span><span class="p">)</span> <span class="n">zi</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">cPi</span><span class="o">-</span><span class="n">zi</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<a name="ln-2428"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">zai</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mf">0.0</span><span class="p">)</span> <span class="n">zi</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">cPi</span>
<a name="ln-2429"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">zai</span><span class="p">.</span><span class="n">lt</span><span class="p">.</span><span class="mf">0.0</span><span class="p">)</span> <span class="n">zi</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">cPi</span><span class="o">+</span><span class="n">zi</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<a name="ln-2430"></a>    <span class="k">else</span>
<a name="ln-2431"></a><span class="k">      if</span> <span class="p">(</span><span class="n">zai</span><span class="p">.</span><span class="n">lt</span><span class="p">.</span><span class="mf">0.0</span><span class="p">)</span> <span class="n">zi</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">cPi</span><span class="o">-</span><span class="n">zi</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
<a name="ln-2432"></a>      <span class="k">if</span> <span class="p">(</span><span class="n">zai</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mf">0.0</span><span class="p">)</span> <span class="n">zi</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="mf">0.0</span>
<a name="ln-2433"></a>    <span class="k">end if</span>
<a name="ln-2434"></a><span class="k">   end do  </span>
<a name="ln-2435"></a><span class="k">  end if</span>
<a name="ln-2436"></a><span class="k">  </span><span class="n">u</span> <span class="o">=</span> <span class="mf">2.0</span><span class="o">*</span><span class="kt">real</span><span class="p">(</span><span class="nb">matmul</span><span class="p">(</span><span class="n">defects</span><span class="p">%</span><span class="n">DL</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">dismat</span><span class="p">,</span><span class="nb">cmplx</span><span class="p">(</span><span class="n">zr</span><span class="p">,</span><span class="n">zi</span><span class="p">)))</span>
<a name="ln-2437"></a><span class="c">! transform displacement vector u to the Cartesian crystal reference frame</span>
<a name="ln-2438"></a>  <span class="n">u</span> <span class="o">=</span> <span class="n">quat_Lp</span><span class="p">(</span> <span class="nb">conjg</span><span class="p">(</span><span class="n">defects</span><span class="p">%</span><span class="n">DL</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">a_dc</span><span class="p">),</span> <span class="nb">dble</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="p">)</span>  
<a name="ln-2439"></a>  <span class="n">sumR</span> <span class="o">=</span> <span class="n">sumR</span> <span class="o">+</span> <span class="n">u</span>
<a name="ln-2440"></a>
<a name="ln-2441"></a><span class="k">end do</span>
<a name="ln-2442"></a>
<a name="ln-2443"></a><span class="c">!-------------------------------------</span>
<a name="ln-2444"></a><span class="c">!--SURFACE INTERSECTING DISLOCATIONS--</span>
<a name="ln-2445"></a><span class="c">!-------------------------------------</span>
<a name="ln-2446"></a><span class="c">! this part is mostly used for ECCI-type image simulations, not for EM or STEM,</span>
<a name="ln-2447"></a><span class="c">! although it could probably be used there as well; we would need to extend it </span>
<a name="ln-2448"></a><span class="c">! to incorporate both top and bottom foil surfaces</span>
<a name="ln-2449"></a>
<a name="ln-2450"></a><span class="c">! do we have any dislocations with surface relaxations ?  YSH model</span>
<a name="ln-2451"></a><span class="k">if</span> <span class="p">(</span><span class="n">defects</span><span class="p">%</span><span class="n">numYdisl</span><span class="p">.</span><span class="n">gt</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span> <span class="k">then </span>
<a name="ln-2452"></a><span class="k">   do </span><span class="n">ii</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">defects</span><span class="p">%</span><span class="n">numYdisl</span>
<a name="ln-2453"></a><span class="c">! first, figure out what the coordinates are in the YSH reference frame for this dislocation ... </span>
<a name="ln-2454"></a><span class="c">! translate to the defect origin</span>
<a name="ln-2455"></a>     <span class="n">tmp</span> <span class="o">=</span>  <span class="n">tmpf</span> <span class="o">-</span>  <span class="p">(</span><span class="o">/</span> <span class="n">defects</span><span class="p">%</span><span class="n">DF_L</span><span class="o">*</span><span class="n">defects</span><span class="p">%</span><span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">id</span><span class="p">,</span> <span class="n">defects</span><span class="p">%</span><span class="n">DF_L</span><span class="o">*</span><span class="n">defects</span><span class="p">%</span><span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">jd</span><span class="p">,</span> <span class="n">defects</span><span class="p">%</span><span class="n">foil</span><span class="p">%</span><span class="n">z0</span><span class="o">*</span><span class="mf">0.5</span> <span class="o">/</span><span class="p">)</span>
<a name="ln-2456"></a>
<a name="ln-2457"></a><span class="c">! rotate into the defect reference frame</span>
<a name="ln-2458"></a>     <span class="n">tmp</span> <span class="o">=</span> <span class="n">quat_Lp</span><span class="p">(</span> <span class="nb">conjg</span><span class="p">(</span><span class="n">defects</span><span class="p">%</span><span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">a_di</span><span class="p">),</span> <span class="n">tmp</span> <span class="p">)</span>   
<a name="ln-2459"></a>
<a name="ln-2460"></a><span class="c">! compute the displacement vector</span>
<a name="ln-2461"></a><span class="c">!     u = sngl(YSHDisp(dble(tmp(2)),-dble(tmp(1)),dble(tmp(3)),ii))</span>
<a name="ln-2462"></a>     <span class="n">u</span> <span class="o">=</span> <span class="nb">sngl</span><span class="p">(</span><span class="n">YSHDisp</span><span class="p">(</span><span class="n">defects</span><span class="p">,</span><span class="nb">dble</span><span class="p">(</span><span class="n">tmp</span><span class="p">(</span><span class="mi">1</span><span class="p">)),</span><span class="nb">dble</span><span class="p">(</span><span class="n">tmp</span><span class="p">(</span><span class="mi">2</span><span class="p">)),</span><span class="nb">dble</span><span class="p">(</span><span class="n">tmp</span><span class="p">(</span><span class="mi">3</span><span class="p">)),</span><span class="n">ii</span><span class="p">))</span>
<a name="ln-2463"></a>
<a name="ln-2464"></a><span class="c">! and rotate back to the image reference frame</span>
<a name="ln-2465"></a>     <span class="n">u</span> <span class="o">=</span> <span class="n">quat_Lp</span><span class="p">(</span> <span class="nb">conjg</span><span class="p">(</span><span class="n">defects</span><span class="p">%</span><span class="n">YD</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">a_id</span><span class="p">),</span> <span class="n">u</span> <span class="p">)</span>
<a name="ln-2466"></a>     <span class="n">u</span> <span class="o">=</span> <span class="n">quat_Lp</span><span class="p">(</span> <span class="n">defects</span><span class="p">%</span><span class="n">foil</span><span class="p">%</span><span class="n">a_ic</span><span class="p">,</span> <span class="n">u</span> <span class="p">)</span> 
<a name="ln-2467"></a>
<a name="ln-2468"></a><span class="c">! that should do it !</span>
<a name="ln-2469"></a>     <span class="n">sumR</span> <span class="o">=</span> <span class="n">sumR</span> <span class="o">+</span> <span class="n">u</span>
<a name="ln-2470"></a>   <span class="k">end do</span>
<a name="ln-2471"></a><span class="k">end if</span>
<a name="ln-2472"></a>
<a name="ln-2473"></a><span class="c">!--------------------</span>
<a name="ln-2474"></a><span class="c">!--STACKING FAULTS--</span>
<a name="ln-2475"></a><span class="c">!--------------------</span>
<a name="ln-2476"></a><span class="c">! stacking faults (this is easy because we&#39;ve already done all the work in the stacking_fault module)</span>
<a name="ln-2477"></a><span class="c">! all we need is the z-value at which the stacking fault plane is crossed in this particular image</span>
<a name="ln-2478"></a><span class="c">! column; from that point on, we simply add the leading partial Burgers vector to the total displacement.</span>
<a name="ln-2479"></a><span class="k">do </span><span class="n">ii</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">defects</span><span class="p">%</span><span class="n">numsf</span>
<a name="ln-2480"></a>  <span class="k">if</span> <span class="p">((</span><span class="n">zpos</span><span class="p">.</span><span class="n">lt</span><span class="p">.</span><span class="n">defects</span><span class="p">%</span><span class="n">SF</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">zpos</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)).</span><span class="nb">and</span><span class="p">.(</span><span class="n">defects</span><span class="p">%</span><span class="n">SF</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">zpos</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">).</span><span class="n">ne</span><span class="p">.</span><span class="o">-</span><span class="mi">1000</span><span class="mf">0.0</span><span class="p">))</span> <span class="k">then </span>
<a name="ln-2481"></a><span class="k">    </span><span class="n">sumR</span> <span class="o">=</span> <span class="n">sumR</span> <span class="o">+</span> <span class="n">defects</span><span class="p">%</span><span class="n">SF</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">lpbc</span>
<a name="ln-2482"></a>  <span class="k">end if</span>
<a name="ln-2483"></a><span class="k">end do</span>
<a name="ln-2484"></a>
<a name="ln-2485"></a>
<a name="ln-2486"></a><span class="c">!--------------------</span>
<a name="ln-2487"></a><span class="c">!--LARGE INCLUSIONS--  currently commented out </span>
<a name="ln-2488"></a><span class="c">!--------------------</span>
<a name="ln-2489"></a><span class="c">! Mader&#39;s expression for the displacement field of a large inclusion</span>
<a name="ln-2490"></a><span class="c">!   if (0.eq.1.) then </span>
<a name="ln-2491"></a><span class="c">!    nu = 0.25</span>
<a name="ln-2492"></a><span class="c">!    ce = 0.005</span>
<a name="ln-2493"></a><span class="c">!    rn = 25.0*DF_L</span>
<a name="ln-2494"></a><span class="c">!    x = (float(i-DF_npix/2)-0.5)*DF_L</span>
<a name="ln-2495"></a><span class="c">!    y = (float(j-DF_npiy/2)-0.5)*DF_L</span>
<a name="ln-2496"></a><span class="c">!    z = float(k)*DF_slice</span>
<a name="ln-2497"></a><span class="c">!    zn = 100.5*DF_slice</span>
<a name="ln-2498"></a><span class="c">!    t = DF_slice * DF_nums</span>
<a name="ln-2499"></a><span class="c">!    pre = (1.0+nu)/(3.0*(1.0-nu))*ce*rn**3</span>
<a name="ln-2500"></a><span class="c">! </span>
<a name="ln-2501"></a><span class="c">!    r1 = sqrt(x**2+y**2+(z-zn)**2)</span>
<a name="ln-2502"></a><span class="c">!    r2 = sqrt(x**2+y**2+(z+zn)**2)</span>
<a name="ln-2503"></a><span class="c">!    r3 = sqrt(x**2+y**2+(2.0*t-z-zn)**2)</span>
<a name="ln-2504"></a><span class="c">! </span>
<a name="ln-2505"></a><span class="c">!    if (((r1.eq.0.0).or.(r2.eq.0.0)).or.(r3.eq.0.0)) then</span>
<a name="ln-2506"></a><span class="c">!      return</span>
<a name="ln-2507"></a><span class="c">!    else</span>
<a name="ln-2508"></a><span class="c">!     dis = (1.0/r1**3+(3.0-4.0*nu)/r2**3-6.0*z*(z+zn)/r2**5+(3.0-4.0*nu)/r3**3-6.0*(t-z)*(2.0*t-z-zn)/r3**5)</span>
<a name="ln-2509"></a><span class="c">!     rx = x*dis</span>
<a name="ln-2510"></a><span class="c">!     ry = y*dis</span>
<a name="ln-2511"></a><span class="c">!     rz = (z-zn)/r1**3-(3.0-4.0*nu)*((z+zn)/r2**3+(2.0*t-z-zn)/r3**3)-6.0*z*(z+zn)**2/r2**5 + &amp;</span>
<a name="ln-2512"></a><span class="c">!          2.0*z/r2**3+6.0*(t-z)*(2.0*t-z-zn)**2/r3**5-2.0*(t-z)/r3**3</span>
<a name="ln-2513"></a><span class="c">! </span>
<a name="ln-2514"></a><span class="c">!     sumR = pre*(/ rx, ry, rz /)</span>
<a name="ln-2515"></a><span class="c">!     return</span>
<a name="ln-2516"></a><span class="c">!    end if</span>
<a name="ln-2517"></a><span class="c">!   end if</span>
<a name="ln-2518"></a>
<a name="ln-2519"></a><span class="c">!--------------------</span>
<a name="ln-2520"></a><span class="c">!--SMALL INCLUSIONS--</span>
<a name="ln-2521"></a><span class="c">!--------------------</span>
<a name="ln-2522"></a><span class="c">! then the coherent precipitates, using the model in section 8.4.1</span>
<a name="ln-2523"></a>  <span class="k">if</span> <span class="p">(</span><span class="n">defects</span><span class="p">%</span><span class="n">numinc</span><span class="p">.</span><span class="n">gt</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-2524"></a><span class="k">   do </span><span class="n">ii</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">defects</span><span class="p">%</span><span class="n">numinc</span>
<a name="ln-2525"></a><span class="c">! subtract the inclusion position from the current slice position to get the relative position vector</span>
<a name="ln-2526"></a>     <span class="n">tmp</span> <span class="o">=</span> <span class="n">tmpf</span> <span class="o">-</span> <span class="p">(</span><span class="o">/</span> <span class="n">defects</span><span class="p">%</span><span class="n">inclusions</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">xpos</span><span class="p">,</span> <span class="n">defects</span><span class="p">%</span><span class="n">inclusions</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">ypos</span><span class="p">,</span> <span class="n">defects</span><span class="p">%</span><span class="n">inclusions</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">zpos</span> <span class="o">/</span><span class="p">)</span>
<a name="ln-2527"></a>     <span class="n">dis</span> <span class="o">=</span> <span class="n">CalcLength</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span><span class="n">tmp</span><span class="p">,</span><span class="s1">&#39;c&#39;</span><span class="p">)</span>
<a name="ln-2528"></a>     <span class="k">if</span> <span class="p">(</span><span class="n">dis</span><span class="p">.</span><span class="n">ge</span><span class="p">.</span><span class="n">defects</span><span class="p">%</span><span class="n">inclusions</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">radius</span><span class="p">)</span> <span class="k">then</span> <span class="c">! outside particle</span>
<a name="ln-2529"></a>       <span class="n">tmp</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">*</span><span class="p">(</span><span class="n">defects</span><span class="p">%</span><span class="n">inclusions</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">radius</span><span class="o">/</span><span class="n">dis</span><span class="p">)</span><span class="o">**</span><span class="mi">3</span>
<a name="ln-2530"></a>     <span class="k">end if</span>
<a name="ln-2531"></a><span class="k">     </span><span class="n">sumR</span> <span class="o">=</span> <span class="n">sumR</span> <span class="o">+</span> <span class="n">defects</span><span class="p">%</span><span class="n">inclusions</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">C</span><span class="o">*</span><span class="n">tmp</span>
<a name="ln-2532"></a>   <span class="k">end do</span>
<a name="ln-2533"></a><span class="k">  end if</span>
<a name="ln-2534"></a>
<a name="ln-2535"></a><span class="c">!---------------------</span>
<a name="ln-2536"></a><span class="c">!--SMALL EINCLUSIONS--</span>
<a name="ln-2537"></a><span class="c">!---------------------</span>
<a name="ln-2538"></a><span class="c">! then the coherent ellipsoidally distorted precipitates, using Eshelby&#39;s model </span>
<a name="ln-2539"></a>   <span class="k">if</span> <span class="p">(</span><span class="n">defects</span><span class="p">%</span><span class="n">numEinc</span><span class="p">.</span><span class="n">gt</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<a name="ln-2540"></a><span class="k">    do </span><span class="n">ii</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">defects</span><span class="p">%</span><span class="n">numEinc</span>
<a name="ln-2541"></a><span class="c">! subtract the inclusion position from the current slice position to get the relative position vector</span>
<a name="ln-2542"></a>      <span class="n">tmp</span> <span class="o">=</span> <span class="n">tmpf</span> <span class="o">-</span> <span class="p">(</span><span class="o">/</span> <span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">xpos</span><span class="p">,</span> <span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">ypos</span><span class="p">,</span> <span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">zpos</span> <span class="o">/</span><span class="p">)</span>
<a name="ln-2543"></a><span class="c">! and also get the position vector for the mirror image inclusion, to make sure we get a traction-free surface...</span>
<a name="ln-2544"></a>      <span class="n">tmp2</span> <span class="o">=</span> <span class="n">tmpf</span> <span class="o">-</span> <span class="p">(</span><span class="o">/</span> <span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">xpos</span><span class="p">,</span> <span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">ypos</span><span class="p">,</span> <span class="o">-</span><span class="n">defects</span><span class="p">%</span><span class="n">Einclusions</span><span class="p">(</span><span class="n">ii</span><span class="p">)%</span><span class="n">zpos</span> <span class="o">/</span><span class="p">)</span>
<a name="ln-2545"></a>      <span class="n">u</span> <span class="o">=</span> <span class="n">Eshelby_disp</span><span class="p">(</span><span class="n">defects</span><span class="p">,</span> <span class="n">ii</span><span class="p">,</span> <span class="n">tmp</span><span class="p">)</span> <span class="o">+</span> <span class="n">Eshelby_disp</span><span class="p">(</span><span class="n">defects</span><span class="p">,</span> <span class="n">ii</span><span class="p">,</span> <span class="n">tmp2</span><span class="p">)</span> 
<a name="ln-2546"></a><span class="c">! we need to check the reference frame here !</span>
<a name="ln-2547"></a>      <span class="n">sumR</span> <span class="o">=</span> <span class="n">sumR</span> <span class="o">+</span> <span class="n">u</span>
<a name="ln-2548"></a>    <span class="k">end do</span>
<a name="ln-2549"></a><span class="k">   end if</span>
<a name="ln-2550"></a>
<a name="ln-2551"></a><span class="c">! TO BE IMPLEMENTED FOR RICHARD LESAR&#39;S Discrete Dislocation Dynamics ! </span>
<a name="ln-2552"></a><span class="c">! finally any displacement fields defined by the user routine UserDisp</span>
<a name="ln-2553"></a><span class="c">! sumR = sumR + UserDisp()</span>
<a name="ln-2554"></a>
<a name="ln-2555"></a>
<a name="ln-2556"></a><span class="c">! TO BE IMPLEMENTED FOR YUNZHI WANG&#39;s Dislocation Simulations ! </span>
<a name="ln-2557"></a><span class="c">! finally any displacement fields defined by the user routine UserDisp</span>
<a name="ln-2558"></a><span class="c">! sumR = sumR + UserDisp()        </span>
<a name="ln-2559"></a>
<a name="ln-2560"></a>
<a name="ln-2561"></a>   <span class="n">defects</span><span class="p">%</span><span class="n">DF_R</span><span class="p">(</span><span class="n">islice</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="n">sumR</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span>
<a name="ln-2562"></a>
<a name="ln-2563"></a>  <span class="k">end do </span><span class="n">sliceloop</span> <span class="c">! main loop over the slices</span>
<a name="ln-2564"></a>
<a name="ln-2565"></a><span class="k">end subroutine </span><span class="n">CalcR</span>
<a name="ln-2566"></a>
<a name="ln-2567"></a>
<a name="ln-2568"></a><span class="k">end module </span><span class="n">defectmodule</span>
</pre></div>

    </section>
    </div>
  </div>

  <section class="visible-xs visible-sm hidden-md">
    <hr>
    

<div class="panel panel-default">
  <div class="panel-heading text-left"><h3 class="panel-title"><a data-toggle="collapse" href="#allfiles-1">All Source Files</a></h3></div>
  <div id="allfiles-1" class="panel-collapse collapse">
    <div class="list-group">
      
      <a class="list-group-item" href="../sourcefile/apb.f90.html">apb.f90</a>
      
      <a class="list-group-item" href="../sourcefile/bobyqa.f90.html">bobyqa.f90</a>
      
      <a class="list-group-item" href="../sourcefile/bobyqa_refinement.f90.html">bobyqa_refinement.f90</a>
      
      <a class="list-group-item" href="../sourcefile/clsupport.f90.html">CLsupport.f90</a>
      
      <a class="list-group-item" href="../sourcefile/constants.f90.html">constants.f90</a>
      
      <a class="list-group-item" href="../sourcefile/defectmodule.f90.html">defectmodule.f90</a>
      
      <a class="list-group-item" href="../sourcefile/dictmod.f90.html">dictmod.f90</a>
      
      <a class="list-group-item" href="../sourcefile/dispfield.f90.html">dispfield.f90</a>
      
      <a class="list-group-item" href="../sourcefile/distortion.f90.html">distortion.f90</a>
      
      <a class="list-group-item" href="../sourcefile/eccimod.f90.html">ECCImod.f90</a>
      
      <a class="list-group-item" href="../sourcefile/eispack.f90.html">eispack.f90</a>
      
      <a class="list-group-item" href="../sourcefile/emdymod.f90.html">EMdymod.f90</a>
      
      <a class="list-group-item" href="../sourcefile/filters.f90.html">filters.f90</a>
      
      <a class="list-group-item" href="../sourcefile/hdftest.f90.html">hdftest.f90</a>
      
      <a class="list-group-item" href="../sourcefile/indexingmod.f90.html">Indexingmod.f90</a>
      
      <a class="list-group-item" href="../sourcefile/initializers.f90.html">initializers.f90</a>
      
      <a class="list-group-item" href="../sourcefile/jsonsupport.f90.html">JSONsupport.f90</a>
      
      <a class="list-group-item" href="../sourcefile/muellercalculus.f90.html">MuellerCalculus.f90</a>
      
      <a class="list-group-item" href="../sourcefile/multibeams.f90.html">multibeams.f90</a>
      
      <a class="list-group-item" href="../sourcefile/namelisthandlers.f90.html">NameListHandlers.f90</a>
      
      <a class="list-group-item" href="../sourcefile/namelistjsonwriters.f90.html">NameListJSONwriters.f90</a>
      
      <a class="list-group-item" href="../sourcefile/namelisttypedefs.f90.html">NameListTypedefs.f90</a>
      
      <a class="list-group-item" href="../sourcefile/noise.f90.html">noise.f90</a>
      
      <a class="list-group-item" href="../sourcefile/others.f90.html">others.f90</a>
      
      <a class="list-group-item" href="../sourcefile/pedmod.f90.html">PEDmod.f90</a>
      
      <a class="list-group-item" href="../sourcefile/pfinversion.f90.html">PFInversion.f90</a>
      
      <a class="list-group-item" href="../sourcefile/pgm.f90.html">pgm.f90</a>
      
      <a class="list-group-item" href="../sourcefile/povray.f90.html">povray.f90</a>
      
      <a class="list-group-item" href="../sourcefile/rng.f90.html">rng.f90</a>
      
      <a class="list-group-item" href="../sourcefile/simulated_annealing.f90.html">simulated_annealing.f90</a>
      
      <a class="list-group-item" href="../sourcefile/so3.f90.html">so3.f90</a>
      
      <a class="list-group-item" href="../sourcefile/stemmodule.f90.html">STEMmodule.f90</a>
      
      <a class="list-group-item" href="../sourcefile/timing.f90.html">timing.f90</a>
      
    </div>
  </div>
</div>


  </section>
  
    <hr>    
    </div> <!-- /container -->
    <footer>
      <div class="container">
      <div class="row">
        <div class="col-xs-6 col-md-4"><p>&copy; 2017 <a rel="license" href="http://www.freebsd.org/copyright/freebsd-doc-license.html">FreeBSD Documentation License</a></p></div>
        <div class="col-xs-6 col-md-4 col-md-push-4">
          <p class="text-right">
            Documentation generated by 
            <a href="https://github.com/cmacmackin/ford">FORD</a>
            
          </p>
        </div>
        <div class="col-xs-12 col-md-4 col-md-pull-4"><p class="text-center"> Fortran Program was developed by Marc De Graef Research Group/Carnegie Mellon University</p></div>
      </div>
      <br>
      </div> <!-- /container -->    
    </footer>

    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
<!--
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
-->
    <script src="../js/bootstrap.min.js"></script>
    <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
    <script src="../js/ie10-viewport-bug-workaround.js"></script>

    <!-- MathJax JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        TeX: { extensions: ['AMSmath.js','AMSsymbols.js','noErrors.js','noUndefined.js'], equationNumbers: { autoNumber: 'AMS' } },
        jax: ['input/TeX','input/MathML','output/HTML-CSS'],
        extensions: ['tex2jax.js','mml2jax.js','MathMenu.js','MathZoom.js'],
        'HTML-CSS': { 
           styles: { '.MathJax_Display, .MathJax .mo, .MathJax .mi, .MathJax .mn': {color: '#000000 ! important'} }
        }
      });
    </script>
    <script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
  </body>
</html>